<!DOCTYPE html>
<!-- saved from url=(0082)http://rails-4-0.railstutorial.org/book/_single-page#sec-password_and_confirmation -->
<html id="custDomain"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/1310fd97f1"></script><script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/nr-632.min.js"></script><script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/6713.js" async="" type="text/javascript"></script><script type="text/javascript" async="" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/54eea5d20a23b37d87000040.js"></script><script id="facebook-jssdk" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/sdk.js"></script><script id="twitter-wjs" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/widgets.js"></script><script async="" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/analytics.js"></script><script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/1197428788.js" type="text/javascript"></script>

<title>Single Page | Ruby on Rails Tutorial (4.0 version &amp; 2nd Ed.) | Softcover.io</title>
<meta charset="UTF-8">
<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"1310fd97f1","applicationID":"4014257","transactionName":"IVZWR0tbWF4BFxhWVw1SSxxaQUdGCwhoRl0DXQ==","queueTime":2,"applicationTime":726,"agent":"js-agent.newrelic.com/nr-632.min.js"}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,n,t){function r(t){if(!n[t]){var o=n[t]={exports:{}};e[t][0].call(o.exports,function(n){var o=e[t][1][n];return r(o?o:n)},o,o.exports)}return n[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({QJf3ax:[function(e,n){function t(e){function n(n,t,a){e&&e(n,t,a),a||(a={});for(var u=c(n),f=u.length,s=i(a,o,r),p=0;f>p;p++)u[p].apply(s,t);return s}function a(e,n){f[e]=c(e).concat(n)}function c(e){return f[e]||[]}function u(){return t(n)}var f={};return{on:a,emit:n,create:u,listeners:c,_events:f}}function r(){return{}}var o="nr@context",i=e("gos");n.exports=t()},{gos:"7eSDFh"}],ee:[function(e,n){n.exports=e("QJf3ax")},{}],3:[function(e,n){function t(e){return function(){r(e,[(new Date).getTime()].concat(i(arguments)))}}var r=e("handle"),o=e(1),i=e(2);"undefined"==typeof window.newrelic&&(newrelic=window.NREUM);var a=["setPageViewName","addPageAction","setCustomAttribute","finished","addToTrace","inlineHit","noticeError"];o(a,function(e,n){window.NREUM[n]=t("api-"+n)}),n.exports=window.NREUM},{1:12,2:13,handle:"D5DuLP"}],"7eSDFh":[function(e,n){function t(e,n,t){if(r.call(e,n))return e[n];var o=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,n,{value:o,writable:!0,enumerable:!1}),o}catch(i){}return e[n]=o,o}var r=Object.prototype.hasOwnProperty;n.exports=t},{}],gos:[function(e,n){n.exports=e("7eSDFh")},{}],handle:[function(e,n){n.exports=e("D5DuLP")},{}],D5DuLP:[function(e,n){function t(e,n,t){return r.listeners(e).length?r.emit(e,n,t):(o[e]||(o[e]=[]),void o[e].push(n))}var r=e("ee").create(),o={};n.exports=t,t.ee=r,r.q=o},{ee:"QJf3ax"}],id:[function(e,n){n.exports=e("XL7HBI")},{}],XL7HBI:[function(e,n){function t(e){var n=typeof e;return!e||"object"!==n&&"function"!==n?-1:e===window?0:i(e,o,function(){return r++})}var r=1,o="nr@id",i=e("gos");n.exports=t},{gos:"7eSDFh"}],G9z0Bl:[function(e,n){function t(){var e=d.info=NREUM.info,n=f.getElementsByTagName("script")[0];if(e&&e.licenseKey&&e.applicationID&&n){c(p,function(n,t){n in e||(e[n]=t)});var t="https"===s.split(":")[0]||e.sslForHttp;d.proto=t?"https://":"http://",a("mark",["onload",i()]);var r=f.createElement("script");r.src=d.proto+e.agent,n.parentNode.insertBefore(r,n)}}function r(){"complete"===f.readyState&&o()}function o(){a("mark",["domContent",i()])}function i(){return(new Date).getTime()}var a=e("handle"),c=e(1),u=(e(2),window),f=u.document,s=(""+location).split("?")[0],p={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-632.min.js"},d=n.exports={offset:i(),origin:s,features:{}};f.addEventListener?(f.addEventListener("DOMContentLoaded",o,!1),u.addEventListener("load",t,!1)):(f.attachEvent("onreadystatechange",r),u.attachEvent("onload",t)),a("mark",["firstbyte",i()])},{1:12,2:3,handle:"D5DuLP"}],loader:[function(e,n){n.exports=e("G9z0Bl")},{}],12:[function(e,n){function t(e,n){var t=[],o="",i=0;for(o in e)r.call(e,o)&&(t[i]=n(o,e[o]),i+=1);return t}var r=Object.prototype.hasOwnProperty;n.exports=t},{}],13:[function(e,n){function t(e,n,t){n||(n=0),"undefined"==typeof t&&(t=e?e.length:0);for(var r=-1,o=t-n||0,i=Array(0>o?0:o);++r<o;)i[r]=e[n+r];return i}n.exports=t},{}]},{},["G9z0Bl"]);</script>
<script>
  window.Config = {
    bucket: "softcover",
    previewBucket: "softcover-cloud"
  }
</script>
<link rel="stylesheet" media="screen" href="https://www.softcover.io/assets/reading-e41cf250aa82b744d93d909924113e8c40af382043d1334da0391a178530adce.css">
<link href="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/print-f4bd271fd41b8086410e78c14546336605a29e5c72c2d08b094c7ccfe03de6c4.css" media="print" rel="stylesheet" type="text/css">
<script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/jquery-2.0.3.min.js" type="text/javascript"></script>
<script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/jquery.formalize.min.js" type="text/javascript"></script>
<script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/underscore-min.js" type="text/javascript"></script>
<script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/saved_resource" type="text/javascript"></script>
<script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/application-7dd97da48bebed5b05e6580ac084b5a0fa9db673b000ae210cbe13d9573e3206.js"></script>
<meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="Y0dCs697eHzBOqeOyqdIn+mfDMPZ7SZ+bYl2iWB0t9LjCWQ/heYA/RukS/w5IEMlK2ylY5UPfRkRYKimknIyTQ==">
<link href="http://rails-4-0.railstutorial.org/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed">
<meta content="http://rails-4-0.railstutorial.org" property="og:url">
<meta content="Ruby on Rails Tutorial (4.0 version &amp; 2nd Ed.)" property="og:title">
<meta content="The Ruby on Rails Tutorial book and screencast series teach you how to develop and deploy real, industrial-strength web applications with Ruby on Rails, the open-source web framework that powers top websites such as Twitter, Hulu, GitHub, and the Yellow Pages. The Ruby on Rails Tutorial book is available for free online and is available for purchase as an ebook (PDF, EPUB, and MOBI formats). The companion screencast series includes 15 individual lessons (including a new Rails 4.0 supplement) totaling more than 15 hours, with one lesson for each chapter of the Ruby on Rails Tutorial book. The best value is the ebook/screencast bundle, which includes the 2nd edition book, the Rails 4.0–compatible version, the 2nd edition screencast series, and the Rails 4.0 supplementary screencasts." property="og:description">
<meta content="Softcover.io" property="og:site_name">
<meta content="https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/images/cover-web.png" property="og:image">
<meta content="https://softcover.s3.amazonaws.com/636/ruby_on_rails_tutorial/images/cover-web.png" property="og:image:secure_url">
<meta content="image/png" property="og:image:type">
<meta content="500" property="og:image:width">
<meta content="500" property="og:image:height">
<link href="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/css" rel="stylesheet" type="text/css">
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/jsapi" type="text/javascript"></script>
<script>
  // test key only
  // this identifies your website in the createToken call below
  Stripe.setPublishableKey('pk_live_Xn1p0BfxqKxkAxtEr03P7wmd');
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('require', 'linker');
  ga('linker:autoLink', ['rails-4-0.railstutorial.org', 'softcover.io']);

  ga('create', 'UA-46858978-1', 'softcover.io', {'allowLinker': true});
  ga('send', 'pageview');

  ga('create', 'UA-8667566-1', 'auto', {
    'name': 'book',
    'allowLinker': true
  });

  ga('book.send', 'pageview');

</script>
<script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>


<script src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/custom_domain_js.js" type="text/javascript"></script>
<script id="mathJaxJS" type="text/javascript" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/MathJax.js"></script><script type="text/javascript" async="" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/tagjs"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">.MathJax_Preview .MJXc-math {color: inherit!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/saved_resource(1)" width="1" height="1" border="0"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/saved_resource(2)" width="1" height="1" border="0"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/saved_resource(3)" width="1" height="1" border="0"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/seg" width="1" height="1" border="0"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/seg(1)" width="1" height="1" border="0"><style type="text/css">.MJXc-script {font-size: .8em}
.MJXc-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXc-bold {font-weight: bold}
.MJXc-italic {font-style: italic}
.MJXc-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXc-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXc-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXc-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXc-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXc-largeop {font-size: 150%}
.MJXc-largeop.MJXc-int {vertical-align: -.2em}
.MJXc-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXc-display {display: block; text-align: center; margin: 1em 0}
.MJXc-math span {display: inline-block}
.MJXc-box {display: block!important; text-align: center}
.MJXc-box:after {content: " "}
.MJXc-rule {display: block!important; margin-top: .1em}
.MJXc-char {display: block!important}
.MJXc-mo {margin: 0 .15em}
.MJXc-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXc-denom {display: inline-table!important; width: 100%}
.MJXc-denom > * {display: table-row!important}
.MJXc-surd {vertical-align: top}
.MJXc-surd > * {display: block!important}
.MJXc-script-box > *  {display: table!important; height: 50%}
.MJXc-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXc-script-box > *:last-child > * {vertical-align: bottom}
.MJXc-script-box > * > * > * {display: block!important}
.MJXc-mphantom {visibility: hidden}
.MJXc-munderover {display: inline-table!important}
.MJXc-over {display: inline-block!important; text-align: center}
.MJXc-over > * {display: block!important}
.MJXc-munderover > * {display: table-row!important}
.MJXc-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXc-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXc-mtr {display: table-row!important}
.MJXc-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXc-mtr > .MJXc-mtd:first-child {padding-left: 0}
.MJXc-mtr:first-child > .MJXc-mtd {padding-top: 0}
.MJXc-mlabeledtr {display: table-row!important}
.MJXc-mlabeledtr > .MJXc-mtd:first-child {padding-left: 0}
.MJXc-mlabeledtr:first-child > .MJXc-mtd {padding-top: 0}
.MJXc-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXc-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXc-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXc-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXc-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXc-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXc-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXc-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXc-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXc-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXc-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_CHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?rev=2.5.3') format('opentype')}
@font-face {font-family: MathJax_Main-bold; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?rev=2.5.3') format('opentype')}
@font-face {font-family: MathJax_Main-italic; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?rev=2.5.3') format('opentype')}
@font-face {font-family: MathJax_Math-italic; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?rev=2.5.3') format('opentype')}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?rev=2.5.3') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?rev=2.5.3') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?rev=2.5.3') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?rev=2.5.3') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?rev=2.5.3') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?rev=2.5.3') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}.fb_link img{border:none}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_reset .fb_dialog_legacy{overflow:visible}.fb_dialog_advanced{padding:10px;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px}.fb_dialog_content{background:#fff;color:#333}.fb_dialog_close_icon{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif);cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{top:5px;left:5px;right:auto}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_close_icon:active{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_loader{background-color:#f6f7f8;border:1px solid #606060;font-size:24px;padding:20px}.fb_dialog_top_left,.fb_dialog_top_right,.fb_dialog_bottom_left,.fb_dialog_bottom_right{height:10px;width:10px;overflow:hidden;position:absolute}.fb_dialog_top_left{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 0;left:-10px;top:-10px}.fb_dialog_top_right{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -10px;right:-10px;top:-10px}.fb_dialog_bottom_left{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -20px;bottom:-10px;left:-10px}.fb_dialog_bottom_right{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -30px;right:-10px;bottom:-10px}.fb_dialog_vert_left,.fb_dialog_vert_right,.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{position:absolute;background:#525252;filter:alpha(opacity=70);opacity:.7}.fb_dialog_vert_left,.fb_dialog_vert_right{width:10px;height:100%}.fb_dialog_vert_left{margin-left:-10px}.fb_dialog_vert_right{right:0;margin-right:-10px}.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{width:100%;height:10px}.fb_dialog_horiz_top{margin-top:-10px}.fb_dialog_horiz_bottom{bottom:0;margin-bottom:-10px}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #3a5795;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}body.fb_hidden{-webkit-transform:none;height:100%;margin:0;overflow:visible;position:absolute;top:-10000px;left:0;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{max-height:590px;min-height:590px;max-width:500px;min-width:500px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .45);position:absolute;left:0;top:0;width:100%;min-height:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_content .dialog_header{-webkit-box-shadow:white 0 1px 1px -1px inset;background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#738ABA), to(#2C4987));border-bottom:1px solid;border-color:#1d4088;color:#fff;font:14px Helvetica, sans-serif;font-weight:bold;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{-webkit-font-smoothing:subpixel-antialiased;height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#4966A6), color-stop(.5, #355492), to(#2A4887));border:1px solid #2f477a;-webkit-background-clip:padding-box;-webkit-border-radius:3px;-webkit-box-shadow:rgba(0, 0, 0, .117188) 0 1px 1px inset, rgba(255, 255, 255, .167969) 0 1px 0;display:inline-block;margin-top:3px;max-width:85px;line-height:18px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{border:none;background:none;color:#fff;font:12px Helvetica, sans-serif;font-weight:bold;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #555;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f6f7f8;border:1px solid #555;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:left}.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_fluid_desktop,.fb_iframe_widget_fluid_desktop span,.fb_iframe_widget_fluid_desktop iframe{max-width:100%}.fb_iframe_widget_fluid_desktop iframe{min-width:220px;position:relative}.fb_iframe_widget_lift{z-index:1}.fb_hide_iframes iframe{position:relative;left:-10000px}.fb_iframe_widget_loader{position:relative;display:inline-block}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}.fb_iframe_widget_loader iframe{min-height:32px;z-index:2;zoom:1}.fb_iframe_widget_loader .FB_Loader{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat;height:32px;width:32px;margin-left:-16px;position:absolute;left:50%;z-index:4}</style></head>
<body><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>
<noscript>
&lt;div id='noscript'&gt;
&lt;h2&gt;Please enable javascript&lt;/h2&gt;
This site requires you to allow Javascript to run in the browser for all features to work. Thank you!
&lt;/div&gt;
</noscript>
<script type="text/javascript">
!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
window.fbAsyncInit = function() {
FB.init({
appId      : '145973438749643',
xfbml      : true,
version    : 'v2.0'
});
};
(function(d, s, id){
var js, fjs = d.getElementsByTagName(s)[0];
if (d.getElementById(id)) {return;}
js = d.createElement(s); js.id = id;
js.src = "//connect.facebook.net/en_US/sdk.js";
fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>
<div class="closeLeft container">
<div class="container_footer">
<div id="header">
<div class="wrapper">
<a class="logo" href="http://www.softcover.io/"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/logo-ac6f1f6a838105d63e98f5fd5f2cf2596824a92c61a7f3c2a7aaf884a61e2fc1.png" alt="Logo ac6f1f6a838105d63e98f5fd5f2cf2596824a92c61a7f3c2a7aaf884a61e2fc1">
</a><a id="mobileMenu" href="javascript://"><div class="closedMenu">
≡
<span>Menu</span>
</div>
<div class="openMenu">
x
<span>Close</span>
</div>
</a><div class="j_userHeader closeLeft" style="display:inline"><ul class="headerMenu">
<li><a href="http://www.softcover.io/login">Log In</a></li>
<li><a href="http://www.softcover.io/account/sign_up">Sign Up</a></li>
</ul>
</div>
<div id="dropBG"></div>
<div class="clear"></div>
</div>
</div>

<link rel="stylesheet" media="screen" href="https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/stylesheets/custom.css?X-Amz-Expires=3600&X-Amz-Date=20150727T121519Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=6e633d55b3f6f450dc58e17905696339410786bf7ad367a108394eba2105a186">
<div id="pageBook">
<div id="bookHeader">
<div class="wrapper">
<div class="bookCover">
<a href="http://rails-4-0.railstutorial.org/book"><img class="cover" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/cover-web.png" alt="Cover web">
<img class="coverBG" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/cover_bg-e5e0c77fac617f88e7a2088ebb8aac68ac4f978d6ce9e66a77a34d255dbfea02.png" alt="Cover bg e5e0c77fac617f88e7a2088ebb8aac68ac4f978d6ce9e66a77a34d255dbfea02">
<p>
<i class="ibooksMedia iRead"></i>
READ ONLINE FREE
</p>
</a></div>
<div class="bookInfo">
<h1>
Ruby on Rails Tutorial (4.0 version &amp; 2nd Ed.)
<span class="j_subtitle">Learn Rails by Example</span>
<strong>Michael Hartl</strong>
</h1>
<p class="j_description">
 The Ruby on Rails Tutorial book and screencast series teach you how to develop and deploy real, industrial-strength web applications with Ruby on Rails, the open-source web framework that powers top websites such as Twitter, Hulu, GitHub, and the Yellow Pages. The Ruby on Rails Tutorial book is available for free online and is available for purchase as an ebook (PDF, EPUB, and MOBI formats). The companion screencast series includes 15 individual lessons (including a new Rails 4.0 supplement) totaling more than 15 hours, with one lesson for each chapter of the Ruby on Rails Tutorial book. The best value is the ebook/screencast bundle, which includes the 2nd edition book, the Rails 4.0–compatible version, the 2nd edition screencast series, and the Rails 4.0 supplementary screencasts. 

</p>

<div class="bookControls">
<a href="http://rails-4-0.railstutorial.org/"><button class="transBG">Book Info</button>
</a><a href="mailto:admin@railstutorial.org"><button class="transBG">Contact Author</button>
</a></div>

</div>

</div>
</div>

<div id="bookMenu" style="display:" class="bookMenuFixed">
<div class="wrapper">
<div class="bookMenuControls">
<div class="bookMenuArows">
<a class="leftArrow" href="javascript://">◄</a>
<a class="upArrow" href="javascript://">▲</a>
<a class="rightArrow" href="javascript://">►</a>
</div>
<div class="bookMenuSize">
<a id="sizeRegular" class="current" href="javascript://"></a>
<a id="sizeBig" href="javascript://"></a>
<a id="sizeBigger" href="javascript://"></a>
</div>
<div class="bookMenuSearch">
<a id="j_singlePage" href="javascript://"><i class="fa fa-search"></i>
Single Page
</a></div>
</div>
<div class="dropDown" id="j_chapterDropDown">
<span id="chapterTitle">Single Page</span>
<ul class="dropMenu"><li><a>Frontmatter
</a></li><li><a>Chapter 1: From zero to deploy
</a></li><li><a>Chapter 2: A demo app
</a></li><li><a>Chapter 3: Mostly static pages
</a></li><li><a>Chapter 4: Rails-flavored Ruby
</a></li><li><a>Chapter 5: Filling in the layout
</a></li><li><a>Chapter 6: Modeling users
</a></li><li><a>Chapter 7: Sign up
</a></li><li><a>Chapter 8: Sign in, sign out
</a></li><li><a>Chapter 9: Updating, showing, and deleting users
</a></li><li><a>Chapter 10: User microposts
</a></li><li><a>Chapter 11: Following users
</a></li></ul>
</div>
<div class="bookMenuActions j_downloadLinks"><a onclick="$(&#39;#bookMenuEmail&#39;).toggleClass(&#39;open&#39;); return false" href=""><button class="greyButton iEmailUpdate">
<i class="fa fa-heart"></i>
</button>
</a><a href="https://www.softcover.io/downloads/28fdb94f/ruby_on_rails_tutorial"><button>Download Previews</button>
</a></div>
</div>
<div class="animated" id="bookMenuEmail">
<div class="wrapper">
<label>Follow this book to receive email updates from the author.</label>
<div class="j_followBookForm"><form action="https://www.softcover.io/books/ruby_on_rails_tutorial/follow?username=28fdb94f" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="✓">
<!-- %input{name: "name", type: "text", placeholder: "YOUR NAME"} -->
<input name="email" placeholder="YOUR EMAIL ADDRESS" type="text">
<input class="greyButton optClick_follow" type="submit" value="Follow Book">
</form>

</div>
</div>
</div>
</div>
<div class="wrapper" id="bookWr">
<div class="bookChapterTop">Single Page</div>
<div id="bookHtml" style="opacity: 1;"><div id="book">
      <div id="frontmatter" data-number="0"><div id="title_page"><h1 class="title">Ruby on Rails Tutorial</h1><h1 class="subtitle">Learn Rails by Example</h1><h2 class="author">Michael Hartl</h2></div>
<h1 class="contents">Contents</h1><div id="table_of_contents"><ul><li class="chapter-star"><a href="http://rails-4-0.railstutorial.org/book/_single-page#foreword" class="heading hyperref">Foreword</a></li><li class="chapter-star"><a href="http://rails-4-0.railstutorial.org/book/_single-page#acknowledgments" class="heading hyperref">Acknowledgments</a></li><li class="chapter-star"><a href="http://rails-4-0.railstutorial.org/book/_single-page#about_the_author" class="heading hyperref">About the author</a></li><li class="chapter-star"><a href="http://rails-4-0.railstutorial.org/book/_single-page#copyright_and_license" class="heading hyperref">Copyright and license</a></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-beginning" class="heading hyperref"><span class="number">Chapter 1 </span>From zero to deploy</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-introduction" class="heading hyperref"><span class="number">1.1 </span>Introduction</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-comments_for_various_readers" class="heading hyperref"><span class="number">1.1.1 </span>Comments for various readers</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid28" class="heading hyperref"><span class="number">1.1.2 </span>“Scaling” Rails</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-conventions" class="heading hyperref"><span class="number">1.1.3 </span>Conventions in this book</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-up_and_running" class="heading hyperref"><span class="number">1.2 </span>Up and running</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-development_tools" class="heading hyperref"><span class="number">1.2.1 </span>Development environments</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rubygems" class="heading hyperref"><span class="number">1.2.2 </span>Ruby, RubyGems, Rails, and Git</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_application" class="heading hyperref"><span class="number">1.2.3 </span>The first application</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-bundler" class="heading hyperref"><span class="number">1.2.4 </span>Bundler</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_server" class="heading hyperref">
  <span class="number">1.2.5 </span>
  <span class="tt">rails server</span>
</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc" class="heading hyperref"><span class="number">1.2.6 </span>Model-view-controller (MVC)</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-version_control" class="heading hyperref"><span class="number">1.3 </span>Version control with Git</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_setup" class="heading hyperref"><span class="number">1.3.1 </span>Installation and setup</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_and_committing" class="heading hyperref"><span class="number">1.3.2 </span>Adding and committing</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid77" class="heading hyperref"><span class="number">1.3.3 </span>What good does Git do you?</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-github" class="heading hyperref"><span class="number">1.3.4 </span>GitHub</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_commands" class="heading hyperref"><span class="number">1.3.5 </span>Branch, edit, commit, merge</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying" class="heading hyperref"><span class="number">1.4 </span>Deploying</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_setup" class="heading hyperref"><span class="number">1.4.1 </span>Heroku setup</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_step_one" class="heading hyperref"><span class="number">1.4.2 </span>Heroku deployment, step one</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid98" class="heading hyperref"><span class="number">1.4.3 </span>Heroku deployment, step two</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_commands" class="heading hyperref"><span class="number">1.4.4 </span>Heroku commands</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-beginning_conclusion" class="heading hyperref"><span class="number">1.5 </span>Conclusion</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="heading hyperref"><span class="number">Chapter 2 </span>A demo app</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-planning_the_application" class="heading hyperref"><span class="number">2.1 </span>Planning the application</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_demo_users" class="heading hyperref"><span class="number">2.1.1 </span>Modeling demo users</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_demo_microposts" class="heading hyperref"><span class="number">2.1.2 </span>Modeling demo microposts</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_users_resource" class="heading hyperref"><span class="number">2.2 </span>The Users resource</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_tour" class="heading hyperref"><span class="number">2.2.1 </span>A user tour</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc_in_action" class="heading hyperref"><span class="number">2.2.2 </span>MVC in action</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-weaknesses_of_this_users_resource" class="heading hyperref"><span class="number">2.2.3 </span>Weaknesses of this Users resource</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-microposts_resource" class="heading hyperref"><span class="number">2.3 </span>The Microposts resource</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_micropost_microtour" class="heading hyperref"><span class="number">2.3.1 </span>A micropost microtour</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-putting_the_micro_in_microposts" class="heading hyperref"><span class="number">2.3.2 </span>Putting the <em>micro</em> in microposts</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_user_has_many_microposts" class="heading hyperref"><span class="number">2.3.3 </span>A user <span class="tt">has_many</span> microposts</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-inheritance_hierarchies" class="heading hyperref"><span class="number">2.3.4 </span>Inheritance hierarchies</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying_the_demo_app" class="heading hyperref"><span class="number">2.3.5 </span>Deploying the demo app</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid11" class="heading hyperref"><span class="number">2.4 </span>Conclusion</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="heading hyperref"><span class="number">Chapter 3 </span>Mostly static pages</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="heading hyperref"><span class="number">3.1 </span>Static pages</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="heading hyperref"><span class="number">3.2 </span>Our first tests</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-TDD" class="heading hyperref"><span class="number">3.2.1 </span>Test-driven development</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_page" class="heading hyperref"><span class="number">3.2.2 </span>Adding a page</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-slightly_dynamic_pages" class="heading hyperref"><span class="number">3.3 </span>Slightly dynamic pages</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-testing_a_title_change" class="heading hyperref"><span class="number">3.3.1 </span>Testing a title change</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-passing_title_tests" class="heading hyperref"><span class="number">3.3.2 </span>Passing title tests</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-embedded_ruby" class="heading hyperref"><span class="number">3.3.3 </span>Embedded Ruby</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layouts" class="heading hyperref"><span class="number">3.3.4 </span>Eliminating duplication with layouts</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages_conclusion" class="heading hyperref"><span class="number">3.4 </span>Conclusion</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages_exercises" class="heading hyperref"><span class="number">3.5 </span>Exercises</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-advanced_setup" class="heading hyperref"><span class="number">3.6 </span>Advanced setup</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-eliminating_bundle_exec" class="heading hyperref"><span class="number">3.6.1 </span>Eliminating <span class="tt">bundle exec</span></a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-guard" class="heading hyperref"><span class="number">3.6.2 </span>Automated tests with Guard</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-spork" class="heading hyperref"><span class="number">3.6.3 </span>Speeding up tests with Spork</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-tests_inside_sublime_text" class="heading hyperref"><span class="number">3.6.4 </span>Tests inside Sublime Text</a></li></ul></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-rails_flavored_ruby" class="heading hyperref"><span class="number">Chapter 4 </span>Rails-flavored Ruby</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-motivation" class="heading hyperref"><span class="number">4.1 </span>Motivation</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strings_and_methods" class="heading hyperref"><span class="number">4.2 </span>Strings and methods</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-comments" class="heading hyperref"><span class="number">4.2.1 </span>Comments</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strings" class="heading hyperref"><span class="number">4.2.2 </span>Strings</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-objects_and_message_passing" class="heading hyperref"><span class="number">4.2.3 </span>Objects and message passing</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-method_definitions" class="heading hyperref"><span class="number">4.2.4 </span>Method definitions</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-back_to_the_title_helper" class="heading hyperref"><span class="number">4.2.5 </span>Back to the title helper</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-other_data_structures" class="heading hyperref"><span class="number">4.3 </span>Other data structures</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-arrays_and_ranges" class="heading hyperref"><span class="number">4.3.1 </span>Arrays and ranges</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-blocks" class="heading hyperref"><span class="number">4.3.2 </span>Blocks</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-hashes_and_symbols" class="heading hyperref"><span class="number">4.3.3 </span>Hashes and symbols</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-css_revisited" class="heading hyperref"><span class="number">4.3.4 </span>CSS revisited</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ruby_classes" class="heading hyperref"><span class="number">4.4 </span>Ruby classes</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-constructors" class="heading hyperref"><span class="number">4.4.1 </span>Constructors</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_class_of_our_own" class="heading hyperref"><span class="number">4.4.2 </span>Class inheritance</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modifying_built_in_classes" class="heading hyperref"><span class="number">4.4.3 </span>Modifying built-in classes</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_controller_class" class="heading hyperref"><span class="number">4.4.4 </span>A controller class</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="heading hyperref"><span class="number">4.4.5 </span>A user class</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-conclusion" class="heading hyperref"><span class="number">4.5 </span>Conclusion</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-exercises" class="heading hyperref"><span class="number">4.6 </span>Exercises</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="heading hyperref"><span class="number">Chapter 5 </span>Filling in the layout</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-structure" class="heading hyperref"><span class="number">5.1 </span>Adding some structure</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_to_the_layout" class="heading hyperref"><span class="number">5.1.1 </span>Site navigation</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="heading hyperref"><span class="number">5.1.2 </span>Bootstrap and custom CSS</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-partials" class="heading hyperref"><span class="number">5.1.3 </span>Partials</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass_and_the_asset_pipeline" class="heading hyperref"><span class="number">5.2 </span>Sass and the asset pipeline</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_asset_pipeline" class="heading hyperref"><span class="number">5.2.1 </span>The asset pipeline</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass" class="heading hyperref"><span class="number">5.2.2 </span>Syntactically awesome stylesheets</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_links" class="heading hyperref"><span class="number">5.3 </span>Layout links</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-route_tests" class="heading hyperref"><span class="number">5.3.1 </span>Route tests</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_routes" class="heading hyperref"><span class="number">5.3.2 </span>Rails routes</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-named_routes" class="heading hyperref"><span class="number">5.3.3 </span>Named routes</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pretty_rspec" class="heading hyperref"><span class="number">5.3.4 </span>Pretty RSpec</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_signup" class="heading hyperref"><span class="number">5.4 </span>User signup: A first step</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-users_controller" class="heading hyperref"><span class="number">5.4.1 </span>Users controller</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_url" class="heading hyperref"><span class="number">5.4.2 </span>Signup URL</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_conclusion" class="heading hyperref"><span class="number">5.5 </span>Conclusion</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_exercises" class="heading hyperref"><span class="number">5.6 </span>Exercises</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="heading hyperref"><span class="number">Chapter 6 </span>Modeling users</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_model" class="heading hyperref"><span class="number">6.1 </span>User model</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-database_migrations" class="heading hyperref"><span class="number">6.1.1 </span>Database migrations</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_model_file" class="heading hyperref"><span class="number">6.1.2 </span>The model file</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_user_objects" class="heading hyperref"><span class="number">6.1.3 </span>Creating user objects</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="heading hyperref"><span class="number">6.1.4 </span>Finding user objects</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_user_objects" class="heading hyperref"><span class="number">6.1.5 </span>Updating user objects</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_validations" class="heading hyperref"><span class="number">6.2 </span>User validations</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-initial_user_tests" class="heading hyperref"><span class="number">6.2.1 </span>Initial user tests</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-presence_validation" class="heading hyperref"><span class="number">6.2.2 </span>Validating presence</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-length_validation" class="heading hyperref"><span class="number">6.2.3 </span>Length validation</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-format_validation" class="heading hyperref"><span class="number">6.2.4 </span>Format validation</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-uniqueness_validation" class="heading hyperref"><span class="number">6.2.5 </span>Uniqueness validation</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_secure_password" class="heading hyperref"><span class="number">6.3 </span>Adding a secure password</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_hashed_password" class="heading hyperref"><span class="number">6.3.1 </span>A hashed password</a></li><li class="subsection"><a href="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io.html" class="heading hyperref"><span class="number">6.3.2 </span>Password and confirmation</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_authentication" class="heading hyperref"><span class="number">6.3.3 </span>User authentication</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-has_secure_password" class="heading hyperref"><span class="number">6.3.4 </span>User has secure password</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_a_user" class="heading hyperref"><span class="number">6.3.5 </span>Creating a user</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid37" class="heading hyperref"><span class="number">6.4 </span>Conclusion</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_users_exercises" class="heading hyperref"><span class="number">6.5 </span>Exercises</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="heading hyperref"><span class="number">Chapter 7 </span>Sign up</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_users" class="heading hyperref"><span class="number">7.1 </span>Showing users</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_environments" class="heading hyperref"><span class="number">7.1.1 </span>Debug and Rails environments</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="heading hyperref"><span class="number">7.1.2 </span>A Users resource</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-tests_with_factories" class="heading hyperref"><span class="number">7.1.3 </span>Testing the user show page (with factories)</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_gravatar_image" class="heading hyperref"><span class="number">7.1.4 </span>A Gravatar image and a sidebar</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_form" class="heading hyperref"><span class="number">7.2 </span>Signup form</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-tests_for_user_signup" class="heading hyperref"><span class="number">7.2.1 </span>Tests for user signup</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-using_form_for" class="heading hyperref"><span class="number">7.2.2 </span>Using <span class="tt">form_for</span></a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_form_html" class="heading hyperref"><span class="number">7.2.3 </span>The form HTML</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_failure" class="heading hyperref"><span class="number">7.3 </span>Signup failure</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_form" class="heading hyperref"><span class="number">7.3.1 </span>A working form</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strong_parameters" class="heading hyperref"><span class="number">7.3.2 </span>Strong parameters</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_error_messages" class="heading hyperref"><span class="number">7.3.3 </span>Signup error messages</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_success" class="heading hyperref"><span class="number">7.4 </span>Signup success</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_finished_signup_form" class="heading hyperref"><span class="number">7.4.1 </span>The finished signup form</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_flash" class="heading hyperref"><span class="number">7.4.2 </span>The flash</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_signup" class="heading hyperref"><span class="number">7.4.3 </span>The first signup</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying_to_production_with_ssl" class="heading hyperref"><span class="number">7.4.4 </span>Deploying to production with SSL</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid44" class="heading hyperref"><span class="number">7.5 </span>Conclusion</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_exercises" class="heading hyperref"><span class="number">7.6 </span>Exercises</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="heading hyperref"><span class="number">Chapter 8 </span>Sign in, sign out</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_failure" class="heading hyperref"><span class="number">8.1 </span>Sessions and signin failure</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sessions_controller" class="heading hyperref"><span class="number">8.1.1 </span>Sessions controller</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_tests" class="heading hyperref"><span class="number">8.1.2 </span>Signin tests</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_form" class="heading hyperref"><span class="number">8.1.3 </span>Signin form</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-reviewing_form_submission" class="heading hyperref"><span class="number">8.1.4 </span>Reviewing form submission</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rendering_with_a_flash_message" class="heading hyperref"><span class="number">8.1.5 </span>Rendering with a flash message</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_success" class="heading hyperref"><span class="number">8.2 </span>Signin success</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="heading hyperref"><span class="number">8.2.1 </span>Remember me</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_sign_in_method" class="heading hyperref"><span class="number">8.2.2 </span>A working <span class="tt">sign_in</span> method</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-current_user" class="heading hyperref"><span class="number">8.2.3 </span>Current user</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-changing_the_layout_links" class="heading hyperref"><span class="number">8.2.4 </span>Changing the layout links</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_upon_signup" class="heading hyperref"><span class="number">8.2.5 </span>Signin upon signup</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signing_out" class="heading hyperref"><span class="number">8.2.6 </span>Signing out</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-cucumber" class="heading hyperref"><span class="number">8.3 </span>Introduction to cucumber (optional)</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-installation_and_setup" class="heading hyperref"><span class="number">8.3.1 </span>Installation and setup</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-features_and_steps" class="heading hyperref"><span class="number">8.3.2 </span>Features and steps</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rspec_custom_matchers" class="heading hyperref"><span class="number">8.3.3 </span>Counterpoint: RSpec custom matchers</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid50" class="heading hyperref"><span class="number">8.4 </span>Conclusion</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sign_in_out_exercises" class="heading hyperref"><span class="number">8.5 </span>Exercises</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="heading hyperref"><span class="number">Chapter 9 </span>Updating, showing, and deleting users</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_users" class="heading hyperref"><span class="number">9.1 </span>Updating users</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-edit_form" class="heading hyperref"><span class="number">9.1.1 </span>Edit form</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-unsuccessful_edits" class="heading hyperref"><span class="number">9.1.2 </span>Unsuccessful edits</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-successful_edits" class="heading hyperref"><span class="number">9.1.3 </span>Successful edits</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-authorization" class="heading hyperref"><span class="number">9.2 </span>Authorization</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-requiring_signed_in_users" class="heading hyperref"><span class="number">9.2.1 </span>Requiring signed-in users</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-requiring_the_right_user" class="heading hyperref"><span class="number">9.2.2 </span>Requiring the right user</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-friendly_forwarding" class="heading hyperref"><span class="number">9.2.3 </span>Friendly forwarding</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_all_users" class="heading hyperref"><span class="number">9.3 </span>Showing all users</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_index" class="heading hyperref"><span class="number">9.3.1 </span>User index</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_users" class="heading hyperref"><span class="number">9.3.2 </span>Sample users</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pagination" class="heading hyperref"><span class="number">9.3.3 </span>Pagination</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-partial_refactoring" class="heading hyperref"><span class="number">9.3.4 </span>Partial refactoring</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-destroying_users" class="heading hyperref"><span class="number">9.4 </span>Deleting users</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-administrative_users" class="heading hyperref"><span class="number">9.4.1 </span>Administrative users</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_destroy_action" class="heading hyperref"><span class="number">9.4.2 </span>The <span class="tt">destroy</span> action</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_and_deleting_users_conclusion" class="heading hyperref"><span class="number">9.5 </span>Conclusion</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="heading hyperref"><span class="number">9.6 </span>Exercises</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="heading hyperref"><span class="number">Chapter 10 </span>User microposts</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_micropost_model" class="heading hyperref"><span class="number">10.1 </span>A Micropost model</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_basic_model" class="heading hyperref"><span class="number">10.1.1 </span>The basic model</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_micropost_validation" class="heading hyperref"><span class="number">10.1.2 </span>The first validation</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_micropost_associations" class="heading hyperref"><span class="number">10.1.3 </span>User/Micropost associations</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ordering_and_dependency" class="heading hyperref"><span class="number">10.1.4 </span>Micropost refinements</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-micropost_validations" class="heading hyperref"><span class="number">10.1.5 </span>Content validations</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_microposts" class="heading hyperref"><span class="number">10.2 </span>Showing microposts</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-augmenting_the_user_show_page" class="heading hyperref"><span class="number">10.2.1 </span>Augmenting the user show page</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_microposts" class="heading hyperref"><span class="number">10.2.2 </span>Sample microposts</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-manipulating_microposts" class="heading hyperref"><span class="number">10.3 </span>Manipulating microposts</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-access_control" class="heading hyperref"><span class="number">10.3.1 </span>Access control</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_microposts" class="heading hyperref"><span class="number">10.3.2 </span>Creating microposts</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_proto_feed" class="heading hyperref"><span class="number">10.3.3 </span>A proto-feed</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-destroying_microposts" class="heading hyperref"><span class="number">10.3.4 </span>Destroying microposts</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid63" class="heading hyperref"><span class="number">10.4 </span>Conclusion</a></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-micropost_exercises" class="heading hyperref"><span class="number">10.5 </span>Exercises</a></li></ul></li><li class="chapter"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="heading hyperref"><span class="number">Chapter 11 </span>Following users</a></li><li><ul><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_relationship_model" class="heading hyperref"><span class="number">11.1 </span>The Relationship model</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_problem_with_the_data_model" class="heading hyperref"><span class="number">11.1.1 </span>A problem with the data model (and a solution)</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-relationship_user_associations" class="heading hyperref"><span class="number">11.1.2 </span>User/relationship associations</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-relationship_validations" class="heading hyperref"><span class="number">11.1.3 </span>Validations</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following" class="heading hyperref"><span class="number">11.1.4 </span>Followed users</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-followers" class="heading hyperref"><span class="number">11.1.5 </span>Followers</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_web_interface_for_following_and_followers" class="heading hyperref"><span class="number">11.2 </span>A web interface for following users</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_following_data" class="heading hyperref"><span class="number">11.2.1 </span>Sample following data</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-stats_and_a_follow_form" class="heading hyperref"><span class="number">11.2.2 </span>Stats and a follow form</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_and_followers_pages" class="heading hyperref"><span class="number">11.2.3 </span>Following and followers pages</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_the_standard_way" class="heading hyperref"><span class="number">11.2.4 </span>A working follow button the standard way</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_with_ajax" class="heading hyperref"><span class="number">11.2.5 </span>A working follow button with Ajax</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_status_feed" class="heading hyperref"><span class="number">11.3 </span>The status feed</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-motivation_and_strategy" class="heading hyperref"><span class="number">11.3.1 </span>Motivation and strategy</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_first_feed_implementation" class="heading hyperref"><span class="number">11.3.2 </span>A first feed implementation</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-scopes_subselects_and_a_lambda" class="heading hyperref"><span class="number">11.3.3 </span>Subselects</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_new_status_feed" class="heading hyperref"><span class="number">11.3.4 </span>The new status feed</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_conclusion" class="heading hyperref"><span class="number">11.4 </span>Conclusion</a></li><li><ul><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-extensions_to_the_sample_application" class="heading hyperref"><span class="number">11.4.1 </span>Extensions to the sample application</a></li><li class="subsection"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-guide_to_further_resources" class="heading hyperref"><span class="number">11.4.2 </span>Guide to further resources</a></li></ul></li><li class="section"><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_exercises" class="heading hyperref"><span class="number">11.5 </span>Exercises</a></li></ul></li></ul></div>
<div class="chapter-star" id="_foreword"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#foreword" class="heading hyperref">Foreword</a></h1>
<p>My former company (CD Baby) was one of the first to loudly switch to Ruby on Rails, and then even more loudly switch back to PHP (Google me to read about the drama).<span class="intersentencespace"></span> This book by Michael Hartl came so highly recommended that I had to try it, and the <em>Ruby on Rails Tutorial</em> is what I used to switch back to Rails again.</p>
<p>Though I’ve worked my way through many Rails books, this is the one that finally made me “get” it.<span class="intersentencespace"></span> Everything is done very much “the Rails way”—a way that felt very unnatural to me before, but now after doing this book finally feels natural.<span class="intersentencespace"></span> This is also the only Rails book that does test-driven development the entire time, an approach highly recommended by the experts but which has never been so clearly demonstrated before.<span class="intersentencespace"></span> Finally, by including Git, GitHub, and Heroku in the demo examples, the author really gives you a feel for what it’s like to do a real-world project.<span class="intersentencespace"></span> The tutorial’s code examples are not in isolation.</p>
<p>The linear narrative is such a great format.<span class="intersentencespace"></span> Personally, I powered through the <em>Rails Tutorial</em> in three long days, doing all the examples and challenges at the end of each chapter.<span class="intersentencespace"></span> Do it from start to finish, without jumping around, and you’ll get the ultimate benefit.</p>
<p>Enjoy!</p>
<p><a href="http://sivers.org/" target="_blank">Derek Sivers</a> (<a href="http://sivers.org/" target="_blank">sivers.org</a>) <span class="break"></span>
<em>Founder, CD Baby</em></p>
</div>
<div class="chapter-star" id="_acknowledgments"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#acknowledgments" class="heading hyperref">Acknowledgments</a></h1>
<p>The <em>Ruby on Rails Tutorial</em> owes a lot to my previous Rails book, <em>RailsSpace</em>, and hence to my coauthor <a href="http://aure.com/" target="_blank">Aurelius Prochazka</a>.<span class="intersentencespace"></span> I’d like to thank Aure both for the work he did on that book and for his support of this one.<span class="intersentencespace"></span> I’d also like to thank Debra Williams Cauley, my editor on both <em>RailsSpace</em> and the <em>Ruby on Rails Tutorial</em>; as long as she keeps taking me to baseball games, I’ll keep writing books for her.</p>
<p>I’d like to acknowledge a long list of Rubyists who have taught and inspired me over the years: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Pratik Naik, Sarah Mei, Sarah Allen, Wolfram Arnold, Alex Chaffee, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, the good people at Pivotal Labs, the Heroku gang, the thoughtbot guys, and the GitHub crew.<span class="intersentencespace"></span> Finally, many, many readers—far too many to list—have contributed a huge number of bug reports and suggestions during the writing of this book, and I gratefully acknowledge their help in making it as good as it can&nbsp;be.</p>
</div>
<div class="chapter-star" id="_about_the_author"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#about_the_author" class="heading hyperref">About the author</a></h1>
<p><a href="http://michaelhartl.com/" target="_blank">Michael Hartl</a> is the author of the <a href="http://www.railstutorial.org/" target="_blank"><em>Ruby on Rails Tutorial</em></a>, the leading introduction to web development with <a href="http://rubyonrails.org/" target="_blank">Ruby on Rails</a>.<span class="intersentencespace"></span> His prior experience includes writing and developing <em>RailsSpace</em>, an extremely obsolete Rails tutorial book, and developing Insoshi, a once-popular and now-obsolete social networking platform in Ruby on Rails.<span class="intersentencespace"></span> In 2011, Michael received a <a href="http://rubyheroes.com/heroes" target="_blank">Ruby Hero Award</a> for his contributions to the Ruby community.<span class="intersentencespace"></span> He is a graduate of <a href="http://college.harvard.edu/" target="_blank">Harvard College</a>, has a <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626" target="_blank">Ph.D. in Physics</a> from <a href="http://www.caltech.edu/" target="_blank">Caltech</a>, and is an alumnus of the <a href="http://ycombinator.com/" target="_blank">Y&nbsp;Combinator</a> entrepreneur program.</p>
</div>
<div class="chapter-star" id="_copyright_and_license"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#copyright_and_license" class="heading hyperref">Copyright and license</a></h1>
<p><em>Ruby on Rails Tutorial: Learn Web Development with Rails</em>.<span class="intersentencespace"></span> Copyright © 2013 by Michael Hartl.<span class="intersentencespace"></span> All source code in the <em>Ruby on Rails Tutorial</em> is available jointly under the <a href="http://opensource.org/licenses/MIT" target="_blank">MIT License</a> and the <a href="http://people.freebsd.org/~phk/" target="_blank">Beerware License</a>.</p>
<div class="code"><div class="highlight"><pre>The MIT License

Copyright (c) 2013 Michael Hartl

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
</pre></div></div>
<div class="code"><div class="highlight"><pre>/*
 * ----------------------------------------------------------------------------
 * "THE BEER-WARE LICENSE" (Revision 42):
 * Michael Hartl wrote this code. As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 * ----------------------------------------------------------------------------
 */
</pre></div></div>
</div></div>

<div id="_cha-beginning" data-tralics-id="cid1" class="chapter" data-number="1"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-beginning" class="heading hyperref"><span class="number">Chapter 1 </span>From zero to deploy</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>Welcome to the <a href="http://www.railstutorial.org/book" target="_blank"><em>Ruby on Rails Tutorial</em></a>.<span class="intersentencespace"></span> The goal of this book is to be the best answer to the question, “If I want to learn web development with <a href="http://rubyonrails.org/" target="_blank">Ruby on Rails</a>, where should I start?”<span class="intersentencespace"></span> By the time you finish the <em>Ruby on Rails Tutorial</em>, you will have all the skills you need to develop and deploy your own custom web applications with Rails.<span class="intersentencespace"></span> You will also be ready to benefit from the many more advanced books, blogs, and screencasts that are part of the thriving Rails educational ecosystem.<span class="intersentencespace"></span> Finally, since the <em>Ruby on Rails Tutorial</em> uses Rails&nbsp;4, the knowledge you gain here represents the state of the art in web development.<span class="intersentencespace"></span> (The most up-to-date version of the <em>Ruby on Rails Tutorial</em> can be found on the book’s website at <a href="http://www.railstutorial.org/" target="_blank">http://www.railstutorial.org/</a>; if you are reading this book offline, be sure to check the <a href="http://www.railstutorial.org/book" target="_blank">online version of the Rails Tutorial book</a> at <a href="http://www.railstutorial.org/book" target="_blank">http://www.railstutorial.org/book</a> for the latest updates.)</p>
<p>(<em>Note</em>: The present volume is the Rails&nbsp;4.0 <em>version</em> of the book, which means that it has been revised to be compatible with Rails&nbsp;4.0, but it is not yet a new <em>edition</em> because the changes in Rails don’t yet justify it.<span class="intersentencespace"></span> From the perspective of an introductory tutorial, the differences between Rails&nbsp;4.0 and the previous version, Rails&nbsp;3.2, are slight.<span class="intersentencespace"></span> Indeed, although there are a large number of miscellaneous small changes (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-diffs" class="hyperref">Box&nbsp;<span class="ref">1.1</span></a>), for our purposes there is only one significant difference, a new security technique called <em>strong parameters</em>, covered in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strong_parameters" class="hyperref">Section&nbsp;<span class="ref">7.3.2</span></a>.<span class="intersentencespace"></span> Once the changes in Rails justify the effort, I plan to prepare a full new edition of the <em>Rails Tutorial</em>.)</p>
<div class="aside" id="_sidebar-diffs" data-tralics-id="uid1" data-number="1.1"><div class="heading"><span class="number">Box 1.1.</span> 

<span class="description">Diffs from the 2nd edition</span></div>
<p>This is a (nearly) comprehensive list of differences between the 2nd edition of the <em>Ruby on Rails Tutorial</em> and the present version.<span class="intersentencespace"></span> (The only really important one is the change to strong parameters; the others are all relatively minor.)<span class="intersentencespace"></span> This list is presented for the convenience of those who read the 2nd edition (or are otherwise familiar with Rails&nbsp;3.2) and want a summary of the diffs.<span class="intersentencespace"></span> If you don’t already have experience with Rails&nbsp;3.2, you should probably ignore this list.</p>
<p>In what follows, each item includes a reference to a section or code listing with an example of the change in question.</p>
<ul>
<li>Change Rails&nbsp;3.2 to Rails&nbsp;4.0 (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rubygems" class="hyperref">Section&nbsp;<span class="ref">1.2.2</span></a>)
</li>
<li>Explicitly include Capybara DSL (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-capybara_dsl" class="hyperref">Listing&nbsp;<span class="ref">3.10</span></a>)
</li>
<li>Change RSpec <code>.should</code> to <code>expect().to</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-TDD" class="hyperref">Section&nbsp;<span class="ref">3.2.1</span></a>)
</li>
<li>Change <code>have_selector(’title’, …)</code> to <code>have_title(…)</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-testing_a_title_change" class="hyperref">Section&nbsp;<span class="ref">3.3.1</span></a>)
</li>
<li>Change HTTP verb from <span class="tt">PUT</span> to <span class="tt">PATCH</span> for updates (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-get_etc" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>)
</li>
<li>Add hash arguments for Turbolinks to stylesheets and JavaScripts (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout" class="hyperref">Listing&nbsp;<span class="ref">3.26</span></a>)
</li>
<li>Change <code>root to: ’path’</code> to <code>root ’path’</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-root_route" class="hyperref">Listing&nbsp;<span class="ref">5.26</span></a>)
</li>
<li>Change <code>find_by_thing(…)</code> to <code>find_by(thing: …)</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>)
</li>
<li>Switch from <code>rake db:test:prepare</code> to <code>rake test:prepare</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-initial_user_tests" class="hyperref">Section&nbsp;<span class="ref">6.2.1</span></a>)
</li>
<li>Change from <code>attr_accessible</code> to strong parameters (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strong_parameters" class="hyperref">Section&nbsp;<span class="ref">7.3.2</span></a>)
</li>
<li>Change to hashed remember tokens (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a>)
</li>
<li>Change <code>before_filter</code> to <code>before_action</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authorize_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.12</span></a>)
</li>
<li>Use Capybara’s <code>match: :first</code> to click on the first matching link (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-delete_link_tests" class="hyperref">Listing&nbsp;<span class="ref">9.42</span></a>)
</li>
<li>Change <code>default_scope</code> from a hash argument to a lambda (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_ordering" class="hyperref">Listing&nbsp;<span class="ref">10.11</span></a>)
</li>
<li>Change <code>dup</code> to <code>to_a</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_dependency_test" class="hyperref">Listing&nbsp;<span class="ref">10.12</span></a>)
</li>
<li>Use XPath to test button toggling (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a>)
</li></ul>

</div><p>It’s worth emphasizing that the goal of this book is <em>not</em> merely to teach Rails, but rather to teach <em>web development with Rails</em>, which means acquiring (or expanding) the skills needed to develop software for the World Wide Web.<span class="intersentencespace"></span> In addition to Ruby on Rails, this skillset includes HTML &amp; CSS, databases, version control, testing, and deployment.<span class="intersentencespace"></span> To accomplish this goal, the <em>Ruby on Rails Tutorial</em> takes an integrated approach: you will learn Rails by example by building a substantial sample application from scratch.<span class="intersentencespace"></span> As <a href="http://sivers.org/" target="_blank">Derek Sivers</a> notes in the foreword, this book is structured as a linear narrative, designed to be read from start to finish.<span class="intersentencespace"></span> If you are used to skipping around in technical books, taking this linear approach might require some adjustment, but I suggest giving it a try.<span class="intersentencespace"></span> You can think of the <em>Ruby on Rails Tutorial</em> as a video game where you are the main character, and where you level up as a Rails developer in each chapter.<span class="intersentencespace"></span> (The exercises are the <a href="http://en.wikipedia.org/wiki/Boss_(video_gaming)#Miniboss" target="_blank">minibosses</a>.)</p>
<p>In this first chapter, we’ll get started with Ruby on Rails by installing all the necessary software and by setting up our development environment (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-up_and_running" class="hyperref">Section&nbsp;<span class="ref">1.2</span></a>).<span class="intersentencespace"></span> We’ll then create our first Rails application, called (appropriately enough) <code>first_app</code>.<span class="intersentencespace"></span> The <em>Rails Tutorial</em> emphasizes good software development practices, so immediately after creating our fresh new Rails project we’ll put it under version control with Git (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-version_control" class="hyperref">Section&nbsp;<span class="ref">1.3</span></a>).<span class="intersentencespace"></span> And, believe it or not, in this chapter we’ll even put our first app on the wider web by <em>deploying</em> it to production (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying" class="hyperref">Section&nbsp;<span class="ref">1.4</span></a>).</p>
<p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a>, we’ll make a second project, whose purpose is to demonstrate the basic workings of a Rails application.<span class="intersentencespace"></span> To get up and running quickly, we’ll build this <em>demo app</em> (called <code>demo_app</code>) using scaffolding (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-scaffolding" class="hyperref">Box&nbsp;<span class="ref">1.2</span></a>) to generate code; since this code is both ugly and complex, <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a> will focus on interacting with the demo app through its <em>URIs</em> (often called <em>URLs</em>)<sup id="_cha-1_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-1">1</a></sup> using a web browser.</p>
<p>The rest of the tutorial focuses on developing a single large <em>sample application</em> (called <code>sample_app</code>), writing all the code from scratch.<span class="intersentencespace"></span> We’ll develop the sample app using <em>test-driven development</em> (TDD), getting started in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a> by creating static pages and then adding a little dynamic content.<span class="intersentencespace"></span> We’ll take a quick detour in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-rails_flavored_ruby" class="hyperref">Chapter&nbsp;<span class="ref">4</span></a> to learn a little about the Ruby language underlying Rails.<span class="intersentencespace"></span> Then, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a> through <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>, we’ll complete the foundation for the sample application by making a site layout, a user data model, and a full registration and authentication system.<span class="intersentencespace"></span> Finally, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a> we’ll add microblogging and social features to make a working example site.</p>
<p>The final sample application will bear more than a passing resemblance to a certain popular <a href="http://twitter.com/" target="_blank">social microblogging site</a>—a site which, coincidentally, was also originally written in Rails.<span class="intersentencespace"></span> Though of necessity our efforts will focus on this specific sample application, the emphasis throughout the <em>Rails Tutorial</em> will be on general principles, so that you will have a solid foundation no matter what kinds of web applications you want to build.</p>
<div class="aside" id="_sidebar-scaffolding" data-tralics-id="uid19" data-number="1.2"><div class="heading"><span class="number">Box 1.2.</span> 

<span class="description">Scaffolding: Quicker, easier, more seductive</span></div>
<p>From the beginning, Rails has benefited from a palpable sense of excitement, starting with the famous <a href="http://www.youtube.com/watch?v=Gzj723LkRJY" target="_blank">15-minute weblog video</a> by Rails creator David Heinemeier Hansson.<span class="intersentencespace"></span> That video and its successors are a great way to get a taste of Rails’ power, and I recommend watching them.<span class="intersentencespace"></span> But be warned: they accomplish their amazing fifteen-minute feat using a feature called <em>scaffolding</em>, which relies heavily on <em>generated code</em>, magically created by the Rails <code>generate</code> command.</p>
<p>When writing a Ruby on Rails tutorial, it is tempting to rely on the scaffolding approach—it’s <a href="http://en.wikipedia.org/wiki/Dark_side_(Star_Wars)" target="_blank">quicker, easier, more seductive</a>.<span class="intersentencespace"></span> But the complexity and sheer amount of code in the scaffolding can be utterly overwhelming to a beginning Rails developer; you may be able to use it, but you probably won’t understand it.<span class="intersentencespace"></span> Following the scaffolding approach risks turning you into a virtuoso script generator with little (and brittle) actual knowledge of Rails.</p>
<p>In the <em>Ruby on Rails Tutorial</em>, we’ll take the (nearly) polar opposite approach: although <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a> will develop a small demo app using scaffolding, the core of the <em>Rails Tutorial</em> is the sample app, which we’ll start writing in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a>.<span class="intersentencespace"></span> At each stage of developing the sample application, we will write <em>small, bite-sized</em> pieces of code—simple enough to understand, yet novel enough to be challenging.<span class="intersentencespace"></span> The cumulative effect will be a deeper, more flexible knowledge of Rails, giving you a good background for writing nearly any type of web application.</p>

</div></div>
<div id="_sec-introduction" data-tralics-id="cid2" class="section" data-number="1.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-introduction" class="heading hyperref"><span class="number">1.1 </span>Introduction</a></h2>
<p>Since its debut in 2004, Ruby on Rails has rapidly become one of the most powerful and popular frameworks for building dynamic web applications.<span class="intersentencespace"></span> Everyone from scrappy startups to huge companies have used Rails: <a href="http://37signals.com/" target="_blank">37signals</a>, <a href="http://github.com/" target="_blank">GitHub</a>, <a href="http://shopify.com/" target="_blank">Shopify</a>, <a href="http://scribd.com/" target="_blank">Scribd</a>, <a href="http://twitter.com/" target="_blank">Twitter</a>, <a href="http://disney.com/" target="_blank">Disney</a>, <a href="http://hulu.com/" target="_blank">Hulu</a>, the <a href="http://yellowpages.com/" target="_blank">Yellow Pages</a>—the list of sites using Rails goes on and on.<span class="intersentencespace"></span> There are also many web development shops that specialize in Rails, such as <a href="http://entp.com/" target="_blank">ENTP</a>, <a href="http://thoughtbot.com/" target="_blank">thoughtbot</a>, <a href="http://pivotallabs.com/" target="_blank">Pivotal Labs</a>, and <a href="http://hashrocket.com/" target="_blank">Hashrocket</a>, plus innumerable independent consultants, trainers, and contractors.</p>
<p>What makes Rails so great?<span class="intersentencespace"></span> First of all, Ruby on Rails is 100% open-source, available under the permissive <a href="http://www.opensource.org/licenses/mit-license.php" target="_blank">MIT License</a>, and as a result it also costs nothing to download or use.<span class="intersentencespace"></span> Rails also owes much of its success to its elegant and compact design; by exploiting the malleability of the underlying <a href="http://ruby-lang.org/" target="_blank">Ruby</a> language, Rails effectively creates a <a href="http://en.wikipedia.org/wiki/Domain_Specific_Language" target="_blank">domain-specific language</a> for writing web applications.<span class="intersentencespace"></span> As a result, many common web programming tasks—such as generating HTML, making data models, and routing URLs—are easy with Rails, and the resulting application code is concise and readable.</p>
<p>Rails also adapts rapidly to new developments in web technology and framework design.<span class="intersentencespace"></span> For example, Rails was one of the first frameworks to fully digest and implement the REST architectural style for structuring web applications (which we’ll be learning about throughout this tutorial).<span class="intersentencespace"></span> And when other frameworks develop successful new techniques, Rails creator <a href="http://loudthinking.com/" target="_blank">David Heinemeier Hansson</a> and the <a href="http://rubyonrails.org/core" target="_blank">Rails core team</a> don’t hesitate to incorporate their ideas.<span class="intersentencespace"></span> Perhaps the most dramatic example is the merger of Rails and Merb, a rival Ruby web framework, so that Rails now benefits from Merb’s modular design, stable <a href="http://en.wikipedia.org/wiki/Application_programming_interface" target="_blank">API</a>, and improved performance.</p>
<p>Finally, Rails benefits from an unusually enthusiastic and diverse community.<span class="intersentencespace"></span> The results include hundreds of open-source <a href="http://contributors.rubyonrails.org/" target="_blank">contributors</a>, well-attended <a href="http://railsconf.com/" target="_blank">conferences</a>, a huge number of <a href="https://rubygems.org/" target="_blank">gems</a> (self-contained solutions to specific problems such as pagination and image upload), a rich variety of informative blogs, and a cornucopia of discussion forums and IRC channels.<span class="intersentencespace"></span> The large number of Rails programmers also makes it easier to handle the inevitable application errors: the “Google the error message” algorithm nearly always produces a relevant blog post or discussion-forum thread.</p>
<div id="_sec-comments_for_various_readers" data-tralics-id="uid20" class="subsection" data-number="1.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-comments_for_various_readers" class="heading hyperref"><span class="number">1.1.1 </span>Comments for various readers</a></h3>
<p>The <em>Rails Tutorial</em> contains integrated tutorials not only for Rails, but also for the underlying Ruby language, the RSpec testing framework, <a href="http://en.wikipedia.org/wiki/HTML" target="_blank">HTML</a>, <a href="http://en.wikipedia.org/wiki/CSS" target="_blank">CSS</a>, a small amount of <a href="http://en.wikipedia.org/wiki/JavaScript" target="_blank">JavaScript</a>, and even a little <a href="http://en.wikipedia.org/wiki/SQL" target="_blank">SQL</a>.<span class="intersentencespace"></span> This means that, no matter where you currently are in your knowledge of web development, by the time you finish this tutorial you will be ready for more advanced Rails resources, as well as for the more systematic treatments of the other subjects mentioned.<span class="intersentencespace"></span> It also means that there’s a <em>lot</em> of material to cover; if you don’t already have much experience programming computers, you might find it overwhelming.<span class="intersentencespace"></span> The comments below contain some suggestions for approaching the <em>Rails Tutorial</em> depending on your background.<span class="intersentencespace"></span> <span class="break"></span></p>
<p><strong>All readers:</strong> One common question when learning Rails is whether to learn Ruby first.<span class="intersentencespace"></span> The answer depends on your personal learning style and how much programming experience you already have.<span class="intersentencespace"></span> If you prefer to learn everything systematically from the ground up, or if you have never programmed before, then learning Ruby first might work well for you, and in this case I recommend <a href="http://www.amazon.com/gp/product/1430223634" target="_blank"><em>Beginning Ruby</em></a> by Peter Cooper.<span class="intersentencespace"></span> On the other hand, many beginning Rails developers are excited about making <em>web</em> applications, and would rather not slog through a 500-page book on pure Ruby before ever writing a single web page.<span class="intersentencespace"></span> In this case, I recommend following the short interactive tutorial at <a href="http://tryruby.org/" target="_blank">Try Ruby</a>,<sup id="_cha-1_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-2">2</a></sup> and then optionally do the free tutorial at <a href="http://railsforzombies.org/" target="_blank">Rails for Zombies</a><sup id="_cha-1_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-3">3</a></sup> to get a taste of what Rails can do.</p>
<p>Another common question is whether to use tests from the start.<span class="intersentencespace"></span> As noted in the introduction, the <em>Rails Tutorial</em> uses test-driven development (also called test-first development), which in my view is the best way to develop Rails applications, but it does introduce a substantial amount of overhead and complexity.<span class="intersentencespace"></span> If you find yourself getting bogged down by the tests, I suggest either skipping them on a first reading or (even better) using them as a tool to verify your code’s correctness without worrying about how they work.<span class="intersentencespace"></span> This latter strategy involves creating the necessary test files (called <em>specs</em>) and filling them with the test code <em>exactly</em> as it appears in the book.<span class="intersentencespace"></span> You can then run the test suite (as described in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a>) to watch it fail, then write the application code as described in the tutorial, and finally re-run the test suite to watch it pass.<span class="intersentencespace"></span> <span class="break"></span></p>
<p><strong>Inexperienced programmers:</strong> The <em>Rails Tutorial</em> is not aimed principally at beginning programmers, and web applications, even relatively simple ones, are by their nature fairly complex.<span class="intersentencespace"></span> If you are completely new to web programming and find the <em>Rails Tutorial</em> too difficult, I suggest learning the basics of HTML and CSS and then giving the <em>Rails Tutorial</em> another go.<span class="intersentencespace"></span> (Unfortunately, I don’t have a personal recommendation here, but <a href="http://headfirstlabs.com/books/hfhtml/" target="_blank"><em>Head First HTML</em></a> looks promising, and one reader recommends <a href="http://www.amazon.com/gp/product/0596526873" target="_blank"><em>CSS: The Missing Manual</em></a> by David Sawyer McFarland.)<span class="intersentencespace"></span> You might also consider reading the first few chapters of <a href="http://www.amazon.com/gp/product/1430223634" target="_blank"><em>Beginning Ruby</em></a> by Peter Cooper, which starts with sample applications much smaller than a full-blown web app.<span class="intersentencespace"></span> That said, a surprising number of beginners have used this tutorial to learn web development, so I suggest giving it a try, and I especially recommend the <a href="http://www.railstutorial.org/screencasts" target="_blank"><em>Rails Tutorial</em> screencast series</a><sup id="_cha-1_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-4">4</a></sup> to give you an “over-the-shoulder” look at Rails software development.<span class="intersentencespace"></span> <span class="break"></span></p>
<p><strong>Experienced programmers new to web development:</strong> Your previous experience means you probably already understand ideas like classes, methods, data structures, etc., which is a big advantage.<span class="intersentencespace"></span> Be warned that if your background is in C/C++ or Java, you may find Ruby a bit of an odd duck, and it might take time to get used to it; just stick with it and eventually you’ll be fine.<span class="intersentencespace"></span> (Ruby even lets you put semicolons at the ends of lines if you miss them too much.)<span class="intersentencespace"></span> The <em>Rails Tutorial</em> covers all the web-specific ideas you’ll need, so don’t worry if you don’t currently know a <span class="tt">POST</span> from a <span class="tt">PATCH</span>.<span class="break"></span></p>
<p><strong>Experienced web developers new to Rails:</strong> You have a great head start, especially if you have used a dynamic language such as PHP or (even better) Python.<span class="intersentencespace"></span> The basics of what we cover will likely be familiar, but test-driven development may be new to you, as may be the structured REST style favored by Rails.<span class="intersentencespace"></span> Ruby has its own idiosyncrasies, so those will likely be new, too.<span class="break"></span></p>
<p><strong>Experienced Ruby programmers:</strong> The set of Ruby programmers who don’t know Rails is a small one nowadays, but if you are a member of this elite group you can fly through this book and then move on to developing applications of your own.<span class="break"></span></p>
<p><strong>Inexperienced Rails programmers:</strong> You’ve perhaps read some other tutorials and made a few small Rails apps yourself.<span class="intersentencespace"></span> Based on reader feedback, I’m confident that you can still get a lot out of this book.<span class="intersentencespace"></span> Among other things, the techniques here may be more up-to-date than the ones you picked up when you originally learned Rails.<span class="intersentencespace"></span> <span class="break"></span></p>
<p><strong>Experienced Rails programmers:</strong> This book is unnecessary for you, but many experienced Rails developers have expressed surprise at how much they learned from this book, and you might enjoy seeing Rails from a different perspective.<span class="intersentencespace"></span> <span class="break"></span></p>
<p>After finishing the <em>Ruby on Rails Tutorial</em>, I recommend that experienced programmers read <a href="http://www.amazon.com/gp/product/1933988657" target="_blank"><em>The Well-Grounded Rubyist</em></a> by David&nbsp;A. Black, <a href="http://www.amazon.com/Eloquent-Ruby-Addison-Wesley-Professional-Series/dp/0321584104/" target="_blank"><em>Eloquent Ruby</em></a> by Russ Olsen, or <a href="http://www.amazon.com/gp/product/0672328844" target="_blank"><em>The Ruby Way</em></a> by Hal Fulton, which is also fairly advanced but takes a more topical approach.<span class="intersentencespace"></span> <span class="break"></span></p>
<p>At the end of this process, no matter where you started, you should be ready for the many more intermediate-to-advanced Rails resources out there.<span class="intersentencespace"></span> Here are some I particularly recommend:</p>
<ul>
<li><a href="http://railscasts.com/" target="_blank">RailsCasts</a> by Ryan Bates: Excellent (mostly) free Rails screencasts
</li>
<li><a href="http://www.gotealeaf.com/railstutorial" target="_blank">Tealeaf Academy</a>: a good online Rails development bootcamp (includes advanced material)
</li>
<li><a href="http://mbsy.co/6VQ8l" target="_blank">Code School</a>: Interactive programming courses
</li>
<li><a href="http://guides.rubyonrails.org/" target="_blank">Rails Guides</a>: Good topical and up-to-date Rails references
</li></ul>
</div>
<div id="_uid28" data-tralics-id="uid28" class="subsection" data-number="1.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid28" class="heading hyperref"><span class="number">1.1.2 </span>“Scaling” Rails</a></h3>
<p>Before moving on with the rest of the introduction, I’d like to take a moment to address the one issue that dogged the Rails framework the most in its early days: the supposed inability of Rails to “scale”—i.e., to handle large amounts of traffic.<span class="intersentencespace"></span> Part of this issue relied on a misconception; <a href="http://idleprocess.wordpress.com/2009/11/24/presentation-summary-high-performance-at-massive-scale-lessons-learned-at-facebook/" target="_blank">you scale a <em>site</em>, not a framework</a>, and Rails, as awesome as it is, is only a framework.<span class="intersentencespace"></span> So the real question should have been, “Can a site built with Rails scale?”<span class="intersentencespace"></span> In any case, the question has now been definitively answered in the affirmative: some of the most heavily trafficked sites in the world use Rails.<span class="intersentencespace"></span> Actually <em>doing</em> the scaling is beyond the scope of just Rails, but rest assured that if <em>your</em> application ever needs to handle the load of Hulu or the Yellow Pages, Rails won’t stop you from taking over the world.</p>
</div>
<div id="_sec-conventions" data-tralics-id="uid29" class="subsection" data-number="1.1.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-conventions" class="heading hyperref"><span class="number">1.1.3 </span>Conventions in this book</a></h3>
<p>The conventions in this book are mostly self-explanatory.<span class="intersentencespace"></span> In this section, I’ll mention some that may not be.</p>
<p>Both the <a href="http://railstutorial.org/book" target="_blank">HTML</a> and <a href="http://railstutorial.org/" target="_blank">PDF</a> editions of this book are full of links, both to internal sections (such as <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-up_and_running" class="hyperref">Section&nbsp;<span class="ref">1.2</span></a>) and to external sites (such as the main <a href="http://rubyonrails.org/download" target="_blank">Ruby on Rails download</a> page).<sup id="_cha-1_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-5">5</a></sup></p>
<p>Many examples in this book use command-line commands.<span class="intersentencespace"></span> For simplicity, all command line examples use a Unix-style command line prompt (a dollar sign), as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">echo</span> <span class="s2">"hello, world"</span>
<span class="go">hello, world</span>
</pre></div></div>
<p>Windows users should understand that their systems will use the analogous angle prompt&nbsp;<code>&gt;</code>:</p>
<div class="code"><div class="highlight"><pre><span class="go">C:\Sites&gt; echo "hello, world"</span>
<span class="go">hello, world</span>
</pre></div></div>
<p>On Unix systems, some commands should be executed with <code>sudo</code>, which stands for “substitute user do”.<sup id="_cha-1_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-6">6</a></sup><span class="intersentencespace"></span> By default, a command executed with <code>sudo</code> is run as an administrative user, which has access to files and directories that normal users can’t touch, such as in this example from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rubygems" class="hyperref">Section&nbsp;<span class="ref">1.2.2</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> sudo ruby setup.rb
</pre></div></div>
<p>Most Unix/Linux/OS&nbsp;X systems require <code>sudo</code> by default, unless you are using Ruby Version Manager as suggested in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_ruby" class="hyperref">Section&nbsp;<span class="ref">1.2.2.3</span></a>; in this case, you would type this instead:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> ruby setup.rb
</pre></div></div>
<p>Rails comes with lots of commands that can be run at the command line.<span class="intersentencespace"></span> For example, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_server" class="hyperref">Section&nbsp;<span class="ref">1.2.5</span></a> we’ll run a local development web server as follows:</p>
<div class="code"><div class="highlight"><pre><span class="nv">$ </span>rails server
</pre></div></div>
<p>As with the command-line prompt, the <em>Rails Tutorial</em> uses the Unix convention for directory separators (i.e., a forward slash&nbsp;<code>/</code>).<span class="intersentencespace"></span> My Rails Tutorial sample application, for instance, lives in</p>
<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app
</pre></div></div>
<p>On Windows, the analogous directory would be</p>
<div class="code"><div class="highlight"><pre>C:\Sites\sample_app
</pre></div></div>
<p>The root directory for any given app is known as the <em>Rails root</em>, but this terminology is confusing and many people mistakenly believe that the “Rails root” is the root directory for Rails itself.<span class="intersentencespace"></span> For clarity, the <em>Rails Tutorial</em> will refer to the Rails root as the <em>application root</em>, and henceforth all directories will be relative to this directory.<span class="intersentencespace"></span> For example, the <code>config</code> directory of my sample application is</p>
<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app/config
</pre></div></div>
<p>The application root directory here is everything before <code>config</code>, i.e.,</p>
<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app
</pre></div></div>
<p>For brevity, when referring to the file</p>
<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app/config/routes.rb
</pre></div></div>
<p>I’ll omit the application root and simply write <code>config/routes.rb</code>.</p>
<p>The <em>Rails Tutorial</em> often shows output from various programs (shell commands, version control status, Ruby programs, etc.).<span class="intersentencespace"></span> Because of the innumerable small differences between different computer systems, the output you see may not always agree exactly with what is shown in the text,
but this is not cause for concern.</p>
<p>Some commands may produce errors depending on your system; rather than attempt the <a href="http://en.wikipedia.org/wiki/Sisyphus" target="_blank">Sisyphean</a> task of documenting all such errors in this tutorial, I will delegate to the “Google the error message” algorithm, which among other things is good practice for real-life software development.<span class="intersentencespace"></span> If you run into any problems while following the tutorial, I suggest consulting the resources listed on the <a href="http://railstutorial.org/help" target="_blank">Rails Tutorial help page</a>.<sup id="_cha-1_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-7">7</a></sup></p>
</div></div>
<div id="_sec-up_and_running" data-tralics-id="cid3" class="section" data-number="1.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-up_and_running" class="heading hyperref"><span class="number">1.2 </span>Up and running</a></h2>

<blockquote class="quote">I think of Chapter 1 as the “weeding out phase” in law school—if you can get your dev environment set up, the rest is easy to get through.<span class="intersentencespace"></span> <span class="break"></span> —Bob Cavezza, <em>Ruby on Rails Tutorial</em> reader</blockquote>
<p>It’s time now to get going with a Ruby on Rails development environment and our first application.<span class="intersentencespace"></span> There is quite a bit of overhead here, especially if you don’t have extensive programming experience, so don’t get discouraged if it takes a while to get started.<span class="intersentencespace"></span> It’s not just you; every developer goes through it (often more than once), but rest assured that the effort will be richly rewarded.</p>
<div id="_sec-development_tools" data-tralics-id="uid33" class="subsection" data-number="1.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-development_tools" class="heading hyperref"><span class="number">1.2.1 </span>Development environments</a></h3>
<p>Considering various idiosyncratic customizations, there are probably as many development environments as there are Rails programmers, but there are at least two broad types: text editor/command line environments, and integrated development environments (IDEs).<span class="intersentencespace"></span> Let’s consider the latter first.</p>
<div id="_uid34" data-tralics-id="uid34" class="subsubsection" data-number="1.2.1.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid34" class="heading">IDEs</a></h4>
<p>The most prominent Rails IDEs are <a href="http://www.aptana.com/rails/" target="_blank">RadRails</a> and <a href="http://www.jetbrains.com/ruby/index.html" target="_blank">RubyMine</a>.<span class="intersentencespace"></span> I’ve heard especially good things about RubyMine, and one reader (David Loeffler) has assembled <a href="https://github.com/perfectionist/sample_project/wiki" target="_blank">notes on how to use RubyMine with this tutorial</a>.<sup id="_cha-1_footnote-ref-8" class="footnote intersentence"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-8">8</a></sup><span class="intersentencespace"></span> If you’re comfortable using an IDE, I suggest taking a look at the options mentioned to see what fits with the way you work.</p>
</div>
<div id="_uid36" data-tralics-id="uid36" class="subsubsection" data-number="1.2.1.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid36" class="heading">Text editors and command lines</a></h4>
<p>Instead of using an IDE, I prefer to use a <em>text editor</em> to edit text, and a <em>command line</em> to issue commands (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-editor_shell" class="hyperref">Figure&nbsp;<span class="ref">1.1</span></a>).<span class="intersentencespace"></span> Which combination you use depends on your tastes and your platform.</p>
<ul>
<li><strong>Text editor:</strong> I recommend <a href="http://www.sublimetext.com/2" target="_blank">Sublime Text&nbsp;2</a>, an outstanding cross-platform text editor that is simultaneously easy to learn and industrial-strength.<sup id="_cha-1_footnote-ref-9" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-9">9</a></sup><span class="intersentencespace"></span> Sublime Text is heavily influenced by <a href="http://macromates.com/" target="_blank">TextMate</a>, and in fact is compatible with most TextMate customizations, such as snippets and color schemes.<span class="intersentencespace"></span> (TextMate, which is available only on OS&nbsp;X, is still a good choice if you use a Mac.)<span class="intersentencespace"></span> A second excellent choice is <a href="http://www.vim.org/" target="_blank">Vim</a>,<sup id="_cha-1_footnote-ref-10" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-10">10</a></sup> versions of which are available for all major platforms.<span class="intersentencespace"></span> Sublime Text can be obtained commercially, whereas Vim can be obtained at no cost; both are industrial-strength editors, but in my experience Sublime Text is <em>much</em> more accessible to beginners.
</li>
<li><strong>Terminal:</strong> On OS&nbsp;X, I recommend either use <a href="http://iterm.sourceforge.net/" target="_blank">iTerm</a> or the native Terminal app.<span class="intersentencespace"></span> On Linux, the default terminal is fine.<span class="intersentencespace"></span> On Windows, many users prefer to develop Rails applications in a virtual machine running Linux, in which case your command-line options reduce to the previous case.<span class="intersentencespace"></span> If developing within Windows itself, I recommend using the command prompt that comes with <a href="http://railsinstaller.org/" target="_blank">Rails Installer</a> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_installer_windows" class="hyperref">Section&nbsp;<span class="ref">1.2.2.1</span></a>).<span class="intersentencespace"></span>
</li></ul>
<p>If you decide to use Sublime Text, you might want to follow the optional setup instructions for <a href="https://github.com/mhartl/rails_tutorial_sublime_text" target="_blank">Rails Tutorial Sublime Text</a>.<sup id="_cha-1_footnote-ref-11" class="footnote intersentence"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-11">11</a></sup><span class="intersentencespace"></span> (Such configuration settings can be fiddly and error-prone, so I mainly recommend them for more advanced users; Sublime Text is an excellent choice for editing Rails applications even without the advanced setup.)</p>
<div class="center figure" id="_fig-editor_shell" data-tralics-id="uid42" data-number="1.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/editor_shell.png" alt="images/figures/editor_shell"></div><div class="caption"><span class="header">Figure 1.1: </span><span class="description">A text editor/command line development environment.<span class="intersentencespace"></span> <a href="http://railstutorial.org/images/figures/editor_shell-full.png" target="_blank">(full size)</a>
</span></div></div>
</div>
<div id="_uid43" data-tralics-id="uid43" class="subsubsection" data-number="1.2.1.3"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid43" class="heading">Browsers</a></h4>
<p>Although there are many web browsers to choose from, the vast majority of Rails programmers use Firefox, Safari, or Chrome when developing.<span class="intersentencespace"></span> All three browsers include a built-in “Inspect element” feature available by right- (or control-)clicking on any part of the page.</p>
</div>
<div id="_uid44" data-tralics-id="uid44" class="subsubsection" data-number="1.2.1.4"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid44" class="heading">A note about tools</a></h4>
<p>In the process of getting your development environment up and running, you may find that you spend a <em>lot</em> of time getting everything just right.<span class="intersentencespace"></span> The learning process for editors and IDEs is particularly long; you can spend weeks on Sublime Text or Vim tutorials alone.<span class="intersentencespace"></span> If you’re new to this game, I want to assure you that <em>spending time learning tools is normal</em>.<span class="intersentencespace"></span> Everyone goes through it.<span class="intersentencespace"></span> Sometimes it is frustrating, and it’s easy to get impatient when you have an awesome web app in your head and you <em>just want to learn Rails already</em>, but have to spend a week learning some weird ancient Unix editor just to get started.<span class="intersentencespace"></span> But, as with an apprentice carpenter striving to master the chisel or the <a href="https://en.wikipedia.org/wiki/Block_plane" target="_blank">plane</a>, there is no subsitute for mastering the tools of <em>your</em> trade, and in the end the reward is worth the effort.</p>
</div></div>
<div id="_sec-rubygems" data-tralics-id="uid45" class="subsection" data-number="1.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rubygems" class="heading hyperref"><span class="number">1.2.2 </span>Ruby, RubyGems, Rails, and Git</a></h3>

<blockquote class="quote">Practically all the software
in the world is either broken or very difficult to use.<span class="intersentencespace"></span> So users dread software.<span class="intersentencespace"></span> They’ve been trained that whenever they try to install something, or even fill out a form online, it’s not going to work.<span class="intersentencespace"></span> <em>I</em> dread installing stuff, and I have a Ph.D. in computer science.<span class="intersentencespace"></span> <span class="break"></span> —Paul Graham, in <em>Founders at Work</em> by Jessica Livingston</blockquote>
<p>Now it’s time to install Ruby and Rails.<span class="intersentencespace"></span> I’ve done my best to cover as many bases as possible, but systems vary, and many things can go wrong during these steps.<span class="intersentencespace"></span> Be sure to Google the error message or consult the <a href="http://railstutorial.org/help" target="_blank">Rails Tutorial help page</a> if you run into trouble.<span class="intersentencespace"></span> Also, there’s a new resource called <a href="http://www.installrails.com/" target="_blank">Install Rails</a> from <a href="https://onemonthrails.com/" target="_blank">One Month Rails</a> that might help you if you get stuck.</p>
<p><strong>Unless otherwise noted, you should use the exact versions of all software used in the tutorial, including Rails itself, if you want the same results.</strong><span class="intersentencespace"></span> Sometimes minor version differences will yield identical results, but you shouldn’t count on this, especially with respect to Rails versions.<span class="intersentencespace"></span> The main exception is Ruby itself: 1.9.3 and 2.0.0 are virtually identical for the purposes of this tutorial, so feel free to use either one.</p>
<div id="_sec-rails_installer_windows" data-tralics-id="uid46" class="subsubsection" data-number="1.2.2.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_installer_windows" class="heading">Rails Installer (Windows)</a></h4>
<p>Installing Rails on Windows used to be a real pain, but thanks to the efforts of the good people at <a href="http://engineyard.com/" target="_blank">Engine Yard</a>—especially Dr.&nbsp;Nic Williams and Wayne&nbsp;E. Seguin—installing Rails and related software on Windows is now easy.<span class="intersentencespace"></span> If you are using Windows, go to <a href="http://railsinstaller.org/" target="_blank">Rails Installer</a> and download the Rails Installer executable and view the excellent installation video.<span class="intersentencespace"></span> Double-click the executable and follow the instructions to install Git (so you can skip <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_git" class="hyperref">Section&nbsp;<span class="ref">1.2.2.2</span></a>), Ruby (skip <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_ruby" class="hyperref">Section&nbsp;<span class="ref">1.2.2.3</span></a>), RubyGems (skip <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_rubygems" class="hyperref">Section&nbsp;<span class="ref">1.2.2.4</span></a>), and Rails itself (skip <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_rails" class="hyperref">Section&nbsp;<span class="ref">1.2.2.5</span></a>).<span class="intersentencespace"></span> Once the installation has finished, you can skip right to the creation of the first application in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_application" class="hyperref">Section&nbsp;<span class="ref">1.2.3</span></a>.</p>
<p>Bear in mind that the Rails Installer might use a slightly different version of Rails from the one installed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_rails" class="hyperref">Section&nbsp;<span class="ref">1.2.2.5</span></a>, which might cause incompatibilities.<span class="intersentencespace"></span> To fix this, I am currently working with Nic and Wayne to create a list of Rails Installers ordered by Rails version number.</p>
</div>
<div id="_sec-install_git" data-tralics-id="uid47" class="subsubsection" data-number="1.2.2.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_git" class="heading">Install Git</a></h4>
<p>Much of the Rails ecosystem depends in one way or another on a <a href="http://en.wikipedia.org/wiki/Revision_control" target="_blank">version control system</a> called <a href="http://git-scm.com/" target="_blank">Git</a> (covered in more detail in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-version_control" class="hyperref">Section&nbsp;<span class="ref">1.3</span></a>).<span class="intersentencespace"></span> Because its use is ubiquitous, you should install Git even at this early stage; I suggest following the installation instructions for your platform at the <a href="http://www.git-scm.com/book/en/Getting-Started-Installing-Git" target="_blank">Installing Git section of <em>Pro Git</em></a>.</p>
</div>
<div id="_sec-install_ruby" data-tralics-id="uid48" class="subsubsection" data-number="1.2.2.3"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_ruby" class="heading">Install Ruby</a></h4>
<p>The next step is to install Ruby.<span class="intersentencespace"></span> (This can be painful and error-prone, and I actually dread having to install new versions of Ruby, but unfortunately it’s the cost of doing business.)</p>
<p>It’s possible that your system already has Ruby installed.<span class="intersentencespace"></span> Try running</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> ruby -v
</pre></div></div>
<p>to see the version number.<span class="intersentencespace"></span> Rails&nbsp;4 requires Ruby 1.9 or later and on most systems works best with Ruby&nbsp;2.0.<span class="intersentencespace"></span> (In particular, it won’t work Ruby 1.8.7.)<span class="intersentencespace"></span> This tutorial assumes that most readers are using Ruby&nbsp;1.9.3 or 2.0.0, but Ruby 1.9.2 should work as well.<span class="intersentencespace"></span> <strong>Note:</strong> I’ve had reports from Windows users that Ruby 2.0 is sketchy, so I recommend using Ruby 1.9.3 if you’re on Windows.</p>
<p>As part of installing Ruby, if you are using OS&nbsp;X or Linux I strongly recommend using <a href="http://rvm.io/" target="_blank">Ruby Version Manager (RVM)</a> or <a href="https://github.com/sstephenson/rbenv" target="_blank">rbenv</a>, which allow you to install and manage multiple versions of Ruby on the same machine.<span class="intersentencespace"></span> (The <a href="http://github.com/vertiginous/pik" target="_blank">Pik</a> project accomplishes a similar feat on Windows.)<span class="intersentencespace"></span> This is particularly important if you want to run different versions of Ruby or Rails on the same machine.<span class="intersentencespace"></span> Unfortunately, RVM and rbenv can’t be used on the same system simultaneously, and since I’ve been using RVM longer that’s the one I use in this tutorial.<span class="intersentencespace"></span> I hear great things about rbenv, though, so you should feel free to use that if you already know it or if you have access to a local rbenv expert.</p>
<p>As a prerequisite, OS&nbsp;X users may need to install the Xcode developer tools.<span class="intersentencespace"></span> To avoid the (huge) full installation, I recommend the much smaller <a href="https://developer.apple.com/downloads/" target="_blank">Command Line Tools for Xcode</a>.<sup id="_cha-1_footnote-ref-12" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-12">12</a></sup></p>
<p>To get started with the Ruby installation, first <a href="http://rvm.io/rvm/install/" target="_blank">install RVM</a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> curl -sSL https://get.rvm.io <span class="p">|</span> bash -s stable
</pre></div></div>
<p>(If you have RVM installed, you should run</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm get stable
</pre></div></div>
<p>to ensure that you have the latest version.)</p>
<p>You can then get Ruby set up by examining the requirements for installing it:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm requirements
</pre></div></div>
<p>If you get the message “command not found”, you should run <code>source</code> on the <code>rvm</code> executable:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">source</span> ~/.rvm/scripts/rvm
</pre></div></div>
<p>On my system, I had to install the following (using <a href="http://mxcl.github.com/homebrew/" target="_blank">Homebrew</a>, a package management system for OS&nbsp;X):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> brew install libtool libxslt libksba openssl
</pre></div></div>
<p>On Linux, you can accomplish similar things with <code>apt-get</code> or <code>yum</code>.</p>
<p>I also had to install a <a href="https://en.wikipedia.org/wiki/YAML" target="_blank">YAML</a> library:</p>
<div class="code"><div class="highlight"><pre><span class="gp">#</span> For Mac with Homebrew
<span class="gp">$</span> brew install libyaml

<span class="gp">#</span> For Debian-based Linux systems
<span class="gp">$</span> apt-get install libyaml-dev

<span class="gp">#</span> For Fedora/CentOS/RHEL Linux systems
<span class="gp">$</span> yum install libyaml-devel
</pre></div></div>
<p>Finally, I needed to tell RVM where OpenSSL was located when installing Ruby&nbsp;2.0.0:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm install 2.0.0 --with-openssl-dir<span class="o">=</span><span class="nv">$HOME</span>/.rvm/usr
<span class="go">&lt;wait a while&gt;</span>
</pre></div></div>
<p>On some systems, especially on Macs using Homebrew, the location of OpenSSL may be different, and you might have to run this command instead:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm install 2.0.0 --with-openssl-dir<span class="o">=</span><span class="nv">$HOME</span>/.rvm/opt/openssl
<span class="go">&lt;wait a while&gt;</span>
</pre></div></div>
<p>Unfortunately, lots of things can go wrong along the way.<span class="intersentencespace"></span> I’ve done my best to cover some of the most common cases, but the only general solution is web searches and determination.</p>
<p>After installing Ruby, you should configure your system for the other software needed to run Rails applications.<span class="intersentencespace"></span> This typically involves installing <em>gems</em>, which are self-contained packages of Ruby code.<span class="intersentencespace"></span> Since gems with different version numbers sometimes conflict, it is often convenient to create separate <em>gemsets</em>, which are self-contained bundles of gems.<span class="intersentencespace"></span> For the purposes of this tutorial, I suggest creating a gemset called <code>railstutorial_rails_4_0</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm use 2.0.0@railstutorial_rails_4_0 --create --default
<span class="go">Using /Users/mhartl/.rvm/gems/ruby-2.0.0-p0 with gemset railstutorial_rails_4_0</span>
</pre></div></div>
<p>This command creates (<span class="inline_verbatim">--create</span>) the gemset <code>railstutorial_rails_4_0</code> associated with Ruby&nbsp;2.0.0 while arranging to start using it immediately (<span class="inline_verbatim">use</span>) and setting it as the default (<span class="inline_verbatim">--default</span>) gemset, so that any time we open a new terminal window the <code>2.0.0@railstutorial_rails_4_0</code> Ruby/gemset combination is automatically selected.<span class="intersentencespace"></span> RVM supports a large variety of commands for manipulating gemsets; see the documentation at <a href="http://rvm.io/gemsets/" target="_blank">http://rvm.beginrescueend.com/gemsets/</a>.<span class="intersentencespace"></span> If you ever get stuck with RVM, running commands like these should help you get your bearings:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm <span class="nb">help</span>
<span class="gp">$</span><span class="nb"> </span>rvm gemset <span class="nb">help</span>
</pre></div></div>
<p>For more information on RVM, I also recommend taking a look at the article <a href="http://strandcode.com/2013/07/11/ruby-version-manager-rvm-overview-for-rails-newbs/" target="_blank">Ruby Version Manager (RVM) Overview for Rails Newbs</a>.<sup id="_cha-1_footnote-ref-13" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-13">13</a></sup></p>
</div>
<div id="_sec-install_rubygems" data-tralics-id="uid51" class="subsubsection" data-number="1.2.2.4"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_rubygems" class="heading">Install RubyGems</a></h4>
<p>RubyGems is a package manager for Ruby projects, and there are many useful libraries (including Rails) available as Ruby packages, or <em>gems</em>.<span class="intersentencespace"></span> Installing RubyGems should be easy once you install Ruby.<span class="intersentencespace"></span> In fact, if you have <a href="http://rvm.io/rvm/install/" target="_blank">installed RVM</a>, you already have RubyGems, since RVM includes it automatically:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> which gem
<span class="go">/Users/mhartl/.rvm/rubies/ruby-2.0.0-p0/bin/gem</span>
</pre></div></div>
<p>If you don’t already have it, you should <a href="http://rubygems.org/pages/download" target="_blank">download RubyGems</a>, extract it, and then go to the <code>rubygems</code> directory and run the setup program:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> ruby setup.rb
</pre></div></div>
<p>(If you get a permissions error here, recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-conventions" class="hyperref">Section&nbsp;<span class="ref">1.1.3</span></a> that you may have to use <code>sudo</code>.)</p>
<p>If you already have RubyGems installed, you should make sure your system uses the version used in this tutorial:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem update --system 2.1.9
</pre></div></div>
<p>Freezing your system to this particular version will help prevent conflicts as RubyGems changes in the future.</p>
<p>When installing gems, by default RubyGems generates two different kinds of documentation (called ri and rdoc), but many Ruby and Rails developers find that the time to build them isn’t worth the benefit.<span class="intersentencespace"></span> (Many programmers rely on online documentation instead of the native ri and rdoc documents.)<span class="intersentencespace"></span> To prevent the automatic generation of the documentation, I recommend making a gem configuration file called <code>.gemrc</code> in your home directory as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-create_gemrc" class="hyperref">Listing&nbsp;<span class="ref">1.1</span></a> with the line in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemrc" class="hyperref">Listing&nbsp;<span class="ref">1.2</span></a>.<span class="intersentencespace"></span> (The tilde&nbsp;“<span class="inline_verbatim">~</span>” means “home directory”, while the dot&nbsp;<span class="inline_verbatim">.</span> in <code>.gemrc</code> makes the file hidden, which is a common convention for configuration files.<span class="intersentencespace"></span> )</p>
<div class="codelisting" id="_code-create_gemrc" data-tralics-id="uid52" data-number="1.1"><div class="heading"><span class="number">Listing 1.1:</span> 

<span class="description">Creating a gem configuration file.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> subl ~/.gemrc
</pre></div></div></div><p>Here <code>subl</code> is the command-line command to launch Sublime Text on OS&nbsp;X, which you can set up using the <a href="http://www.sublimetext.com/docs/2/osx_command_line.html" target="_blank">Sublime Text&nbsp;2 documentation for the OS&nbsp;X command line</a>.<span class="intersentencespace"></span> If you’re on a different platform, or if you’re using a different editor, you should replace this command as necessary (i.e., by double-clicking the application icon or by using an alternate command such as <code>mate</code>, <code>vim</code>, <code>gvim</code>, or <code>mvim</code>).<span class="intersentencespace"></span> For brevity, throughout the rest of this tutorial I’ll use <code>subl</code> as a shorthand for “open with your favorite text editor.”</p>
<div class="codelisting" id="_code-gemrc" data-tralics-id="uid53" data-number="1.2"><div class="heading"><span class="number">Listing 1.2:</span> 

<span class="description">Suppressing the ri and rdoc documentation in <code>.gemrc</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="ss">install</span><span class="p">:</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">rdoc</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">ri</span>
<span class="ss">update</span><span class="p">:</span>  <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">rdoc</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">ri</span>
</pre></div></div></div></div>
<div id="_sec-install_rails" data-tralics-id="uid54" class="subsubsection" data-number="1.2.2.5"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_rails" class="heading">Install Rails</a></h4>
<p>Once you’ve installed RubyGems, installing Rails should be easy.<span class="intersentencespace"></span> This tutorial standardizes on Rails&nbsp;4.0, which we can install as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem install rails --version 4.0.8
</pre></div></div>
<p>To check your Rails installation, run the following command to print out the version number:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails -v
<span class="go">Rails 4.0.8</span>
</pre></div></div>
<p><strong>Important note:</strong> Be sure <em>not</em> to install Rails&nbsp;4.1, which is not compatible with this tutorial.<span class="intersentencespace"></span> (The upcoming 3rd edition will use Rails&nbsp;4.1 or later.)</p>
<p><em>Note:</em> If you installed Rails using the Rails Installer in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_installer_windows" class="hyperref">Section&nbsp;<span class="ref">1.2.2.1</span></a>, there might be slight version differences.<span class="intersentencespace"></span> As of this writing, those differences are not relevant, but in the future, as the current Rails version diverges from the one used in this tutorial, these differences may become significant.</p>
<p>If you’re running Linux, you might have to install a couple of other packages at this point:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> sudo apt-get install libxslt-dev libxml2-dev libsqlite3-dev <span class="c"># Linux only</span>
</pre></div></div>
<p>or</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> sudo yum install libxslt-devel libxml2-devel libsqlite3-devel
</pre></div></div>
</div></div>
<div id="_sec-the_first_application" data-tralics-id="uid55" class="subsection" data-number="1.2.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_application" class="heading hyperref"><span class="number">1.2.3 </span>The first application</a></h3>
<p>Virtually all Rails applications start the same way, by running the <code>rails new</code> command.<span class="intersentencespace"></span> This handy command creates a skeleton Rails application in a directory of your choice.<span class="intersentencespace"></span> To get started, make a directory for your Rails projects and then run <code>rails new</code> to make the first application (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rails_command" class="hyperref">Listing&nbsp;<span class="ref">1.3</span></a>):</p>
<div class="codelisting" id="_code-rails_command" data-tralics-id="uid56" data-number="1.3"><div class="heading"><span class="number">Listing 1.3:</span> 

<span class="description">Running <code>rails new</code> to generate a new application.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mkdir rails_projects
<span class="gp">$</span> <span class="nb">cd </span>rails_projects
<span class="gp">$</span> rails new first_app
<span class="go">      create</span>
<span class="go">      create  README.rdoc</span>
<span class="go">      create  Rakefile</span>
<span class="go">      create  config.ru</span>
<span class="go">      create  .gitignore</span>
<span class="go">      create  Gemfile</span>
<span class="go">      create  app</span>
<span class="go">      create  app/assets/javascripts/application.js</span>
<span class="go">      create  app/assets/stylesheets/application.css</span>
<span class="go">      create  app/controllers/application_controller.rb</span>
<span class="go">      .</span>
<span class="go">      .</span>
<span class="go">      .</span>
<span class="go">      create  test/test_helper.rb</span>
<span class="go">      create  tmp/cache</span>
<span class="go">      create  tmp/cache/assets</span>
<span class="go">      create  vendor/assets/javascripts</span>
<span class="go">      create  vendor/assets/javascripts/.keep</span>
<span class="go">      create  vendor/assets/stylesheets</span>
<span class="go">      create  vendor/assets/stylesheets/.keep</span>
<span class="go">         run  bundle install</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">Your bundle is complete! Use `bundle show [gemname]` to see where a bundled</span>
<span class="go">gem is installed.</span>
</pre></div></div></div><p>As seen at the end of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rails_command" class="hyperref">Listing&nbsp;<span class="ref">1.3</span></a>, running <code>rails new</code> automatically runs the <code>bundle install</code> command after the file creation is done.<span class="intersentencespace"></span> If that step doesn’t work right now, don’t worry; follow the steps in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-bundler" class="hyperref">Section&nbsp;<span class="ref">1.2.4</span></a> and you should be able to get it to work.</p>
<p>Notice how many files and directories the <code>rails</code> command creates.<span class="intersentencespace"></span> This standard directory and file structure (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-directory_structure_rails" class="hyperref">Figure&nbsp;<span class="ref">1.2</span></a>) is one of the many advantages of Rails; it immediately gets you from zero to a functional (if minimal) application.<span class="intersentencespace"></span> Moreover, since the structure is common to all Rails apps, you can immediately get your bearings when looking at someone else’s code.<span class="intersentencespace"></span> A summary of the default Rails files appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-rails_directory_structure" class="hyperref">Table&nbsp;<span class="ref">1.1</span></a>; we’ll learn about most of these files and directories throughout the rest of this book.<span class="intersentencespace"></span> In particular, starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_asset_pipeline" class="hyperref">Section&nbsp;<span class="ref">5.2.1</span></a> we’ll discuss the <code>app/assets</code> directory, part of the <em>asset pipeline</em> that makes it easier than ever to organize and deploy assets such as cascading style sheets and JavaScript files.</p>
<div class="center figure" id="_fig-directory_structure_rails" data-tralics-id="uid57" data-number="1.2">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/directory_structure_rails_4_0.png" alt="images/figures/directory_structure_rails_4_0"></div><div class="caption"><span class="header">Figure 1.2: </span><span class="description">The directory structure for a newly created Rails app.
</span></div></div>
<div class="table" id="_table-rails_directory_structure" data-tralics-id="uid58" data-number="1.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>File/Directory</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><code>app/</code></td>
<td class="align_left">Core application (app) code, including models, views, controllers, and helpers</td>
</tr><tr><td class="align_left"><code>app/assets</code></td>
<td class="align_left">Applications assets such as cascading style sheets (CSS), JavaScript files, and images</td>
</tr><tr><td class="align_left"><code>bin/</code></td>
<td class="align_left">Binary executable files</td>
</tr><tr><td class="align_left"><code>config/</code></td>
<td class="align_left">Application configuration</td>
</tr><tr><td class="align_left"><code>db/</code></td>
<td class="align_left">Database files</td>
</tr><tr><td class="align_left"><code>doc/</code></td>
<td class="align_left">Documentation for the application</td>
</tr><tr><td class="align_left"><code>lib/</code></td>
<td class="align_left">Library modules</td>
</tr><tr><td class="align_left"><code>lib/assets</code></td>
<td class="align_left">Library assets such as cascading style sheets (CSS), JavaScript files, and images</td>
</tr><tr><td class="align_left"><code>log/</code></td>
<td class="align_left">Application log files</td>
</tr><tr><td class="align_left"><code>public/</code></td>
<td class="align_left">Data accessible to the public (e.g., web browsers), such as error pages</td>
</tr><tr><td class="align_left"><code>bin/rails</code></td>
<td class="align_left">A program for generating code, opening console sessions, or starting a local server</td>
</tr><tr><td class="align_left"><code>test/</code></td>
<td class="align_left">Application tests (made obsolete by the <code>spec/</code> directory in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a>)</td>
</tr><tr><td class="align_left"><code>tmp/</code></td>
<td class="align_left">Temporary files</td>
</tr><tr><td class="align_left"><code>vendor/</code></td>
<td class="align_left">Third-party code such as plugins and gems</td>
</tr><tr><td class="align_left"><code>vendor/assets</code></td>
<td class="align_left">Third-party assets such as cascading style sheets (CSS), JavaScript files, and images</td>
</tr><tr><td class="align_left"><code>README.rdoc</code></td>
<td class="align_left">A brief description of the application</td>
</tr><tr><td class="align_left"><code>Rakefile</code></td>
<td class="align_left">Utility tasks available via the <code>rake</code> command</td>
</tr><tr><td class="align_left"><code>Gemfile</code></td>
<td class="align_left">Gem requirements for this app</td>
</tr><tr><td class="align_left"><code>Gemfile.lock</code></td>
<td class="align_left">A list of gems used to ensure that all copies of the app use the same gem versions</td>
</tr><tr><td class="align_left"><code>config.ru</code></td>
<td class="align_left">A configuration file for <a href="http://rack.github.io/" target="_blank">Rack middleware</a></td>
</tr><tr><td class="align_left"><code>.gitignore</code></td>
<td class="align_left">Patterns for files that should be ignored by Git</td>
</tr></tbody></table><div class="caption"><span class="header">Table 1.1: </span><span class="description">A summary of the default Rails directory structure.
</span></div></div>
</div>
<div id="_sec-bundler" data-tralics-id="uid59" class="subsection" data-number="1.2.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-bundler" class="heading hyperref"><span class="number">1.2.4 </span>Bundler</a></h3>
<p>After creating a new Rails application, the next step is to use <em>Bundler</em> to install and include the gems needed by the app.<span class="intersentencespace"></span> As noted briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_application" class="hyperref">Section&nbsp;<span class="ref">1.2.3</span></a>, Bundler is run automatically (via <code>bundle install</code>) by the <code>rails</code> command, but in this section we’ll make some changes to the default application gems and run Bundler again.<span class="intersentencespace"></span> This involves opening the <code>Gemfile</code> with your favorite text editor:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd </span>first_app/
<span class="gp">$</span> subl Gemfile
</pre></div></div>
<p>The result should look something like <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-default_gemfile" class="hyperref">Listing&nbsp;<span class="ref">1.4</span></a>.<span class="intersentencespace"></span> The code in this file is Ruby, but don’t worry at this point about the syntax; <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-rails_flavored_ruby" class="hyperref">Chapter&nbsp;<span class="ref">4</span></a> will cover Ruby in more depth.</p>
<div class="codelisting" id="_code-default_gemfile" data-tralics-id="uid60" data-number="1.4"><div class="heading"><span class="number">Listing 1.4:</span> 

<span class="description">The default <code>Gemfile</code> in the <code>first_app</code> directory.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="c1"># Use sqlite3 as the database for Active Record</span>
<span class="n">gem</span> <span class="s1">'sqlite3'</span>

<span class="c1"># Use SCSS for stylesheets</span>
<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.0.1'</span>

<span class="c1"># Use Uglifier as compressor for JavaScript assets</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'&gt;= 1.3.0'</span>

<span class="c1"># Use CoffeeScript for .js.coffee assets and views</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.0.0'</span>

<span class="c1"># See https://github.com/sstephenson/execjs#readme for more supported runtimes</span>
<span class="c1"># gem 'therubyracer', platforms: :ruby</span>

<span class="c1"># Use jquery as the JavaScript library</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span>

<span class="c1"># Turbolinks makes following links in your web application faster.</span>
<span class="c1"># Read more: https://github.com/rails/turbolinks</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span>

<span class="c1"># Build JSON APIs with ease. Read more: https://github.com/rails/jbuilder</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0.1'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="c1"># bundle exec rake doc:rails generates the API under doc/api.</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="c1"># Use ActiveModel has_secure_password</span>
<span class="c1"># gem 'bcrypt-ruby', '~&gt; 3.1.2'</span>

<span class="c1"># Use unicorn as the app server</span>
<span class="c1"># gem 'unicorn'</span>

<span class="c1"># Use Capistrano for deployment</span>
<span class="c1"># gem 'capistrano', group: :development</span>

<span class="c1"># Use debugger</span>
<span class="c1"># gem 'debugger', group: [:development, :test]</span>
</pre></div></div></div><p>Many of these lines are commented out with the hash symbol&nbsp;<code>#</code>; they are there to show you some commonly needed gems and to give examples of the Bundler syntax.<span class="intersentencespace"></span> For now, we won’t need any gems other than the defaults.</p>
<p>Unless you specify a version number to the <code>gem</code> command, Bundler will automatically install the latest version of the gem.<span class="intersentencespace"></span> Unfortunately, gem updates often cause minor but potentially confusing breakage, so in this tutorial we’ll include explicit version numbers known to work, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_sqlite_version" class="hyperref">Listing&nbsp;<span class="ref">1.5</span></a> (which also omits the commented-out lines from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-default_gemfile" class="hyperref">Listing&nbsp;<span class="ref">1.4</span></a>).</p>
<div class="codelisting" id="_code-gemfile_sqlite_version" data-tralics-id="uid61" data-number="1.5"><div class="heading"><span class="number">Listing 1.5:</span> 

<span class="description">A <code>Gemfile</code> with an explicit version for each Ruby gem.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_sqlite_version" class="hyperref">Listing&nbsp;<span class="ref">1.5</span></a> adds the lines</p>
<div class="code"><div class="highlight"><pre><span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>
</pre></div></div>
<p>identifying the version of Ruby expected by the application (especially useful when deploying applications (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying" class="hyperref">Section&nbsp;<span class="ref">1.4</span></a>)), along with the RVM gemset (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_ruby" class="hyperref">Section&nbsp;<span class="ref">1.2.2.3</span></a>).<span class="intersentencespace"></span> Because the gemset line starts with&nbsp;<code>#</code>, which is the Ruby comment character, it will be ignored if you aren’t using RVM, but if you are RVM will conveniently use the right Ruby version/gemset combination upon entering the application directory.<span class="intersentencespace"></span> (If you are using a version of Ruby other than 2.0.0, you should change the Ruby version line accordingly.)</p>
<p>The updated <code>Gemfile</code> also changes the line for jQuery, the default JavaScript library used by Rails, from</p>
<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'jquery-rails'</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
</pre></div></div>
<p>We’ve also changed</p>
<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'sqlite3'</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
<span class="k">end</span>
</pre></div></div>
<p>which forces Bundler to install version <code>1.3.8</code> of the <code>sqlite3</code> gem.<span class="intersentencespace"></span> Note that we’ve also taken this opportunity to arrange for the gem to be included only in a development environment (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_environments" class="hyperref">Section&nbsp;<span class="ref">7.1.1</span></a>), which prevents potential conflicts with the database used by Heroku (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying" class="hyperref">Section&nbsp;<span class="ref">1.4</span></a>).</p>
<p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_sqlite_version" class="hyperref">Listing&nbsp;<span class="ref">1.5</span></a> also changes a few other lines, converting</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Use SCSS for stylesheets</span>
<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.0.1'</span>

<span class="c1"># Use Uglifier as compressor for JavaScript assets</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'&gt;= 1.3.0'</span>

<span class="c1"># Use CoffeeScript for .js.coffee assets and views</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.0.0'</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
</pre></div></div>
<p>The syntax</p>
<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'&gt;= 1.3.0'</span>
</pre></div></div>
<p>installs the latest version of the <code>uglifier</code> gem (which handles file compression for the asset pipeline) as long as it’s greater than or equal to version <code>1.3.0</code>—even if it’s, say, version&nbsp;<code>7.2</code>.<span class="intersentencespace"></span> Meanwhile, the code</p>
<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.0.0'</span>
</pre></div></div>
<p>installs the gem <code>coffee-rails</code> (also needed by the asset pipeline) as long as it’s newer than version&nbsp;<code>4.0.0</code> but not newer than <code>4.1</code>.<span class="intersentencespace"></span> In other words, the <span class="inline_verbatim">&gt;=</span> notation always installs the latest gem when you run <code>bundle install</code>, whereas the <span class="inline_verbatim">~&gt; 4.0.0</span> notation only installs updated gems representing minor point releases (e.g., from <code>4.0.0</code> to <code>4.0.1</code>), but not major point releases (e.g., from <code>4.0</code> to <code>4.1</code>).<span class="intersentencespace"></span> Unfortunately, experience shows that even minor point releases can break things, so for the <em>Rails Tutorial</em> we’ll err on the side of caution by including exact version numbers for virtually all gems.<span class="intersentencespace"></span> You are welcome to use the most up-to-date version of any gem, including using the <span class="inline_verbatim">~&gt;</span> construction in the <code>Gemfile</code> (which I generally recommend for more advanced users), but be warned that this may cause the tutorial to act unpredictably.</p>
<p>Once you’ve assembled the proper <code>Gemfile</code>, install the gems using <code>bundle install</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>The <code>bundle install</code> command might take a few moments, but when it’s done our application will be ready to run.<span class="intersentencespace"></span> (If you’ve changed the version of the Rails gem, which would likely happen only if you’re using Rails Installer, you should run <code>bundle update rails</code> at the command line as well.)</p>
</div>
<div id="_sec-rails_server" data-tralics-id="uid62" class="subsection" data-number="1.2.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_server" class="heading hyperref"><span class="number">1.2.5 </span><span class="tt">rails server</span></a></h3>
<p>Thanks to running <code>rails new</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_application" class="hyperref">Section&nbsp;<span class="ref">1.2.3</span></a> and <code>bundle install</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-bundler" class="hyperref">Section&nbsp;<span class="ref">1.2.4</span></a>, we already have an application we can run—but how?<span class="intersentencespace"></span> Happily, Rails comes with a command-line program, or <em>script</em>, that runs a <em>local</em> web server, visible only from your development machine:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server
<span class="go">=&gt; Booting WEBrick</span>
<span class="go">=&gt; Rails application starting on http://0.0.0.0:3000</span>
<span class="go">=&gt; Call with -d to detach</span>
<span class="go">=&gt; Ctrl-C to shutdown server</span>
</pre></div></div>
<p>(If your system complains about the lack of a JavaScript runtime, visit the <a href="https://github.com/sstephenson/execjs" target="_blank">execjs page at GitHub</a> for a list of possibilities.<span class="intersentencespace"></span> I particularly recommend installing <a href="http://nodejs.org/" target="_blank">Node.js</a>.)<span class="intersentencespace"></span> This tells us that the application is running on <a href="http://en.wikipedia.org/wiki/TCP_and_UDP_port" target="_blank">port number</a> 3000<sup id="_cha-1_footnote-ref-14" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-14">14</a></sup> at the address <code>0.0.0.0</code>.<span class="intersentencespace"></span> This address tells the computer to listen on every available IP address configured on that specific machine; in particular, we can view the application using the special address <code>127.0.0.1</code>, which is also known as <code>localhost</code>.<span class="intersentencespace"></span> We can see the result of visiting <a href="http://localhost:3000/" target="_blank">http://localhost:3000/</a> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-riding_rails" class="hyperref">Figure&nbsp;<span class="ref">1.3</span></a>.</p>
<div class="center figure" id="_fig-riding_rails" data-tralics-id="uid64" data-number="1.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/riding_rails_4_0.png" alt="images/figures/riding_rails_4_0"></div><div class="caption"><span class="header">Figure 1.3: </span><span class="description">The default Rails page.
</span></div></div>
<p>To see information about our first application, click on the link “About your application’s environment”.<span class="intersentencespace"></span> The result is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-riding_rails_environment" class="hyperref">Figure&nbsp;<span class="ref">1.4</span></a>.<span class="intersentencespace"></span> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-riding_rails_environment" class="hyperref">Figure&nbsp;<span class="ref">1.4</span></a> represents the environment on my machine when I made the screenshot; your results may differ.)</p>
<div class="center figure" id="_fig-riding_rails_environment" data-tralics-id="uid65" data-number="1.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/riding_rails_environment_4_0.png" alt="images/figures/riding_rails_environment_4_0"></div><div class="caption"><span class="header">Figure 1.4: </span><span class="description">The default page with the app environment.
</span></div></div>
<p>Of course, we don’t need the default Rails page in the long run, but it’s nice to see it working for now.<span class="intersentencespace"></span> We’ll remove the default page (and replace it with a custom home page) in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_routes" class="hyperref">Section&nbsp;<span class="ref">5.3.2</span></a>.</p>
</div>
<div id="_sec-mvc" data-tralics-id="uid66" class="subsection" data-number="1.2.6"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc" class="heading hyperref"><span class="number">1.2.6 </span>Model-view-controller (MVC)</a></h3>
<p>Even at this early stage, it’s helpful to get a high-level overview of how Rails applications work (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-MVC" class="hyperref">Figure&nbsp;<span class="ref">1.5</span></a>).<span class="intersentencespace"></span> You might have noticed that the standard Rails application structure (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-directory_structure_rails" class="hyperref">Figure&nbsp;<span class="ref">1.2</span></a>) has an application directory called <code>app/</code> with three subdirectories: <code>models</code>, <code>views</code>, and <code>controllers</code>.<span class="intersentencespace"></span> This is a hint that Rails follows the <a href="http://en.wikipedia.org/wiki/Model-view-controller" target="_blank">model-view-controller</a> (MVC) architectural pattern, which enforces a separation between “domain logic” (also called “business logic”) from the input and presentation logic associated with a graphical user interface (GUI).<span class="intersentencespace"></span> In the case of web applications, the “domain logic” typically consists of data models for things like users, articles, and products, and the GUI is just a web page in a web browser.</p>
<p>When interacting with a Rails application, a browser sends a <em>request</em>, which is received by a web server and passed on to a Rails <em>controller</em>, which is in charge of what to do next.<span class="intersentencespace"></span> In some cases, the controller will immediately render a <em>view</em>, which is a template that gets converted to HTML and sent back to the browser.<span class="intersentencespace"></span> More commonly for dynamic sites, the controller interacts with a <em>model</em>, which is a Ruby object that represents an element of the site (such as a user) and is in charge of communicating with the database.<span class="intersentencespace"></span> After invoking the model, the controller then renders the view and returns the complete web page to the browser as HTML.</p>
<div class="center figure" id="_fig-MVC" data-tralics-id="uid67" data-number="1.5"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/mvc_schematic.png" alt="mvc_schematic"></span>
<div class="caption"><span class="header">Figure 1.5: </span><span class="description">A schematic representation of the model-view-controller (MVC) architecture.
</span></div></div>
<p>If this discussion seems a bit abstract right now, worry not; we’ll refer back to this section frequently.<span class="intersentencespace"></span> In addition, <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc_in_action" class="hyperref">Section&nbsp;<span class="ref">2.2.2</span></a> has a more detailed discussion of MVC in the context of the demo app.<span class="intersentencespace"></span> Finally, the sample app will use all aspects of MVC; we’ll cover controllers and views starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a>, models starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_model" class="hyperref">Section&nbsp;<span class="ref">6.1</span></a>, and we’ll see all three working together in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="hyperref">Section&nbsp;<span class="ref">7.1.2</span></a>.</p>
</div></div>
<div id="_sec-version_control" data-tralics-id="cid4" class="section" data-number="1.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-version_control" class="heading hyperref"><span class="number">1.3 </span>Version control with Git</a></h2>
<p>Now that we have a fresh and working Rails application, we’ll take a moment for a step that, while technically optional, would be viewed by many Rails developers as practically essential, namely, placing our application source code under <em>version control</em>.<span class="intersentencespace"></span> Version control systems allow us to track changes to our project’s code, collaborate more easily, and roll back any inadvertent errors (such as accidentally deleting files).<span class="intersentencespace"></span> Knowing how to use a version control system is a required skill for every software developer.</p>
<p>There are many options for version control, but the Rails community has largely standardized on <a href="http://git-scm.com/" target="_blank">Git</a>, a distributed version control system originally developed by Linus Torvalds to host the Linux kernel.<span class="intersentencespace"></span> Git is a large subject, and we’ll only be scratching the surface in this book, but there are many good free resources online; I especially recommend <a href="http://git-scm.com/book" target="_blank"><em>Pro Git</em></a> by Scott Chacon (Apress, 2009).<span class="intersentencespace"></span> Putting your source code under version control with Git is <em>strongly</em> recommended, not only because it’s nearly a universal practice in the Rails world, but also because it will allow you to share your code more easily (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-github" class="hyperref">Section&nbsp;<span class="ref">1.3.4</span></a>) and deploy your application right here in the first chapter (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying" class="hyperref">Section&nbsp;<span class="ref">1.4</span></a>).</p>
<div id="_sec-git_setup" data-tralics-id="uid68" class="subsection" data-number="1.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_setup" class="heading hyperref"><span class="number">1.3.1 </span>Installation and setup</a></h3>
<p>The first step is to install Git if you haven’t yet followed the steps in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_git" class="hyperref">Section&nbsp;<span class="ref">1.2.2.2</span></a>.<span class="intersentencespace"></span> (As noted in that section, this involves following the instructions in the <a href="http://git-scm.com/book/en/getting-started-installing-git" target="_blank">Installing Git section of <em>Pro Git</em></a>.)</p>
<div id="_uid69" data-tralics-id="uid69" class="subsubsection" data-number="1.3.1.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid69" class="heading">First-time system setup</a></h4>
<p>After installing Git, you should perform a set of one-time setup steps.<span class="intersentencespace"></span> These are <em>system</em> setups, meaning you only have to do them once per computer:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global user.name <span class="s2">"Your Name"</span>
<span class="gp">$</span> git config --global user.email your.email@example.com
</pre></div></div>
<p>I also like to use <code>co</code> in place of the more verbose <code>checkout</code> command, which we can arrange as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global alias.co checkout
</pre></div></div>
<p>This tutorial will usually use the full <code>checkout</code> command, which works for systems that don’t have <code>co</code> configured, but in real life I nearly always use <code>git co</code>.</p>
<p>As a final setup step, you can optionally set the editor Git will use for commit messages.<span class="intersentencespace"></span> If you use a graphical editor such as Sublime Text, TextMate, gVim, or MacVim, you need to use a flag to make sure that the editor stays attached to the shell instead of detaching immediately:<sup id="_cha-1_footnote-ref-15" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-15">15</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global core.editor <span class="s2">"subl -w"</span>
</pre></div></div>
<p>Replace <code>"subl -w"</code> with <code>"mate -w"</code> for TextMate, <code>"gvim -f"</code> for gVim, or <code>"mvim -f"</code> for MacVim.</p>
</div>
<div id="_uid71" data-tralics-id="uid71" class="subsubsection" data-number="1.3.1.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid71" class="heading">First-time repository setup</a></h4>
<p>Now we come to some steps that are necessary each time you create a new <em>repository</em>.<span class="intersentencespace"></span> First navigate to the root directory of the first app and initialize a new repository:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="go">Initialized empty Git repository in /Users/mhartl/rails_projects/first_app/.git/</span>
</pre></div></div>
<p>The next step is to add the project files to the repository.<span class="intersentencespace"></span> There’s a minor complication, though: by default Git tracks the changes of <em>all</em> the files, but there are some files we don’t want to track.<span class="intersentencespace"></span> For example, Rails creates log files to record the behavior of the application; these files change frequently, and we don’t want our version control system to have to update them constantly.<span class="intersentencespace"></span> Git has a simple mechanism to ignore such files: simply include a file called <code>.gitignore</code> in the application root directory with some rules telling Git which files to ignore.<sup id="_cha-1_footnote-ref-16" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-16">16</a></sup></p>
<p>Looking again at <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-rails_directory_structure" class="hyperref">Table&nbsp;<span class="ref">1.1</span></a>, we see that the <code>rails</code> command creates a default <code>.gitignore</code> file in the application root directory, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-default_gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.6</span></a>.</p>
<div class="codelisting" id="_code-default_gitignore" data-tralics-id="uid73" data-number="1.6"><div class="heading"><span class="number">Listing 1.6:</span> 

<span class="description">The default <code>.gitignore</code> created by the <code>rails</code> command.</span>
</div>

<div class="code"><div class="highlight"><pre># See http://help.github.com/ignore-files/ for more about ignoring files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'

# Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-default_gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.6</span></a> causes Git to ignore files such as log files, Rails temporary (<code>tmp</code>) files, and SQLite databases.<span class="intersentencespace"></span> (For example, to ignore log files, which live in the <code>log/</code> directory, we use <code>log/*.log</code> to ignore all files that end in <code>.log</code>.)<span class="intersentencespace"></span> Most of these ignored files change frequently and automatically, so including them under version control is unnecessary.<span class="intersentencespace"></span> Moreover, when collaborating with others, these irrelevant changes can cause frustrating conflicts.</p>
<p>The <code>.gitignore</code> file in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-default_gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.6</span></a> is a good start, but for convenience and security (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-secret_token" class="hyperref">Listing&nbsp;<span class="ref">3.2</span></a>) I recommend using <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.7</span></a> instead.<span class="intersentencespace"></span> This augmented <code>.gitignore</code> arranges to ignore Rails documentation files, Vim and Emacs swap files, and (for OS&nbsp;X users) the weird <code>.DS_Store</code> directories created by the Mac Finder application.<span class="intersentencespace"></span> If you want to use this broader set of ignored files, open up <code>.gitignore</code> in your favorite text editor and fill it with the contents of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.7</span></a>.</p>
<div class="codelisting" id="_code-gitignore" data-tralics-id="uid74" data-number="1.7"><div class="heading"><span class="number">Listing 1.7:</span> 

<span class="description">An augmented <code>.gitignore</code> file.</span>
</div>

<div class="code"><div class="highlight"><pre># Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# Ignore other unneeded files.
database.yml
doc/
*.swp
*~
.project
.DS_Store
.idea
.secret
</pre></div></div></div></div></div>
<div id="_sec-adding_and_committing" data-tralics-id="uid75" class="subsection" data-number="1.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_and_committing" class="heading hyperref"><span class="number">1.3.2 </span>Adding and committing</a></h3>
<p>Finally, we’ll add the files in your new Rails project to Git and then commit the results.<span class="intersentencespace"></span> You can add all the files (apart from those that match the ignore patterns in <code>.gitignore</code>) as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
</pre></div></div>
<p>Here the dot ‘<code>.</code>’ represents the current directory, and Git is smart enough to add the files <em>recursively</em>, so it automatically includes all the subdirectories.<span class="intersentencespace"></span> This command adds the project files to a <em>staging area</em>, which contains pending changes to your project; you can see which files are in the staging area using the <code>status</code> command:<sup id="_cha-1_footnote-ref-17" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-17">17</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="gp">#</span>
<span class="gp">#</span> Initial commit
<span class="gp">#</span>
<span class="gp">#</span> Changes to be committed:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">"git rm --cached &lt;file&gt;..."</span> to unstage<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       new file:   README.rdoc
<span class="gp">#</span>       new file:   Rakefile
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
</pre></div></div>
<p>(The results are long, so I’ve used vertical dots to indicate omitted output.)</p>
<p>To tell Git you want to keep the changes, use the <code>commit</code> command:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -m <span class="s2">"Initialize repository"</span>
<span class="go">[master (root-commit) df0a62f] Initialize repository</span>
<span class="go">42 files changed, 8461 insertions(+), 0 deletions(-)</span>
<span class="go">create mode 100644 README.rdoc</span>
<span class="go">create mode 100644 Rakefile</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
</pre></div></div>
<p>The <code>-m</code> flag lets you add a message for the commit; if you omit <code>-m</code>, Git will open the editor you set in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_setup" class="hyperref">Section&nbsp;<span class="ref">1.3.1</span></a> and have you enter the message there.</p>
<p>It is important to note that Git commits are <em>local</em>, recorded only on the machine on which the commits occur.<span class="intersentencespace"></span> This is in contrast to the popular open-source version control system called Subversion, in which a commit necessarily makes changes on a remote repository.<span class="intersentencespace"></span> Git divides a Subversion-style commit into its two logical pieces: a local recording of the changes (<code>git commit</code>) and a push of the changes up to a remote repository (<code>git push</code>).<span class="intersentencespace"></span> We’ll see an example of the push step in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_commands" class="hyperref">Section&nbsp;<span class="ref">1.3.5</span></a>.</p>
<p>By the way, you can see a list of your commit messages using the <code>log</code> command:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git log
<span class="go">commit df0a62f3f091e53ffa799309b3e32c27b0b38eb4</span>
<span class="go">Author: Michael Hartl &lt;michael@michaelhartl.com&gt;</span>
<span class="go">Date:   Thu Oct 15 11:36:21 2009 -0700</span>

<span class="go">  Initialize repository</span>
</pre></div></div>
<p>To exit <code>git log</code>, you may have to type <code>q</code> to quit.</p>
</div>
<div id="_uid77" data-tralics-id="uid77" class="subsection" data-number="1.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid77" class="heading hyperref"><span class="number">1.3.3 </span>What good does Git do you?</a></h3>
<p>It’s probably not entirely clear at this point why putting your source under version control does you any good, so let me give just one example.<span class="intersentencespace"></span> (We’ll see many others in the chapters ahead.)<span class="intersentencespace"></span> Suppose you’ve made some accidental changes, such as (D’oh!)<span class="intersentencespace"></span> deleting the critical <code>app/controllers/</code> directory:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> ls app/controllers/
<span class="go">application_controller.rb</span>
<span class="gp">$</span> rm -rf app/controllers/
<span class="gp">$</span> ls app/controllers/
<span class="go">ls: app/controllers/: No such file or directory</span>
</pre></div></div>
<p>Here we’re using the Unix <code>ls</code> command to list the contents of the <code>app/controllers/</code> directory and the <code>rm</code> command to remove it.<span class="intersentencespace"></span> The <code>-rf</code> flag means “recursive force”, which recursively removes all files, directories, subdirectories, and so on, without asking for explicit confirmation of each deletion.</p>
<p>Let’s check the status to see what’s up:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="gp">#</span> Changed but not updated:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">"git add/rm &lt;file&gt;..."</span> to update what will be committed<span class="o">)</span>
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">"git checkout -- &lt;file&gt;..."</span> to discard changes in working directory<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       deleted:    app/controllers/application_controller.rb
<span class="gp">#</span>
<span class="go">no changes added to commit (use "git add" and/or "git commit -a")</span>
</pre></div></div>
<p>We see here that a file has been deleted, but the changes are only on the “working tree”; they haven’t been committed yet.<span class="intersentencespace"></span> This means we can still undo the changes easily by having Git check out the previous commit with the <code>checkout</code> command (and a <code>-f</code> flag to force overwriting the current changes):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -f
<span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="go">nothing to commit (working directory clean)</span>
<span class="gp">$</span> ls app/controllers/
<span class="go">application_controller.rb</span>
</pre></div></div>
<p>The missing directory and file are back.<span class="intersentencespace"></span> That’s a relief!</p>
</div>
<div id="_sec-github" data-tralics-id="uid78" class="subsection" data-number="1.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-github" class="heading hyperref"><span class="number">1.3.4 </span>GitHub</a></h3>
<p>Now that you’ve put your project under version control with Git, it’s time to push your code up to <a href="http://github.com/" target="_blank">GitHub</a>, a social coding site optimized for hosting and sharing Git repositories.<span class="intersentencespace"></span> Putting a copy of your Git repository at GitHub serves two purposes: it’s a full backup of your code (including the full history of commits), and it makes any future collaboration much easier.<span class="intersentencespace"></span> This step is optional, but being a GitHub member will open the door to participating in a wide variety of open-source projects.</p>
<div class="center figure" id="_fig-create_first_repository" data-tralics-id="uid79" data-number="1.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/create_first_repository_4_0.png" alt="images/figures/create_first_repository_4_0"></div><div class="caption"><span class="header">Figure 1.6: </span><span class="description">Creating the first app repository at GitHub.
</span></div></div>
<p>GitHub has a variety of paid plans, but for open-source code their services are free, so sign up for a <a href="https://github.com/signup/free" target="_blank">free GitHub account</a> if you don’t have one already.<span class="intersentencespace"></span> (You might have to follow the <a href="http://help.github.com/key-setup-redirect" target="_blank">GitHub tutorial on creating SSH keys</a> first.)<span class="intersentencespace"></span> After signing up, click on the link to <a href="http://github.com/new" target="_blank">create a repository</a> and fill in the information as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-create_first_repository" class="hyperref">Figure&nbsp;<span class="ref">1.6</span></a>.<span class="intersentencespace"></span> (Take care <em>not</em> to initialize the repository with a <code>README</code> file, as <code>rails new</code> creates one of those automatically.)<span class="intersentencespace"></span> After submitting the form, push up your first application as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin https://github.com/&lt;username&gt;/first_app.git
<span class="gp">$</span> git push -u origin master
</pre></div></div>
<p>These commands tell Git that you want to add GitHub as the origin for your main (<em>master</em>) branch and then push your repository up to GitHub.<span class="intersentencespace"></span> (Don’t worry about what the <span class="tt">-u</span> flag does; if you’re curious, do a web search for “git set upstream”.)<span class="intersentencespace"></span> Of course, you should replace <span class="inline_verbatim">&lt;username&gt;</span> with your actual username.<span class="intersentencespace"></span> For example, the command I ran was</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin https://github.com/mhartl/first_app.git
</pre></div></div>
<p>The result is a page at GitHub for the first application repository, with file browsing, full commit history, and lots of other goodies (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-github_repository_page" class="hyperref">Figure&nbsp;<span class="ref">1.7</span></a>).</p>
<div class="center figure" id="_fig-github_repository_page" data-tralics-id="uid80" data-number="1.7">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/github_repository_page_4_0.png" alt="images/figures/github_repository_page_4_0"></div><div class="caption"><span class="header">Figure 1.7: </span><span class="description">A GitHub repository page.
</span></div></div>
<p>GitHub also has native applications to augment the command-line interface, so if you’re more comfortable with GUI apps you might want to check out <a href="http://windows.github.com/" target="_blank">GitHub for Windows</a> or <a href="http://mac.github.com/" target="_blank">GitHub for Mac</a>.<span class="intersentencespace"></span> (GitHub for Linux is still just Git, it seems.)</p>
</div>
<div id="_sec-git_commands" data-tralics-id="uid81" class="subsection" data-number="1.3.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_commands" class="heading hyperref"><span class="number">1.3.5 </span>Branch, edit, commit, merge</a></h3>
<p>If you’ve followed the steps in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-github" class="hyperref">Section&nbsp;<span class="ref">1.3.4</span></a>, you might notice that GitHub automatically shows the contents of the <code>README</code> file on the main repository page.<span class="intersentencespace"></span> In our case, since the project is a Rails application generated using the <code>rails</code> command, the <code>README</code> file is the one that comes with Rails (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-rails_readme" class="hyperref">Figure&nbsp;<span class="ref">1.8</span></a>).<span class="intersentencespace"></span> Because of the <code>.rdoc</code> extension on the file, GitHub ensures that it is formatted nicely, but the contents aren’t helpful at all, so in this section we’ll make our first edit by changing the <code>README</code> to describe our project rather than the Rails framework itself.<span class="intersentencespace"></span> In the process, we’ll see a first example of the branch, edit, commit, merge workflow that I recommend using with Git.</p>
<div class="center figure" id="_fig-rails_readme" data-tralics-id="uid82" data-number="1.8">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/rails_readme_4_0.png" alt="images/figures/rails_readme_4_0"></div><div class="caption"><span class="header">Figure 1.8: </span><span class="description">The initial <code>README</code> file for our project at GitHub.
</span></div></div>
<div id="_sec-git_branch" data-tralics-id="uid83" class="subsubsection" data-number="1.3.5.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_branch" class="heading">Branch</a></h4>
<p>Git is incredibly good at making <em>branches</em>, which are effectively copies of a repository where we can make (possibly experimental) changes without modifying the parent files.<span class="intersentencespace"></span> In most cases, the parent repository is the <em>master</em> branch, and we can create a new topic branch by using <code>checkout</code> with the <code>-b</code> flag:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b modify-README
<span class="go">Switched to a new branch 'modify-README'</span>
<span class="gp">$</span> git branch
<span class="go">master</span>
<span class="go">* modify-README</span>
</pre></div></div>
<p>Here the second command, <code>git branch</code>, just lists all the local branches, and the asterisk&nbsp;<code>*</code> identifies which branch we’re currently on.<span class="intersentencespace"></span> Note that <code>git checkout -b modify-README</code> both creates a new branch and switches to it, as indicated by the asterisk in front of the <code>modify-README</code> branch.<span class="intersentencespace"></span> (If you set up the <code>co</code> alias in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-version_control" class="hyperref">Section&nbsp;<span class="ref">1.3</span></a>, you can use <code>git co -b modify-README</code> instead.)</p>
<p>The full value of branching only becomes clear when working on a project with multiple developers,<sup id="_cha-1_footnote-ref-18" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-18">18</a></sup> but branches are helpful even for a single-developer tutorial such as this one.<span class="intersentencespace"></span> In particular, the master branch is insulated from any changes we make to the topic branch, so even if we <em>really</em> screw things up we can always abandon the changes by checking out the master branch and deleting the topic branch.<span class="intersentencespace"></span> We’ll see how to do this at the end of the section.</p>
<p>By the way, for a change as small as this one I wouldn’t normally bother with a new branch, but it’s never too early to start practicing good habits.</p>
</div>
<div id="_sec-git_edit" data-tralics-id="uid85" class="subsubsection" data-number="1.3.5.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_edit" class="heading">Edit</a></h4>
<p>After creating the topic branch, we’ll edit it to make it a little more descriptive.<span class="intersentencespace"></span> I prefer the <a href="http://daringfireball.net/projects/markdown/" target="_blank">Markdown markup language</a> to the default RDoc for this purpose, and if you use the file extension <code>.md</code> then GitHub will automatically format it nicely for you.<span class="intersentencespace"></span> So, first we’ll use Git’s version of the Unix <code>mv</code> (“move”) command to change the name, and then fill it in with the contents of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_readme" class="hyperref">Listing&nbsp;<span class="ref">1.8</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git mv README.rdoc README.md
<span class="gp">$</span> subl README.md
</pre></div></div>
<div class="codelisting" id="_code-new_readme" data-tralics-id="uid86" data-number="1.8"><div class="heading"><span class="number">Listing 1.8:</span> 

<span class="description">The new <code>README</code> file, <code>README.md</code>.</span>
</div>

<div class="code"><div class="highlight"><pre># Ruby on Rails Tutorial: first application

This is the first application for the
[*Ruby on Rails Tutorial*](http://railstutorial.org/)
by [Michael Hartl](http://michaelhartl.com/).
</pre></div></div></div></div>
<div id="_sec-git_commit" data-tralics-id="uid87" class="subsubsection" data-number="1.3.5.3"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_commit" class="heading">Commit</a></h4>
<p>With the changes made, we can take a look at the status of our branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch modify-README
<span class="gp">#</span> Changes to be committed:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">"git reset HEAD &lt;file&gt;..."</span> to unstage<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       renamed:    README.rdoc -&gt; README.md
<span class="gp">#</span>
<span class="gp">#</span> Changed but not updated:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">"git add &lt;file&gt;..."</span> to update what will be committed<span class="o">)</span>
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">"git checkout -- &lt;file&gt;..."</span> to discard changes in working directory<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       modified:   README.md
<span class="gp">#</span>
</pre></div></div>
<p>At this point, we could use <code>git add .</code> as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_and_committing" class="hyperref">Section&nbsp;<span class="ref">1.3.2</span></a>, but Git provides the <code>-a</code> flag as a shortcut for the (very common) case of committing all modifications to existing files (or files created using <code>git mv</code>, which don’t count as new files to Git):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -a -m <span class="s2">"Improve the README file"</span>
<span class="go">2 files changed, 5 insertions(+), 243 deletions(-)</span>
<span class="go">delete mode 100644 README.rdoc</span>
<span class="go">create mode 100644 README.md</span>
</pre></div></div>
<p>Be careful about using the <code>-a</code> flag improperly; if you have added any new files to the project since the last commit, you still have to tell Git about them using <code>git add</code> first.</p>
<p>Note that we write the commit message in the <em>present</em> tense.<span class="intersentencespace"></span> Git models commits as a series of patches, and in this context it makes sense to describe what each commit <em>does</em>, rather than what it did.<span class="intersentencespace"></span> Moreover, this usage matches up with the commit messages generated by Git commands themselves.<span class="intersentencespace"></span> See the GitHub post <a href="https://github.com/blog/926-shiny-new-commit-styles" target="_blank">Shiny new commit styles</a> for more information.</p>
</div>
<div id="_sec-git_merge" data-tralics-id="uid88" class="subsubsection" data-number="1.3.5.4"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_merge" class="heading">Merge</a></h4>
<p>Now that we’ve finished making our changes, we’re ready to <em>merge</em> the results back into our master branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="go">Switched to branch 'master'</span>
<span class="gp">$</span> git merge modify-README
<span class="go">Updating 34f06b7..2c92bef</span>
<span class="go">Fast forward</span>
<span class="go">README.rdoc     |  243 --------------------------------------------------</span>
<span class="go">README.md       |    5 +</span>
<span class="go">2 files changed, 5 insertions(+), 243 deletions(-)</span>
<span class="go">delete mode 100644 README.rdoc</span>
<span class="go">create mode 100644 README.md</span>
</pre></div></div>
<p>Note that the Git output frequently includes things like <code>34f06b7</code>, which are related to Git’s internal representation of repositories.<span class="intersentencespace"></span> Your exact results will differ in these details, but otherwise should essentially match the output shown above.</p>
<p>After you’ve merged in the changes, you can tidy up your branches by deleting the topic branch using <code>git branch -d</code> if you’re done with it:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git branch -d modify-README
<span class="go">Deleted branch modify-README (was 2c92bef).</span>
</pre></div></div>
<p>This step is optional, and in fact it’s quite common to leave the topic branch intact.<span class="intersentencespace"></span> This way you can switch back and forth between the topic and master branches, merging in changes every time you reach a natural stopping point.</p>
<p>As mentioned above, it’s also possible to abandon the changes to your topic branch, in this case with <code>git branch -D</code>:</p>
<div class="code"><div class="highlight"><pre><span class="c"># For illustration only; don't do this unless you mess up a branch</span>
<span class="nv">$ </span>git checkout -b topic-branch
<span class="nv">$ </span>&lt;really screw up the branch&gt;
<span class="nv">$ </span>git add .
<span class="nv">$ </span>git commit -a -m <span class="s2">"Major screw up"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git branch -D topic-branch
</pre></div></div>
<p>Unlike the <code>-d</code> flag, the <code>-D</code> flag will delete the branch even though we haven’t merged in the changes.</p>
</div>
<div id="_sec-git_push" data-tralics-id="uid89" class="subsubsection" data-number="1.3.5.5"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_push" class="heading">Push</a></h4>
<p>Now that we’ve updated the <code>README</code>, we can push the changes up to GitHub to see the result.<span class="intersentencespace"></span> Since we have already done one push (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-github" class="hyperref">Section&nbsp;<span class="ref">1.3.4</span></a>), on most systems we can omit <code>origin master</code>, and simply run <code>git push</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div></div>
<p>As promised, GitHub nicely formats the new file using Markdown (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-new_readme" class="hyperref">Figure&nbsp;<span class="ref">1.9</span></a>).</p>
<div class="center figure" id="_fig-new_readme" data-tralics-id="uid90" data-number="1.9">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/new_readme_4_0.png" alt="images/figures/new_readme_4_0"></div><div class="caption"><span class="header">Figure 1.9: </span><span class="description">The improved <code>README</code> file formatted with Markdown.
</span></div></div>
</div></div></div>
<div id="_sec-deploying" data-tralics-id="cid5" class="section" data-number="1.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying" class="heading hyperref"><span class="number">1.4 </span>Deploying</a></h2>
<p>Even at this early stage, we’re already going to deploy our (still-empty) Rails application to production.<span class="intersentencespace"></span> This step is optional, but deploying early and often allows us to catch any deployment problems early in our development cycle.<span class="intersentencespace"></span> The alternative—deploying only after laborious effort sealed away in a development environment—often leads to terrible integration headaches when launch time comes.<sup id="_cha-1_footnote-ref-19" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-19">19</a></sup></p>
<p>Deploying Rails applications used to be a pain, but the Rails deployment ecosystem has matured rapidly in the past few years, and now there are several great options.<span class="intersentencespace"></span> These include shared hosts or virtual private servers running <a href="http://www.modrails.com/" target="_blank">Phusion Passenger</a> (a module for the Apache and Nginx<sup id="_cha-1_footnote-ref-20" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-20">20</a></sup> web servers), full-service deployment companies such as <a href="http://engineyard.com/" target="_blank">Engine Yard</a> and <a href="http://railsmachine.com/" target="_blank">Rails Machine</a>, and cloud deployment services such as <a href="http://cloud.engineyard.com/" target="_blank">Engine Yard Cloud</a> and <a href="http://heroku.com/" target="_blank">Heroku</a>.</p>
<p>My favorite Rails deployment option is Heroku, which is a hosted platform built specifically for deploying Rails and other web applications.<span class="intersentencespace"></span> Heroku makes deploying Rails applications ridiculously easy—as long as your source code is under version control with Git.<span class="intersentencespace"></span> (This is yet another reason to follow the Git setup steps in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-version_control" class="hyperref">Section&nbsp;<span class="ref">1.3</span></a> if you haven’t already.)<span class="intersentencespace"></span> The rest of this section is dedicated to deploying our first application to Heroku.</p>
<div id="_sec-heroku_setup" data-tralics-id="uid93" class="subsection" data-number="1.4.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_setup" class="heading hyperref"><span class="number">1.4.1 </span>Heroku setup</a></h3>
<p>Heroku uses the <a href="http://www.postgresql.org/" target="_blank">PostgreSQL</a> database (pronounced “post-gres-cue-ell”, and often called “Postgres” for short), which means that we need to add the <span class="tt">pg</span>&nbsp;gem in the production environment to allow Rails to talk to Postgres:</p>
<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div>
<p>Note also the addition of the <span class="tt">rails_12factor</span> gem, which is used by Heroku to serve static assets such as images and stylesheets.</p>
<p>As mentioned in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-bundler" class="hyperref">Section&nbsp;<span class="ref">1.2.4</span></a>, it’s also a good idea to specify explictly which version of Ruby our applications expects:</p>
<div class="code"><div class="highlight"><pre><span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>
</pre></div></div>
<p>(Here I’ve also added the optional RVM gemset line for convenience.<span class="intersentencespace"></span> You should substitute <code>’1.9.3’</code> if that’s the version of Ruby you’re using, though for this tutorial the difference shouldn’t ever matter.)<span class="intersentencespace"></span> Applying these changes to the <code>Gemfile</code> from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_sqlite_version" class="hyperref">Listing&nbsp;<span class="ref">1.5</span></a> yields <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_pg_gem" class="hyperref">Listing&nbsp;<span class="ref">1.9</span></a>.</p>
<div class="codelisting" id="_code-gemfile_pg_gem" data-tralics-id="uid94" data-number="1.9"><div class="heading"><span class="number">Listing 1.9:</span> 

<span class="description">A <code>Gemfile</code> with added gems and explicit Ruby version.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div></div><p>To install it, we run <code>bundle install</code> with a special flag:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --without production
</pre></div></div>
<p>The <span class="inline_verbatim">--without production</span> option prevents the local installation of any production gems, which in this case consists of&nbsp;<span class="tt">pg</span> and <span class="tt">rails_12factor</span>.<span class="intersentencespace"></span> (If Bundler complains about a <span class="tt">readline</span> error, try adding the line <span class="inline_verbatim">gem</span> <span class="inline_verbatim">'rb-readline',</span> <span class="inline_verbatim">'~&gt; 0.4.2'</span> to your <code>Gemfile</code>.)<span class="intersentencespace"></span> Because the only gems we’ve added are restricted to a production environment, right now this command doesn’t actually install any additional local gems, but it’s needed to update <code>Gemfile.lock</code> with the <span class="tt">pg</span> and <span class="tt">rails_12factor</span> gems and the specific Ruby version.<span class="intersentencespace"></span> We can commit the resulting change as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -a -m <span class="s2">"Update Gemfile.lock for Heroku"</span>
</pre></div></div>
<p>(Some readers have reported that they need one last bit of configuration at this point, namely, creating the files Heroku needs to serve static assets like images and CSS:</p>
<div class="code"><div class="highlight"><pre><span class="gp">#</span> This should only be used <span class="k">if</span> your Heroku deploy fails without it.
<span class="gp">$</span> rake assets:precompile
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add precompiled assets for Heroku"</span>
</pre></div></div>
<p>(This uses the <code>rake</code> command, which we’ll cover in more detail in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_users_resource" class="hyperref">Section&nbsp;<span class="ref">2.2</span></a>.)<span class="intersentencespace"></span> The asset precompile step shouldn’t be necessary, and I have been unable to reproduce the issue, but the reports are common enough that I include it here for reference.)</p>
<p>Next we have to create and configure a new Heroku account.<span class="intersentencespace"></span> The first step is to <a href="http://api.heroku.com/signup" target="_blank">sign up for Heroku</a>; after checking your email to complete the creation of your account, install the necessary Heroku software using the <a href="https://toolbelt.heroku.com/" target="_blank">Heroku Toolbelt</a>.<sup id="_cha-1_footnote-ref-21" class="footnote intersentence"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-21">21</a></sup><span class="intersentencespace"></span> Then use the <code>heroku</code> command to log in at the command line (you may have to exit and restart your terminal program first):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku login
</pre></div></div>
<p>Finally, navigate back to your Rails project directory and use the <code>heroku</code> command to create a place on the Heroku servers for the sample app to live (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-heroku_create" class="hyperref">Listing&nbsp;<span class="ref">1.10</span></a>).</p>
<div class="codelisting" id="_code-heroku_create" data-tralics-id="uid96" data-number="1.10"><div class="heading"><span class="number">Listing 1.10:</span> 

<span class="description">Creating a new application at Heroku.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects/first_app
<span class="gp">$</span> heroku create
<span class="go">Created http://stormy-cloud-5881.herokuapp.com/ |</span>
<span class="go">git@heroku.com:stormy-cloud-5881.herokuapp.com</span>
<span class="go">Git remote heroku added</span>
</pre></div></div></div><p>The <code>heroku</code> command creates a new subdomain just for our application, available for immediate viewing.<span class="intersentencespace"></span> There’s nothing there yet, though, so let’s get busy deploying.</p>
</div>
<div id="_sec-heroku_step_one" data-tralics-id="uid97" class="subsection" data-number="1.4.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_step_one" class="heading hyperref"><span class="number">1.4.2 </span>Heroku deployment, step one</a></h3>
<p>To deploy the application, the first step is to use Git to push it up to Heroku:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku master
</pre></div></div>
</div>
<div id="_uid98" data-tralics-id="uid98" class="subsection" data-number="1.4.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid98" class="heading hyperref"><span class="number">1.4.3 </span>Heroku deployment, step two</a></h3>
<p>There is no step two!<span class="intersentencespace"></span> We’re already done (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-heroku_app" class="hyperref">Figure&nbsp;<span class="ref">1.10</span></a>).<span class="intersentencespace"></span> To see your newly deployed application, you can visit the address that you saw when you ran <code>heroku create</code> (i.e., <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-heroku_create" class="hyperref">Listing&nbsp;<span class="ref">1.10</span></a>, but with the address for your app, not the address for mine).<span class="intersentencespace"></span> You can also use an argument to the <code>heroku</code> command that automatically opens your browser with the right address:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div></div>
<p>Unfortunately, the resulting page is an error; as of Rails&nbsp;4.0, for technical reasons the default Rails page doesn’t work on Heroku.<span class="intersentencespace"></span> The good news is that the error will go away (in the context of the full sample application) when we add a root route in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_routes" class="hyperref">Section&nbsp;<span class="ref">5.3.2</span></a>.</p>
<div class="center figure" id="_fig-heroku_app" data-tralics-id="uid99" data-number="1.10">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/heroku_app_4_0.png" alt="images/figures/heroku_app_4_0"></div><div class="caption"><span class="header">Figure 1.10: </span><span class="description">The first Rails Tutorial application running on Heroku.
</span></div></div>
<p>Once you’ve deployed successfully, Heroku provides a beautiful interface for administering and configuring your application (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-heroku_info" class="hyperref">Figure&nbsp;<span class="ref">1.11</span></a>).</p>
<div class="center figure" id="_fig-heroku_info" data-tralics-id="uid100" data-number="1.11">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/heroku_info_4_0.png" alt="images/figures/heroku_info_4_0"></div><div class="caption"><span class="header">Figure 1.11: </span><span class="description">The beautiful interface at Heroku.
</span></div></div>
</div>
<div id="_sec-heroku_commands" data-tralics-id="uid101" class="subsection" data-number="1.4.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_commands" class="heading hyperref"><span class="number">1.4.4 </span>Heroku commands</a></h3>
<p>There are many <a href="http://devcenter.heroku.com/heroku-command" target="_blank">Heroku commands</a>, and we’ll barely scratch the surface in this book.<span class="intersentencespace"></span> Let’s take a minute to show just one of them by renaming the application as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku rename railstutorial
</pre></div></div>
<p>Don’t use this name yourself; it’s already taken by me!<span class="intersentencespace"></span> In fact, you probably shouldn’t bother with this step right now; using the default address supplied by Heroku is fine.<span class="intersentencespace"></span> But if you do want to rename your application, you can arrange for it to be reasonably secure by using a random or obscure subdomain, such as the following:</p>
<pre>hwpcbmze.herokuapp.com
seyjhflo.herokuapp.com
jhyicevg.herokuapp.com</pre>
<p>With a random subdomain like this, someone could visit your site only if you gave them the address.<span class="intersentencespace"></span> (By the way, as a preview of Ruby’s compact awesomeness, here’s the code I used to generate the random subdomains:</p>
<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>
</pre></div></div>
<p>Pretty sweet.)</p>
<p>In addition to supporting subdomains, Heroku also supports custom domains.<span class="intersentencespace"></span> (In fact, the <a href="http://railstutorial.org/" target="_blank">Ruby on Rails Tutorial site</a> lives at Heroku; if you’re reading this book online, you’re looking at a Heroku-hosted site right now!)<span class="intersentencespace"></span> See the <a href="http://devcenter.heroku.com/" target="_blank">Heroku documentation</a> for more information about custom domains and other Heroku topics.</p>
</div></div>
<div id="_sec-beginning_conclusion" data-tralics-id="cid6" class="section" data-number="1.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-beginning_conclusion" class="heading hyperref"><span class="number">1.5 </span>Conclusion</a></h2>
<p>We’ve come a long way in this chapter: installation, development environment setup, version control, and deployment.<span class="intersentencespace"></span> If you want to share your progress at this point, feel free to send a tweet or Facebook status update with something like this:</p>
<div class="center"><p><a href="http://twitter.com/?status=I%27m%20learning%20Ruby%20on%20Rails%20with%20@railstutorial!%20http://railstutorial.org/" target="_blank">I’m learning Ruby on Rails with @railstutorial!<span class="intersentencespace"></span> http://railstutorial.org/</a></p>
</div><p>&nbsp;</p>
<p>All that’s left is to actually start learning Rails!<span class="intersentencespace"></span> Let’s get to it.</p>
</div>
<div id="cha-1_footnotes">
  <ol class="footnotes">
    <li id="_cha-1_footnote-1"><em>URI</em> stands for Uniform Resource Identifier, while the slightly less general <em>URL</em> stands for Uniform Resource Locator.<span class="intersentencespace"></span> In practice, the URL is usually equivalent to “the thing you see in the address bar of your browser”.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-1">↑</a></li>
    <li id="_cha-1_footnote-2">http://tryruby.org/&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-2">↑</a></li>
    <li id="_cha-1_footnote-3">http://railsforzombies.org/&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-3">↑</a></li>
    <li id="_cha-1_footnote-4">http://www.railstutorial.org/screencasts&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-4">↑</a></li>
    <li id="_cha-1_footnote-5">When reading the <em>Rails Tutorial</em>, you may find it convenient to follow an internal section link to look at the reference and then immediately go back to where you were before.<span class="intersentencespace"></span> This is easy when reading the book as a web page, since you can just use the Back button of your browser, but both Adobe Reader and OS&nbsp;X’s Preview allow you to do this with the PDF as well.<span class="intersentencespace"></span> In Reader, you can right-click on the document and select “Previous View” to go back.<span class="intersentencespace"></span> In Preview, use the Go menu: <span class="tt">Go &gt; Back</span>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-5">↑</a></li>
    <li id="_cha-1_footnote-6">Many people erroneously believe that <code>sudo</code> stands for “superuser do” because it runs commands as the superuser (root) by default.<span class="intersentencespace"></span> In fact, <code>sudo</code> is a concatenation of the <code>su</code> command and the English word “do”, and <code>su</code> stands for “substitute user”, as you can verify by typing <code>man su</code> in your shell.<span class="intersentencespace"></span> This etymology also suggests the pronunciation “SOO-doo” (because the word “do” is pronounced “doo”), although the alternate pronunciation “SOO-doh” is also common.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-6">↑</a></li>
    <li id="_cha-1_footnote-7">http://railstutorial.org/help&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-7">↑</a></li>
    <li id="_cha-1_footnote-8">https://github.com/perfectionist/sample_project/wiki&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-8">↑</a></li>
    <li id="_cha-1_footnote-9">As of this writing, <a href="http://www.sublimetext.com/3" target="_blank">Sublime Text&nbsp;3</a> is in beta.<span class="intersentencespace"></span> I recommend trying the newest Sublime Text only if you really want to be on the bleeding edge.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-9">↑</a></li>
    <li id="_cha-1_footnote-10">The vi editor is one of the most ancient yet powerful weapons in the Unix arsenal, and Vim is “vi improved”.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-10">↑</a></li>
    <li id="_cha-1_footnote-11">https://github.com/mhartl/rails_tutorial_sublime_text&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-11">↑</a></li>
    <li id="_cha-1_footnote-12">https://developer.apple.com/downloads/&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-12">↑</a></li>
    <li id="_cha-1_footnote-13">http://strandcode.com/2013/07/11/ruby-version-manager-rvm-overview-for-rails-newbs/&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-13">↑</a></li>
    <li id="_cha-1_footnote-14">Normally, websites run on port 80, but this usually requires special privileges, so Rails picks a less restricted higher-numbered port for the development server.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-14">↑</a></li>
    <li id="_cha-1_footnote-15">Normally this is a feature, since it lets you continue to use the command line after launching your editor, but Git interprets the detachment as closing the file with an empty commit message, which prevents the commit from going through.<span class="intersentencespace"></span> I only mention this point because it can be seriously confusing if you try to set your editor to <code>subl</code> or <code>gvim</code> without the flag.<span class="intersentencespace"></span> (If you find this note confusing, it is safe to ignore it.)&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-15">↑</a></li>
    <li id="_cha-1_footnote-16">If you can’t see the <code>.gitignore</code> file in your directory, you may need to configure your directory viewer to show hidden files.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-16">↑</a></li>
    <li id="_cha-1_footnote-17">If in the future any unwanted files start showing up when you type <code>git status</code>, just add them to your <code>.gitignore</code> file from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.7</span></a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-17">↑</a></li>
    <li id="_cha-1_footnote-18">See the chapter <a href="http://git-scm.com/book/en/git-branching" target="_blank">Git Branching in <em>Pro Git</em></a> for details.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-18">↑</a></li>
    <li id="_cha-1_footnote-19">Though it shouldn’t matter for the example applications in the <em>Rails Tutorial</em>, if you’re worried about accidentally making your app public too soon there are several options; see <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_commands" class="hyperref">Section&nbsp;<span class="ref">1.4.4</span></a> for one.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-19">↑</a></li>
    <li id="_cha-1_footnote-20">Pronounced “Engine X”.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-20">↑</a></li>
    <li id="_cha-1_footnote-21">https://toolbelt.heroku.com/&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-1_footnote-ref-21">↑</a></li>
  </ol>
</div><div id="_cha-a_demo_app" data-tralics-id="cid7" class="chapter" data-number="2"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="heading hyperref"><span class="number">Chapter 2 </span>A demo app</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>In this chapter, we’ll develop a simple demonstration application to show off some of the power of Rails.<span class="intersentencespace"></span> The purpose is to get a high-level overview of Ruby on Rails programming (and web development in general) by rapidly generating an application using <em>scaffold generators</em>.<span class="intersentencespace"></span> As discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-scaffolding" class="hyperref">Box&nbsp;<span class="ref">1.2</span></a>, the rest of the book will take the opposite approach, developing a full application incrementally and explaining each new concept as it arises, but for a quick overview (and some instant gratification) there is no substitute for scaffolding.<span class="intersentencespace"></span> The resulting demo app will allow us to interact with it through its URLs, giving us insight into the structure of a Rails application, including a first example of the <em>REST architecture</em> favored by Rails.</p>
<p>As with the forthcoming sample application, the demo app will consist of <em>users</em> and their associated <em>microposts</em> (thus constituting a minimalist Twitter-style app).<span class="intersentencespace"></span> The functionality will be utterly under-developed, and many of the steps will seem like magic, but worry not: the full sample app will develop a similar application from the ground up starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a>, and I will provide plentiful forward-references to later material.<span class="intersentencespace"></span> In the mean time, have patience and a little faith—the whole point of this tutorial is to take you <em>beyond</em> this superficial, scaffold-driven approach to achieve a deeper understanding of Rails.</p>
</div>
<div id="_sec-planning_the_application" data-tralics-id="cid8" class="section" data-number="2.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-planning_the_application" class="heading hyperref"><span class="number">2.1 </span>Planning the application</a></h2>
<p>In this section, we’ll outline our plans for the demo application.<span class="intersentencespace"></span> As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_application" class="hyperref">Section&nbsp;<span class="ref">1.2.3</span></a>, we’ll start by generating the application skeleton using the <code>rails</code> command:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects
<span class="gp">$</span> rails new demo_app
<span class="gp">$</span> <span class="nb">cd </span>demo_app
</pre></div></div>
<p>Next, we’ll use a text editor to update the <code>Gemfile</code> needed by Bundler with the contents of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_gemfile_sqlite_version_redux" class="hyperref">Listing&nbsp;<span class="ref">2.1</span></a>.</p>
<div class="codelisting" id="_code-demo_gemfile_sqlite_version_redux" data-tralics-id="uid102" data-number="2.1"><div class="heading"><span class="number">Listing 2.1:</span> 

<span class="description">A <code>Gemfile</code> for the demo app.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_gemfile_sqlite_version_redux" class="hyperref">Listing&nbsp;<span class="ref">2.1</span></a> is identical to <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_pg_gem" class="hyperref">Listing&nbsp;<span class="ref">1.9</span></a>.</p>
<p>As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_setup" class="hyperref">Section&nbsp;<span class="ref">1.4.1</span></a>, we’ll install the local gems while suppressing the installation of production gems using the <span class="inline_verbatim">--without production</span> option:<sup id="_cha-2_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-1">1</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --without production
</pre></div></div>
<p>(Recall that if Bundler complains about a <span class="tt">readline</span> error, try adding <code>gem ’rb-readline’</code> to your <code>Gemfile</code>.)</p>
<p>Finally, we’ll put the demo app under version control.<span class="intersentencespace"></span> Recall that the <code>rails</code> command generates a default <code>.gitignore</code> file, but depending on your system you may find the augmented file from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.7</span></a> to be more convenient.<span class="intersentencespace"></span> Then initialize a Git repository and make the first commit:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Initial commit"</span>
</pre></div></div>
<div class="center figure" id="_fig-create_demo_repo" data-tralics-id="uid104" data-number="2.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/create_demo_repo_4_0.png" alt="images/figures/create_demo_repo_4_0"></div><div class="caption"><span class="header">Figure 2.1: </span><span class="description">Creating a demo app repository at GitHub.
</span></div></div>
<p>You can also optionally create a new repository (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-create_demo_repo" class="hyperref">Figure&nbsp;<span class="ref">2.1</span></a>) and push it up to GitHub:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin https://github.com/&lt;username&gt;/demo_app.git
<span class="gp">$</span> git push -u origin master
</pre></div></div>
<p>(As with the first app, take care <em>not</em> to initialize the GitHub repository with a <code>README</code> file.)</p>
<p>Now we’re ready to start making the app itself.<span class="intersentencespace"></span> The typical first step when making a web application is to create a <em>data model</em>, which is a representation of the structures needed by our application.<span class="intersentencespace"></span> In our case, the demo app will be a microblog, with only users and short (micro)posts.<span class="intersentencespace"></span> Thus, we’ll begin with a model for <em>users</em> of the app (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_demo_users" class="hyperref">Section&nbsp;<span class="ref">2.1.1</span></a>), and then we’ll add a model for <em>microposts</em> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_demo_microposts" class="hyperref">Section&nbsp;<span class="ref">2.1.2</span></a>).</p>
<div id="_sec-modeling_demo_users" data-tralics-id="uid105" class="subsection" data-number="2.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_demo_users" class="heading hyperref"><span class="number">2.1.1 </span>Modeling demo users</a></h3>
<p>There are as many choices for a user data model as there are different registration forms on the web; we’ll go with a distinctly minimalist approach.<span class="intersentencespace"></span> Users of our demo app will have a unique <code>integer</code> identifier called <code>id</code>, a publicly viewable <code>name</code> (of type <code>string</code>), and an <code>email</code> address (also a <code>string</code>) that will double as a username.<span class="intersentencespace"></span> A summary of the data model for users appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_user_model" class="hyperref">Figure&nbsp;<span class="ref">2.2</span></a>.</p>
<div class="center figure" id="_fig-demo_user_model" data-tralics-id="uid106" data-number="2.2"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_user_model.png" alt="demo_user_model"></span>
<div class="caption"><span class="header">Figure 2.2: </span><span class="description">The data model for users.
</span></div></div>
<p>As we’ll see starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-database_migrations" class="hyperref">Section&nbsp;<span class="ref">6.1.1</span></a>, the label <code>users</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_user_model" class="hyperref">Figure&nbsp;<span class="ref">2.2</span></a> corresponds to a <em>table</em> in a database, and the <code>id</code>, <code>name</code>, and <code>email</code> attributes are <em>columns</em> in that table.</p>
</div>
<div id="_sec-modeling_demo_microposts" data-tralics-id="uid107" class="subsection" data-number="2.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_demo_microposts" class="heading hyperref"><span class="number">2.1.2 </span>Modeling demo microposts</a></h3>
<p>The core of the micropost data model is even simpler than the one for users: a micropost has only an <code>id</code> and a <code>content</code> field for the micropost’s text (of type <code>string</code>).<sup id="_cha-2_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-2">2</a></sup><span class="intersentencespace"></span> There’s an additional complication, though: we want to <em>associate</em> each micropost with a particular user; we’ll accomplish this by recording the <code>user_id</code> of the owner of the post.<span class="intersentencespace"></span> The results are shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_micropost_model" class="hyperref">Figure&nbsp;<span class="ref">2.3</span></a>.</p>
<div class="center figure" id="_fig-demo_micropost_model" data-tralics-id="uid109" data-number="2.3"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_micropost_model.png" alt="demo_micropost_model"></span>
<div class="caption"><span class="header">Figure 2.3: </span><span class="description">The data model for microposts.
</span></div></div>
<p>We’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_user_has_many_microposts" class="hyperref">Section&nbsp;<span class="ref">2.3.3</span></a> (and more fully in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a>) how this <code>user_id</code> attribute allows us to succinctly express the notion that a user potentially has many associated microposts.</p>
</div></div>
<div id="_sec-demo_users_resource" data-tralics-id="cid9" class="section" data-number="2.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_users_resource" class="heading hyperref"><span class="number">2.2 </span>The Users resource</a></h2>
<p>In this section, we’ll implement the users data model in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_demo_users" class="hyperref">Section&nbsp;<span class="ref">2.1.1</span></a>, along with a web interface to that model.<span class="intersentencespace"></span> The combination will constitute a <em>Users resource</em>, which will allow us to think of users as objects that can be created, read, updated, and deleted through the web via the <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank">HTTP protocol</a>.<span class="intersentencespace"></span> As promised in the introduction, our Users resource will be created by a scaffold generator program, which comes standard with each Rails project.<span class="intersentencespace"></span> I urge you not to look too closely at the generated code; at this stage, it will only serve to confuse you.</p>
<p>Rails scaffolding is generated by passing the <code>scaffold</code> command to the <code>rails generate</code> script.<span class="intersentencespace"></span> The argument of the <code>scaffold</code> command is the singular version of the resource name (in this case, <code>User</code>), together with optional parameters for the data model’s attributes:<sup id="_cha-2_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-3">3</a></sup></p>
<div class="code"><div class="highlight"><pre>$ rails generate scaffold User name:string email:string
      invoke  active_record
      create    db/migrate/20130305221714_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      test/models/user_test.rb
      create      test/fixtures/users.yml
      invoke  resource_route
       route    resources :users
      invoke  jbuilder_scaffold_controller
      create    app/controllers/users_controller.rb
      invoke    erb
      create      app/views/users
      create      app/views/users/index.html.erb
      create      app/views/users/edit.html.erb
      create      app/views/users/show.html.erb
      create      app/views/users/new.html.erb
      create      app/views/users/_form.html.erb
      invoke    test_unit
      create      test/controllers/users_controller_test.rb
      invoke    helper
      create      app/helpers/users_helper.rb
      invoke      test_unit
      create        test/helpers/users_helper_test.rb
      invoke    jbuilder
       exist      app/views/users
      create      app/views/users/index.json.jbuilder
      create      app/views/users/show.json.jbuilder
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/users.js.coffee
      invoke    scss
      create      app/assets/stylesheets/users.css.scss
      invoke  scss
      create    app/assets/stylesheets/scaffolds.css.scss
</pre></div></div>
<p>By including <code>name:string</code> and <code>email:string</code>, we have arranged for the User model to have the form shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_user_model" class="hyperref">Figure&nbsp;<span class="ref">2.2</span></a>.<span class="intersentencespace"></span> (Note that there is no need to include a parameter for&nbsp;<code>id</code>; it is created automatically by Rails for use as the <em>primary key</em> in the database.)</p>
<p>To proceed with the demo application, we first need to <em>migrate</em> the database using <em>Rake</em> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-rake" class="hyperref">Box&nbsp;<span class="ref">2.1</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="go">==  CreateUsers: migrating ====================================================</span>
<span class="go">-- create_table(:users)</span>
<span class="go">   -&gt; 0.0017s</span>
<span class="go">==  CreateUsers: migrated (0.0018s) ===========================================</span>
</pre></div></div>
<p>This simply updates the database with our new <code>users</code> data model.<span class="intersentencespace"></span> (We’ll learn more about database migrations starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-database_migrations" class="hyperref">Section&nbsp;<span class="ref">6.1.1</span></a>.)<span class="intersentencespace"></span> Note that, in order to ensure that the command uses the version of Rake corresponding to our <code>Gemfile</code>, we need to run <code>rake</code> using <code>bundle exec</code>.<span class="intersentencespace"></span> (If, as suggested in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_ruby" class="hyperref">Section&nbsp;<span class="ref">1.2.2.3</span></a>, you are using RVM, you can omit <code>bundle exec</code>, but I’ll include it for completeness.<span class="intersentencespace"></span> For alternate ways to eliminate the need for <code>bundle exec</code>, see <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-eliminating_bundle_exec" class="hyperref">Section&nbsp;<span class="ref">3.6.1</span></a>.)</p>
<p>With that, we can run the local web server using <code>rails s</code>, which is a shortcut for <code>rails server</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails s
</pre></div></div>
<p>Now the demo application should be ready to go at <a href="http://localhost:3000/" target="_blank">http://localhost:3000/</a>.</p>
<div class="aside" id="_sidebar-rake" data-tralics-id="uid111" data-number="2.1"><div class="heading"><span class="number">Box 2.1.</span> 

<span class="description">Rake</span></div>
<p>In the Unix tradition, the <a href="http://en.wikipedia.org/wiki/Make_(software)" target="_blank"><em>make</em></a> utility has played an important role in building executable programs from source code; many a computer hacker has committed to muscle memory the line</p>
<pre>  $ ./configure &amp;&amp; make &amp;&amp; sudo make install</pre>
<p>commonly used to compile code on Unix systems (including Linux and Mac OS&nbsp;X).</p>
<p>Rake is <em>Ruby make</em>, a make-like language written in Ruby.<span class="intersentencespace"></span> Rails uses Rake extensively, especially for the innumerable little administrative tasks necessary when developing database-backed web applications.<span class="intersentencespace"></span> The <code>rake db:migrate</code> command is probably the most common, but there are many others; you can see a list of database tasks using <code>-T db</code>:</p>
<pre>  $ bundle exec rake -T db</pre>
<p>To see all the Rake tasks available, run</p>
<pre>  $ bundle exec rake -T</pre>
<p>The list is likely to be overwhelming, but don’t worry, you don’t have to know all (or even most) of these commands.<span class="intersentencespace"></span> By the end of the <em>Rails Tutorial</em>, you’ll know all the most important ones.</p>

</div>
<div id="_sec-a_user_tour" data-tralics-id="uid112" class="subsection" data-number="2.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_tour" class="heading hyperref"><span class="number">2.2.1 </span>A user tour</a></h3>
<p>Visiting the root url&nbsp;<a href="http://localhost:3000/" target="_blank">http://localhost:3000/</a> shows the same default Rails page shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-riding_rails" class="hyperref">Figure&nbsp;<span class="ref">1.3</span></a>, but in generating the Users resource scaffolding we have also created a large number of pages for manipulating users.<span class="intersentencespace"></span> For example, the page for listing all users is at <a href="http://localhost:3000/users" target="_blank">/users</a>, and the
page for making a new user is at <a href="http://localhost:3000/users/new" target="_blank">/users/new</a>.<span class="intersentencespace"></span> The rest of this section is dedicated to taking a whirlwind tour through these user pages.<span class="intersentencespace"></span> As we proceed, it may help to refer to <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-user_urls" class="hyperref">Table&nbsp;<span class="ref">2.1</span></a>, which shows the correspondence between pages and URLs.</p>
<div class="table" id="_table-user_urls" data-tralics-id="uid113" data-number="2.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><a href="http://localhost:3000/users" target="_blank">/users</a></td>
<td class="align_left"><code>index</code></td>
<td class="align_left">page to list all users</td>
</tr><tr><td class="align_left"><a href="http://localhost:3000/users/1" target="_blank">/users/1</a></td>
<td class="align_left"><code>show</code></td>
<td class="align_left">page to show user with id <code>1</code></td>
</tr><tr><td class="align_left"><a href="http://localhost:3000/users/new" target="_blank">/users/new</a></td>
<td class="align_left"><code>new</code></td>
<td class="align_left">page to make a new user</td>
</tr><tr><td class="align_left"><a href="http://localhost:3000/users/1/edit" target="_blank">/users/1/edit</a></td>
<td class="align_left"><code>edit</code></td>
<td class="align_left">page to edit user with id <code>1</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 2.1: </span><span class="description">The correspondence between pages and URLs for the Users resource.
</span></div></div>
<p>We start with the page to show all the users in our application, called <a href="http://localhost:3000/users" target="_blank"><span class="tt">index</span></a>; as you might expect, initially there are no users at all (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_blank_user_index_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.4</span></a>).</p>
<div class="center figure" id="_fig-demo_blank_user_index_rails_3" data-tralics-id="uid114" data-number="2.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_blank_user_index_rails_3.png" alt="images/figures/demo_blank_user_index_rails_3"></div><div class="caption"><span class="header">Figure 2.4: </span><span class="description">The initial index page for the Users resource (<a href="http://localhost:3000/users" target="_blank">/users</a>).
</span></div></div>
<p>To make a new user, we visit the <a href="http://localhost:3000/users/new" target="_blank"><span class="tt">new</span></a> page, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_new_user_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.5</span></a>.<span class="intersentencespace"></span> (Since the http://localhost:3000 part of the address is implicit whenever we are developing locally, I’ll usually omit it from now on.)<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>, this will become the user signup page.</p>
<div class="center figure" id="_fig-demo_new_user_rails_3" data-tralics-id="uid115" data-number="2.5">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_new_user_rails_3.png" alt="images/figures/demo_new_user_rails_3"></div><div class="caption"><span class="header">Figure 2.5: </span><span class="description">The new user page (<a href="http://localhost:3000/users/new" target="_blank">/users/new</a>).
</span></div></div>
<p>We can create a user by entering name and email values in the text fields and then clicking the Create User button.<span class="intersentencespace"></span> The result is the user <a href="http://localhost:3000/users/1" target="_blank"><span class="tt">show</span></a> page, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_show_user_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.6</span></a>.<span class="intersentencespace"></span> (The green welcome message is accomplished using the <em>flash</em>, which we’ll learn about in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_flash" class="hyperref">Section&nbsp;<span class="ref">7.4.2</span></a>.)<span class="intersentencespace"></span> Note that the URL is <a href="http://localhost:3000/users/1" target="_blank">/users/1</a>; as you might suspect, the number&nbsp;<code>1</code> is simply the user’s&nbsp;<code>id</code> attribute from <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_user_model" class="hyperref">Figure&nbsp;<span class="ref">2.2</span></a>.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_users" class="hyperref">Section&nbsp;<span class="ref">7.1</span></a>, this page will become the user’s profile.</p>
<div class="center figure" id="_fig-demo_show_user_rails_3" data-tralics-id="uid116" data-number="2.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_show_user_rails_3.png" alt="images/figures/demo_show_user_rails_3"></div><div class="caption"><span class="header">Figure 2.6: </span><span class="description">The page to show a user (<a href="http://localhost:3000/users/1" target="_blank">/users/1</a>).
</span></div></div>
<p>To change a user’s information, we visit the <a href="http://localhost:3000/users/1/edit" target="_blank"><span class="tt">edit</span></a> page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_edit_user_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.7</span></a>).<span class="intersentencespace"></span> By modifying the user information and clicking the Update User button, we arrange to change the information for the user in the demo application (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_update_user_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.8</span></a>).<span class="intersentencespace"></span> (As we’ll see in detail starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>, this user data is stored in a database back-end.)<span class="intersentencespace"></span> We’ll add user edit/update functionality to the sample application in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_users" class="hyperref">Section&nbsp;<span class="ref">9.1</span></a>.</p>
<div class="center figure" id="_fig-demo_edit_user_rails_3" data-tralics-id="uid117" data-number="2.7">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_edit_user_rails_3.png" alt="images/figures/demo_edit_user_rails_3"></div><div class="caption"><span class="header">Figure 2.7: </span><span class="description">The user edit page (<a href="http://localhost:3000/users/1/edit" target="_blank">/users/1/edit</a>).
</span></div></div>
<div class="center figure" id="_fig-demo_update_user_rails_3" data-tralics-id="uid118" data-number="2.8">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_update_user_rails_3.png" alt="images/figures/demo_update_user_rails_3"></div><div class="caption"><span class="header">Figure 2.8: </span><span class="description">A user with updated information.
</span></div></div>
<p>Now we’ll create a second user by revisiting the <a href="http://localhost:3000/users/new" target="_blank"><span class="tt">new</span></a> page and submitting a second set of user information; the resulting user <a href="http://localhost:3000/users" target="_blank"><span class="tt">index</span></a> is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_user_index_two_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.9</span></a>.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_users" class="hyperref">Section&nbsp;<span class="ref">7.1</span></a> will develop the user index into a more polished page for showing all users.</p>
<div class="center figure" id="_fig-demo_user_index_two_rails_3" data-tralics-id="uid119" data-number="2.9">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_user_index_two_rails_3.png" alt="images/figures/demo_user_index_two_rails_3"></div><div class="caption"><span class="header">Figure 2.9: </span><span class="description">The user index page (<a href="http://localhost:3000/users" target="_blank">/users</a>) with a second user.
</span></div></div>
<p>Having shown how to create, show, and edit users, we come finally to destroying them (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_destroy_user_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.10</span></a>).<span class="intersentencespace"></span> You should verify that clicking on the link in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_destroy_user_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.10</span></a> destroys the second user, yielding an index page with only one user.<span class="intersentencespace"></span> (If it doesn’t work, be sure that JavaScript is enabled in your browser; Rails uses JavaScript to issue the request needed to destroy a user.)<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-destroying_users" class="hyperref">Section&nbsp;<span class="ref">9.4</span></a> adds user deletion to the sample app, taking care to restrict its use to a special class of administrative users.</p>
<div class="center figure" id="_fig-demo_destroy_user_rails_3" data-tralics-id="uid120" data-number="2.10">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_destroy_user_rails_3.png" alt="images/figures/demo_destroy_user_rails_3"></div><div class="caption"><span class="header">Figure 2.10: </span><span class="description">Destroying a user.
</span></div></div>
</div>
<div id="_sec-mvc_in_action" data-tralics-id="uid121" class="subsection" data-number="2.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc_in_action" class="heading hyperref"><span class="number">2.2.2 </span>MVC in action</a></h3>
<p>Now that we’ve completed a quick overview of the Users resource, let’s examine one particular part of it in the context of the Model-View-Controller (MVC) pattern introduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc" class="hyperref">Section&nbsp;<span class="ref">1.2.6</span></a>.<span class="intersentencespace"></span> Our strategy will be to describe the results of a typical browser hit—a visit to the user index page at <a href="http://localhost:3000/users" target="_blank">/users</a>—in terms of MVC (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-mvc_detailed" class="hyperref">Figure&nbsp;<span class="ref">2.11</span></a>).</p>
<div class="center figure" id="_fig-mvc_detailed" data-tralics-id="uid122" data-number="2.11">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/mvc_detailed.png" alt="images/figures/mvc_detailed"></div><div class="caption"><span class="header">Figure 2.11: </span><span class="description">A detailed diagram of MVC in Rails.
</span></div></div>
<ol>
<li>The browser issues a request for the /users URL.
</li>
<li>Rails routes /users to the <code>index</code> action in the Users controller.<span class="intersentencespace"></span>
</li>
<li>The <code>index</code> action asks the User model to retrieve all users (<code>User.all</code>).<span class="intersentencespace"></span>
</li>
<li>The User model pulls all the users from the database.<span class="intersentencespace"></span>
</li>
<li>The User model returns the list of users to the controller.<span class="intersentencespace"></span>
</li>
<li>The controller captures the users in the <code>@users</code> variable, which is passed to the <code>index</code> view.<span class="intersentencespace"></span>
</li>
<li>The view uses embedded Ruby to render the page as HTML.
</li>
<li>The controller passes the HTML back to the browser.<sup id="_cha-2_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-4">4</a></sup>
</li></ol>
<p>We start with a request issued from the browser—i.e., the result of typing a URL in the address bar or clicking on a link (Step&nbsp;1 in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-mvc_detailed" class="hyperref">Figure&nbsp;<span class="ref">2.11</span></a>).<span class="intersentencespace"></span> This request hits the <em>Rails router</em> (Step&nbsp;2), which dispatches to the proper <em>controller action</em> based on the URL (and, as we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-get_etc" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>, the type of request).<span class="intersentencespace"></span> The code to create the mapping of user URLs to controller actions for the Users resource appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rails_routes" class="hyperref">Listing&nbsp;<span class="ref">2.2</span></a>; this code effectively sets up the table of URL/action pairs seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-user_urls" class="hyperref">Table&nbsp;<span class="ref">2.1</span></a>.<span class="intersentencespace"></span> (The strange notation <code>:users</code> is a <em>symbol</em>, which we’ll learn about in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-hashes_and_symbols" class="hyperref">Section&nbsp;<span class="ref">4.3.3</span></a>.)</p>
<div class="codelisting" id="_code-rails_routes" data-tralics-id="uid132" data-number="2.2"><div class="heading"><span class="number">Listing 2.2:</span> 

<span class="description">The Rails routes, with a rule for the Users resource.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">DemoApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The pages from the tour in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_tour" class="hyperref">Section&nbsp;<span class="ref">2.2.1</span></a> correspond to <em>actions</em> in the Users <em>controller</em>, which is a collection of related actions; the controller generated by the scaffolding is shown schematically in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_users_controller" class="hyperref">Listing&nbsp;<span class="ref">2.3</span></a>.<span class="intersentencespace"></span> Note the notation <code>class UsersController &lt; ApplicationController</code>; this is an example of a Ruby <em>class</em> with <em>inheritance</em>.<span class="intersentencespace"></span> (We’ll discuss inheritance briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-inheritance_hierarchies" class="hyperref">Section&nbsp;<span class="ref">2.3.4</span></a> and cover both subjects in more detail in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ruby_classes" class="hyperref">Section&nbsp;<span class="ref">4.4</span></a>.)</p>
<div class="codelisting" id="_code-demo_users_controller" data-tralics-id="uid133" data-number="2.3"><div class="heading"><span class="number">Listing 2.3:</span> 

<span class="description">The Users controller in schematic form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>You may notice that there are more actions than there are pages; the <code>index</code>, <code>show</code>, <code>new</code>, and <code>edit</code> actions all correspond to pages from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_tour" class="hyperref">Section&nbsp;<span class="ref">2.2.1</span></a>, but there are additional <code>create</code>, <code>update</code>, and <code>destroy</code> actions as well.<span class="intersentencespace"></span> These actions don’t typically render pages (although they sometimes do); instead, their main purpose is to modify information about users in the database.<span class="intersentencespace"></span> This full suite of controller actions, summarized in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-demo_RESTful_users" class="hyperref">Table&nbsp;<span class="ref">2.2</span></a>, represents the implementation of the REST architecture in Rails (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-REST" class="hyperref">Box&nbsp;<span class="ref">2.2</span></a>), which is based on the ideas of <em>representational state transfer</em> identified and named by computer scientist <a href="http://en.wikipedia.org/wiki/Roy_Fielding" target="_blank">Roy Fielding</a>.<sup id="_cha-2_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-5">5</a></sup><span class="intersentencespace"></span> Note from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-demo_RESTful_users" class="hyperref">Table&nbsp;<span class="ref">2.2</span></a> that there is some overlap in the URLs; for example, both the user <code>show</code> action and the <code>update</code> action correspond to the URL /users/1.<span class="intersentencespace"></span> The difference between them is the <a href="http://en.wikipedia.org/wiki/HTTP_request#Request_methods" target="_blank">HTTP request method</a> they respond to.<span class="intersentencespace"></span> We’ll learn more about HTTP request methods starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-TDD" class="hyperref">Section&nbsp;<span class="ref">3.2.1</span></a>.</p>
<div class="table" id="_table-demo_RESTful_users" data-tralics-id="uid135" data-number="2.2"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users</td>
<td class="align_left"><code>index</code></td>
<td class="align_left">page to list all users</td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>show</code></td>
<td class="align_left">page to show user with id <code>1</code></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/new</td>
<td class="align_left"><code>new</code></td>
<td class="align_left">page to make a new user</td>
</tr><tr><td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/users</td>
<td class="align_left"><code>create</code></td>
<td class="align_left">create a new user</td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/edit</td>
<td class="align_left"><code>edit</code></td>
<td class="align_left">page to edit user with id <code>1</code></td>
</tr><tr><td class="align_left"><span class="tt">PATCH</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>update</code></td>
<td class="align_left">update user with id <code>1</code></td>
</tr><tr><td class="align_left"><span class="tt">DELETE</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left">delete user with id <code>1</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 2.2: </span><span class="description">RESTful routes provided by the Users resource in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rails_routes" class="hyperref">Listing&nbsp;<span class="ref">2.2</span></a>.
</span></div></div>
<div class="aside" id="_sidebar-REST" data-tralics-id="uid136" data-number="2.2"><div class="heading"><span class="number">Box 2.2.</span> 

<span class="description">REpresentational State Transfer (REST)</span></div>
<p>If you read much about Ruby on Rails web development, you’ll see a lot of references to “REST”, which is an acronym for REpresentational State Transfer.<span class="intersentencespace"></span> REST is an architectural style for developing distributed, networked systems and software applications such as the World Wide Web and web applications.<span class="intersentencespace"></span> Although REST theory is rather abstract, in the context of Rails applications REST means that most application components (such as users and microposts) are modeled as <em>resources</em> that can be created, read, updated, and deleted—operations that correspond both to the <a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank">CRUD operations of relational databases</a> and four fundamental <a href="http://en.wikipedia.org/wiki/HTTP_request#Request_methods" target="_blank">HTTP request methods</a>: <span class="tt">POST</span>, <span class="tt">GET</span>, <span class="tt">PATCH</span>, and <span class="tt">DELETE</span>.<span class="intersentencespace"></span> (We’ll learn more about HTTP requests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-TDD" class="hyperref">Section&nbsp;<span class="ref">3.2.1</span></a> and especially <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-get_etc" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>.)</p>
<p>As a Rails application developer, the RESTful style of development helps you make choices about which controllers and actions to write: you simply structure the application using resources that get created, read, updated, and deleted.<span class="intersentencespace"></span> In the case of users and microposts, this process is straightforward, since they are naturally resources in their own right.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>, we’ll see an example where REST principles allow us to model a subtler problem, “following users”, in a natural and convenient way.</p>

</div><p>To examine the relationship between the Users controller and the User model, let’s focus on a simplified version of the <code>index</code> action, shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_index_action" class="hyperref">Listing&nbsp;<span class="ref">2.4</span></a>.<span class="intersentencespace"></span> (The scaffold code is ugly and confusing, so I’ve suppressed it.)</p>
<div class="codelisting" id="_code-demo_index_action" data-tralics-id="uid137" data-number="2.4"><div class="heading"><span class="number">Listing 2.4:</span> 

<span class="description">The simplified user <code>index</code> action for the demo application.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>This <code>index</code> action has the line <code>@users = User.all</code> (Step&nbsp;3), which asks the User model to retrieve a list of all the users from the database (Step&nbsp;4), and then places them in the variable <code>@users</code> (pronounced “at-users”) (Step&nbsp;5).<span class="intersentencespace"></span> The User model itself appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_user_model" class="hyperref">Listing&nbsp;<span class="ref">2.5</span></a>; although it is rather plain, it comes equipped with a large amount of functionality because of inheritance (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-inheritance_hierarchies" class="hyperref">Section&nbsp;<span class="ref">2.3.4</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ruby_classes" class="hyperref">Section&nbsp;<span class="ref">4.4</span></a>).<span class="intersentencespace"></span> In particular, by using the Rails library called <em>Active Record</em>, the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_user_model" class="hyperref">Listing&nbsp;<span class="ref">2.5</span></a> arranges for <code>User.all</code> to return all the users.</p>
<div class="codelisting" id="_code-demo_user_model" data-tralics-id="uid138" data-number="2.5"><div class="heading"><span class="number">Listing 2.5:</span> 

<span class="description">The User model for the demo application.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre></div></div></div><p>Once the <code>@users</code> variable is defined, the controller calls the <em>view</em> (Step&nbsp;6), shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_index_view" class="hyperref">Listing&nbsp;<span class="ref">2.6</span></a>.<span class="intersentencespace"></span> Variables that start with the <code>@</code>&nbsp;sign, called <em>instance variables</em>, are automatically available in the view; in this case, the <code>index.html.erb</code> view in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_index_view" class="hyperref">Listing&nbsp;<span class="ref">2.6</span></a> iterates through the <code>@users</code> list and outputs a line of HTML for each one.<span class="intersentencespace"></span> (Remember, you aren’t supposed to understand this code right now.<span class="intersentencespace"></span> It is shown only for purposes of illustration.)</p>
<div class="codelisting" id="_code-demo_index_view" data-tralics-id="uid139" data-number="2.6"><div class="heading"><span class="number">Listing 2.6:</span> 

<span class="description">The view for the user index.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Listing users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Email<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>

<span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Show'</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Edit'</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Destroy'</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s1">'Are you sure?'</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/table&gt;</span>

<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'New User'</span><span class="p">,</span> <span class="n">new_user_path</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>The view converts its contents to HTML (Step&nbsp;7), which is then returned by the controller to the browser for display (Step&nbsp;8).</p>
</div>
<div id="_sec-weaknesses_of_this_users_resource" data-tralics-id="uid140" class="subsection" data-number="2.2.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-weaknesses_of_this_users_resource" class="heading hyperref"><span class="number">2.2.3 </span>Weaknesses of this Users resource</a></h3>
<p>Though good for getting a general overview of Rails, the scaffold Users resource suffers from a number of severe weaknesses.</p>
<ul>
<li><strong>No data validations.</strong><span class="intersentencespace"></span> Our User model accepts data such as blank names and invalid email addresses without complaint.<span class="intersentencespace"></span>
</li>
<li><strong>No authentication.</strong><span class="intersentencespace"></span> We have no notion of signing in or out, and no way to prevent any user from performing any operation.<span class="intersentencespace"></span>
</li>
<li><strong>No tests.</strong><span class="intersentencespace"></span> This isn’t technically true—the scaffolding includes rudimentary tests—but the generated tests are ugly and inflexible, and they don’t test for data validation, authentication, or any other custom requirements.<span class="intersentencespace"></span>
</li>
<li><strong>No layout.</strong><span class="intersentencespace"></span> There is no consistent site styling or navigation.<span class="intersentencespace"></span>
</li>
<li><strong>No real understanding.</strong><span class="intersentencespace"></span> If you understand the scaffold code, you probably shouldn’t be reading this book.<span class="intersentencespace"></span>
</li></ul>
</div></div>
<div id="_sec-microposts_resource" data-tralics-id="cid10" class="section" data-number="2.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-microposts_resource" class="heading hyperref"><span class="number">2.3 </span>The Microposts resource</a></h2>
<p>Having generated and explored the Users resource, we turn now to the associated Microposts resource.<span class="intersentencespace"></span> Throughout this section, I recommend comparing the elements of the Microposts resource with the analogous user elements from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_users_resource" class="hyperref">Section&nbsp;<span class="ref">2.2</span></a>; you should see that the two resources parallel each other in many ways.<span class="intersentencespace"></span> The RESTful structure of Rails applications is best absorbed by this sort of repetition of form; indeed, seeing the parallel structure of Users and Microposts even at this early stage is one of the prime motivations for this chapter.<span class="intersentencespace"></span> (As we’ll see, writing applications more robust than the toy example in this chapter takes considerable effort—we won’t see the Microposts resource again until <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a>—and I didn’t want to defer its first appearance quite that far.)</p>
<div id="_sec-a_micropost_microtour" data-tralics-id="uid146" class="subsection" data-number="2.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_micropost_microtour" class="heading hyperref"><span class="number">2.3.1 </span>A micropost microtour</a></h3>
<p>As with the Users resource, we’ll generate scaffold code for the Microposts resource using <code>rails generate scaffold</code>, in this case implementing the data model from <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_micropost_model" class="hyperref">Figure&nbsp;<span class="ref">2.3</span></a>:<sup id="_cha-2_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-6">6</a></sup></p>
<div class="code"><div class="highlight"><pre>$ rails generate scaffold Micropost content:string user_id:integer
      invoke  active_record
      create    db/migrate/20130307005528_create_microposts.rb
      create    app/models/micropost.rb
      invoke    test_unit
      create      test/models/micropost_test.rb
      create      test/fixtures/microposts.yml
      invoke  resource_route
       route    resources :microposts
      invoke  jbuilder_scaffold_controller
      create    app/controllers/microposts_controller.rb
      invoke    erb
      create      app/views/microposts
      create      app/views/microposts/index.html.erb
      create      app/views/microposts/edit.html.erb
      create      app/views/microposts/show.html.erb
      create      app/views/microposts/new.html.erb
      create      app/views/microposts/_form.html.erb
      invoke    test_unit
      create      test/controllers/microposts_controller_test.rb
      invoke    helper
      create      app/helpers/microposts_helper.rb
      invoke      test_unit
      create        test/helpers/microposts_helper_test.rb
      invoke    jbuilder
       exist      app/views/microposts
      create      app/views/microposts/index.json.jbuilder
      create      app/views/microposts/show.json.jbuilder
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/microposts.js.coffee
      invoke    scss
      create      app/assets/stylesheets/microposts.css.scss
      invoke  scss
   identical    app/assets/stylesheets/scaffolds.css.scss
</pre></div></div>
<p>To update our database with the new data model, we need to run a migration as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_users_resource" class="hyperref">Section&nbsp;<span class="ref">2.2</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="go">==  CreateMicroposts: migrating ===============================================</span>
<span class="go">-- create_table(:microposts)</span>
<span class="go">   -&gt; 0.0023s</span>
<span class="go">==  CreateMicroposts: migrated (0.0026s) ======================================</span>
</pre></div></div>
<p>Now we are in a position to create microposts in the same way we created users in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_tour" class="hyperref">Section&nbsp;<span class="ref">2.2.1</span></a>.<span class="intersentencespace"></span> As you might guess, the scaffold generator has updated the Rails routes file with a rule for Microposts resource, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_microposts_resource" class="hyperref">Listing&nbsp;<span class="ref">2.7</span></a>.<sup id="_cha-2_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-7">7</a></sup><span class="intersentencespace"></span> As with users, the <code>resources :microposts</code> routing rule maps micropost URLs to actions in the Microposts controller, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-demo_RESTful_microposts" class="hyperref">Table&nbsp;<span class="ref">2.3</span></a>.</p>
<div class="codelisting" id="_code-demo_microposts_resource" data-tralics-id="uid149" data-number="2.7"><div class="heading"><span class="number">Listing 2.7:</span> 

<span class="description">The Rails routes, with a new rule for Microposts resources.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">DemoApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:microposts</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="table" id="_table-demo_RESTful_microposts" data-tralics-id="uid150" data-number="2.3"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/microposts</td>
<td class="align_left"><code>index</code></td>
<td class="align_left">page to list all microposts</td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/microposts/1</td>
<td class="align_left"><code>show</code></td>
<td class="align_left">page to show micropost with id <code>1</code></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/microposts/new</td>
<td class="align_left"><code>new</code></td>
<td class="align_left">page to make a new micropost</td>
</tr><tr><td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/microposts</td>
<td class="align_left"><code>create</code></td>
<td class="align_left">create a new micropost</td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/microposts/1/edit</td>
<td class="align_left"><code>edit</code></td>
<td class="align_left">page to edit micropost with id <code>1</code></td>
</tr><tr><td class="align_left"><span class="tt">PATCH</span></td>
<td class="align_left">/microposts/1</td>
<td class="align_left"><code>update</code></td>
<td class="align_left">update micropost with id <code>1</code></td>
</tr><tr><td class="align_left"><span class="tt">DELETE</span></td>
<td class="align_left">/microposts/1</td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left">delete micropost with id <code>1</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 2.3: </span><span class="description">RESTful routes provided by the Microposts resource in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_microposts_resource" class="hyperref">Listing&nbsp;<span class="ref">2.7</span></a>.
</span></div></div>
<p>The Microposts controller itself appears in schematic form <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_microposts_controller" class="hyperref">Listing&nbsp;<span class="ref">2.8</span></a>.<span class="intersentencespace"></span> Note that, apart from having <code>MicropostsController</code> in place of <code>UsersController</code>, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_microposts_controller" class="hyperref">Listing&nbsp;<span class="ref">2.8</span></a> is <em>identical</em> to the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_users_controller" class="hyperref">Listing&nbsp;<span class="ref">2.3</span></a>.<span class="intersentencespace"></span> This is a reflection of the REST architecture common to both resources.</p>
<div class="codelisting" id="_code-demo_microposts_controller" data-tralics-id="uid151" data-number="2.8"><div class="heading"><span class="number">Listing 2.8:</span> 

<span class="description">The Microposts controller in schematic form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To make some actual microposts, we enter information at the new microposts page, <a href="http://localhost:3000/microposts/new" target="_blank">/microposts/new</a>, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_new_micropost_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.12</span></a>.</p>
<div class="center figure" id="_fig-demo_new_micropost_rails_3" data-tralics-id="uid152" data-number="2.12">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_new_micropost_rails_3.png" alt="images/figures/demo_new_micropost_rails_3"></div><div class="caption"><span class="header">Figure 2.12: </span><span class="description">The new micropost page (<a href="http://localhost:3000/microposts/new" target="_blank">/microposts/new</a>).
</span></div></div>
<p>At this point, go ahead and create a micropost or two, taking care to make sure that at least one has a <code>user_id</code> of&nbsp;<code>1</code> to match the id of the first user created in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_tour" class="hyperref">Section&nbsp;<span class="ref">2.2.1</span></a>.<span class="intersentencespace"></span> The result should look something like <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_micropost_index_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.13</span></a>.</p>
<div class="center figure" id="_fig-demo_micropost_index_rails_3" data-tralics-id="uid153" data-number="2.13">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_micropost_index_rails_3.png" alt="images/figures/demo_micropost_index_rails_3"></div><div class="caption"><span class="header">Figure 2.13: </span><span class="description">The micropost index page (<a href="http://localhost:3000/microposts" target="_blank">/microposts</a>).
</span></div></div>
</div>
<div id="_sec-putting_the_micro_in_microposts" data-tralics-id="uid154" class="subsection" data-number="2.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-putting_the_micro_in_microposts" class="heading hyperref"><span class="number">2.3.2 </span>Putting the <em>micro</em> in microposts</a></h3>
<p>Any <em>micro</em>post worthy of the name should have some means of enforcing the length of the post.<span class="intersentencespace"></span> Implementing this constraint in Rails is easy with <em>validations</em>; to accept microposts with at most 140 characters (à la Twitter), we use a <em>length</em> validation.<span class="intersentencespace"></span> At this point, you should open the file <code>app/models/micropost.rb</code> in your text editor or IDE and fill it with the contents of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_length_validation" class="hyperref">Listing&nbsp;<span class="ref">2.9</span></a>.<span class="intersentencespace"></span> (The use of <code>validates</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_length_validation" class="hyperref">Listing&nbsp;<span class="ref">2.9</span></a> is characteristic of Rails&nbsp;3; if you’ve previously worked with Rails&nbsp;2.3, you should compare this to the use of <code>validates_length_of</code>.)</p>
<div class="codelisting" id="_code-demo_length_validation" data-tralics-id="uid155" data-number="2.9"><div class="heading"><span class="number">Listing 2.9:</span> 

<span class="description">Constraining microposts to be at most 140 characters.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_length_validation" class="hyperref">Listing&nbsp;<span class="ref">2.9</span></a> may look rather mysterious—we’ll cover validations more thoroughly starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_validations" class="hyperref">Section&nbsp;<span class="ref">6.2</span></a>—but its effects are readily apparent if we go to the new micropost page and enter more than 140 characters for the content of the post.<span class="intersentencespace"></span> As seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-micropost_length_error_rails_3" class="hyperref">Figure&nbsp;<span class="ref">2.14</span></a>, Rails renders <em>error messages</em> indicating that the micropost’s content is too long.<span class="intersentencespace"></span> (We’ll learn more about error messages in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_error_messages" class="hyperref">Section&nbsp;<span class="ref">7.3.3</span></a>.)</p>
<div class="center figure" id="_fig-micropost_length_error_rails_3" data-tralics-id="uid156" data-number="2.14">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/micropost_length_error_rails_3.png" alt="images/figures/micropost_length_error_rails_3"></div><div class="caption"><span class="header">Figure 2.14: </span><span class="description">Error messages for a failed micropost creation.
</span></div></div>
</div>
<div id="_sec-demo_user_has_many_microposts" data-tralics-id="uid157" class="subsection" data-number="2.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_user_has_many_microposts" class="heading hyperref"><span class="number">2.3.3 </span>A user <span class="tt">has_many</span> microposts</a></h3>
<p>One of the most powerful features of Rails is the ability to form <em>associations</em> between different data models.<span class="intersentencespace"></span> In the case of our User model, each user potentially has many microposts.<span class="intersentencespace"></span> We can express this in code by updating the User and Micropost models as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_user_has_many_microposts" class="hyperref">Listing&nbsp;<span class="ref">2.10</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_micropost_belongs_to_user" class="hyperref">Listing&nbsp;<span class="ref">2.11</span></a>.</p>
<div class="codelisting" id="_code-demo_user_has_many_microposts" data-tralics-id="uid158" data-number="2.10"><div class="heading"><span class="number">Listing 2.10:</span> 

<span class="description">A user has many microposts.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-demo_micropost_belongs_to_user" data-tralics-id="uid159" data-number="2.11"><div class="heading"><span class="number">Listing 2.11:</span> 

<span class="description">A micropost belongs to a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>We can visualize the result of this association in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-micropost_user_association" class="hyperref">Figure&nbsp;<span class="ref">2.15</span></a>.<span class="intersentencespace"></span> Because of the <code>user_id</code> column in the <code>microposts</code> table, Rails (using Active Record) can infer the microposts associated with each user.</p>
<div class="center figure" id="_fig-micropost_user_association" data-tralics-id="uid160" data-number="2.15">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/micropost_user_association.png" alt="images/figures/micropost_user_association"></div><div class="caption"><span class="header">Figure 2.15: </span><span class="description">The association between microposts and users.
</span></div></div>
<p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>, we will use the association of users and microposts both to display all of a user’s microposts and to construct a Twitter-like micropost feed.<span class="intersentencespace"></span> For now, we can examine the implications of the user-micropost association by using the <em>console</em>, which is a useful tool for interacting with Rails applications.<span class="intersentencespace"></span> We first invoke the console with <code>rails console</code> at the command line, and then retrieve the first user from the database using <code>User.first</code> (putting the results in the variable <code>first_user</code>):<sup id="_cha-2_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-8">8</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">first_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.org",</span>
<span class="go">created_at: "2013-03-06 02:01:31", updated_at: "2013-03-06 02:01:31"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">first_user</span><span class="o">.</span><span class="n">microposts</span>
<span class="go">=&gt; [#&lt;Micropost id: 1, content: "First micropost!", user_id: 1, created_at:</span>
<span class="go">"2013-03-06 02:37:37", updated_at: "2013-03-06 02:37:37"&gt;, #&lt;Micropost id: 2,</span>
<span class="go">content: "Second micropost", user_id: 1, created_at: "2013-03-06 02:38:54",</span>
<span class="go">updated_at: "2013-03-06 02:38:54"&gt;]</span>
<span class="gp">&gt;&gt; </span><span class="nb">exit</span>
</pre></div></div>
<p>(I include the last line just to demonstrate how to exit the console, and on most systems you can Ctrl-d for the same purpose.)<span class="intersentencespace"></span> Here we have accessed the user’s microposts using the code <code>first_user.microposts</code>: with this code, Active Record automatically returns all the microposts with <code>user_id</code> equal to the id of <code>first_user</code> (in this case,&nbsp;<code>1</code>).<span class="intersentencespace"></span> We’ll learn much more about the association facilities in Active Record in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>.</p>
</div>
<div id="_sec-inheritance_hierarchies" data-tralics-id="uid162" class="subsection" data-number="2.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-inheritance_hierarchies" class="heading hyperref"><span class="number">2.3.4 </span>Inheritance hierarchies</a></h3>
<p>We end our discussion of the demo application with a brief description of the controller and model class hierarchies in Rails.<span class="intersentencespace"></span> This discussion will only make much sense if you have some experience with object-oriented programming (OOP); if you haven’t studied OOP, feel free to skip this section.<span class="intersentencespace"></span> In particular, if you are unfamiliar with <em>classes</em> (discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ruby_classes" class="hyperref">Section&nbsp;<span class="ref">4.4</span></a>), I suggest looping back to this section at a later time.</p>
<p>We start with the inheritance structure for models.<span class="intersentencespace"></span> Comparing <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_user_class" class="hyperref">Listing&nbsp;<span class="ref">2.12</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_micropost_class" class="hyperref">Listing&nbsp;<span class="ref">2.13</span></a>, we see that both the User model and the Micropost model inherit (via the left angle bracket&nbsp;<code>&lt;</code>) from <code>ActiveRecord::Base</code>, which is the base class for models provided by ActiveRecord; a diagram summarizing this relationship appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_model_inheritance" class="hyperref">Figure&nbsp;<span class="ref">2.16</span></a>.<span class="intersentencespace"></span> It is by inheriting from <code>ActiveRecord::Base</code> that our model objects gain the ability to communicate with the database, treat the database columns as Ruby attributes, and so&nbsp;on.</p>
<div class="codelisting" id="_code-demo_user_class" data-tralics-id="uid163" data-number="2.12"><div class="heading"><span class="number">Listing 2.12:</span> 

<span class="description">The <code>User</code> class, with inheritance.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-demo_micropost_class" data-tralics-id="uid164" data-number="2.13"><div class="heading"><span class="number">Listing 2.13:</span> 

<span class="description">The <code>Micropost</code> class, with inheritance.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="center figure" id="_fig-demo_model_inheritance" data-tralics-id="uid165" data-number="2.16">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_model_inheritance.png" alt="images/figures/demo_model_inheritance"></div><div class="caption"><span class="header">Figure 2.16: </span><span class="description">The inheritance hierarchy for the User and Micropost models.
</span></div></div>
<p>The inheritance structure for controllers is only slightly more complicated.<span class="intersentencespace"></span> Comparing <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_users_controller_class" class="hyperref">Listing&nbsp;<span class="ref">2.14</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_microposts_controller_class" class="hyperref">Listing&nbsp;<span class="ref">2.15</span></a>, we see that both the Users controller and the Microposts controller inherit from the Application controller.<span class="intersentencespace"></span> Examining <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_application_controller_class" class="hyperref">Listing&nbsp;<span class="ref">2.16</span></a>, we see that <code>ApplicationController</code> itself inherits from <code>ActionController::Base</code>; this is the base class for controllers provided by the Rails library Action Pack.<span class="intersentencespace"></span> The relationships between these classes is illustrated in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-demo_controller_inheritance" class="hyperref">Figure&nbsp;<span class="ref">2.17</span></a>.</p>
<div class="codelisting" id="_code-demo_users_controller_class" data-tralics-id="uid166" data-number="2.14"><div class="heading"><span class="number">Listing 2.14:</span> 

<span class="description">The <code>UsersController</code> class, with inheritance.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-demo_microposts_controller_class" data-tralics-id="uid167" data-number="2.15"><div class="heading"><span class="number">Listing 2.15:</span> 

<span class="description">The <code>MicropostsController</code> class, with inheritance.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-demo_application_controller_class" data-tralics-id="uid168" data-number="2.16"><div class="heading"><span class="number">Listing 2.16:</span> 

<span class="description">The <code>ApplicationController</code> class, with inheritance.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/application_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="center figure" id="_fig-demo_controller_inheritance" data-tralics-id="uid169" data-number="2.17">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/demo_controller_inheritance.png" alt="images/figures/demo_controller_inheritance"></div><div class="caption"><span class="header">Figure 2.17: </span><span class="description">The inheritance hierarchy for the Users and Microposts controllers.
</span></div></div>
<p>As with model inheritance, by inheriting ultimately from <code>ActionController::Base</code> both the Users and Microposts controllers gain a large amount of functionality, such as the ability to manipulate model objects, filter inbound HTTP requests, and render views as HTML. Since all Rails controllers inherit from <code>ApplicationController</code>, rules defined in the Application controller automatically apply to every action in the application.<span class="intersentencespace"></span> For example, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a> we’ll see how to include helpers for signing in and signing out of all of the sample application’s controllers.</p>
</div>
<div id="_sec-deploying_the_demo_app" data-tralics-id="uid170" class="subsection" data-number="2.3.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying_the_demo_app" class="heading hyperref"><span class="number">2.3.5 </span>Deploying the demo app</a></h3>
<p>With the completion of the Microposts resource, now is a good time to push the repository up to GitHub:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Finish demo app"</span>
<span class="gp">$</span> git push
</pre></div></div>
<p>Ordinarily, you should make smaller, more frequent commits, but for the purposes of this chapter a single big commit at the end is fine.</p>
<p>At this point, you can also deploy the demo app to Heroku as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying" class="hyperref">Section&nbsp;<span class="ref">1.4</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku create
<span class="gp">$</span> git push heroku master
</pre></div></div>
<p>(As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_setup" class="hyperref">Section&nbsp;<span class="ref">1.4.1</span></a>, some readers have reported needing to precompile static assets (such as CSS and images), which can be included by hand as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">#</span> This should only be used <span class="k">if</span> your Heroku deploy fails without it.
<span class="gp">$</span> rake assets:precompile
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add precompiled assets for Heroku"</span>
<span class="gp">$</span> git push heroku master
</pre></div></div>
<p>This shouldn’t be necessary, and I have been unable to reproduce the issue, but the reports are common enough that I include it here for reference.)</p>
<p>To get the application’s database to work, you’ll also have to migrate the production database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run rake db:migrate
</pre></div></div>
<p>This updates the database at Heroku with the necessary user/micropost data model.</p>
</div></div>
<div id="_cid11" data-tralics-id="cid11" class="section" data-number="2.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid11" class="heading hyperref"><span class="number">2.4 </span>Conclusion</a></h2>
<p>We’ve come now to the end of the 30,000-foot view of a Rails application.<span class="intersentencespace"></span> The demo app developed in this chapter has several strengths and a host of weaknesses.</p>
<p><strong>Strengths</strong></p>
<ul>
<li>High-level overview of Rails
</li>
<li>Introduction to MVC
</li>
<li>First taste of the REST architecture
</li>
<li>Beginning data modeling
</li>
<li>A live, database-backed web application in production
</li></ul>
<p><strong>Weaknesses</strong></p>
<ul>
<li>No custom layout or styling
</li>
<li>No static pages (like “Home” or “About”)
</li>
<li>No user passwords
</li>
<li>No user images
</li>
<li>No signing in
</li>
<li>No security
</li>
<li>No automatic user/micropost association
</li>
<li>No notion of “following” or “followed”
</li>
<li>No micropost feed
</li>
<li>No test-driven development
</li>
<li><strong>No real understanding</strong>
</li></ul>
<p>The rest of this tutorial is dedicated to building on the strengths and eliminating the weaknesses.</p>
</div>
<div id="cha-2_footnotes">
  <ol class="footnotes">
    <li id="_cha-2_footnote-1">If you’ve changed the version of the Rails gem, which would likely happen only if you’re using Rails Installer, you should run <code>bundle update rails</code> at the command line as well.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-ref-1">↑</a></li>
    <li id="_cha-2_footnote-2">When modeling longer posts, such as those for a normal (non-micro) blog, you should use the <code>text</code> type in place of <code>string</code>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-ref-2">↑</a></li>
    <li id="_cha-2_footnote-3">The name of the scaffold follows the convention of <em>models</em>, which are singular, rather than resources and controllers, which are plural.<span class="intersentencespace"></span> Thus, we have <code>User</code> instead <code>Users</code>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-ref-3">↑</a></li>
    <li id="_cha-2_footnote-4">Some references indicate that the view returns the HTML directly to the browser (via a web server such as Apache or Nginx).<span class="intersentencespace"></span> Regardless of the implementation details, I prefer to think of the controller as a central hub through which all the application’s information flows.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-ref-4">↑</a></li>
    <li id="_cha-2_footnote-5">Fielding, Roy Thomas.<span class="intersentencespace"></span> <em>Architectural Styles and the Design of Network-based Software Architectures</em>.<span class="intersentencespace"></span> Doctoral dissertation, University of California, Irvine, 2000.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-ref-5">↑</a></li>
    <li id="_cha-2_footnote-6">As with the User scaffold, the scaffold generator for microposts follows the singular convention of Rails models; thus, we have <code>generate Micropost</code>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-ref-6">↑</a></li>
    <li id="_cha-2_footnote-7">The scaffold code may have extra newlines compared to <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_microposts_resource" class="hyperref">Listing&nbsp;<span class="ref">2.7</span></a>.<span class="intersentencespace"></span> This is not a cause for concern, as Ruby ignores extra newlines.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-ref-7">↑</a></li>
    <li id="_cha-2_footnote-8">Your console prompt might be something like <code>ruby-2.0.0-head &gt;</code>, but the examples use&nbsp;<span class="inline_verbatim">&gt;&gt;</span> since Ruby versions will vary.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-2_footnote-ref-8">↑</a></li>
  </ol>
</div><div id="_cha-static_pages" data-tralics-id="cid12" class="chapter" data-number="3"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="heading hyperref"><span class="number">Chapter 3 </span>Mostly static pages</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>In this chapter, we will begin developing the sample application that will serve as our example throughout the rest of this tutorial.<span class="intersentencespace"></span> Although the sample app will eventually have users, microposts, and a full login and authentication framework, we will begin with a seemingly limited topic: the creation of static pages.<span class="intersentencespace"></span> Despite its apparent simplicity, making static pages is a highly instructive exercise, rich in implications—a perfect start for our nascent application.</p>
<p>Although Rails is designed for making database-backed dynamic websites, it also excels at making the kind of static pages we might make with raw HTML files.<span class="intersentencespace"></span> In fact, using Rails even for static pages yields a distinct advantage: we can easily add just a <em>small</em> amount of dynamic content.<span class="intersentencespace"></span> In this chapter we’ll learn how.<span class="intersentencespace"></span> Along the way, we’ll get our first taste of <em>automated testing</em>, which will help us be more confident that our code is correct.<span class="intersentencespace"></span> Moreover, having a good test suite will allow us to <em>refactor</em> our code with confidence, changing its form without changing its function.</p>
<p>There’s a lot of code in this chapter, especially in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="hyperref">Section&nbsp;<span class="ref">3.2</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-slightly_dynamic_pages" class="hyperref">Section&nbsp;<span class="ref">3.3</span></a>, and if you’re new to Ruby you shouldn’t worry about understanding the details right now.<span class="intersentencespace"></span> As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-comments_for_various_readers" class="hyperref">Section&nbsp;<span class="ref">1.1.1</span></a>, one strategy is to copy-and-paste the tests and use them to verify the application code, without worrying at this point how they work.<span class="intersentencespace"></span> In addition, <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-rails_flavored_ruby" class="hyperref">Chapter&nbsp;<span class="ref">4</span></a> covers Ruby in more depth, so there is plenty of opportunity for these ideas to sink in.<span class="intersentencespace"></span> Finally, RSpec tests will recur throughout the tutorial, so if you get stuck now I recommend forging ahead; you’ll be amazed how, after just a few more chapters, initially inscrutable code will suddenly look simple.<span class="intersentencespace"></span> (You might also consider the <a href="http://mbsy.co/6VQ8l" target="_blank">RSpec course at Code School</a>, which one reader has said answered a lot of his RSpec questions.)</p>
<p>As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a>, before getting started we need to create a new Rails project, this time called <code>sample_app</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects
<span class="gp">$</span> rails new sample_app --skip-test-unit
<span class="gp">$</span> <span class="nb">cd </span>sample_app
</pre></div></div>
<p>Here the <span class="inline_verbatim">--skip-test-unit</span> option to the <code>rails</code> command tells Rails not to generate a <code>test</code> directory associated with the default <code>Test::Unit</code> framework.<span class="intersentencespace"></span> This is not because we won’t be writing tests; on the contrary, starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="hyperref">Section&nbsp;<span class="ref">3.2</span></a> we will be using an alternate testing framework called <em>RSpec</em> to write a thorough test suite.</p>
<p>As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-planning_the_application" class="hyperref">Section&nbsp;<span class="ref">2.1</span></a>, our next step is to use a text editor to update the <code>Gemfile</code> with the gems needed by our application.<span class="intersentencespace"></span> On the other hand, for the sample application we’ll also need two gems we didn’t need before: the gem for RSpec and the gem for the RSpec library specific to Rails.<span class="intersentencespace"></span> The code to include them is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_rspec" class="hyperref">Listing&nbsp;<span class="ref">3.1</span></a>.<span class="intersentencespace"></span> (<em>Note</em>: If you would like to install <em>all</em> the gems needed for the sample application, you should use the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-final_gemfile" class="hyperref">Listing&nbsp;<span class="ref">9.47</span></a> at this time.)</p>
<div class="codelisting" id="_code-gemfile_rspec" data-tralics-id="uid187" data-number="3.1"><div class="heading"><span class="number">Listing 3.1:</span> 

<span class="description">A <code>Gemfile</code> for the sample app.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span><span class="p">,</span> <span class="s1">'2.35.1'</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span><span class="p">,</span> <span class="s1">'2.1.0'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div></div><p>This includes <span class="tt">rspec-rails</span> in a development environment so that we have access to RSpec-specific generators, and it includes it in test mode in order to run the tests.<span class="intersentencespace"></span> We don’t have to install RSpec itself because it is a dependency of <span class="tt">rspec-rails</span> and will thus be installed automatically.<span class="intersentencespace"></span> We also include the <a href="https://github.com/jnicklas/capybara" target="_blank">Capybara gem</a>, which allows us to simulate a user’s interaction with the sample application using a natural English-like syntax, together with <a href="http://docs.seleniumhq.org/projects/webdriver/" target="_blank">Selenium</a>, one of Capybara’s dependencies.<sup id="_cha-3_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-1">1</a></sup><span class="intersentencespace"></span> As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a>, we also must include the PostgreSQL and static assets gems in production for deployment to Heroku:</p>
<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div>
<p>Heroku recommends against using different databases in development and production, but for the sample application it won’t make any difference, and SQLite is <em>much</em> easier than PostgreSQL to install and configure.<span class="intersentencespace"></span> Installing and configuring PostgreSQL on your local machine is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages_exercises" class="hyperref">Section&nbsp;<span class="ref">3.5</span></a>).</p>
<p>To install and include the new gems, we run <code>bundle install</code>.<span class="intersentencespace"></span> As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_setup" class="hyperref">Section&nbsp;<span class="ref">1.4.1</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a>, we suppress the installation of production gems using the option <span class="inline_verbatim">--without</span> <span class="inline_verbatim">production</span>:<sup id="_cha-3_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-2">2</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --without production
</pre></div></div>
<p>In case you’ve previously installed a version of a gem (such as Rails itself) other than the one specified by the <code>Gemfile</code>, it’s a good idea to <em>update</em> the gems with <code>bundle update</code> to make sure the versions match:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle update
</pre></div></div>
<p>Because the sample application is shared as a public repository, it’s important to update the so-called <em>secret token</em> used by Rails to protect session variables so that it is dynamically generated rather than hard-coded (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-secret_token" class="hyperref">Listing&nbsp;<span class="ref">3.2</span></a>).<span class="intersentencespace"></span> (The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-secret_token" class="hyperref">Listing&nbsp;<span class="ref">3.2</span></a> is fairly advanced for so early in the tutorial, but because it’s a potentially serious security issue I feel it’s important to include it even at this early stage.)<span class="intersentencespace"></span> Be sure to use the augmented <code>.gitignore</code> file from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.7</span></a> so that the <code>.secret</code> key isn’t exposed in your repository.</p>
<p><strong>Note: If your app is missing <code>secret_token.rb</code> and has <code>secrets.yml</code> instead, it probably means you installed Rails 4.1 by mistake.<span class="intersentencespace"></span> In this case, uninstall Rails using <code>gem uninstall rails</code> and then reinstall it by following the instructions in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-install_rails" class="hyperref">Section&nbsp;<span class="ref">1.2.2.5</span></a>.</strong></p>
<div class="codelisting" id="_code-secret_token" data-tralics-id="uid190" data-number="3.2"><div class="heading"><span class="number">Listing 3.2:</span> 

<span class="description">Dynamically generating a secret token.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/initializers/secret_token.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Be sure to restart your server when you modify this file.</span>

<span class="c1"># Your secret key is used for verifying the integrity of signed cookies.</span>
<span class="c1"># If you change this key, all old signed cookies will become invalid!</span>

<span class="c1"># Make sure the secret is at least 30 characters and all random,</span>
<span class="c1"># no regular words or you'll be exposed to dictionary attacks.</span>
<span class="c1"># You can use `rake secret` to generate a secure secret key.</span>

<span class="c1"># Make sure your secret_key_base is kept private</span>
<span class="c1"># if you're sharing your code publicly.</span>
<span class="nb">require</span> <span class="s1">'securerandom'</span>

<span class="k">def</span> <span class="nf">secure_token</span>
  <span class="n">token_file</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'.secret'</span><span class="p">)</span>
  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="n">token_file</span><span class="p">)</span>
    <span class="c1"># Use the existing token.</span>
    <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">token_file</span><span class="p">)</span><span class="o">.</span><span class="n">chomp</span>
  <span class="k">else</span>
    <span class="c1"># Generate a new token and store it in token_file.</span>
    <span class="n">token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">token_file</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">token</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">secret_key_base</span> <span class="o">=</span> <span class="n">secure_token</span>
</pre></div></div></div><p>Next, we need to configure Rails to use RSpec in place of <code>Test::Unit</code>.<span class="intersentencespace"></span> This can be accomplished with <code>rails generate rspec:install</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate rspec:install
</pre></div></div>
<p>If your system complains about the lack of a JavaScript runtime, visit the <a href="https://github.com/sstephenson/execjs" target="_blank">execjs page at GitHub</a> for a list of possibilities.<span class="intersentencespace"></span> I particularly recommend installing <a href="http://nodejs.org/" target="_blank">Node.js</a>.</p>
<p>With that, all we have left is to initialize the Git repository:<sup id="_cha-3_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-3">3</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Initial commit"</span>
</pre></div></div>
<p>As with the first application, I suggest updating the <code>README</code> file (located in the root directory of the application) to be more helpful and descriptive, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sample_app_readme" class="hyperref">Listing&nbsp;<span class="ref">3.3</span></a>.</p>
<div class="codelisting" id="_code-sample_app_readme" data-tralics-id="uid192" data-number="3.3"><div class="heading"><span class="number">Listing 3.3:</span> 

<span class="description">An improved <code>README</code> file for the sample app.</span>
</div>

<div class="code"><div class="highlight"><pre># Ruby on Rails Tutorial: sample application

This is the sample application for
the [*Ruby on Rails Tutorial*](http://railstutorial.org/)
by [Michael Hartl](http://michaelhartl.com/).
</pre></div></div></div><p>Then change it to use the Markdown extension&nbsp;<code>.md</code> and commit the changes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git mv README.rdoc README.md
<span class="gp">$</span> git commit -am <span class="s2">"Improve the README"</span>
</pre></div></div>
<p>You may recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_commands" class="hyperref">Section&nbsp;<span class="ref">1.3.5</span></a> that we used the Git command <code>git commit -a -m "Message"</code>, with flags for “all changes” (<code>-a</code>) and a message (<code>-m</code>).<span class="intersentencespace"></span> As shown in the second command above, Git also lets us roll the two flags into one using <code>git commit -am "Message"</code>.</p>
<p>Since we’ll be using this sample app throughout the rest of the book, it’s a good idea to <a href="https://github.com/new" target="_blank">make a new repository at GitHub</a> and push it up:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin https://github.com/&lt;username&gt;/sample_app.git
<span class="gp">$</span> git push -u origin master
</pre></div></div>
<p>As a result of my performing this step, you can find the <a href="https://github.com/railstutorial/sample_app_rails_4" target="_blank">Rails Tutorial sample application code on GitHub</a> (under the username <span class="tt">railstutorial</span> and the slightly different name <span class="tt">sample_app_rails_4</span>).<sup id="_cha-3_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-4">4</a></sup></p>
<p>Of course, we can optionally deploy the app to Heroku even at this early stage:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku create
<span class="gp">$</span> git push heroku master
<span class="gp">$</span> heroku run rake db:migrate
</pre></div></div>
<p>(As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_setup" class="hyperref">Section&nbsp;<span class="ref">1.4.1</span></a>, some readers have reported needing to precompile static assets (such as CSS and images), which can be included by hand as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">#</span> This should only be used <span class="k">if</span> your Heroku deploy fails without it.
<span class="gp">$</span> rake assets:precompile
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add precompiled assets for Heroku"</span>
<span class="gp">$</span> git push heroku master
</pre></div></div>
<p>This shouldn’t be necessary, and I have been unable to reproduce the issue, but the reports are common enough that I include it here for reference.)</p>
<p>As you proceed through the rest of the book, I recommend pushing and deploying the application regularly:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku run rake db:migrate
</pre></div></div>
<p>This provides remote backups and lets you catch any production errors as soon as possible.<span class="intersentencespace"></span> If you run into problems at Heroku, make sure to take a look at the production logs to try to diagnose the problem:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div></div>
<p>With all the preparation finished, we’re finally ready to get started developing the sample application.</p>
</div>
<div id="_sec-static_pages" data-tralics-id="cid13" class="section" data-number="3.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="heading hyperref"><span class="number">3.1 </span>Static pages</a></h2>
<p>In this section, we’ll take a first step toward making dynamic pages by creating a set of Rails <em>actions</em> and <em>views</em> containing (for now) only static HTML.<sup id="_cha-3_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-5">5</a></sup><span class="intersentencespace"></span> Rails actions come bundled together inside <em>controllers</em> (the C in MVC from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc" class="hyperref">Section&nbsp;<span class="ref">1.2.6</span></a>), which contain sets of actions related by a common purpose.<span class="intersentencespace"></span> We got a glimpse of controllers in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a>, and will come to a deeper understanding once we explore the <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer" target="_blank">REST architecture</a> more fully (starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>); in essence, a controller is a container for a group of (possibly dynamic) web pages.</p>
<p>In order to get our bearings, it’s helpful to recall the Rails directory structure from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_application" class="hyperref">Section&nbsp;<span class="ref">1.2.3</span></a> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-directory_structure_rails" class="hyperref">Figure&nbsp;<span class="ref">1.2</span></a>).<span class="intersentencespace"></span> In this section, we’ll be working mainly in the <code>app/controllers</code> and <code>app/views</code> directories.<span class="intersentencespace"></span> (In <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="hyperref">Section&nbsp;<span class="ref">3.2</span></a>, we’ll even add a new directory of our own.)<span class="intersentencespace"></span> I suggest opening the sample app in your text editor or IDE at this time (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-opening_the_project" class="hyperref">Box&nbsp;<span class="ref">3.1</span></a>).</p>
<div class="aside" id="_sidebar-opening_the_project" data-tralics-id="uid195" data-number="3.1"><div class="heading"><span class="number">Box 3.1.</span> 

<span class="description">Opening the project</span></div>
<p>It’s useful to be able to open the entire Rails project in your text editor or IDE. Unfortunately, how to do this is system-dependent, but in many cases you can open the current application directory, represented in Unix by a dot&nbsp;“<code>.</code>”, using the command-line command for your editor of choice:</p>
<pre>  $ cd ~/rails_projects/sample_app
  $ &lt;editor name&gt; .</pre>
<p>For example, to open the sample app in Sublime Text, you type
</p><pre>  $ subl .</pre>
<p>For Vim, you type
</p><pre>  $ vim .</pre>
<p>(where <code>vim</code> might be <code>gvim</code> or <code>mvim</code> depending on which flavor of Vim you use).<span class="intersentencespace"></span></p>

</div><p>To get started with static pages, recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_commands" class="hyperref">Section&nbsp;<span class="ref">1.3.5</span></a> that, when using Git, it’s a good practice to do our work on a separate topic branch rather than the master branch.<span class="intersentencespace"></span> If you’re using Git for version control, you should run the following command:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b static-pages
</pre></div></div>
<p>Rails comes with a script for making controllers called <code>generate</code>; all it needs to work its magic is the controller’s name.<span class="intersentencespace"></span> Since we’ll be making a controller to handle static pages, we’ll call it the StaticPages controller.<span class="intersentencespace"></span> We’ll also plan to make actions for a Home page, a Help page, and an About page.<span class="intersentencespace"></span> The <code>generate</code> script takes an optional list of actions, so we’ll include two of the initial actions directly on the command line (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generating_pages" class="hyperref">Listing&nbsp;<span class="ref">3.4</span></a>).</p>
<div class="codelisting" id="_code-generating_pages" data-tralics-id="uid196" data-number="3.4"><div class="heading"><span class="number">Listing 3.4:</span> 

<span class="description">Generating a StaticPages controller.</span>
</div>

<div class="code"><div class="highlight"><pre>$ rails generate controller StaticPages home help --no-test-framework
      create  app/controllers/static_pages_controller.rb
       route  get "static_pages/help"
       route  get "static_pages/home"
      invoke  erb
      create    app/views/static_pages
      create    app/views/static_pages/home.html.erb
      create    app/views/static_pages/help.html.erb
      invoke  helper
      create    app/helpers/static_pages_helper.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/static_pages.js.coffee
      invoke    scss
      create      app/assets/stylesheets/static_pages.css.scss
</pre></div></div></div><p>Here we’ve used the option <span class="inline_verbatim">--no-test-framework</span> to suppress the generation of the default RSpec tests, which we won’t be using.<span class="intersentencespace"></span> Instead, we’ll create the tests by hand starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="hyperref">Section&nbsp;<span class="ref">3.2</span></a>.<span class="intersentencespace"></span> We’ve also intentionally left off the <code>about</code> action from the command line arguments in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generating_pages" class="hyperref">Listing&nbsp;<span class="ref">3.4</span></a> so that we can see how to add it using test-driven development, or TDD (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="hyperref">Section&nbsp;<span class="ref">3.2</span></a>).</p>
<p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generating_pages" class="hyperref">Listing&nbsp;<span class="ref">3.4</span></a>, note that we have passed the controller name as so-called <a href="https://en.wikipedia.org/wiki/CamelCase" target="_blank">CamelCase</a>, which leads to the creation of a controller file written in <a href="https://en.wikipedia.org/wiki/Snake_case" target="_blank">snake case</a>, so that a controller called StaticPages yields a file called <code>static_pages_controller.rb</code>.<span class="intersentencespace"></span> This is merely a convention, and in fact using snake case at the command line also works: the command</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller static_pages ...
</pre></div></div>
<p>also generates a controller called <code>static_pages_controller.rb</code>.<span class="intersentencespace"></span> Because Ruby uses CamelCase for class names (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ruby_classes" class="hyperref">Section&nbsp;<span class="ref">4.4</span></a>), my preference is to refer to controllers using their CamelCase names, but this is a matter of taste.<span class="intersentencespace"></span> (Since Ruby filenames typically use snake case, the Rails generator converts CamelCase to snake case using the <a href="http://api.rubyonrails.org/classes/ActiveSupport/Inflector.html#method-i-underscore" target="_blank"><span class="tt">underscore</span></a> method.)</p>
<p>By the way, if you ever make a mistake when generating code, it’s useful to know how to reverse the process.<span class="intersentencespace"></span> See <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-undoing_things" class="hyperref">Box&nbsp;<span class="ref">3.2</span></a> for some techniques on how to undo things in Rails.</p>
<div class="aside" id="_sidebar-undoing_things" data-tralics-id="uid197" data-number="3.2"><div class="heading"><span class="number">Box 3.2.</span> 

<span class="description">Undoing things</span></div>
<p>Even when you’re very careful, things can sometimes go wrong when developing Rails applications.<span class="intersentencespace"></span> Happily, Rails has some facilities to help you recover.</p>
<p>One common scenario is wanting to undo code generation—for example, if you change your mind on the name of a controller.<span class="intersentencespace"></span> When generating a controller, Rails creates many more files than the controller file itself (as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generating_pages" class="hyperref">Listing&nbsp;<span class="ref">3.4</span></a>).<span class="intersentencespace"></span> Undoing the generation means removing not only the principal generated file, but all the ancillary files as well.<span class="intersentencespace"></span> (In fact, we also want to undo any automatic edits made to the <span class="tt">routes.rb</span> file.)<span class="intersentencespace"></span> In Rails, this can be accomplished with <span class="tt">rails destroy</span>.<span class="intersentencespace"></span> In particular, these two commands cancel each other out:</p>
<pre>  $ rails generate controller FooBars baz quux
  $ rails destroy  controller FooBars</pre>
<p>Similarly, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a> we’ll generate a <em>model</em> as follows:</p>
<pre>  $ rails generate model Foo bar:string baz:integer</pre>
<p>This can be undone using</p>
<pre>  $ rails destroy model Foo</pre>
<p>(In this case, it turns out we can omit the other command-line arguments.<span class="intersentencespace"></span> When you get to <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>, see if you can figure out why.)</p>
<p>Another technique related to models involves undoing <em>migrations</em>, which we saw briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a> and will see much more of starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>.<span class="intersentencespace"></span> Migrations change the state of the database using</p>
<pre>  $ rake db:migrate</pre>
<p>We can undo a single migration step using</p>
<pre>  $ rake db:rollback</pre>
<p>To go all the way back to the beginning, we can use</p>
<pre>  $ rake db:migrate VERSION=0</pre>
<p>As you might guess, substituting any other number for <span class="tt">0</span> migrates to that version number, where the version numbers come from listing the migrations sequentially.</p>
<p>With these techniques in hand, we are well-equipped to recover from the inevitable development <a href="http://en.wikipedia.org/wiki/SNAFU" target="_blank">snafus</a>.<span class="intersentencespace"></span></p>

</div><p>The StaticPages controller generation in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generating_pages" class="hyperref">Listing&nbsp;<span class="ref">3.4</span></a> automatically updates the <em>routes</em> file, called <code>config/routes.rb</code>, which Rails uses to find the correspondence between URLs and web pages.<span class="intersentencespace"></span> This is our first encounter with the <code>config</code> directory, so it’s helpful to take a quick look at it (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-config_directory_rails" class="hyperref">Figure&nbsp;<span class="ref">3.1</span></a>).<span class="intersentencespace"></span> The <code>config</code> directory is where Rails collects files needed for the application configuration (hence the name).</p>
<div class="center figure" id="_fig-config_directory_rails" data-tralics-id="uid198" data-number="3.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/config_directory_rails_4.png" alt="images/figures/config_directory_rails_4"></div><div class="caption"><span class="header">Figure 3.1: </span><span class="description">Contents of the sample app’s <code>config</code> directory.
</span></div></div>
<p>Since we generated <code>home</code> and <code>help</code> actions, the routes file already has a rule for each one, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_routes" class="hyperref">Listing&nbsp;<span class="ref">3.5</span></a>.</p>
<div class="codelisting" id="_code-pages_routes" data-tralics-id="uid199" data-number="3.5"><div class="heading"><span class="number">Listing 3.5:</span> 

<span class="description">The routes for the <code>home</code> and <code>help</code> actions in the StaticPages controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"static_pages/home"</span>
  <span class="n">get</span> <span class="s2">"static_pages/help"</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Here the rule</p>
<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">"static_pages/home"</span>
</pre></div></div>
<p>maps requests for the URL /static_pages/home to the <code>home</code> action in the StaticPages controller.<span class="intersentencespace"></span> Moreover, by using <code>get</code> we arrange for the route to respond to a <span class="tt">GET</span> request, which is one of the fundamental
<em>HTTP verbs</em> supported by the hypertext transfer protocol (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-get_etc" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>).<span class="intersentencespace"></span> In our case, this means that when we generate a <code>home</code> action inside the StaticPages controller we automatically get a page at the address /static_pages/home.<span class="intersentencespace"></span> To see the results, navigate to <a href="http://localhost:3000/static_pages/home" target="_blank">/static_pages/home</a> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-raw_home_view" class="hyperref">Figure&nbsp;<span class="ref">3.2</span></a>).</p>
<div class="center figure" id="_fig-raw_home_view" data-tralics-id="uid200" data-number="3.2">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/raw_home_view_31.png" alt="images/figures/raw_home_view_31"></div><div class="caption"><span class="header">Figure 3.2: </span><span class="description">The raw home view (<a href="http://localhost:3000/static_pages/home" target="_blank">/static_pages/home</a>).
</span></div></div>
<div class="aside" id="_sidebar-get_etc" data-tralics-id="uid201" data-number="3.3"><div class="heading"><span class="number">Box 3.3.</span> 

<span class="description"><span class="tt">GET</span>, et cet.</span></div>
<p>The hypertext transfer protocol (<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods" target="_blank">HTTP</a>) defines the basic operations <span class="tt">GET</span>, <span class="tt">POST</span>, <span class="tt">PATCH</span>, and <span class="tt">DELETE</span>.<span class="intersentencespace"></span> These refer to operations between a <em>client</em> computer (typically running a web browser such as Firefox or Safari) and a <em>server</em> (typically running a web server such as Apache or Nginx).<span class="intersentencespace"></span> (It’s important to understand that, when developing Rails applications on a local computer, the client and server are the same physical machine, but in general they are different.)<span class="intersentencespace"></span> An emphasis on HTTP verbs is typical of web frameworks (including Rails) influenced by the <em>REST architecture</em>, which we saw briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a> and will start learning about more in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>.</p>
<p><span class="tt">GET</span> is the most common HTTP operation, used for <em>reading</em> data on the web; it just means “get a page”, and every time you visit a site like google.com or wikipedia.org your browser is submitting a <span class="tt">GET</span> request.<span class="intersentencespace"></span> <span class="tt">POST</span> is the next most common operation; it is the request sent by your browser when you submit a form.<span class="intersentencespace"></span> In Rails applications, <span class="tt">POST</span> requests are typically used for <em>creating</em> things (although HTTP also allows <span class="tt">POST</span> to perform updates); for example, the <span class="tt">POST</span> request sent when you submit a registration form creates a new user on the remote site.<span class="intersentencespace"></span> The other two verbs, <span class="tt">PATCH</span> and <span class="tt">DELETE</span>, are designed for <em>updating</em> and <em>destroying</em> things on the remote server.<span class="intersentencespace"></span> These requests are less common than <span class="tt">GET</span> and <span class="tt">POST</span> since browsers are incapable of sending them natively, but some web frameworks (including Ruby on Rails) have clever ways of making it <em>seem</em> like browsers are issuing such requests.</p>
<p>By the way, previous versions of Rails used <span class="tt">PUT</span> in place of <span class="tt">PATCH</span>, and Rails&nbsp;4.0 still supports this usage, but <span class="tt">PATCH</span> <a href="http://weblog.rubyonrails.org/2012/2/25/edge-rails-patch-is-the-new-primary-http-method-for-updates/" target="_blank">matches the intended HTTP usage better</a> and is preferred for new applications.<span class="intersentencespace"></span></p>

</div><p>To understand where this page comes from, let’s start by taking a look at the StaticPages controller in a text editor; you should see something like <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_pages_controller" class="hyperref">Listing&nbsp;<span class="ref">3.6</span></a>.<span class="intersentencespace"></span> You may note that, unlike the demo Users and Microposts controllers from <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a>, the StaticPages controller does not use the standard REST actions.<span class="intersentencespace"></span> This is normal for a collection of static pages—the REST architecture isn’t the best solution to every problem.</p>
<div class="codelisting" id="_code-static_pages_controller" data-tralics-id="uid202" data-number="3.6"><div class="heading"><span class="number">Listing 3.6:</span> 

<span class="description">The StaticPages controller made by <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generating_pages" class="hyperref">Listing&nbsp;<span class="ref">3.4</span></a>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We see from the <code>class</code> keyword in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_pages_controller" class="hyperref">Listing&nbsp;<span class="ref">3.6</span></a> that <code>static_pages_controller.rb</code> defines a <em>class</em>, in this case called <code>StaticPagesController</code>.<span class="intersentencespace"></span> Classes are simply a convenient way to organize <em>functions</em> (also called <em>methods</em>) like the <code>home</code> and <code>help</code> actions, which are defined using the <code>def</code> keyword.<span class="intersentencespace"></span> The angle bracket&nbsp;<code>&lt;</code> indicates that <code>StaticPagesController</code> <em>inherits</em> from the Rails class <code>ApplicationController</code>; as we’ll see momentarily, this means that our pages come equipped with a large amount of Rails-specific functionality.<span class="intersentencespace"></span> (We’ll learn more about both classes and inheritance in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ruby_classes" class="hyperref">Section&nbsp;<span class="ref">4.4</span></a>.)</p>
<p>In the case of the StaticPages controller, both its methods are initially empty:</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">help</span>
<span class="k">end</span>
</pre></div></div>
<p>In plain Ruby, these methods would simply do nothing.<span class="intersentencespace"></span> In Rails, the situation is different—<code>StaticPagesController</code> is a Ruby class, but because it inherits from <code>ApplicationController</code> the behavior of its methods is specific to Rails: when visiting the URL /static_pages/home, Rails looks in the StaticPages controller and executes the code in the <code>home</code> action, and then renders the <em>view</em> (the V in MVC from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc" class="hyperref">Section&nbsp;<span class="ref">1.2.6</span></a>) corresponding to the action.<span class="intersentencespace"></span> In the present case, the <code>home</code> action is empty, so all visiting /static_pages/home does is render the view.<span class="intersentencespace"></span> So, what does a view look like, and how do we find it?</p>
<p>If you take another look at the output in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generating_pages" class="hyperref">Listing&nbsp;<span class="ref">3.4</span></a>, you might be able to guess the correspondence between actions and views: an action like <code>home</code> has a corresponding view called <code>home.html.erb</code>.<span class="intersentencespace"></span> We’ll learn in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-slightly_dynamic_pages" class="hyperref">Section&nbsp;<span class="ref">3.3</span></a> what the <code>.erb</code> part means; from the <code>.html</code> part you probably won’t be surprised that it basically looks like HTML (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-raw_home_view" class="hyperref">Listing&nbsp;<span class="ref">3.7</span></a>).</p>
<div class="codelisting" id="_code-raw_home_view" data-tralics-id="uid203" data-number="3.7"><div class="heading"><span class="number">Listing 3.7:</span> 

<span class="description">The generated view for the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>StaticPages#home<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/static_pages/home.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>The view for the <code>help</code> action is analogous (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-raw_help_view" class="hyperref">Listing&nbsp;<span class="ref">3.8</span></a>).</p>
<div class="codelisting" id="_code-raw_help_view" data-tralics-id="uid204" data-number="3.8"><div class="heading"><span class="number">Listing 3.8:</span> 

<span class="description">The generated view for the Help page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>StaticPages#help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/static_pages/help.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>Both of these views are just placeholders: they have a top-level heading (inside the <code>h1</code> tag) and a paragraph (<code>p</code> tag) with the full path to the relevant file.<span class="intersentencespace"></span> We’ll add some (very slightly) dynamic content starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-slightly_dynamic_pages" class="hyperref">Section&nbsp;<span class="ref">3.3</span></a>, but as they stand these views underscore an important point: Rails views can simply contain static HTML.</p>
<p>In the remainder of this chapter, we’ll add some custom content to the Home and Help pages, and then add in the About page we left off in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a>.<span class="intersentencespace"></span> Then we’ll add a very small amount of dynamic content by changing the title on a per-page basis.</p>
<p>Before moving on, if you’re using Git it’s a good idea to add the files for the StaticPages controller to the repository:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add a StaticPages controller"</span>
</pre></div></div>
</div>
<div id="_sec-first_tests" data-tralics-id="cid14" class="section" data-number="3.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="heading hyperref"><span class="number">3.2 </span>Our first tests</a></h2>
<p>The <em>Rails Tutorial</em> takes an intuitive approach to testing that emphasizes the behavior of the application rather than its precise implementation, a variant of test-driven development known as behavior-driven development (BDD).<span class="intersentencespace"></span> Our main tools will be <em>integration tests</em> (starting in this section) and <em>unit tests</em> (starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>).<span class="intersentencespace"></span> Integration tests, known as <em>request specs</em> in the context of RSpec, allow us to simulate the actions of a user interacting with our application using a web browser.<span class="intersentencespace"></span> Together with the natural-language syntax provided by Capybara, integration tests provide a powerful method to test our application’s functionality without having to manually check each page with a browser.<span class="intersentencespace"></span> (Another popular choice for BDD, called Cucumber, is introduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-cucumber" class="hyperref">Section&nbsp;<span class="ref">8.3</span></a>.)</p>
<p>The defining quality of TDD is writing tests <em>first</em>, before the application code.<span class="intersentencespace"></span> Initially, this might take some getting used to, but the benefits are significant.<span class="intersentencespace"></span> By writing a <em>failing</em> test first and then implementing the application code to get it to pass, we increase our confidence that the test is actually covering the functionality we think it is.<span class="intersentencespace"></span> Moreover, the fail-implement-pass development cycle induces a <a href="http://en.wikipedia.org/wiki/Flow_(psychology)" target="_blank">flow state</a>, leading to enjoyable coding and high productivity.<span class="intersentencespace"></span> Finally, the tests act as a <em>client</em> for the application code, often leading to more elegant software designs.</p>
<p>It’s important to understand that TDD is not always the right tool for the job: there’s no reason to dogmatically insist that tests always should be written first, that they should cover every single feature, or that there should necessarily be any tests at all.<span class="intersentencespace"></span> For example, when you aren’t at all sure how to solve a given programming problem, it’s often useful to skip the tests and write only application code, just to get a sense of what the solution will look like.<span class="intersentencespace"></span> (In the language of <a href="http://en.wikipedia.org/wiki/Extreme_Programming" target="_blank">Extreme Programming (XP)</a>, this exploratory step is called a <em>spike</em>.)<span class="intersentencespace"></span> Once you see the general shape of the solution, you can then use TDD to implement a more polished version.</p>
<p>In this section, we’ll be running the tests using the <code>rspec</code> command supplied by the RSpec gem.<span class="intersentencespace"></span> This practice is straightforward but not ideal, and if you are a more advanced user I suggest setting up your system as described in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-advanced_setup" class="hyperref">Section&nbsp;<span class="ref">3.6</span></a>.</p>
<div id="_sec-TDD" data-tralics-id="uid205" class="subsection" data-number="3.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-TDD" class="heading hyperref"><span class="number">3.2.1 </span>Test-driven development</a></h3>
<p>In test-driven development, we first write a <em>failing</em> test, represented in many testing tools by the color red.<span class="intersentencespace"></span> We then implement code to get the test to pass, represented by the color green.<span class="intersentencespace"></span> Finally, if necessary, we refactor the code, changing its form (by eliminating duplication, for example) without changing its function.<span class="intersentencespace"></span> This cycle is known as “Red, Green, Refactor”.</p>
<p>We’ll begin by adding some content to the Home page using test-driven development, including a top-level heading (<code>&lt;h1&gt;</code>) with the content <code>Sample App</code>.<span class="intersentencespace"></span> The first step is to generate an integration test (request spec) for our static pages:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test static_pages
<span class="go">      invoke  rspec</span>
<span class="go">      create    spec/requests/static_pages_spec.rb</span>
</pre></div></div>
<p>This creates the <code>static_pages_spec.rb</code> in the <code>spec/requests</code> directory.<span class="intersentencespace"></span> As with most generated code, the result is not pretty, so let’s open <code>static_pages_spec.rb</code> with a text editor and replace it with the contents of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_content_spec" class="hyperref">Listing&nbsp;<span class="ref">3.9</span></a>.</p>
<div class="codelisting" id="_code-home_page_content_spec" data-tralics-id="uid206" data-number="3.9"><div class="heading"><span class="number">Listing 3.9:</span> 

<span class="description">Code to test the contents of the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_content_spec" class="hyperref">Listing&nbsp;<span class="ref">3.9</span></a> is pure Ruby, but even if you’ve studied Ruby before it might not look familiar.<span class="intersentencespace"></span> This is because RSpec uses the general malleability of Ruby to define a <em>domain-specific language</em> (DSL) built just for testing.<span class="intersentencespace"></span> The important point is that <em>you do not need to understand RSpec’s syntax to be able to use RSpec</em>.<span class="intersentencespace"></span> It may seem like magic at first, but RSpec and Capybara are designed to read more or less like English, and if you follow the examples in this tutorial you’ll pick it up fairly quickly.</p>
<p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_content_spec" class="hyperref">Listing&nbsp;<span class="ref">3.9</span></a> contains a <code>describe</code> block with one <em>example</em>, i.e., a block starting with <code>it "…" do</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>The first line indicates that we are describing the Home page.<span class="intersentencespace"></span> This description is just a string, and it can be anything you want; RSpec doesn’t care, but you and other human readers probably do.<span class="intersentencespace"></span> Then the spec says that when you visit the Home page at <code>/static_pages/home</code>, the content should contain the words “Sample App”.<span class="intersentencespace"></span> As with the first line, what goes inside the quote marks is irrelevant to RSpec, and is intended to be descriptive to human readers.<span class="intersentencespace"></span> Then the line</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
</pre></div></div>
<p>uses the Capybara function <code>visit</code> to simulate visiting the URL <code>/static_pages/home</code> in a browser, while the line</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
</pre></div></div>
<p>uses the <code>page</code> variable (also provided by Capybara) to express the expectation that the resulting page should have the right content.</p>
<p>To get the test to run properly, we have to add a line to the <code>spec_helper.rb</code> file, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-capybara_dsl" class="hyperref">Listing&nbsp;<span class="ref">3.10</span></a>.</p>
<div class="codelisting" id="_code-capybara_dsl" data-tralics-id="uid207" data-number="3.10"><div class="heading"><span class="number">Listing 3.10:</span> 

<span class="description">Adding the Capybara DSL to the RSpec helper file.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/spec_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># This file is copied to spec/ when you run 'rails generate rspec:install'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">DSL</span>
<span class="k">end</span>
</pre></div></div></div><p>To actually run the test, we have several options, including some convenient but rather advanced tools discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-advanced_setup" class="hyperref">Section&nbsp;<span class="ref">3.6</span></a>.<span class="intersentencespace"></span> For now, we’ll use the <code>rspec</code> command at the command line (executed with <code>bundle exec</code> to ensure that RSpec runs in the environment specified by our <code>Gemfile</code>):<sup id="_cha-3_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-6">6</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>This yields a failing test.<span class="intersentencespace"></span> The appearance of the result depends on your system; on my system, the red failing test appears as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-red_failing_spec" class="hyperref">Figure&nbsp;<span class="ref">3.3</span></a>.<sup id="_cha-3_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-7">7</a></sup></p>
<div class="center figure" id="_fig-red_failing_spec" data-tralics-id="uid210" data-number="3.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/red_failing_spec_4_0.png" alt="images/figures/red_failing_spec_4_0"></div><div class="caption"><span class="header">Figure 3.3: </span><span class="description">A red (failing) test.
</span></div></div>
<p>To get the test to pass, we’ll replace the default Home page test with the HTML in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_passing" class="hyperref">Listing&nbsp;<span class="ref">3.11</span></a>.</p>
<div class="codelisting" id="_code-home_page_passing" data-tralics-id="uid211" data-number="3.11"><div class="heading"><span class="number">Listing 3.11:</span> 

<span class="description">Code to get a passing test for the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>This arranges for a top-level heading (<code>&lt;h1&gt;</code>) with the content <code>Sample App</code>, which should get the test to pass.<span class="intersentencespace"></span> We also include an <em>anchor</em> tag&nbsp;<code>a</code>, which creates links to the given URL (called an “href”, or “hypertext reference”, in the context of an anchor tag):</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
</pre></div></div>
<p>Now re-run the test to see the effect:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>On my system, the passing test appears as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-green_passing_spec" class="hyperref">Figure&nbsp;<span class="ref">3.4</span></a>.</p>
<div class="center figure" id="_fig-green_passing_spec" data-tralics-id="uid212" data-number="3.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/green_passing_spec_4_0.png" alt="images/figures/green_passing_spec_4_0"></div><div class="caption"><span class="header">Figure 3.4: </span><span class="description">A green (passing) test.
</span></div></div>
<p>Based on the example for the Home page, you can probably guess the analogous test and application code for the Help page.<span class="intersentencespace"></span> We start by testing for the relevant content, in this case the string <code>’Help’</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-help_content_spec" class="hyperref">Listing&nbsp;<span class="ref">3.12</span></a>).</p>
<div class="codelisting" id="_code-help_content_spec" data-tralics-id="uid213" data-number="3.12"><div class="heading"><span class="number">Listing 3.12:</span> 

<span class="description">Adding code to test the contents of the Help page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Help page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Help'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/help'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Help'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Then run the tests:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>One test should fail.<span class="intersentencespace"></span> (Since systems will vary, and since keeping track of how many tests there are at each stage of the tutorial is a maintenance nightmare, I’ll omit the RSpec output from now on.)</p>
<p>The application code is similar to the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_passing" class="hyperref">Listing&nbsp;<span class="ref">3.11</span></a>, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-help_page_passing" class="hyperref">Listing&nbsp;<span class="ref">3.13</span></a>.</p>
<div class="codelisting" id="_code-help_page_passing" data-tralics-id="uid214" data-number="3.13"><div class="heading"><span class="number">Listing 3.13:</span> 

<span class="description">Code to get a passing test for the Help page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on the Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/help"</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/book"</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>The tests should now pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
</div>
<div id="_sec-adding_a_page" data-tralics-id="uid215" class="subsection" data-number="3.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_page" class="heading hyperref"><span class="number">3.2.2 </span>Adding a page</a></h3>
<p>Having seen test-driven development in action in a simple example, we’ll use the same technique to accomplish the slightly more complicated task of adding a new page, namely, the About page that we intentionally left off in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a>.<span class="intersentencespace"></span> By writing a test and running RSpec at each step, we’ll see how TDD can guide us through the development of our application code.</p>
<div id="_sec-red" data-tralics-id="uid216" class="subsubsection" data-number="3.2.2.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-red" class="heading">Red</a></h4>
<p>We’ll get to the Red part of the Red-Green cycle by writing a failing test for the About page.<span class="intersentencespace"></span> Following the models from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-help_content_spec" class="hyperref">Listing&nbsp;<span class="ref">3.12</span></a>, you can probably guess the right test (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_page_content_spec" class="hyperref">Listing&nbsp;<span class="ref">3.14</span></a>).</p>
<div class="codelisting" id="_code-about_page_content_spec" data-tralics-id="uid217" data-number="3.14"><div class="heading"><span class="number">Listing 3.14:</span> 

<span class="description">Adding code to test the contents of the About page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Help page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Help'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/help'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Help'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/about'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-green" data-tralics-id="uid218" class="subsubsection" data-number="3.2.2.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-green" class="heading">Green</a></h4>
<p>Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a> that we can generate a static page in Rails by creating an action and corresponding view with the page’s name.<span class="intersentencespace"></span> In our case, the About page will first need an action called <code>about</code> in the StaticPages controller.<span class="intersentencespace"></span> Having written a failing test, we can now be confident that, in getting it to pass, we will actually have created a working About page.</p>
<p>If you run the RSpec example using</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>the output includes the following complaint:</p>
<div class="code"><div class="highlight"><pre>No route matches [GET] "/static_pages/about"
</pre></div></div>
<p>This is a hint that we need to add <code>/static_pages/about</code> to the routes file, which we can accomplish by following the pattern in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_routes" class="hyperref">Listing&nbsp;<span class="ref">3.5</span></a>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_route" class="hyperref">Listing&nbsp;<span class="ref">3.15</span></a>.</p>
<div class="codelisting" id="_code-about_route" data-tralics-id="uid219" data-number="3.15"><div class="heading"><span class="number">Listing 3.15:</span> 

<span class="description">Adding the <code>about</code> route.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"static_pages/home"</span>
  <span class="n">get</span> <span class="s2">"static_pages/help"</span>
  <span class="n">get</span> <span class="s2">"static_pages/about"</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Now running</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>complains that</p>
<div class="code"><div class="highlight"><pre>The action 'about' could not be found for StaticPagesController
</pre></div></div>
<p>To solve this problem, we follow the model provided by <code>home</code> and <code>help</code> from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_pages_controller" class="hyperref">Listing&nbsp;<span class="ref">3.6</span></a> by adding an <code>about</code> action in the StaticPages controller (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-adding_the_about_page" class="hyperref">Listing&nbsp;<span class="ref">3.16</span></a>).</p>
<div class="codelisting" id="_code-adding_the_about_page" data-tralics-id="uid220" data-number="3.16"><div class="heading"><span class="number">Listing 3.16:</span> 

<span class="description">The StaticPages controller with added <code>about</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Now running</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>says that we are missing a “template”, i.e., a view:</p>
<div class="code"><div class="highlight"><pre>Missing template static_pages/about
</pre></div></div>
<p>To solve this issue, we add the <code>about</code> view.<span class="intersentencespace"></span> This involves creating a new file called <code>about.html.erb</code> in the <code>app/views/static_pages</code> directory with the contents shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_view" class="hyperref">Listing&nbsp;<span class="ref">3.17</span></a>.</p>
<div class="codelisting" id="_code-about_view" data-tralics-id="uid221" data-number="3.17"><div class="heading"><span class="number">Listing 3.17:</span> 

<span class="description">Code for the About page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/about.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  is a project to make a book and screencasts to teach web development
  with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://rubyonrails.org/"</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
  is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>Running RSpec should now get us back to Green:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>Of course, it’s never a bad idea to take a look at the page in a browser to make sure our tests aren’t completely crazy (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-about_us" class="hyperref">Figure&nbsp;<span class="ref">3.5</span></a>).</p>
<div class="center figure" id="_fig-about_us" data-tralics-id="uid222" data-number="3.5">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/about_us_2nd_edition.png" alt="images/figures/about_us_2nd_edition"></div><div class="caption"><span class="header">Figure 3.5: </span><span class="description">The new About page (<a href="http://localhost:3000/static_pages/about" target="_blank">/static_pages/about</a>).
</span></div></div>
</div>
<div id="_sec-refactor" data-tralics-id="uid223" class="subsubsection" data-number="3.2.2.3"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-refactor" class="heading">Refactor</a></h4>
<p>Now that we’ve gotten to Green, we are free to refactor our code with confidence.<span class="intersentencespace"></span> Oftentimes code will start to “smell”, meaning that it gets ugly, bloated, or filled with repetition.<span class="intersentencespace"></span> The computer doesn’t care, of course, but humans do, so it is important to keep the code base clean by refactoring frequently.<span class="intersentencespace"></span> Having a good test suite is an invaluable tool in this regard, as it dramatically lowers the probability of introducing bugs while refactoring.</p>
<p>Our sample app is a little too small to refactor right now, but code smell seeps in at every crack, and we won’t have to wait long: we’ll already get busy refactoring in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layouts" class="hyperref">Section&nbsp;<span class="ref">3.3.4</span></a>.</p>
</div></div></div>
<div id="_sec-slightly_dynamic_pages" data-tralics-id="cid15" class="section" data-number="3.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-slightly_dynamic_pages" class="heading hyperref"><span class="number">3.3 </span>Slightly dynamic pages</a></h2>
<p>Now that we’ve created the actions and views for some static pages, we’ll make them <em>very slightly</em> dynamic by adding some content that changes on a per-page basis: we’ll have the title of each page change to reflect its content.<span class="intersentencespace"></span> Whether a changing title represents <em>truly</em> dynamic content is debatable, but in any case it lays the necessary foundation for unambiguously dynamic content in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>.</p>
<p>If you skipped the TDD material in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="hyperref">Section&nbsp;<span class="ref">3.2</span></a>, be sure to create an About page at this point using the code from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_route" class="hyperref">Listing&nbsp;<span class="ref">3.15</span></a>, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-adding_the_about_page" class="hyperref">Listing&nbsp;<span class="ref">3.16</span></a>, and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_view" class="hyperref">Listing&nbsp;<span class="ref">3.17</span></a>.</p>
<div id="_sec-testing_a_title_change" data-tralics-id="uid224" class="subsection" data-number="3.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-testing_a_title_change" class="heading hyperref"><span class="number">3.3.1 </span>Testing a title change</a></h3>
<p>Our plan is to edit the Home, Help, and About pages to make page titles that change on each page.<span class="intersentencespace"></span> This will involve using the <code>&lt;title&gt;</code> tag in our page views.<span class="intersentencespace"></span> Most browsers display the contents of the title tag at the top of the browser window (Google Chrome is an odd exception), and it is also important for search-engine optimization.<span class="intersentencespace"></span> We’ll start by writing tests for the titles, then add the titles themselves, and finally use a <em>layout</em> file to refactor the resulting pages and eliminate duplication.</p>
<p>You may have noticed that the <code>rails new</code> command already created a layout file.<span class="intersentencespace"></span> We’ll learn its purpose shortly, but for now you should rename it before proceeding:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> mv app/views/layouts/application.html.erb foobar   <span class="c"># temporary change</span>
</pre></div></div>
<p>(<code>mv</code> is a Unix command; on Windows you may need to rename the file using the file browser or the <code>rename</code> command.)<span class="intersentencespace"></span> You wouldn’t normally do this in a real application, but it’s easier to understand the purpose of the layout file if we start by disabling it.</p>
<div class="table" id="_table-static_pages" data-tralics-id="uid225" data-number="3.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_center"><strong>Page</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Base title</strong></td>
<td class="align_left"><strong>Variable title</strong></td>
</tr><tr><td class="align_center">Home</td>
<td class="align_left">/static_pages/home</td>
<td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td>
<td class="align_left"><code>"Home"</code></td>
</tr><tr><td class="align_center">Help</td>
<td class="align_left">/static_pages/help</td>
<td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td>
<td class="align_left"><code>"Help"</code></td>
</tr><tr><td class="align_center">About</td>
<td class="align_left">/static_pages/about</td>
<td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td>
<td class="align_left"><code>"About"</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 3.1: </span><span class="description">The (mostly) static pages for the sample app.
</span></div></div>
<p>By the end of this section, all three of our static pages will have titles of the form “Ruby on Rails Tutorial Sample App | Home”, where the last part of the title will vary depending on the page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-static_pages" class="hyperref">Table&nbsp;<span class="ref">3.1</span></a>).<span class="intersentencespace"></span> We’ll build on the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_page_content_spec" class="hyperref">Listing&nbsp;<span class="ref">3.14</span></a>, adding title tests following the model in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-title_test" class="hyperref">Listing&nbsp;<span class="ref">3.18</span></a>.</p>
<div class="codelisting" id="_code-title_test" data-tralics-id="uid226" data-number="3.18"><div class="heading"><span class="number">Listing 3.18:</span> 

<span class="description">A title test.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">"should have the right title"</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | Home"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div><p>This uses the <code>have_title</code> method, which checks for an HTML title with the given content.<span class="intersentencespace"></span> In other words, the code</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | Home"</span><span class="p">)</span>
</pre></div></div>
<p>checks to see that the content inside the <code>title</code> tag is</p>
<div class="code"><div class="highlight"><pre><span class="s2">"Ruby on Rails Tutorial Sample App | Home"</span>
</pre></div></div>
<p>It’s worth mentioning that the content need not be an exact match; any substring works as well, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Home"</span><span class="p">)</span>
</pre></div></div>
<p>will also match the full title.</p>
<p>Adding new tests for each of our three static pages, following the model of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-title_test" class="hyperref">Listing&nbsp;<span class="ref">3.18</span></a>, gives us our new StaticPages test (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_title" class="hyperref">Listing&nbsp;<span class="ref">3.19</span></a>).<span class="intersentencespace"></span> Note that there is considerable repetition here, which we will eliminate in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pretty_rspec" class="hyperref">Section&nbsp;<span class="ref">5.3.4</span></a>.</p>
<div class="codelisting" id="_code-pages_controller_spec_title" data-tralics-id="uid227" data-number="3.19"><div class="heading"><span class="number">Listing 3.19:</span> 

<span class="description">The StaticPages controller spec with title tests.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'Home'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | Home"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Help page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Help'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/help'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Help'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'Help'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/help'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | Help"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/about'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/about'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | About Us"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the tests from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_title" class="hyperref">Listing&nbsp;<span class="ref">3.19</span></a> in place, you should run</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>to verify that our code is now Red (failing tests).</p>
</div>
<div id="_sec-passing_title_tests" data-tralics-id="uid228" class="subsection" data-number="3.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-passing_title_tests" class="heading hyperref"><span class="number">3.3.2 </span>Passing title tests</a></h3>
<p>Now we’ll get our title tests to pass, and at the same time add the full HTML structure needed to make valid web pages.<span class="intersentencespace"></span> The markup for a modern web page follows this form:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Greeting<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>Hello, world!<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
<p>This structure includes a <em>document type</em>, or doctype, declaration at the top to tell browsers which version of HTML we’re using (in this case, <a href="http://en.wikipedia.org/wiki/HTML5" target="_blank">HTML5</a>);<sup id="_cha-3_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-8">8</a></sup> a <code>head</code> section, in this case with “Greeting” inside a <code>title</code> tag; and a <code>body</code> section, in this case with “Hello, world!”<span class="intersentencespace"></span> inside a <code>p</code> (paragraph) tag.<span class="intersentencespace"></span> (The indentation is optional—HTML is not sensitive to whitespace, and ignores both tabs and spaces—but it makes the document’s structure easier to see.)</p>
<p>Applying this basic structure to the Home page yields <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_view_full_html" class="hyperref">Listing&nbsp;<span class="ref">3.20</span></a>.</p>
<div class="codelisting" id="_code-home_view_full_html" data-tralics-id="uid230" data-number="3.20"><div class="heading"><span class="number">Listing 3.20:</span> 

<span class="description">The view for the Home page with full HTML structure.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Home<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_view_full_html" class="hyperref">Listing&nbsp;<span class="ref">3.20</span></a> uses the title tested for in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_title" class="hyperref">Listing&nbsp;<span class="ref">3.19</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Home<span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p>As a result, the tests for the Home page should now pass.<span class="intersentencespace"></span> We’re still Red because of the failing Help and About tests, and we can get to Green with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-help_view_full_html" class="hyperref">Listing&nbsp;<span class="ref">3.21</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_view_full_html" class="hyperref">Listing&nbsp;<span class="ref">3.22</span></a>.</p>
<div class="codelisting" id="_code-help_view_full_html" data-tralics-id="uid231" data-number="3.21"><div class="heading"><span class="number">Listing 3.21:</span> 

<span class="description">The view for the Help page with full HTML structure.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Help<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Get help on the Ruby on Rails Tutorial at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/help"</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
      To get help on this sample app, see the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/book"</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-about_view_full_html" data-tralics-id="uid232" data-number="3.22"><div class="heading"><span class="number">Listing 3.22:</span> 

<span class="description">The view for the About page with full HTML structure.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/about.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | About Us<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      is a project to make a book and screencasts to teach web development
      with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://rubyonrails.org/"</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
      is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div></div>
<div id="_sec-embedded_ruby" data-tralics-id="uid233" class="subsection" data-number="3.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-embedded_ruby" class="heading hyperref"><span class="number">3.3.3 </span>Embedded Ruby</a></h3>
<p>We’ve achieved a lot already in this section, generating three valid pages using Rails controllers and actions, but they are purely static HTML and hence don’t show off the power of Rails.<span class="intersentencespace"></span> Moreover, they suffer from terrible duplication:</p>
<ul>
<li>The page titles are almost (but not quite) exactly the same.<span class="intersentencespace"></span>
</li>
<li>“Ruby on Rails Tutorial Sample App” is common to all three titles.<span class="intersentencespace"></span>
</li>
<li>The entire HTML skeleton structure is repeated on each page.<span class="intersentencespace"></span>
</li></ul>
<p>This repeated code is a violation of the important “Don’t Repeat Yourself” (DRY) principle; in this section and the next we’ll “DRY out our code” by removing the repetition.</p>
<p>Paradoxically, we’ll take the first step toward eliminating duplication by first adding some more: we’ll make the titles of the pages, which are currently quite similar, match <em>exactly</em>.<span class="intersentencespace"></span> This will make it much simpler to remove all the repetition at a stroke.</p>
<p>The technique involves using <em>Embedded Ruby</em> in our views.<span class="intersentencespace"></span> Since the Home, Help, and About page titles have a variable component, we’ll use a special Rails function called <code>provide</code> to set a different title on each page.<span class="intersentencespace"></span> We can see how this works by replacing the literal title “Home” in the <code>home.html.erb</code> view with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_view_erb_title" class="hyperref">Listing&nbsp;<span class="ref">3.23</span></a>.</p>
<div class="codelisting" id="_code-home_view_erb_title" data-tralics-id="uid237" data-number="3.23"><div class="heading"><span class="number">Listing 3.23:</span> 

<span class="description">The view for the Home page with an Embedded Ruby title.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Home'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_view_erb_title" class="hyperref">Listing&nbsp;<span class="ref">3.23</span></a> is our first example of Embedded Ruby, also called <em>ERb</em>.<span class="intersentencespace"></span> (Now you know why HTML views have the file extension <code>.html.erb</code>.)<span class="intersentencespace"></span> ERb is the primary template system for including dynamic content in web pages.<sup id="_cha-3_footnote-ref-9" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-9">9</a></sup><span class="intersentencespace"></span> The code</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Home'</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>indicates using <span class="inline_verbatim">&lt;% ... %&gt;</span> that Rails should call the <code>provide</code> function and associate the string <code>’Home’</code> with the label <code>:title</code>.<sup id="_cha-3_footnote-ref-10" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-10">10</a></sup><span class="intersentencespace"></span> Then, in the title, we use the closely related notation <span class="inline_verbatim">&lt;%= ... %&gt;</span> to insert the title into the template using Ruby’s <code>yield</code> function:<sup id="_cha-3_footnote-ref-11" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-11">11</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p>(The distinction between the two types of embedded Ruby is that <span class="inline_verbatim">&lt;% ... %&gt;</span> <em>executes</em> the code inside, while <span class="inline_verbatim">&lt;%= ... %&gt;</span> executes it and <em>inserts</em> the result into the template.)<span class="intersentencespace"></span> The resulting page is exactly the same as before, only now the variable part of the title is generated dynamically by ERb.</p>
<p>We can verify that all this works by running the tests from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-testing_a_title_change" class="hyperref">Section&nbsp;<span class="ref">3.3.1</span></a> and see that they still pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>Then we can make the corresponding replacements for the Help and About pages (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-help_view_erb_title" class="hyperref">Listing&nbsp;<span class="ref">3.24</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_view_erb_title" class="hyperref">Listing&nbsp;<span class="ref">3.25</span></a>).</p>
<div class="codelisting" id="_code-help_view_erb_title" data-tralics-id="uid241" data-number="3.24"><div class="heading"><span class="number">Listing 3.24:</span> 

<span class="description">The view for the Help page with an Embedded Ruby title.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Help'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Get help on the Ruby on Rails Tutorial at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/help"</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
      To get help on this sample app, see the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/book"</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-about_view_erb_title" data-tralics-id="uid242" data-number="3.25"><div class="heading"><span class="number">Listing 3.25:</span> 

<span class="description">The view for the About page with an Embedded Ruby title.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/about.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'About Us'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      is a project to make a book and screencasts to teach web development
      with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://rubyonrails.org/"</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
      is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div></div>
<div id="_sec-layouts" data-tralics-id="uid243" class="subsection" data-number="3.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layouts" class="heading hyperref"><span class="number">3.3.4 </span>Eliminating duplication with layouts</a></h3>
<p>Now that we’ve replaced the variable part of the page titles with ERb, each of our pages looks something like this:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Foo'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
      Contents
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div>
<p>In other words, <em>all</em> our pages are identical in structure, including the contents of the title tag, with the sole exception of the material inside the <code>body</code> tag.</p>
<p>In order to factor out this common structure, Rails comes with a special <em>layout</em> file called <code>application.html.erb</code>, which we renamed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-testing_a_title_change" class="hyperref">Section&nbsp;<span class="ref">3.3.1</span></a> and which we’ll now restore:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> mv foobar app/views/layouts/application.html.erb
</pre></div></div>
<p>To get the layout to work, we have to replace the default title with the Embedded Ruby from the examples above:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p>The resulting layout appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout" class="hyperref">Listing&nbsp;<span class="ref">3.26</span></a>.</p>
<div class="codelisting" id="_code-application_layout" data-tralics-id="uid244" data-number="3.26"><div class="heading"><span class="number">Listing 3.26:</span> 

<span class="description">The sample application site layout.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                            <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p>Note here the special line</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This code is responsible for inserting the contents of each page into the layout.<span class="intersentencespace"></span> It’s not important to know exactly how this works; what matters is that using this layout ensures that, for example, visiting the page /static_pages/home converts the contents of <code>home.html.erb</code> to HTML and then inserts it in place of <span class="inline_verbatim">&lt;%= yield %&gt;</span>.</p>
<p>It’s also worth noting that the default Rails layout includes several additional lines:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This code arranges to include the application stylesheet and JavaScript, which are part of the asset pipeline (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_asset_pipeline" class="hyperref">Section&nbsp;<span class="ref">5.2.1</span></a>), together with the Rails method <code>csrf_meta_tags</code>, which prevents <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_blank">cross-site request forgery</a> (CSRF), a type of malicious web attack.</p>
<p>Of course, the views in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_view_erb_title" class="hyperref">Listing&nbsp;<span class="ref">3.23</span></a>, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-help_view_erb_title" class="hyperref">Listing&nbsp;<span class="ref">3.24</span></a>, and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_view_erb_title" class="hyperref">Listing&nbsp;<span class="ref">3.25</span></a> are still filled with all the HTML structure included in the layout, so we have to remove it, leaving only the interior contents.<span class="intersentencespace"></span> The resulting cleaned-up views appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_view_interior" class="hyperref">Listing&nbsp;<span class="ref">3.27</span></a>, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-help_view_interior" class="hyperref">Listing&nbsp;<span class="ref">3.28</span></a>, and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-about_view_interior" class="hyperref">Listing&nbsp;<span class="ref">3.29</span></a>.</p>
<div class="codelisting" id="_code-home_view_interior" data-tralics-id="uid245" data-number="3.27"><div class="heading"><span class="number">Listing 3.27:</span> 

<span class="description">The Home page with HTML structure removed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Home'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-help_view_interior" data-tralics-id="uid246" data-number="3.28"><div class="heading"><span class="number">Listing 3.28:</span> 

<span class="description">The Help page with HTML structure removed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/help.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Help'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on the Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/help"</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/book"</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-about_view_interior" data-tralics-id="uid247" data-number="3.29"><div class="heading"><span class="number">Listing 3.29:</span> 

<span class="description">The About page with HTML structure removed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/about.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'About Us'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  is a project to make a book and screencasts to teach web development
  with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://rubyonrails.org/"</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
  is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>With these views defined, the Home, Help, and About pages are the same as before, but they have much less duplication.<span class="intersentencespace"></span> Verifying that the test suite still passes gives us confidence that this code refactoring was successful:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
</div></div>
<div id="_sec-static_pages_conclusion" data-tralics-id="cid16" class="section" data-number="3.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages_conclusion" class="heading hyperref"><span class="number">3.4 </span>Conclusion</a></h2>
<p>Seen from the outside, this chapter hardly accomplished anything: we started with static pages, and ended with…<em>mostly</em> static pages.<span class="intersentencespace"></span> But appearances are deceiving: by developing in terms of Rails controllers, actions, and views, we are now in a position to add arbitrary amounts of dynamic content to our site.<span class="intersentencespace"></span> Seeing exactly how this plays out is the task for the rest of this tutorial.</p>
<p>Before moving on, let’s take a minute to commit our changes and merge them into the master branch.<span class="intersentencespace"></span> Back in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a> we created a Git branch for the development of static pages.<span class="intersentencespace"></span> If you haven’t been making commits as we’ve been moving along, first make a commit indicating that we’ve reached a stopping point:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Finish static pages"</span>
</pre></div></div>
<p>Then merge the changes back into the master branch using the same technique as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-git_commands" class="hyperref">Section&nbsp;<span class="ref">1.3.5</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge static-pages
</pre></div></div>
<p>Once you reach a stopping point like this, it’s usually a good idea to push your code up to a remote repository (which, if you followed the steps in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-github" class="hyperref">Section&nbsp;<span class="ref">1.3.4</span></a>, will be GitHub):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div></div>
<p>If you like, at this point you can even deploy the updated application to Heroku:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
</pre></div></div>
</div>
<div id="_sec-static_pages_exercises" data-tralics-id="cid17" class="section" data-number="3.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages_exercises" class="heading hyperref"><span class="number">3.5 </span>Exercises</a></h2>
<ol>
<li>Make a Contact page for the sample app.<span class="intersentencespace"></span> Following the model in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_title" class="hyperref">Listing&nbsp;<span class="ref">3.19</span></a>, first write a test for the existence of a page at the URL /static_pages/contact by testing for the title “Ruby on Rails Tutorial Sample App | Contact”.<span class="intersentencespace"></span> Get your test to pass by filling the Contact page with the content from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-proposed_contact_page" class="hyperref">Listing&nbsp;<span class="ref">3.30</span></a>.<span class="intersentencespace"></span> (This exercise is solved as part of <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_links" class="hyperref">Section&nbsp;<span class="ref">5.3</span></a>.)
</li>
<li>You may have noticed some repetition in the StaticPages controller spec (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_title" class="hyperref">Listing&nbsp;<span class="ref">3.19</span></a>).<span class="intersentencespace"></span> In particular, the base title, “Ruby on Rails Tutorial Sample App”, is the same for every title test.<span class="intersentencespace"></span> Using the RSpec <code>let</code> function, which creates a variable corresponding to its argument, verify that the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_exercise" class="hyperref">Listing&nbsp;<span class="ref">3.31</span></a> still pass.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_exercise" class="hyperref">Listing&nbsp;<span class="ref">3.31</span></a> introduces <em>string interpolation</em>, which is covered further in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strings" class="hyperref">Section&nbsp;<span class="ref">4.2.2</span></a>.
</li>
<li><strong>(advanced)</strong> As noted on the <a href="http://devcenter.heroku.com/articles/how-do-i-use-sqlite3-for-development" target="_blank">Heroku page on using <span class="tt">sqlite3</span> for development</a>, it’s a good idea to use the same database in development, test, and production environments to minimize the possibility of subtle incompatibilities.<span class="intersentencespace"></span> Follow the <a href="http://devcenter.heroku.com/articles/local-postgresql" target="_blank">Heroku instructions for local PostgreSQL installation</a> to install the PostgreSQL database on your local system.<span class="intersentencespace"></span> Update your <code>Gemfile</code> to eliminate the <span class="tt">sqlite3</span> gem and use the <span class="tt">pg</span> gem exclusively, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-Gemfile_pg_gem" class="hyperref">Listing&nbsp;<span class="ref">3.32</span></a>.<span class="intersentencespace"></span> You will also have to learn about the <code>config/database.yml</code> file and how to run PostgreSQL locally.<span class="intersentencespace"></span> (Note that for security you should add <code>database.yml</code> to your <code>.gitignore</code> file, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.7</span></a>.)<span class="intersentencespace"></span> Your goal should be to create and configure both the development database and the test database to use PostgreSQL. I especially recommend using <a href="http://inductionapp.com/" target="_blank">Induction</a> to connect to and view the local PostgreSQL database.<span class="intersentencespace"></span> <strong>Warning:</strong> You may find this exercise challenging, and I recommend it only for advanced users.<span class="intersentencespace"></span> If you get stuck, don’t hesitate to skip it; as noted previously, the sample application developed in this tutorial is fully compatible with both SQLite and PostgreSQL.
</li></ol>
<div class="codelisting" id="_code-proposed_contact_page" data-tralics-id="uid251" data-number="3.30"><div class="heading"><span class="number">Listing 3.30:</span> 

<span class="description">Code for a proposed Contact page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/contact.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Contact'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Contact Ruby on Rails Tutorial about the sample app at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/contact"</span><span class="nt">&gt;</span>contact page<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-pages_controller_spec_exercise" data-tralics-id="uid252" data-number="3.31"><div class="heading"><span class="number">Listing 3.31:</span> 

<span class="description">The StaticPages controller spec with a base title.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:base_title</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'Home'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Home"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Help page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Help'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/help'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Help'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'Help'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/help'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Help"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/about'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/about'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | About Us"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Contact page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Contact'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/contact'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Contact'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'Contact'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/contact'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Contact"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-Gemfile_pg_gem" data-tralics-id="uid253" data-number="3.32"><div class="heading"><span class="number">Listing 3.32:</span> 

<span class="description">The <code>Gemfile</code> needed to use PostgreSQL instead of SQLite.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span><span class="p">,</span> <span class="s1">'2.35.1'</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span><span class="p">,</span> <span class="s1">'2.1.0'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-advanced_setup" data-tralics-id="cid18" class="section" data-number="3.6"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-advanced_setup" class="heading hyperref"><span class="number">3.6 </span>Advanced setup</a></h2>
<p>As mentioned briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_tests" class="hyperref">Section&nbsp;<span class="ref">3.2</span></a>, using the <code>rspec</code> command directly is not ideal.<span class="intersentencespace"></span> In this section, we’ll first discuss a method to eliminate the necessity of typing <code>bundle exec</code>, and then set up testing to automate the running of the test suite using Guard (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-guard" class="hyperref">Section&nbsp;<span class="ref">3.6.2</span></a>) and, optionally, Spork (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-spork" class="hyperref">Section&nbsp;<span class="ref">3.6.3</span></a>).<span class="intersentencespace"></span> Finally, we’ll mention a method for running tests directly inside Sublime Text, a technique especially useful when used in concert with Spork.</p>
<p>This section should only be attempted by fairly advanced users and can be skipped without loss of continuity.<span class="intersentencespace"></span> Among other things, this material is likely to go out of date faster than the rest of the tutorial, so you shouldn’t expect everything on your system to match the examples exactly, and you may have to Google around to get everything to work.</p>
<div id="_sec-eliminating_bundle_exec" data-tralics-id="uid254" class="subsection" data-number="3.6.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-eliminating_bundle_exec" class="heading hyperref"><span class="number">3.6.1 </span>Eliminating <span class="tt">bundle exec</span></a></h3>
<p>As mentioned briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-TDD" class="hyperref">Section&nbsp;<span class="ref">3.2.1</span></a>, it is necessary in general to prefix commands such as <code>rake</code> or <code>rspec</code> with <code>bundle exec</code> so that the programs run in the exact gem environment specified by the <code>Gemfile</code>.<span class="intersentencespace"></span> (For technical reasons, the only exception to this is the <code>rails</code> command itself.)<span class="intersentencespace"></span> This practice is rather cumbersome, and in this section we discuss two ways to eliminate its necessity.</p>
<div id="_sec-rvm_bundler_integration" data-tralics-id="uid255" class="subsubsection" data-number="3.6.1.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rvm_bundler_integration" class="heading">RVM Bundler integration</a></h4>
<p>The first and preferred method is to use RVM, which includes Bundler integration as of version 1.11.<span class="intersentencespace"></span> You can verify that you have a sufficiently up-to-date version of RVM as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm get stable
<span class="gp">$</span> rvm -v

<span class="go">rvm 1.19.5 (stable)</span>
</pre></div></div>
<p>As long as the version number is 1.11.x or greater, installed gems will automatically be executed in the proper Bundler environment, so that you can write (for example)</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/
</pre></div></div>
<p>and omit the leading <code>bundle exec</code>.<span class="intersentencespace"></span> If this is the case, you should skip the rest of this section.</p>
<p>If for any reason you are restricted to an earlier version of RVM, you can still eliminate <code>bundle exec</code> by using <a href="http://rvm.io/integration/bundler/" target="_blank">RVM Bundler integration</a><sup id="_cha-3_footnote-ref-12" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-12">12</a></sup> to configure the Ruby Version Manager to include the proper executables automatically in the local environment.<span class="intersentencespace"></span> The steps are simple if somewhat mysterious.<span class="intersentencespace"></span> First, run these two commands:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm get head <span class="o">&amp;&amp;</span> rvm reload
<span class="gp">$</span> chmod +x <span class="nv">$rvm_path</span>/hooks/after_cd_bundler
</pre></div></div>
<p>Then run these:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects/sample_app
<span class="gp">$</span> bundle install --without production --binstubs<span class="o">=</span>./bundler_stubs
</pre></div></div>
<p>Together, these commands combine RVM and Bundler magic to ensure that commands such as <code>rake</code> and <code>rspec</code> are automatically executed in the right environment.<span class="intersentencespace"></span> Since these files are specific to your local setup, you should add the <code>bundler_stubs</code> directory to your <code>.gitignore</code> file (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-bundler_stubs_gitignore" class="hyperref">Listing&nbsp;<span class="ref">3.33</span></a>).</p>
<div class="codelisting" id="_code-bundler_stubs_gitignore" data-tralics-id="uid257" data-number="3.33"><div class="heading"><span class="number">Listing 3.33:</span> 

<span class="description">Adding <code>bundler_stubs</code> to the <code>.gitignore</code> file.</span>
</div>

<div class="code"><div class="highlight"><pre># Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# Ignore other unneeded files.
doc/
*.swp
*~
.project
.DS_Store
.idea
bundler_stubs/
</pre></div></div></div><p>If you add another executable (such as <code>guard</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-guard" class="hyperref">Section&nbsp;<span class="ref">3.6.2</span></a>), you should re-run the <code>bundle install</code> command:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --binstubs<span class="o">=</span>./bundler_stubs
</pre></div></div>
</div>
<div id="_sec-binstubs" data-tralics-id="uid258" class="subsubsection" data-number="3.6.1.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-binstubs" class="heading">binstubs</a></h4>
<p>If you’re not using RVM, you can still avoid typing <code>bundle exec</code> using the <a href="https://github.com/mpapis/rubygems-bundler" target="_blank"><span class="tt">rubygems-bundler</span></a> gem:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem install rubygems-bundler
<span class="gp">$</span> gem regenerate_binstubs
</pre></div></div>
<p>The second command creates all the necessary executables locally, so that we can now run the test suite as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/
</pre></div></div>
<p>The same goes for <code>rake</code>, etc.:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
</pre></div></div>
<p>If you add another executable (such as <code>guard</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-guard" class="hyperref">Section&nbsp;<span class="ref">3.6.2</span></a>), you might have to re-run <code>gem regenerate_binstubs</code>.<span class="intersentencespace"></span> (This shouldn’t be necessary, but I mention the possibility just in case.)</p>
<p>For the sake of readers who skip this section, the rest of this tutorial will err on the side of caution and explicitly use <code>bundle exec</code>, but of course you should feel free to use the more compact version if your system is properly configured.</p>
</div></div>
<div id="_sec-guard" data-tralics-id="uid259" class="subsection" data-number="3.6.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-guard" class="heading hyperref"><span class="number">3.6.2 </span>Automated tests with Guard</a></h3>
<p>One annoyance associated with using the <code>rspec</code> command is having to switch to the command line and run the tests by hand.<span class="intersentencespace"></span> (A second annoyance, the slow start-up time of the test suite, is addressed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-spork" class="hyperref">Section&nbsp;<span class="ref">3.6.3</span></a>.)<span class="intersentencespace"></span> In this section, we’ll show how to use <a href="https://github.com/guard/guard" target="_blank">Guard</a> to automate the running of the tests.<span class="intersentencespace"></span> Guard monitors changes in the filesystem so that, for example, when we change the <code>static_pages_spec.rb</code> file only those tests get run.<span class="intersentencespace"></span> Even better, we can configure Guard so that when, say, the <code>home.html.erb</code> file is modified, the <code>static_pages_spec.rb</code> automatically runs.</p>
<p>First we add <code>guard-rspec</code> to the <code>Gemfile</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_guard" class="hyperref">Listing&nbsp;<span class="ref">3.34</span></a>).</p>
<div class="codelisting" id="_code-gemfile_guard" data-tralics-id="uid260" data-number="3.34"><div class="heading"><span class="number">Listing 3.34:</span> 

<span class="description">A <code>Gemfile</code> for the sample app, including Guard.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
  <span class="n">gem</span> <span class="s1">'guard-rspec'</span><span class="p">,</span> <span class="s1">'2.5.0'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span><span class="p">,</span> <span class="s1">'2.35.1'</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span><span class="p">,</span> <span class="s1">'2.1.0'</span>

  <span class="c1"># Uncomment this line on OS X.</span>
  <span class="c1"># gem 'growl', '1.0.3'</span>

  <span class="c1"># Uncomment these lines on Linux.</span>
  <span class="c1"># gem 'libnotify', '0.8.0'</span>

  <span class="c1"># Uncomment these lines on Windows.</span>
  <span class="c1"># gem 'rb-notifu', '0.0.4'</span>
  <span class="c1"># gem 'wdm', '0.1.0'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div></div><p>Be sure to uncomment the lines in the test group relevant for your system.<span class="intersentencespace"></span> (Note that, if you want Growl notifications, you will have to purchase <a href="http://growl.info/downloads" target="_blank">Growl</a>, which is available in the Apple App Store for a nominal charge.)</p>
<p>We next install the gems by running <code>bundle install</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>Then initialize Guard so that it works with RSpec:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard init rspec
<span class="go">Writing new Guardfile to /Users/mhartl/rails_projects/sample_app/Guardfile</span>
<span class="go">rspec guard added to Guardfile, feel free to edit it</span>
</pre></div></div>
<p>Now edit the resulting <code>Guardfile</code> so that Guard will run the right tests when the integration tests and views are updated (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-guardfile" class="hyperref">Listing&nbsp;<span class="ref">3.35</span></a>).</p>
<div class="codelisting" id="_code-guardfile" data-tralics-id="uid261" data-number="3.35"><div class="heading"><span class="number">Listing 3.35:</span> 

<span class="description">Additions to the default <code>Guardfile</code>.<span class="intersentencespace"></span> Note the added <code>require</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'active_support/inflector'</span>

<span class="n">guard</span> <span class="s1">'rspec'</span><span class="p">,</span> <span class="ss">all_after_pass</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'config/routes.rb'</span><span class="p">)</span>
  <span class="c1"># Custom Rails Tutorial specs</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/controllers/(.+)_(controller)\.rb$}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="o">[</span><span class="s2">"spec/routing/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_routing_spec.rb"</span><span class="p">,</span>
     <span class="s2">"spec/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">s/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span><span class="p">,</span>
     <span class="s2">"spec/acceptance/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span><span class="p">,</span>
     <span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="sr">/_pages/</span><span class="o">]</span> <span class="p">?</span> <span class="s2">"spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span> <span class="p">:</span>
                       <span class="s2">"spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">singularize</span><span class="si">}</span><span class="s2">_pages_spec.rb"</span><span class="p">)</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/views/(.+)/}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="sr">/_pages/</span><span class="o">]</span> <span class="p">?</span> <span class="s2">"spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb"</span> <span class="p">:</span>
                      <span class="s2">"spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">singularize</span><span class="si">}</span><span class="s2">_pages_spec.rb"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/controllers/sessions_controller\.rb$}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="s2">"spec/requests/authentication_pages_spec.rb"</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Here the line</p>
<div class="code"><div class="highlight"><pre><span class="n">guard</span> <span class="s1">'rspec'</span><span class="p">,</span> <span class="ss">all_after_pass</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
</pre></div></div>
<p>ensures that Guard doesn’t run all the tests after a failing test passes (to speed up the Red-Green-Refactor cycle).</p>
<p>We can now start <code>guard</code> as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard
</pre></div></div>
<p>To eliminate the need to prefix the command with <code>bundle exec</code>, re-follow the steps in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-eliminating_bundle_exec" class="hyperref">Section&nbsp;<span class="ref">3.6.1</span></a>.</p>
<p>By the way, if you get a Guard error complaining about the absence of a <code>spec/routing</code> directory, you can fix it by creating an empty one:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> mkdir spec/routing
</pre></div></div>
</div>
<div id="_sec-spork" data-tralics-id="uid262" class="subsection" data-number="3.6.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-spork" class="heading hyperref"><span class="number">3.6.3 </span>Speeding up tests with Spork</a></h3>
<p>When running <code>bundle exec rspec</code>, you may have noticed that it takes several seconds just to start running the tests, but once they start running they finish quickly.<span class="intersentencespace"></span> This is because each time RSpec runs the tests it has to reload the entire Rails environment.<span class="intersentencespace"></span> The <a href="http://github.com/sporkrb/spork" target="_blank">Spork test server</a><sup id="_cha-3_footnote-ref-13" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-13">13</a></sup> aims to solve this problem.<span class="intersentencespace"></span> Spork loads the environment <em>once</em>, and then maintains a pool of processes for running future tests.<span class="intersentencespace"></span> Spork is particularly useful when combined with Guard (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-guard" class="hyperref">Section&nbsp;<span class="ref">3.6.2</span></a>).</p>
<p>The first step is to add the <code>spork</code> gem dependency to the <code>Gemfile</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_spork" class="hyperref">Listing&nbsp;<span class="ref">3.36</span></a>).</p>
<div class="codelisting" id="_code-gemfile_spork" data-tralics-id="uid264" data-number="3.36"><div class="heading"><span class="number">Listing 3.36:</span> 

<span class="description">A <code>Gemfile</code> for the sample app, including Spork.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">'spork-rails'</span><span class="p">,</span> <span class="s1">'4.0.0'</span>
  <span class="n">gem</span> <span class="s1">'guard-spork'</span><span class="p">,</span> <span class="s1">'1.5.0'</span>
  <span class="n">gem</span> <span class="s1">'childprocess'</span><span class="p">,</span> <span class="s1">'0.3.6'</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then install Spork using <code>bundle install</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>Next, bootstrap the Spork configuration:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork --bootstrap
</pre></div></div>
<p>Now we need to edit the RSpec configuration file, located in <code>spec/spec_helper.rb</code>, so that the environment gets loaded in a <em>prefork</em> block, which arranges for it to be loaded only once (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-spork_spec_helper" class="hyperref">Listing&nbsp;<span class="ref">3.37</span></a>).</p>
<div class="codelisting" id="_code-spork_spec_helper" data-tralics-id="uid265" data-number="3.37"><div class="heading"><span class="number">Listing 3.37:</span> 

<span class="description">Adding environment loading to the <code>Spork.prefork</code> block.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/spec_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'rubygems'</span>
<span class="nb">require</span> <span class="s1">'spork'</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">prefork</span> <span class="k">do</span>
  <span class="no">ENV</span><span class="o">[</span><span class="s2">"RAILS_ENV"</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
  <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">"../../config/environment"</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">'rspec/rails'</span>
  <span class="nb">require</span> <span class="s1">'rspec/autorun'</span>

  <span class="c1"># Requires supporting ruby files with custom matchers and macros, etc,</span>
  <span class="c1"># in spec/support/ and its subdirectories.</span>
  <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"spec/support/**/*.rb"</span><span class="p">)</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span><span class="p">}</span>

  <span class="c1"># Checks for pending migrations before tests are run.</span>
  <span class="c1"># If you are not using ActiveRecord, you can remove this line.</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">.</span><span class="n">check_pending!</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">)</span>

  <span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="c1"># ## Mock Framework</span>
    <span class="c1">#</span>
    <span class="c1"># If you prefer to use mocha, flexmock or RR, uncomment the appropriate line:</span>
    <span class="c1">#</span>
    <span class="c1"># config.mock_with :mocha</span>
    <span class="c1"># config.mock_with :flexmock</span>
    <span class="c1"># config.mock_with :rr</span>

    <span class="c1"># Remove this line if you're not using ActiveRecord or ActiveRecord fixtures</span>
    <span class="n">config</span><span class="o">.</span><span class="n">fixture_path</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="o">::</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/spec/fixtures"</span>

    <span class="c1"># If you're not using ActiveRecord, or you'd prefer not to run each of your</span>
    <span class="c1"># examples within a transaction, remove the following line or assign false</span>
    <span class="c1"># instead of true.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">use_transactional_fixtures</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># If true, the base class of anonymous controllers will be inferred</span>
    <span class="c1"># automatically. This will be the default behavior in future versions of</span>
    <span class="c1"># rspec-rails.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">infer_base_class_for_anonymous_controllers</span> <span class="o">=</span> <span class="kp">false</span>

    <span class="c1"># Run specs in random order to surface order dependencies. If you find an</span>
    <span class="c1"># order dependency and want to debug it, you can fix the order by providing</span>
    <span class="c1"># the seed, which is printed after each run.</span>
    <span class="c1">#     --seed 1234</span>
    <span class="n">config</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="s2">"random"</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">DSL</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">each_run</span> <span class="k">do</span>
  <span class="c1"># This code will be run each time you run your specs.</span>

<span class="k">end</span>
</pre></div></div></div><p>Before running Spork, we can get a baseline for the testing overhead by timing our test suite as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
<span class="go">......</span>

<span class="go">6 examples, 0 failures</span>

<span class="go">real	0m8.633s</span>
<span class="go">user	0m7.240s</span>
<span class="go">sys	0m1.068s</span>
</pre></div></div>
<p>Here the test suite takes more than seven seconds to run even though the actual tests run in under a tenth of a second.<span class="intersentencespace"></span> To speed this up, we can open a dedicated terminal window, navigate to the application root directory, and then start a Spork server:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork
<span class="go">Using RSpec</span>
<span class="go">Loading Spork.prefork block...</span>
<span class="go">Spork is ready and listening on 8989!</span>
</pre></div></div>
<p>(To eliminate the need to prefix the command with <code>bundle exec</code>, re-follow the steps in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-eliminating_bundle_exec" class="hyperref">Section&nbsp;<span class="ref">3.6.1</span></a>.)<span class="intersentencespace"></span> In another terminal window, we can now run our test suite with the <span class="inline_verbatim">--drb</span> (“distributed Ruby”) option and verify that the environment-loading overhead is greatly reduced:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb --drb
<span class="go">......</span>

<span class="go">6 examples, 0 failures</span>

<span class="go">real	0m2.649s</span>
<span class="go">user	0m1.259s</span>
<span class="go">sys	0m0.258s</span>
</pre></div></div>
<p>It’s inconvenient to have to include the <span class="inline_verbatim">--drb</span> option every time we run <code>rspec</code>, so I recommend adding it to the <code>.rspec</code> file in the application’s root directory, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rspec_drb" class="hyperref">Listing&nbsp;<span class="ref">3.38</span></a>.</p>
<div class="codelisting" id="_code-rspec_drb" data-tralics-id="uid266" data-number="3.38"><div class="heading"><span class="number">Listing 3.38:</span> 

<span class="description">Configuring RSpec to automatically use Spork.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">.rspec</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="o">--</span><span class="n">colour</span>
<span class="o">--</span><span class="n">drb</span>
</pre></div></div></div><p>One word of advice when using Spork: after changing a file included in the prefork loading (such as <code>routes.rb</code>), you will have to restart the Spork server to load the new Rails environment.<span class="intersentencespace"></span> If your tests are failing when you think they should be passing, quit the Spork server with Ctrl-C and restart it:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork
<span class="go">Using RSpec</span>
<span class="go">Loading Spork.prefork block...</span>
<span class="go">Spork is ready and listening on 8989!</span>
<span class="go">^C</span>
<span class="gp">$</span> bundle <span class="nb">exec </span>spork
</pre></div></div>
<div id="_sec-spork_and_guard" data-tralics-id="uid267" class="subsubsection" data-number="3.6.3.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-spork_and_guard" class="heading">Guard with Spork</a></h4>
<p>Spork is especially useful when used with Guard, which we can arrange as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard init spork
</pre></div></div>
<p>We then need to change the <code>Guardfile</code> as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-spork_guardfile" class="hyperref">Listing&nbsp;<span class="ref">3.39</span></a>.</p>
<div class="codelisting" id="_code-spork_guardfile" data-tralics-id="uid268" data-number="3.39"><div class="heading"><span class="number">Listing 3.39:</span> 

<span class="description">The <code>Guardfile</code> updated for Spork.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'active_support/inflector'</span>

<span class="n">guard</span> <span class="s1">'spork'</span><span class="p">,</span> <span class="ss">:cucumber_env</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'RAILS_ENV'</span> <span class="o">=&gt;</span> <span class="s1">'test'</span> <span class="p">},</span>
               <span class="ss">:rspec_env</span>    <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'RAILS_ENV'</span> <span class="o">=&gt;</span> <span class="s1">'test'</span> <span class="p">}</span> <span class="k">do</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'config/application.rb'</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'config/environment.rb'</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'config/environments/test.rb'</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^config/initializers/.+\.rb$}</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'Gemfile'</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'Gemfile.lock'</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'spec/spec_helper.rb'</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:rspec</span> <span class="p">}</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">'test/test_helper.rb'</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:test_unit</span> <span class="p">}</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{features/support/}</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:cucumber</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">guard</span> <span class="s1">'rspec'</span><span class="p">,</span> <span class="ss">all_after_pass</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">cli</span><span class="p">:</span> <span class="s1">'--drb'</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we’ve updated the arguments to <code>guard</code> to include
<span class="inline_verbatim">cli: '--drb'</span>, which ensures that Guard uses the command-line interface (cli) to the Spork server.<span class="intersentencespace"></span> We’ve also added a command to watch the <code>features/support/</code> directory, which we’ll start modifying in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a>.</p>
<p>With that configuration in place, we can start Guard and Spork at the same time with the <code>guard</code> command:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard
</pre></div></div>
<p>Guard automatically starts a Spork server, dramatically reducing the overhead each time a test gets run.</p>
<p>A well-configured testing environment with Guard, Spork, and (optionally) test notifications makes test-driven development positively addictive.<span class="intersentencespace"></span> See the <a href="http://railstutorial.org/screencasts" target="_blank">Rails Tutorial screencasts</a><sup id="_cha-3_footnote-ref-14" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-14">14</a></sup> for more information.</p>
</div></div>
<div id="_sec-tests_inside_sublime_text" data-tralics-id="uid270" class="subsection" data-number="3.6.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-tests_inside_sublime_text" class="heading hyperref"><span class="number">3.6.4 </span>Tests inside Sublime Text</a></h3>
<p>If you’re using Sublime Text, there is a powerful set of helper commands to run tests directly inside the editor.<span class="intersentencespace"></span> This is currently my preferred setup, as it works great when you only have a few tests while still scaling nicely even to very large (and therefore long-running) test suites.<span class="intersentencespace"></span> To get them working, follow the instructions for your platform at <a href="https://github.com/maltize/sublime-text-2-ruby-tests" target="_blank">Sublime Text 2 Ruby Tests</a>.<sup id="_cha-3_footnote-ref-15" class="footnote intersentence"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-15">15</a></sup><span class="intersentencespace"></span> On my platform (Macintosh OS&nbsp;X), I can install the commands as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/Library/Application<span class="se">\ </span>Support/Sublime<span class="se">\ </span>Text<span class="se">\ </span>2/Packages
<span class="gp">$</span> git clone https://github.com/maltize/sublime-text-2-ruby-tests.git RubyTest
</pre></div></div>
<p>You may also want to follow the setup instructions for <a href="https://github.com/mhartl/rails_tutorial_sublime_text" target="_blank">Rails Tutorial Sublime Text</a> at this time.<sup id="_cha-3_footnote-ref-16" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-16">16</a></sup></p>
<p>After restarting Sublime Text, the RubyTest package supplies the following commands:</p>
<ul>
<li><strong>Command-Shift-R</strong>: run a single test (if run on an <code>it</code> block) or group of tests (if run on a <code>describe</code> block)
</li>
<li><strong>Command-Shift-E</strong>: run the last test(s)
</li>
<li><strong>Command-Shift-T</strong>: run all the tests in current file
</li></ul>
<p>Because test suites can become quite slow even for relatively small projects, being able to run one test (or a small group of tests) at a time can be a huge win.<span class="intersentencespace"></span> Even a single test requires the same Rails environment overhead, of course, which is why these commands are perfectly complemented by Spork: running a single test eliminates the overhead of running the entire test file, while running Spork eliminates the overhead of starting the test environment.<span class="intersentencespace"></span> Here is the sequence I recommend:</p>
<ol>
<li>Start Spork in a terminal window.<span class="intersentencespace"></span>
</li>
<li>Write a single test or small group of tests.<span class="intersentencespace"></span>
</li>
<li>Run Command-Shift-R to verify that the test or test group is red.<span class="intersentencespace"></span>
</li>
<li>Write the corresponding application code.<span class="intersentencespace"></span>
</li>
<li>Run Command-Shift-E to run the same test/group again, verifying that it’s green.<span class="intersentencespace"></span>
</li>
<li>Repeat steps 2–5 as necessary.<span class="intersentencespace"></span>
</li>
<li>When reaching a natural stopping point (such as before a commit), run <code>rspec spec/</code> at the command line to confirm that the entire test suite is still green.<span class="intersentencespace"></span>
</li></ol>
<p>Even with the ability to run tests inside of Sublime Text, I still sometimes prefer using Guard, but at this point my bread-and-butter TDD technique is the one enumerated above.</p>
</div></div>
<div id="cha-3_footnotes">
  <ol class="footnotes">
    <li id="_cha-3_footnote-1">The successor to <em>Webrat</em>, Capybara is named after the world’s <a href="http://en.wikipedia.org/wiki/Capybara" target="_blank">largest rodent</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-1">↑</a></li>
    <li id="_cha-3_footnote-2">It’s worth noting that <span class="inline_verbatim">--without</span> <span class="inline_verbatim">production</span>is a “remembered option”, which means that we don’t have to include it in future invocations of Bundler.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-2">↑</a></li>
    <li id="_cha-3_footnote-3">As before, you may find the augmented file from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gitignore" class="hyperref">Listing&nbsp;<span class="ref">1.7</span></a> to be more convenient depending on your system.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-3">↑</a></li>
    <li id="_cha-3_footnote-4">https://github.com/railstutorial/sample_app_rails_4&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-4">↑</a></li>
    <li id="_cha-3_footnote-5">Our method for making static pages is probably the simplest, but it’s not the only way.<span class="intersentencespace"></span> The optimal method really depends on your needs; if you expect a <em>large</em> number of static pages, using a StaticPages controller can get quite cumbersome, but in our sample app we’ll only need a few.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-5">↑</a></li>
    <li id="_cha-3_footnote-6">Running <code>bundle exec</code> every time is rather cumbersome; see <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-advanced_setup" class="hyperref">Section&nbsp;<span class="ref">3.6</span></a> for some options to eliminate it.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-6">↑</a></li>
    <li id="_cha-3_footnote-7">I actually use a dark background for both my terminal and editor, but the light background looks better in the screenshots.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-7">↑</a></li>
    <li id="_cha-3_footnote-8">HTML changes with time; by explicitly making a doctype declaration we make it likelier that browsers will render our pages properly in the future.<span class="intersentencespace"></span> The extremely simple doctype <code>&lt;!DOCTYPE html&gt;</code> is characteristic of the latest HTML standard, HTML5.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-8">↑</a></li>
    <li id="_cha-3_footnote-9">There is a second popular template system called <a href="http://haml-lang.com/" target="_blank">Haml</a>, which I personally love, but it’s not <em>quite</em> standard enough yet for use in an introductory tutorial.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-9">↑</a></li>
    <li id="_cha-3_footnote-10">Experienced Rails developers might have expected the use of <code>content_for</code> at this point, but it doesn’t work well with the asset pipeline.<span class="intersentencespace"></span> The <code>provide</code> function is its replacement.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-10">↑</a></li>
    <li id="_cha-3_footnote-11">If you’ve studied Ruby before, you might suspect that Rails is <em>yielding</em> the contents to a block, and your suspicion would be correct.<span class="intersentencespace"></span> But you don’t need to know this to develop applications with Rails.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-11">↑</a></li>
    <li id="_cha-3_footnote-12">http://rvm.io/integration/bundler/&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-12">↑</a></li>
    <li id="_cha-3_footnote-13">A <em>spork</em> is a combination spoon-fork.<span class="intersentencespace"></span> The project’s name is a pun on Spork’s use of <a href="http://en.wikipedia.org/wiki/POSIX" target="_blank">POSIX</a> <a href="http://en.wikipedia.org/wiki/Fork_(software_development)" target="_blank">forks</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-13">↑</a></li>
    <li id="_cha-3_footnote-14">http://railstutorial.org/screencasts&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-14">↑</a></li>
    <li id="_cha-3_footnote-15">https://github.com/maltize/sublime-text-2-ruby-tests&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-15">↑</a></li>
    <li id="_cha-3_footnote-16">https://github.com/mhartl/rails_tutorial_sublime_text&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-3_footnote-ref-16">↑</a></li>
  </ol>
</div><div id="_cha-rails_flavored_ruby" data-tralics-id="cid19" class="chapter" data-number="4"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-rails_flavored_ruby" class="heading hyperref"><span class="number">Chapter 4 </span>Rails-flavored Ruby</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>Grounded in examples from <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a>, this chapter explores some elements of Ruby important for Rails.<span class="intersentencespace"></span> Ruby is a big language, but fortunately the subset needed to be productive as a Rails developer is relatively small.<span class="intersentencespace"></span> Moreover, this subset is <em>different</em> from the usual approaches to learning Ruby, which is why, if your goal is making dynamic web applications, I recommend learning Rails first, picking up bits of Ruby along the way.<span class="intersentencespace"></span> To become a Rails <em>expert</em>, you need to understand Ruby more deeply, and this book gives you a good foundation for developing that expertise.<span class="intersentencespace"></span> As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-comments_for_various_readers" class="hyperref">Section&nbsp;<span class="ref">1.1.1</span></a>, after finishing the <em>Rails Tutorial</em> I suggest reading a pure Ruby book such as <a href="http://www.amazon.com/gp/product/1430223634" target="_blank"><em>Beginning Ruby</em></a>, <a href="http://www.amazon.com/gp/product/1933988657" target="_blank"><em>The Well-Grounded Rubyist</em></a>, or <a href="http://www.amazon.com/gp/product/0672328844" target="_blank"><em>The Ruby Way</em></a>.</p>
<p>This chapter covers a lot of material, and it’s OK not to get it all on the first pass.<span class="intersentencespace"></span> I’ll refer back to it frequently in future chapters.</p>
</div>
<div id="_sec-motivation" data-tralics-id="cid20" class="section" data-number="4.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-motivation" class="heading hyperref"><span class="number">4.1 </span>Motivation</a></h2>
<p>As we saw in the last chapter, it’s possible to develop the skeleton of a Rails application, and even start testing it, with essentially no knowledge of the underlying Ruby language.<span class="intersentencespace"></span> We did this by relying on the test code provided by the tutorial and addressing each error message until the test suite was passing.<span class="intersentencespace"></span> This situation can’t last forever, though, and we’ll open this chapter with an addition to the site that brings us face-to-face with our Ruby limitations.</p>
<p>When we last saw our new application, we had just updated our mostly static pages to use Rails layouts to eliminate duplication in our views, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout_redux" class="hyperref">Listing&nbsp;<span class="ref">4.1</span></a> (which is a slightly reformatted version of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout" class="hyperref">Listing&nbsp;<span class="ref">3.26</span></a>).</p>
<div class="codelisting" id="_code-application_layout_redux" data-tralics-id="uid283" data-number="4.1"><div class="heading"><span class="number">Listing 4.1:</span> 

<span class="description">The sample application site layout.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                           <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p>Let’s focus on one particular line in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout_redux" class="hyperref">Listing&nbsp;<span class="ref">4.1</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                       <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This uses the built-in Rails function <code>stylesheet_link_tag</code> (which you can read more about at the <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/AssetTagHelper.html#method-i-stylesheet_link_tag" target="_blank">Rails API</a>) to include <code>application.css</code> for all <a href="http://www.w3.org/TR/CSS2/media.html" target="_blank">media types</a> (including computer screens and printers).<span class="intersentencespace"></span> To an experienced Rails developer, this line looks simple, but there are at least four potentially confusing Ruby ideas: built-in Rails methods, method invocation with missing parentheses, symbols, and hashes.<span class="intersentencespace"></span> We’ll cover all of these ideas in this chapter.</p>
<p>In addition to coming equipped with a large number of built-in functions for use in the views, Rails also allows the creation of new ones.<span class="intersentencespace"></span> Such functions are called <em>helpers</em>; to see how to make a custom helper, let’s start by examining the title line from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout_redux" class="hyperref">Listing&nbsp;<span class="ref">4.1</span></a>:</p>
<div class="code"><div class="highlight"><pre>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This relies on the definition of a page title (using <code>provide</code>) in each view, as in</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Home'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div>
<p>But what if we don’t provide a title?<span class="intersentencespace"></span> It’s a good convention to have a <em>base title</em> we use on every page, with an optional page title if we want to be more specific.<span class="intersentencespace"></span> We’ve <em>almost</em> achieved that with our current layout, with one wrinkle: as you can see if you delete the <code>provide</code> call in one of the views, in the absence of a page-specific title the full title appears as follows:</p>
<div class="code"><div class="highlight"><pre>Ruby on Rails Tutorial Sample App |
</pre></div></div>
<p>In other words, there’s a suitable base title, but there’s also a trailing vertical bar character <code>|</code> at the end.</p>
<p>To solve the problem of a missing page title, we’ll define a custom helper called <code>full_title</code>.<span class="intersentencespace"></span> The <code>full_title</code> helper returns a base title, “Ruby on Rails Tutorial Sample App”, if no page title is defined, and adds a vertical bar followed by the page title if one is defined (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-title_helper" class="hyperref">Listing&nbsp;<span class="ref">4.2</span></a>).<sup id="_cha-4_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-1">1</a></sup></p>
<div class="codelisting" id="_code-title_helper" data-tralics-id="uid285" data-number="4.2"><div class="heading"><span class="number">Listing 4.2:</span> 

<span class="description">Defining a <code>full_title</code> helper.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/application_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># Returns the full title on a per-page basis.</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">base_title</span>
    <span class="k">else</span>
      <span class="s2">"</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Now that we have a helper, we can use it to simplify our layout by replacing</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p>with</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div></div>
<p>as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout_full_title" class="hyperref">Listing&nbsp;<span class="ref">4.3</span></a>.</p>
<div class="codelisting" id="_code-application_layout_full_title" data-tralics-id="uid286" data-number="4.3"><div class="heading"><span class="number">Listing 4.3:</span> 

<span class="description">The sample application site layout.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                           <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p>To put our helper to work, we can eliminate the unnecessary word “Home” from the Home page, allowing it to revert to the base title.<span class="intersentencespace"></span> We do this by first updating our test with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_base_title_spec" class="hyperref">Listing&nbsp;<span class="ref">4.4</span></a>, which updates the previous title test and adds one to test for the absence of the custom <code>’Home’</code> string in the title.<span class="intersentencespace"></span> (<em>Note</em>: If you completed the exercise corresponding to <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_exercise" class="hyperref">Listing&nbsp;<span class="ref">3.31</span></a>, you should retain the <code>let</code> statement defining the <code>base_title</code> in the first <code>describe</code> block.)</p>
<div class="codelisting" id="_code-home_base_title_spec" data-tralics-id="uid287" data-number="4.4"><div class="heading"><span class="number">Listing 4.4:</span> 

<span class="description">Updated tests for the Home page’s title.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the base title"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should not have a custom page title"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/home'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>See if you can figure out why we’ve added a new test instead of just altering the current one.<span class="intersentencespace"></span> (<em>Hint</em>: The answer is in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-testing_a_title_change" class="hyperref">Section&nbsp;<span class="ref">3.3.1</span></a>.)</p>
<p>Let’s run the test suite to verify that one test fails:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>To get the test suite to pass, we’ll remove the <code>provide</code> line from the Home page’s view, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_base_title" class="hyperref">Listing&nbsp;<span class="ref">4.5</span></a>.</p>
<div class="codelisting" id="_code-home_page_base_title" data-tralics-id="uid288" data-number="4.5"><div class="heading"><span class="number">Listing 4.5:</span> 

<span class="description">The Home page with no custom page title.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>At this point the tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>As with the line to include the application stylesheet, the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-title_helper" class="hyperref">Listing&nbsp;<span class="ref">4.2</span></a> may look simple to the eyes of an experienced Rails developer, but it’s <em>full</em> of potentially confusing Ruby ideas: modules, comments, local variable assignment, booleans, control flow, string interpolation, and return values.<span class="intersentencespace"></span> This chapter will cover all of these ideas as well.</p>
</div>
<div id="_sec-strings_and_methods" data-tralics-id="cid21" class="section" data-number="4.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strings_and_methods" class="heading hyperref"><span class="number">4.2 </span>Strings and methods</a></h2>
<p>Our principal tool for learning Ruby will be the <em>Rails console</em>, a command-line tool for interacting with Rails applications first seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_user_has_many_microposts" class="hyperref">Section&nbsp;<span class="ref">2.3.3</span></a>.<span class="intersentencespace"></span> The console itself is built on top of interactive Ruby (<code>irb</code>), and thus has access to the full power of the Ruby language.<span class="intersentencespace"></span> (As we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_controller_class" class="hyperref">Section&nbsp;<span class="ref">4.4.4</span></a>, the console also has access to the Rails environment.)<span class="intersentencespace"></span> Start the console at the command line as follows:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="go">Loading development environment</span>
<span class="go">&gt;&gt;</span>
</pre></div></div>
<p>By default, the console starts in a <em>development environment</em>, which is one of three separate environments defined by Rails (the others are <em>test</em> and <em>production</em>).<span class="intersentencespace"></span> This distinction won’t be important in this chapter, but we’ll learn more about environments in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_environments" class="hyperref">Section&nbsp;<span class="ref">7.1.1</span></a>.</p>
<p>The console is a great learning tool, and you should feel free to explore—don’t worry, you (probably) won’t break anything.<span class="intersentencespace"></span> When using the console, type Ctrl-C if you get stuck, or Ctrl-D to exit the console altogether.<span class="intersentencespace"></span> Throughout the rest of this chapter, you might find it helpful to consult the <a href="http://ruby-doc.org/core-2.0/" target="_blank">Ruby API</a>.<span class="intersentencespace"></span> It’s packed (perhaps even <em>too</em> packed) with information; for example, to learn more about Ruby strings you can look at the Ruby API entry for the <code>String</code> class.</p>
<div id="_sec-comments" data-tralics-id="uid289" class="subsection" data-number="4.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-comments" class="heading hyperref"><span class="number">4.2.1 </span>Comments</a></h3>
<p>Ruby <em>comments</em> start with the pound sign&nbsp;<code>#</code> (also called the “hash mark” or, more poetically, the “octothorpe”) and extend to the end of the line.<span class="intersentencespace"></span> Ruby ignores comments, but they are useful for human readers (including, often, the original author!).<span class="intersentencespace"></span> In the code</p>
<div class="code"><div class="highlight"><pre>  <span class="c1"># Returns the full title on a per-page basis.</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
</pre></div></div>
<p>the first line is a comment indicating the purpose of the subsequent function definition.</p>
<p>You don’t ordinarily include comments in console sessions, but for instructional purposes I’ll include some comments in what follows, like this:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="mi">17</span> <span class="o">+</span> <span class="mi">42</span>   <span class="c1"># Integer addition</span>
<span class="go">=&gt; 59</span>
</pre></div></div>
<p>If you follow along in this section typing or copying-and-pasting commands into your own console, you can of course omit the comments if you like; the console will ignore them in any case.</p>
</div>
<div id="_sec-strings" data-tralics-id="uid290" class="subsection" data-number="4.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strings" class="heading hyperref"><span class="number">4.2.2 </span>Strings</a></h3>
<p><em>Strings</em> are probably the most important data structure for web applications, since web pages ultimately consist of strings of characters sent from the server to the browser.<span class="intersentencespace"></span> Let’s start exploring strings with the console, this time started with <code>rails&nbsp;c</code>, which is a shortcut for <code>rails console</code>:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails c</span>
<span class="gp">&gt;&gt; </span><span class="s2">""</span>         <span class="c1"># An empty string</span>
<span class="go">=&gt; ""</span>
<span class="gp">&gt;&gt; </span><span class="s2">"foo"</span>      <span class="c1"># A nonempty string</span>
<span class="go">=&gt; "foo"</span>
</pre></div></div>
<p>These are <em>string literals</em> (also, amusingly, called <em>literal strings</em>), created using the double quote character&nbsp;<code>"</code>.<span class="intersentencespace"></span> The console prints the result of evaluating each line, which in the case of a string literal is just the string itself.</p>
<p>We can also concatenate strings with the <code>+</code> operator:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"foo"</span> <span class="o">+</span> <span class="s2">"bar"</span>    <span class="c1"># String concatenation</span>
<span class="go">=&gt; "foobar"</span>
</pre></div></div>
<p>Here the result of evaluating <code>"foo"</code> plus <code>"bar"</code> is the string <code>"foobar"</code>.<sup id="_cha-4_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-2">2</a></sup></p>
<p>Another way to build up strings is via <em>interpolation</em> using the special syntax <code>#{}</code>:<sup id="_cha-4_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-3">3</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">"Michael"</span>    <span class="c1"># Variable assignment</span>
<span class="go">=&gt; "Michael"</span>
<span class="gp">&gt;&gt; </span><span class="s2">"</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> Hartl"</span>     <span class="c1"># String interpolation</span>
<span class="go">=&gt; "Michael Hartl"</span>
</pre></div></div>
<p>Here we’ve <em>assigned</em> the value <code>"Michael"</code> to the variable <code>first_name</code> and then interpolated it into the string <code>"#{first_name} Hartl"</code>.<span class="intersentencespace"></span> We could also assign both strings a variable name:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">"Michael"</span>
<span class="go">=&gt; "Michael"</span>
<span class="gp">&gt;&gt; </span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">"Hartl"</span>
<span class="go">=&gt; "Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">last_name</span>    <span class="c1"># Concatenation, with a space in between</span>
<span class="go">=&gt; "Michael Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="s2">"</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">"</span>    <span class="c1"># The equivalent interpolation</span>
<span class="go">=&gt; "Michael Hartl"</span>
</pre></div></div>
<p>Note that the final two expressions are equivalent, but I prefer the interpolated version; having to add the single space <code>"&nbsp;"</code> seems a bit awkward.</p>
<div id="_sec-printing" data-tralics-id="uid293" class="subsubsection" data-number="4.2.2.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-printing" class="heading">Printing</a></h4>
<p>To <em>print</em> a string, the most commonly used Ruby function is <code>puts</code> (pronounced “put ess”, for “put string”):</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"foo"</span>     <span class="c1"># put string</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>The <code>puts</code> method operates as a <em>side-effect</em>: the expression <code>puts "foo"</code> prints the string to the screen and then returns <a href="http://www.answers.com/nil" target="_blank">literally nothing</a>: <code>nil</code> is a special Ruby value for “nothing at all”.<span class="intersentencespace"></span> (In what follows, I’ll sometimes suppress the <code>=&gt; nil</code> part for simplicity.)</p>
<p>Using <code>puts</code> automatically appends a newline character&nbsp;<span class="inline_verbatim">\n</span> to the output; the related <code>print</code> method does not:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">"foo"</span>    <span class="c1"># print string (same as puts, but without the newline)</span>
<span class="go">foo=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">"foo</span><span class="se">\n</span><span class="s2">"</span>  <span class="c1"># Same as puts "foo"</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
</div>
<div id="_sec-single_quoted_strings" data-tralics-id="uid294" class="subsubsection" data-number="4.2.2.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-single_quoted_strings" class="heading">Single-quoted strings</a></h4>
<p>All the examples so far have used <em>double-quoted strings</em>, but Ruby also supports <em>single-quoted</em> strings.<span class="intersentencespace"></span> For many uses, the two types of strings are effectively identical:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">'foo'</span>          <span class="c1"># A single-quoted string</span>
<span class="go">=&gt; "foo"</span>
<span class="gp">&gt;&gt; </span><span class="s1">'foo'</span> <span class="o">+</span> <span class="s1">'bar'</span>
<span class="go">=&gt; "foobar"</span>
</pre></div></div>
<p>There’s an important difference, though; Ruby won’t interpolate into single-quoted strings:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">'#{foo} bar'</span>     <span class="c1"># Single-quoted strings don't allow interpolation</span>
<span class="go">=&gt; "\#{foo} bar"</span>
</pre></div></div>
<p>Note how the console returns values using double-quoted strings, which requires a backslash to <em>escape</em> special characters such as&nbsp;<code>#</code>.</p>
<p>If double-quoted strings can do everything that single-quoted strings can do, and interpolate to boot, what’s the point of single-quoted strings?<span class="intersentencespace"></span> They are often useful because they are truly literal, and contain exactly the characters you type.<span class="intersentencespace"></span> For example, the “backslash” character is special on most systems, as in the literal newline&nbsp;<span class="inline_verbatim">\n</span>.<span class="intersentencespace"></span> If you want a variable to contain a literal backslash, single quotes make it easier:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">'\n'</span>       <span class="c1"># A literal 'backslash n' combination</span>
<span class="go">=&gt; "\\n"</span>
</pre></div></div>
<p>As with the&nbsp;<code>#</code> character in our previous example, Ruby needs to escape the backslash with an additional backslash; inside double-quoted strings, a literal backslash is represented with <em>two</em> backslashes.<span class="intersentencespace"></span> For a small example like this, there’s not much savings, but if there are lots of things to escape it can be a real help:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">'Newlines (\n) and tabs (\t) both use the backslash character \.'</span>
<span class="go">=&gt; "Newlines (\\n) and tabs (\\t) both use the backslash character \\."</span>
</pre></div></div>
</div></div>
<div id="_sec-objects_and_message_passing" data-tralics-id="uid295" class="subsection" data-number="4.2.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-objects_and_message_passing" class="heading hyperref"><span class="number">4.2.3 </span>Objects and message passing</a></h3>
<p>Everything in Ruby, including strings and even <code>nil</code>, is an <em>object</em>.<span class="intersentencespace"></span> We’ll see the technical meaning of this in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_class_of_our_own" class="hyperref">Section&nbsp;<span class="ref">4.4.2</span></a>, but I don’t think anyone ever understood objects by reading the definition in a book; you have to build up your intuition for objects by seeing lots of examples.</p>
<p>It’s easier to describe what objects <em>do</em>, which is respond to messages.<span class="intersentencespace"></span> An object like a string, for example, can respond to the message <code>length</code>, which returns the number of characters in the string:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"foobar"</span><span class="o">.</span><span class="n">length</span>        <span class="c1"># Passing the "length" message to a string</span>
<span class="go">=&gt; 6</span>
</pre></div></div>
<p>Typically, the messages that get passed to objects are <em>methods</em>, which are functions defined on those objects.<sup id="_cha-4_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-4">4</a></sup><span class="intersentencespace"></span> Strings also respond to the <code>empty?</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"foobar"</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">""</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>Note the question mark at the end of the <code>empty?</code> method.<span class="intersentencespace"></span> This is a Ruby convention indicating that the return value is <em>boolean</em>: <code>true</code> or <code>false</code>.<span class="intersentencespace"></span> Booleans are especially useful for <em>control flow</em>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">"foobar"</span>
<span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">"The string is empty"</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">"The string is nonempty"</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; "The string is nonempty"</span>
</pre></div></div>
<p>Booleans can also be combined using the <code>&amp;&amp;</code> (“and”), <code>||</code> (“or”), and <code>!</code> (“not”) operators:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="s2">"foo"</span>
<span class="go">=&gt; "foo"</span>
<span class="gp">&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="s2">""</span>
<span class="go">=&gt; ""</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"Both strings are empty"</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"One of the strings is empty"</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">"One of the strings is empty"</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"x is not empty"</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">"x is not empty"</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>Since everything in Ruby is an object, it follows that <code>nil</code> is an object, so it too can respond to methods.<span class="intersentencespace"></span> One example is the <code>to_s</code> method that can convert virtually any object to a string:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span>
<span class="go">=&gt; ""</span>
</pre></div></div>
<p>This certainly appears to be an empty string, as we can verify by <em>chaining</em> the messages we pass to <code>nil</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">NoMethodError: You have a nil object when you didn't expect it!</span>
<span class="go">You might have expected an instance of Array.</span>
<span class="go">The error occurred while evaluating nil.empty?</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">empty?</span>      <span class="c1"># Message chaining</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>We see here that the <code>nil</code> object doesn’t itself respond to the <code>empty?</code> method, but <code>nil.to_s</code> does.</p>
<p>There’s a special method for testing for <code>nil</code>-ness, which you might be able to guess:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"foo"</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">""</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>The code</p>
<div class="code"><div class="highlight"><pre><span class="nb">puts</span> <span class="s2">"x is not empty"</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
</pre></div></div>
<p>also shows an alternate use of the <code>if</code> keyword: Ruby allows you to write a statement that is evaluated only if the statement following <code>if</code> is true.<span class="intersentencespace"></span> There’s a complementary <code>unless</code> keyword that works the same way:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">string</span> <span class="o">=</span> <span class="s2">"foobar"</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"The string '</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">' is nonempty."</span> <span class="k">unless</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">The string 'foobar' is nonempty.</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>It’s worth noting that the <code>nil</code> object is special, in that it is the <em>only</em> Ruby object that is false in a boolean context, apart from <code>false</code> itself:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="kp">nil</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">true</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">false</span>        <span class="c1"># nil is false</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>In particular, all other Ruby objects are <em>true</em>, even 0:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="mi">0</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">true</span>        <span class="c1"># 0 (and everything other than nil and false itself) is true</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">false</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; true</span>
</pre></div></div>
</div>
<div id="_sec-method_definitions" data-tralics-id="uid297" class="subsection" data-number="4.2.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-method_definitions" class="heading hyperref"><span class="number">4.2.4 </span>Method definitions</a></h3>
<p>The console allows us to define methods the same way we did with the <code>home</code> action from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_pages_controller" class="hyperref">Listing&nbsp;<span class="ref">3.6</span></a> or the <code>full_title</code> helper from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-title_helper" class="hyperref">Listing&nbsp;<span class="ref">4.2</span></a>.<span class="intersentencespace"></span> (Defining methods in the console is a bit cumbersome, and ordinarily you would use a file, but it’s convenient for demonstration purposes.)<span class="intersentencespace"></span> For example, let’s define a function <code>string_message</code> that takes a single <em>argument</em> and returns a message based on whether the argument is empty or not:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">"It's an empty string!"</span>
<span class="gp">&gt;&gt; </span>  <span class="k">else</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">"The string is nonempty."</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="go">It's an empty string!</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">The string is nonempty.</span>
</pre></div></div>
<p>Note that Ruby functions have an <em>implicit return</em>, meaning they return the last statement evaluated—in this case, one of the two message strings, depending on whether the method’s argument <code>string</code> is empty or not.<span class="intersentencespace"></span> Ruby also has an explicit return option; the following function is equivalent to the one above:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">"It's an empty string!"</span> <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">"The string is nonempty."</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
</pre></div></div>
<p>(The alert reader might notice at this point that the second <code>return</code> here is actually unnecessary—being the last expression in the function, the string <code>"The string is nonempty."</code> will be returned regardless of the <code>return</code> keyword, but using <code>return</code> in both places has a pleasing symmetry to it.)</p>
<p>It’s also important to understand that the name of the function argument is irrelevant as far as the caller is concerned.<span class="intersentencespace"></span> In other words, the first example above could replace <code>string</code> with any other valid variable name, such as <code>the_function_argument</code>, and it would work just the same:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">the_function_argument</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">if</span> <span class="n">the_function_argument</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">"It's an empty string!"</span>
<span class="gp">&gt;&gt; </span>  <span class="k">else</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">"The string is nonempty."</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="go">It's an empty string!</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">The string is nonempty.</span>
</pre></div></div>
</div>
<div id="_sec-back_to_the_title_helper" data-tralics-id="uid298" class="subsection" data-number="4.2.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-back_to_the_title_helper" class="heading hyperref"><span class="number">4.2.5 </span>Back to the title helper</a></h3>
<p>We are now in a position to understand the <code>full_title</code> helper from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-title_helper" class="hyperref">Listing&nbsp;<span class="ref">4.2</span></a>:<sup id="_cha-4_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-5">5</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># Returns the full title on a per-page basis.       # Documentation comment</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>                          <span class="c1"># Method definition</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>  <span class="c1"># Variable assignment</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>                              <span class="c1"># Boolean test</span>
      <span class="n">base_title</span>                                      <span class="c1"># Implicit return</span>
    <span class="k">else</span>
      <span class="s2">"</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">"</span>                 <span class="c1"># String interpolation</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>These elements—function definition, variable assignment, boolean tests, control flow, and string interpolation—come together to make a compact helper method for use in our site layout.<span class="intersentencespace"></span> The final element is <code>module ApplicationHelper</code>: modules give us a way to package together related methods, which can then be <em>mixed in</em> to Ruby classes using <code>include</code>.<span class="intersentencespace"></span> When writing ordinary Ruby, you often write modules and include them explicitly yourself, but in the case of a helper module Rails handles the inclusion for us.<span class="intersentencespace"></span> The result is that the <code>full_title</code> method is <a href="http://catb.org/jargon/html/A/automagically.html" target="_blank">automagically</a> available in all our views.</p>
</div></div>
<div id="_sec-other_data_structures" data-tralics-id="cid22" class="section" data-number="4.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-other_data_structures" class="heading hyperref"><span class="number">4.3 </span>Other data structures</a></h2>
<p>Although web apps are ultimately about strings, actually <em>making</em> those strings requires using other data structures as well.<span class="intersentencespace"></span> In this section, we’ll learn about some Ruby data structures important for writing Rails applications.</p>
<div id="_sec-arrays_and_ranges" data-tralics-id="uid300" class="subsection" data-number="4.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-arrays_and_ranges" class="heading hyperref"><span class="number">4.3.1 </span>Arrays and ranges</a></h3>
<p>An array is just a list of elements in a particular order.<span class="intersentencespace"></span> We haven’t discussed arrays yet in the <em>Rails Tutorial</em>, but understanding them gives a good foundation for understanding hashes (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-hashes_and_symbols" class="hyperref">Section&nbsp;<span class="ref">4.3.3</span></a>) and for aspects of Rails data modeling (such as the <code>has_many</code> association seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_user_has_many_microposts" class="hyperref">Section&nbsp;<span class="ref">2.3.3</span></a> and covered more in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_micropost_associations" class="hyperref">Section&nbsp;<span class="ref">10.1.3</span></a>).</p>
<p>So far we’ve spent a lot of time understanding strings, and there’s a natural way to get from strings to arrays using the <code>split</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span> <span class="s2">"foo bar     baz"</span><span class="o">.</span><span class="n">split</span>     <span class="c1"># Split a string into a three-element array.</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
</pre></div></div>
<p>The result of this operation is an array of three strings.<span class="intersentencespace"></span> By default, <code>split</code> divides a string into an array by splitting on whitespace, but you can split on nearly anything else as well:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"fooxbarxbazx"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
</pre></div></div>
<p>As is conventional in most computer languages, Ruby arrays are <em>zero-offset</em>, which means that the first element in the array has index&nbsp;0, the second has index&nbsp;1, and so on:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="o">]</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>               <span class="c1"># Ruby uses square brackets for array access.</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>              <span class="c1"># Indices can even be negative!</span>
<span class="go">=&gt; 17</span>
</pre></div></div>
<p>We see here that Ruby uses square brackets to access array elements.<span class="intersentencespace"></span> In addition to this bracket notation, Ruby offers synonyms for some commonly accessed elements:<sup id="_cha-4_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-6">6</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>                  <span class="c1"># Just a reminder of what 'a' is</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">second</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>    <span class="c1"># Comparison using ==</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>This last line introduces the equality comparison operator <code>==</code>, which Ruby shares with many other languages, along with the associated <code>!=</code> (“not equal”), etc.:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">length</span>       <span class="c1"># Like strings, arrays respond to the 'length' method.</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">3</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">!=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>In addition to <code>length</code> (seen in the first line above), arrays respond to a wealth of other methods:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; [17, 8, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">shuffle</span>
<span class="go">=&gt; [17, 42, 8]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
</pre></div></div>
<p>Note that none of the methods above changes <code>a</code> itself.<span class="intersentencespace"></span> To <em>mutate</em> the array, use the corresponding “bang” methods (so-called because the exclamation point is usually pronounced “bang” in this context):</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort!</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [8, 17, 42]</span>
</pre></div></div>
<p>You can also add to arrays with the <code>push</code> method or its equivalent operator, <span class="inline_verbatim">&lt;&lt;</span>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>                  <span class="c1"># Pushing 6 onto an array</span>
<span class="go">=&gt; [42, 8, 17, 6]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>                     <span class="c1"># Pushing 7 onto an array</span>
<span class="go">=&gt; [42, 8, 17, 6, 7]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s2">"foo"</span> <span class="o">&lt;&lt;</span> <span class="s2">"bar"</span>        <span class="c1"># Chaining array pushes</span>
<span class="go">=&gt; [42, 8, 17, 6, 7, "foo", "bar"]</span>
</pre></div></div>
<p>This last example shows that you can chain pushes together, and also that, unlike arrays in many other languages, Ruby arrays can contain a mixture of different types (in this case, integers and strings).</p>
<p>Before we saw <code>split</code> convert a string to an array.<span class="intersentencespace"></span> We can also go the other way with the <code>join</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17, 7, "foo", "bar"]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span>                       <span class="c1"># Join on nothing.</span>
<span class="go">=&gt; "428177foobar"</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>                 <span class="c1"># Join on comma-space.</span>
<span class="go">=&gt; "42, 8, 17, 7, foo, bar"</span>
</pre></div></div>
<p>Closely related to arrays are <em>ranges</em>, which can probably most easily be understood by converting them to arrays using the <code>to_a</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span>
<span class="go">=&gt; 0..9</span>
<span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="o">.</span><span class="n">to_a</span>              <span class="c1"># Oops, call to_a on 9.</span>
<span class="go">NoMethodError: undefined method `to_a' for 9:Fixnum</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># Use parentheses to call to_a on the range.</span>
<span class="go">=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
</pre></div></div>
<p>Though <code>0..9</code> is a valid range, the second expression above shows that we need to add parentheses to call a method on it.</p>
<p>Ranges are useful for pulling out array elements:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="sx">%w[foo bar baz quux]</span>         <span class="c1"># Use %w to make a string array.</span>
<span class="go">=&gt; ["foo", "bar", "baz", "quux"]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
</pre></div></div>
<p>A particularly useful trick is to use the index -1 at the end of the range to select every element from the starting point to the end of the array <em>without</em> explicitly having to use the array’s length:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="go">=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">]</span>               <span class="c1"># Explicitly use the array's length.</span>
<span class="go">=&gt; [2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>                         <span class="c1"># Use the index -1 trick.</span>
<span class="go">=&gt; [2, 3, 4, 5, 6, 7, 8, 9]</span>
</pre></div></div>
<p>Ranges also work with characters:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'e'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="go">=&gt; ["a", "b", "c", "d", "e"]</span>
</pre></div></div>
</div>
<div id="_sec-blocks" data-tralics-id="uid302" class="subsection" data-number="4.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-blocks" class="heading hyperref"><span class="number">4.3.2 </span>Blocks</a></h3>
<p>Both arrays and ranges respond to a host of methods that accept <em>blocks</em>, which are simultaneously one of Ruby’s most powerful and most confusing features:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="p">}</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div></div>
<p>This code calls the <code>each</code> method on the range <code>(1..5)</code> and passes it the block <code>{ |i| puts 2 * i }</code>.<span class="intersentencespace"></span> The vertical bars around the variable name in&nbsp;<code>|i|</code> are Ruby syntax for a block variable, and it’s up to the method to know what to do with the block.<span class="intersentencespace"></span> In this case, the range’s <code>each</code> method can handle a block with a single local variable, which we’ve called&nbsp;<code>i</code>, and it just executes the block for each value in the range.</p>
<p>Curly braces are one way to indicate a block, but there is a second way as well:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div></div>
<p>Blocks can be more than one line, and often are.<span class="intersentencespace"></span> In the <em>Rails Tutorial</em> we’ll follow the common convention of using curly braces only for short one-line blocks and the <code>do..end</code> syntax for longer one-liners and for multi-line blocks:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">number</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">number</span>
<span class="gp">&gt;&gt; </span>  <span class="nb">puts</span> <span class="s1">'--'</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">2</span>
<span class="go">--</span>
<span class="go">4</span>
<span class="go">--</span>
<span class="go">6</span>
<span class="go">--</span>
<span class="go">8</span>
<span class="go">--</span>
<span class="go">10</span>
<span class="go">--</span>
<span class="go">=&gt; 1..5</span>
</pre></div></div>
<p>Here I’ve used <code>number</code> in place of&nbsp;<code>i</code> just to emphasize that any variable name will do.</p>
<p>Unless you already have a substantial programming background, there is no shortcut to understanding blocks; you just have to see them a lot, and eventually you’ll get used to them.<sup id="_cha-4_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-7">7</a></sup><span class="intersentencespace"></span> Luckily, humans are quite good at making generalizations from concrete examples; here are a few more, including a couple using the <code>map</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">"Betelgeuse!"</span> <span class="p">}</span>   <span class="c1"># 3.times takes a block with no variables.</span>
<span class="go">"Betelgeuse!"</span>
<span class="go">"Betelgeuse!"</span>
<span class="go">"Betelgeuse!"</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="p">}</span>          <span class="c1"># The ** notation is for 'power'.</span>
<span class="go">=&gt; [1, 4, 9, 16, 25]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span>                        <span class="c1"># Recall that %w makes string arrays.</span>
<span class="go">=&gt; ["a", "b", "c"]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">upcase</span> <span class="p">}</span>
<span class="go">=&gt; ["A", "B", "C"]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[A B C]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
<span class="go">=&gt; ["a", "b", "c"]</span>
</pre></div></div>
<p>As you can see, the <code>map</code> method returns the result of applying the given block to each element in the array or range.</p>
<p>By the way, we’re now in a position to understand the line of Ruby I threw into <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-heroku_commands" class="hyperref">Section&nbsp;<span class="ref">1.4.4</span></a> to generate random subdomains:</p>
<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>
</pre></div></div>
<p>Let’s build it up step-by-step:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>                     <span class="c1"># An alphabet array</span>
<span class="go">=&gt; ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o",</span>
<span class="go">"p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span>             <span class="c1"># Shuffle it.</span>
<span class="go">=&gt; ["c", "g", "l", "k", "h", "z", "s", "i", "n", "d", "y", "u", "t", "j", "q",</span>
<span class="go">"b", "r", "o", "f", "e", "w", "v", "m", "a", "x", "p"]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">]</span>       <span class="c1"># Pull out the first eight elements.</span>
<span class="go">=&gt; ["f", "w", "i", "a", "h", "p", "c", "x"]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">'a'</span><span class="o">.</span><span class="n">.</span><span class="s1">'z'</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>  <span class="c1"># Join them together to make one string.</span>
<span class="go">=&gt; "mznpybuj"</span>
</pre></div></div>
</div>
<div id="_sec-hashes_and_symbols" data-tralics-id="uid304" class="subsection" data-number="4.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-hashes_and_symbols" class="heading hyperref"><span class="number">4.3.3 </span>Hashes and symbols</a></h3>
<p>Hashes are essentially arrays that aren’t limited to integer indices.<span class="intersentencespace"></span> (In fact, some languages, especially Perl, sometimes call hashes <em>associative arrays</em> for this reason.)<span class="intersentencespace"></span> Instead, hash indices, or <em>keys</em>, can be almost any object.<span class="intersentencespace"></span> For example, we can use strings as keys:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{}</span>                          <span class="c1"># {} is an empty hash.</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">"first_name"</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Michael"</span>     <span class="c1"># Key "first_name", value "Michael"</span>
<span class="go">=&gt; "Michael"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">"last_name"</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Hartl"</span>        <span class="c1"># Key "last_name", value "Hartl"</span>
<span class="go">=&gt; "Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">"first_name"</span><span class="o">]</span>                 <span class="c1"># Element access is like arrays.</span>
<span class="go">=&gt; "Michael"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span>                               <span class="c1"># A literal representation of the hash</span>
<span class="go">=&gt; {"last_name"=&gt;"Hartl", "first_name"=&gt;"Michael"}</span>
</pre></div></div>
<p>Hashes are indicated with curly braces containing key-value pairs; a pair of braces with no key-value pairs—i.e., <code>{}</code>—is an empty hash.<span class="intersentencespace"></span> It’s important to note that the curly braces for hashes have nothing to do with the curly braces for blocks.<span class="intersentencespace"></span> (Yes, this can be confusing.)<span class="intersentencespace"></span> Although hashes resemble arrays, one important difference is that hashes don’t generally guarantee keeping their elements in a particular order.<sup id="_cha-4_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-8">8</a></sup><span class="intersentencespace"></span> If order matters, use an array.</p>
<p>Instead of defining hashes one item at a time using square brackets, it’s easy to use a literal representation with keys and values separated by&nbsp;<code>=&gt;</code>, called a “hashrocket”:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"first_name"</span> <span class="o">=&gt;</span> <span class="s2">"Michael"</span><span class="p">,</span> <span class="s2">"last_name"</span> <span class="o">=&gt;</span> <span class="s2">"Hartl"</span> <span class="p">}</span>
<span class="go">=&gt; {"last_name"=&gt;"Hartl", "first_name"=&gt;"Michael"}</span>
</pre></div></div>
<p>Here I’ve used the usual Ruby convention of putting an extra space at the two ends of the hash—a convention ignored by the console output.<span class="intersentencespace"></span> (Don’t ask me why the spaces are conventional; probably some early influential Ruby programmer liked the look of the extra spaces, and the convention stuck.)</p>
<p>So far we’ve used strings as hash keys, but in Rails it is much more common to use <em>symbols</em> instead.<span class="intersentencespace"></span> Symbols look kind of like strings, but prefixed with a colon instead of surrounded by quotes.<span class="intersentencespace"></span> For example, <code>:name</code> is a symbol.<span class="intersentencespace"></span> You can think of symbols as basically strings without all the extra baggage:<sup id="_cha-4_footnote-ref-9" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-9">9</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"name"</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="go">=&gt; ["n", "a", "m", "e"]</span>
<span class="gp">&gt;&gt; </span><span class="ss">:name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="go">NoMethodError: undefined method `split' for :name:Symbol</span>
<span class="gp">&gt;&gt; </span><span class="s2">"foobar"</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; "raboof"</span>
<span class="gp">&gt;&gt; </span><span class="ss">:foobar</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">NoMethodError: undefined method `reverse' for :foobar:Symbol</span>
</pre></div></div>
<p>Symbols are a special Ruby data type shared with very few other languages, so they may seem weird at first, but Rails uses them a lot, so you’ll get used to them fast.</p>
<p>In terms of symbols as hash keys, we can define a <code>user</code> hash as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">"michael@example.com"</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;"Michael Hartl", :email=&gt;"michael@example.com"}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>              <span class="c1"># Access the value corresponding to :name.</span>
<span class="go">=&gt; "Michael Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>          <span class="c1"># Access the value of an undefined key.</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>We see here from the last example that the hash value for an undefined key is simply <code>nil</code>.</p>
<p>Since it’s so common for hashes to use symbols as keys, Ruby&nbsp;1.9 supports a new syntax just for this special case:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">"michael@example.com"</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;"Michael Hartl", :email=&gt;"michael@example.com"}</span>
<span class="gp">&gt;&gt; </span><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"michael@example.com"</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;"Michael Hartl", :email=&gt;"michael@example.com"}</span>
<span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">==</span> <span class="n">h2</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>The second syntax replaces the symbol/hashrocket combination with the name of the key followed by a colon and a value:</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"michael@example.com"</span> <span class="p">}</span>
</pre></div></div>
<p>This construction more closely follows the hash notation in other languages (such as JavaScript) and enjoys growing popularity in the Rails community.<span class="intersentencespace"></span> Because both hash syntaxes are still in common use, it’s essential to be able to recognize both of them.<span class="intersentencespace"></span> Unfortunately, this can be confusing, especially since <code>:name</code> is valid on its own (as a standalone symbol) but <code>name:</code> has no meaning by itself.<span class="intersentencespace"></span> The bottom line is that <code>:name =&gt;</code> and <code>name:</code> are effectively the same <em>only inside literal hashes</em>, so that</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Michael Hartl"</span> <span class="p">}</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span> <span class="p">}</span>
</pre></div></div>
<p>are equivalent, but otherwise you need to use <code>:name</code> (with the colon coming first) to denote a symbol</p>
<p>Hash values can be virtually anything, even other hashes, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-nested_hashes" class="hyperref">Listing&nbsp;<span class="ref">4.6</span></a>.</p>
<div class="codelisting" id="_code-nested_hashes" data-tralics-id="uid307" data-number="4.6"><div class="heading"><span class="number">Listing 4.6:</span> 

<span class="description">Nested hashes.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># Define a hash called 'params' (short for 'parameters').</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;"Michael Hartl", :email=&gt;"mhartl@example.com"}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span>
<span class="go">=&gt; {:user=&gt;{:name=&gt;"Michael Hartl", :email=&gt;"mhartl@example.com"}}</span>
<span class="gp">&gt;&gt; </span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
<span class="go">=&gt; "mhartl@example.com"</span>
</pre></div></div></div><p>These sorts of hashes-of-hashes, or <em>nested hashes</em>, are heavily used by Rails, as we’ll see starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_failure" class="hyperref">Section&nbsp;<span class="ref">7.3</span></a>.</p>
<p>As with arrays and ranges, hashes respond to the <code>each</code> method.<span class="intersentencespace"></span> For example, consider a hash named <code>flash</code> with keys for two conditions, <code>:success</code> and <code>:error</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success</span><span class="p">:</span> <span class="s2">"It worked!"</span><span class="p">,</span> <span class="ss">error</span><span class="p">:</span> <span class="s2">"It failed."</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;"It worked!", :error=&gt;"It failed."}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">"Key </span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> has value </span><span class="si">#{</span><span class="n">value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">"</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">Key :success has value "It worked!"</span>
<span class="go">Key :error has value "It failed."</span>
</pre></div></div>
<p>Note that, while the <code>each</code> method for arrays takes a block with only one variable, <code>each</code> for hashes takes two, a <em>key</em> and a <em>value</em>.<span class="intersentencespace"></span> Thus, the <code>each</code> method for a hash iterates through the hash one key-value <em>pair</em> at a time.</p>
<p>The last example uses the useful <code>inspect</code> method, which returns a string with a literal representation of the object it’s called on:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># Put an array as a string.</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="go">4</span>
<span class="go">5</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">inspect</span>    <span class="c1"># Put a literal array.</span>
<span class="go">[1, 2, 3, 4, 5]</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:name</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">name</span>
<span class="go">:name</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">"It worked!"</span><span class="p">,</span> <span class="s2">"It worked!"</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">It worked!</span>
<span class="go">"It worked!"</span>
</pre></div></div>
<p>By the way, using <code>inspect</code> to print an object is common enough that there’s a shortcut for it, the <code>p</code> function:<sup id="_cha-4_footnote-ref-10" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-10">10</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">p</span> <span class="ss">:name</span>             <span class="c1"># Same as 'puts :name.inspect'</span>
<span class="go">:name</span>
</pre></div></div>
</div>
<div id="_sec-css_revisited" data-tralics-id="uid309" class="subsection" data-number="4.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-css_revisited" class="heading hyperref"><span class="number">4.3.4 </span>CSS revisited</a></h3>
<p>It’s time now to revisit the line from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout_redux" class="hyperref">Listing&nbsp;<span class="ref">4.1</span></a> used in the layout to include the cascading style sheets:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                       <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>We are now nearly in a position to understand this.<span class="intersentencespace"></span> As mentioned briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-motivation" class="hyperref">Section&nbsp;<span class="ref">4.1</span></a>, Rails defines a special function to include stylesheets, and</p>
<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>is a call to this function.<span class="intersentencespace"></span> But there are several mysteries.<span class="intersentencespace"></span> First, where are the parentheses?<span class="intersentencespace"></span> In Ruby, they are optional; these two are equivalent:</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Parentheses on function calls are optional.</span>
<span class="n">stylesheet_link_tag</span><span class="p">(</span><span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>Second, the <code>media</code> argument sure looks like a hash, but where are the curly braces?<span class="intersentencespace"></span> When hashes are the <em>last</em> argument in a function call, the curly braces are optional; these two are equivalent:</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Curly braces on final hash arguments are optional.</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="p">{</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                     <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>Next, why does the <code>data-turbolinks-track</code> key/value pair use the old-style hashrocket syntax?<span class="intersentencespace"></span> This is because using the newer syntax to write</p>
<div class="code"><div class="highlight"><pre><span class="n">data</span><span class="o">-</span><span class="n">turbolinks</span><span class="o">-</span><span class="ss">track</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p>is invalid because of the hyphens.<span class="intersentencespace"></span> This forces us to use the older syntax, yielding</p>
<div class="code"><div class="highlight"><pre><span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>Finally, why does Ruby correctly interpret the lines</p>
<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>even with a line break between the final elements?<span class="intersentencespace"></span> The answer is that Ruby doesn’t distinguish between newlines and other whitespace in this context.<sup id="_cha-4_footnote-ref-11" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-11">11</a></sup><span class="intersentencespace"></span> The <em>reason</em> I chose to break the code into pieces is that I prefer to keep lines of source code under 80 characters for legibility.<sup id="_cha-4_footnote-ref-12" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-12">12</a></sup></p>
<p>So, we see now that the line</p>
<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                   <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div></div>
<p>calls the <code>stylesheet_link_tag</code> function with two arguments: a string, indicating the path to the stylesheet, and a hash with two elements, indicating the media type and telling Rails to use the <a href="https://github.com/rails/turbolinks" target="_blank">turbolinks</a> feature (new in Rails&nbsp;4).<span class="intersentencespace"></span> Because of the <span class="inline_verbatim">&lt;%= %&gt;</span> brackets, the results are inserted into the template by ERb, and if you view the source of the page in your browser you should see the HTML needed to include a stylesheet (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-scss_source" class="hyperref">Listing&nbsp;<span class="ref">4.7</span></a>).<span class="intersentencespace"></span> (You may see some extra things, like <code>?body=1</code>, after the CSS filenames.<span class="intersentencespace"></span> These are inserted by Rails to ensure that browsers reload the CSS when it changes on the server.)</p>
<div class="codelisting" id="_code-scss_source" data-tralics-id="uid312" data-number="4.7"><div class="heading"><span class="number">Listing 4.7:</span> 

<span class="description">The HTML source produced by the CSS includes.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">data-turbolinks-track=</span><span class="s">"true"</span> <span class="na">href=</span><span class="s">"/assets/application.css"</span> <span class="na">media=</span><span class="s">"all"</span>
<span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="nt">/&gt;</span>
</pre></div></div></div><p>If you actually view the CSS file by navigating to <a href="http://localhost:3000/assets/application.css" target="_blank">http://localhost:3000/assets/application.css</a>, you’ll see that (apart from some comments) it is empty.<span class="intersentencespace"></span> We’ll set about changing this in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a>.</p>
</div></div>
<div id="_sec-ruby_classes" data-tralics-id="cid23" class="section" data-number="4.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ruby_classes" class="heading hyperref"><span class="number">4.4 </span>Ruby classes</a></h2>
<p>We’ve said before that everything in Ruby is an object, and in this section we’ll finally get to define some of our own.<span class="intersentencespace"></span> Ruby, like many object-oriented languages, uses <em>classes</em> to organize methods; these classes are then <em>instantiated</em> to create objects.<span class="intersentencespace"></span> If you’re new to object-oriented programming, this may sound like gibberish, so let’s look at some concrete examples.</p>
<div id="_sec-constructors" data-tralics-id="uid313" class="subsection" data-number="4.4.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-constructors" class="heading hyperref"><span class="number">4.4.1 </span>Constructors</a></h3>
<p>We’ve seen lots of examples of using classes to instantiate objects, but we have yet to do so explicitly.<span class="intersentencespace"></span> For example, we instantiated a string using the double quote characters, which is a <em>literal constructor</em> for strings:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">"foobar"</span>       <span class="c1"># A literal constructor for strings using double quotes</span>
<span class="go">=&gt; "foobar"</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
</pre></div></div>
<p>We see here that strings respond to the method <code>class</code>, and simply return the class they belong to.</p>
<p>Instead of using a literal constructor, we can use the equivalent <em>named constructor</em>, which involves calling the <code>new</code> method on the class name:<sup id="_cha-4_footnote-ref-13" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-13">13</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>   <span class="c1"># A named constructor for a string</span>
<span class="go">=&gt; "foobar"</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">==</span> <span class="s2">"foobar"</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>This is equivalent to the literal constructor, but it’s more explicit about what we’re doing.</p>
<p>Arrays work the same way as strings:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span>
<span class="go">=&gt; [1, 3, 2]</span>
</pre></div></div>
<p>Hashes, in contrast, are different.<span class="intersentencespace"></span> While the array constructor <code>Array.new</code> takes an initial value for the array, <code>Hash.new</code> takes a <em>default</em> value for the hash, which is the value of the hash for a nonexistent key:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>            <span class="c1"># Try to access the value for the nonexistent key :foo.</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># Arrange for nonexistent keys to return 0 instead of nil.</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>
<span class="go">=&gt; 0</span>
</pre></div></div>
<p>When a method gets called on the class itself, as in the case of <code>new</code>, it’s called a <em>class method</em>.<span class="intersentencespace"></span> The result of calling <code>new</code> on a class is an object of that class, also called an <em>instance</em> of the class.<span class="intersentencespace"></span> A method called on an instance, such as <code>length</code>, is called an <em>instance method</em>.</p>
</div>
<div id="_sec-a_class_of_our_own" data-tralics-id="uid315" class="subsection" data-number="4.4.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_class_of_our_own" class="heading hyperref"><span class="number">4.4.2 </span>Class inheritance</a></h3>
<p>When learning about classes, it’s useful to find out the <em>class hierarchy</em> using the <code>superclass</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; "foobar"</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>                        <span class="c1"># Find the class of s.</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>             <span class="c1"># Find the superclass of String.</span>
<span class="go">=&gt; Object</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>  <span class="c1"># Ruby 1.9 uses a new BasicObject base class</span>
<span class="go">=&gt; BasicObject</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>A diagram of this inheritance hierarchy appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-string_inheritance_ruby_1_9" class="hyperref">Figure&nbsp;<span class="ref">4.1</span></a>.<span class="intersentencespace"></span> We see here that the superclass of <code>String</code> is <code>Object</code> and the superclass of <code>Object</code> is <code>BasicObject</code>, but <code>BasicObject</code> has no superclass.<span class="intersentencespace"></span> This pattern is true of every Ruby object: trace back the class hierarchy far enough and every class in Ruby ultimately inherits from <code>BasicObject</code>, which has no superclass itself.<span class="intersentencespace"></span> This is the technical meaning of “everything in Ruby is an object”.</p>
<div class="center figure" id="_fig-string_inheritance_ruby_1_9" data-tralics-id="uid316" data-number="4.1"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/string_inheritance_ruby_1_9.png" alt="string_inheritance_ruby_1_9"></span>
<div class="caption"><span class="header">Figure 4.1: </span><span class="description">The inheritance hierarchy for the <code>String</code> class.
</span></div></div>
<p>To understand classes a little more deeply, there’s no substitute for making one of our own.<span class="intersentencespace"></span> Let’s make a <code>Word</code> class with a <code>palindrome?</code> method that returns <code>true</code> if the word is the same spelled forward and backward:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>    <span class="n">string</span> <span class="o">==</span> <span class="n">string</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>We can use it as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">w</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span>              <span class="c1"># Make a new Word object.</span>
<span class="go">=&gt; #&lt;Word:0x22d0b20&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">"level"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>If this example strikes you as a bit contrived, good; this is by design.<span class="intersentencespace"></span> It’s odd to create a new class just to create a method that takes a string as an argument.<span class="intersentencespace"></span> Since a word <em>is a</em> string, it’s more natural to have our <code>Word</code> class <em>inherit</em> from <code>String</code>, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-word_class" class="hyperref">Listing&nbsp;<span class="ref">4.8</span></a>.<span class="intersentencespace"></span> (You should exit the console and re-enter it to clear out the old definition of <code>Word</code>.)</p>
<div class="codelisting" id="_code-word_class" data-tralics-id="uid317" data-number="4.8"><div class="heading"><span class="number">Listing 4.8:</span> 

<span class="description">Defining a <code>Word</code> class in the console.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span> <span class="o">&lt;</span> <span class="nb">String</span>             <span class="c1"># Word inherits from String.</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># Returns true if the string is its own reverse.</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>        <span class="c1"># self is the string itself.</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div></div></div><p>Here <code>Word &lt; String</code> is the Ruby syntax for inheritance (discussed briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a>), which ensures that, in addition to the new <code>palindrome?</code> method, words also have all the same methods as strings:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"level"</span><span class="p">)</span>    <span class="c1"># Make a new Word, initialized with "level".</span>
<span class="go">=&gt; "level"</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">palindrome?</span>            <span class="c1"># Words have the palindrome? method.</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">length</span>                 <span class="c1"># Words also inherit all the normal string methods.</span>
<span class="go">=&gt; 5</span>
</pre></div></div>
<p>Since the <code>Word</code> class inherits from <code>String</code>, we can use the console to see the class hierarchy explicitly:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Word</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div></div>
<p>This hierarchy is illustrated in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-word_inheritance_ruby_1_9" class="hyperref">Figure&nbsp;<span class="ref">4.2</span></a>.</p>
<div class="center figure" id="_fig-word_inheritance_ruby_1_9" data-tralics-id="uid318" data-number="4.2"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/word_inheritance_ruby_1_9.png" alt="word_inheritance_ruby_1_9"></span>
<div class="caption"><span class="header">Figure 4.2: </span><span class="description">The inheritance hierarchy for the (non-built-in) <code>Word</code> class from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-word_class" class="hyperref">Listing&nbsp;<span class="ref">4.8</span></a>.
</span></div></div>
<p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-word_class" class="hyperref">Listing&nbsp;<span class="ref">4.8</span></a>, note that checking that the word is its own reverse involves accessing the word inside the <code>Word</code> class.<span class="intersentencespace"></span> Ruby allows us to do this using the <code>self</code> keyword: inside the <code>Word</code> class, <code>self</code> is the object itself, which means we can use</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
</pre></div></div>
<p>to check if the word is a palindrome.<sup id="_cha-4_footnote-ref-14" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-14">14</a></sup></p>
</div>
<div id="_sec-modifying_built_in_classes" data-tralics-id="uid320" class="subsection" data-number="4.4.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modifying_built_in_classes" class="heading hyperref"><span class="number">4.4.3 </span>Modifying built-in classes</a></h3>
<p>While inheritance is a powerful idea, in the case of palindromes it might be even more natural to add the <code>palindrome?</code> method to the <code>String</code> class itself, so that (among other things) we can call <code>palindrome?</code> on a string literal, which we currently can’t do:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"level"</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">NoMethodError: undefined method `palindrome?' for "level":String</span>
</pre></div></div>
<p>Amazingly, Ruby lets you do just this; Ruby classes can be <em>opened</em> and modified, allowing ordinary mortals such as ourselves to add methods to them:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># Returns true if the string is its own reverse.</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">"deified"</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>(I don’t know which is cooler: that Ruby lets you add methods to built-in classes, or that <code>"deified"</code> is a palindrome.)</p>
<p>Modifying built-in classes is a powerful technique, but with great power comes great responsibility, and it’s considered bad form to add methods to built-in classes without having a <em>really</em> good reason for doing so.<span class="intersentencespace"></span> Rails does have some good reasons; for example, in web applications we often want to prevent variables from being <em>blank</em>—e.g., a user’s name should be something other than spaces and other <a href="http://en.wikipedia.org/wiki/Whitespace_(computer_science)" target="_blank">whitespace</a>—so Rails adds a <code>blank?</code> method to Ruby.<span class="intersentencespace"></span> Since the Rails console automatically includes the Rails extensions, we can see an example here (this won’t work in plain <code>irb</code>):</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">""</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="s2">"      "</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">"      "</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>We see that a string of spaces is not <em>empty</em>, but it is <em>blank</em>.<span class="intersentencespace"></span> Note also that <code>nil</code> is blank; since <code>nil</code> isn’t a string, this is a hint that Rails actually adds <code>blank?</code> to <code>String</code>’s base class, which (as we saw at the beginning of this section) is <code>Object</code> itself.<span class="intersentencespace"></span> We’ll see some other examples of Rails additions to Ruby classes in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a>.</p>
</div>
<div id="_sec-a_controller_class" data-tralics-id="uid321" class="subsection" data-number="4.4.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_controller_class" class="heading hyperref"><span class="number">4.4.4 </span>A controller class</a></h3>
<p>All this talk about classes and inheritance may have triggered a flash of recognition, because we have seen both before, in the StaticPages controller (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-adding_the_about_page" class="hyperref">Listing&nbsp;<span class="ref">3.16</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>You’re now in a position to appreciate, at least vaguely, what this code means: <code>StaticPagesController</code> is a class that inherits from <code>ApplicationController</code>, and comes equipped with <code>home</code>, <code>help</code>, and <code>about</code> methods.<span class="intersentencespace"></span> Since each Rails console session loads the local Rails environment, we can even create a controller explicitly and examine its class hierarchy:<sup id="_cha-4_footnote-ref-15" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-15">15</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span> <span class="o">=</span> <span class="no">StaticPagesController</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;StaticPagesController:0x22855d0&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; StaticPagesController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ApplicationController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Metal</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; AbstractController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div></div>
<p>A diagram of this hierarchy appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-static_pages_controller_inheritance" class="hyperref">Figure&nbsp;<span class="ref">4.3</span></a>.</p>
<div class="center figure" id="_fig-static_pages_controller_inheritance" data-tralics-id="uid323" data-number="4.3"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/static_pages_controller_inheritance.png" alt="static_pages_controller_inheritance"></span>
<div class="caption"><span class="header">Figure 4.3: </span><span class="description">The inheritance hierarchy for the StaticPages controller.
</span></div></div>
<p>We can even call the controller actions inside the console, which are just methods:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">home</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>Here the return value is <code>nil</code> because the <code>home</code> action is blank.</p>
<p>But wait—actions don’t have return values, at least not ones that matter.<span class="intersentencespace"></span> The point of the <code>home</code> action, as we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a>, is to render a web page, not to return a value.<span class="intersentencespace"></span> And I sure don’t remember ever calling <code>StaticPagesController.new</code> anywhere.<span class="intersentencespace"></span> What’s going on?</p>
<p>What’s going on is that Rails is <em>written in</em> Ruby, but Rails isn’t Ruby.<span class="intersentencespace"></span> Some Rails classes are used like ordinary Ruby objects, but some are just <a href="http://www.answers.com/grist" target="_blank">grist</a> for Rails’ magic mill.<span class="intersentencespace"></span> Rails is <a href="http://en.wikipedia.org/wiki/Sui_generis" target="_blank"><em>sui generis</em></a>, and should be studied and understood separately from Ruby.<span class="intersentencespace"></span> This is why, if your principal programming interest is writing web applications, I recommend learning Rails first, then learning Ruby, then looping back to Rails.</p>
</div>
<div id="_sec-a_user_class" data-tralics-id="uid324" class="subsection" data-number="4.4.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="heading hyperref"><span class="number">4.4.5 </span>A user class</a></h3>
<p>We end our tour of Ruby with a complete class of our own, a <code>User</code> class that anticipates the User model coming up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>.</p>
<p>So far we’ve entered class definitions at the console, but this quickly becomes tiresome; instead, create the file <code>example_user.rb</code> in your application root directory and fill it with the contents of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-example_user" class="hyperref">Listing&nbsp;<span class="ref">4.9</span></a>.</p>
<div class="codelisting" id="_code-example_user" data-tralics-id="uid325" data-number="4.9"><div class="heading"><span class="number">Listing 4.9:</span> 

<span class="description">Code for an example user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">example_user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">"</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>There’s quite a bit going on here, so let’s take it step by step.<span class="intersentencespace"></span> The first line,</p>
<div class="code"><div class="highlight"><pre>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
</pre></div></div>
<p>creates <em>attribute accessors</em> corresponding to a user’s name and email address.<span class="intersentencespace"></span> This creates “getter” and “setter” methods that allow us to retrieve (get) and assign (set) <code>@name</code> and <code>@email</code> <em>instance variables</em>, which were mentioned briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc_in_action" class="hyperref">Section&nbsp;<span class="ref">2.2.2</span></a>.<span class="intersentencespace"></span> In Rails, the principal importance of instance variables is that they are automatically available in the views, but in general they are used for variables that need to be available throughout a Ruby class.<span class="intersentencespace"></span> (We’ll have more to say about this in a moment.)<span class="intersentencespace"></span> Instance variables always begin with an&nbsp;<code>@</code> sign, and are <code>nil</code> when undefined.</p>
<p>The first method, <code>initialize</code>, is special in Ruby: it’s the method called when we execute <code>User.new</code>.<span class="intersentencespace"></span> This particular <code>initialize</code> takes one argument, <code>attributes</code>:</p>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>
</pre></div></div>
<p>Here the <code>attributes</code> variable has a <em>default value</em> equal to the empty hash, so that we can define a user with no name or email address (recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-hashes_and_symbols" class="hyperref">Section&nbsp;<span class="ref">4.3.3</span></a> that hashes return <code>nil</code> for nonexistent keys, so the value of <code>attributes[:name]</code> will be <code>nil</code> if there is no <code>:name</code> key, and similarly for <code>attributes[:email]</code>).</p>
<p>Finally, our class defines a method called <code>formatted_email</code> that uses the values of the assigned <code>@name</code> and <code>@email</code> variables to build up a nicely formatted version of the user’s email address using string interpolation (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strings" class="hyperref">Section&nbsp;<span class="ref">4.2.2</span></a>):</p>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">"</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;"</span>
  <span class="k">end</span>
</pre></div></div>
<p>Because <code>@name</code> and <code>@email</code> are both instance variables (as indicated with the&nbsp;<code>@</code> sign), they are automatically available in the <code>formatted_email</code> method.</p>
<p>Let’s fire up the console, <code>require</code> the example user code, and take our User class out for a spin:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">require</span> <span class="s1">'./example_user'</span>     <span class="c1"># This is how you load the example_user code.</span>
<span class="go">=&gt; ["User"]</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User:0x224ceec @email=nil, @name=nil&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span>                 <span class="c1"># nil since attributes[:name] is nil</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Example User"</span>           <span class="c1"># Assign a non-nil name</span>
<span class="go">=&gt; "Example User"</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"user@example.com"</span>      <span class="c1"># and a non-nil email address</span>
<span class="go">=&gt; "user@example.com"</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; "Example User &lt;user@example.com&gt;"</span>
</pre></div></div>
<p>Here the <code>’.’</code><span class="intersentencespace"></span> is Unix for “current directory”, and <code>’./example_user’</code> tells Ruby to look for an example user file relative to that location.<span class="intersentencespace"></span> The subsequent code creates an empty example user and then fills in the name and email address by assigning directly to the corresponding attributes (assignments made possible by the <code>attr_accessor</code> line in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-example_user" class="hyperref">Listing&nbsp;<span class="ref">4.9</span></a>).<span class="intersentencespace"></span> When we write</p>
<div class="code"><div class="highlight"><pre><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Example User"</span>
</pre></div></div>
<p>Ruby is setting the <code>@name</code> variable to <code>"Example User"</code> (and similarly for the <code>email</code> attribute), which we then use in the <code>formatted_email</code> method.</p>
<p>Recalling from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-css_revisited" class="hyperref">Section&nbsp;<span class="ref">4.3.4</span></a> we can omit the curly braces for final hash arguments, we can create another user by passing a hash to the <code>initialize</code> method to create a user with pre-defined attributes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User:0x225167c @email="mhartl@example.com", @name="Michael Hartl"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; "Michael Hartl &lt;mhartl@example.com&gt;"</span>
</pre></div></div>
<p>We will see starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a> that initializing objects using a hash argument, a technique known as <em>mass assignment</em>, is common in Rails applications.</p>
</div></div>
<div id="_sec-conclusion" data-tralics-id="cid24" class="section" data-number="4.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-conclusion" class="heading hyperref"><span class="number">4.5 </span>Conclusion</a></h2>
<p>This concludes our overview of the Ruby language.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a>, we’ll start putting it to good use in developing the sample application.</p>
<p>We won’t be using the <code>example_user.rb</code> file from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>, so I suggest removing it:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm example_user.rb
</pre></div></div>
<p>Then commit the other changes to the main source code repository:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add a full_title helper"</span>
</pre></div></div>
</div>
<div id="_sec-exercises" data-tralics-id="cid25" class="section" data-number="4.6"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-exercises" class="heading hyperref"><span class="number">4.6 </span>Exercises</a></h2>
<ol>
<li>By replacing the question marks in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-string_shuffle" class="hyperref">Listing&nbsp;<span class="ref">4.10</span></a> with the appropriate methods, combine <code>split</code>, <code>shuffle</code>, and <code>join</code> to write a function that shuffles the letters in a given string.
</li>
<li>Using <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-string_shuffle_two" class="hyperref">Listing&nbsp;<span class="ref">4.11</span></a> as a guide, add a <code>shuffle</code> method to the <code>String</code> class.
</li>
<li>Create three hashes called <code>person1</code>, <code>person2</code>, and <code>person3</code>, with first and last names under the keys <code>:first</code> and <code>:last</code>.<span class="intersentencespace"></span> Then create a <code>params</code> hash so that <code>params[:father]</code> is <code>person1</code>, <code>params[:mother]</code> is <code>person2</code>, and <code>params[:child]</code> is <code>person3</code>.<span class="intersentencespace"></span> Verify that, for example, <code>params[:father][:first]</code> has the right value.
</li>
<li>Find an online version of the Ruby API and read about the <code>Hash</code> method <code>merge</code>.
</li>
<li><strong>(optional)</strong> Follow the <a href="http://rubykoans.com/" target="_blank">Ruby Koans</a><sup id="_cha-4_footnote-ref-16" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-16">16</a></sup> to seek Ruby enlightenment.<span class="intersentencespace"></span>
</li></ol>
<div class="codelisting" id="_code-string_shuffle" data-tralics-id="uid332" data-number="4.10"><div class="heading"><span class="number">Listing 4.10:</span> 

<span class="description">Skeleton for a string shuffle function.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_shuffle</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">string_shuffle</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
</pre></div></div></div><div class="codelisting" id="_code-string_shuffle_two" data-tralics-id="uid333" data-number="4.11"><div class="heading"><span class="number">Listing 4.11:</span> 

<span class="description">Skeleton for a <code>shuffle</code> method attached to the <code>String</code> class.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">shuffle</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">"foobar"</span><span class="o">.</span><span class="n">shuffle</span>
</pre></div></div></div></div>
<div id="cha-4_footnotes">
  <ol class="footnotes">
    <li id="_cha-4_footnote-1">If a helper is specific to a particular controller, you should put it in the corresponding helper file; for example, helpers for the StaticPages controller generally go in <code>app/helpers/static_pages_helper.rb</code>.<span class="intersentencespace"></span> In our case, we expect the <code>full_title</code> helper to be used on all the site’s pages, and Rails has a special helper file for this case: <code>app/helpers/application_helper.rb</code>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-1">↑</a></li>
    <li id="_cha-4_footnote-2">For more on the origins of “foo” and “bar”—and, in particular, the possible <em>non</em>-relation of “foobar” to “FUBAR”—see the <a href="http://www.catb.org/jargon/html/F/foo.html" target="_blank">Jargon File entry on “foo”</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-2">↑</a></li>
    <li id="_cha-4_footnote-3">Programmers familiar with Perl or PHP should compare this to the automatic interpolation of dollar sign variables in expressions like <code>"foo $bar"</code>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-3">↑</a></li>
    <li id="_cha-4_footnote-4">Apologies in advance for switching haphazardly between <em>function</em> and <em>method</em> throughout this chapter; in Ruby, they’re the same thing: all methods are functions, and all functions are methods, because everything is an object.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-4">↑</a></li>
    <li id="_cha-4_footnote-5">Well, there will still be <em>one</em> thing left that we don’t understand, which is how Rails ties this all together: mapping URLs to actions, making the <code>full_title</code> helper available in views, etc.<span class="intersentencespace"></span> This is an interesting subject, and I encourage you to investigate it further, but knowing exactly <em>how</em> Rails works is not necessary when <em>using</em> Rails.<span class="intersentencespace"></span> (For a deeper understanding, I recommend <em>The Rails&nbsp;4 Way</em> by Obie Fernandez.)&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-5">↑</a></li>
    <li id="_cha-4_footnote-6">The <code>second</code> method used here isn’t currently part of Ruby itself, but rather is added by Rails.<span class="intersentencespace"></span> It works in this case because the Rails console automatically includes the Rails extensions to Ruby.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-6">↑</a></li>
    <li id="_cha-4_footnote-7">Programming experts, on the other hand, might benefit from knowing that blocks are <em>closures</em>, which are one-shot anonymous functions with data attached.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-7">↑</a></li>
    <li id="_cha-4_footnote-8">Ruby 1.9 actually guarantees that hashes keep their elements in the same order entered, but it would be unwise ever to count on a particular ordering.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-8">↑</a></li>
    <li id="_cha-4_footnote-9">As a result of having less baggage, symbols are easier to compare to each other; strings need to be compared character by character, while symbols can be compared all in one go.<span class="intersentencespace"></span> This makes them ideal for use as hash keys.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-9">↑</a></li>
    <li id="_cha-4_footnote-10">There’s actually a subtle difference, which is that <code>p</code> returns the object being printed while <code>puts</code> always returns <code>nil</code>.<span class="intersentencespace"></span> Thanks to reader Katarzyna Siwek for pointing this out.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-10">↑</a></li>
    <li id="_cha-4_footnote-11">A newline is what comes at the end of a line, thereby starting a new line.<span class="intersentencespace"></span> In code, it is represented by the character <span class="inline_verbatim">\n</span>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-11">↑</a></li>
    <li id="_cha-4_footnote-12">Actually <em>counting</em> columns could drive you crazy, which is why many text editors have a visual aid to help you.<span class="intersentencespace"></span> For example, if you take a look back at <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-editor_shell" class="hyperref">Figure&nbsp;<span class="ref">1.1</span></a>, you’ll see a small vertical line on the right to help keep code under 80 characters.<span class="intersentencespace"></span> (It’s actually at 78 columns, which gives you a little margin for error.)<span class="intersentencespace"></span> If you use TextMate, you can find this feature under <span class="tt">View &gt; Wrap Column &gt; 78</span>.<span class="intersentencespace"></span> In Sublime Text, you can use <span class="tt">View &gt; Ruler &gt; 78</span> or <span class="tt">View &gt; Ruler &gt; 80</span>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-12">↑</a></li>
    <li id="_cha-4_footnote-13">These results will vary based on the version of Ruby you are using.<span class="intersentencespace"></span> This example assumes you are using Ruby&nbsp;1.9.3.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-13">↑</a></li>
    <li id="_cha-4_footnote-14">For more on Ruby classes and the <code>self</code> keyword, see the <a href="http://railstips.org/" target="_blank">RailsTips</a> post “<a href="http://railstips.org/blog/archives/2006/11/18/class-and-instance-variables-in-ruby/" target="_blank">Class and Instance Variables in Ruby</a>”.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-14">↑</a></li>
    <li id="_cha-4_footnote-15">You don’t have to know what each class in this hierarchy does.<span class="intersentencespace"></span> <em>I</em> don’t know what they all do, and I’ve been programming in Ruby on Rails since 2005.<span class="intersentencespace"></span> This means either that (a) I’m grossly incompetent or (b) you can be a skilled Rails developer without knowing all its innards.<span class="intersentencespace"></span> I hope for both our sakes that it’s the latter.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-15">↑</a></li>
    <li id="_cha-4_footnote-16">http://rubykoans.com/&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-4_footnote-ref-16">↑</a></li>
  </ol>
</div><div id="_cha-filling_in_the_layout" data-tralics-id="cid26" class="chapter" data-number="5"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="heading hyperref"><span class="number">Chapter 5 </span>Filling in the layout</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>In the process of taking a brief tour of Ruby in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-rails_flavored_ruby" class="hyperref">Chapter&nbsp;<span class="ref">4</span></a>, we learned about including the application stylesheet into the sample application—but, as noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-css_revisited" class="hyperref">Section&nbsp;<span class="ref">4.3.4</span></a>, this stylesheet is currently empty.<span class="intersentencespace"></span> In this chapter, we’ll change this by incorporating the <em>Bootstrap</em> framework into our application, and then we’ll add some custom styles of our own.<sup id="_cha-5_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-1">1</a></sup><span class="intersentencespace"></span> We’ll also start filling in the layout with links to the pages (such as Home and About) that we’ve created so far (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-structure" class="hyperref">Section&nbsp;<span class="ref">5.1</span></a>).<span class="intersentencespace"></span> Along the way, we’ll learn about partials, Rails routes, and the asset pipeline, including an introduction to Sass (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass_and_the_asset_pipeline" class="hyperref">Section&nbsp;<span class="ref">5.2</span></a>).<span class="intersentencespace"></span> We’ll also refactor the tests from <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a> using the latest RSpec techniques.<span class="intersentencespace"></span> We’ll end by taking a first important step toward letting users sign up to our site.</p>
</div>
<div id="_sec-structure" data-tralics-id="cid27" class="section" data-number="5.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-structure" class="heading hyperref"><span class="number">5.1 </span>Adding some structure</a></h2>
<p>The <em>Rails Tutorial</em> is a book on web development, not web design, but it would be depressing to work on an application that looks like <em>complete</em> crap, so in this section we’ll add some structure to the layout and give it some minimal styling with CSS. In addition to using some custom CSS rules, we’ll make use of <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a>, an open-source web design framework from Twitter.<span class="intersentencespace"></span> We’ll also give our <em>code</em> some styling, so to speak, using <em>partials</em> to tidy up the layout once it gets a little cluttered.</p>
<p>When building web applications, it is often useful to get a high-level overview of the user interface as early as possible.<span class="intersentencespace"></span> Throughout the rest of this book, I will thus often include <em>mockups</em> (in a web context often called <em>wireframes</em>), which are rough sketches of what the eventual application will look like.<sup id="_cha-5_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-2">2</a></sup><span class="intersentencespace"></span> In this chapter, we will principally be developing the static pages introduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a>, including a site logo, a navigation header, and a site footer.<span class="intersentencespace"></span> A mockup for the most important of these pages, the Home page, appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_page_mockup" class="hyperref">Figure&nbsp;<span class="ref">5.1</span></a>.<span class="intersentencespace"></span> You can see the final result in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-site_with_footer" class="hyperref">Figure&nbsp;<span class="ref">5.7</span></a>.<span class="intersentencespace"></span> You’ll note that it differs in some details—for example, we’ll end up adding a Rails logo on the page—but that’s fine, since a mockup need not be exact.</p>
<div class="center figure" id="_fig-home_page_mockup" data-tralics-id="uid336" data-number="5.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_page_mockup_bootstrap.png" alt="images/figures/home_page_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 5.1: </span><span class="description">A mockup of the sample application’s Home page.
</span></div></div>
<p>As usual, if you’re using Git for version control, now would be a good time to make a new branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b filling-in-layout
</pre></div></div>
<div id="_sec-adding_to_the_layout" data-tralics-id="uid337" class="subsection" data-number="5.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_to_the_layout" class="heading hyperref"><span class="number">5.1.1 </span>Site navigation</a></h3>
<p>As a first step toward adding links and styles to the sample application, we’ll update the site layout file <code>application.html.erb</code> (last seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-application_layout_full_title" class="hyperref">Listing&nbsp;<span class="ref">4.3</span></a>) with additional HTML structure.<span class="intersentencespace"></span> This includes some additional divisions, some CSS classes, and the start of our site navigation.<span class="intersentencespace"></span> The full file is in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_new_structure" class="hyperref">Listing&nbsp;<span class="ref">5.1</span></a>; explanations for the various pieces follow immediately thereafter.<span class="intersentencespace"></span> If you’d rather not delay gratification, you can see the results in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-layout_no_logo_or_custom_css" class="hyperref">Figure&nbsp;<span class="ref">5.2</span></a>.<span class="intersentencespace"></span> (<em>Note:</em> it’s not (yet) very gratifying.)</p>
<div class="codelisting" id="_code-layout_new_structure" data-tralics-id="uid338" data-number="5.1"><div class="heading"><span class="number">Listing 5.1:</span> 

<span class="description">The site layout with added structure.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                           <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">    &lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;</span>
<span class="c">    &lt;![endif]--&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="s1">'#'</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;nav&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/nav&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p>Let’s look at the new elements in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_new_structure" class="hyperref">Listing&nbsp;<span class="ref">5.1</span></a> from top to bottom.<span class="intersentencespace"></span> As alluded to briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-passing_title_tests" class="hyperref">Section&nbsp;<span class="ref">3.3.2</span></a>, Rails&nbsp;4 uses HTML5 by default (as indicated by the doctype <code>&lt;!DOCTYPE html&gt;</code>); since the HTML5 standard is relatively new, some browsers (especially older versions Internet Explorer) don’t fully support it, so we include some JavaScript code (known as an “<a href="http://code.google.com/p/html5shim/" target="_blank">HTML5 shim</a>”) to work around the issue:</p>
<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">&lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;</span>
<span class="c">&lt;![endif]--&gt;</span>
</pre></div></div>
<p>The somewhat odd syntax</p>
<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
</pre></div></div>
<p>includes the enclosed line only if the version of Microsoft Internet Explorer&nbsp;(IE) is less than&nbsp;9 (<code>if lt IE 9</code>).<span class="intersentencespace"></span> The weird <code>[if lt IE 9]</code> syntax is <em>not</em> part of Rails; it’s actually a <a href="http://en.wikipedia.org/wiki/Conditional_comment" target="_blank">conditional comment</a> supported by Internet Explorer browsers for just this sort of situation.<span class="intersentencespace"></span> It’s a good thing, too, because it means we can include the HTML5 shim <em>only</em> for IE browsers less than version&nbsp;9, leaving other browsers such as Firefox, Chrome, and Safari unaffected.</p>
<p>The next section includes a <code>header</code> for the site’s (plain-text) logo, a couple of divisions (using the <code>div</code> tag), and a list of elements with navigation links:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="s1">'#'</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div>
<p>Here the <code>header</code> tag indicates elements that should go at the top of the page.<span class="intersentencespace"></span> We’ve given the <code>header</code> tag three <em>CSS classes</em>,<sup id="_cha-5_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-3">3</a></sup> called <code>navbar</code>, <code>navbar-fixed-top</code>, and <code>navbar-inverse</code>, separated by spaces:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
</pre></div></div>
<p>All HTML elements can be assigned both classes and <em>ids</em>; these are merely labels, and are useful for styling with CSS (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="hyperref">Section&nbsp;<span class="ref">5.1.2</span></a>).<span class="intersentencespace"></span> The main difference between classes and ids is that classes can be used multiple times on a page, but ids can be used only once.<span class="intersentencespace"></span> In the present case, all the navbar classes have special meaning to the Bootstrap framework, which we’ll install and use in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="hyperref">Section&nbsp;<span class="ref">5.1.2</span></a>.</p>
<p>Inside the <code>header</code> tag, we see a couple of <code>div</code> tags:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
</pre></div></div>
<p>The <code>div</code> tag is a generic division; it doesn’t do anything apart from divide the document into distinct parts.<span class="intersentencespace"></span> In older-style HTML, <code>div</code> tags are used for nearly all site divisions, but HTML5 adds the <code>header</code>, <code>nav</code>, and <code>section</code> elements for divisions common to many applications.<span class="intersentencespace"></span> In this case, each <code>div</code> has a CSS class as well.<span class="intersentencespace"></span> As with the <code>header</code> tag’s classes, these classes have special meaning to Bootstrap.</p>
<p>After the divs, we encounter some embedded Ruby:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="s1">'#'</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div></div>
<p>This uses the Rails helper <code>link_to</code> to create links (which we created directly with the anchor tag&nbsp;<code>a</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-passing_title_tests" class="hyperref">Section&nbsp;<span class="ref">3.3.2</span></a>); the first argument to <code>link_to</code> is the link text, while the second is the URL. We’ll fill in the URLs with <em>named routes</em> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-named_routes" class="hyperref">Section&nbsp;<span class="ref">5.3.3</span></a>, but for now we use the stub URL <code>’#’</code> commonly used in web design.<span class="intersentencespace"></span> The third argument is an options hash, in this case adding the CSS&nbsp;id <code>logo</code> to the sample app link.<span class="intersentencespace"></span> (The other three links have no options hash, which is fine since it’s optional.)<span class="intersentencespace"></span> Rails helpers often take options hashes in this way, giving us the flexibility to add arbitrary HTML options without ever leaving Rails.</p>
<p>The second element inside the divs is a list of navigation links, made using the <em>unordered list</em> tag <code>ul</code>, together with the <em>list item</em> tag <code>li</code>:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div></div>
<p>The <code>nav</code> tag, though formally unnecessary here, communicates the purpose of the navigation links.<span class="intersentencespace"></span> The <code>nav</code> and <code>pull-right</code> classes on the <code>ul</code> tag have special meaning to Bootstrap.<span class="intersentencespace"></span> Once Rails has processed this layout and evaluated the embedded Ruby, the list looks like this:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Help<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Sign in<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div></div>
<p>The final part of the layout is a <code>div</code> for the main content:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
<p>As before, the <code>container</code> class has special meaning to Bootstrap.<span class="intersentencespace"></span> As we learned in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layouts" class="hyperref">Section&nbsp;<span class="ref">3.3.4</span></a>, the <code>yield</code> method inserts the contents of each page into the site layout.</p>
<p>Apart from the site footer, which we’ll add in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-partials" class="hyperref">Section&nbsp;<span class="ref">5.1.3</span></a>, our layout is now complete, and we can look at the results by visiting the Home page.<span class="intersentencespace"></span> To take advantage of the upcoming style elements, we’ll add some extra elements to
the <code>home.html.erb</code> view (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_button" class="hyperref">Listing&nbsp;<span class="ref">5.2</span></a>).</p>
<div class="codelisting" id="_code-signup_button" data-tralics-id="uid340" data-number="5.2"><div class="heading"><span class="number">Listing 5.2:</span> 

<span class="description">The Home page with a link to the signup page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center hero-unit"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;h2&gt;</span>
    This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
  <span class="nt">&lt;/h2&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="s1">'#'</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="s2">"Rails"</span><span class="p">),</span> <span class="s1">'http://rubyonrails.org/'</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>In preparation for adding users to our site in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>, the first <code>link_to</code> creates a stub link of the form</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"btn btn-large btn-primary"</span><span class="nt">&gt;</span>Sign up now!<span class="nt">&lt;/a&gt;</span>
</pre></div></div>
<p>In the <code>div</code> tag, the <code>hero-unit</code> CSS class has a special meaning to Bootstrap, as do the <code>btn</code>, <code>btn-large</code>, and <code>btn-primary</code> classes in the signup button.</p>
<p>The second <code>link_to</code> shows off the <code>image_tag</code> helper, which takes as arguments the path to an image and an optional options hash, in this case setting the <code>alt</code> attribute of the image tag using symbols.<span class="intersentencespace"></span> To make this clearer, let’s look at the HTML this tag produces:<sup id="_cha-5_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-4">4</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">alt=</span><span class="s">"Rails"</span> <span class="na">src=</span><span class="s">"/assets/rails.png"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>(Note that the <code>src</code> attribute <em>doesn’t</em> include <code>images</code>; Rails automatically makes the association of the file with the <code>images</code> directory on the server.<span class="intersentencespace"></span> Placing all the assets in the same <code>assets</code> directory allows them to be served faster.)<span class="intersentencespace"></span> The <code>alt</code> attribute is what will be displayed if there is no image, and it is also what will be displayed by screen readers for the visually impaired.<span class="intersentencespace"></span> Although people are sometimes sloppy about including the <code>alt</code> attribute for images, it is in fact required by the HTML standard.<span class="intersentencespace"></span> Luckily, Rails includes a default <code>alt</code> attribute; if you don’t specify the attribute in the call to <code>image_tag</code>, Rails just uses the image filename (minus extension).<span class="intersentencespace"></span> In this case, though, we’ve set the <code>alt</code> text explicitly in order to capitalize “Rails”.</p>
<p>In previous versions of Rails, the <code>rails.png</code> logo was included automatically with every Rails project, but in the latest version it doesn’t get generated as part of <code>rails new</code>, so you should download it from the main Ruby on Rails page at <a href="http://rubyonrails.org/images/rails.png" target="_blank">http://rubyonrails.org/images/rails.png</a> and place it in the <code>app/assets/images/</code> directory.<span class="intersentencespace"></span> (You may also have to create that directory as well, either with <code>mkdir</code> or with a graphical file manager.)<span class="intersentencespace"></span> Because we used the <code>image_tag</code> helper in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_button" class="hyperref">Listing&nbsp;<span class="ref">5.2</span></a>, Rails will automatically find any images in that directory using the asset pipeline (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass_and_the_asset_pipeline" class="hyperref">Section&nbsp;<span class="ref">5.2</span></a>).</p>
<p>Now we’re finally ready to see the fruits of our labors (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-layout_no_logo_or_custom_css" class="hyperref">Figure&nbsp;<span class="ref">5.2</span></a>).<span class="intersentencespace"></span> Pretty underwhelming, you say?<span class="intersentencespace"></span> Perhaps so.<span class="intersentencespace"></span> Happily, though, we’ve done a good job of giving our HTML elements sensible classes, which puts us in a great position to add style to the site with CSS.</p>
<div class="center figure" id="_fig-layout_no_logo_or_custom_css" data-tralics-id="uid342" data-number="5.2">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/layout_no_logo_or_custom_css_bootstrap_rails_4.png" alt="images/figures/layout_no_logo_or_custom_css_bootstrap_rails_4"></div><div class="caption"><span class="header">Figure 5.2: </span><span class="description">The Home page (<a href="http://localhost:3000/static_pages/home" target="_blank">/static_pages/home</a>) with no custom CSS.
</span></div></div>
</div>
<div id="_sec-custom_css" data-tralics-id="uid343" class="subsection" data-number="5.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="heading hyperref"><span class="number">5.1.2 </span>Bootstrap and custom CSS</a></h3>
<p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_to_the_layout" class="hyperref">Section&nbsp;<span class="ref">5.1.1</span></a>, we associated many of the HTML elements with CSS classes, which gives us considerable flexibility in constructing a layout based on CSS. As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_to_the_layout" class="hyperref">Section&nbsp;<span class="ref">5.1.1</span></a>, many of these classes are specific to <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a>, a framework from Twitter that makes it easy to add nice web design and user interface elements to an HTML5 application.<span class="intersentencespace"></span> In this section, we’ll combine Bootstrap with some custom CSS rules to start adding some style to the sample application.</p>
<p>Our first step is to add Bootstrap, which in Rails applications can be accomplished with the <span class="tt">bootstrap-sass</span> gem, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-bootstrap_sass" class="hyperref">Listing&nbsp;<span class="ref">5.3</span></a>.<span class="intersentencespace"></span> (To fix a version incompatibility, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-bootstrap_sass" class="hyperref">Listing&nbsp;<span class="ref">5.3</span></a> also fixes the version of <em>Sprockets</em>, part of the asset pipeline covered in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass_and_the_asset_pipeline" class="hyperref">Section&nbsp;<span class="ref">5.2</span></a>.)<span class="intersentencespace"></span> The Bootstrap framework natively uses the <a href="http://lesscss.org/" target="_blank">LESS CSS</a> language for making dynamic stylesheets, but the Rails asset pipeline supports the (very similar) Sass language by default (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass_and_the_asset_pipeline" class="hyperref">Section&nbsp;<span class="ref">5.2</span></a>), so <span class="tt">bootstrap-sass</span> converts LESS to Sass and makes all the necessary Bootstrap files available to the current application.<sup id="_cha-5_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-5">5</a></sup></p>
<div class="codelisting" id="_code-bootstrap_sass" data-tralics-id="uid345" data-number="5.3"><div class="heading"><span class="number">Listing 5.3:</span> 

<span class="description">Adding the <span class="tt">bootstrap-sass</span> gem to the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'sprockets'</span><span class="p">,</span> <span class="s1">'2.11.0'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>To install Bootstrap, we run <code>bundle install</code> as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>Then restart the web server to incorporate the changes into the development application.<span class="intersentencespace"></span> (On most systems, restarting the server will involve pressing Ctrl-C and then running <code>rails server</code>.)<span class="intersentencespace"></span> Finally, as of Rails&nbsp;4.0 we need to add a line to <code>config/application.rb</code> to make <span class="tt">bootstrap-sass</span> compatible with the asset pipeline, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-bootstrap_config" class="hyperref">Listing&nbsp;<span class="ref">5.4</span></a>.</p>
<div class="codelisting" id="_code-bootstrap_config" data-tralics-id="uid346" data-number="5.4"><div class="heading"><span class="number">Listing 5.4:</span> 

<span class="description">Adding a line for asset pipeline compatibility.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/application.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../boot'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="sx">%w(*.png *.jpg *.jpeg *.gif)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The first step in adding custom CSS to our application is to open a file to contain it:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> subl app/assets/stylesheets/custom.css.scss
</pre></div></div>
<p>Here both the directory name and filename are important.<span class="intersentencespace"></span> The directory</p>
<div class="code"><div class="highlight"><pre><span class="go">app/assets/stylesheets</span>
</pre></div></div>
<p>is part of the asset pipeline (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass_and_the_asset_pipeline" class="hyperref">Section&nbsp;<span class="ref">5.2</span></a>), and any stylesheets in this directory will automatically be included as part of the <code>application.css</code> file included in the site layout.<span class="intersentencespace"></span> Furthermore, the filename <code>custom.css.scss</code> includes the <code>.css</code> extension, which indicates a CSS file, and the <code>.scss</code> extension, which indicates a “Sassy CSS” file and arranges for the asset pipeline to process the file using Sass.<span class="intersentencespace"></span> (We won’t be using Sass until <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass" class="hyperref">Section&nbsp;<span class="ref">5.2.2</span></a>, but it’s needed now for the <span class="tt">bootstrap-sass</span> gem to work its magic.)</p>
<p>Inside the file for custom CSS, we can use the <code>@import</code> function to include Bootstrap, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-bootstrap_css" class="hyperref">Listing&nbsp;<span class="ref">5.5</span></a>.</p>
<div class="codelisting" id="_code-bootstrap_css" data-tralics-id="uid347" data-number="5.5"><div class="heading"><span class="number">Listing 5.5:</span> 

<span class="description">Adding Bootstrap CSS. <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>
</pre></div></div></div><p>This one line includes the entire Bootstrap CSS framework, with the result shown in in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sample_app_only_bootstrap" class="hyperref">Figure&nbsp;<span class="ref">5.3</span></a>.<span class="intersentencespace"></span> (You may have to use Ctrl-C to restart the local web server.<span class="intersentencespace"></span> It’s also worth noting that the screenshots use Bootstrap&nbsp;2.0, whereas the tutorial currently uses Bootstrap&nbsp;2.3, so there may be minor differences in appearance.<span class="intersentencespace"></span> These are not cause for concern.)<span class="intersentencespace"></span> The placement of the text isn’t good and the logo doesn’t have any style, but the colors and signup button look promising.</p>
<div class="center figure" id="_fig-sample_app_only_bootstrap" data-tralics-id="uid348" data-number="5.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/sample_app_only_bootstrap_4_0.png" alt="images/figures/sample_app_only_bootstrap_4_0"></div><div class="caption"><span class="header">Figure 5.3: </span><span class="description">The sample application with Bootstrap CSS.
</span></div></div>
<p>Next we’ll add some CSS that will be used site-wide for styling the layout and each individual page, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-universal_css" class="hyperref">Listing&nbsp;<span class="ref">5.6</span></a>.<span class="intersentencespace"></span> There are quite a few rules in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-universal_css" class="hyperref">Listing&nbsp;<span class="ref">5.6</span></a>; to get a sense of what a CSS rule does, it’s often helpful to comment it out using CSS comments, i.e., by putting it inside <code>/* … */</code>, and seeing what changes.<span class="intersentencespace"></span> The result of the CSS in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-universal_css" class="hyperref">Listing&nbsp;<span class="ref">5.6</span></a> is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sample_app_universal" class="hyperref">Figure&nbsp;<span class="ref">5.4</span></a>.</p>
<div class="codelisting" id="_code-universal_css" data-tralics-id="uid349" data-number="5.6"><div class="heading"><span class="number">Listing 5.6:</span> 

<span class="description">Adding CSS for some universal styling applying to all pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>

<span class="cm">/* universal */</span>

<span class="nt">html</span> <span class="p">{</span>
  <span class="na">overflow-y</span><span class="o">:</span> <span class="no">scroll</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">textarea</span> <span class="p">{</span>
  <span class="na">resize</span><span class="o">:</span> <span class="n">vertical</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="nt">h1</span> <span class="p">{</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="_fig-sample_app_universal" data-tralics-id="uid350" data-number="5.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/sample_app_universal_4_0.png" alt="images/figures/sample_app_universal_4_0"></div><div class="caption"><span class="header">Figure 5.4: </span><span class="description">Adding some spacing and other universal styling.
</span></div></div>
<p>Note that the CSS in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-universal_css" class="hyperref">Listing&nbsp;<span class="ref">5.6</span></a> has a consistent form.<span class="intersentencespace"></span> In general, CSS rules refer either to a class, an id, an HTML tag, or some combination thereof, followed by a list of styling commands.<span class="intersentencespace"></span> For example,</p>
<div class="code"><div class="highlight"><pre><span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p>puts 60&nbsp;pixels of padding at the top of the page.<span class="intersentencespace"></span> Because of the <code>navbar-fixed-top</code> class in the <code>header</code> tag, Bootstrap fixes the navigation bar to the top of the page, so the padding serves to separate the main text from the navigation.<span class="intersentencespace"></span> (Because the default navbar color changed between Bootstrap 2.0 and 2.1, we need the <code>navbar-inverse</code> class to make it dark instead of light.)<span class="intersentencespace"></span> Meanwhile, the CSS in the rule</p>
<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p>associates the <code>center</code> class with the <code>text-align: center</code> property.<span class="intersentencespace"></span> In other words, the dot <code>.</code><span class="intersentencespace"></span> in <code>.center</code> indicates that the rule styles a class.<span class="intersentencespace"></span> (As we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-logo_css" class="hyperref">Listing&nbsp;<span class="ref">5.8</span></a>, the pound sign <code>#</code> identifies a rule to style a CSS <em>id</em>.)<span class="intersentencespace"></span> This means that elements inside any tag (such as a <code>div</code>) with class <code>center</code> will be centered on the page.<span class="intersentencespace"></span> (We saw an example of this class in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_button" class="hyperref">Listing&nbsp;<span class="ref">5.2</span></a>.)</p>
<p>Although Bootstrap comes with CSS rules for nice typography, we’ll also add some custom rules for the appearance of the text on our site, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-typography_css" class="hyperref">Listing&nbsp;<span class="ref">5.7</span></a>.<span class="intersentencespace"></span> (Not all of these rules apply to the Home page, but each rule here will be used at some point in the sample application.)<span class="intersentencespace"></span> The result of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-typography_css" class="hyperref">Listing&nbsp;<span class="ref">5.7</span></a> is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sample_app_typography" class="hyperref">Figure&nbsp;<span class="ref">5.5</span></a>.</p>
<div class="codelisting" id="_code-typography_css" data-tralics-id="uid351" data-number="5.7"><div class="heading"><span class="number">Listing 5.7:</span> 

<span class="description">Adding CSS for nice typography.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">typography</span> <span class="o">*/</span>

<span class="nt">h1</span><span class="o">,</span> <span class="nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class="o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class="nt">h5</span><span class="o">,</span> <span class="nt">h6</span> <span class="p">{</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">3</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-2</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.2</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">p</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="_fig-sample_app_typography" data-tralics-id="uid352" data-number="5.5">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/sample_app_typography_4_0.png" alt="images/figures/sample_app_typography_4_0"></div><div class="caption"><span class="header">Figure 5.5: </span><span class="description">Adding some typographic styling.
</span></div></div>
<p>Finally, we’ll add some rules to style the site’s logo, which simply consists of the text “sample app”.<span class="intersentencespace"></span> The CSS in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-logo_css" class="hyperref">Listing&nbsp;<span class="ref">5.8</span></a> converts the text to uppercase and modifies its size, color, and placement.<span class="intersentencespace"></span> (We’ve used a CSS&nbsp;id because we expect the site logo to appear on the page only once, but you could use a class instead.)</p>
<div class="codelisting" id="_code-logo_css" data-tralics-id="uid353" data-number="5.8"><div class="heading"><span class="number">Listing 5.8:</span> 

<span class="description">Adding CSS for the site logo.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">header</span> <span class="o">*/</span>

<span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nn">#logo</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><p>Here <code>color: #fff</code> changes the color of the logo to white.<span class="intersentencespace"></span> HTML colors can be coded with three pairs of base-16 (hexadecimal) numbers, one each for the primary colors red, green, and blue (in that order).<span class="intersentencespace"></span> The code <code>#ffffff</code> maxes out all three colors, yielding pure white, and <code>#fff</code> is a shorthand for the full <code>#ffffff</code>.<span class="intersentencespace"></span> The CSS standard also defines a large number of synonyms for common <a href="http://www.w3schools.com/html/html_colornames.asp" target="_blank">HTML colors</a>, including <code>white</code> for <code>#fff</code>.<span class="intersentencespace"></span> The result of the CSS in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-logo_css" class="hyperref">Listing&nbsp;<span class="ref">5.8</span></a> is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sample_app_logo" class="hyperref">Figure&nbsp;<span class="ref">5.6</span></a>.</p>
<div class="center figure" id="_fig-sample_app_logo" data-tralics-id="uid354" data-number="5.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/sample_app_logo_4_0.png" alt="images/figures/sample_app_logo_4_0"></div><div class="caption"><span class="header">Figure 5.6: </span><span class="description">The sample app with nicely styled logo.
</span></div></div>
</div>
<div id="_sec-partials" data-tralics-id="uid355" class="subsection" data-number="5.1.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-partials" class="heading hyperref"><span class="number">5.1.3 </span>Partials</a></h3>
<p>Although the layout in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_new_structure" class="hyperref">Listing&nbsp;<span class="ref">5.1</span></a> serves its purpose, it’s getting a little cluttered.<span class="intersentencespace"></span> The HTML shim takes up three lines and uses weird IE-specific syntax, so it would be nice to tuck it away somewhere on its own.<span class="intersentencespace"></span> In addition, the header HTML forms a logical unit, so it should all be packaged up in one place.<span class="intersentencespace"></span> The way to achieve this in Rails is to use a facility called <em>partials</em>.<span class="intersentencespace"></span> Let’s first take a look at what the layout looks like after the partials are defined (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_with_partials" class="hyperref">Listing&nbsp;<span class="ref">5.9</span></a>).</p>
<div class="codelisting" id="_code-layout_with_partials" data-tralics-id="uid356" data-number="5.9"><div class="heading"><span class="number">Listing 5.9:</span> 

<span class="description">The site layout with partials for the stylesheets and header.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                           <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/shim'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/header'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_with_partials" class="hyperref">Listing&nbsp;<span class="ref">5.9</span></a>, we’ve replaced the HTML shim stylesheet lines with a single call to a Rails helper called <code>render</code>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/shim'</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The effect of this line is to look for a file called <code>app/views/layouts/_shim.html.erb</code>, evaluate its contents, and insert the results into the view.<sup id="_cha-5_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-6">6</a></sup><span class="intersentencespace"></span> (Recall that <span class="inline_verbatim">&lt;%= ... %&gt;</span> is the embedded Ruby syntax needed to evaluate a Ruby expression and then insert the results into the template.)<span class="intersentencespace"></span> Note the leading underscore on the filename <code>_shim.html.erb</code>; this underscore is the universal convention for naming partials, and among other things makes it possible to identify all the partials in a directory at a glance.</p>
<p>Of course, to get the partial to work, we have to fill it with some content; in the case of the shim partial, this is just the three lines of shim code from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_new_structure" class="hyperref">Listing&nbsp;<span class="ref">5.1</span></a>; the result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-stylesheets_partial" class="hyperref">Listing&nbsp;<span class="ref">5.10</span></a>.</p>
<div class="codelisting" id="_code-stylesheets_partial" data-tralics-id="uid358" data-number="5.10"><div class="heading"><span class="number">Listing 5.10:</span> 

<span class="description">A partial for the HTML shim.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_shim.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">&lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;</span>
<span class="c">&lt;![endif]--&gt;</span>
</pre></div></div></div><p>Similarly, we can move the header material into the partial shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-header_partial" class="hyperref">Listing&nbsp;<span class="ref">5.11</span></a> and insert it into the layout with another call to <code>render</code>.</p>
<div class="codelisting" id="_code-header_partial" data-tralics-id="uid359" data-number="5.11"><div class="heading"><span class="number">Listing 5.11:</span> 

<span class="description">A partial for the site header.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="s1">'#'</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div><p>Now that we know how to make partials, let’s add a site footer to go along with the header.<span class="intersentencespace"></span> By now you can probably guess that we’ll call it <code>_footer.html.erb</code> and put it in the layouts directory (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-footer_partial" class="hyperref">Listing&nbsp;<span class="ref">5.12</span></a>).<sup id="_cha-5_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-7">7</a></sup></p>
<div class="codelisting" id="_code-footer_partial" data-tralics-id="uid361" data-number="5.12"><div class="heading"><span class="number">Listing 5.12:</span> 

<span class="description">A partial for the site footer.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_footer.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"footer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;small&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    by Michael Hartl
  <span class="nt">&lt;/small&gt;</span>
  <span class="nt">&lt;nav&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"About"</span><span class="p">,</span>   <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Contact"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://news.railstutorial.org/"</span><span class="nt">&gt;</span>News<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</pre></div></div></div><p>As with the header, in the footer we’ve used <code>link_to</code> for the internal links to the About and Contact pages and stubbed out the URLs with <code>’#’</code> for now.<span class="intersentencespace"></span> (As with <code>header</code>, the <code>footer</code> tag is new in HTML5.)</p>
<p>We can render the footer partial in the layout by following the same pattern as the stylesheets and header partials (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_with_footer" class="hyperref">Listing&nbsp;<span class="ref">5.13</span></a>).</p>
<div class="codelisting" id="_code-layout_with_footer" data-tralics-id="uid362" data-number="5.13"><div class="heading"><span class="number">Listing 5.13:</span> 

<span class="description">The site layout with a footer partial.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span>
                                           <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/shim'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/header'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/footer'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p>Of course, the footer will be ugly without some styling (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-footer_css" class="hyperref">Listing&nbsp;<span class="ref">5.14</span></a>).<span class="intersentencespace"></span> The results appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-site_with_footer" class="hyperref">Figure&nbsp;<span class="ref">5.7</span></a>.</p>
<div class="codelisting" id="_code-footer_css" data-tralics-id="uid363" data-number="5.14"><div class="heading"><span class="number">Listing 5.14:</span> 

<span class="description">Adding the CSS for the site footer.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">footer</span> <span class="o">*/</span>

<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#eaeaea</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">a</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#555</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#222</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">small</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">ul</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">ul</span> <span class="nt">li</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="_fig-site_with_footer" data-tralics-id="uid364" data-number="5.7">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/site_with_footer_bootstrap_4_0.png" alt="images/figures/site_with_footer_bootstrap_4_0"></div><div class="caption"><span class="header">Figure 5.7: </span><span class="description">The Home page (<a href="http://localhost:3000/static_pages/home" target="_blank">/static_pages/home</a>) with an added footer.
</span></div></div>
</div></div>
<div id="_sec-sass_and_the_asset_pipeline" data-tralics-id="cid28" class="section" data-number="5.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass_and_the_asset_pipeline" class="heading hyperref"><span class="number">5.2 </span>Sass and the asset pipeline</a></h2>
<p>One of the most notable additions in recent versions of Rails is the asset pipeline, which significantly improves the production and management of static assets such as CSS, JavaScript, and images.<span class="intersentencespace"></span> This section gives a high-level overview of the asset pipeline and then shows how to use a remarkable tool for making CSS called <em>Sass</em>, now included by default as part of the asset pipeline.</p>
<div id="_sec-the_asset_pipeline" data-tralics-id="uid365" class="subsection" data-number="5.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_asset_pipeline" class="heading hyperref"><span class="number">5.2.1 </span>The asset pipeline</a></h3>
<p>The asset pipeline involves lots of changes under Rails’ hood, but from the perspective of a typical Rails developer there are three principal features to understand: asset directories, manifest files, and preprocessor engines.<sup id="_cha-5_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-8">8</a></sup><span class="intersentencespace"></span> Let’s consider each in turn.</p>
<div id="_uid367" data-tralics-id="uid367" class="subsubsection" data-number="5.2.1.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid367" class="heading">Asset directories</a></h4>
<p>In versions of Rails before 3.0 (including 3.0 itself), static assets lived in the <code>public/</code> directory, as follows:</p>
<ul>
<li><code>public/stylesheets</code>
</li>
<li><code>public/javascripts</code>
</li>
<li><code>public/images</code>
</li></ul>
<p>Files in these directories are (even post-3.0) automatically served up via requests to http://example.com/stylesheets, etc.</p>
<p>Starting in Rails 3.1, and continuing in Rails&nbsp;4, there are <em>three</em> canonical directories for static assets, each with its own purpose:</p>
<ul>
<li><code>app/assets</code>: assets specific to the present application
</li>
<li><code>lib/assets</code>: assets for libraries written by your dev team
</li>
<li><code>vendor/assets</code>: assets from third-party vendors
</li></ul>
<p>As you might guess, each of these directories has a subdirectory for each asset class, e.g.,</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> ls app/assets/
<span class="go">images      javascripts stylesheets</span>
</pre></div></div>
<p>At this point, we’re in a position to understand the motivation behind the location of the <code>custom.css.scss</code> file in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="hyperref">Section&nbsp;<span class="ref">5.1.2</span></a>: <code>custom.css.scss</code> is specific to the sample application, so it goes in <code>app/assets/stylesheets</code>.</p>
</div>
<div id="_uid374" data-tralics-id="uid374" class="subsubsection" data-number="5.2.1.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid374" class="heading">Manifest files</a></h4>
<p>Once you’ve placed your assets in their logical locations, you can use <em>manifest files</em> to tell Rails (via the <a href="https://github.com/sstephenson/sprockets" target="_blank">Sprockets</a> gem) how to combine them to form single files.<span class="intersentencespace"></span> (This applies to CSS and JavaScript but not to images.)<span class="intersentencespace"></span> As an example, let’s take a look at the default manifest file for app stylesheets (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-app_css_manifest" class="hyperref">Listing&nbsp;<span class="ref">5.15</span></a>).</p>
<div class="codelisting" id="_code-app_css_manifest" data-tralics-id="uid375" data-number="5.15"><div class="heading"><span class="number">Listing 5.15:</span> 

<span class="description">The manifest file for app-specific CSS. <span class="break"></span> <span class="filepath">app/assets/stylesheets/application.css</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This is a manifest file that'll automatically include all the stylesheets</span>
<span class="cm"> * available in this directory and any sub-directories. You're free to add</span>
<span class="cm"> * application-wide styles to this file and they'll appear at the top of the</span>
<span class="cm"> * compiled file, but it's generally better to create a new file per style</span>
<span class="cm"> * scope.</span>
<span class="cm"> *= require_self</span>
<span class="cm"> *= require_tree .</span>
<span class="cm">*/</span>
</pre></div></div></div><p>The key lines here are actually CSS comments, but they are used by Sprockets to include the proper files:</p>
<div class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> .</span>
<span class="cm"> .</span>
<span class="cm"> .</span>
<span class="cm"> *= require_self</span>
<span class="cm"> *= require_tree .</span>
<span class="cm">*/</span>
</pre></div></div>
<p>Here</p>
<div class="code"><div class="highlight"><pre><span class="go">*= require_tree .</span>
</pre></div></div>
<p>ensures that all CSS files in the <code>app/assets/stylesheets</code> directory (including the tree subdirectories) are included into the application CSS. The line</p>
<div class="code"><div class="highlight"><pre><span class="go">*= require_self</span>
</pre></div></div>
<p>specifies where in the loading sequence the CSS in <code>application.css</code> itself gets included.</p>
<p>Rails comes with sensible default manifest files, and in the <em>Rails Tutorial</em> we won’t need to make any changes, but the <a href="http://guides.rubyonrails.org/asset_pipeline.html" target="_blank">Rails Guides entry on the asset pipeline</a> has more detail if you need it.</p>
</div>
<div id="_uid376" data-tralics-id="uid376" class="subsubsection" data-number="5.2.1.3"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid376" class="heading">Preprocessor engines</a></h4>
<p>After you’ve assembled your assets, Rails prepares them for the site template by running them through several preprocessing engines and using the manifest files to combine them for delivery to the browser.<span class="intersentencespace"></span> We tell Rails which processor to use using filename extensions; the three most common cases are <code>.scss</code> for Sass, <code>.coffee</code> for CoffeeScript, and <code>.erb</code> for embedded Ruby (ERb).<span class="intersentencespace"></span> We first covered ERb in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-embedded_ruby" class="hyperref">Section&nbsp;<span class="ref">3.3.3</span></a>, and cover Sass in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass" class="hyperref">Section&nbsp;<span class="ref">5.2.2</span></a>.<span class="intersentencespace"></span> We won’t be needing CoffeeScript in this tutorial, but it’s an elegant little language that compiles to JavaScript.<span class="intersentencespace"></span> (The <a href="http://railscasts.com/episodes/267-coffeescript-basics" target="_blank">RailsCast on CoffeeScript basics</a> is a good place to start.)</p>
<p>The preprocessor engines can be chained, so that</p>
<p><code>foobar.js.coffee</code></p>
<p>gets run through the CoffeeScript processor, and</p>
<p><code>foobar.js.erb.coffee</code></p>
<p>gets run through both CoffeeScript and ERb (with the code running from right to left, i.e., CoffeeScript first).</p>
</div>
<div id="_uid377" data-tralics-id="uid377" class="subsubsection" data-number="5.2.1.4"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid377" class="heading">Efficiency in production</a></h4>
<p>One of the best things about the asset pipeline is that it automatically results in assets that are optimized to be efficient in a production application.<span class="intersentencespace"></span> Traditional methods for organizing CSS and JavaScript involve splitting functionality into separate files and using nice formatting (with lots of indentation).<span class="intersentencespace"></span> While convenient for the programmer, this is inefficient in production; including multiple full-sized files can significantly slow page-load times (one of the most important factors affecting the quality of the user experience).<span class="intersentencespace"></span> With the asset pipeline, in production all the application stylesheets get rolled into one CSS file (<code>application.css</code>), all the application JavaScript code gets rolled into one JavaScript file (<code>javascripts.js</code>), and all such files (including those in <code>lib/assets</code> and <code>vendor/assets</code>) are <em>minified</em> to remove the unnecessary whitespace that bloats file size.<span class="intersentencespace"></span> As a result, we get the best of both worlds: multiple nicely formatted files for programmer convenience, with single optimized files in production.</p>
</div></div>
<div id="_sec-sass" data-tralics-id="uid378" class="subsection" data-number="5.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sass" class="heading hyperref"><span class="number">5.2.2 </span>Syntactically awesome stylesheets</a></h3>
<p><em>Sass</em> is a language for writing stylesheets that improves on CSS in many ways.<span class="intersentencespace"></span> In this section, we cover two of the most important improvements, <em>nesting</em> and <em>variables</em>.<span class="intersentencespace"></span> (A third technique, <em>mixins</em>, is introduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_environments" class="hyperref">Section&nbsp;<span class="ref">7.1.1</span></a>.)</p>
<p>As noted briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="hyperref">Section&nbsp;<span class="ref">5.1.2</span></a>, Sass supports a format called SCSS (indicated with a <code>.scss</code> filename extension), which is a strict superset of CSS itself; that is, SCSS only <em>adds</em> features to CSS, rather than defining an entirely new syntax.<sup id="_cha-5_footnote-ref-9" class="footnote intersentence"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-9">9</a></sup><span class="intersentencespace"></span> This means that every valid CSS file is also a valid SCSS file, which is convenient for projects with existing style rules.<span class="intersentencespace"></span> In our case, we used SCSS from the start in order to take advantage of Bootstrap.<span class="intersentencespace"></span> Since the Rails asset pipeline automatically uses Sass to process files with the <code>.scss</code> extension, the <code>custom.css.scss</code> file will be run through the Sass preprocessor before being packaged up for delivery to the browser.</p>
<div id="_uid380" data-tralics-id="uid380" class="subsubsection" data-number="5.2.2.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid380" class="heading">Nesting</a></h4>
<p>A common pattern in stylesheets is having rules that apply to nested elements.<span class="intersentencespace"></span> For example, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-universal_css" class="hyperref">Listing&nbsp;<span class="ref">5.6</span></a> we have rules both for <code>.center</code> and for <code>.center h1</code>:</p>
<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="nt">h1</span> <span class="p">{</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p>We can replace this in Sass with</p>
<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="nt">h1</span> <span class="p">{</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
<p>Here the nested <code>h1</code> rule automatically inherits the <code>.center</code> context.</p>
<p>There’s a second candidate for nesting that requires a slightly different syntax.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-logo_css" class="hyperref">Listing&nbsp;<span class="ref">5.8</span></a>, we have the code</p>
<div class="code"><div class="highlight"><pre><span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nn">#logo</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p>Here the logo id <code>#logo</code> appears twice, once by itself and once with the <code>hover</code> attribute (which controls its appearance when the mouse pointer hovers over the element in question).<span class="intersentencespace"></span> In order to nest the second rule, we need to reference the parent element <code>#logo</code>; in SCSS, this is accomplished with the ampersand character&nbsp;<code>&amp;</code> as follows:</p>
<div class="code"><div class="highlight"><pre><span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
    <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
<p>Sass changes <code>&amp;:hover</code> into <code>#logo:hover</code> as part of converting from SCSS to CSS.</p>
<p>Both of these nesting techniques apply to the footer CSS in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-footer_css" class="hyperref">Listing&nbsp;<span class="ref">5.14</span></a>, which can be transformed into the following:</p>
<div class="code"><div class="highlight"><pre><span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#eaeaea</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="mh">#555</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">color</span><span class="o">:</span> <span class="mh">#222</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">small</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="nt">li</span> <span class="p">{</span>
      <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
<p>Converting <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-footer_css" class="hyperref">Listing&nbsp;<span class="ref">5.14</span></a> by hand is a good exercise, and you should verify that the CSS still works properly after the conversion.</p>
</div>
<div id="_uid381" data-tralics-id="uid381" class="subsubsection" data-number="5.2.2.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#uid381" class="heading">Variables</a></h4>
<p>Sass allows us to define <em>variables</em> to eliminate duplication and write more expressive code.<span class="intersentencespace"></span> For example, looking at <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-typography_css" class="hyperref">Listing&nbsp;<span class="ref">5.7</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-footer_css" class="hyperref">Listing&nbsp;<span class="ref">5.14</span></a>, we see that there are repeated references to the same color:</p>
<div class="code"><div class="highlight"><pre><span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p>In this case, <code>#999</code> is a light gray, and we can give it a name by defining a variable as follows:</p>
<div class="code"><div class="highlight"><pre><span class="nv">$lightGray</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
</pre></div></div>
<p>This allows us to rewrite our SCSS like this:</p>
<div class="code"><div class="highlight"><pre><span class="nv">$lightGray</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$lightGray</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$lightGray</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p>Because variable names such as <code>$lightGray</code> are more descriptive than <code>#999</code>, it’s often useful to define variables even for values that aren’t repeated.<span class="intersentencespace"></span> Indeed, the Bootstrap framework defines a large number of variables for colors, available online on the <a href="http://bootstrapdocs.com/v2.0.4/docs/less.html" target="_blank">Bootstrap page of LESS variables</a>.<span class="intersentencespace"></span> That page defines variables using LESS, not Sass, but the <span class="tt">bootstrap-sass</span> gem provides the Sass equivalents.<span class="intersentencespace"></span> It is not difficult to guess the correspondence; where LESS uses an “at” sign&nbsp;<code>@</code>, Sass uses a dollar sign&nbsp;<code>$</code>.<span class="intersentencespace"></span> Looking the Bootstrap variable page, we see that there is a variable for light gray:</p>
<div class="code"><div class="highlight"><pre> <span class="k">@grayLight</span><span class="nd">:</span> <span class="nn">#999</span><span class="o">;</span>
</pre></div></div>
<p>This means that, via the <span class="tt">bootstrap-sass</span> gem, there should be a corresponding SCSS variable <code>$grayLight</code>.<span class="intersentencespace"></span> We can use this to replace our custom variable, <code>$lightGray</code>, which gives</p>
<div class="code"><div class="highlight"><pre><span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p>Applying the Sass nesting and variable definition features to the full SCSS file gives the file in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-refactored_scss" class="hyperref">Listing&nbsp;<span class="ref">5.16</span></a>.<span class="intersentencespace"></span> This uses both Sass variables (as inferred from the Bootstrap LESS variable page) and built-in named colors (i.e., <code>white</code> for <code>#fff</code>).<span class="intersentencespace"></span> Note in particular the dramatic improvement in the rules for the <code>footer</code> tag.</p>
<div class="codelisting" id="_code-refactored_scss" data-tralics-id="uid382" data-number="5.16"><div class="heading"><span class="number">Listing 5.16:</span> 

<span class="description">The initial SCSS file converted to use nesting and variables.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="cm">/* universal */</span>

<span class="nt">html</span> <span class="p">{</span>
  <span class="na">overflow-y</span><span class="o">:</span> <span class="no">scroll</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">textarea</span> <span class="p">{</span>
  <span class="na">resize</span><span class="o">:</span> <span class="n">vertical</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="nt">h1</span> <span class="p">{</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* typography */</span>

<span class="nt">h1</span><span class="o">,</span> <span class="nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class="o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class="nt">h5</span><span class="o">,</span> <span class="nt">h6</span> <span class="p">{</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">3</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-2</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.2</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">p</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* header */</span>

<span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
    <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* footer */</span>

<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayMediumLight</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nv">$gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">color</span><span class="o">:</span> <span class="nv">$grayDarker</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">small</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="nt">li</span> <span class="p">{</span>
      <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div><p>Sass gives us even more ways to simplify our stylesheets, but the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-refactored_scss" class="hyperref">Listing&nbsp;<span class="ref">5.16</span></a> uses the most important features and gives us a great start.<span class="intersentencespace"></span> See the <a href="http://sass-lang.com/" target="_blank">Sass website</a> for more details.</p>
</div></div></div>
<div id="_sec-layout_links" data-tralics-id="cid29" class="section" data-number="5.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_links" class="heading hyperref"><span class="number">5.3 </span>Layout links</a></h2>
<p>Now that we’ve finished a site layout with decent styling, it’s time to start filling in the links we’ve stubbed out with <code>’#’</code>.<span class="intersentencespace"></span> Of course, we could hard-code links like</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/static_pages/about"</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
</pre></div></div>
<p>but that isn’t the Rails Way.<span class="intersentencespace"></span> For one, it would be nice if the URL for the about page were /about rather than /static_pages/about.<span class="intersentencespace"></span> Moreover, Rails conventionally uses <em>named routes</em>, which involves code like</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"About"</span><span class="p">,</span> <span class="n">about_path</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This way the code has a more transparent meaning, and it’s also more flexible since we can change the definition of <code>about_path</code> and have the URL change everywhere <code>about_path</code> is used.</p>
<p>The full list of our planned links appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-url_mapping" class="hyperref">Table&nbsp;<span class="ref">5.1</span></a>, along with their mapping to URLs and routes.<span class="intersentencespace"></span> We’ll implement all but the last one by the end of this chapter.<span class="intersentencespace"></span> (We’ll make the last one in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>.)</p>
<div class="table" id="_table-url_mapping" data-tralics-id="uid383" data-number="5.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>Page</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_right"><strong>Named route</strong></td>
</tr><tr><td class="align_left">Home</td>
<td class="align_left">/</td>
<td class="align_right"><code>root_path</code></td>
</tr><tr><td class="align_left">About</td>
<td class="align_left">/about</td>
<td class="align_right"><code>about_path</code></td>
</tr><tr><td class="align_left">Help</td>
<td class="align_left">/help</td>
<td class="align_right"><code>help_path</code></td>
</tr><tr><td class="align_left">Contact</td>
<td class="align_left">/contact</td>
<td class="align_right"><code>contact_path</code></td>
</tr><tr><td class="align_left">Sign up</td>
<td class="align_left">/signup</td>
<td class="align_right"><code>signup_path</code></td>
</tr><tr><td class="align_left">Sign in</td>
<td class="align_left">/signin</td>
<td class="align_right"><code>signin_path</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 5.1: </span><span class="description">Route and URL mapping for site links.
</span></div></div>
<p>Before moving on, let’s add a Contact page (left as an exercise in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a>).<span class="intersentencespace"></span> The test appears as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_page_test" class="hyperref">Listing&nbsp;<span class="ref">5.17</span></a>, which simply follows the model last seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_title" class="hyperref">Listing&nbsp;<span class="ref">3.19</span></a>.</p>
<div class="codelisting" id="_code-contact_page_test" data-tralics-id="uid384" data-number="5.17"><div class="heading"><span class="number">Listing 5.17:</span> 

<span class="description">Tests for a Contact page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"Contact page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Contact'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/contact'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Contact'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'Contact'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">'/static_pages/contact'</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | Contact"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To ensure that both of the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_page_test" class="hyperref">Listing&nbsp;<span class="ref">5.17</span></a> fail, we need to comment out the “Contact” link in the footer, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-comment_out_footer" class="hyperref">Listing&nbsp;<span class="ref">5.18</span></a>.</p>
<div class="codelisting" id="_code-comment_out_footer" data-tralics-id="uid385" data-number="5.18"><div class="heading"><span class="number">Listing 5.18:</span> 

<span class="description">Commenting out the “Contact” link in the footer.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_footer.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"footer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;small&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    by Michael Hartl
  <span class="nt">&lt;/small&gt;</span>
  <span class="nt">&lt;nav&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"About"</span><span class="p">,</span>   <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%#</span><span class="c">= link_to "Contact", '#' </span><span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://news.railstutorial.org/"</span><span class="nt">&gt;</span>News<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</pre></div></div></div><p>We see from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-comment_out_footer" class="hyperref">Listing&nbsp;<span class="ref">5.18</span></a> how to comment out code in Embedded Ruby, which involves placing a Ruby comment character&nbsp;<code>#</code> immediately after the percent sign:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%#</span><span class="c">= link_to "Contact", '#' </span><span class="cp">%&gt;</span>
</pre></div></div>
<p>At this point, the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_page_test" class="hyperref">Listing&nbsp;<span class="ref">5.17</span></a> should fail:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>The application code parallels the addition of the About page in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_page" class="hyperref">Section <span class="ref">3.2.2</span></a>: first we update the routes (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_route" class="hyperref">Listing&nbsp;<span class="ref">5.19</span></a>), then we add a <code>contact</code> action to the StaticPages controller (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_action" class="hyperref">Listing&nbsp;<span class="ref">5.20</span></a>), and finally we create a Contact view (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_view" class="hyperref">Listing&nbsp;<span class="ref">5.21</span></a>).</p>
<div class="codelisting" id="_code-contact_route" data-tralics-id="uid386" data-number="5.19"><div class="heading"><span class="number">Listing 5.19:</span> 

<span class="description">Adding a route for the Contact page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"static_pages/home"</span>
  <span class="n">get</span> <span class="s2">"static_pages/help"</span>
  <span class="n">get</span> <span class="s2">"static_pages/about"</span>
  <span class="n">get</span> <span class="s2">"static_pages/contact"</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-contact_action" data-tralics-id="uid387" data-number="5.20"><div class="heading"><span class="number">Listing 5.20:</span> 

<span class="description">Adding an action for the Contact page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-contact_view" data-tralics-id="uid388" data-number="5.21"><div class="heading"><span class="number">Listing 5.21:</span> 

<span class="description">The view for the Contact page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/contact.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Contact'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Contact Ruby on Rails Tutorial about the sample app at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/contact"</span><span class="nt">&gt;</span>contact page<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>Now make sure that the tests pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>At this point, having gone through the Red-Green cycle to verify that we’re testing for the right things, we should uncomment the “Contact” link in the footer (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-uncomment_footer" class="hyperref">Listing&nbsp;<span class="ref">5.22</span></a>).<span class="intersentencespace"></span> This isn’t ideal, as now our tests won’t catch a regression if we accidentally remove the <code>h1</code> tag from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_view" class="hyperref">Listing&nbsp;<span class="ref">5.21</span></a>.<span class="intersentencespace"></span> Fixing this issue, which requires writing a test specifically for the content of the <code>h1</code>, is solved in an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_exercises" class="hyperref">Section&nbsp;<span class="ref">5.6</span></a>).</p>
<div class="codelisting" id="_code-uncomment_footer" data-tralics-id="uid389" data-number="5.22"><div class="heading"><span class="number">Listing 5.22:</span> 

<span class="description">Uncommenting the “Contact” link in the footer.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_footer.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"footer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;small&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    by Michael Hartl
  <span class="nt">&lt;/small&gt;</span>
  <span class="nt">&lt;nav&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"About"</span><span class="p">,</span>   <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Contact"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://news.railstutorial.org/"</span><span class="nt">&gt;</span>News<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</pre></div></div></div>
<div id="_sec-route_tests" data-tralics-id="uid390" class="subsection" data-number="5.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-route_tests" class="heading hyperref"><span class="number">5.3.1 </span>Route tests</a></h3>
<p>With the work we’ve done writing integration tests for the static pages, writing tests for the routes is simple: we just replace each occurrence of a hard-coded address with the desired named route from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-url_mapping" class="hyperref">Table&nbsp;<span class="ref">5.1</span></a>.<span class="intersentencespace"></span> In other words, we change</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="s1">'/static_pages/about'</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">about_path</span>
</pre></div></div>
<p>and so on for the other pages.<span class="intersentencespace"></span> The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-route_tests" class="hyperref">Listing&nbsp;<span class="ref">5.23</span></a>.</p>
<div class="codelisting" id="_code-route_tests" data-tralics-id="uid391" data-number="5.23"><div class="heading"><span class="number">Listing 5.23:</span> 

<span class="description">Tests for the named routes.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the base title"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should not have a custom page title"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Help page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Help'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">help_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Help'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'Help'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">help_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | Help"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'About Us'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | About Us"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Contact page"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should have the content 'Contact'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">contact_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Contact'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the title 'Contact'"</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">contact_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App | Contact"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As usual, you should check that the tests are now red:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>By the way, if the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-route_tests" class="hyperref">Listing&nbsp;<span class="ref">5.23</span></a> strikes you as repetitive and verbose, you’re not alone.<span class="intersentencespace"></span> We’ll refactor this mess into a beautiful jewel in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pretty_rspec" class="hyperref">Section&nbsp;<span class="ref">5.3.4</span></a>.</p>
</div>
<div id="_sec-rails_routes" data-tralics-id="uid392" class="subsection" data-number="5.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_routes" class="heading hyperref"><span class="number">5.3.2 </span>Rails routes</a></h3>
<p>Now that we have tests for the URLs we want, it’s time to get them to work.<span class="intersentencespace"></span> As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a>, the file Rails uses for URL mappings is <code>config/routes.rb</code>.<span class="intersentencespace"></span> If you take a look at the default routes file, you’ll see that it’s quite a mess, but it’s a useful mess—full of commented-out example route mappings.<span class="intersentencespace"></span> I suggest reading through it at some point, and I also suggest taking a look at the <a href="http://guides.rubyonrails.org/routing.html" target="_blank">Rails Guides article “Rails Routing from the outside in”</a> for a much more in-depth treatment of routes.</p>
<p>To define the named routes, we need to replace rules such as</p>
<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">'static_pages/help'</span>
</pre></div></div>
<p>with</p>
<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">'/help'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#help'</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
</pre></div></div>
<p>This arranges both for a valid page at <code>/help</code> (responding to <span class="tt">GET</span> requests) and a named route called <code>help_path</code> that returns the path to that page.<span class="intersentencespace"></span> (Actually, using <code>get</code> in place of <code>match</code> gives the same named routes, but using <code>match</code> is more conventional.)</p>
<p>Applying this pattern to the other static pages gives <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_page_routes" class="hyperref">Listing&nbsp;<span class="ref">5.24</span></a>.<span class="intersentencespace"></span> The only exception is the Home page, which we’ll take care of in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-root_route" class="hyperref">Listing&nbsp;<span class="ref">5.26</span></a>.</p>
<div class="codelisting" id="_code-static_page_routes" data-tralics-id="uid393" data-number="5.24"><div class="heading"><span class="number">Listing 5.24:</span> 

<span class="description">Routes for static pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">match</span> <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#help'</span><span class="p">,</span>    <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span><span class="p">,</span>   <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#contact'</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>If you read the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_page_routes" class="hyperref">Listing&nbsp;<span class="ref">5.24</span></a> carefully, you can probably figure out what it does; for example, you can see that</p>
<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">'/about'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span><span class="p">,</span>  <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
</pre></div></div>
<p>matches a <span class="tt">GET</span> request for <code>’/about’</code> and routes it to the <code>about</code> action in the StaticPages controller.<span class="intersentencespace"></span> Before, this was more explicit: we used
</p><div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">'static_pages/about'</span>
</pre></div></div>
<p>to get to the same place, but <code>/about</code> is more succinct.<span class="intersentencespace"></span> In addition, as mentioned above, the code <code>match ’/about’</code> also automatically creates <em>named routes</em> for use in the controllers and views:</p>
<div class="code"><div class="highlight"><pre><span class="n">about_path</span> <span class="o">-&gt;</span> <span class="s1">'/about'</span>
<span class="n">about_url</span>  <span class="o">-&gt;</span> <span class="s1">'http://localhost:3000/about'</span>
</pre></div></div>
<p>Note that <code>about_url</code> is the <em>full</em> URL http://localhost:3000/about (with <code>localhost:3000</code> being replaced with the domain name, such as <code>example.com</code>, for a fully deployed site).<span class="intersentencespace"></span> As discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_links" class="hyperref">Section&nbsp;<span class="ref">5.3</span></a>, to get just /about, you use <code>about_path</code>.<span class="intersentencespace"></span> In the <em>Rails Tutorial</em>, we’ll follow the common convention of using the <code>path</code> form except when doing redirects, where we’ll use the <code>url</code> form.<span class="intersentencespace"></span> This is because after redirects the HTTP standard technically requires a full URL, although in most browsers it will work either way.</p>
<p>With these routes now defined, the tests for the Help, About, and Contact pages should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>This leaves the test for the Home page as the last one to fail.</p>
<p>To establish the route mapping for the Home page, we <em>could</em> use code like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#home'</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
</pre></div></div>
<p>This is unnecessary, though; Rails has special instructions for the root URL&nbsp;/ (“slash”) located lower down in the file (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-root_route_hint" class="hyperref">Listing&nbsp;<span class="ref">5.25</span></a>).</p>
<div class="codelisting" id="_code-root_route_hint" data-tralics-id="uid394" data-number="5.25"><div class="heading"><span class="number">Listing 5.25:</span> 

<span class="description">The commented-out hint for defining the root route.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># You can have the root of your site routed with "root"</span>
  <span class="c1"># root 'welcome#index'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Using <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-root_route_hint" class="hyperref">Listing&nbsp;<span class="ref">5.25</span></a> as a model, we arrive at <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-root_route" class="hyperref">Listing&nbsp;<span class="ref">5.26</span></a> to route the root URL&nbsp;/ to the Home page.</p>
<div class="codelisting" id="_code-root_route" data-tralics-id="uid395" data-number="5.26"><div class="heading"><span class="number">Listing 5.26:</span> 

<span class="description">Adding a mapping for the root route.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>  <span class="s1">'static_pages#home'</span>
  <span class="n">match</span> <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#help'</span><span class="p">,</span>    <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span><span class="p">,</span>   <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#contact'</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>This code maps the root URL&nbsp;/ to /static_pages/home, which means that <a href="http://localhost:3000/" target="_blank">http://localhost:3000/</a> is finally something other than the default Rails page from <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-riding_rails" class="hyperref">Figure&nbsp;<span class="ref">1.3</span></a>.<span class="intersentencespace"></span> It also gives us URL helpers as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">root_path</span> <span class="o">-&gt;</span> <span class="s1">'/'</span>
<span class="n">root_url</span>  <span class="o">-&gt;</span> <span class="s1">'http://localhost:3000/'</span>
</pre></div></div>
<p>With that, all of the routes for static pages are working, and the tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>Now we just have to fill in the links in the layout.</p>
</div>
<div id="_sec-named_routes" data-tralics-id="uid396" class="subsection" data-number="5.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-named_routes" class="heading hyperref"><span class="number">5.3.3 </span>Named routes</a></h3>
<p>Let’s put the named routes created in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_routes" class="hyperref">Section&nbsp;<span class="ref">5.3.2</span></a> to work in our layout.<span class="intersentencespace"></span> This will entail filling in the second arguments of the <code>link_to</code> functions with the proper named routes.<span class="intersentencespace"></span> For example, we’ll convert</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"About"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"About"</span><span class="p">,</span> <span class="n">about_path</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>and so on.</p>
<p>We’ll start in the header partial, <code>_header.html.erb</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-header_partial_links" class="hyperref">Listing&nbsp;<span class="ref">5.27</span></a>), which has links to the Home and Help pages.<span class="intersentencespace"></span> While we’re at it, we’ll follow a common web convention and link the logo to the Home page as well.</p>
<div class="codelisting" id="_code-header_partial_links" data-tralics-id="uid397" data-number="5.27"><div class="heading"><span class="number">Listing 5.27:</span> 

<span class="description">Header partial with links.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span>    <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span>    <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div><p>We won’t have a named route for the “Sign in” link until <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>, so we’ve left it as <code>’#’</code> for now.</p>
<p>The other place with links is the footer partial, <code>_footer.html.erb</code>, which has links for the About and Contact pages (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-footer_partial_links" class="hyperref">Listing&nbsp;<span class="ref">5.28</span></a>).</p>
<div class="codelisting" id="_code-footer_partial_links" data-tralics-id="uid398" data-number="5.28"><div class="heading"><span class="number">Listing 5.28:</span> 

<span class="description">Footer partial with links.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_footer.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"footer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;small&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    by Michael Hartl
  <span class="nt">&lt;/small&gt;</span>
  <span class="nt">&lt;nav&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"About"</span><span class="p">,</span>   <span class="n">about_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Contact"</span><span class="p">,</span> <span class="n">contact_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://news.railstutorial.org/"</span><span class="nt">&gt;</span>News<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</pre></div></div></div><p>With that, our layout has links to all the static pages created in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a>, so that, for example, <a href="http://localhost:3000/about" target="_blank">/about</a> goes to the About page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-about_page" class="hyperref">Figure&nbsp;<span class="ref">5.8</span></a>).</p>
<p>By the way, it’s worth noting that, although we haven’t actually tested for the presence of the links on the layout, our tests will fail if the routes aren’t defined.<span class="intersentencespace"></span> You can check this by commenting out the routes in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_page_routes" class="hyperref">Listing&nbsp;<span class="ref">5.24</span></a> and running your test suite.<span class="intersentencespace"></span> For a testing method that actually makes sure the links go to the right places, see <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_exercises" class="hyperref">Section&nbsp;<span class="ref">5.6</span></a>.</p>
<div class="center figure" id="_fig-about_page" data-tralics-id="uid399" data-number="5.8">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/about_page_styled.png" alt="images/figures/about_page_styled"></div><div class="caption"><span class="header">Figure 5.8: </span><span class="description">The About page at <a href="http://localhost:3000/about" target="_blank">/about</a>.
</span></div></div>
</div>
<div id="_sec-pretty_rspec" data-tralics-id="uid400" class="subsection" data-number="5.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pretty_rspec" class="heading hyperref"><span class="number">5.3.4 </span>Pretty RSpec</a></h3>
<p>We noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-route_tests" class="hyperref">Section&nbsp;<span class="ref">5.3.1</span></a> that the tests for the static pages are getting a little verbose and repetitive (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-route_tests" class="hyperref">Listing&nbsp;<span class="ref">5.23</span></a>).<span class="intersentencespace"></span> In this section we’ll make use of the latest features of RSpec to make our tests more compact and elegant.</p>
<p>Let’s take a look at a couple of the examples to see how they can be improved:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"should have the base title"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"should not have a custom page title"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>One thing we notice is that all three examples include a visit to the root path.<span class="intersentencespace"></span> We can eliminate this duplication with a <code>before</code> block:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"should have the base title"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"should not have a custom page title"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>This uses the line</p>
<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>
</pre></div></div>
<p>to visit the root path before each example.<span class="intersentencespace"></span> (The <code>before</code> method can also be invoked with <code>before(:each)</code>, which is a synonym.)</p>
<p>Another source of duplication appears in each example; we have both</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">"should have the content 'Sample App'"</span> <span class="k">do</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span>
</pre></div></div>
<p>which say essentially the same thing.<span class="intersentencespace"></span> In addition, both examples reference the <code>page</code> variable.<span class="intersentencespace"></span> We can eliminate these sources of duplication by telling RSpec that <code>page</code> is the <em>subject</em> of the tests using</p>
<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
</pre></div></div>
<p>and then using a variant of the <code>it</code> method to collapse the code and description into one line:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>Because of <code>subject { page }</code>, the call to <code>should</code> automatically uses the <code>page</code> variable supplied by Capybara (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-TDD" class="hyperref">Section&nbsp;<span class="ref">3.2.1</span></a>).</p>
<p>Applying these changes gives much more compact tests for the Home page:</p>
<div class="code"><div class="highlight"><pre>  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Ruby on Rails Tutorial Sample App"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
</pre></div></div>
<p>This code looks nicer, but the title test is still a bit long.<span class="intersentencespace"></span> Indeed, most of the title tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-route_tests" class="hyperref">Listing&nbsp;<span class="ref">5.23</span></a> have long title text of the form</p>
<div class="code"><div class="highlight"><pre><span class="s2">"Ruby on Rails Tutorial Sample App | About"</span>
</pre></div></div>
<p>An exercise in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages_exercises" class="hyperref">Section&nbsp;<span class="ref">3.5</span></a> proposes eliminating some of this duplication by defining a <code>base_title</code> variable and using string interpolation (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_exercise" class="hyperref">Listing&nbsp;<span class="ref">3.31</span></a>).<span class="intersentencespace"></span> We can do even better by defining a <code>full_title</code>, which parallels the <code>full_title</code> helper from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-title_helper" class="hyperref">Listing&nbsp;<span class="ref">4.2</span></a>.<span class="intersentencespace"></span> We do this by creating both a <code>spec/support</code> directory and a <code>utilities.rb</code> file for RSpec utilities (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rspec_utilities" class="hyperref">Listing&nbsp;<span class="ref">5.29</span></a>).</p>
<div class="codelisting" id="_code-rspec_utilities" data-tralics-id="uid401" data-number="5.29"><div class="heading"><span class="number">Listing 5.29:</span> 

<span class="description">A file for RSpec utilities with a <code>full_title</code> function.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/support/utilities.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
  <span class="n">base_title</span> <span class="o">=</span> <span class="s2">"Ruby on Rails Tutorial Sample App"</span>
  <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">base_title</span>
  <span class="k">else</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Of course, this is essentially a duplicate of the helper in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-title_helper" class="hyperref">Listing&nbsp;<span class="ref">4.2</span></a>, but having two independent methods allows us to catch any typos in the base title.<span class="intersentencespace"></span> This is dubious design, though, and a better (slightly more advanced) approach, which tests the original <code>full_title</code> helper directly, appears in the exercises (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_exercises" class="hyperref">Section&nbsp;<span class="ref">5.6</span></a>).</p>
<p>Files in the <code>spec/support</code> directory are automatically included by RSpec, which means that we can write the Home tests as follows:</p>
<div class="code"><div class="highlight"><pre>  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">''</span><span class="p">))</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
</pre></div></div>
<p>We can now simplify the tests for the Help, About, and Contact pages using the same methods used for the Home page.<span class="intersentencespace"></span> The results appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pretty_page_tests" class="hyperref">Listing&nbsp;<span class="ref">5.30</span></a>.</p>
<div class="codelisting" id="_code-pretty_page_tests" data-tralics-id="uid402" data-number="5.30"><div class="heading"><span class="number">Listing 5.30:</span> 

<span class="description">Prettier tests for the static pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sample App'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">''</span><span class="p">))</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Help page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">help_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Help'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Help'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">about_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'About'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Contact page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">contact_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Contact'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Contact'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>You should now verify that the tests still pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div></div>
<p>This RSpec style in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pretty_page_tests" class="hyperref">Listing&nbsp;<span class="ref">5.30</span></a> is much pithier than the style in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-route_tests" class="hyperref">Listing&nbsp;<span class="ref">5.23</span></a>—indeed, it can be made even pithier (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_exercises" class="hyperref">Section&nbsp;<span class="ref">5.6</span></a>).<span class="intersentencespace"></span> We will use this more compact style whenever possible when developing the rest of the sample application.</p>
</div></div>
<div id="_sec-user_signup" data-tralics-id="cid30" class="section" data-number="5.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_signup" class="heading hyperref"><span class="number">5.4 </span>User signup: A first step</a></h2>
<p>As a capstone to our work on the layout and routing, in this section we’ll make a route for the signup page, which will mean creating a second controller along the way.<span class="intersentencespace"></span> This is a first important step toward allowing users to register for our site; we’ll take the next step, modeling users, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>, and we’ll finish the job in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>.</p>
<div id="_sec-users_controller" data-tralics-id="uid403" class="subsection" data-number="5.4.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-users_controller" class="heading hyperref"><span class="number">5.4.1 </span>Users controller</a></h3>
<p>It’s been a while since we created our first controller, the StaticPages controller, way back in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-static_pages" class="hyperref">Section&nbsp;<span class="ref">3.1</span></a>.<span class="intersentencespace"></span> It’s time to create a second one, the Users controller.<span class="intersentencespace"></span> As before, we’ll use <code>generate</code> to make the simplest controller that meets our present needs, namely, one with a stub signup page for new users.<span class="intersentencespace"></span> Following the conventional <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer" target="_blank">REST architecture</a> favored by Rails, we’ll call the action for new users <code>new</code> and pass it as an argument to <code>generate controller</code> to create it automatically (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_users_controller" class="hyperref">Listing&nbsp;<span class="ref">5.31</span></a>).</p>
<div class="codelisting" id="_code-generate_users_controller" data-tralics-id="uid404" data-number="5.31"><div class="heading"><span class="number">Listing 5.31:</span> 

<span class="description">Generating a Users controller (with a <code>new</code> action).</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new --no-test-framework
<span class="go">      create  app/controllers/users_controller.rb</span>
<span class="go">       route  get "users/new"</span>
<span class="go">      invoke  erb</span>
<span class="go">      create    app/views/users</span>
<span class="go">      create    app/views/users/new.html.erb</span>
<span class="go">      invoke  helper</span>
<span class="go">      create    app/helpers/users_helper.rb</span>
<span class="go">      invoke  assets</span>
<span class="go">      invoke    coffee</span>
<span class="go">      create      app/assets/javascripts/users.js.coffee</span>
<span class="go">      invoke    scss</span>
<span class="go">      create      app/assets/stylesheets/users.css.scss</span>
</pre></div></div></div><p>This creates a Users controller with a <code>new</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_users_controller" class="hyperref">Listing&nbsp;<span class="ref">5.32</span></a>) and a stub user view (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_new_action" class="hyperref">Listing&nbsp;<span class="ref">5.33</span></a>).</p>
<div class="codelisting" id="_code-initial_users_controller" data-tralics-id="uid405" data-number="5.32"><div class="heading"><span class="number">Listing 5.32:</span> 

<span class="description">The initial Users controller, with a <code>new</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-initial_new_action" data-tralics-id="uid406" data-number="5.33"><div class="heading"><span class="number">Listing 5.33:</span> 

<span class="description">The initial <code>new</code> view for Users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Users#new<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/users/new.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div></div>
<div id="_sec-signup_url" data-tralics-id="uid407" class="subsection" data-number="5.4.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_url" class="heading hyperref"><span class="number">5.4.2 </span>Signup URL</a></h3>
<p>With the code from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-users_controller" class="hyperref">Section&nbsp;<span class="ref">5.4.1</span></a>, we already have a working page for new users at /users/new, but recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-url_mapping" class="hyperref">Table&nbsp;<span class="ref">5.1</span></a> that we want the URL to be /signup instead.<span class="intersentencespace"></span> As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_links" class="hyperref">Section&nbsp;<span class="ref">5.3</span></a>, we’ll first write some integration tests, which we’ll now generate:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test user_pages
</pre></div></div>
<p>Then, following the model of the static pages spec in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pretty_page_tests" class="hyperref">Listing&nbsp;<span class="ref">5.30</span></a>, we’ll fill in the user pages test with code to test for the contents of the <code>h1</code> and <code>title</code> tags, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_pages_spec" class="hyperref">Listing&nbsp;<span class="ref">5.34</span></a>.</p>
<div class="codelisting" id="_code-user_pages_spec" data-tralics-id="uid408" data-number="5.34"><div class="heading"><span class="number">Listing 5.34:</span> 

<span class="description">The initial spec for users, with a test for the signup page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"signup page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can run these tests using the <code>rspec</code> command as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb
</pre></div></div>
<p>It’s worth noting that we can also run all the request specs by passing the whole directory instead of just one file:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/
</pre></div></div>
<p>Based on this pattern, you may be able to guess how to run <em>all</em> the specs:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>For completeness, we’ll usually use this method to run the tests through the rest of the tutorial.<span class="intersentencespace"></span> By the way, it’s worth noting (since you may see other people use it) that you can also run the test suite using the <code>spec</code> Rake task:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake spec
</pre></div></div>
<p>(In fact, you can just type <code>rake</code> by itself; the default behavior of <code>rake</code> is to run the test suite.)<span class="intersentencespace"></span> The only caveat is that using <code>rake</code> to run the tests for the current sample application will raise an error since it requires the test database to be prepared properly, a step we’ll defer to <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-initial_user_tests" class="hyperref">Section&nbsp;<span class="ref">6.2.1</span></a>.</p>
<p>By construction, the Users controller already has a <code>new</code> action, so to get the test to pass all we need is the right route and the right view content.<span class="intersentencespace"></span> We’ll follow the examples from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_page_routes" class="hyperref">Listing&nbsp;<span class="ref">5.24</span></a> and add a <code>match ’/signup’</code> rule for the signup URL (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_route" class="hyperref">Listing&nbsp;<span class="ref">5.35</span></a>).</p>
<div class="codelisting" id="_code-signup_route" data-tralics-id="uid409" data-number="5.35"><div class="heading"><span class="number">Listing 5.35:</span> 

<span class="description">A route for the signup page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"users/new"</span>

  <span class="n">root</span>  <span class="s1">'static_pages#home'</span>
  <span class="n">match</span> <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'users#new'</span><span class="p">,</span>            <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#help'</span><span class="p">,</span>    <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span><span class="p">,</span>   <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#contact'</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we have kept the rule <code>get "users/new"</code>, which was generated automatically by the Users controller generation in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_users_controller" class="hyperref">Listing&nbsp;<span class="ref">5.31</span></a>.<span class="intersentencespace"></span> Currently, this rule is necessary for the <code>’users/new’</code> routing to work, but it doesn’t follow the proper REST conventions (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-demo_RESTful_users" class="hyperref">Table&nbsp;<span class="ref">2.2</span></a>), and we will eliminate it in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="hyperref">Section&nbsp;<span class="ref">7.1.2</span></a>.</p>
<p>To get the tests to pass, all we need now is a view with the title and heading “Sign up” (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_signup_page" class="hyperref">Listing&nbsp;<span class="ref">5.36</span></a>).</p>
<div class="codelisting" id="_code-initial_signup_page" data-tralics-id="uid410" data-number="5.36"><div class="heading"><span class="number">Listing 5.36:</span> 

<span class="description">The initial (stub) signup page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/users/new.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>At this point, the signup test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_pages_spec" class="hyperref">Listing&nbsp;<span class="ref">5.34</span></a> should pass.<span class="intersentencespace"></span> All that’s left is to add the proper link to the button on the Home page.<span class="intersentencespace"></span> As with the other routes, <code>match ’/signup’</code> gives us the named route <code>signup_path</code>, which we put to use in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_signup_link" class="hyperref">Listing&nbsp;<span class="ref">5.37</span></a>.</p>
<div class="codelisting" id="_code-home_page_signup_link" data-tralics-id="uid411" data-number="5.37"><div class="heading"><span class="number">Listing 5.37:</span> 

<span class="description">Linking the button to the Signup page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center hero-unit"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;h2&gt;</span>
    This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
  <span class="nt">&lt;/h2&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="s2">"Rails"</span><span class="p">),</span> <span class="s1">'http://rubyonrails.org/'</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>With that, we’re done with the links and named routes, at least until we add a route for signing in (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>).<span class="intersentencespace"></span> The resulting new user page (at the URL /signup) appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-new_signup_page" class="hyperref">Figure&nbsp;<span class="ref">5.9</span></a>.</p>
<div class="center figure" id="_fig-new_signup_page" data-tralics-id="uid412" data-number="5.9">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/new_signup_page_bootstrap.png" alt="images/figures/new_signup_page_bootstrap"></div><div class="caption"><span class="header">Figure 5.9: </span><span class="description">The new signup page at <a href="http://localhost:3000/signup" target="_blank">/signup</a>.
</span></div></div>
<p>At this point the tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div>
<div id="_sec-layout_conclusion" data-tralics-id="cid31" class="section" data-number="5.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_conclusion" class="heading hyperref"><span class="number">5.5 </span>Conclusion</a></h2>
<p>In this chapter, we’ve hammered our application layout into shape and polished up the routes.<span class="intersentencespace"></span> The rest of the book is dedicated to fleshing out the sample application: first, by adding users who can sign up, sign in, and sign out; next, by adding user microposts; and, finally, by adding the ability to follow other users.</p>
<p>At this point, if you are using Git you should merge the changes back into the master branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Finish layout and routes"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge filling-in-layout
</pre></div></div>
<p>You can also push up to GitHub:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div></div>
<p>Finally, you can deploy to Heroku:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
</pre></div></div>
<p>The result should be a working sample application on the production server:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div></div>
<p>If you run into trouble, try running</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div></div>
<p>to debug the error using the Heroku logfile.</p>
</div>
<div id="_sec-layout_exercises" data-tralics-id="cid32" class="section" data-number="5.6"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_exercises" class="heading hyperref"><span class="number">5.6 </span>Exercises</a></h2>
<ol>
<li>We saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_links" class="hyperref">Section&nbsp;<span class="ref">5.3</span></a> that the <code>have_content</code> RSpec matcher sometimes matches <em>too</em> broadly, leading us to temporarily comment out the “Contact” line in the footer to avoid an erroneous passing test (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-comment_out_footer" class="hyperref">Listing&nbsp;<span class="ref">5.18</span></a>).<span class="intersentencespace"></span> To fix this, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_test_have_selector" class="hyperref">Listing&nbsp;<span class="ref">5.38</span></a> introduces Capybara’s <code>have_selector</code> method, which allows us to test the presence of specific HTML tags.<span class="intersentencespace"></span> By deleting and then restoring the “Contact” <code>h1</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_view" class="hyperref">Listing&nbsp;<span class="ref">5.21</span></a>, verify that the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_test_have_selector" class="hyperref">Listing&nbsp;<span class="ref">5.38</span></a> correctly fails even when the footer isn’t commented out.
</li>
<li>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pretty_page_tests" class="hyperref">Listing&nbsp;<span class="ref">5.30</span></a> for testing static pages is compact but is still a bit repetitive.<span class="intersentencespace"></span> RSpec supports a facility called <em>shared examples</em> to eliminate this kind of duplication.<span class="intersentencespace"></span> By following the example in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_pages_spec_shared_example" class="hyperref">Listing&nbsp;<span class="ref">5.39</span></a>, fill in the missing tests for the About and Contact pages.<span class="intersentencespace"></span> Note that the <code>let</code> command, introduced briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pages_controller_spec_exercise" class="hyperref">Listing&nbsp;<span class="ref">3.31</span></a>, creates a local variable with the given value on demand (i.e., when the variable is used), in contrast to an instance variable, which is created upon assignment.<span class="intersentencespace"></span> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-static_pages_spec_shared_example" class="hyperref">Listing&nbsp;<span class="ref">5.39</span></a> also incorporates the use of <code>have_selector</code> from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_test_have_selector" class="hyperref">Listing&nbsp;<span class="ref">5.38</span></a>.)
</li>
<li>You may have noticed that our tests for the layout links test the routing but don’t actually check that the links on the layout go to the right pages.<span class="intersentencespace"></span> One way to implement these tests is to use <code>visit</code> and <code>click_link</code> inside the RSpec integration test.<span class="intersentencespace"></span> Fill in the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_links_test" class="hyperref">Listing&nbsp;<span class="ref">5.40</span></a> to verify that all the layout links are properly defined.
</li>
<li>Eliminate the need for the <code>full_title</code> test helper in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rspec_utilities" class="hyperref">Listing&nbsp;<span class="ref">5.29</span></a> by writing tests for the original helper method, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-full_title_helper_tests" class="hyperref">Listing&nbsp;<span class="ref">5.41</span></a>.<span class="intersentencespace"></span> (You will have to create both the <code>spec/helpers</code> directory and the <code>application_helper_spec.rb</code> file.)<span class="intersentencespace"></span> Then <code>include</code> it into the test using the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rspec_utilities_simplified" class="hyperref">Listing&nbsp;<span class="ref">5.42</span></a>.<span class="intersentencespace"></span> Verify by running the test suite that the new code is still valid.<span class="intersentencespace"></span> <em>Note</em>: <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-full_title_helper_tests" class="hyperref">Listing&nbsp;<span class="ref">5.41</span></a> uses <em>regular expressions</em>, which we’ll learn more about in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-format_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.4</span></a>.<span class="intersentencespace"></span> (Thanks to <a href="http://alexchaffee.com/" target="_blank">Alex Chaffee</a> for the suggestion and code used in this exercise.)
</li></ol>
<div class="codelisting" id="_code-contact_test_have_selector" data-tralics-id="uid417" data-number="5.38"><div class="heading"><span class="number">Listing 5.38:</span> 

<span class="description">A more specific test for the Contact page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"Contact page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">contact_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Contact'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Contact'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-static_pages_spec_shared_example" data-tralics-id="uid418" data-number="5.39"><div class="heading"><span class="number">Listing 5.39:</span> 

<span class="description">Using an RSpec shared example to eliminate test duplication.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">shared_examples_for</span> <span class="s2">"all static pages"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">heading</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:heading</span><span class="p">)</span>    <span class="p">{</span> <span class="s1">'Sample App'</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:page_title</span><span class="p">)</span> <span class="p">{</span> <span class="s1">''</span> <span class="p">}</span>

    <span class="n">it_should_behave_like</span> <span class="s2">"all static pages"</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'| Home'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Help page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">help_path</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:heading</span><span class="p">)</span>    <span class="p">{</span> <span class="s1">'Help'</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:page_title</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'Help'</span> <span class="p">}</span>

    <span class="n">it_should_behave_like</span> <span class="s2">"all static pages"</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"About page"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"Contact page"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-layout_links_test" data-tralics-id="uid419" data-number="5.40"><div class="heading"><span class="number">Listing 5.40:</span> 

<span class="description">A test for the links on the layout.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">"should have the right links on the layout"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">click_link</span> <span class="s2">"About"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'About Us'</span><span class="p">))</span>
    <span class="n">click_link</span> <span class="s2">"Help"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">"Contact"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">"Home"</span>
    <span class="n">click_link</span> <span class="s2">"Sign up now!"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">"sample app"</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="c1"># fill in</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-full_title_helper_tests" data-tralics-id="uid420" data-number="5.41"><div class="heading"><span class="number">Listing 5.41:</span> 

<span class="description">Tests for the <code>full_title</code> helper.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/helpers/application_helper_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">ApplicationHelper</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"full_title"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should include the page title"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">match</span><span class="p">(</span><span class="sr">/foo/</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should include the base title"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">match</span><span class="p">(</span><span class="sr">/^Ruby on Rails Tutorial Sample App/</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should not include a bar for the home page"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s2">""</span><span class="p">))</span><span class="o">.</span><span class="n">not_to</span> <span class="n">match</span><span class="p">(</span><span class="sr">/\|/</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-rspec_utilities_simplified" data-tralics-id="uid421" data-number="5.42"><div class="heading"><span class="number">Listing 5.42:</span> 

<span class="description">Replacing the <code>full_title</code> test helper with a simple <code>include</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/support/utilities.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>
</pre></div></div></div></div>
<div id="cha-5_footnotes">
  <ol class="footnotes">
    <li id="_cha-5_footnote-1">Thanks to reader <a href="https://twitter.com/colmtuite" target="_blank">Colm Tuite</a> for his excellent work in helping to convert the sample application over to Bootstrap.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-1">↑</a></li>
    <li id="_cha-5_footnote-2">The mockups in the <em>Ruby on Rails Tutorial</em> are made with an excellent online mockup application called <a href="http://gomockingbird.com/" target="_blank">Mockingbird</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-2">↑</a></li>
    <li id="_cha-5_footnote-3">These are completely unrelated to Ruby classes.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-3">↑</a></li>
    <li id="_cha-5_footnote-4">You might notice that the <code>img</code> tag, rather than looking like <span class="inline_verbatim">&lt;img&gt;...&lt;/img&gt;</span>, instead looks like <span class="inline_verbatim">&lt;img ... /&gt;</span>.<span class="intersentencespace"></span> Tags that follow this form are known as <em>self-closing</em> tags.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-4">↑</a></li>
    <li id="_cha-5_footnote-5">It is also possible to use LESS with the asset pipeline; see the <a href="http://rubygems.org/gems/less-rails-bootstrap" target="_blank"><span class="tt">less-rails-bootstrap</span> gem</a> for details.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-5">↑</a></li>
    <li id="_cha-5_footnote-6">Many Rails developers use a <code>shared</code> directory for partials shared across different views.<span class="intersentencespace"></span> I prefer to use the <code>shared</code> folder for utility partials that are useful on multiple views, while putting partials that are literally on every page (as part of the site layout) in the <code>layouts</code> directory.<span class="intersentencespace"></span> (We’ll create the <code>shared</code> directory starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>.)<span class="intersentencespace"></span> That seems to me a logical division, but putting them all in the <code>shared</code> folder certainly works fine, too.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-6">↑</a></li>
    <li id="_cha-5_footnote-7">You may wonder why we use both the <code>footer</code> tag and <code>.footer</code> class.<span class="intersentencespace"></span> The answer is that the tag has a clear meaning to human readers, and the class is used by Bootstrap.<span class="intersentencespace"></span> Using a <code>div</code> tag in place of <code>footer</code> would work as well.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-7">↑</a></li>
    <li id="_cha-5_footnote-8">The structure of this section is based on the excellent blog post “The Rails 3 Asset Pipeline in (about) 5 Minutes” by Michael Erasmus.<span class="intersentencespace"></span> For more details, see the <a href="http://guides.rubyonrails.org/asset_pipeline.html" target="_blank">Rails Guide on the Asset Pipeline</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-8">↑</a></li>
    <li id="_cha-5_footnote-9">The older <code>.sass</code> format, also supported by Sass, defines a new language which is less verbose (and has fewer curly braces) but is less convenient for existing projects and is harder to learn for those already familiar with CSS.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-5_footnote-ref-9">↑</a></li>
  </ol>
</div><div id="_cha-modeling_users" data-tralics-id="cid33" class="chapter" data-number="6"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="heading hyperref"><span class="number">Chapter 6 </span>Modeling users</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a>, we ended with a stub page for creating new users (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_signup" class="hyperref">Section&nbsp;<span class="ref">5.4</span></a>); over the course of the next four chapters, we’ll fulfill the promise implicit in this incipient signup page.<span class="intersentencespace"></span> In this chapter, we’ll take the first critical step by creating a <em>data model</em> for users of our site, together with a way to store that data.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>, we’ll give users the ability to sign up for our site and create a user profile page.<span class="intersentencespace"></span> Once users can sign up, we’ll let them sign in and sign out as well (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>), and in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-requiring_signed_in_users" class="hyperref">Section&nbsp;<span class="ref">9.2.1</span></a>) we’ll learn how to protect pages from improper access.<span class="intersentencespace"></span> Taken together, the material in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a> through <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a> develops a full Rails login and authentication system.<span class="intersentencespace"></span> As you may know, there are various pre-built authentication solutions for Rails; <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-roll_your_own" class="hyperref">Box&nbsp;<span class="ref">6.1</span></a> explains why, at least at first, it’s probably a better idea to roll your own.</p>
<p>This is a long and action-packed chapter, and you may find it unusually challenging, especially if you are new to data modeling.<span class="intersentencespace"></span> By the end of it, though, we will have created an industrial-strength system for validating, storing, and retrieving user information.</p>
<div class="aside" id="_sidebar-roll_your_own" data-tralics-id="uid422" data-number="6.1"><div class="heading"><span class="number">Box 6.1.</span> 

<span class="description">Roll your own authentication system</span></div>
<p>Virtually all web applications require a login and authentication system of some sort.<span class="intersentencespace"></span> As a result, most web frameworks have a plethora of options for implementing such systems, and Rails is no exception.<span class="intersentencespace"></span> Examples of authentication and authorization systems include <a href="http://github.com/thoughtbot/clearance" target="_blank">Clearance</a>, <a href="http://github.com/binarylogic/authlogic" target="_blank">Authlogic</a>, <a href="http://github.com/plataformatec/devise" target="_blank">Devise</a>, and <a href="http://railscasts.com/episodes/192-authorization-with-cancan" target="_blank">CanCan</a> (as well as non-Rails-specific solutions built on top of <a href="http://en.wikipedia.org/wiki/OpenID" target="_blank">OpenID</a> or <a href="http://en.wikipedia.org/wiki/Oauth" target="_blank">OAuth</a>).<span class="intersentencespace"></span> It’s reasonable to ask why we should reinvent the wheel.<span class="intersentencespace"></span> Why not just use an off-the-shelf solution instead of rolling our own?</p>
<p>For one, practical experience shows that authentication on most sites requires extensive customization, and modifying a third-party product is often more work than writing the system from scratch.<span class="intersentencespace"></span> In addition, off-the-shelf systems can be “black boxes”, with potentially mysterious innards; when you write your own system, you are far more likely to understand it.<span class="intersentencespace"></span> Moreover, recent additions to Rails (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3</span></a>) make it easy to write a custom authentication system.<span class="intersentencespace"></span> Finally, if you <em>do</em> end up using a third-party system later on, you’ll be in a much better position to understand and modify it if you’ve first built one yourself.<span class="intersentencespace"></span></p>

</div><p>As usual, if you’re following along using Git for version control, now would be a good time to make a topic branch for modeling users:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b modeling-users
</pre></div></div>
<p>(The first line here is just to make sure that you start on the master branch, so that the <code>modeling-users</code> topic branch is based on <code>master</code>.<span class="intersentencespace"></span> You can skip that command if you’re already on the master branch.)</p>
</div>
<div id="_sec-user_model" data-tralics-id="cid34" class="section" data-number="6.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_model" class="heading hyperref"><span class="number">6.1 </span>User model</a></h2>
<p>Although the ultimate goal of the next three chapters is to make a signup page for our site (mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_mockup_preview" class="hyperref">Figure&nbsp;<span class="ref">6.1</span></a>), it would do little good now to accept information for new users: we don’t currently have any place to put it.<span class="intersentencespace"></span> Thus, the first step in signing up users is to make a data structure to capture and store their information.</p>
<div class="center figure" id="_fig-signup_mockup_preview" data-tralics-id="uid423" data-number="6.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_mockup_bootstrap.png" alt="images/figures/signup_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 6.1: </span><span class="description">A mockup of the user signup page.
</span></div></div>
<p>In Rails, the default data structure for a data model is called, naturally enough, a&nbsp;<em>model</em> (the M in MVC from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc" class="hyperref">Section&nbsp;<span class="ref">1.2.6</span></a>).<span class="intersentencespace"></span> The default Rails solution to the problem of persistence is to use a <em>database</em> for long-term data storage, and the default library for interacting with the database is called <em>Active Record</em>.<sup id="_cha-6_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-1">1</a></sup><span class="intersentencespace"></span> Active Record comes with a host of methods for creating, saving, and finding data objects, all without having to use the structured query language (SQL)<sup id="_cha-6_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-2">2</a></sup> used by <a href="http://en.wikipedia.org/wiki/Relational_database" target="_blank">relational databases</a>.<span class="intersentencespace"></span> Moreover, Rails has a feature called <em>migrations</em> to allow data definitions to be written in pure Ruby, without having to learn an SQL data definition language (DDL).<span class="intersentencespace"></span> The effect is that Rails insulates you almost entirely from the details of the data store.<span class="intersentencespace"></span> In this book, by using SQLite for development and PostgreSQL (via Heroku) for deployment (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying" class="hyperref">Section&nbsp;<span class="ref">1.4</span></a>), we have developed this theme even further, to the point where we barely ever have to think about how Rails stores data, even for production applications.</p>
<div id="_sec-database_migrations" data-tralics-id="uid426" class="subsection" data-number="6.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-database_migrations" class="heading hyperref"><span class="number">6.1.1 </span>Database migrations</a></h3>
<p>You may recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a> that we have already encountered, via a custom-built <code>User</code> class, user objects with <code>name</code> and <code>email</code> attributes.<span class="intersentencespace"></span> That class served as a useful example, but it lacked the critical property of <em>persistence</em>: when we created a User object at the Rails console, it disappeared as soon as we exited.<span class="intersentencespace"></span> Our goal in this section is to create a model for users that won’t disappear quite so easily.</p>
<p>As with the User class in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>, we’ll start by modeling a user with two attributes, a <code>name</code> and an <code>email</code> address, the latter of which we’ll use as a unique username.<sup id="_cha-6_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-3">3</a></sup><span class="intersentencespace"></span> (We’ll add an attribute for passwords in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3</span></a>.)<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-example_user" class="hyperref">Listing&nbsp;<span class="ref">4.9</span></a>, we did this with Ruby’s <code>attr_accessor</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>In contrast, when using Rails to model users we don’t need to identify the attributes explicitly.<span class="intersentencespace"></span> As noted briefly above, to store data Rails uses a relational database by default, which consists of <em>tables</em> composed of data <em>rows</em>, where each row has <em>columns</em> of data attributes.<span class="intersentencespace"></span> For example, to store users with names and email addresses, we’ll create a <code>users</code> table with <code>name</code> and <code>email</code> columns (with each row corresponding to one user).<span class="intersentencespace"></span> By naming the columns in this way, we’ll let Active Record figure out the User object attributes for us.</p>
<p>Let’s see how this works.<span class="intersentencespace"></span> (If this discussion gets too abstract for your taste, be patient; the console examples starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.3</span></a> and the database browser screenshots in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sqlite_database_browser" class="hyperref">Figure&nbsp;<span class="ref">6.3</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sqlite_user_row" class="hyperref">Figure&nbsp;<span class="ref">6.6</span></a> should make things clearer.)<span class="intersentencespace"></span> You may recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_users_controller" class="hyperref">Listing&nbsp;<span class="ref">5.31</span></a> that we created a Users controller (along with a <code>new</code> action) using the command</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new --no-test-framework
</pre></div></div>
<p>There is an analogous command for making a model: <code>generate model</code>.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_user_model" class="hyperref">Listing&nbsp;<span class="ref">6.1</span></a> shows the command to generate a User model with two attributes, <code>name</code> and <code>email</code>.</p>
<div class="codelisting" id="_code-generate_user_model" data-tralics-id="uid428" data-number="6.1"><div class="heading"><span class="number">Listing 6.1:</span> 

<span class="description">Generating a User model.</span>
</div>

<div class="code"><div class="highlight"><pre>$ rails generate model User name:string email:string
      invoke  active_record
      create    db/migrate/[timestamp]_create_users.rb
      create    app/models/user.rb
      invoke    rspec
      create      spec/models/user_spec.rb
</pre></div></div></div><p>(Note that, in contrast to the plural convention for controller names, model names are singular: a Users controller, but a User model.)<span class="intersentencespace"></span> By passing the optional parameters <code>name:string</code> and <code>email:string</code>, we tell Rails about the two attributes we want, along with what types those attributes should be (in this case, <code>string</code>).<span class="intersentencespace"></span> Compare this with including the action names in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generating_pages" class="hyperref">Listing&nbsp;<span class="ref">3.4</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_users_controller" class="hyperref">Listing&nbsp;<span class="ref">5.31</span></a>.</p>
<p>One of the results of the <code>generate</code> command in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_user_model" class="hyperref">Listing&nbsp;<span class="ref">6.1</span></a> is a new file called a <em>migration</em>.<span class="intersentencespace"></span> Migrations provide a way to alter the structure of the database incrementally, so that our data model can adapt to changing requirements.<span class="intersentencespace"></span> In the case of the User model, the migration is created automatically by the model generation script; it creates a <code>users</code> table with two columns, <code>name</code> and <code>email</code>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_migration" class="hyperref">Listing&nbsp;<span class="ref">6.2</span></a>.<span class="intersentencespace"></span> (We’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-uniqueness_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.5</span></a> and again in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3</span></a> how to make a migration from scratch.)</p>
<div class="codelisting" id="_code-users_migration" data-tralics-id="uid429" data-number="6.2"><div class="heading"><span class="number">Listing 6.2:</span> 

<span class="description">Migration for the User model (to create a <code>users</code> table).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the name of the migration file is prefixed by a <em>timestamp</em> based on when the migration was generated.<span class="intersentencespace"></span> In the early days of migrations, the filenames were prefixed with incrementing integers, which caused conflicts for collaborating teams if multiple programmers had migrations with the same number.<span class="intersentencespace"></span> Barring the improbable scenario of migrations generated the same second, using timestamps conveniently avoids such collisions.</p>
<p>The migration itself consists of a <code>change</code> method that determines the change to be made to the database.<span class="intersentencespace"></span> In the case of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_migration" class="hyperref">Listing&nbsp;<span class="ref">6.2</span></a>, <code>change</code> uses a Rails method called <code>create_table</code> to create a <em>table</em> in the database for storing users.<span class="intersentencespace"></span> The <code>create_table</code> method accepts a block (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-blocks" class="hyperref">Section&nbsp;<span class="ref">4.3.2</span></a>) with one block variable, in this case called <code>t</code> (for “table”).<span class="intersentencespace"></span> Inside the block, the <code>create_table</code> method uses the <code>t</code>&nbsp;object to create <code>name</code> and <code>email</code> columns in the database, both of type <code>string</code>.<sup id="_cha-6_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-4">4</a></sup><span class="intersentencespace"></span> Here the table name is plural (<code>users</code>) even though the model name is singular (User), which reflects a linguistic convention followed by Rails: a model represents a single user, whereas a database table consists of many users.<span class="intersentencespace"></span> The final line in the block, <code>t.timestamps</code>, is a special command that creates two <em>magic columns</em> called <code>created_at</code> and <code>updated_at</code>, which are timestamps that automatically record when a given user is created and updated.<span class="intersentencespace"></span> (We’ll see concrete examples of the magic columns starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.3</span></a>.)<span class="intersentencespace"></span> The full data model represented by this migration is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_model_initial" class="hyperref">Figure&nbsp;<span class="ref">6.2</span></a>.</p>
<div class="center figure" id="_fig-user_model_initial" data-tralics-id="uid431" data-number="6.2"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_model_initial.png" alt="user_model_initial"></span>
<div class="caption"><span class="header">Figure 6.2: </span><span class="description">The users data model produced by <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_migration" class="hyperref">Listing&nbsp;<span class="ref">6.2</span></a>.
</span></div></div>
<p>We can run the migration, known as “migrating up”, using the <code>rake</code> command (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-rake" class="hyperref">Box&nbsp;<span class="ref">2.1</span></a>) as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div></div>
<p>(You may recall that we ran this command in a similar context in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_users_resource" class="hyperref">Section&nbsp;<span class="ref">2.2</span></a>.)<span class="intersentencespace"></span> The first time <code>db:migrate</code> is run, it creates a file called <code>db/development.sqlite3</code>, which is an <a href="http://sqlite.org/" target="_blank">SQLite</a><sup id="_cha-6_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-5">5</a></sup> database.<span class="intersentencespace"></span> We can see the structure of the database using the excellent <a href="http://sqlitebrowser.org/" target="_blank">SQLite Database Browser</a> to open the <code>db/development.sqlite3</code> file (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sqlite_database_browser" class="hyperref">Figure&nbsp;<span class="ref">6.3</span></a>); compare with the diagram in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_model_initial" class="hyperref">Figure&nbsp;<span class="ref">6.2</span></a>.<span class="intersentencespace"></span> You might note that there’s one column in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sqlite_database_browser" class="hyperref">Figure&nbsp;<span class="ref">6.3</span></a> not accounted for in the migration: the <code>id</code> column.<span class="intersentencespace"></span> As noted briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_users_resource" class="hyperref">Section&nbsp;<span class="ref">2.2</span></a>, this column is created automatically, and is used by Rails to identify each row uniquely.</p>
<div class="center figure" id="_fig-sqlite_database_browser" data-tralics-id="uid433" data-number="6.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/sqlite_database_browser.png" alt="images/figures/sqlite_database_browser"></div><div class="caption"><span class="header">Figure 6.3: </span><span class="description">The <a href="http://sqlitebrowser.sourceforge.net/" target="_blank">SQLite Database Browser</a> with our new <code>users</code> table.
</span></div></div>
<p>Most migrations, including all the ones in the <em>Rails Tutorial</em>, are <em>reversible</em>, which means we can “migrate down” and undo them with a single Rake task, called <code>db:rollback</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:rollback
</pre></div></div>
<p>(See <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-undoing_things" class="hyperref">Box&nbsp;<span class="ref">3.2</span></a> for another technique useful for reversing migrations.)<span class="intersentencespace"></span> Under the hood, this command executes the <code>drop_table</code> command to remove the users table from the database.<span class="intersentencespace"></span> The reason this works is that the <code>change</code> method knows that <code>drop_table</code> is the inverse of <code>create_table</code>, which means that the rollback migration can be easily inferred.<span class="intersentencespace"></span> In the case of an irreversible migration, such as one to remove a database column, it is necessary to define separate <code>up</code> and <code>down</code> methods in place of the single <code>change</code> method.<span class="intersentencespace"></span> Read about <a href="http://guides.rubyonrails.org/migrations.html" target="_blank">migrations in the Rails Guides</a> for more information.</p>
<p>If you rolled back the database, migrate up again before proceeding:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div></div>
</div>
<div id="_sec-the_model_file" data-tralics-id="uid434" class="subsection" data-number="6.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_model_file" class="heading hyperref"><span class="number">6.1.2 </span>The model file</a></h3>
<p>We’ve seen how the User model generation in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_user_model" class="hyperref">Listing&nbsp;<span class="ref">6.1</span></a> generated a migration file (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_migration" class="hyperref">Listing&nbsp;<span class="ref">6.2</span></a>), and we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sqlite_database_browser" class="hyperref">Figure&nbsp;<span class="ref">6.3</span></a> the results of running this migration: it updated a file called <code>development.sqlite3</code> by creating a table <code>users</code> with columns <code>id</code>, <code>name</code>, <code>email</code>, <code>created_at</code>, and <code>updated_at</code>.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_user_model" class="hyperref">Listing&nbsp;<span class="ref">6.1</span></a> also created the model itself; the rest of this section is dedicated to understanding it.</p>
<p>We begin by looking at the code for the User model, which lives in the file <code>user.rb</code> inside the <code>app/models/</code> directory.<span class="intersentencespace"></span> It is, to put it mildly, very compact (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-raw_user_model" class="hyperref">Listing&nbsp;<span class="ref">6.3</span></a>).</p>
<div class="codelisting" id="_code-raw_user_model" data-tralics-id="uid435" data-number="6.3"><div class="heading"><span class="number">Listing 6.3:</span> 

<span class="description">The brand new User model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre></div></div></div><p>Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_class_of_our_own" class="hyperref">Section&nbsp;<span class="ref">4.4.2</span></a> that the syntax <code>class User &lt; ActiveRecord::Base</code> means that the <code>User</code> class <em>inherits</em> from <code>ActiveRecord::Base</code>, so that the User model automatically has all the functionality of the <code>ActiveRecord::Base</code> class.<span class="intersentencespace"></span> Of course, knowledge of this inheritance doesn’t do any good unless we know what <code>ActiveRecord::Base</code> contains, so let’s get started with some concrete examples.</p>
</div>
<div id="_sec-creating_user_objects" data-tralics-id="uid436" class="subsection" data-number="6.1.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_user_objects" class="heading hyperref"><span class="number">6.1.3 </span>Creating user objects</a></h3>
<p>As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-rails_flavored_ruby" class="hyperref">Chapter&nbsp;<span class="ref">4</span></a>, our tool of choice for exploring data models is the Rails console.<span class="intersentencespace"></span> Since we don’t (yet) want to make any changes to our database, we’ll start the console in a <em>sandbox</em>:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="go">Loading development environment in sandbox</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="go">&gt;&gt;</span>
</pre></div></div>
<p>As indicated by the helpful message “Any modifications you make will be rolled back on exit”, when started in a sandbox the console will “roll back” (i.e., undo) any database changes introduced during the session.</p>
<p>In the console session in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>, we created a new user object with <code>User.new</code>, which we had access to only after requiring the example user file in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-example_user" class="hyperref">Listing&nbsp;<span class="ref">4.9</span></a>.<span class="intersentencespace"></span> With models, the situation is different; as you may recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_controller_class" class="hyperref">Section&nbsp;<span class="ref">4.4.4</span></a>, the Rails console automatically loads the Rails environment, which includes the models.<span class="intersentencespace"></span> This means that we can make a new user object without any further work:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, name: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div></div>
<p>We see here the default console representation of a user object.</p>
<p>When called with no arguments, <code>User.new</code> returns an object with all <code>nil</code> attributes.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>, we designed the example User class to take an <em>initialization hash</em> to set the object attributes; that design choice was motivated by Active Record, which allows objects to be initialized in the same way:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div></div>
<p>Here we see that the name and email attributes have been set as expected.</p>
<p>If you’ve been tailing the development log, you may have noticed that no new lines have shown up yet.<span class="intersentencespace"></span> This is because calling <code>User.new</code> doesn’t touch the database; it simply creates a new Ruby object in memory.<span class="intersentencespace"></span> To save the user object to the database, we call the <code>save</code> method on the <code>user</code> variable:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>The <code>save</code> method returns <code>true</code> if it succeeds and <code>false</code> otherwise.<span class="intersentencespace"></span> (Currently, all saves should succeed; we’ll see cases in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_validations" class="hyperref">Section&nbsp;<span class="ref">6.2</span></a> when some will fail.)<span class="intersentencespace"></span> As soon as you save, you should see a line in the console with the SQL command to <code>INSERT INTO "users"</code>.<span class="intersentencespace"></span> Because of the many methods supplied by Active Record, we won’t ever need raw SQL in this book, and I’ll omit discussion of the SQL commands from now on.<span class="intersentencespace"></span> But you can learn a lot by reading the SQL corresponding to Active Record commands.</p>
<p>You may have noticed that the new user object had <code>nil</code> values for the <code>id</code> and the magic columns <code>created_at</code> and <code>updated_at</code> attributes.<span class="intersentencespace"></span> Let’s see if our <code>save</code> changed anything:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 00:57:46", updated_at: "2013-03-11 00:57:46"&gt;</span>
</pre></div></div>
<p>We see that the <code>id</code> has been assigned a value of&nbsp;<code>1</code>, while the magic columns have been assigned the current time and date.<sup id="_cha-6_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-6">6</a></sup><span class="intersentencespace"></span> Currently, the created and updated timestamps are identical; we’ll see them differ in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.5</span></a>.</p>
<p>As with the User class in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>, instances of the User model allow access to their attributes using a dot notation:<sup id="_cha-6_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-7">7</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "Michael Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.com"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Mon, 11 Mar 2013 00:57:46 UTC +00:00</span>
</pre></div></div>
<p>As we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>, it’s often convenient to make and save a model in two steps as we have above, but Active Record also lets you combine them into one step with <code>User.create</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"A Nother"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"another@example.org"</span><span class="p">)</span>
<span class="go">#&lt;User id: 2, name: "A Nother", email: "another@example.org", created_at:</span>
<span class="go">"2013-03-11 01:05:24", updated_at: "2013-03-11 01:05:24"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@bar.com"</span><span class="p">)</span>
<span class="go">#&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2013-03-11</span>
<span class="go">01:05:42", updated_at: "2013-03-11 01:05:42"&gt;</span>
</pre></div></div>
<p>Note that <code>User.create</code>, rather than returning <code>true</code> or <code>false</code>, returns the User object itself, which we can optionally assign to a variable (such as <code>foo</code> in the second command above).</p>
<p>The inverse of <code>create</code> is <code>destroy</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">=&gt; #&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2013-03-11</span>
<span class="go">01:05:42", updated_at: "2013-03-11 01:05:42"&gt;</span>
</pre></div></div>
<p>Oddly, <code>destroy</code>, like <code>create</code>, returns the object in question, though I can’t recall ever having used the return value of <code>destroy</code>.<span class="intersentencespace"></span> Even odder, perhaps, is that the <code>destroy</code>ed object still exists in memory:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2013-03-11</span>
<span class="go">01:05:42", updated_at: "2013-03-11 01:05:42"&gt;</span>
</pre></div></div>
<p>How do we know if we really destroyed an object?<span class="intersentencespace"></span> And for saved and non-destroyed objects, how can we retrieve users from the database?<span class="intersentencespace"></span> It’s time to learn how to use Active Record to find user objects.</p>
</div>
<div id="_sec-finding_user_objects" data-tralics-id="uid439" class="subsection" data-number="6.1.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="heading hyperref"><span class="number">6.1.4 </span>Finding user objects</a></h3>
<p>Active Record provides several options for finding objects.<span class="intersentencespace"></span> Let’s use them to find the first user we created while verifying that the third user (<code>foo</code>) has been destroyed.<span class="intersentencespace"></span> We’ll start with the existing user:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 00:57:46", updated_at: "2013-03-11 00:57:46"&gt;</span>
</pre></div></div>
<p>Here we’ve passed the id of the user to <code>User.find</code>; Active Record returns the user with that&nbsp;id.</p>
<p>Let’s see if the user with an <code>id</code> of&nbsp;<code>3</code> still exists in the database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn't find User with ID=3</span>
</pre></div></div>
<p>Since we destroyed our third user in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.3</span></a>, Active Record can’t find it in the database.<span class="intersentencespace"></span> Instead, <code>find</code> raises an <em>exception</em>, which is a way of indicating an exceptional event in the execution of a program—in this case, a nonexistent Active Record id, which causes <code>find</code> to raise an <code>ActiveRecord::RecordNotFound</code> exception.<sup id="_cha-6_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-8">8</a></sup></p>
<p>In addition to the generic <code>find</code>, Active Record also allows us to find users by specific attributes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 00:57:46", updated_at: "2013-03-11 00:57:46"&gt;</span>
</pre></div></div>
<p>The <code>find_by_email</code> method is automatically created by Active Record based on the <code>email</code> attribute in the <code>users</code> table.<span class="intersentencespace"></span> (As you might guess, Active Record creates a <code>find_by_name</code> method as well.)<span class="intersentencespace"></span> Starting in Rails&nbsp;4.0, the preferred method to find by attribute is to use the <code>find_by</code> method instead, passing the attribute as a hash:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 00:57:46", updated_at: "2013-03-11 00:57:46"&gt;</span>
</pre></div></div>
<p>Since we will be using email addresses as usernames, this sort of <code>find</code> will be useful when we learn how to let users sign in to our site (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>).<span class="intersentencespace"></span> If you’re worried that <code>find_by</code> will be inefficient if there are a large number of users, you’re ahead of the game; we’ll cover this issue, and its solution via database indices, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-uniqueness_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.5</span></a>.</p>
<p>We’ll end with a couple of more general ways of finding users.<span class="intersentencespace"></span> First, there’s <code>first</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 00:57:46", updated_at: "2013-03-11 00:57:46"&gt;</span>
</pre></div></div>
<p>Naturally, <code>first</code> just returns the first user in the database.<span class="intersentencespace"></span> There’s also <code>all</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; [#&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 00:57:46", updated_at: "2013-03-11 00:57:46"&gt;,</span>
<span class="go">#&lt;User id: 2, name: "A Nother", email: "another@example.org", created_at:</span>
<span class="go">"2013-03-11 01:05:24", updated_at: "2013-03-11 01:05:24"&gt;]</span>
</pre></div></div>
<p>No prizes for inferring that <code>all</code> returns an array (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-arrays_and_ranges" class="hyperref">Section&nbsp;<span class="ref">4.3.1</span></a>) of all users in the database.</p>
</div>
<div id="_sec-updating_user_objects" data-tralics-id="uid441" class="subsection" data-number="6.1.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_user_objects" class="heading hyperref"><span class="number">6.1.5 </span>Updating user objects</a></h3>
<p>Once we’ve created objects, we often want to update them.<span class="intersentencespace"></span> There are two basic ways to do this.<span class="intersentencespace"></span> First, we can assign attributes individually, as we did in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user's attributes</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 00:57:46", updated_at: "2013-03-11 00:57:46"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"mhartl@example.net"</span>
<span class="go">=&gt; "mhartl@example.net"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>Note that the final step is necessary to write the changes to the database.<span class="intersentencespace"></span> We can see what happens without a save by using <code>reload</code>, which reloads the object based on the database information:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.net"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"foo@bar.com"</span>
<span class="go">=&gt; "foo@bar.com"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.net"</span>
</pre></div></div>
<p>Now that we’ve updated the user by running <code>user.save</code>, the magic columns differ, as promised in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.3</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; "2013-03-11 00:57:46"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; "2013-03-11 01:37:32"</span>
</pre></div></div>
<p>The second main way to update attributes is to use <code>update_attributes</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"The Dude"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"dude@abides.org"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "The Dude"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "dude@abides.org"</span>
</pre></div></div>
<p>The <code>update_attributes</code> method accepts a hash of attributes, and on success performs both the update and the save in one step (returning <code>true</code> to indicate that the save went through).<span class="intersentencespace"></span> Note that if any of the validations fail, such as when a password is required to save a record (as implemented in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3</span></a>), the call to <code>update_attributes</code> will fail.<span class="intersentencespace"></span> If we only need to update a single attribute, using the singular <code>update_attribute</code> bypasses this restriction:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"The Dude"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "The Dude"</span>
</pre></div></div>
</div></div>
<div id="_sec-user_validations" data-tralics-id="cid35" class="section" data-number="6.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_validations" class="heading hyperref"><span class="number">6.2 </span>User validations</a></h2>
<p>The User model we created in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_model" class="hyperref">Section&nbsp;<span class="ref">6.1</span></a> now has working <code>name</code> and <code>email</code> attributes, but they are completely generic: any string (including an empty one) is currently valid in either case.<span class="intersentencespace"></span> And yet, names and email addresses are more specific than this.<span class="intersentencespace"></span> For example, <code>name</code> should be non-blank, and <code>email</code> should match the specific format characteristic of email addresses.<span class="intersentencespace"></span> Moreover, since we’ll be using email addresses as unique usernames when users sign in, we shouldn’t allow email duplicates in the database.</p>
<p>In short, we shouldn’t allow <code>name</code> and <code>email</code> to be just any strings; we should enforce certain constraints on their values.<span class="intersentencespace"></span> Active Record allows us to impose such constraints using <em>validations</em>.<span class="intersentencespace"></span> In this section, we’ll cover several of the most common cases, validating <em>presence</em>, <em>length</em>, <em>format</em> and <em>uniqueness</em>.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-has_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3.4</span></a> we’ll add a final common validation, <em>confirmation</em>.<span class="intersentencespace"></span> And we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_failure" class="hyperref">Section&nbsp;<span class="ref">7.3</span></a> how validations give us convenient error messages when users make submissions that violate them.</p>
<div id="_sec-initial_user_tests" data-tralics-id="uid442" class="subsection" data-number="6.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-initial_user_tests" class="heading hyperref"><span class="number">6.2.1 </span>Initial user tests</a></h3>
<p>As with the other features of our sample app, we’ll add User model validations using test-driven development.<span class="intersentencespace"></span> Because we didn’t pass the</p>
<pre>--no-test-framework</pre>
<p>flag when we generated the User model (unlike, e.g., <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_users_controller" class="hyperref">Listing&nbsp;<span class="ref">5.31</span></a>), the command in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_user_model" class="hyperref">Listing&nbsp;<span class="ref">6.1</span></a> produces an initial spec for testing users, but in this case it’s practically blank (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-default_user_spec" class="hyperref">Listing&nbsp;<span class="ref">6.4</span></a>).</p>
<div class="codelisting" id="_code-default_user_spec" data-tralics-id="uid443" data-number="6.4"><div class="heading"><span class="number">Listing 6.4:</span> 

<span class="description">The practically blank default User spec.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">pending</span> <span class="s2">"add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</pre></div></div></div><p>This simply uses the <code>pending</code> method to indicate that we should fill the spec with something useful.<span class="intersentencespace"></span> We can see its effect by preparing a (blank) test database and running the User model spec:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
<span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">*</span>


<span class="go">Finished in 0.01999 seconds</span>
<span class="go">1 example, 0 failures, 1 pending</span>

<span class="go">Pending:</span>
<span class="go">  User add some examples to (or delete)</span>
<span class="go">  /Users/mhartl/rails_projects/sample_app/spec/models/user_spec.rb</span>
<span class="go">  (Not Yet Implemented)</span>
</pre></div></div>
<p>On many systems, pending specs will be displayed in yellow to indicate that they are in between passing (green) and failing (red).</p>
<p>This is the first time we’ve seen the command to create a test database with the correct structure:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>This just ensures that the data model from the development database, <code>db/development.sqlite3</code>, is reflected in the test database, <code>db/test.sqlite3</code>.<sup id="_cha-6_footnote-ref-9" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-9">9</a></sup><span class="intersentencespace"></span> (Failure to run this Rake task after a migration is a common source of confusion.<span class="intersentencespace"></span> In addition, sometimes the test database gets corrupted and needs to be reset.<span class="intersentencespace"></span> If your test suite is mysteriously breaking, be sure to try running <code>rake test:prepare</code> to see if that fixes the problem.)<span class="intersentencespace"></span> Note that by default the test database gets <a href="http://en.wikipedia.org/wiki/Rollback_(data_management)" target="_blank">rolled back</a> at the end of each test, so each run of the tests starts with a fresh database.</p>
<p>We’ll follow the advice of the default spec by filling it in with some RSpec examples, shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_spec" class="hyperref">Listing&nbsp;<span class="ref">6.5</span></a>.</p>
<div class="codelisting" id="_code-user_spec" data-tralics-id="uid445" data-number="6.5"><div class="heading"><span class="number">Listing 6.5:</span> 

<span class="description">Testing for the <code>:name</code> and <code>:email</code> attributes.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>The <code>before</code> block, which we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-pretty_page_tests" class="hyperref">Listing&nbsp;<span class="ref">5.30</span></a>, runs the code inside the block before each example—in this case, creating a new <code>@user</code> instance variable using <code>User.new</code> and a valid initialization hash.<span class="intersentencespace"></span> Then</p>
<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
</pre></div></div>
<p>makes <code>@user</code> the default subject of the test example, as seen before in the context of the <code>page</code> variable in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pretty_rspec" class="hyperref">Section&nbsp;<span class="ref">5.3.4</span></a>.</p>
<p>The two examples in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_spec" class="hyperref">Listing&nbsp;<span class="ref">6.5</span></a> test for the existence of <code>name</code> and <code>email</code> attributes:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>By themselves, these tests aren’t particularly useful, as a User object that lacks (say) a <code>name</code> attribute will throw an exception in the <code>before</code> block.<span class="intersentencespace"></span> But these tests do ensure that the constructions <code>user.name</code> and <code>user.email</code> are valid, whereas the <code>before</code> block only tests the attributes when passed as a hash to <code>new</code>.<span class="intersentencespace"></span> In addition, testing for model attributes is a useful convention, as it allows us to see at a glance the methods the model should respond to.</p>
<p>The <code>respond_to</code> methods implicitly use the Ruby method <code>respond_to?</code>, which accepts a symbol and returns <code>true</code> if the object responds to the given method or attribute and <code>false</code> otherwise:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:foobar</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>(Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-objects_and_message_passing" class="hyperref">Section&nbsp;<span class="ref">4.2.3</span></a> that Ruby uses a question mark to indicate such true/false boolean methods.)<span class="intersentencespace"></span> The tests themselves rely on the <em>boolean convention</em> used by RSpec: the code</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div></div>
<p>can be tested using the RSpec code</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">"should respond to 'name'"</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>Because of <code>subject { @user }</code>, we can alternatively write this using the single-line style introduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pretty_rspec" class="hyperref">Section&nbsp;<span class="ref">5.3.4</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>These kinds of tests allow us to use TDD to add new attributes and methods to our User model, and as a side-effect we get a nice specification for the methods that all <code>User</code> objects should respond to.</p>
<p>Because we have already properly prepared the test database with <code>rake test:prepare</code>, the tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-presence_validation" data-tralics-id="uid446" class="subsection" data-number="6.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-presence_validation" class="heading hyperref"><span class="number">6.2.2 </span>Validating presence</a></h3>
<p>Perhaps the most elementary validation is <em>presence</em>, which simply verifies that a given attribute is present.<span class="intersentencespace"></span> For example, in this section we’ll ensure that both the name and email fields are present before a user gets saved to the database.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_error_messages" class="hyperref">Section&nbsp;<span class="ref">7.3.3</span></a>, we’ll see how to propagate this requirement up to the signup form for creating new users.</p>
<p>We’ll start with a test for the presence of a <code>name</code> attribute.<span class="intersentencespace"></span> Although the first step in TDD is to write a <em>failing</em> test (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-TDD" class="hyperref">Section&nbsp;<span class="ref">3.2.1</span></a>), in this case we don’t yet know enough about validations to write the proper test, so we’ll write the validation first, using the console to understand it.<span class="intersentencespace"></span> Then we’ll comment out the validation, write a failing test, and verify that uncommenting the validation gets the test to pass.<span class="intersentencespace"></span> This procedure may seem pedantic for such a simple test, but I have seen many “simple” tests that actually test the wrong thing; being meticulous about TDD is simply the <em>only</em> way to be confident that we’re testing the right thing.<span class="intersentencespace"></span> (This comment-out technique is also useful when rescuing an application whose application code is already written but—<a href="http://en.wiktionary.org/wiki/quelle_horreur" target="_blank"><em>quelle horreur!</em></a>—has no tests.)</p>
<p>The way to validate the presence of the name attribute is to use the <code>validates</code> method with argument <code>presence: true</code>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_presence_of_name" class="hyperref">Listing&nbsp;<span class="ref">6.6</span></a>.<span class="intersentencespace"></span> The <code>presence: true</code> argument is a one-element <em>options hash</em>; recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-css_revisited" class="hyperref">Section&nbsp;<span class="ref">4.3.4</span></a> that curly braces are optional when passing hashes as the final argument in a method.<span class="intersentencespace"></span> (As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_to_the_layout" class="hyperref">Section&nbsp;<span class="ref">5.1.1</span></a>, the use of options hashes is a recurring theme in Rails.)</p>
<div class="codelisting" id="_code-validates_presence_of_name" data-tralics-id="uid447" data-number="6.6"><div class="heading"><span class="number">Listing 6.6:</span> 

<span class="description">Validating the presence of a <code>name</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_presence_of_name" class="hyperref">Listing&nbsp;<span class="ref">6.6</span></a> may look like magic, but <code>validates</code> is just a method.<span class="intersentencespace"></span> An equivalent formulation of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_presence_of_name" class="hyperref">Listing&nbsp;<span class="ref">6.6</span></a> using parentheses is as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>Let’s drop into the console to see the effects of adding a validation to our User model:<sup id="_cha-6_footnote-ref-10" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-10">10</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>Here <code>user.save</code> returns <code>false</code>, indicating a failed save.<span class="intersentencespace"></span> In the final command, we use the <code>valid?</code> method, which returns <code>false</code> when the object fails one or more validations, and <code>true</code> when all validations pass.<span class="intersentencespace"></span> In this case, we only have one validation, so we know which one failed, but it can still be helpful to check using the <code>errors</code> object generated on failure:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; ["Name can't be blank"]</span>
</pre></div></div>
<p>(The error message is a hint that Rails validates the presence of an attribute using the <code>blank?</code> method, which we saw at the end of <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modifying_built_in_classes" class="hyperref">Section&nbsp;<span class="ref">4.4.3</span></a>.)</p>
<p>Now for the failing test.<span class="intersentencespace"></span> To ensure that our incipient test will fail, let’s comment out the validation at this point (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-commented_out_validation" class="hyperref">Listing&nbsp;<span class="ref">6.7</span></a>).</p>
<div class="codelisting" id="_code-commented_out_validation" data-tralics-id="uid449" data-number="6.7"><div class="heading"><span class="number">Listing 6.7:</span> 

<span class="description">Commenting out a validation to ensure a failing test.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># validates :name, presence: true</span>
<span class="k">end</span>
</pre></div></div></div><p>The initial validation tests then appear as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-failing_validates_name_spec" class="hyperref">Listing&nbsp;<span class="ref">6.8</span></a>.</p>
<div class="codelisting" id="_code-failing_validates_name_spec" data-tralics-id="uid450" data-number="6.8"><div class="heading"><span class="number">Listing 6.8:</span> 

<span class="description">A failing test for validation of the <code>name</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"when name is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">" "</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The first new example is just a sanity check, verifying that the subject (<code>@user</code>) is initially valid:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</pre></div></div>
<p>This is another example of the RSpec boolean convention we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-initial_user_tests" class="hyperref">Section&nbsp;<span class="ref">6.2.1</span></a>: whenever an object responds to a boolean method <code>foo?</code>, there is a corresponding test method called <code>be_foo</code>.<span class="intersentencespace"></span> In this case, we can test the result of calling</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</pre></div></div>
<p>with</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_valid</span>
<span class="k">end</span>
</pre></div></div>
<p>As before, <code>subject { @user }</code> lets us use the one-line style, yielding</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</pre></div></div>
<p>The second test first sets the user’s name to an invalid (blank) value, and then tests to see that the resulting <code>@user</code> object is invalid:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"when name is not present"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">" "</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>This uses a <code>before</code> block to set the user’s name to an invalid (blank) value and then checks that the resulting user object is not valid.</p>
<p>You should verify that the tests fail at this point:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">...F</span>
<span class="go">4 examples, 1 failure</span>
</pre></div></div>
<p>Now uncomment the validation (i.e., revert <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-commented_out_validation" class="hyperref">Listing&nbsp;<span class="ref">6.7</span></a> back to <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_presence_of_name" class="hyperref">Listing&nbsp;<span class="ref">6.6</span></a>) to get the tests to pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">....</span>
<span class="go">4 examples, 0 failures</span>
</pre></div></div>
<p>Of course, we also want to validate the presence of email addresses.<span class="intersentencespace"></span> The test (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_email_spec" class="hyperref">Listing&nbsp;<span class="ref">6.9</span></a>) is analogous to the one for the <code>name</code> attribute.</p>
<div class="codelisting" id="_code-validates_email_spec" data-tralics-id="uid451" data-number="6.9"><div class="heading"><span class="number">Listing 6.9:</span> 

<span class="description">A test for presence of the <code>email</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when email is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">" "</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The implementation is also virtually the same, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_presence_of_email" class="hyperref">Listing&nbsp;<span class="ref">6.10</span></a>.</p>
<div class="codelisting" id="_code-validates_presence_of_email" data-tralics-id="uid452" data-number="6.10"><div class="heading"><span class="number">Listing 6.10:</span> 

<span class="description">Validating the presence of the <code>name</code> and <code>email</code> attributes.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div><p>Now all the tests should pass, and the presence validations are complete.</p>
</div>
<div id="_sec-length_validation" data-tralics-id="uid453" class="subsection" data-number="6.2.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-length_validation" class="heading hyperref"><span class="number">6.2.3 </span>Length validation</a></h3>
<p>We’ve constrained our User model to require a name for each user, but we should go further: the user’s names will be displayed on the sample site, so we should enforce some limit on their length.<span class="intersentencespace"></span> With all the work we did in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-presence_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.2</span></a>, this step is easy.</p>
<p>We start with a test.<span class="intersentencespace"></span> There’s no science to picking a maximum length; we’ll just pull&nbsp;<code>50</code> out of thin air as a reasonable upper bound, which means verifying that names of&nbsp;<code>51</code> characters are too long (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-length_validation_test" class="hyperref">Listing&nbsp;<span class="ref">6.11</span></a>).</p>
<div class="codelisting" id="_code-length_validation_test" data-tralics-id="uid454" data-number="6.11"><div class="heading"><span class="number">Listing 6.11:</span> 

<span class="description">A test for <code>name</code> length validation.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when name is too long"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>For convenience, we’ve used “string multiplication” in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-length_validation_test" class="hyperref">Listing&nbsp;<span class="ref">6.11</span></a> to make a string 51 characters long.<span class="intersentencespace"></span> We can see how this works using the console:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div></div>
<p>The test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-length_validation_test" class="hyperref">Listing&nbsp;<span class="ref">6.11</span></a> should fail.<span class="intersentencespace"></span> To get it to pass, we need to know about the validation argument to constrain length, <code>:length</code>, along with the <code>:maximum</code> parameter to enforce the upper bound (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-length_validation" class="hyperref">Listing&nbsp;<span class="ref">6.12</span></a>).</p>
<div class="codelisting" id="_code-length_validation" data-tralics-id="uid455" data-number="6.12"><div class="heading"><span class="number">Listing 6.12:</span> 

<span class="description">Adding a length validation for the <code>name</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div><p>Now the tests should pass.<span class="intersentencespace"></span> With our test suite passing again, we can move on to a more challenging validation: email format.</p>
</div>
<div id="_sec-format_validation" data-tralics-id="uid456" class="subsection" data-number="6.2.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-format_validation" class="heading hyperref"><span class="number">6.2.4 </span>Format validation</a></h3>
<p>Our validations for the <code>name</code> attribute enforce only minimal constraints—any non-blank name under 51 characters will do—but of course the <code>email</code> attribute must satisfy more stringent requirements.<span class="intersentencespace"></span> So far we’ve only rejected blank email addresses; in this section, we’ll require email addresses to conform to the familiar pattern <code>user@example.com</code>.</p>
<p>Neither the tests nor the validation will be exhaustive, just good enough to accept most valid email addresses and reject most invalid ones.<span class="intersentencespace"></span> We’ll start with a couple tests involving collections of valid and invalid addresses.<span class="intersentencespace"></span> To make these collections, it’s worth knowing about the useful <code>%w[]</code> technique for making arrays of strings, as seen in this console session:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.COM THE_US-ER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; ["user@foo.COM", "THE_US-ER@foo.bar.org", "first.last@foo.jp"]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">user@foo.COM</span>
<span class="go">THE_US-ER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</pre></div></div>
<p>Here we’ve iterated over the elements of the <code>addresses</code> array using the <code>each</code> method (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-blocks" class="hyperref">Section&nbsp;<span class="ref">4.3.2</span></a>).<span class="intersentencespace"></span> With this technique in hand, we’re ready to write some basic email format validation tests (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_format_validation_tests" class="hyperref">Listing&nbsp;<span class="ref">6.13</span></a>).</p>
<div class="codelisting" id="_code-email_format_validation_tests" data-tralics-id="uid457" data-number="6.13"><div class="heading"><span class="number">Listing 6.13:</span> 

<span class="description">Tests for email format validation.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when email format is invalid"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should be invalid"</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo,com user_at_foo.org example.user@foo.</span>
<span class="sx">                     foo@bar_baz.com foo@bar+baz.com]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invalid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">invalid_address</span>
        <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_valid</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"when email format is valid"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.COM A_US-ER@f.b.org frst.lst@foo.jp a+b@baz.cn]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">valid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">valid_address</span>
        <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_valid</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As noted above, these are far from exhaustive, but we do check the common valid email forms <code>user@foo.COM</code>, <code>THE_US-ER@foo.bar.org </code> (uppercase, underscores, and compound domains), and <code>first.last@foo.jp</code> (the standard corporate username <code>first.last</code>, with a two-letter top-level domain&nbsp;<code>jp</code> (Japan)), along with several invalid forms.</p>
<p>The application code for email format validation uses a <em>regular expression</em> (or <em>regex</em>) to define the format, along with the <code>:format</code> argument to the <code>validates</code> method (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_format_of_email" class="hyperref">Listing&nbsp;<span class="ref">6.14</span></a>).</p>
<div class="codelisting" id="_code-validates_format_of_email" data-tralics-id="uid458" data-number="6.14"><div class="heading"><span class="number">Listing 6.14:</span> 

<span class="description">Validating the email format with a regular expression.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>Here the regex <code>VALID_EMAIL_REGEX</code> is a <em>constant</em>, indicated in Ruby by a name starting with a capital letter.<span class="intersentencespace"></span> The code</p>
<div class="code"><div class="highlight"><pre>  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
</pre></div></div>
<p>ensures that only email addresses that match the pattern will be considered valid.</p>
<p>So, where does the pattern come from?<span class="intersentencespace"></span> Regular expressions consist of a terse (some would say <a href="http://catb.org/jargon/html/L/line-noise.html" target="_blank">unreadable</a>) language for matching text patterns; learning to construct regexes is an art, and to get you started I’ve broken <code>VALID_EMAIL_REGEX</code> into bite-sized pieces (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-valid_email_regex" class="hyperref">Table&nbsp;<span class="ref">6.1</span></a>).<sup id="_cha-6_footnote-ref-11" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-11">11</a></sup><span class="intersentencespace"></span> To really learn about regular expressions, though, I consider the amazing <a href="http://www.rubular.com/" target="_blank">Rubular</a> regular expression editor (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-rubular" class="hyperref">Figure&nbsp;<span class="ref">6.4</span></a>) to be simply essential.<sup id="_cha-6_footnote-ref-12" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-12">12</a></sup><span class="intersentencespace"></span> The Rubular website has a beautiful interactive interface for making regular expressions, along with a handy regex quick reference.<span class="intersentencespace"></span> I encourage you to study <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-valid_email_regex" class="hyperref">Table&nbsp;<span class="ref">6.1</span></a> with a browser window open to Rubular—no amount of reading about regular expressions can replace a couple of hours playing with Rubular.<span class="intersentencespace"></span> (<em>Note</em>: If you use the regex from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_format_of_email" class="hyperref">Listing&nbsp;<span class="ref">6.14</span></a> in Rubular, you should leave off the <span class="inline_verbatim">\A</span> and <span class="inline_verbatim">\z</span> characters.)</p>
<div class="table" id="_table-valid_email_regex" data-tralics-id="uid461" data-number="6.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>Expression</strong></td>
<td class="align_left"><strong>Meaning</strong></td>
</tr><tr><td class="align_left"><span class="inline_verbatim">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span></td>
<td class="align_left">full regex</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">/</span></td>
<td class="align_left">start of regex</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">\A</span></td>
<td class="align_left">match start of a string</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">[\w+\-.]+</span></td>
<td class="align_left">at least one word character, plus, hyphen, or dot</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">@</span></td>
<td class="align_left">literal “at sign”</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">[a-z\d\-.]+</span></td>
<td class="align_left">at least one letter, digit, hyphen, or dot</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">\.</span></td>
<td class="align_left">literal dot</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">[a-z]+</span></td>
<td class="align_left">at least one letter</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">\z</span></td>
<td class="align_left">match end of a string</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">/</span></td>
<td class="align_left">end of regex</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">i</span></td>
<td class="align_left">case insensitive</td>
</tr></tbody></table><div class="caption"><span class="header">Table 6.1: </span><span class="description">Breaking down the email regex from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_format_of_email" class="hyperref">Listing&nbsp;<span class="ref">6.14</span></a>.
</span></div></div>
<p>By the way, there actually exists a full regex for matching email addresses according to the official standard, but it’s really not worth the trouble.<span class="intersentencespace"></span> The one in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_format_of_email" class="hyperref">Listing&nbsp;<span class="ref">6.14</span></a> is fine, maybe even better than the official one.<sup id="_cha-6_footnote-ref-13" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-13">13</a></sup><span class="intersentencespace"></span> The expression above does have one weakness, though: it allows invalid addresses such as <code>foo@bar..com</code> that contain consecutive dots.<span class="intersentencespace"></span> Fixing this blemish is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_users_exercises" class="hyperref">Section&nbsp;<span class="ref">6.5</span></a>).</p>
<div class="center figure" id="_fig-rubular" data-tralics-id="uid463" data-number="6.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/rubular.png" alt="images/figures/rubular"></div><div class="caption"><span class="header">Figure 6.4: </span><span class="description">The awesome <a href="http://www.rubular.com/" target="_blank">Rubular</a> regular expression editor.
</span></div></div>
<p>The tests should all be passing now.<span class="intersentencespace"></span> (In fact, the tests for valid email addresses should have been passing all along; since regexes are notoriously error-prone, the valid email tests are there mainly as a sanity check on <code>VALID_EMAIL_REGEX</code>.)<span class="intersentencespace"></span> This means that there’s only one constraint left: enforcing the email addresses to be unique.</p>
</div>
<div id="_sec-uniqueness_validation" data-tralics-id="uid464" class="subsection" data-number="6.2.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-uniqueness_validation" class="heading hyperref"><span class="number">6.2.5 </span>Uniqueness validation</a></h3>
<p>To enforce uniqueness of email addresses (so that we can use them as usernames), we’ll be using the <code>:unique</code> option to the <code>validates</code> method.<span class="intersentencespace"></span> But be warned: there’s a <em>major</em> caveat, so don’t just skim this section—read it carefully.</p>
<p>We’ll start, as usual, with our tests.<span class="intersentencespace"></span> In our previous model tests, we’ve mainly used <code>User.new</code>, which just creates a Ruby object in memory, but for uniqueness tests we actually need to put a record into the database.<sup id="_cha-6_footnote-ref-14" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-14">14</a></sup><span class="intersentencespace"></span> The (first) duplicate email test appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_uniqueness_of_email_test" class="hyperref">Listing&nbsp;<span class="ref">6.15</span></a>.</p>
<div class="codelisting" id="_code-validates_uniqueness_of_email_test" data-tralics-id="uid466" data-number="6.15"><div class="heading"><span class="number">Listing 6.15:</span> 

<span class="description">A test for the rejection of duplicate email addresses.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when email address is already taken"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The method here is to make a user with the same email address as <code>@user</code>, which we accomplish using <code>@user.dup</code>, which creates a duplicate user with the same attributes.<span class="intersentencespace"></span> Since we then save that user, the original <code>@user</code> has an email address that already exists in the database, and hence should not be valid.</p>
<p>We can get the new test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_uniqueness_of_email_test" class="hyperref">Listing&nbsp;<span class="ref">6.15</span></a> to pass with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_uniqueness_of_email" class="hyperref">Listing&nbsp;<span class="ref">6.16</span></a>.</p>
<div class="codelisting" id="_code-validates_uniqueness_of_email" data-tralics-id="uid467" data-number="6.16"><div class="heading"><span class="number">Listing 6.16:</span> 

<span class="description">Validating the uniqueness of email addresses.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div><p>We’re not quite done, though.<span class="intersentencespace"></span> Email addresses are typically processed as if they were case-insensitive—i.e., <code>foo@bar.com</code> is treated the same as <code>FOO@BAR.COM</code> or <code>FoO@BAr.coM</code>—so our validation should incorporate this as well.<sup id="_cha-6_footnote-ref-15" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-15">15</a></sup><span class="intersentencespace"></span> We test for case-insensitivity with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_uniqueness_of_email_case_insensitive_test" class="hyperref">Listing&nbsp;<span class="ref">6.17</span></a>.</p>
<div class="codelisting" id="_code-validates_uniqueness_of_email_case_insensitive_test" data-tralics-id="uid469" data-number="6.17"><div class="heading"><span class="number">Listing 6.17:</span> 

<span class="description">A test for the rejection of duplicate email addresses, insensitive to case.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when email address is already taken"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we are using the <code>upcase</code> method on strings (seen briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-blocks" class="hyperref">Section&nbsp;<span class="ref">4.3.2</span></a>).<span class="intersentencespace"></span> This test does the same thing as the first duplicate email test, but with an upper-case email address instead.<span class="intersentencespace"></span> If this test feels a little abstract, go ahead and fire up the console:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="go">=&gt; "USER@EXAMPLE.COM"</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">dup</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>Of course, <code>user_with_same_email.valid?</code> is <code>true</code>, because the uniqueness validation is currently case-sensitive, but we want it to be <code>false</code>.<span class="intersentencespace"></span> Fortunately, <code>:uniqueness</code> accepts an option, <code>:case_sensitive</code>, for just this purpose (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_uniqueness_of_email_case_insensitive" class="hyperref">Listing&nbsp;<span class="ref">6.18</span></a>).</p>
<div class="codelisting" id="_code-validates_uniqueness_of_email_case_insensitive" data-tralics-id="uid470" data-number="6.18"><div class="heading"><span class="number">Listing 6.18:</span> 

<span class="description">Validating the uniqueness of email addresses, ignoring case.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we have simply replaced <code>true</code> with <code>case_sensitive: false</code>; Rails infers in this case that <code>:uniqueness</code> should be <code>true</code>.<span class="intersentencespace"></span> At this point, our application—with an important caveat—enforces email uniqueness, and our test suite should pass.</p>
<div id="_sec-the_caveat" data-tralics-id="uid471" class="subsubsection" data-number="6.2.5.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_caveat" class="heading">The uniqueness caveat</a></h4>
<p>There’s just one small problem, the caveat alluded to above:</p>
<p><strong>Using <code>validates :uniqueness</code> does not guarantee uniqueness.</strong></p>
<p>D’oh!<span class="intersentencespace"></span> But what can go wrong?<span class="intersentencespace"></span> Here’s what:</p>
<ol>
<li>Alice signs up for the sample app, with address alice@wonderland.com.<span class="intersentencespace"></span>
</li>
<li>Alice accidentally clicks on “Submit” <em>twice</em>, sending two requests in quick succession.<span class="intersentencespace"></span>
</li>
<li>The following sequence occurs: request 1 creates a user in memory that passes validation, request 2 does the same, request&nbsp;1’s user gets saved, request&nbsp;2’s user gets saved.<span class="intersentencespace"></span>
</li>
<li>Result: two user records with the exact same email address, despite the uniqueness validation.<span class="intersentencespace"></span>
</li></ol>
<p>If the above sequence seems implausible, believe me, it isn’t: it can happen on any Rails website with significant traffic.<span class="intersentencespace"></span> Luckily, the solution is straightforward to implement; we just need to enforce uniqueness at the database level as well.<span class="intersentencespace"></span> Our method is to create a database <em>index</em> on the email column, and then require that the index be unique.</p>
<p>The email index represents an update to our data modeling requirements, which (as discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-database_migrations" class="hyperref">Section&nbsp;<span class="ref">6.1.1</span></a>) is handled in Rails using migrations.<span class="intersentencespace"></span> We saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-database_migrations" class="hyperref">Section&nbsp;<span class="ref">6.1.1</span></a> that generating the User model automatically created a new migration (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_migration" class="hyperref">Listing&nbsp;<span class="ref">6.2</span></a>); in the present case, we are adding structure to an existing model, so we need to create a migration directly using the <code>migration</code> generator:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_index_to_users_email
</pre></div></div>
<p>Unlike the migration for users, the email uniqueness migration is not pre-defined, so we need to fill in its contents with <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_uniqueness_index" class="hyperref">Listing&nbsp;<span class="ref">6.19</span></a>.<sup id="_cha-6_footnote-ref-16" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-16">16</a></sup></p>
<div class="codelisting" id="_code-email_uniqueness_index" data-tralics-id="uid477" data-number="6.19"><div class="heading"><span class="number">Listing 6.19:</span> 

<span class="description">The migration for enforcing email uniqueness.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_index_to_users_email.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIndexToUsersEmail</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This uses a Rails method called <code>add_index</code> to add an index on the <code>email</code> column of the <code>users</code> table.<span class="intersentencespace"></span> The index by itself doesn’t enforce uniqueness, but the option <code>unique: true</code> does.</p>
<p>The final step is to migrate the database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div></div>
<p>(If this fails, try exiting any running sandbox console sessions, which can lock the database and prevent migrations.)<span class="intersentencespace"></span> If you’re interested in seeing the practical effect of this, take a look at the file <code>db/schema.rb</code>, which should now include a line like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="s2">"users"</span><span class="p">,</span> <span class="o">[</span><span class="s2">"email"</span><span class="o">]</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"index_users_on_email"</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p>Unfortunately, there’s one more change we need to make to be assured of email uniqueness, which is to make sure that the email address is all lower-case before it gets saved to the database.<span class="intersentencespace"></span> The reason is that not all database adapters use case-sensitive indices.<sup id="_cha-6_footnote-ref-17" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-17">17</a></sup><span class="intersentencespace"></span> The way to do this is with a <a href="http://en.wikipedia.org/wiki/Callback_(computer_science)" target="_blank"><em>callback</em></a>, which is a method that gets invoked at a particular point in the lifetime of an Active Record object (see the <a href="http://api.rubyonrails.org/v4.0.0/classes/ActiveRecord/Callbacks.html" target="_blank">Rails API entry on callbacks</a>).<span class="intersentencespace"></span> In the present case, we’ll use a <code>before_save</code> callback to force Rails to downcase the email attribute before saving the user to the database, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase" class="hyperref">Listing&nbsp;<span class="ref">6.20</span></a>.</p>
<div class="codelisting" id="_code-email_downcase" data-tralics-id="uid479" data-number="6.20"><div class="heading"><span class="number">Listing 6.20:</span> 

<span class="description">Ensuring email uniqueness by downcasing the email attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase" class="hyperref">Listing&nbsp;<span class="ref">6.20</span></a> passes a block to the <code>before_save</code> callback and sets the user’s email address to a lower-case version of its current value using the <code>downcase</code> string method.<span class="intersentencespace"></span> This code is a little advanced, and at this point I suggest you simply trust that it works; if you’re skeptical, comment out the uniqueness validation from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_uniqueness_of_email" class="hyperref">Listing&nbsp;<span class="ref">6.16</span></a> and try to create users with identical email addresses to see the error that results.<span class="intersentencespace"></span> (We’ll see this technique again in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a>, where we’ll use the preferred <em>method reference</em> convention.)<span class="intersentencespace"></span> Writing a test for the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase" class="hyperref">Listing&nbsp;<span class="ref">6.20</span></a> is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_users_exercises" class="hyperref">Section&nbsp;<span class="ref">6.5</span></a>).</p>
<p>Now the Alice scenario above will work fine: the database will save a user record based on the first request, and will reject the second save for violating the uniqueness constraint.<span class="intersentencespace"></span> (An error will appear in the Rails log, but that doesn’t do any harm.<span class="intersentencespace"></span> You can actually catch the <code>ActiveRecord::StatementInvalid</code> exception that gets raised, but in this tutorial we won’t bother with this step.)<span class="intersentencespace"></span> Adding this index on the email attribute accomplishes a second goal, alluded to briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>: it fixes an efficiency problem in <code>find_by</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-database_indices" class="hyperref">Box&nbsp;<span class="ref">6.2</span></a>).</p>
<div class="aside" id="_sidebar-database_indices" data-tralics-id="uid480" data-number="6.2"><div class="heading"><span class="number">Box 6.2.</span> 

<span class="description">Database indices</span></div>
<p>When creating a column in a database, it is important to consider whether we will need to <em>find</em> records by that column.<span class="intersentencespace"></span> Consider, for example, the <span class="tt">email</span> attribute created by the migration in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_migration" class="hyperref">Listing&nbsp;<span class="ref">6.2</span></a>.<span class="intersentencespace"></span> When we allow users to sign in to the sample app starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>, we will need to find the user record corresponding to the submitted email address; unfortunately, based on the naïve data model, the only way to find a user by email address is to look through <em>each</em> user row in the database and compare its email attribute to the given email.<span class="intersentencespace"></span> This is known in the database business as a <em>full-table scan</em>, and for a real site with thousands of users it is a <a href="http://catb.org/jargon/html/B/Bad-Thing.html" target="_blank">Bad Thing</a>.</p>
<p>Putting an index on the email column fixes the problem.<span class="intersentencespace"></span> To understand a database index, it’s helpful to consider the analogy of a book index.<span class="intersentencespace"></span> In a book, to find all the occurrences of a given string, say “foobar”, you would have to scan each page for “foobar”.<span class="intersentencespace"></span> With a book index, on the other hand, you can just look up “foobar” in the index to see all the pages containing “foobar”.<span class="intersentencespace"></span> A database index works essentially the same way.</p>

</div></div></div></div>
<div id="_sec-adding_a_secure_password" data-tralics-id="cid36" class="section" data-number="6.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_secure_password" class="heading hyperref"><span class="number">6.3 </span>Adding a secure password</a></h2>
<p>In this section, we’ll add the last of the basic User attributes: a secure password used to authenticate users of the sample application.<span class="intersentencespace"></span> The method is to require each user to have a password (with a password confirmation), and then store a <em>hashed</em> version of the password in the database.<span class="intersentencespace"></span> (There is some potential for confusion here.<span class="intersentencespace"></span> In the present context, a <em>hash</em> refers not to the Ruby data structure from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-hashes_and_symbols" class="hyperref">Section&nbsp;<span class="ref">4.3.3</span></a> but rather to the result of applying a irreversible <a href="http://en.wikipedia.org/wiki/Hash_function" target="_blank">hash function</a> to input data.)<span class="intersentencespace"></span> We’ll also add a way to <em>authenticate</em> a user based on a given password, a method we’ll use in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a> to allow users to sign in to the site.</p>
<p>The method for authenticating users will be to take a submitted password, hash it, and compare the result to the hashed value stored in the database.<span class="intersentencespace"></span> If the two match, then the submitted password is correct and the user is authenticated.<span class="intersentencespace"></span> By comparing hashed values instead of raw passwords, we will be able to authenticate users without storing the passwords themselves.<span class="intersentencespace"></span> This means that, even if our database is compromised, our users’ passwords will still be secure.</p>
<p>Much of the secure password machinery will be implemented using a single Rails method called <code>has_secure_password</code> (first introduced in Rails&nbsp;3.1).<span class="intersentencespace"></span> Because so much of what follows depends on this one method, it is difficult to develop secure passwords incrementally.<span class="intersentencespace"></span> Starting in <a href="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io.html" class="hyperref">Section&nbsp;<span class="ref">6.3.2</span></a>, I recommend adding the <code>has_secure_password</code> method early on and then comment it out before adding each new test to use proper TDD.(Since screencasts allow for a more incremental development approach, interested readers should consider the <a href="http://railstutorial.org/screencasts" target="_blank">Ruby on Rails Tutorial screencasts</a> for a fuller understanding of this material.)</p>
<div id="_sec-a_hashed_password" data-tralics-id="uid481" class="subsection" data-number="6.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_hashed_password" class="heading hyperref"><span class="number">6.3.1 </span>A hashed password</a></h3>
<p>We’ll start with the necessary change to the data model for users, which involves adding a <code>password_digest</code> column to the <code>users</code> table (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_model_password_digest" class="hyperref">Figure&nbsp;<span class="ref">6.5</span></a>).<span class="intersentencespace"></span> The name <em>digest</em> comes from the terminology of <a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function" target="_blank">cryptographic hash functions</a>, and the exact name <code>password_digest</code> is necessary for the implementation in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-has_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3.4</span></a> to work.<span class="intersentencespace"></span> By hashing the password properly, we’ll ensure that an attacker won’t be able to sign in to the site even if they manage to obtain a copy of the database.</p>
<div class="center figure" id="_fig-user_model_password_digest" data-tralics-id="uid482" data-number="6.5"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_model_password_digest.png" alt="user_model_password_digest"></span>
<div class="caption"><span class="header">Figure 6.5: </span><span class="description">The User model with an added <code>password_digest</code> attribute.
</span></div></div>
<p>We’ll use the state-of-the-art hash function called <a href="http://en.wikipedia.org/wiki/Bcrypt" target="_blank">bcrypt</a> to irreversibly transform the password to make the password hash.<span class="intersentencespace"></span> To use bcrypt in the sample application, we need to add the <code>bcrypt-ruby</code> gem to our <code>Gemfile</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-bcrypt_ruby" class="hyperref">Listing&nbsp;<span class="ref">6.21</span></a>).</p>
<div class="codelisting" id="_code-bcrypt_ruby" data-tralics-id="uid483" data-number="6.21"><div class="heading"><span class="number">Listing 6.21:</span> 

<span class="description">Adding <code>bcrypt-ruby</code> to the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'sprockets'</span><span class="p">,</span> <span class="s1">'2.11.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.1.2'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then run <code>bundle install</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>Since we want users to have a password digest column, a user object should respond to <code>password_digest</code>, which suggests the test shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-respond_to_password_digest" class="hyperref">Listing&nbsp;<span class="ref">6.22</span></a>.</p>
<div class="codelisting" id="_code-respond_to_password_digest" data-tralics-id="uid484" data-number="6.22"><div class="heading"><span class="number">Listing 6.22:</span> 

<span class="description">Ensuring that a User object has a <code>password_digest</code> column.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To get the test to pass, we first generate an appropriate migration for the <code>password_digest</code> column:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_password_digest_to_users password_digest:string
</pre></div></div>
<p>Here the first argument is the migration name, and we’ve also supplied a second argument with the name and type of attribute we want to create.<span class="intersentencespace"></span> (Compare this to the original generation of the <code>users</code> table in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_user_model" class="hyperref">Listing&nbsp;<span class="ref">6.1</span></a>.)<span class="intersentencespace"></span> We can choose any migration name we want, but it’s convenient to end the name with <code>_to_users</code>, since in this case Rails automatically constructs a migration to add columns to the <code>users</code> table.<span class="intersentencespace"></span> Moreover, by including the second argument, we’ve given Rails enough information to construct the entire migration for us, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-password_migration" class="hyperref">Listing&nbsp;<span class="ref">6.23</span></a>.</p>
<div class="codelisting" id="_code-password_migration" data-tralics-id="uid485" data-number="6.23"><div class="heading"><span class="number">Listing 6.23:</span> 

<span class="description">The migration to add a <code>password_digest</code> column to the <code>users</code> table.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[ts]_add_password_digest_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPasswordDigestToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This code uses the <code>add_column</code> method to add a <code>password_digest</code> column to the <code>users</code> table.</p>
<p>We can get the failing test from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-respond_to_password_digest" class="hyperref">Listing&nbsp;<span class="ref">6.22</span></a> to pass by migrating the development database and preparing the test database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
<span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-password_and_confirmation" data-tralics-id="uid486" class="subsection" data-number="6.3.2"><h3><a href="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io.html" class="heading hyperref"><span class="number">6.3.2 </span>Password and confirmation</a></h3>
<p>As seen in the mockup in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_mockup_preview" class="hyperref">Figure&nbsp;<span class="ref">6.1</span></a>, we expect to have users confirm their passwords, a common practice on the web meant to minimize typos.<span class="intersentencespace"></span> We could enforce this at the controller layer, but it’s conventional to put it in the model and use Active Record to enforce the constraint.<span class="intersentencespace"></span> The method is to add <code>password</code> and <code>password_confirmation</code> attributes to the User model, and then require that the two attributes match before the record is saved to the database.<span class="intersentencespace"></span> Unlike the other attributes we’ve seen so far, the password attributes will be <em>virtual</em>—they will only exist temporarily in memory, and will not be persisted to the database.<span class="intersentencespace"></span> As we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-has_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3.4</span></a>, these virtual attributes are implemented automatically by <code>has_secure_password</code>.</p>
<p>We’ll start with <code>respond_to</code> tests for a password and its confirmation, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_respond_to_password" class="hyperref">Listing&nbsp;<span class="ref">6.24</span></a>.</p>
<div class="codelisting" id="_code-user_respond_to_password" data-tralics-id="uid487" data-number="6.24"><div class="heading"><span class="number">Listing 6.24:</span> 

<span class="description">Testing for the <code>password</code> and <code>password_confirmation</code> attributes.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we’ve added <code>:password</code> and <code>:password_confirmation</code> to the initialization hash for <code>User.new</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                   <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>We definitely don’t want users to enter a blank password, so we’ll add another test to validate password presence:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"when password is not present"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">" "</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">" "</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>Since we’ll be testing password mismatch in a moment, here we make sure to test the <em>presence</em> validation by setting both the password and its confirmation to a blank string.</p>
<p>We also want to ensure that the password and confirmation match.<span class="intersentencespace"></span> The case where they <em>do</em> match is already covered by <code>it { should be_valid }</code>, so we only need to test the case of a mismatch:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"when password doesn't match confirmation"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"mismatch"</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>Putting everything together gives the (failing) tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-password_tests" class="hyperref">Listing&nbsp;<span class="ref">6.25</span></a>.</p>
<div class="codelisting" id="_code-password_tests" data-tralics-id="uid488" data-number="6.25"><div class="heading"><span class="number">Listing 6.25:</span> 

<span class="description">Test for the password and password confirmation.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when password is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                       <span class="ss">password</span><span class="p">:</span> <span class="s2">" "</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">" "</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"when password doesn't match confirmation"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"mismatch"</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can get the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-password_tests" class="hyperref">Listing&nbsp;<span class="ref">6.25</span></a> to pass using just one extra line of code, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_passing_password_tests" class="hyperref">Listing&nbsp;<span class="ref">6.26</span></a>.</p>
<div class="codelisting" id="_code-initial_passing_password_tests" data-tralics-id="uid489" data-number="6.26"><div class="heading"><span class="number">Listing 6.26:</span> 

<span class="description">Getting the initial password tests to pass.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_secure_password</span>
<span class="k">end</span>
</pre></div></div></div><p>It’s remarkable that the one line</p>
<div class="code"><div class="highlight"><pre><span class="n">has_secure_password</span>
</pre></div></div>
<p>gets all of the current password tests to pass, and it does a lot more besides.<span class="intersentencespace"></span> Indeed, it does too much, preventing some of the upcoming tests from being red before going green, so before proceeding I recommend commenting it out (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-commented_out_has_secure_password" class="hyperref">Listing&nbsp;<span class="ref">6.27</span></a>).</p>
<div class="codelisting" id="_code-commented_out_has_secure_password" data-tralics-id="uid490" data-number="6.27"><div class="heading"><span class="number">Listing 6.27:</span> 

<span class="description">Commenting out <code>has_secure_password</code> for the sake of TDD. <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># has_secure_password</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-user_authentication" data-tralics-id="uid491" class="subsection" data-number="6.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_authentication" class="heading hyperref"><span class="number">6.3.3 </span>User authentication</a></h3>
<p>The final piece of our password machinery is a method to retrieve users based on their email and passwords.<span class="intersentencespace"></span> This divides naturally into two parts: first, find a user by email address; second, authenticate the user with a given password.<span class="intersentencespace"></span> All but the last of the tests in this section are implemented by <code>has_secure_password</code>, so while implementing them you should be able to uncomment the commented-out line in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-commented_out_has_secure_password" class="hyperref">Listing&nbsp;<span class="ref">6.27</span></a> to get them to pass.</p>
<p>The first step is simple; as we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>, we can find a user with a given email address using the <code>find_by</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">)</span>
</pre></div></div>
<p>The second step is then to use an <code>authenticate</code> method to verify that the user has the given password.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>, we’ll retrieve the current (signed-in) user using code something like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</pre></div></div>
<p>If the given password matches the user’s password, it should return the user; otherwise, it should return <code>false</code>.</p>
<p>As usual, we can express the requirement for <code>authenticate</code> using RSpec.<span class="intersentencespace"></span> The resulting tests are more advanced than the others we’ve seen, so let’s break them down into pieces; if you’re new to RSpec, you might want to read this section a couple of times.<span class="intersentencespace"></span> We start by requiring a User object to respond to <code>authenticate</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>We then cover the two cases of password match and mismatch:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"return value of authenticate method"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"with valid password"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"with invalid password"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"invalid"</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">eq</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user_for_invalid_password</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_false</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>The <code>before</code> block saves the user to the database so that it can be retrieved using <code>find_by</code>, which we accomplish using the <code>let</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>We’ve used <code>let</code> in a couple of exercises, but this is the first time we’ve seen it in the body of the tutorial.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-let" class="hyperref">Box&nbsp;<span class="ref">6.3</span></a> covers <code>let</code> in more detail.</p>
<p>The two <code>describe</code> blocks cover the case where <code>@user</code> and <code>found_user</code> should be the same (password match) and different (password mismatch); they use the “equals” <code>eq</code> test for object equality (which uses <code>==</code> to test equality, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-arrays_and_ranges" class="hyperref">Section&nbsp;<span class="ref">4.3.1</span></a>).<span class="intersentencespace"></span> Note that the tests in</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"with invalid password"</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"invalid"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">eq</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user_for_invalid_password</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>use <code>let</code> a second time, and also use the <code>specify</code> method.<span class="intersentencespace"></span> This is just a synonym for <code>it</code>, and can be used when writing <code>it</code> would sound unnatural.<span class="intersentencespace"></span> In this case, it sounds OK to say “it [i.e., the user] should not equal user for invalid password”, but it sounds strange to say “it user for invalid password should be false”; saying “specify: expect user for invalid password to be false” sounds better.</p>
<div class="aside" id="_sidebar-let" data-tralics-id="uid492" data-number="6.3"><div class="heading"><span class="number">Box 6.3.</span> 

<span class="description">Using <span class="tt">let</span></span></div>
<p>RSpec’s <span class="tt">let</span> method provides a convenient way to create local variables inside tests.<span class="intersentencespace"></span> The syntax might look a little strange, but its effect is similar to variable assignment.<span class="intersentencespace"></span> The argument of <span class="tt">let</span> is a symbol, and it takes a block whose return value is assigned to a local variable with the symbol’s name.<span class="intersentencespace"></span> In other words,</p>
<pre>let(:found_user) { User.find_by(email: @user.email) }</pre>
<p>creates a <span class="tt">found_user</span> variable whose value is equal to the result of <span class="tt">find_by</span>.<span class="intersentencespace"></span> We can then use this variable in any of the <span class="tt">before</span> or <span class="tt">it</span> blocks throughout the rest of the test.<span class="intersentencespace"></span> One advantage of <span class="tt">let</span> is that it <em>memoizes</em> its value, which means that it remembers the value from one invocation to the next.<span class="intersentencespace"></span> (Note that <a href="http://en.wikipedia.org/wiki/Memoization" target="_blank"><em>memoize</em></a> is a technical term; in particular, it’s <em>not</em> a misspelling of “memorize”.)<span class="intersentencespace"></span> In the present case, because <span class="tt">let</span> memoizes the <span class="tt">found_user</span> variable, the <span class="tt">find_by</span> method will only be called once whenever the User model specs are run.<span class="intersentencespace"></span></p>

</div><p>Finally, as a security precaution, we’ll test for a length validation on passwords, requiring that they be at least six characters long:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"with a password that's too short"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>Putting together all the tests above gives <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authenticate_spec" class="hyperref">Listing&nbsp;<span class="ref">6.28</span></a>.</p>
<div class="codelisting" id="_code-authenticate_spec" data-tralics-id="uid493" data-number="6.28"><div class="heading"><span class="number">Listing 6.28:</span> 

<span class="description">Tests for password length and the <code>authenticate</code> method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"with a password that's too short"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"return value of authenticate method"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with valid password"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with invalid password"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"invalid"</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">eq</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user_for_invalid_password</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-let" class="hyperref">Box&nbsp;<span class="ref">6.3</span></a>, <code>let</code> memoizes its value, so that the first nested <code>describe</code> block in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authenticate_spec" class="hyperref">Listing&nbsp;<span class="ref">6.28</span></a> invokes <code>let</code> to retrieve the user from the database using <code>find_by</code>, but the second <code>describe</code> block doesn’t hit the database a second time.</p>
</div>
<div id="_sec-has_secure_password" data-tralics-id="uid494" class="subsection" data-number="6.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-has_secure_password" class="heading hyperref"><span class="number">6.3.4 </span>User has secure password</a></h3>
<p>In previous versions of Rails, adding a secure password was difficult and time-consuming, as seen in the <a href="http://railstutorial.org/book?version=3.0" target="_blank">Rails&nbsp;3.0 version of the <em>Rails Tutorial</em></a>,<sup id="_cha-6_footnote-ref-18" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-18">18</a></sup> which covers the creation of an authentication system from scratch.<span class="intersentencespace"></span> But web developers’ understanding of how best to authenticate users has matured enough that it now comes bundled with the latest version of Rails.<span class="intersentencespace"></span> As a result, we’ll complete the implementation of secure passwords (and get to a green test suite) using only a few lines of code.</p>
<p>First, we need a length validation for the password, which uses the <code>:minimum</code> key in analogy with the <code>:maximum</code> key from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-length_validation" class="hyperref">Listing&nbsp;<span class="ref">6.12</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
</pre></div></div>
<p>(Presence validations for the password and its confirmation are automatically added by <code>has_secure_password</code>.)</p>
<p>Second, we need to add <code>password</code> and <code>password_confirmation</code> attributes, require the presence of the password, require that they match, and add an <code>authenticate</code> method to compare a hashed password to the <code>password_digest</code> to authenticate users.<span class="intersentencespace"></span> This is the only nontrivial step, and in the latest version of Rails all these features come for free with one method, <code>has_secure_password</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">has_secure_password</span>
</pre></div></div>
<p>As long as there is a <code>password_digest</code> column in the database, adding this one method to our model gives us a secure way to create and authenticate new users.</p>
<p>(If you’d like to see how <code>has_secure_password</code> is implemented, I suggest taking a look at <a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank">the source code for <span class="tt">secure_password.rb</span></a>, which is well-documented and quite readable.<span class="intersentencespace"></span> That code includes the lines</p>
<div class="code"><div class="highlight"><pre><span class="n">validates_confirmation_of</span> <span class="ss">:password</span><span class="p">,</span>
                          <span class="k">if</span><span class="p">:</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">present?</span> <span class="p">}</span>
</pre></div></div>
<p>which (as described in the <a href="http://api.rubyonrails.org/v4.0.0/classes/ActiveModel/Validations/HelperMethods.html#method-i-validates_confirmation_of" target="_blank">Rails API</a>) automagically creates an attribute called <code>password_confirmation</code>.<span class="intersentencespace"></span> It also includes a validation for the <code>password_digest</code> attribute.)</p>
<p>Together with the presence validation from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_passing_password_tests" class="hyperref">Listing&nbsp;<span class="ref">6.26</span></a>, the elements above yield the User model shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-password_implementation" class="hyperref">Listing&nbsp;<span class="ref">6.29</span></a>, which completes the implementation of secure passwords.</p>
<div class="codelisting" id="_code-password_implementation" data-tralics-id="uid496" data-number="6.29"><div class="heading"><span class="number">Listing 6.29:</span> 

<span class="description">The complete implementation for secure passwords.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span>   <span class="kp">true</span><span class="p">,</span>
                    <span class="nb">format</span><span class="p">:</span>     <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>You should confirm at this point that the test suite passes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p><em>Note</em>: If you get a deprecation warning like</p>
<div class="code"><div class="highlight"><pre>[deprecated] I18n.enforce_available_locales will default to true in the future
</pre></div></div>
<p>you can get rid of it by editing <code>config/application.rb</code> as follows:</p>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../boot'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="no">I18n</span><span class="o">.</span><span class="n">enforce_available_locales</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
</div>
<div id="_sec-creating_a_user" data-tralics-id="uid497" class="subsection" data-number="6.3.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_a_user" class="heading hyperref"><span class="number">6.3.5 </span>Creating a user</a></h3>
<p>Now that the basic User model is complete, we’ll create a user in the database as preparation for making a page to show the user’s information in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_users" class="hyperref">Section&nbsp;<span class="ref">7.1</span></a>.<span class="intersentencespace"></span> This also gives us a chance to make the work from the previous sections feel more concrete; merely getting the test suite to pass may seem anti-climactic, and it will be gratifying to see an actual user record in the development database.</p>
<p>Since we can’t yet sign up through the web—that’s the goal of <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>—we’ll use the Rails console to create a new user by hand.<span class="intersentencespace"></span> In contrast to <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.3</span></a>, in this section we’ll take care <em>not</em> to start in a sandbox, since this time the whole point is to save a record to the database:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">,</span>
<span class="gp">?&gt; </span>            <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 20:45:19", updated_at: "2013-03-11 20:45:19",</span>
<span class="go">password_digest: "$2a$10$kn4cQDJTzV76ZgDxOWk6Je9A0Ttn5sKNaGTEmT0jU7.n..."&gt;</span>
</pre></div></div>
<p>To check that this worked, let’s look at the row in the development database (<code>db/development.sqlite3</code>) using the SQLite Database Browser (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sqlite_user_row" class="hyperref">Figure <span class="ref">6.6</span></a>).<span class="intersentencespace"></span> Note that the columns correspond to the attributes of the data model defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_model_password_digest" class="hyperref">Figure&nbsp;<span class="ref">6.5</span></a>.</p>
<div class="center figure" id="_fig-sqlite_user_row" data-tralics-id="uid498" data-number="6.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/sqlite_user_row_with_password_4_0.png" alt="images/figures/sqlite_user_row_with_password_4_0"></div><div class="caption"><span class="header">Figure 6.6: </span><span class="description">A user row in the SQLite database <code>db/development.sqlite3</code>.
</span></div></div>
<p>Returning to the console, we can see the effect of <code>has_secure_password</code> from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-password_implementation" class="hyperref">Listing&nbsp;<span class="ref">6.29</span></a> by looking at the <code>password_digest</code> attribute:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password_digest</span>
<span class="go">=&gt; "$2a$10$kn4cQDJTzV76ZgDxOWk6Je9A0Ttn5sKNaGTEmT0jU7.ncBJ/60gHq"</span>
</pre></div></div>
<p>This is the hashed version of the password (<code>"foobar"</code>) used to initialize the user object.<span class="intersentencespace"></span> We can also verify that the <code>authenticate</code> command is working by first using an invalid password and then a valid one:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"invalid"</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2013-03-11 20:45:19", updated_at: "2013-03-11 20:45:19",</span>
<span class="go">password_digest: "$2a$10$kn4cQDJTzV76ZgDxOWk6Je9A0Ttn5sKNaGTEmT0jU7.n..."&gt;</span>
</pre></div></div>
<p>As required by the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authenticate_spec" class="hyperref">Listing&nbsp;<span class="ref">6.28</span></a>, <code>authenticate</code> returns <code>false</code> if the password is invalid and the user itself if the password is valid.</p>
</div></div>
<div id="_cid37" data-tralics-id="cid37" class="section" data-number="6.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid37" class="heading hyperref"><span class="number">6.4 </span>Conclusion</a></h2>
<p>Starting from scratch, in this chapter we created a working User model with <code>name</code>, <code>email</code>, and various password attributes, together with validations enforcing several important constraints on their values.<span class="intersentencespace"></span> In addition, we can securely authenticate users using a given password.<span class="intersentencespace"></span> In previous versions of Rails, such a feat would have taken more than twice as much code, but because of the compact <code>validates</code> method and <code>has_secure_password</code>, we were able to build a complete User model using less than a dozen lines of code.</p>
<p>In the next chapter, <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>, we’ll make a working signup form to create new users, together with a page to display each user’s information.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>, we’ll use the authentication machinery from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-adding_a_secure_password" class="hyperref">Section&nbsp;<span class="ref">6.3</span></a> to let users sign into the site.</p>
<p>If you’re using Git, now would be a good time to commit if you haven’t done so in a while:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Make a basic User model (including secure passwords)"</span>
</pre></div></div>
<p>Then merge back into the master branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge modeling-users
</pre></div></div>
</div>
<div id="_sec-modeling_users_exercises" data-tralics-id="cid38" class="section" data-number="6.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_users_exercises" class="heading hyperref"><span class="number">6.5 </span>Exercises</a></h2>
<ol>
<li>Add a test for the email downcasing from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase" class="hyperref">Listing&nbsp;<span class="ref">6.20</span></a>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase_test" class="hyperref">Listing&nbsp;<span class="ref">6.30</span></a>.<span class="intersentencespace"></span> This test uses the <code>reload</code> method for reloading a value from the database and the <code>eq</code> method for testing equality.<span class="intersentencespace"></span> By commenting out the <code>before_save</code> line, verify that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase_test" class="hyperref">Listing&nbsp;<span class="ref">6.30</span></a> tests the right thing.
</li>
<li>By running the test suite, verify that the <code>before_save</code> callback can be written as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-downcase_bang" class="hyperref">Listing&nbsp;<span class="ref">6.31</span></a>.
</li>
<li>As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-format_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.4</span></a>, the email regex in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-validates_format_of_email" class="hyperref">Listing&nbsp;<span class="ref">6.14</span></a> allows invalid email addresses with consecutive dots, i.e., addresses of the form “foo@bar..com”.<span class="intersentencespace"></span> Add this address to the list of invalid address in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_format_validation_tests" class="hyperref">Listing&nbsp;<span class="ref">6.13</span></a> to get a failing test, and then use the more complicated regex shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-better_email_regex" class="hyperref">Listing&nbsp;<span class="ref">6.32</span></a> to get the test to pass.
</li>
<li>Read through the Rails API entry for <code>ActiveRecord::Base</code> to get a sense of its capabilities.
</li>
<li>Study the entry in the Rails API for the <code>validates</code> method to learn more about its capabilities and options.
</li>
<li>Spend a couple of hours playing with <a href="http://www.rubular.com/" target="_blank">Rubular</a>.
</li></ol>
<div class="codelisting" id="_code-email_downcase_test" data-tralics-id="uid505" data-number="6.30"><div class="heading"><span class="number">Listing 6.30:</span> 

<span class="description">A test for the email downcasing from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase" class="hyperref">Listing&nbsp;<span class="ref">6.20</span></a>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"email address with mixed case"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:mixed_case_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Foo@ExAMPle.CoM"</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"should be saved as all lower-case"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">mixed_case_email</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">mixed_case_email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-downcase_bang" data-tralics-id="uid506" data-number="6.31"><div class="heading"><span class="number">Listing 6.31:</span> 

<span class="description">An alternate implementation of the <code>before_save</code> callback.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_secure_password</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase!</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-better_email_regex" data-tralics-id="uid507" data-number="6.32"><div class="heading"><span class="number">Listing 6.32:</span> 

<span class="description">A valid email regex that disallows double dots in email addresses.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-]+(?:\.[a-z\d\-]+)*\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="cha-6_footnotes">
  <ol class="footnotes">
    <li id="_cha-6_footnote-1">The name comes from the “<a href="http://en.wikipedia.org/wiki/Active_record_pattern" target="_blank">active record pattern</a>”, identified and named in <em>Patterns of Enterprise Application Architecture</em> by Martin Fowler.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-1">↑</a></li>
    <li id="_cha-6_footnote-2">Pronounced “ess-cue-ell”, though the alternate pronunciation “sequel” is also common.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-2">↑</a></li>
    <li id="_cha-6_footnote-3">By using an email address as the username, we open the theoretical possibility of communicating with our users at a future date.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-3">↑</a></li>
    <li id="_cha-6_footnote-4">Don’t worry about exactly how the <code>t</code>&nbsp;object manages to do this; the beauty of <em>abstraction layers</em> is that we don’t have to know.<span class="intersentencespace"></span> We can just trust the <code>t</code>&nbsp;object to do its job.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-4">↑</a></li>
    <li id="_cha-6_footnote-5">Officially pronounced “ess-cue-ell-ite”, although the (mis)pronunciation “sequel-ite” is also common.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-5">↑</a></li>
    <li id="_cha-6_footnote-6">In case you’re curious about <code>"2013-03-11 00:57:46"</code>, I’m not writing this after midnight; the timestamps are recorded in <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time" target="_blank">Coordinated Universal Time</a> (UTC), which for most practical purposes is the same as <a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time" target="_blank">Greenwich Mean Time</a>.<span class="intersentencespace"></span> From the <a href="http://tf.nist.gov/general/misc.htm" target="_blank">NIST Time and Frequency FAQ</a>: <strong>Q:</strong> Why is UTC used as the acronym for Coordinated Universal Time instead of CUT? <strong>A:</strong> In 1970 the Coordinated Universal Time system was devised by an international advisory group of technical experts within the International Telecommunication Union (ITU).<span class="intersentencespace"></span> The ITU felt it was best to designate a single abbreviation for use in all languages in order to minimize confusion.<span class="intersentencespace"></span> Since unanimous agreement could not be achieved on using either the English word order, CUT, or the French word order, TUC, the acronym UTC was chosen as a compromise.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-6">↑</a></li>
    <li id="_cha-6_footnote-7">Note the value of <code>user.updated_at</code>.<span class="intersentencespace"></span> Told you the timestamp was in UTC.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-7">↑</a></li>
    <li id="_cha-6_footnote-8">Exceptions and exception handling are somewhat advanced Ruby subjects, and we won’t need them much in this book.<span class="intersentencespace"></span> They are important, though, and I suggest learning about them using one of the Ruby books recommended in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-comments_for_various_readers" class="hyperref">Section&nbsp;<span class="ref">1.1.1</span></a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-8">↑</a></li>
    <li id="_cha-6_footnote-9">This assumes you are using SQLite locally.<span class="intersentencespace"></span> These files won’t exist if you are instead using Postgres, as suggested in the <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a> exercise.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-9">↑</a></li>
    <li id="_cha-6_footnote-10">I’ll omit the output of console commands when they are not particularly instructive—for example, the results of <code>User.new</code>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-10">↑</a></li>
    <li id="_cha-6_footnote-11">Note that, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-valid_email_regex" class="hyperref">Table&nbsp;<span class="ref">6.1</span></a>, “letter” really means “lower-case letter”, but the <code>i</code> at the end of the regex enforces case-insensitive matching.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-11">↑</a></li>
    <li id="_cha-6_footnote-12">If you find it as useful as I do, I encourage you to <a href="http://bit.ly/donate-to-rubular" target="_blank">donate to Rubular</a> to reward developer <a href="http://lovitt.net/" target="_blank">Michael Lovitt</a> for his wonderful work.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-12">↑</a></li>
    <li id="_cha-6_footnote-13">Did you know that <code>"Michael Hartl"@example.com</code>, with quotation marks and a space in the middle, is a valid email address according to the standard?<span class="intersentencespace"></span> Incredibly, it is—but it’s absurd.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-13">↑</a></li>
    <li id="_cha-6_footnote-14">As noted briefly in the introduction to this section, there is a dedicated test database, <code>db/test.sqlite3</code>, for this purpose.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-14">↑</a></li>
    <li id="_cha-6_footnote-15">Technically, only the domain part of the email address is case-insensitive: foo@bar.com is actually different from Foo@bar.com.<span class="intersentencespace"></span> In practice, though, it is a bad idea to rely on this fact; as noted at <a href="http://email.about.com/od/emailbehindthescenes/f/email_case_sens.htm" target="_blank">about.com</a>, “Since the case sensitivity of email addresses can create a lot of confusion, interoperability problems and widespread headaches, it would be foolish to require email addresses to be typed with the correct case.<span class="intersentencespace"></span> Hardly any email service or ISP does enforce case sensitive email addresses, returning messages whose recipient’s email address was not typed correctly (in all upper case, for example).”<span class="intersentencespace"></span> Thanks to reader Riley Moses for pointing this out.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-15">↑</a></li>
    <li id="_cha-6_footnote-16">Of course, we could just edit the migration file for the <code>users</code> table in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_migration" class="hyperref">Listing&nbsp;<span class="ref">6.2</span></a> but that would require rolling back and then migrating back up.<span class="intersentencespace"></span> The Rails Way is to use migrations every time we discover that our data model needs to change.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-16">↑</a></li>
    <li id="_cha-6_footnote-17">Direct experimentation with SQLite on my system and PostgreSQL on Heroku show that this step is, in fact, necessary.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-17">↑</a></li>
    <li id="_cha-6_footnote-18">http://railstutorial.org/book?version=3.0&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-6_footnote-ref-18">↑</a></li>
  </ol>
</div><div id="_cha-sign_up" data-tralics-id="cid39" class="chapter" data-number="7"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="heading hyperref"><span class="number">Chapter 7 </span>Sign up</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>Now that we have a working User model, it’s time to add an ability few websites can live without: letting users sign up for the site.<span class="intersentencespace"></span> We’ll use an HTML <em>form</em> to submit user signup information to our application in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_form" class="hyperref">Section&nbsp;<span class="ref">7.2</span></a>, which will then be used to create a new user and save its attributes to the database in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_success" class="hyperref">Section&nbsp;<span class="ref">7.4</span></a>.<span class="intersentencespace"></span> At the end of the signup process, it’s important to render a profile page with the newly created user’s information, so we’ll begin by making a page for <em>showing</em> users, which will serve as the first step toward implementing the REST architecture for users (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-mvc_in_action" class="hyperref">Section&nbsp;<span class="ref">2.2.2</span></a>).<span class="intersentencespace"></span> As usual, we’ll write tests as we develop, extending the theme of using RSpec and Capybara to write succinct and expressive integration tests.</p>
<p>In order to make a user profile page, we need to have a user in the database, which introduces a chicken-and-egg problem: how can the site have a user before there is a working signup page?<span class="intersentencespace"></span> Happily, this problem has already been solved: in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_a_user" class="hyperref">Section&nbsp;<span class="ref">6.3.5</span></a>, we created a User record by hand using the Rails console.<span class="intersentencespace"></span> If you skipped that section, you should go there now and complete it before proceeding.</p>
<p>If you’re following along with version control, make a topic branch as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b sign-up
</pre></div></div>
</div>
<div id="_sec-showing_users" data-tralics-id="cid40" class="section" data-number="7.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_users" class="heading hyperref"><span class="number">7.1 </span>Showing users</a></h2>
<p>In this section, we’ll take the first steps toward the final profile by making a page to display a user’s name and profile photo, as indicated by the mockup in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_mockup_profile_name" class="hyperref">Figure&nbsp;<span class="ref">7.1</span></a>.<sup id="_cha-7_footnote-ref-1" class="footnote intersentence"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-1">1</a></sup><span class="intersentencespace"></span> Our eventual goal for the user profile pages is to show the user’s profile image, basic user data, and a list of microposts, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_mockup" class="hyperref">Figure&nbsp;<span class="ref">7.2</span></a>.<sup id="_cha-7_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-2">2</a></sup><span class="intersentencespace"></span> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_mockup" class="hyperref">Figure&nbsp;<span class="ref">7.2</span></a> has our first example of <em>lorem ipsum</em> text, which has a <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean" target="_blank">fascinating story</a> that you should definitely read about some time.)<span class="intersentencespace"></span> We’ll complete this task, and with it the sample application, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>.</p>
<div class="center figure" id="_fig-profile_mockup_profile_name" data-tralics-id="uid510" data-number="7.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/profile_mockup_profile_name_bootstrap.png" alt="images/figures/profile_mockup_profile_name_bootstrap"></div><div class="caption"><span class="header">Figure 7.1: </span><span class="description">A mockup of the user profile made in this section.
</span></div></div>
<div class="center figure" id="_fig-profile_mockup" data-tralics-id="uid511" data-number="7.2">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/profile_mockup_bootstrap.png" alt="images/figures/profile_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 7.2: </span><span class="description">A mockup of our best guess at the final profile page.
</span></div></div>
<div id="_sec-rails_environments" data-tralics-id="uid512" class="subsection" data-number="7.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rails_environments" class="heading hyperref"><span class="number">7.1.1 </span>Debug and Rails environments</a></h3>
<p>The profiles in this section will be the first truly dynamic pages in our application.<span class="intersentencespace"></span> Although the view will exist as a single page of code, each profile will be customized using information retrieved from the site’s database.<span class="intersentencespace"></span> As preparation for adding dynamic pages to our sample application, now is a good time to add some debug information to our site layout (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rails_debug" class="hyperref">Listing&nbsp;<span class="ref">7.1</span></a>).<span class="intersentencespace"></span> This displays some useful information about each page using the built-in <code>debug</code> method and <code>params</code> variable (which we’ll learn more about in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="hyperref">Section&nbsp;<span class="ref">7.1.2</span></a>).</p>
<div class="codelisting" id="_code-rails_debug" data-tralics-id="uid513" data-number="7.1"><div class="heading"><span class="number">Listing 7.1:</span> 

<span class="description">Adding some debug information to the site layout.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/header'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/footer'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p>To make the debug output look nice, we’ll add some rules to the custom stylesheet created in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-mixin_and_debug" class="hyperref">Listing&nbsp;<span class="ref">7.2</span></a>.</p>
<div class="codelisting" id="_code-mixin_and_debug" data-tralics-id="uid514" data-number="7.2"><div class="heading"><span class="number">Listing 7.2:</span> 

<span class="description">Adding code for a pretty debug box, including a Sass mixin.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">"bootstrap"</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="k">@mixin</span><span class="nf"> box_sizing</span> <span class="p">{</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">miscellaneous</span> <span class="o">*/</span>

<span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">clear</span><span class="o">:</span> <span class="no">both</span><span class="p">;</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><p>This introduces the Sass <em>mixin</em> facility, in this case called <code>box_sizing</code>.<span class="intersentencespace"></span> A mixin allows a group of CSS rules to be packaged up and used for multiple elements, converting</p>
<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="o">@</span><span class="nt">include</span> <span class="nt">box_sizing</span><span class="o">;</span>
<span class="p">}</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div>
<p>We’ll put this mixin to use again in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-using_form_for" class="hyperref">Section&nbsp;<span class="ref">7.2.2</span></a>.<span class="intersentencespace"></span> The result in the case of the debug box is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_page_with_debug" class="hyperref">Figure&nbsp;<span class="ref">7.3</span></a>.</p>
<div class="center figure" id="_fig-home_page_with_debug" data-tralics-id="uid515" data-number="7.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_page_with_debug_4_0.png" alt="images/figures/home_page_with_debug_4_0"></div><div class="caption"><span class="header">Figure 7.3: </span><span class="description">The sample application Home page (<a href="http://localhost:3000/" target="_blank">/</a>) with debug information.
</span></div></div>
<p>The debug output in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_page_with_debug" class="hyperref">Figure&nbsp;<span class="ref">7.3</span></a> gives potentially useful information about the page being rendered:</p>
<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static_pages</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">home</span>
</pre></div></div>
<p>This is a YAML<sup id="_cha-7_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-3">3</a></sup> representation of <code>params</code>, which is basically a hash, and in this case identifies the controller and action for the page.<span class="intersentencespace"></span> We’ll see another example in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="hyperref">Section&nbsp;<span class="ref">7.1.2</span></a>.</p>
<p>Since we don’t want to display debug information to users of a deployed application, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rails_debug" class="hyperref">Listing&nbsp;<span class="ref">7.1</span></a> uses</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div></div>
<p>to restrict the debug information to the <em>development environment</em>, which is one of three environments defined by default in Rails (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-rails_environments" class="hyperref">Box&nbsp;<span class="ref">7.1</span></a>).<sup id="_cha-7_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-4">4</a></sup><span class="intersentencespace"></span> In particular, <code>Rails.env.development?</code> is <code>true</code> only in a development environment, so the Embedded Ruby</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>won’t be inserted into production applications or tests.<span class="intersentencespace"></span> (Inserting the debug information into tests probably wouldn’t do any harm, but it probably wouldn’t do any good, either, so it’s best to restrict the debug display to development only.)</p>
<div class="aside" id="_sidebar-rails_environments" data-tralics-id="uid518" data-number="7.1"><div class="heading"><span class="number">Box 7.1.</span> 

<span class="description">Rails environments</span></div>
<p>Rails comes equipped with three environments: <span class="tt">test</span>, <span class="tt">development</span>, and <span class="tt">production</span>.<span class="intersentencespace"></span> The default environment for the Rails console is <span class="tt">development</span>:</p>
<pre>  $ rails console
  Loading development environment
  &gt;&gt; Rails.env
  =&gt; "development"
  &gt;&gt; Rails.env.development?
  =&gt; true
  &gt;&gt; Rails.env.test?
  =&gt; false</pre>
<p>As you can see, Rails provides a <span class="tt">Rails</span> object with an <span class="tt">env</span> attribute and associated environment boolean methods, so that, for example, <span class="tt">Rails.env.test?</span><span class="intersentencespace"></span> returns <span class="tt">true</span> in a test environment and <span class="tt">false</span> otherwise.</p>
<p>If you ever need to run a console in a different environment (to debug a test, for example), you can pass the environment as a parameter to the <span class="tt">console</span> script:</p>
<pre>  $ rails console test
  Loading test environment
  &gt;&gt; Rails.env
  =&gt; "test"
  &gt;&gt; Rails.env.test?
  =&gt; true</pre>
<p>As with the console, <span class="tt">development</span> is the default environment for the local Rails server, but you can also run it in a different environment:</p>
<pre>  $ rails server --environment production</pre>
<p>If you view your app running in production, it won’t work without a production database, which we can create by running <span class="tt">rake db:migrate</span> in production:</p>
<pre>  $ bundle exec rake db:migrate RAILS_ENV=production</pre>
<p>(I find it confusing that the console, server, and migrate commands specify non-default environments in three mutually incompatible ways, which is why I bothered showing all three.)</p>
<p>By the way, if you have deployed your sample app to Heroku, you can see its environment using the <span class="tt">heroku</span> command, which provides its own (remote) console:</p>
<pre>  $ heroku run console
  Ruby console for yourapp.herokuapp.com
  &gt;&gt; Rails.env
  =&gt; "production"
  &gt;&gt; Rails.env.production?
  =&gt; true</pre>
<p>Naturally, since Heroku is a platform for production sites, it runs each application in a production environment.<span class="intersentencespace"></span></p>

</div></div>
<div id="_sec-a_users_resource" data-tralics-id="uid519" class="subsection" data-number="7.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="heading hyperref"><span class="number">7.1.2 </span>A Users resource</a></h3>
<p>At the end of <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>, we created a new user in the database.<span class="intersentencespace"></span> As seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_a_user" class="hyperref">Section&nbsp;<span class="ref">6.3.5</span></a>, this user has id&nbsp;<code>1</code>, and our goal now is to make a page to display this user’s information.<span class="intersentencespace"></span> We’ll follow the conventions of the REST architecture favored in Rails applications (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-REST" class="hyperref">Box&nbsp;<span class="ref">2.2</span></a>), which means representing data as <em>resources</em> that can be created, shown, updated, or destroyed—four actions corresponding to the four fundamental operations <span class="tt">POST</span>, <span class="tt">GET</span>, <span class="tt">PATCH</span>, and <span class="tt">DELETE</span> defined by the <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank">HTTP standard</a> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-get_etc" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>).</p>
<p>When following REST principles, resources are typically referenced using the resource name and a unique identifier.<span class="intersentencespace"></span> What this means in the context of users—which we’re now thinking of as a Users <em>resource</em>—is that we should view the user with id&nbsp;<code>1</code> by issuing a <span class="tt">GET</span> request to the URL /users/1.<span class="intersentencespace"></span> Here the <code>show</code> action is <em>implicit</em> in the type of request—when Rails’ REST features are activated, <span class="tt">GET</span> requests are automatically handled by the <code>show</code> action.</p>
<p>We saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_tour" class="hyperref">Section&nbsp;<span class="ref">2.2.1</span></a> that the page for a user with id&nbsp;<code>1</code> has URL /users/1.<span class="intersentencespace"></span> Unfortunately, visiting that URL right now just gives an error (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_routing_error" class="hyperref">Figure&nbsp;<span class="ref">7.4</span></a>).</p>
<div class="center figure" id="_fig-profile_routing_error" data-tralics-id="uid520" data-number="7.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/profile_routing_error.png" alt="images/figures/profile_routing_error"></div><div class="caption"><span class="header">Figure 7.4: </span><span class="description">The error page for /users/1.
</span></div></div>
<p>We can get the REST-style URL to work by adding a single line to our routes file (<code>config/routes.rb</code>):</p>
<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span>
</pre></div></div>
<p>The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_resource" class="hyperref">Listing&nbsp;<span class="ref">7.3</span></a>.</p>
<div class="codelisting" id="_code-users_resource" data-tralics-id="uid521" data-number="7.3"><div class="heading"><span class="number">Listing 7.3:</span> 

<span class="description">Adding a Users resource to the routes file.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">root</span>  <span class="s1">'static_pages#home'</span>
  <span class="n">match</span> <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'users#new'</span><span class="p">,</span>            <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>You might have noticed that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_resource" class="hyperref">Listing&nbsp;<span class="ref">7.3</span></a> removes the line</p>
<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">"users/new"</span>
</pre></div></div>
<p>last seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_route" class="hyperref">Listing&nbsp;<span class="ref">5.35</span></a>.<span class="intersentencespace"></span> This is because <code>resources :users</code> doesn’t just add a working /users/1 URL; it endows our sample application with <em>all</em> the actions needed for a RESTful Users resource,<sup id="_cha-7_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-5">5</a></sup> along with a large number of named routes (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-named_routes" class="hyperref">Section&nbsp;<span class="ref">5.3.3</span></a>) for generating user URLs.<span class="intersentencespace"></span> The resulting correspondence of URLs, actions, and named routes is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>.<span class="intersentencespace"></span> (Compare to <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-demo_RESTful_users" class="hyperref">Table&nbsp;<span class="ref">2.2</span></a>.)<span class="intersentencespace"></span> Over the course of the next three chapters, we’ll cover all of the other entries in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a> as we fill in all the actions necessary to make Users a fully RESTful resource.</p>
<div class="table" id="_table-RESTful_users" data-tralics-id="uid523" data-number="7.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Named route</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users</td>
<td class="align_left"><code>index</code></td>
<td class="align_left"><code>users_path</code></td>
<td class="align_left">page to list all users</td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>show</code></td>
<td class="align_left"><code>user_path(user)</code></td>
<td class="align_left">page to show user</td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/new</td>
<td class="align_left"><code>new</code></td>
<td class="align_left"><code>new_user_path</code></td>
<td class="align_left">page to make a new user (signup)</td>
</tr><tr><td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/users</td>
<td class="align_left"><code>create</code></td>
<td class="align_left"><code>users_path</code></td>
<td class="align_left">create a new user</td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/edit</td>
<td class="align_left"><code>edit</code></td>
<td class="align_left"><code>edit_user_path(user)</code></td>
<td class="align_left">page to edit user with id <code>1</code></td>
</tr><tr><td class="align_left"><span class="tt">PATCH</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>update</code></td>
<td class="align_left"><code>user_path(user)</code></td>
<td class="align_left">update user</td>
</tr><tr><td class="align_left"><span class="tt">DELETE</span></td>
<td class="align_left">/users/1</td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left"><code>user_path(user)</code></td>
<td class="align_left">delete user</td>
</tr></tbody></table><div class="caption"><span class="header">Table 7.1: </span><span class="description">RESTful routes provided by the Users resource in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_resource" class="hyperref">Listing&nbsp;<span class="ref">7.3</span></a>.
</span></div></div>
<p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_resource" class="hyperref">Listing&nbsp;<span class="ref">7.3</span></a>, the routing works, but there’s still no page there (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_show_unknown_action_4" class="hyperref">Figure&nbsp;<span class="ref">7.5</span></a>).<span class="intersentencespace"></span> To fix this, we’ll begin with a minimalist version of the profile page, which we’ll flesh out in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_gravatar_image" class="hyperref">Section&nbsp;<span class="ref">7.1.4</span></a>.</p>
<div class="center figure" id="_fig-user_show_unknown_action_4" data-tralics-id="uid524" data-number="7.5">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_show_unknown_action_4.png" alt="images/figures/user_show_unknown_action_4"></div><div class="caption"><span class="header">Figure 7.5: </span><span class="description">The URL /users/1 with routing but no page.
</span></div></div>
<p>We’ll use the standard Rails location for showing a user, which is <code>app/views/users/show.html.erb</code>.<span class="intersentencespace"></span> Unlike the <code>new.html.erb</code> view, which we created with the generator in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_users_controller" class="hyperref">Listing&nbsp;<span class="ref">5.31</span></a>, the <code>show.html.erb</code> file doesn’t currently exist, so you’ll have to create it by hand, filling it with the content shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-stub_user_view" class="hyperref">Listing&nbsp;<span class="ref">7.4</span></a>.</p>
<div class="codelisting" id="_code-stub_user_view" data-tralics-id="uid525" data-number="7.4"><div class="heading"><span class="number">Listing 7.4:</span> 

<span class="description">A stub view for showing user information.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>This view uses Embedded Ruby to display the user’s name and email address, assuming the existence of an instance variable called <code>@user</code>.<span class="intersentencespace"></span> Of course, eventually the real user show page will look very different, and won’t display the email address publicly.</p>
<p>In order to get the user show view to work, we need to define an <code>@user</code> variable in the corresponding <code>show</code> action in the Users controller.<span class="intersentencespace"></span> As you might expect, we use the <code>find</code> method on the User model (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>) to retrieve the user from the database, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_action" class="hyperref">Listing&nbsp;<span class="ref">7.5</span></a>.</p>
<div class="codelisting" id="_code-user_show_action" data-tralics-id="uid526" data-number="7.5"><div class="heading"><span class="number">Listing 7.5:</span> 

<span class="description">The Users controller with a <code>show</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we’ve used <code>params</code> to retrieve the user&nbsp;id.<span class="intersentencespace"></span> When we make the appropriate request to the Users controller, <code>params[:id]</code> will be the user id&nbsp;<span class="tt">1</span>, so the effect is the same as the <code>find</code> method</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div></div>
<p>we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>.<span class="intersentencespace"></span> (Technically, <code>params[:id]</code> is the string&nbsp;<code>"1"</code>, but <code>find</code> is smart enough to convert this to an integer.)</p>
<p>With the user view and action defined, the URL <a href="http://localhost:3000/users/1" target="_blank">/users/1</a> works perfectly (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_show_rails_3" class="hyperref">Figure&nbsp;<span class="ref">7.6</span></a>).<span class="intersentencespace"></span> Note that the debug information in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_show_rails_3" class="hyperref">Figure&nbsp;<span class="ref">7.6</span></a> confirms the value of <code>params[:id]</code>:</p>
<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">'1'</span>
</pre></div></div>
<p>This is why the code</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_action" class="hyperref">Listing&nbsp;<span class="ref">7.5</span></a> finds the user with id&nbsp;<span class="tt">1</span>.</p>
<div class="center figure" id="_fig-user_show_rails_3" data-tralics-id="uid527" data-number="7.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_show_bootstrap.png" alt="images/figures/user_show_bootstrap"></div><div class="caption"><span class="header">Figure 7.6: </span><span class="description">The user show page at <a href="http://localhost:3000/users/1" target="_blank">/users/1</a> after adding a Users resource.
</span></div></div>
</div>
<div id="_sec-tests_with_factories" data-tralics-id="uid528" class="subsection" data-number="7.1.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-tests_with_factories" class="heading hyperref"><span class="number">7.1.3 </span>Testing the user show page (with factories)</a></h3>
<p>Now that we have a minimal working profile, it’s time to start working on the version mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_mockup_profile_name" class="hyperref">Figure&nbsp;<span class="ref">7.1</span></a>.<span class="intersentencespace"></span> As with the creation of static pages (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a>) and the User model (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>), we’ll proceed using test-driven development.</p>
<p>Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_url" class="hyperref">Section&nbsp;<span class="ref">5.4.2</span></a> that we have elected to use integration tests for the pages associated with the Users resource.<span class="intersentencespace"></span> In the case of the signup page, our test first visits the <code>signup_path</code> and then checks for the right <code>h1</code> and <code>title</code> tags, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_pages_spec" class="hyperref">Listing&nbsp;<span class="ref">5.34</span></a> and reproduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_signup_test" class="hyperref">Listing&nbsp;<span class="ref">7.6</span></a>.<span class="intersentencespace"></span> (Note that we’ve omitted the <code>full_title</code> helper from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pretty_rspec" class="hyperref">Section&nbsp;<span class="ref">5.3.4</span></a> since the full title is already adequately tested there.)</p>
<div class="codelisting" id="_code-initial_signup_test" data-tralics-id="uid529" data-number="7.6"><div class="heading"><span class="number">Listing 7.6:</span> 

<span class="description">A recap of the initial User pages spec.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"signup page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To test the user show page, we’ll need a User model object so that the code in the <code>show</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_action" class="hyperref">Listing&nbsp;<span class="ref">7.5</span></a>) has something to find:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
  <span class="c1"># Replace with code to make a user variable</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>where we need to fill in the comment with the appropriate code.<span class="intersentencespace"></span> This uses the <code>user_path</code> named route (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>) to generate the path to the show page for the given user.<span class="intersentencespace"></span> It then tests that the page content and title both contain the user’s name.</p>
<p>In order to make the necessary User model object, we could use Active Record to create a user with <code>User.create</code>, but experience shows that user <em>factories</em> are a more convenient way to define user objects and insert them in the database.<span class="intersentencespace"></span> We’ll be using the factories generated by <a href="http://github.com/thoughtbot/factory_girl" target="_blank">Factory Girl</a>, a Ruby gem produced by the good people at <a href="http://thoughtbot.com/" target="_blank">thoughtbot</a>.<span class="intersentencespace"></span> As with RSpec, Factory Girl defines a domain-specific language in Ruby, in this case specialized for defining Active Record objects.<span class="intersentencespace"></span> The syntax is simple, relying on Ruby blocks and custom methods to define the attributes of the desired object.<span class="intersentencespace"></span> For cases such as the one in this chapter, the advantage over Active Record may not be obvious, but we’ll use more advanced features of factories in future chapters.<span class="intersentencespace"></span> For example, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pagination" class="hyperref">Section&nbsp;<span class="ref">9.3.3</span></a> it will be important to create a sequence of users with unique email addresses, and factories make it easy to do this.</p>
<p>As with other Ruby gems, we can install Factory Girl by adding a line to the <code>Gemfile</code> used by Bundler (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gemfile_factory_girl" class="hyperref">Listing&nbsp;<span class="ref">7.7</span></a>).<span class="intersentencespace"></span> (Since Factory Girl is only needed in the tests, we’ve put it in the <code>:test</code> group.)</p>
<div class="codelisting" id="_code-gemfile_factory_girl" data-tralics-id="uid530" data-number="7.7"><div class="heading"><span class="number">Listing 7.7:</span> 

<span class="description">Adding Factory Girl to the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">'factory_girl_rails'</span><span class="p">,</span> <span class="s1">'4.2.0'</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then install as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>We’ll put all our Factory Girl factories in the file <code>spec/factories.rb</code>, which automatically gets loaded by RSpec.<span class="intersentencespace"></span> The code needed to make a User factory appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_factory" class="hyperref">Listing&nbsp;<span class="ref">7.8</span></a>.</p>
<div class="codelisting" id="_code-user_factory" data-tralics-id="uid531" data-number="7.8"><div class="heading"><span class="number">Listing 7.8:</span> 

<span class="description">A factory to simulate User model objects.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/factories.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">"Michael Hartl"</span>
    <span class="n">email</span>    <span class="s2">"michael@example.com"</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>By passing the symbol <code>:user</code> to the <code>factory</code> command, we tell Factory Girl that the subsequent definition is for a User model object.</p>
<p>With the definition in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_factory" class="hyperref">Listing&nbsp;<span class="ref">7.8</span></a>, we can create a User factory in the tests using the <code>let</code> command (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-let" class="hyperref">Box&nbsp;<span class="ref">6.3</span></a>) and the <code>FactoryGirl</code> method supplied by Factory Girl:</p>
<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>The final result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_page_test" class="hyperref">Listing&nbsp;<span class="ref">7.9</span></a>.</p>
<div class="codelisting" id="_code-user_show_page_test" data-tralics-id="uid532" data-number="7.9"><div class="heading"><span class="number">Listing 7.9:</span> 

<span class="description">A test for the user show page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"signup page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>You should verify at this point that the test suite is red:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>We can get the tests to green with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-name_title_and_heading" class="hyperref">Listing&nbsp;<span class="ref">7.10</span></a>.</p>
<div class="codelisting" id="_code-name_title_and_heading" data-tralics-id="uid533" data-number="7.10"><div class="heading"><span class="number">Listing 7.10:</span> 

<span class="description">Adding a title and heading for the user profile page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
</pre></div></div></div><p>Running the tests again should confirm that the test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_page_test" class="hyperref">Listing&nbsp;<span class="ref">7.9</span></a> is passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>One thing you will quickly notice when running tests with Factory Girl is that they are <em>slow</em>.<span class="intersentencespace"></span> The reason is not Factory Girl’s fault, and in fact it is a <em>feature</em>, not a bug.<span class="intersentencespace"></span> The issue is that the bcrypt algorithm used in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_hashed_password" class="hyperref">Section&nbsp;<span class="ref">6.3.1</span></a> to create a secure password hash is slow by design: bcrypt’s slow speed is part of what makes it so hard to attack.<span class="intersentencespace"></span> Unfortunately, this means that creating users can bog down the test suite; happily, there is an easy fix.<span class="intersentencespace"></span> The <span class="tt">bcrypt-ruby</span> library uses a <em>cost factor</em> to control how computationally costly it is to create the secure hash.<span class="intersentencespace"></span> The default value is designed for security, not for speed, which is perfect for production applications, but in tests our needs are reversed: we want <em>fast</em> tests, and don’t care at all about the security of the test users’ password hashes.<span class="intersentencespace"></span> The solution is to add a line to the test configuration file, <code>config/environments/test.rb</code>, redefining the cost factor from its secure default value to its fast minimum value, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-test_bcrypt_cost_factor" class="hyperref">Listing&nbsp;<span class="ref">7.11</span></a>.<span class="intersentencespace"></span> Even for a small test suite, the gains in speed from this step can be considerable, and I strongly recommend including <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-test_bcrypt_cost_factor" class="hyperref">Listing&nbsp;<span class="ref">7.11</span></a> in your <code>test.rb</code> configuration.</p>
<div class="codelisting" id="_code-test_bcrypt_cost_factor" data-tralics-id="uid534" data-number="7.11"><div class="heading"><span class="number">Listing 7.11:</span> 

<span class="description">Redefining the Bcrypt cost factor in a test environment.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/environments/test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Speed up tests by lowering bcrypt's cost function.</span>
  <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-a_gravatar_image" data-tralics-id="uid535" class="subsection" data-number="7.1.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_gravatar_image" class="heading hyperref"><span class="number">7.1.4 </span>A Gravatar image and a sidebar</a></h3>
<p>Having defined a basic user page in the previous section, we’ll now flesh it out a little with a profile image for each user and the first cut of the user sidebar.<span class="intersentencespace"></span> When making views, we’ll focus on the visual appearance and not worry too much about the exact structure of the page, which means that (at least for now) we won’t be writing tests.<span class="intersentencespace"></span> When we come to more error-prone aspects of view, such as pagination (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pagination" class="hyperref">Section&nbsp;<span class="ref">9.3.3</span></a>), we’ll resume test-driven development.</p>
<p>We’ll start by adding a “globally recognized avatar”, or <a href="http://gravatar.com/" target="_blank">Gravatar</a>, to the user profile.<sup id="_cha-7_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-6">6</a></sup><span class="intersentencespace"></span> Originally created by Tom Preston-Werner (cofounder of <a href="http://github.com/" target="_blank">GitHub</a>) and later acquired and scaled by <a href="http://automattic.com/" target="_blank">Automattic</a> (the makers of <a href="http://wordpress.com/" target="_blank">WordPress</a>), Gravatar is a free service that allows users to upload images and associate them with email addresses they control.<span class="intersentencespace"></span> Gravatars are a convenient way to include user profile images without going through the trouble of managing image upload, cropping, and storage; all we need to do is construct the proper Gravatar image URL using the user’s email address and the corresponding Gravatar image will automatically appear.<sup id="_cha-7_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-7">7</a></sup></p>
<p>Our plan is to define a <code>gravatar_for</code> helper function to return a Gravatar image for a given user, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_view_with_gravatar" class="hyperref">Listing&nbsp;<span class="ref">7.12</span></a>.</p>
<div class="codelisting" id="_code-user_show_view_with_gravatar" data-tralics-id="uid538" data-number="7.12"><div class="heading"><span class="number">Listing 7.12:</span> 

<span class="description">The user show view with name and Gravatar.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div></div></div><p>You can verify at this point that the test suite is failing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>Because the <code>gravatar_for</code> method is undefined, the user show view is currently broken.<span class="intersentencespace"></span> (Catching errors of this nature is perhaps the most useful aspect of view specs.<span class="intersentencespace"></span> This is why having <em>some</em> test of the view, even a minimalist one, is so important.)</p>
<p>By default, methods defined in any helper file are automatically available in any view, but for convenience we’ll put the <code>gravatar_for</code> method in the file for helpers associated with the Users controller.<span class="intersentencespace"></span> As <a href="http://en.gravatar.com/site/implement/hash/" target="_blank">noted at the Gravatar home page</a>, Gravatar URLs are based on an <a href="http://en.wikipedia.org/wiki/MD5" target="_blank">MD5 hash</a> of the user’s email address.<span class="intersentencespace"></span> In Ruby, the MD5 hashing algorithm is implemented using the <code>hexdigest</code> method, which is part of the <code>Digest</code> library:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">email</span> <span class="o">=</span> <span class="s2">"MHARTL@example.COM"</span><span class="o">.</span>
<span class="gp">&gt;&gt; </span><span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
<span class="go">=&gt; "1fda4469bcbec3badf5418269ffc5968"</span>
</pre></div></div>
<p>Since email addresses are case-insensitive (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-format_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.4</span></a>) but MD5 hashes are not, we’ve used the <code>downcase</code> method to ensure that the argument to <code>hexdigest</code> is all lower-case.<span class="intersentencespace"></span> The resulting <code>gravatar_for</code> helper appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gravatar_for_helper" class="hyperref">Listing&nbsp;<span class="ref">7.13</span></a>.</p>
<div class="codelisting" id="_code-gravatar_for_helper" data-tralics-id="uid539" data-number="7.13"><div class="heading"><span class="number">Listing 7.13:</span> 

<span class="description">Defining a <code>gravatar_for</code> helper method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/users_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"gravatar"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gravatar_for_helper" class="hyperref">Listing&nbsp;<span class="ref">7.13</span></a> returns an image tag for the Gravatar with a <code>"gravatar"</code> class and alt text equal to the user’s name (which is especially convenient for sight-impaired users using a screen reader).<span class="intersentencespace"></span> You can confirm that the test suite is now passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>The profile page appears as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_with_gravatar" class="hyperref">Figure&nbsp;<span class="ref">7.7</span></a>, which shows the default Gravatar image, which appears because <code>user@example.com</code> is an invalid email address—the <a href="http://example.com/" target="_blank">example.com</a> domain is reserved for examples (like this one).</p>
<div class="center figure" id="_fig-profile_with_gravatar" data-tralics-id="uid540" data-number="7.7">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/profile_with_gravatar_bootstrap_4_0.png" alt="images/figures/profile_with_gravatar_bootstrap_4_0"></div><div class="caption"><span class="header">Figure 7.7: </span><span class="description">The user profile page <a href="http://localhost:3000/users/1" target="_blank">/users/1</a> with the default Gravatar.
</span></div></div>
<p>To get our application to display a custom Gravatar, we’ll use <code>update_attributes</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.5</span></a>) to update the user in the database:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>Here we’ve assigned the user the email address <code>example@railstutorial.org</code>, which I’ve associated with the Rails Tutorial logo, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_custom_gravatar" class="hyperref">Figure&nbsp;<span class="ref">7.8</span></a>.</p>
<div class="center figure" id="_fig-profile_custom_gravatar" data-tralics-id="uid541" data-number="7.8">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/profile_custom_gravatar_bootstrap_4_0.png" alt="images/figures/profile_custom_gravatar_bootstrap_4_0"></div><div class="caption"><span class="header">Figure 7.8: </span><span class="description">The user show page with a custom Gravatar.
</span></div></div>
<p>The last element needed to complete the mockup from <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_mockup_profile_name" class="hyperref">Figure&nbsp;<span class="ref">7.1</span></a> is the initial version of the user sidebar.<span class="intersentencespace"></span> We’ll implement it using the <code>aside</code> tag, which is used for content (such as sidebars) that complements the rest of the page but can also stand alone.<span class="intersentencespace"></span> We include <code>row</code> and <code>span4</code> classes, which are both part of Bootstrap.<span class="intersentencespace"></span> The code for the modified user show page appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_with_sidebar" class="hyperref">Listing&nbsp;<span class="ref">7.14</span></a>.</p>
<div class="codelisting" id="_code-user_show_with_sidebar" data-tralics-id="uid542" data-number="7.14"><div class="heading"><span class="number">Listing 7.14:</span> 

<span class="description">Adding a sidebar to the user <code>show</code> view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"span4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>With the HTML elements and CSS classes in place, we can style the profile page (including the sidebar and the Gravatar) with the SCSS shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sidebar_css" class="hyperref">Listing&nbsp;<span class="ref">7.15</span></a>.<span class="intersentencespace"></span> (Note the nesting of the table CSS rules, which works only because of the Sass engine used by the asset pipeline.)<span class="intersentencespace"></span> The resulting page is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_show_sidebar_css" class="hyperref">Figure&nbsp;<span class="ref">7.9</span></a>.</p>
<div class="codelisting" id="_code-sidebar_css" data-tralics-id="uid543" data-number="7.15"><div class="heading"><span class="number">Listing 7.15:</span> 

<span class="description">SCSS for styling the user show page, including the sidebar.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">section</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">span</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.4</span><span class="kt">em</span><span class="p">;</span>
      <span class="na">text-align</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-top</span><span class="o">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="_fig-user_show_sidebar_css" data-tralics-id="uid544" data-number="7.9">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_show_sidebar_css_bootstrap.png" alt="images/figures/user_show_sidebar_css_bootstrap"></div><div class="caption"><span class="header">Figure 7.9: </span><span class="description">The user show page <a href="http://localhost:3000/users/1" target="_blank">/users/1</a> with a sidebar and CSS.
</span></div></div>
</div></div>
<div id="_sec-signup_form" data-tralics-id="cid41" class="section" data-number="7.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_form" class="heading hyperref"><span class="number">7.2 </span>Signup form</a></h2>
<p>Now that we have a working (though not yet complete) user profile page, we’re ready to make a signup form for our site.<span class="intersentencespace"></span> We saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-new_signup_page" class="hyperref">Figure&nbsp;<span class="ref">5.9</span></a> (shown again in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-blank_signup_page_recap" class="hyperref">Figure&nbsp;<span class="ref">7.10</span></a>) that the signup page is currently blank: useless for signing up new users.<span class="intersentencespace"></span> The goal of this section is to start changing this sad state of affairs by producing the signup form mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_mockup" class="hyperref">Figure&nbsp;<span class="ref">7.11</span></a>.</p>
<div class="center figure" id="_fig-blank_signup_page_recap" data-tralics-id="uid545" data-number="7.10">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/new_signup_page_bootstrap.png" alt="images/figures/new_signup_page_bootstrap"></div><div class="caption"><span class="header">Figure 7.10: </span><span class="description">The current state of the signup page <a href="http://localhost:3000/signup" target="_blank">/signup</a>.
</span></div></div>
<div class="center figure" id="_fig-signup_mockup" data-tralics-id="uid546" data-number="7.11">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_mockup_bootstrap.png" alt="images/figures/signup_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 7.11: </span><span class="description">A mockup of the user signup page.
</span></div></div>
<p>Since we’re about to add the ability to create new users through the web, let’s remove the user created at the console in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_a_user" class="hyperref">Section&nbsp;<span class="ref">6.3.5</span></a>.<span class="intersentencespace"></span> The cleanest way to do this is to reset the database with the <code>db:reset</code> Rake task:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
</pre></div></div>
<p>After resetting the database, on some systems the test database needs to be re-prepared as well:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>Finally, on some systems you might have to restart the web server (using Ctrl-C) for the changes to take effect.<sup id="_cha-7_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-8">8</a></sup></p>
<div id="_sec-tests_for_user_signup" data-tralics-id="uid548" class="subsection" data-number="7.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-tests_for_user_signup" class="heading hyperref"><span class="number">7.2.1 </span>Tests for user signup</a></h3>
<p>In the days before powerful web frameworks with full testing capabilities, testing was often painful and error-prone.<span class="intersentencespace"></span> For example, to test a signup page manually, we would have to visit the page in a browser and then submit alternately invalid and valid data, verifying in each case that the application’s behavior was correct.<span class="intersentencespace"></span> Moreover, we would have to remember to repeat the process any time the application changed.<span class="intersentencespace"></span> With RSpec and Capybara, we will be able to write expressive tests to automate tasks that used to have to be done by hand.</p>
<p>We’ve already seen how Capybara supports an intuitive web-navigation syntax.<span class="intersentencespace"></span> So far, we’ve mostly used <code>visit</code> to visit particular pages, but Capybara can do a lot more, including filling in the kind of fields we see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_mockup" class="hyperref">Figure&nbsp;<span class="ref">7.11</span></a> and clicking on the button.<span class="intersentencespace"></span> The syntax looks like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">click_button</span> <span class="s2">"Create my account"</span>
</pre></div></div>
<p>Our goal now is to write tests for the right behavior given invalid and valid signup information.<span class="intersentencespace"></span> Because these tests are fairly advanced, we’ll build them up piece by piece.<span class="intersentencespace"></span> If you want to see how they work (including which file to put them in), you can skip ahead to <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-basic_signup_tests" class="hyperref">Listing&nbsp;<span class="ref">7.16</span></a>.</p>
<p>Our first task is to test for a failing signup form, and we can simulate the submission of invalid data by visiting the page and clicking the button using <code>click_button</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">click_button</span> <span class="s2">"Create my account"</span>
</pre></div></div>
<p>This is equivalent to visiting the signup page and submitting blank signup information (which is invalid).<span class="intersentencespace"></span> Similarly, to simulate the submission of valid data, we fill in valid information using <code>fill_in</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
<span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>        <span class="ss">with</span><span class="p">:</span> <span class="s2">"user@example.com"</span>
<span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>     <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">fill_in</span> <span class="s2">"Confirmation"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">click_button</span> <span class="s2">"Create my account"</span>
</pre></div></div>
<p>The purpose of our tests is to verify that clicking the signup button results in the correct behavior, creating a new user when the information is valid and not creating a user when it’s invalid.<span class="intersentencespace"></span> The way to do this is to check the <em>count</em> of users, and under the hood our tests will use the <code>count</code> method available on every Active Record class, including <code>User</code>:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 0</span>
</pre></div></div>
<p>Here <code>User.count</code> is <code>0</code> because we reset the database at the beginning of this section.</p>
<p>When submitting invalid data, we expect the user count not to change; when submitting valid data, we expect it to change by 1.<span class="intersentencespace"></span> We can express this in RSpec by combining the <code>expect</code> method with either the <code>to</code> method or the <code>not_to</code> method.<span class="intersentencespace"></span> We’ll start with the invalid case since it is simpler; we visit the signup path and click the button, and we expect it <em>not to</em> change the user count:</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Create my account"</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div></div>
<p>Note that, as indicated by the curly braces, <code>expect</code> wraps <code>click_button</code> in a block (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-blocks" class="hyperref">Section&nbsp;<span class="ref">4.3.2</span></a>).<span class="intersentencespace"></span> This is for the benefit of the <code>change</code> method, which takes as arguments an object and a symbol and then calculates the result of calling that symbol as a method on the object both before and after the block.<span class="intersentencespace"></span> In other words, the code</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Create my account"</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div></div>
<p>calculates</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>before and after the execution of</p>
<div class="code"><div class="highlight"><pre><span class="n">click_button</span> <span class="s2">"Create my account"</span>
</pre></div></div>
<p>In the present case, we want the given code <em>not</em> to change the count, which we express using the <code>not_to</code> method.<span class="intersentencespace"></span> In effect, by enclosing the button click in a block we are able to replace</p>
<div class="code"><div class="highlight"><pre><span class="n">initial</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">click_button</span> <span class="s2">"Create my account"</span>
<span class="n">final</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">expect</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">final</span>
</pre></div></div>
<p>with the single line</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Create my account"</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div></div>
<p>which reads like natural language and is much more compact.<span class="intersentencespace"></span> (Note that <code>eq</code> is an RSpec method to test equality.)</p>
<p>The case of valid data is similar, but instead of verifying that the user count doesn’t change, we check that clicking the button changes the count by 1:</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
<span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>        <span class="ss">with</span><span class="p">:</span> <span class="s2">"user@example.com"</span>
<span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>     <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">fill_in</span> <span class="s2">"Confirmation"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
<span class="n">expect</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">"Create my account"</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div></div>
<p>This uses the <code>to</code> method because we expect a click on the signup button with valid data <em>to</em> change the user count by one.</p>
<p>Combining the two cases with the appropriate <code>describe</code> blocks and pulling the common code into <code>before</code> blocks yields good basic tests for signing up users, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-basic_signup_tests" class="hyperref">Listing&nbsp;<span class="ref">7.16</span></a>.<span class="intersentencespace"></span> Here we’ve factored out the common text for the submit button using the <code>let</code> method to define a <code>submit</code> variable.</p>
<div class="codelisting" id="_code-basic_signup_tests" data-tralics-id="uid549" data-number="7.16"><div class="heading"><span class="number">Listing 7.16:</span> 

<span class="description">Good basic tests for signing up users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signup page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"signup"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:submit</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Create my account"</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">"should not create a user"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="s2">"Example User"</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>        <span class="ss">with</span><span class="p">:</span> <span class="s2">"user@example.com"</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>     <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
        <span class="n">fill_in</span> <span class="s2">"Confirmation"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"foobar"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"should create a user"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We’ll add a few more tests as needed in the sections that follow, but the basic tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-basic_signup_tests" class="hyperref">Listing&nbsp;<span class="ref">7.16</span></a> already cover an impressive amount of functionality.<span class="intersentencespace"></span> To get them to pass, we have to create a signup page with just the right elements, arrange for the page’s submission to be routed to the right place, and successfully create a new user in the database only if the resulting user data is valid.</p>
<p>Of course, at this point the tests should fail:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-using_form_for" data-tralics-id="uid550" class="subsection" data-number="7.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-using_form_for" class="heading hyperref"><span class="number">7.2.2 </span>Using <span class="tt">form_for</span></a></h3>
<p>Now that we have good failing tests for user signup, we’ll start getting them to pass by making a <em>form</em> for signing up users.<span class="intersentencespace"></span> We can accomplish this in Rails with the <code>form_for</code> helper method, which takes in an Active Record object and constructs a form using the object’s attributes.<span class="intersentencespace"></span> The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a>.<span class="intersentencespace"></span> (Readers familiar with Rails&nbsp;2.x should note that <code>form_for</code> uses the “percent-equals” ERb syntax for inserting content; that is, where Rails&nbsp;2.x used <span class="inline_verbatim">&lt;% form_for ... %&gt;</span>, we now use <span class="inline_verbatim">&lt;%= form_for ... %&gt;</span> instead.)</p>
<div class="codelisting" id="_code-signup_form" data-tralics-id="uid551" data-number="7.17"><div class="heading"><span class="number">Listing 7.17:</span> 

<span class="description">A form to sign up new users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Let’s break this down into pieces.<span class="intersentencespace"></span> The presence of the <code>do</code> keyword indicates that <code>form_for</code> takes a block with one variable, which we’ve called <code>f</code> for “form”:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>As is usually the case with Rails helpers, we don’t need to know any details about the implementation, but what we <em>do</em> need to know is what the <code>f</code> object does: when called with a method corresponding to an <a href="http://www.w3schools.com/html/html_forms.asp" target="_blank">HTML form element</a>—such as a text field, radio button, or password field—it returns code for that element specifically designed to set an attribute of the <code>@user</code> object.<span class="intersentencespace"></span> In other words,</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>creates the HTML needed to make a labeled text field element appropriate for setting the <code>name</code> attribute of a User model.<span class="intersentencespace"></span> (We’ll take a look at the HTML itself in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_form_html" class="hyperref">Section&nbsp;<span class="ref">7.2.3</span></a>.)</p>
<p>To see this in action, we need to drill down and look at the actual HTML produced by this form, but here we have a problem: the page currently breaks, because we have not set the <code>@user</code> variable—like all undefined instance variables (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>), <code>@user</code> is currently <code>nil</code>.<span class="intersentencespace"></span> Appropriately, if you run your test suite at this point, you’ll see that the tests for the contents of the signup page from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_signup_test" class="hyperref">Listing&nbsp;<span class="ref">7.6</span></a> now fail:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">"signup page"</span>
</pre></div></div>
<p>(The <code>-e</code> here arranges to run just the examples whose description strings match <code>"signup page"</code>.<span class="intersentencespace"></span> Note in particular that this is <em>not</em> the substring <code>"signup"</code>, which would run all the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-basic_signup_tests" class="hyperref">Listing&nbsp;<span class="ref">7.16</span></a>.)<span class="intersentencespace"></span> To get these tests to pass again and to get our form to render, we must define an <code>@user</code> variable in the controller action corresponding to <code>new.html.erb</code>, i.e., the <code>new</code> action in the Users controller.<span class="intersentencespace"></span> The <code>form_for</code> helper expects <code>@user</code> to be a User object, and since we’re creating a <em>new</em> user we simply use <code>User.new</code>, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_action_with_user" class="hyperref">Listing&nbsp;<span class="ref">7.18</span></a>.</p>
<div class="codelisting" id="_code-new_action_with_user" data-tralics-id="uid552" data-number="7.18"><div class="heading"><span class="number">Listing 7.18:</span> 

<span class="description">Adding an <code>@user</code> variable to the <code>new</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the <code>@user</code> variable so defined, the test for the signup page should be passing again:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">"signup page"</span>
</pre></div></div>
<p>At this point, the form (with the styling from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-form_css" class="hyperref">Listing&nbsp;<span class="ref">7.19</span></a>) appears as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_form" class="hyperref">Figure&nbsp;<span class="ref">7.12</span></a>.<span class="intersentencespace"></span> Note the reuse of the <code>box_sizing</code> mixin from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-mixin_and_debug" class="hyperref">Listing&nbsp;<span class="ref">7.2</span></a>.</p>
<div class="codelisting" id="_code-form_css" data-tralics-id="uid553" data-number="7.19"><div class="heading"><span class="number">Listing 7.19:</span> 

<span class="description">CSS for the signup form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>

<span class="nt">input</span><span class="o">,</span> <span class="nt">textarea</span><span class="o">,</span> <span class="nt">select</span><span class="o">,</span> <span class="nc">.uneditable-input</span> <span class="p">{</span>
  <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#bbb</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">input</span> <span class="p">{</span>
  <span class="na">height</span><span class="o">:</span> <span class="no">auto</span> <span class="nv">!important</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="_fig-signup_form" data-tralics-id="uid554" data-number="7.12">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_form_bootstrap.png" alt="images/figures/signup_form_bootstrap"></div><div class="caption"><span class="header">Figure 7.12: </span><span class="description">The signup form <a href="http://localhost:3000/signup" target="_blank">/signup</a> for new users.
</span></div></div>
</div>
<div id="_sec-the_form_html" data-tralics-id="uid555" class="subsection" data-number="7.2.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_form_html" class="heading hyperref"><span class="number">7.2.3 </span>The form HTML</a></h3>
<p>As indicated by <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_form" class="hyperref">Figure&nbsp;<span class="ref">7.12</span></a>, the signup page now renders properly, indicating that the <code>form_for</code> code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a> is producing valid HTML. If you look at the HTML for the generated form (using either <a href="http://getfirebug.com/" target="_blank">Firebug</a> or the “view page source” feature of your browser), you should see markup as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form_html" class="hyperref">Listing&nbsp;<span class="ref">7.20</span></a>.<span class="intersentencespace"></span> Although many of the details are irrelevant for our purposes, let’s take a moment to highlight the most important parts of its structure.</p>
<div class="codelisting" id="_code-signup_form_html" data-tralics-id="uid556" data-number="7.20"><div class="heading"><span class="number">Listing 7.20:</span> 

<span class="description">The HTML for the form in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_form" class="hyperref">Figure&nbsp;<span class="ref">7.12</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span>
      <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_email"</span> <span class="na">name=</span><span class="s">"user[email]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span>
         <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password_confirmation"</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password_confirmation"</span>
         <span class="na">name=</span><span class="s">"user[password_confirmation]"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-large btn-primary"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span>
         <span class="na">value=</span><span class="s">"Create my account"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div><p>(Here I’ve omitted some HTML related to the <em>authenticity token</em>, which Rails automatically includes to thwart a particular kind of attack called a <em>cross-site request forgery</em> (CSRF).<span class="intersentencespace"></span> See <a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token" target="_blank">the Stack Overflow entry on the Rails authenticity token</a> if you’re interested in the details of how this works and why it’s important.)</p>
<p>We’ll start with the internal structure of the document.<span class="intersentencespace"></span> Comparing <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a> with <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form_html" class="hyperref">Listing&nbsp;<span class="ref">7.20</span></a>, we see that the Embedded Ruby</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>produces the HTML</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>produces the HTML</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"user_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>As seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-filled_in_form" class="hyperref">Figure&nbsp;<span class="ref">7.13</span></a>, text fields (<code>type="text"</code>) simply display their contents, whereas password fields (<code>type="password"</code>) obscure the input for security purposes, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-filled_in_form" class="hyperref">Figure&nbsp;<span class="ref">7.13</span></a>.</p>
<div class="center figure" id="_fig-filled_in_form" data-tralics-id="uid557" data-number="7.13">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/filled_in_form_bootstrap.png" alt="images/figures/filled_in_form_bootstrap"></div><div class="caption"><span class="header">Figure 7.13: </span><span class="description">A filled-in form with <code>text</code> and <code>password</code> fields.
</span></div></div>
<p>As we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_success" class="hyperref">Section&nbsp;<span class="ref">7.4</span></a>, the key to creating a user is the special <code>name</code> attribute in each <code>input</code>:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_name"</span> <span class="na">name=</span><span class="s">"user[name]"</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_password"</span> <span class="na">name=</span><span class="s">"user[password]"</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>These <code>name</code> values allow Rails to construct an initialization hash (via the <code>params</code> variable) for creating users using the values entered by the user, as we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_failure" class="hyperref">Section&nbsp;<span class="ref">7.3</span></a>.</p>
<p>The second important element is the <code>form</code> tag itself.<span class="intersentencespace"></span> Rails creates the <code>form</code> tag using the <code>@user</code> object: because every Ruby object knows its own class (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-constructors" class="hyperref">Section&nbsp;<span class="ref">4.4.1</span></a>), Rails figures out that <code>@user</code> is of class <code>User</code>; moreover, since <code>@user</code> is a <em>new</em> user, Rails knows to construct a form with the <code>post</code> method, which is the proper verb for creating a new object (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-get_etc" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span> <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
</pre></div></div>
<p>Here the <code>class</code> and <code>id</code> attributes are largely irrelevant; what’s important is <code>action="/users"</code> and <code>method="post"</code>.<span class="intersentencespace"></span> Together, these constitute instructions to issue an HTTP <span class="tt">POST</span> request to the /users URL. We’ll see in the next two sections what effects this has.</p>
</div></div>
<div id="_sec-signup_failure" data-tralics-id="cid42" class="section" data-number="7.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_failure" class="heading hyperref"><span class="number">7.3 </span>Signup failure</a></h2>
<p>Although we’ve briefly examined the HTML for the form in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_form" class="hyperref">Figure&nbsp;<span class="ref">7.12</span></a> (shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form_html" class="hyperref">Listing&nbsp;<span class="ref">7.20</span></a>), we haven’t yet covered any details, and the form is best understood in the context of <em>signup failure</em>.<span class="intersentencespace"></span> In this section, we’ll create a signup form that accepts an invalid submission and re-renders the signup page with a list of errors, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_failure_mockup" class="hyperref">Figure&nbsp;<span class="ref">7.14</span></a>.</p>
<div class="center figure" id="_fig-signup_failure_mockup" data-tralics-id="uid558" data-number="7.14">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_failure_mockup_bootstrap.png" alt="images/figures/signup_failure_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 7.14: </span><span class="description">A mockup of the signup failure page.
</span></div></div>
<div id="_sec-a_working_form" data-tralics-id="uid559" class="subsection" data-number="7.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_form" class="heading hyperref"><span class="number">7.3.1 </span>A working form</a></h3>
<p>Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="hyperref">Section&nbsp;<span class="ref">7.1.2</span></a> that adding <code>resources :users</code> to the <code>routes.rb</code> file (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_resource" class="hyperref">Listing&nbsp;<span class="ref">7.3</span></a>) automatically ensures that our Rails application responds to the RESTful URLs from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>.<span class="intersentencespace"></span> In particular, it ensures that a <span class="tt">POST</span> request to /users is handled by the <code>create</code> action.<span class="intersentencespace"></span> Our strategy for the <code>create</code> action is to use the form submission to make a new user object using <code>User.new</code>, try (and fail) to save that user, and then render the signup page for possible resubmission.<span class="intersentencespace"></span> Let’s get started by reviewing the code for the signup form:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users"</span> <span class="na">class=</span><span class="s">"new_user"</span> <span class="na">id=</span><span class="s">"new_user"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
</pre></div></div>
<p>As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_form_html" class="hyperref">Section&nbsp;<span class="ref">7.2.3</span></a>, this HTML issues a <span class="tt">POST</span> request to the /users URL.</p>
<p>Our first step in getting the test for invalid information from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-basic_signup_tests" class="hyperref">Listing&nbsp;<span class="ref">7.16</span></a> to pass is to add the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-first_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.21</span></a>.<span class="intersentencespace"></span> This listing includes a second use of the <code>render</code> method, which we first saw in the context of partials (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-partials" class="hyperref">Section&nbsp;<span class="ref">5.1.3</span></a>); as you can see, <code>render</code> works in controller actions as well.<span class="intersentencespace"></span> Note that we’ve taken this opportunity to introduce an <code>if</code>-<code>else</code> branching structure, which allows us to handle the cases of failure and success separately based on the value of <code>@user.save</code>, which (as we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.3</span></a>) is either <code>true</code> or <code>false</code> depending on whether the save succeeds.</p>
<div class="codelisting" id="_code-first_create_action" data-tralics-id="uid560" data-number="7.21"><div class="heading"><span class="number">Listing 7.21:</span> 

<span class="description">A <code>create</code> action that can handle signup failure (but not success).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>    <span class="c1"># Not the final implementation!</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note the comment: this is not the final implementation, but it’s enough to get us started.<span class="intersentencespace"></span> We’ll finish the implementation in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strong_parameters" class="hyperref">Section&nbsp;<span class="ref">7.3.2</span></a>.</p>
<p>The best way to understand how the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-first_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.21</span></a> works is to <em>submit</em> the form with some invalid signup data; the result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_failure" class="hyperref">Figure&nbsp;<span class="ref">7.15</span></a>, and the full debug information (with an increased font size) appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_failure_rails_debug" class="hyperref">Figure&nbsp;<span class="ref">7.16</span></a>.</p>
<div class="center figure" id="_fig-signup_failure" data-tralics-id="uid561" data-number="7.15">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_failure_rails_4.png" alt="images/figures/signup_failure_rails_4"></div><div class="caption"><span class="header">Figure 7.15: </span><span class="description">Signup failure.
</span></div></div>
<div class="center figure" id="_fig-signup_failure_rails_debug" data-tralics-id="uid562" data-number="7.16">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_failure_rails_4_debug.png" alt="images/figures/signup_failure_rails_4_debug"></div><div class="caption"><span class="header">Figure 7.16: </span><span class="description">Signup failure debug information.
</span></div></div>
<p>To get a better picture of how Rails handles the submission, let’s take a closer look at the <code>user</code> part of the parameters hash from the debug information (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_failure_rails_debug" class="hyperref">Figure&nbsp;<span class="ref">7.16</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="s2">"user"</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Foo Bar"</span><span class="p">,</span>
            <span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
            <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"[FILTERED]"</span><span class="p">,</span>
            <span class="s2">"password_confirmation"</span> <span class="o">=&gt;</span> <span class="s2">"[FILTERED]"</span>
          <span class="p">}</span>
</pre></div></div>
<p>This hash gets passed to the Users controller as <code>params</code>, and we saw starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="hyperref">Section&nbsp;<span class="ref">7.1.2</span></a> that the <code>params</code> hash contains information about each request.<span class="intersentencespace"></span> In the case of a URL like /users/1, the value of <code>params[:id]</code> is the <code>id</code> of the corresponding user (<code>1</code>&nbsp;in this example).<span class="intersentencespace"></span> In the case of posting to the signup form, <code>params</code> instead contains a hash of hashes, a construction we first saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-hashes_and_symbols" class="hyperref">Section&nbsp;<span class="ref">4.3.3</span></a>, which introduced the strategically named <code>params</code> variable in a console session.<span class="intersentencespace"></span> The debug information above shows that submitting the form results in a <code>user</code> hash with attributes corresponding to the submitted values, where the keys come from the <code>name</code> attributes of the <code>input</code> tags seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a>; for example, the value of</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"user_email"</span> <span class="na">name=</span><span class="s">"user[email]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>with name <code>"user[email]"</code> is precisely the <code>email</code> attribute of the <code>user</code> hash.</p>
<p>Although the hash keys appear as strings in the debug output, they get passed to the Users controller as symbols, so that <code>params[:user]</code> is the hash of user attributes—in fact, exactly the attributes needed as an argument to <code>User.new</code>, as first seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a> and appearing in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-first_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.21</span></a>.<span class="intersentencespace"></span> This means that the line</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>is mostly equivalent to</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo Bar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
                 <span class="ss">password</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">)</span>
</pre></div></div>
<p>In previous versions of Rails, using</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>actually worked, but it was insecure by default and required a careful and error-prone procedure to prevent malicious users from potentially modifying the application database.<span class="intersentencespace"></span> As of Rails&nbsp;4.0, this code raises an error (as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_failure" class="hyperref">Figure&nbsp;<span class="ref">7.15</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_failure_rails_debug" class="hyperref">Figure&nbsp;<span class="ref">7.16</span></a> above), which means it is secure by default.<span class="intersentencespace"></span> We can double-check this by verifying that the relevant tests fail:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"signup with invalid information"</span>
</pre></div></div>
</div>
<div id="_sec-strong_parameters" data-tralics-id="uid563" class="subsection" data-number="7.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strong_parameters" class="heading hyperref"><span class="number">7.3.2 </span>Strong parameters</a></h3>
<p>We mentioned briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a> the idea of <em>mass assignment</em>, which involves initializing a Ruby variable using a hash of values, as in</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>    <span class="c1"># Not the final implementation!</span>
</pre></div></div>
<p>The comment included in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-first_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.21</span></a> and reproduced above indicates that this is not the final implementation.<span class="intersentencespace"></span> The reason is that initializing the entire <code>params</code> hash is <em>extremely</em> dangerous—it arranges to pass to <code>User.new</code> <em>all</em> data submitted by a user.<span class="intersentencespace"></span> In particular, suppose that, in addition to the current attributes, the User model included an <code>admin</code> attribute used to identify administrative users of the site.<span class="intersentencespace"></span> (We will implement just such an attribute in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-administrative_users" class="hyperref">Section&nbsp;<span class="ref">9.4.1</span></a>.)<span class="intersentencespace"></span> The way to set such an attribute to <code>true</code> is to pass the value <code>admin=’1’</code> as part of <code>params[:user]</code>, a task that is easy to accomplish using a command-line HTTP client such as <span class="tt">curl</span>.<span class="intersentencespace"></span> The result would be that, by passing in the entire <code>params</code> hash to <code>User.new</code>, we would allow any user of the site to gain administrative access by including <code>admin=’1’</code> in the web request.</p>
<p>Previous versions of Rails used a method called <code>attr_accessible</code> in the <em>model</em> layer to solve this problem, but as of Rails&nbsp;4.0 the preferred technique is to use so-called <em>strong parameters</em> in the controller layer.<span class="intersentencespace"></span> This allows us to specify which parameters are <em>required</em> and which ones are <em>permitted</em>.<span class="intersentencespace"></span> In addition, passing in a raw <code>params</code> hash as above will cause an error to be raised, so that Rails applications are now immune to mass assignment vulnerabilities by default.</p>
<p>In the present instance, we want to require the <code>params</code> hash to have a <code>:user</code> attribute, and we want to permit the name, email, password, and password confirmation attributes (but no others).<span class="intersentencespace"></span> We can accomplish this as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
</pre></div></div>
<p>This code returns a version of the <code>params</code> hash with only the permitted attributes (while raising an error if the <code>:user</code> attribute is missing).</p>
<p>To facilitate the use of these parameters, it’s conventional to introduce an auxiliary method called <code>user_params</code> that returns an appropriate initialization hash and use it in place of <code>params[:user]</code>:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</pre></div></div>
<p>Since <code>user_params</code> will only be used internally by the Users controller and need not be exposed to external users via the web, we’ll make it <em>private</em> using Ruby’s <code>private</code> keyword, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-create_action_strong_parameters" class="hyperref">Listing&nbsp;<span class="ref">7.22</span></a>.<span class="intersentencespace"></span> (We’ll discuss <code>private</code> in more detail in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a>.)</p>
<div class="codelisting" id="_code-create_action_strong_parameters" data-tralics-id="uid564" data-number="7.22"><div class="heading"><span class="number">Listing 7.22:</span> 

<span class="description">Using strong parameters in the <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-create_action_strong_parameters" class="hyperref">Listing&nbsp;<span class="ref">7.22</span></a>, the tests for invalid submission should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"signup with invalid information"</span>
</pre></div></div>
</div>
<div id="_sec-signup_error_messages" data-tralics-id="uid565" class="subsection" data-number="7.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_error_messages" class="heading hyperref"><span class="number">7.3.3 </span>Signup error messages</a></h3>
<p>As a final step in handling failed user creation, we’ll add helpful error messages to indicate the problems that prevented successful registration.<span class="intersentencespace"></span> Conveniently, Rails automatically provides such messages based on the User model validations.<span class="intersentencespace"></span> For example, consider trying to save a user with an invalid email address and with a password that’s too short:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo Bar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
<span class="gp">?&gt; </span>                <span class="ss">password</span><span class="p">:</span> <span class="s2">"dude"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"dude"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; ["Email is invalid", "Password is too short (minimum is 6 characters)"]</span>
</pre></div></div>
<p>Here the <code>errors.full_messages</code> object (which we saw briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-presence_validation" class="hyperref">Section <span class="ref">6.2.2</span></a>) contains an array of error messages.</p>
<p>As in the console session above, the failed save in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-first_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.21</span></a> generates a list of error messages associated with the <code>@user</code> object.<span class="intersentencespace"></span> To display the messages in the browser, we’ll render an error-messages partial on the user <code>new</code> page, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-f_error_messages" class="hyperref">Listing&nbsp;<span class="ref">7.23</span></a>.<span class="intersentencespace"></span> (Writing a test for the error messages first is a good idea and is left as an exercise; see <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_exercises" class="hyperref">Section&nbsp;<span class="ref">7.6</span></a>.)<span class="intersentencespace"></span> It’s worth noting that this error messages partial is only a first attempt; the final version appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_microposts" class="hyperref">Section&nbsp;<span class="ref">10.3.2</span></a>.</p>
<div class="codelisting" id="_code-f_error_messages" data-tralics-id="uid566" data-number="7.23"><div class="heading"><span class="number">Listing 7.23:</span> 

<span class="description">Code to display error messages on the signup form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Notice here that we <code>render</code> a partial called <code>’shared/error_messages’</code>; this reflects the common Rails convention of using a dedicated <code>shared/</code> directory for partials expected to be used in views across multiple controllers.<span class="intersentencespace"></span> (We’ll see this expectation fulfilled in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-edit_form" class="hyperref">Section&nbsp;<span class="ref">9.1.1</span></a>.)<span class="intersentencespace"></span> This means that we have to create both the new <code>app/views/shared</code> directory and the <code>_error_messages.html.erb</code> partial file.<span class="intersentencespace"></span> The partial itself appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-errors_partial" class="hyperref">Listing&nbsp;<span class="ref">7.24</span></a>.</p>
<div class="codelisting" id="_code-errors_partial" data-tralics-id="uid567" data-number="7.24"><div class="heading"><span class="number">Listing 7.24:</span> 

<span class="description">A partial for displaying form submission error messages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_error_messages.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-error"</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>This partial introduces several new Rails and Ruby constructs, including two methods for Rails error objects.<span class="intersentencespace"></span> The first method is <code>count</code>, which simply returns the number of errors:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 2</span>
</pre></div></div>
<p>The other new method is <code>any?</code>, which (together with <code>empty?</code>) is one of a pair of complementary methods:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>We see here that the <code>empty?</code> method, which we first saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-objects_and_message_passing" class="hyperref">Section&nbsp;<span class="ref">4.2.3</span></a> in the context of strings, also works on Rails error objects, returning <code>true</code> for an empty object and <code>false</code> otherwise.<span class="intersentencespace"></span> The <code>any?</code> method is just the opposite of <code>empty?</code>, returning <code>true</code> if there are any elements present and <code>false</code> otherwise.<span class="intersentencespace"></span> (By the way, all of these methods—<code>count</code>, <code>empty?</code>, and <code>any?</code>—work on Ruby arrays as well.<span class="intersentencespace"></span> We’ll put this fact to good use starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_microposts" class="hyperref">Section&nbsp;<span class="ref">10.2</span></a>.)</p>
<p>The other new idea is the <code>pluralize</code> text helper.<span class="intersentencespace"></span> It isn’t available in the console by default, but we can include it explicitly through the <code>ActionView::Helpers::TextHelper</code> module:<sup id="_cha-7_footnote-ref-9" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-9">9</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">include</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">TextHelper</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span>
<span class="go">=&gt; "1 error"</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span>
<span class="go">=&gt; "5 errors"</span>
</pre></div></div>
<p>We see here that <code>pluralize</code> takes an integer argument and then returns the number with a properly pluralized version of its second argument.<span class="intersentencespace"></span> Underlying this method is a powerful <em>inflector</em> that knows how to pluralize a large number of words, including many with irregular plurals:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"woman"</span><span class="p">)</span>
<span class="go">=&gt; "2 women"</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"erratum"</span><span class="p">)</span>
<span class="go">=&gt; "3 errata"</span>
</pre></div></div>
<p>As a result of its use of <code>pluralize</code>, the code</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>returns <code>"0 errors"</code>, <code>"1 error"</code>, <code>"2 errors"</code>, and so on, depending on how many errors there are, thereby avoiding ungrammatical phrases such as <code>"1 errors"</code> (a distressingly common mistake on <a href="http://www.urbandictionary.com/define.php?term=interwebs" target="_blank">teh interwebs</a>).</p>
<p>Note that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-errors_partial" class="hyperref">Listing&nbsp;<span class="ref">7.24</span></a> includes the CSS&nbsp;id <code>error_explanation</code> for use in styling the error messages.<span class="intersentencespace"></span> (Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="hyperref">Section&nbsp;<span class="ref">5.1.2</span></a> that CSS uses the pound sign <code>#</code> to style ids.)<span class="intersentencespace"></span> In addition, on error pages Rails automatically wraps the fields with errors in <code>div</code>s with the CSS class <code>field_with_errors</code>.<span class="intersentencespace"></span> These labels then allow us to style the error messages with the SCSS shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-error_messages_css" class="hyperref">Listing&nbsp;<span class="ref">7.25</span></a>, which makes use of Sass’s <code>@extend</code> function to include the functionality of two Bootstrap classes <code>control-group</code> and <code>error</code>.<span class="intersentencespace"></span> As a result, on failed submission the error messages appear surrounded by red, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_error_messages" class="hyperref">Figure&nbsp;<span class="ref">7.17</span></a>.<span class="intersentencespace"></span> Because the messages are generated by the model validations, they will automatically change if you ever change your mind about, say, the format of email addresses, or the minimum length of passwords.</p>
<div class="codelisting" id="_code-error_messages_css" data-tralics-id="uid569" data-number="7.25"><div class="heading"><span class="number">Listing 7.25:</span> 

<span class="description">CSS for styling error messages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nn">#error_explanation</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#f00</span><span class="p">;</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">18</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="k">@extend</span> <span class="nc">.control-group</span><span class="o">;</span>
  <span class="o">@</span><span class="nt">extend</span> <span class="nc">.error</span><span class="o">;</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="_fig-signup_error_messages" data-tralics-id="uid570" data-number="7.17">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_error_messages_bootstrap.png" alt="images/figures/signup_error_messages_bootstrap"></div><div class="caption"><span class="header">Figure 7.17: </span><span class="description">Failed signup with error messages.
</span></div></div>
<p>To see the results of our work in this section, we’ll recapitulate the steps in the failed signup test from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-basic_signup_tests" class="hyperref">Listing&nbsp;<span class="ref">7.16</span></a> by visiting the signup page and clicking “Create my account” with blank input fields.<span class="intersentencespace"></span> The result is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-blank_signup_password_digest" class="hyperref">Figure&nbsp;<span class="ref">7.18</span></a>.<span class="intersentencespace"></span> As you might guess from the working page, at this point the corresponding test should also pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"signup with invalid information"</span>
</pre></div></div>
<div class="center figure" id="_fig-blank_signup_password_digest" data-tralics-id="uid571" data-number="7.18">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/blank_signup_password_digest_bootstrap_4_0.png" alt="images/figures/blank_signup_password_digest_bootstrap_4_0"></div><div class="caption"><span class="header">Figure 7.18: </span><span class="description">The result of visiting <a href="http://localhost:3000/signup" target="_blank">/signup</a> and just clicking “Create my account”.
</span></div></div>
</div></div>
<div id="_sec-signup_success" data-tralics-id="cid43" class="section" data-number="7.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_success" class="heading hyperref"><span class="number">7.4 </span>Signup success</a></h2>
<p>Having handled invalid form submissions, now it’s time to complete the signup form by actually saving a new user (if valid) to the database.<span class="intersentencespace"></span> First, we try to save the user; if the save succeeds, the user’s information gets written to the database automatically, and we then <em>redirect</em> the browser to show the user’s profile (together with a friendly greeting), as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_success_mockup" class="hyperref">Figure&nbsp;<span class="ref">7.19</span></a>.<span class="intersentencespace"></span> If it fails, we simply fall back on the behavior developed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_failure" class="hyperref">Section&nbsp;<span class="ref">7.3</span></a>.</p>
<div class="center figure" id="_fig-signup_success_mockup" data-tralics-id="uid572" data-number="7.19">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_success_mockup_bootstrap.png" alt="images/figures/signup_success_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 7.19: </span><span class="description">A mockup of successful signup.
</span></div></div>
<div id="_sec-the_finished_signup_form" data-tralics-id="uid573" class="subsection" data-number="7.4.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_finished_signup_form" class="heading hyperref"><span class="number">7.4.1 </span>The finished signup form</a></h3>
<p>To complete a working signup form, we need to fill in the commented-out section in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-first_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.21</span></a> with the appropriate behavior.<span class="intersentencespace"></span> Currently, the test for valid submission should be failing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"signup with valid information"</span>
</pre></div></div>
<p>This is because the default behavior for a Rails action is to render the corresponding view, but there is not (nor should there be) a view template corresponding to the <code>create</code> action.<span class="intersentencespace"></span> Instead, we need to redirect to a different page, and it makes sense for that page to be the newly created user’s profile.<span class="intersentencespace"></span> Testing that the proper page gets rendered is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_exercises" class="hyperref">Section&nbsp;<span class="ref">7.6</span></a>); the application code appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.26</span></a>.</p>
<div class="codelisting" id="_code-user_create_action" data-tralics-id="uid574" data-number="7.26"><div class="heading"><span class="number">Listing 7.26:</span> 

<span class="description">The user <code>create</code> action with a save and a redirect.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we can omit the <code>user_url</code> in the redirect, writing simply <code>redirect_to @user</code> to redirect to the user show page.</p>
<p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.26</span></a>, our signup form is working, as you can verify by running the test suite:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-the_flash" data-tralics-id="uid575" class="subsection" data-number="7.4.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_flash" class="heading hyperref"><span class="number">7.4.2 </span>The flash</a></h3>
<p>Before submitting a valid registration in a browser, we’re going to add a bit of polish common in web applications: a message that appears on the subsequent page (in this case, welcoming our new user to the application) and then disappears upon visiting a second page or on page reload.<span class="intersentencespace"></span> The Rails way to accomplish this is to use a special variable called the <em>flash</em>, which we can treat like a hash.<span class="intersentencespace"></span> You may even recall the console example in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-hashes_and_symbols" class="hyperref">Section&nbsp;<span class="ref">4.3.3</span></a>, where we saw how to iterate through a hash using a strategically named <code>flash</code> hash:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success</span><span class="p">:</span> <span class="s2">"It worked!"</span><span class="p">,</span> <span class="ss">error</span><span class="p">:</span> <span class="s2">"It failed."</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;"It worked!", error: "It failed."}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">success</span>
<span class="go">It worked!</span>
<span class="go">error</span>
<span class="go">It failed.</span>
</pre></div></div>
<p>We can arrange to display the contents of the flash site-wide by including it in our application layout, as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_flash" class="hyperref">Listing&nbsp;<span class="ref">7.27</span></a>.<span class="intersentencespace"></span> (This code is a particularly ugly combination of HTML and ERb; an exercise in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_exercises" class="hyperref">Section&nbsp;<span class="ref">7.6</span></a> shows how to make it prettier.)</p>
<div class="codelisting" id="_code-layout_flash" data-tralics-id="uid576" data-number="7.27"><div class="heading"><span class="number">Listing 7.27:</span> 

<span class="description">Adding the contents of the <code>flash</code> variable to the site layout.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/header'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'layouts/footer'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div><p>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_flash" class="hyperref">Listing&nbsp;<span class="ref">7.27</span></a> arranges to insert a <code>div</code> tag for each element in the flash, with a CSS class indicating the type of message.<span class="intersentencespace"></span> For example, if <code>flash[:success] = "Welcome to the Sample App!"</code>, then the code</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>will produce this HTML:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-success"</span><span class="nt">&gt;</span>Welcome to the Sample App!<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
<p>(Note that the key <code>:success</code> is a symbol, but embedded Ruby automatically converts it to the string <code>"success"</code> before inserting it into the template.)<span class="intersentencespace"></span> The reason we iterate through all possible key/value pairs is so that we can include other kinds of flash messages.<span class="intersentencespace"></span> For example, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rendering_with_a_flash_message" class="hyperref">Section&nbsp;<span class="ref">8.1.5</span></a> we’ll see <code>flash[:error]</code> used to indicate a failed signin attempt.<sup id="_cha-7_footnote-ref-10" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-10">10</a></sup></p>
<p>Writing a test for the right flash message is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_exercises" class="hyperref">Section&nbsp;<span class="ref">7.6</span></a>), and we can get the test to pass by assigning <code>flash[:success]</code> a welcome message in the <code>create</code> action, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_flash" class="hyperref">Listing&nbsp;<span class="ref">7.28</span></a>.</p>
<div class="codelisting" id="_code-signup_flash" data-tralics-id="uid578" data-number="7.28"><div class="heading"><span class="number">Listing 7.28:</span> 

<span class="description">Adding a flash message to user signup.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-the_first_signup" data-tralics-id="uid579" class="subsection" data-number="7.4.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_first_signup" class="heading hyperref"><span class="number">7.4.3 </span>The first signup</a></h3>
<p>We can see the result of all this work by signing up our first user under the name “Rails Tutorial” and email address “example@railstutorial.org”.<span class="intersentencespace"></span> The resulting page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_flash" class="hyperref">Figure&nbsp;<span class="ref">7.20</span></a>) shows a friendly message upon successful signup, including nice green styling for the <code>success</code> class, which comes included with the Bootstrap CSS framework from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="hyperref">Section&nbsp;<span class="ref">5.1.2</span></a>.<span class="intersentencespace"></span> (If instead you get an error message indicating that the email address has already been taken, be sure to run the <code>db:reset</code> Rake task as indicated in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_form" class="hyperref">Section&nbsp;<span class="ref">7.2</span></a>.)<span class="intersentencespace"></span> Then, upon reloading the user show page, the flash message disappears as promised (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_flash_reloaded" class="hyperref">Figure&nbsp;<span class="ref">7.21</span></a>).</p>
<div class="center figure" id="_fig-signup_flash" data-tralics-id="uid580" data-number="7.20">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_flash_bootstrap.png" alt="images/figures/signup_flash_bootstrap"></div><div class="caption"><span class="header">Figure 7.20: </span><span class="description">The results of a successful user signup, with flash message.
</span></div></div>
<div class="center figure" id="_fig-signup_flash_reloaded" data-tralics-id="uid581" data-number="7.21">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_flash_reloaded_bootstrap.png" alt="images/figures/signup_flash_reloaded_bootstrap"></div><div class="caption"><span class="header">Figure 7.21: </span><span class="description">The flash-less profile page after a browser reload.
</span></div></div>
<p>We can now check our database just to be double-sure that the new user was actually created:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Rails Tutorial", email: "example@railstutorial.org",</span>
<span class="go">created_at: "2013-03-12 05:51:34", updated_at: "2013-03-12 05:51:34",</span>
<span class="go">password_digest: "$2a$10$A58/j7wwh3aAffGkMAO9Q.jjh3jshd.6akhDKtchAz/R..."&gt;</span>
</pre></div></div>
</div>
<div id="_sec-deploying_to_production_with_ssl" data-tralics-id="uid582" class="subsection" data-number="7.4.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying_to_production_with_ssl" class="heading hyperref"><span class="number">7.4.4 </span>Deploying to production with SSL</a></h3>
<p>Having developed the User model and the signup functionality, now is a good time to deploy the sample application to production.<span class="intersentencespace"></span> (If you didn’t follow the setup steps in the introduction to <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-static_pages" class="hyperref">Chapter&nbsp;<span class="ref">3</span></a>, you should go back and do them now.)<span class="intersentencespace"></span> As part of this, we will add <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank">Secure Sockets Layer (SSL)</a><sup id="_cha-7_footnote-ref-11" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-11">11</a></sup> to the production application, thereby making signup secure.<span class="intersentencespace"></span> Since we’ll implement SSL site-wide, the sample application will also be secure during user signin (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>) and will also be immune to the <em>session hijacking</em> vulnerability (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a>).</p>
<p>As preparation for the deployment, you should merge your changes into the <code>master</code> branch at this point:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Finish user signup"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-up
</pre></div></div>
<p>To get the deployment to work, we first need to add a line forcing the use of SSL in production.<span class="intersentencespace"></span> The result, which involves editing the production configuration file <code>config/environments/production.rb</code>, appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-ssl_in_production" class="hyperref">Listing&nbsp;<span class="ref">7.29</span></a>.</p>
<div class="codelisting" id="_code-ssl_in_production" data-tralics-id="uid584" data-number="7.29"><div class="heading"><span class="number">Listing 7.29:</span> 

<span class="description">Configuring the application to use SSL in production.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/environments/production.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security,</span>
  <span class="c1"># and use secure cookies.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">force_ssl</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To get the production site working, we have to commit the change to the configuration file and push the result up to Heroku:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -a -m <span class="s2">"Add SSL in production"</span>
<span class="gp">$</span> git push heroku
</pre></div></div>
<p>Next, we need to run the migration on the production database to tell Heroku about the User data model:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run rake db:migrate
</pre></div></div>
<p>(You might see some deprecation warnings at this point, which you should ignore.)</p>
<p>Finally, we need to set up SSL on the remote server.<span class="intersentencespace"></span> Configuring a production site to use SSL is painful and error-prone, and among other things it involves purchasing an <em>SSL certificate</em> for your domain.<span class="intersentencespace"></span> Luckily, for an application running on a Heroku domain (such as the sample application), we can piggyback on Heroku’s SSL certificate, a feature that is included automatically as part of the Heroku platform.<span class="intersentencespace"></span> If you want to run SSL on a custom domain, such as <code>example.com</code>, you’ll have no choice but to endure some pain, which you can read about on <a href="http://devcenter.heroku.com/articles/ssl" target="_blank">Heroku’s page on SSL</a>.</p>
<p>The result of all this work is a working signup form on the production server (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_in_production" class="hyperref">Figure&nbsp;<span class="ref">7.22</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div></div>
<p>Note in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_in_production" class="hyperref">Figure&nbsp;<span class="ref">7.22</span></a> the <span class="tt">https://</span> in place of the usual <span class="tt">http://</span>.<span class="intersentencespace"></span> The extra ‘s’ is an indication that SSL is working.</p>
<p>You should feel free to visit the signup page and create a new user at this time.<span class="intersentencespace"></span> If you have trouble, try running</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div></div>
<p>to debug the error using the Heroku logfile.</p>
<div class="center figure" id="_fig-signup_in_production" data-tralics-id="uid585" data-number="7.22">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signup_in_production_bootstrap.png" alt="images/figures/signup_in_production_bootstrap"></div><div class="caption"><span class="header">Figure 7.22: </span><span class="description">A working signup page on the live Web.
</span></div></div>
</div></div>
<div id="_cid44" data-tralics-id="cid44" class="section" data-number="7.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid44" class="heading hyperref"><span class="number">7.5 </span>Conclusion</a></h2>
<p>Being able to sign up users is a major milestone for our application.<span class="intersentencespace"></span> Although the sample app has yet to accomplish anything useful, we have laid an essential foundation for all future development.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>, we will complete our authentication machinery by allowing users to sign in and out of the application.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>, we will allow all users to update their account information, and will allow site administrators to delete users, thereby completing the full suite of the Users resource REST actions from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>.<span class="intersentencespace"></span> Finally, we’ll add authorization methods to our actions to enforce a site security model.</p>
</div>
<div id="_sec-signup_exercises" data-tralics-id="cid45" class="section" data-number="7.6"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_exercises" class="heading hyperref"><span class="number">7.6 </span>Exercises</a></h2>
<ol>
<li>Verify that the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gravatar_option" class="hyperref">Listing&nbsp;<span class="ref">7.30</span></a> allows the <code>gravatar_for</code> helper defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_gravatar_image" class="hyperref">Section&nbsp;<span class="ref">7.1.4</span></a> to take an optional <code>size</code> parameter, allowing code like <code>gravatar_for user, size: 40</code> in the view.
</li>
<li>Write tests for the error messages implemented in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-f_error_messages" class="hyperref">Listing&nbsp;<span class="ref">7.23</span></a>.<span class="intersentencespace"></span> A suggested start appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-error_messages_test" class="hyperref">Listing&nbsp;<span class="ref">7.31</span></a>.
</li>
<li>By writing the test first or by intentionally breaking and then fixing the application code, verify that the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-after_save_tests" class="hyperref">Listing&nbsp;<span class="ref">7.32</span></a> correctly specify the desired behavior after saving the user in the <code>create</code> action.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-after_save_tests" class="hyperref">Listing&nbsp;<span class="ref">7.32</span></a> uses the <code>have_selector</code> method introduced in the <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a> exercises (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_exercises" class="hyperref">Section&nbsp;<span class="ref">5.6</span></a>).<span class="intersentencespace"></span> In this case, we use <code>have_selector</code> to pick out particular CSS classes along with specific HTML tags.
</li>
<li>As noted before, the flash HTML in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_flash" class="hyperref">Listing&nbsp;<span class="ref">7.27</span></a> is ugly.<span class="intersentencespace"></span> Verify by running the test suite that the cleaner code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_flash_content_tag" class="hyperref">Listing&nbsp;<span class="ref">7.33</span></a>, which uses the Rails <code>content_tag</code> helper, also works.
</li></ol>
<div class="codelisting" id="_code-gravatar_option" data-tralics-id="uid590" data-number="7.30"><div class="heading"><span class="number">Listing 7.30:</span> 

<span class="description">Defining an optional <code>:size</code> parameter for the <code>gravatar_for</code> helper.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/users_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="p">})</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">?s=</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"gravatar"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-error_messages_test" data-tralics-id="uid591" data-number="7.31"><div class="heading"><span class="number">Listing 7.31:</span> 

<span class="description">Suggested error messages tests.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signup page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"signup"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"after submission"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign up'</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div></div></div><div class="codelisting" id="_code-after_save_tests" data-tralics-id="uid592" data-number="7.32"><div class="heading"><span class="number">Listing 7.32:</span> 

<span class="description">Tests for the post-save behavior in the <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre>    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"after saving the user"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">'user@example.com'</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-success'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Welcome'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div></div></div><div class="codelisting" id="_code-layout_flash_content_tag" data-tralics-id="uid593" data-number="7.33"><div class="heading"><span class="number">Listing 7.33:</span> 

<span class="description">The <code>flash</code> ERb in the site layout using <code>content_tag</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/application.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"alert alert-</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div></div>
<div id="cha-7_footnotes">
  <ol class="footnotes">
    <li id="_cha-7_footnote-1"><a href="http://gomockingbird.com/" target="_blank">Mockingbird</a> doesn’t support custom images like the profile photo in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_mockup_profile_name" class="hyperref">Figure&nbsp;<span class="ref">7.1</span></a>; I put that in by hand using <a href="http://www.adobe.com/products/fireworks/" target="_blank">Adobe Fireworks</a>.<span class="intersentencespace"></span>&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-1">↑</a></li>
    <li id="_cha-7_footnote-2">The hippo here is from <a href="http://www.flickr.com/photos/43803060@N00/24308857/" target="_blank">http://www.flickr.com/photos/43803060@N00/24308857/</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-2">↑</a></li>
    <li id="_cha-7_footnote-3">The Rails <code>debug</code> information is shown as <a href="http://www.yaml.org/" target="_blank">YAML</a> (a <a href="http://catb.org/jargon/html/R/recursive-acronym.html" target="_blank">recursive acronym</a> standing for “YAML Ain’t Markup Language”), which is a friendly data format designed to be both machine- <em>and</em> human-readable.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-3">↑</a></li>
    <li id="_cha-7_footnote-4">You can define your own custom environments as well; see the <a href="http://railscasts.com/episodes/72-adding-an-environment" target="_blank">RailsCast on adding an environment</a> for details.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-4">↑</a></li>
    <li id="_cha-7_footnote-5">This means that the <em>routing</em> works, but the corresponding pages don’t necessarily work at this point.<span class="intersentencespace"></span> For example, /users/1/edit gets routed properly to the <code>edit</code> action of the Users controller, but since the <code>edit</code> action doesn’t exist yet actually hitting that URL will return an error.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-5">↑</a></li>
    <li id="_cha-7_footnote-6">In Hinduism, an avatar is the manifestation of a deity in human or animal form.<span class="intersentencespace"></span> By extension, the term <em>avatar</em> is commonly used to mean some kind of personal representation, especially in a virtual environment.<span class="intersentencespace"></span> But you’ve seen the <a href="http://www.imdb.com/title/tt0499549/" target="_blank">movie</a>, so you already knew this.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-6">↑</a></li>
    <li id="_cha-7_footnote-7">If your application does need to handle custom images or other file uploads, I recommend <a href="https://github.com/thoughtbot/paperclip" target="_blank">Paperclip</a> or <a href="https://github.com/jnicklas/carrierwave" target="_blank">CarrierWave</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-7">↑</a></li>
    <li id="_cha-7_footnote-8">Weird, right?<span class="intersentencespace"></span> I don’t get it either.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-8">↑</a></li>
    <li id="_cha-7_footnote-9">I figured this out by looking up <code>pluralize</code> in the <a href="http://api.rubyonrails.org/v4.0.0/classes/ActionView/Helpers/TextHelper.html#method-i-pluralize" target="_blank">Rails API</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-9">↑</a></li>
    <li id="_cha-7_footnote-10">Actually, we’ll use the closely related <code>flash.now</code>, but we’ll defer that subtlety until we need it.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-10">↑</a></li>
    <li id="_cha-7_footnote-11">Technically, SSL is now TLS, for Transport Layer Security, but everyone I know still says “SSL”.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-7_footnote-ref-11">↑</a></li>
  </ol>
</div><div id="_cha-sign_in_sign_out" data-tralics-id="cid46" class="chapter" data-number="8"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="heading hyperref"><span class="number">Chapter 8 </span>Sign in, sign out</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>Now that new users can sign up for our site (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>), it’s time to give registered users the ability to sign in and sign out.<span class="intersentencespace"></span> This will allow us to add customizations based on signin status and based on the identity of the current user.<span class="intersentencespace"></span> For example, in this chapter we’ll update the site header with signin/signout links and a profile link.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a>, we’ll use the identity of a signed-in user to create microposts associated with that user, and in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a> we’ll allow the current user to follow other users of the application (thereby receiving a feed of their microposts).</p>
<p>Having users sign in will also allow us to implement a security model, restricting access to particular pages based on the identity of the signed-in user.<span class="intersentencespace"></span> For instance, as we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>, only signed-in users will be able to access the page used to edit user information.<span class="intersentencespace"></span> The signin system will also make possible special privileges for administrative users, such as the ability (also introduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>) to delete users from the database.</p>
<p>After implementing the core authentication machinery, we’ll take a short detour to investigate <em>Cucumber</em>, a popular system for behavior-driven development (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-cucumber" class="hyperref">Section&nbsp;<span class="ref">8.3</span></a>).<span class="intersentencespace"></span> In particular, we’ll re-implement a couple of the RSpec integration tests in Cucumber to see how the two methods compare.</p>
<p>As in previous chapters, we’ll do our work on a topic branch and merge in the changes at the end:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b sign-in-out
</pre></div></div>
</div>
<div id="_sec-signin_failure" data-tralics-id="cid47" class="section" data-number="8.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_failure" class="heading hyperref"><span class="number">8.1 </span>Sessions and signin failure</a></h2>
<p>A <a href="http://en.wikipedia.org/wiki/Session_(computer_science)" target="_blank"><em>session</em></a> is a semi-permanent connection between two computers, such as a client computer running a web browser and a server running Rails.<span class="intersentencespace"></span> We’ll be using sessions to implement the common pattern of “signing in”, and in this context there are several different models for session behavior common on the web: “forgetting” the session on browser close, using an optional “remember me” checkbox for persistent sessions, and automatically remembering sessions until the user explicitly signs out.<sup id="_cha-8_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-1">1</a></sup><span class="intersentencespace"></span> We’ll opt for the final of these options: when users sign in, we will remember their signin status “forever”, clearing the session only when the user explicitly signs out.<span class="intersentencespace"></span> (We’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a> just how long “forever” is.)</p>
<p>It’s convenient to model sessions as a RESTful resource: we’ll have a signin page for <em>new</em> sessions, signing in will <em>create</em> a session, and signing out will <em>destroy</em> it.<span class="intersentencespace"></span> Unlike the Users resource, which uses a database back-end (via the User model) to persist data, the Sessions resource will use a <a href="http://en.wikipedia.org/wiki/HTTP_cookie" target="_blank"><em>cookie</em></a>, which is a small piece of text placed on the user’s browser.<span class="intersentencespace"></span> Much of the work involved in signin comes from building this cookie-based authentication machinery.<span class="intersentencespace"></span> In this section and the next, we’ll prepare for this work by constructing a Sessions controller, a signin form, and the relevant controller actions.<span class="intersentencespace"></span> We’ll then complete user signin in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_success" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a> by adding the necessary cookie-manipulation code.</p>
<div id="_sec-sessions_controller" data-tralics-id="uid595" class="subsection" data-number="8.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sessions_controller" class="heading hyperref"><span class="number">8.1.1 </span>Sessions controller</a></h3>
<p>The elements of signing in and out correspond to particular REST actions of the Sessions controller: the signin form is handled by the <code>new</code> action (covered in this section), actually signing in is handled by sending a <span class="tt">POST</span> request to the <code>create</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_failure" class="hyperref">Section&nbsp;<span class="ref">8.1</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_success" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a>), and signing out is handled by sending a <span class="tt">DELETE</span> request to the <code>destroy</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signing_out" class="hyperref">Section&nbsp;<span class="ref">8.2.6</span></a>).<span class="intersentencespace"></span> (Recall the association of HTTP verbs with REST actions from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>.)<span class="intersentencespace"></span> To get started, we’ll generate a Sessions controller and an integration test for the authentication machinery:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions --no-test-framework
<span class="gp">$</span> rails generate integration_test authentication_pages
</pre></div></div>
<p>Following the model from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_form" class="hyperref">Section&nbsp;<span class="ref">7.2</span></a> for the signup page, we’ll create a signin form for creating new sessions, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.1</span></a>.</p>
<div class="center figure" id="_fig-signin_mockup" data-tralics-id="uid596" data-number="8.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signin_mockup_bootstrap.png" alt="images/figures/signin_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 8.1: </span><span class="description">A mockup of the signin form.
</span></div></div>
<p>The signin page will live at the URL given by <code>signin_path</code> (defined momentarily), and as usual we’ll start with a minimalist test, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_session_tests" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a>.<span class="intersentencespace"></span> (Compare to the analogous code for the signup page in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_signup_test" class="hyperref">Listing&nbsp;<span class="ref">7.6</span></a>.)</p>
<div class="codelisting" id="_code-new_session_tests" data-tralics-id="uid597" data-number="8.1"><div class="heading"><span class="number">Listing 8.1:</span> 

<span class="description">Tests for the <code>new</code> session action and view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"signin page"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The tests initially fail, as required:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>To get the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_session_tests" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a> to pass, we first need to define routes for the Sessions resource, together with a custom named route for the signin page (which we’ll map to the Session controller’s <code>new</code> action).<span class="intersentencespace"></span> As with the Users resource, we can use the <code>resources</code> method to define the standard RESTful routes:</p>
<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</pre></div></div>
<p>Since we have no need to show or edit sessions, we’ve restricted the actions to <code>new</code>, <code>create</code>, and <code>destroy</code> using the <code>:only</code> option accepted by <code>resources</code>.<span class="intersentencespace"></span> The full result, including named routes for signin and signout, appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a>.</p>
<div class="codelisting" id="_code-sessions_resource" data-tralics-id="uid598" data-number="8.2"><div class="heading"><span class="number">Listing 8.2:</span> 

<span class="description">Adding a resource to get the standard RESTful actions for sessions.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">root</span>  <span class="s1">'static_pages#home'</span>
  <span class="n">match</span> <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'users#new'</span><span class="p">,</span>            <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/signin'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#new'</span><span class="p">,</span>         <span class="ss">via</span><span class="p">:</span> <span class="s1">'get'</span>
  <span class="n">match</span> <span class="s1">'/signout'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#destroy'</span><span class="p">,</span>     <span class="ss">via</span><span class="p">:</span> <span class="s1">'delete'</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note the use of <code>via: ’delete’</code> for the signout route, which indicates that it should be invoked using an HTTP <span class="tt">DELETE</span> request.</p>
<p>The resources defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a> provide URLs and actions similar to those for users (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>), as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_sessions" class="hyperref">Table&nbsp;<span class="ref">8.1</span></a>.<span class="intersentencespace"></span> Note that the routes for signin and signout are custom, but the route for creating a session is simply the default (i.e., <code>[resource name]_path</code>).</p>
<div class="table" id="_table-RESTful_sessions" data-tralics-id="uid599" data-number="8.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Named route</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/signin</td>
<td class="align_left"><code>signin_path</code></td>
<td class="align_left"><code>new</code></td>
<td class="align_left">page for a new session (signin)</td>
</tr><tr><td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/sessions</td>
<td class="align_left"><code>sessions_path</code></td>
<td class="align_left"><code>create</code></td>
<td class="align_left">create a new session</td>
</tr><tr><td class="align_left"><span class="tt">DELETE</span></td>
<td class="align_left">/signout</td>
<td class="align_left"><code>signout_path</code></td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left">delete a session (sign out)</td>
</tr></tbody></table><div class="caption"><span class="header">Table 8.1: </span><span class="description">RESTful routes provided by the sessions rules in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a>.
</span></div></div>
<p>By the way, if you ever want a complete list of the routes for your application, you can use the <code>rake routes</code> command to have Rails generate it for you:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake routes
<span class="go">        Prefix Verb   URI Pattern                    Controller#Action</span>
<span class="go">         users GET    /users(.:format)               users#index</span>
<span class="go">               POST   /users(.:format)               users#create</span>
<span class="go">      new_user GET    /users/new(.:format)           users#new</span>
<span class="go">     edit_user GET    /users/:id/edit(.:format)      users#edit</span>
<span class="go">          user GET    /users/:id(.:format)           users#show</span>
<span class="go">               PATCH  /users/:id(.:format)           users#update</span>
<span class="go">               PUT    /users/:id(.:format)           users#update</span>
<span class="go">               DELETE /users/:id(.:format)           users#destroy</span>
<span class="go">      sessions POST   /sessions(.:format)            sessions#create</span>
<span class="go">   new_session GET    /sessions/new(.:format)        sessions#new</span>
<span class="go">       session DELETE /sessions/:id(.:format)        sessions#destroy</span>
<span class="go">          root GET    /                              static_pages#home</span>
<span class="go">        signup GET    /signup(.:format)              users#new</span>
<span class="go">        signin GET    /signin(.:format)              sessions#new</span>
<span class="go">       signout DELETE /signout(.:format)             sessions#destroy</span>
<span class="go">          help GET    /help(.:format)                static_pages#help</span>
<span class="go">         about GET    /about(.:format)               static_pages#about</span>
<span class="go">       contact GET    /contact(.:format)             static_pages#contact</span>
</pre></div></div>
<p>The next step to get the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_session_tests" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a> to pass is to add a <code>new</code> action to the Sessions controller, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_session_title" class="hyperref">Listing&nbsp;<span class="ref">8.3</span></a> (which also defines the <code>create</code> and <code>destroy</code> actions for future reference).</p>
<div class="codelisting" id="_code-new_session_title" data-tralics-id="uid600" data-number="8.3"><div class="heading"><span class="number">Listing 8.3:</span> 

<span class="description">The initial Sessions controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The final step is to define the initial version of the signin page.<span class="intersentencespace"></span> Note that, since it is the page for a new session, the signin page lives in the file <code>app/views/sessions/new.html.erb</code>, which we have to create.<span class="intersentencespace"></span> The contents, which for now only define the page title and top-level heading, appear as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_signin_page" class="hyperref">Listing&nbsp;<span class="ref">8.4</span></a>.</p>
<div class="codelisting" id="_code-initial_signin_page" data-tralics-id="uid601" data-number="8.4"><div class="heading"><span class="number">Listing 8.4:</span> 

<span class="description">The initial signin view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Sign in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>
</pre></div></div></div><p>With that, the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_session_tests" class="hyperref">Listing&nbsp;<span class="ref">8.1</span></a> should be passing, and we’re ready to make the actual signin form.</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-signin_tests" data-tralics-id="uid602" class="subsection" data-number="8.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_tests" class="heading hyperref"><span class="number">8.1.2 </span>Signin tests</a></h3>
<p>Comparing <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.1</span></a> with <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_mockup" class="hyperref">Figure&nbsp;<span class="ref">7.11</span></a>, we see that the signin form (or, equivalently, the new session form) is similar in appearance to the signup form, except with two fields (email and password) in place of four.<span class="intersentencespace"></span> As with the signup form, we can test the signin form by using Capybara to fill in the form values and then click the button.</p>
<p>In the process of writing the tests, we’ll be forced to design aspects of the application, which is one of the nice side-effects of test-driven development.<span class="intersentencespace"></span> We’ll start with invalid signin, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_failure_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.2</span></a>.</p>
<div class="center figure" id="_fig-signin_failure_mockup" data-tralics-id="uid603" data-number="8.2">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signin_failure_mockup_bootstrap.png" alt="images/figures/signin_failure_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 8.2: </span><span class="description">A mockup of signin failure.
</span></div></div>
<p>As seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_failure_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.2</span></a>, when the signin information is invalid we want to re-render the signin page and display an error message.<span class="intersentencespace"></span> We’ll render the error as a flash message, which we can test for as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>This uses the Capybara method <code>have_selector</code> seen before in the solutions to two exercises, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-contact_test_have_selector" class="hyperref">Listing&nbsp;<span class="ref">5.38</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-after_save_tests" class="hyperref">Listing&nbsp;<span class="ref">7.32</span></a>.<span class="intersentencespace"></span> The <code>have_selector</code> method checks for a particular selector element (i.e., an HTML tag, though as of Capybara&nbsp;2.0 it only works for <em>visible</em> elements).<span class="intersentencespace"></span> In this case, we’re looking for</p>
<div class="code"><div class="highlight"><pre><span class="n">div</span><span class="o">.</span><span class="n">alert</span><span class="o">.</span><span class="n">alert</span><span class="o">-</span><span class="n">error</span>
</pre></div></div>
<p>which checks for a <code>div</code> tag.<span class="intersentencespace"></span> In particular, recalling that the dot means “class” in CSS (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="hyperref">Section&nbsp;<span class="ref">5.1.2</span></a>), you might be able to guess that this tests for a <code>div</code> tag with the classes <code>"alert"</code> and <code>"alert-error"</code>, like so:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-error"</span><span class="nt">&gt;</span>Invalid...<span class="nt">&lt;/div&gt;</span>
</pre></div></div>
<p>Combining the title and flash tests gives the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_failing_signin_test" class="hyperref">Listing&nbsp;<span class="ref">8.5</span></a>.<span class="intersentencespace"></span> As we’ll see, these tests miss an important subtlety, which we’ll address in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rendering_with_a_flash_message" class="hyperref">Section&nbsp;<span class="ref">8.1.5</span></a>.</p>
<div class="codelisting" id="_code-initial_failing_signin_test" data-tralics-id="uid604" data-number="8.5"><div class="heading"><span class="number">Listing 8.5:</span> 

<span class="description">The tests for signin failure.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Sign in"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Having written tests for signin failure, we now turn to signin success.<span class="intersentencespace"></span> The changes we’ll test for are the rendering of the user’s profile page (as determined by the page title, which should be the user’s name), together with three planned changes to the site navigation:</p>
<ol>
<li>The appearance of a link to the profile page
</li>
<li>The appearance of a “Sign out” link
</li>
<li>The disappearance of the “Sign in” link
</li></ol>
<p>(We’ll defer the test for the “Settings” link to <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_users" class="hyperref">Section&nbsp;<span class="ref">9.1</span></a> and for the “Users” link to <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_all_users" class="hyperref">Section&nbsp;<span class="ref">9.3</span></a>.)<span class="intersentencespace"></span> A mockup of these changes appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_success_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.3</span></a>.<sup id="_cha-8_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-2">2</a></sup><span class="intersentencespace"></span> Note that the signout and profile links appear in a dropdown “Account” menu; in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-changing_the_layout_links" class="hyperref">Section&nbsp;<span class="ref">8.2.4</span></a>, we’ll see how to make such a menu with Bootstrap.</p>
<div class="center figure" id="_fig-signin_success_mockup" data-tralics-id="uid609" data-number="8.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signin_success_mockup_bootstrap.png" alt="images/figures/signin_success_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 8.3: </span><span class="description">A mockup of the user profile after a successful signin.
</span></div></div>
<p>The test code for signin success appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_success_tests" class="hyperref">Listing&nbsp;<span class="ref">8.6</span></a>.</p>
<div class="codelisting" id="_code-signin_success_tests" data-tralics-id="uid610" data-number="8.6"><div class="heading"><span class="number">Listing 8.6:</span> 

<span class="description">Test for signin success.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">"Sign in"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span>     <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we’ve introduced Capybara’s <code>have_link</code> method.<span class="intersentencespace"></span> It takes as arguments the text of the link and an optional <code>:href</code> parameter, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div></div>
<p>ensures that the anchor tag&nbsp;<code>a</code> has the right <code>href</code> (URL) attribute—in this case, a link to the user’s profile page.<span class="intersentencespace"></span> Note also that we take care to <code>upcase</code> the user’s email address to make sure our ability to find the user in the database is case-insensitive.</p>
</div>
<div id="_sec-signin_form" data-tralics-id="uid611" class="subsection" data-number="8.1.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_form" class="heading hyperref"><span class="number">8.1.3 </span>Signin form</a></h3>
<p>With our tests in place, we’re ready to start developing the signin form.<span class="intersentencespace"></span> Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a> that the signup form uses the <code>form_for</code> helper, taking as an argument the user instance variable <code>@user</code>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The main difference between this and the signup form is that we have no Session model, and hence no analogue for the <code>@user</code> variable.<span class="intersentencespace"></span> This means that, in constructing the new session form, we have to give <code>form_for</code> slightly more information; in particular, whereas</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div></div>
<p>allows Rails to infer that the <code>action</code> of the form should be to <span class="tt">POST</span> to the URL /users, in the case of sessions we need to indicate the <em>name</em> of the resource and the corresponding URL:</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">sessions_path</span><span class="p">)</span>
</pre></div></div>
<p>(A second option is to use <code>form_tag</code> in place of <code>form_for</code>; this might be even more idiomatically correct Rails, but it has less in common with the signup form, and at this stage I want to emphasize the parallel structure.<span class="intersentencespace"></span> Making a working form with <code>form_tag</code> is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sign_in_out_exercises" class="hyperref">Section&nbsp;<span class="ref">8.5</span></a>).)</p>
<p>With the proper <code>form_for</code> in hand, it’s easy to make a signin form to match the mockup in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.1</span></a> using the signup form (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a>) as a model, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_form" class="hyperref">Listing&nbsp;<span class="ref">8.7</span></a>.</p>
<div class="codelisting" id="_code-signin_form" data-tralics-id="uid612" data-number="8.7"><div class="heading"><span class="number">Listing 8.7:</span> 

<span class="description">Code for the signin form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Sign in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">sessions_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Note that we’ve added a link to the signup page for convenience.<span class="intersentencespace"></span> With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_form" class="hyperref">Listing&nbsp;<span class="ref">8.7</span></a>, the signin form appears as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_form" class="hyperref">Figure&nbsp;<span class="ref">8.4</span></a>.</p>
<div class="center figure" id="_fig-signin_form" data-tralics-id="uid613" data-number="8.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signin_form_bootstrap.png" alt="images/figures/signin_form_bootstrap"></div><div class="caption"><span class="header">Figure 8.4: </span><span class="description">The signin form (<a href="http://localhost:3000/signin" target="_blank">/signin</a>).
</span></div></div>
<p>Though you’ll soon get out of the habit of looking at the HTML generated by Rails (instead trusting the helpers to do their job), for now let’s take a look at it (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_form_html" class="hyperref">Listing&nbsp;<span class="ref">8.8</span></a>).</p>
<div class="codelisting" id="_code-signin_form_html" data-tralics-id="uid614" data-number="8.8"><div class="heading"><span class="number">Listing 8.8:</span> 

<span class="description">HTML for the signin form produced by <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_form" class="hyperref">Listing&nbsp;<span class="ref">8.7</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/sessions"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"session_email"</span> <span class="na">name=</span><span class="s">"session[email]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"session_password"</span> <span class="na">name=</span><span class="s">"session[password]"</span>
           <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-large btn-primary"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span>
       <span class="na">value=</span><span class="s">"Sign in"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div><p>Comparing <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_form_html" class="hyperref">Listing&nbsp;<span class="ref">8.8</span></a> with <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form_html" class="hyperref">Listing&nbsp;<span class="ref">7.20</span></a>, you might be able to guess that submitting this form will result in a <code>params</code> hash where <code>params[:session][:email]</code> and <code>params[:session][:password]</code> correspond to the email and password fields.</p>
</div>
<div id="_sec-reviewing_form_submission" data-tralics-id="uid615" class="subsection" data-number="8.1.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-reviewing_form_submission" class="heading hyperref"><span class="number">8.1.4 </span>Reviewing form submission</a></h3>
<p>As in the case of creating users (signup), the first step in creating sessions (signin) is to handle <em>invalid</em> input.<span class="intersentencespace"></span> We already have tests for the signup failure (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_failing_signin_test" class="hyperref">Listing&nbsp;<span class="ref">8.5</span></a>), and the application code is simple apart from a couple of subtleties.<span class="intersentencespace"></span> We’ll start by reviewing what happens when a form gets submitted, and then arrange for helpful error messages to appear in the case of signin failure (as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_failure_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.2</span></a>.)<span class="intersentencespace"></span> Then we’ll lay the foundation for successful signin (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_success" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a>) by evaluating each signin submission based on the validity of its email/password combination.</p>
<p>Let’s start by defining a minimalist <code>create</code> action for the Sessions controller (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_create_session" class="hyperref">Listing&nbsp;<span class="ref">8.9</span></a>), which does nothing but render the <code>new</code> view.<span class="intersentencespace"></span> Submitting the <a href="http://localhost:3000/sessions/new" target="_blank">/sessions/new</a> form with blank fields then yields the result shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-initial_failed_signin_rails_3" class="hyperref">Figure&nbsp;<span class="ref">8.5</span></a>.</p>
<div class="codelisting" id="_code-initial_create_session" data-tralics-id="uid616" data-number="8.9"><div class="heading"><span class="number">Listing 8.9:</span> 

<span class="description">A preliminary version of the Sessions <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">render</span> <span class="s1">'new'</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="center figure" id="_fig-initial_failed_signin_rails_3" data-tralics-id="uid617" data-number="8.5">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/initial_failed_signin_rails_3_bootstrap.png" alt="images/figures/initial_failed_signin_rails_3_bootstrap"></div><div class="caption"><span class="header">Figure 8.5: </span><span class="description">The initial failed signin, with <code>create</code> as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_create_session" class="hyperref">Listing&nbsp;<span class="ref">8.9</span></a>.
</span></div></div>
<p>Carefully inspecting the debug information in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-initial_failed_signin_rails_3" class="hyperref">Figure&nbsp;<span class="ref">8.5</span></a> shows that, as hinted at the end of <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_form" class="hyperref">Section&nbsp;<span class="ref">8.1.3</span></a>, the submission results in a <code>params</code> hash containing the email and password under the key <code>:session</code>:</p>
<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">''</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">''</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sign in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div></div>
<p>As with the case of user signup (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signup_failure" class="hyperref">Figure&nbsp;<span class="ref">7.15</span></a>) these parameters form a <em>nested</em> hash like the one we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-nested_hashes" class="hyperref">Listing&nbsp;<span class="ref">4.6</span></a>.<span class="intersentencespace"></span> In particular, <code>params</code> contains a nested hash of the form</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span> <span class="p">}</span>
</pre></div></div>
<p>This means that</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div></div>
<p>is itself a hash:</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span>
</pre></div></div>
<p>As a result,</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div></div>
<p>is the submitted email address and</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div></div>
<p>is the submitted password.</p>
<p>In other words, inside the <code>create</code> action the <code>params</code> hash has all the information needed to authenticate users by email and password.<span class="intersentencespace"></span> Not coincidentally, we already have exactly the methods we need: the <code>User.find_by</code> method provided by Active Record (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>) and the <code>authenticate</code> method provided by <code>has_secure_password</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_authentication" class="hyperref">Section&nbsp;<span class="ref">6.3.3</span></a>).<span class="intersentencespace"></span> Recalling that <code>authenticate</code> returns <code>false</code> for an invalid authentication, our strategy for user signin can be summarized as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># Sign the user in and redirect to the user's show page.</span>
  <span class="k">else</span>
    <span class="c1"># Create an error message and re-render the signin form.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>The first line here pulls the user out of the database using the submitted email address.<span class="intersentencespace"></span> (Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-uniqueness_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.5</span></a> that email addresses are saved as all lower-case, so here we use the <code>downcase</code> method to ensure a match when the submitted address is valid.)<span class="intersentencespace"></span> The next line can be a bit confusing but is fairly common in idiomatic Rails programming:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>This uses <code>&amp;&amp;</code> (logical <em>and</em>) to determine if the resulting user is valid.<span class="intersentencespace"></span> Taking into account that any object other than <code>nil</code> and <code>false</code> itself is <code>true</code> in a boolean context (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-objects_and_message_passing" class="hyperref">Section&nbsp;<span class="ref">4.2.3</span></a>), the possibilities appear as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-user_and_and" class="hyperref">Table&nbsp;<span class="ref">8.2</span></a>.<span class="intersentencespace"></span> We see from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-user_and_and" class="hyperref">Table&nbsp;<span class="ref">8.2</span></a> that the <code>if</code> statement is <code>true</code> only if a user with the given email both exists in the database and has the given password, exactly as required.</p>
<div class="table" id="_table-user_and_and" data-tralics-id="uid618" data-number="8.2"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>User</strong></td>
<td class="align_left"><strong>Password</strong></td>
<td class="align_left"><strong>a &amp;&amp; b</strong></td>
</tr><tr><td class="align_left">nonexistent</td>
<td class="align_left"><em>anything</em></td>
<td class="align_left"><code>nil &amp;&amp; [anything] == false</code></td>
</tr><tr><td class="align_left">valid user</td>
<td class="align_left">wrong password</td>
<td class="align_left"><code>true &amp;&amp; false == false</code></td>
</tr><tr><td class="align_left">valid user</td>
<td class="align_left">right password</td>
<td class="align_left"><code>true &amp;&amp; true == true</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 8.2: </span><span class="description">Possible results of <code>user &amp;&amp; user.authenticate(…)</code>.
</span></div></div>
</div>
<div id="_sec-rendering_with_a_flash_message" data-tralics-id="uid619" class="subsection" data-number="8.1.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rendering_with_a_flash_message" class="heading hyperref"><span class="number">8.1.5 </span>Rendering with a flash message</a></h3>
<p>Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_error_messages" class="hyperref">Section&nbsp;<span class="ref">7.3.3</span></a> that we displayed signup errors using the User model error messages.<span class="intersentencespace"></span> These errors are associated with a particular Active Record object, but this strategy won’t work here because the session isn’t an Active Record model.<span class="intersentencespace"></span> Instead, we’ll put a message in the flash to be displayed upon failed signin.<span class="intersentencespace"></span> A first, slightly incorrect, attempt appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-failed_signin_attempt" class="hyperref">Listing&nbsp;<span class="ref">8.10</span></a>.</p>
<div class="codelisting" id="_code-failed_signin_attempt" data-tralics-id="uid620" data-number="8.10"><div class="heading"><span class="number">Listing 8.10:</span> 

<span class="description">An (unsuccessful) attempt at handling failed signin.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Sign the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span> <span class="c1"># Not quite right!</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Because of the flash message display in the site layout (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_flash" class="hyperref">Listing&nbsp;<span class="ref">7.27</span></a>), the <code>flash[:error]</code> message automatically gets displayed; because of the Bootstrap CSS, it automatically gets nice styling (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-failed_signin_flash" class="hyperref">Figure&nbsp;<span class="ref">8.6</span></a>).</p>
<div class="center figure" id="_fig-failed_signin_flash" data-tralics-id="uid621" data-number="8.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/failed_signin_flash_bootstrap.png" alt="images/figures/failed_signin_flash_bootstrap"></div><div class="caption"><span class="header">Figure 8.6: </span><span class="description">The flash message for a failed signin.
</span></div></div>
<p>Unfortunately, as noted in the text and in the comment in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-failed_signin_attempt" class="hyperref">Listing&nbsp;<span class="ref">8.10</span></a>, this code isn’t quite right.<span class="intersentencespace"></span> The page looks fine, though, so what’s the problem?<span class="intersentencespace"></span> The issue is that the contents of the flash persist for one <em>request</em>, but—unlike a redirect, which we used in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_flash" class="hyperref">Listing&nbsp;<span class="ref">7.28</span></a>—re-rendering a template with <code>render</code> doesn’t count as a request.<span class="intersentencespace"></span> The result is that the flash message persists one request longer than we want.<span class="intersentencespace"></span> For example, if we submit invalid information, the flash is set and gets displayed on the signin page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-failed_signin_flash" class="hyperref">Figure&nbsp;<span class="ref">8.6</span></a>); if we then click on another page, such as the Home page, that’s the first request since the form submission, and the flash gets displayed again (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-flash_persistence" class="hyperref">Figure&nbsp;<span class="ref">8.7</span></a>).</p>
<div class="center figure" id="_fig-flash_persistence" data-tralics-id="uid622" data-number="8.7">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/flash_persistence_bootstrap.png" alt="images/figures/flash_persistence_bootstrap"></div><div class="caption"><span class="header">Figure 8.7: </span><span class="description">An example of the flash persisting.
</span></div></div>
<p>This flash persistence is a bug in our application, and before proceeding with a fix it is a good idea to write a test catching the error.<span class="intersentencespace"></span> In particular, the signin failure tests are currently passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"signin with invalid information"</span>
</pre></div></div>
<p>But the tests should never pass when there is a known bug, so we should add a failing test to catch it.<span class="intersentencespace"></span> Fortunately, dealing with a problem like flash persistence is one of many areas where integration tests really shine; they let us say exactly what we mean:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"after visiting another page"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"Home"</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>After submitting invalid signin data, this test follows the Home link in the site layout and then requires that the flash error message not appear.<span class="intersentencespace"></span> The updated code, with the modified flash test, is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-correct_signin_failure_test" class="hyperref">Listing&nbsp;<span class="ref">8.11</span></a>.</p>
<div class="codelisting" id="_code-correct_signin_failure_test" data-tralics-id="uid623" data-number="8.11"><div class="heading"><span class="number">Listing 8.11:</span> 

<span class="description">Correct tests for signin failure.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Sign in"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"after visiting another page"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"Home"</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The new test fails, as required:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"signin with invalid information"</span>
</pre></div></div>
<p>To get the failing test to pass, instead of <code>flash</code> we use <code>flash.now</code>, which is specifically designed for displaying flash messages on rendered pages; unlike the contents of <code>flash</code>, its contents disappear as soon as there is an additional request.<span class="intersentencespace"></span> The corrected application code appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-correct_signin_failure" class="hyperref">Listing&nbsp;<span class="ref">8.12</span></a>.</p>
<div class="codelisting" id="_code-correct_signin_failure" data-tralics-id="uid624" data-number="8.12"><div class="heading"><span class="number">Listing 8.12:</span> 

<span class="description">Correct code for failed signin.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Sign the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Now the test suite for users with invalid information should be green:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">"with invalid information"</span>
</pre></div></div>
</div></div>
<div id="_sec-signin_success" data-tralics-id="cid48" class="section" data-number="8.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_success" class="heading hyperref"><span class="number">8.2 </span>Signin success</a></h2>
<p>Having handled a failed signin, we now need to actually sign a user in.<span class="intersentencespace"></span> Getting there will require some of the most challenging Ruby programming so far in this tutorial, so hang in there through the end and be prepared for a little heavy lifting.<span class="intersentencespace"></span> Happily, the first step is easy—completing the Sessions controller <code>create</code> action is a snap.<span class="intersentencespace"></span> Unfortunately, it’s also a cheat.</p>
<p>Filling in the area now occupied by the signin comment (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-correct_signin_failure" class="hyperref">Listing&nbsp;<span class="ref">8.12</span></a>) is simple: upon successful signin, we sign the user in using the <code>sign_in</code> function, and then redirect to the profile page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_success_not_yet_working" class="hyperref">Listing&nbsp;<span class="ref">8.13</span></a>).<span class="intersentencespace"></span> We see now why this is a cheat: alas, <code>sign_in</code> doesn’t currently exist.<span class="intersentencespace"></span> Writing it will occupy the rest of this section.</p>
<div class="codelisting" id="_code-sign_in_success_not_yet_working" data-tralics-id="uid625" data-number="8.13"><div class="heading"><span class="number">Listing 8.13:</span> 

<span class="description">The completed Sessions controller <code>create</code> action (not yet working).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div>
<div id="_sec-remember_me" data-tralics-id="uid626" class="subsection" data-number="8.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="heading hyperref"><span class="number">8.2.1 </span>Remember me</a></h3>
<p>We’re now in a position to start implementing our signin model, namely, remembering user signin status “forever” and ending the session only when the user explicitly signs out.<span class="intersentencespace"></span> The signin functions themselves will end up crossing the traditional Model-View-Controller lines; in particular, several signin functions will need to be available in both controllers and views.<span class="intersentencespace"></span> You may recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-back_to_the_title_helper" class="hyperref">Section&nbsp;<span class="ref">4.2.5</span></a> that Ruby provides a <em>module</em> facility for packaging functions together and including them in multiple places, and that’s the plan for the authentication functions.<span class="intersentencespace"></span> We could make an entirely new module for authentication, but the Sessions controller already comes equipped with a module, namely, <code>SessionsHelper</code>.<span class="intersentencespace"></span> Moreover, such helpers are automatically included in Rails views, so all we need to do to use the Sessions helper functions in controllers is to include the module into the Application controller (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_helper_include" class="hyperref">Listing&nbsp;<span class="ref">8.14</span></a>).</p>
<div class="codelisting" id="_code-sessions_helper_include" data-tralics-id="uid627" data-number="8.14"><div class="heading"><span class="number">Listing 8.14:</span> 

<span class="description">Including the Sessions helper module into the Application controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/application_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>
<span class="k">end</span>
</pre></div></div></div><p>By default, all the helpers are available in the views but not in the controllers.<span class="intersentencespace"></span> We need the methods from the Sessions helper in both places, so we have to include it explicitly.</p>
<p>Because HTTP is a <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state" target="_blank"><em>stateless protocol</em></a>, web applications requiring user signin must implement a way to track each user’s progress from page to page.<span class="intersentencespace"></span> One technique for maintaining the user signin status is to use a traditional Rails session (via the special <code>session</code> function) to store a <em>remember token</em> equal to the user’s id:</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>This <code>session</code> object makes the user id available from page to page by storing it in a cookie that expires upon browser close.<span class="intersentencespace"></span> On each page, the application could simply call</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>to retrieve the user.<span class="intersentencespace"></span> Because of the way Rails handles sessions, this process is secure; if a malicious user tries to spoof the user id, Rails will detect a mismatch based on a special <em>session id</em> generated for each session.</p>
<p>For our application’s design choice, which involves <em>persistent</em> sessions—that is, signin status that lasts even after browser close—we need to use a <em>permanent</em> identifier for the signed-in user.<span class="intersentencespace"></span> To accomplish this, we’ll generate a unique, secure remember token for each user and store it as a <em>permanent</em> cookie rather than one that expires on browser close.</p>
<p>The remember token needs to be associated with a user and stored for future use, so we’ll add it as an attribute to the User model, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_model_remember_token" class="hyperref">Figure&nbsp;<span class="ref">8.8</span></a>.</p>
<div class="center figure" id="_fig-user_model_remember_token" data-tralics-id="uid628" data-number="8.8"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_model_remember_token_31.png" alt="user_model_remember_token_31"></span>
<div class="caption"><span class="header">Figure 8.8: </span><span class="description">The User model with an added <code>remember_token</code> attribute.
</span></div></div>
<p>We’ll start with a small addition to the User model specs (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_responds_to_remember_token" class="hyperref">Listing&nbsp;<span class="ref">8.15</span></a>).</p>
<div class="codelisting" id="_code-user_responds_to_remember_token" data-tralics-id="uid629" data-number="8.15"><div class="heading"><span class="number">Listing 8.15:</span> 

<span class="description">A first test for the remember token.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>We can get this test to pass by generating a remember token at the command line:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_token_to_users
</pre></div></div>
<p>Next we fill in the resulting migration with the code from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-add_remember_token_to_users" class="hyperref">Listing&nbsp;<span class="ref">8.16</span></a>.<span class="intersentencespace"></span> Note that, because we expect to retrieve users by remember token, we’ve added an index (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-database_indices" class="hyperref">Box&nbsp;<span class="ref">6.2</span></a>) to the <code>remember_token</code> column.</p>
<div class="codelisting" id="_code-add_remember_token_to_users" data-tralics-id="uid630" data-number="8.16"><div class="heading"><span class="number">Listing 8.16:</span> 

<span class="description">A migration to add a <code>remember_token</code> to the <code>users</code> table.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[ts]_add_remember_token_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberTokenToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Next we update the development and test databases as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>At this point the User model specs should be passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div></div>
<p>Now we have to decide what to use as a remember token.<span class="intersentencespace"></span> There are many mostly equivalent possibilities—essentially, any large random string will do just fine, as long as it’s unique.<span class="intersentencespace"></span> The <code>urlsafe_base64</code> method from the <code>SecureRandom</code> module in the Ruby standard library fits the bill:<sup id="_cha-8_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-3">3</a></sup> it returns a random string of length 16 composed of the characters A–Z, a–z, 0–9, “-”, and “_” (for a total of 64 possibilities, thus “<a href="http://en.wikipedia.org/wiki/Base64" target="_blank">base64</a>”).<span class="intersentencespace"></span> This means that the probability of two remember tokens colliding is a negligibly small <span class="inline_math"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-1-Frame"><nobr><span class="math" id="MathJax-Span-1" role="math" style="width: 10.913em; display: inline-block;"><span style="display: inline-block; position: relative; width: 9.812em; height: 0px; font-size: 111%;"><span style="position: absolute; clip: rect(1.704em 1000.003em 3.106em -999.997em); top: -2.7em; left: 0.003em;"><span class="mrow" id="MathJax-Span-2"><span class="mn" id="MathJax-Span-3" style="font-family: MathJax_Main;">1</span><span class="texatom" id="MathJax-Span-4"><span class="mrow" id="MathJax-Span-5"><span class="mo" id="MathJax-Span-6" style="font-family: MathJax_Main;">/</span></span></span><span class="msubsup" id="MathJax-Span-7"><span style="display: inline-block; position: relative; width: 1.804em; height: 0px;"><span style="position: absolute; clip: rect(3.156em 1000.003em 4.157em -999.997em); top: -4.002em; left: 0.003em;"><span class="mn" id="MathJax-Span-8" style="font-family: MathJax_Main;">64</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -4.402em; left: 1.004em;"><span class="texatom" id="MathJax-Span-9"><span class="mrow" id="MathJax-Span-10"><span class="mn" id="MathJax-Span-11" style="font-size: 70.7%; font-family: MathJax_Main;">16</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-12" style="font-family: MathJax_Main; padding-left: 0.303em;">=</span><span class="msubsup" id="MathJax-Span-13" style="padding-left: 0.303em;"><span style="display: inline-block; position: relative; width: 1.854em; height: 0px;"><span style="position: absolute; clip: rect(3.206em 1000.003em 4.157em -999.997em); top: -4.002em; left: 0.003em;"><span class="mn" id="MathJax-Span-14" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -4.402em; left: 0.503em;"><span class="texatom" id="MathJax-Span-15"><span class="mrow" id="MathJax-Span-16"><span class="mo" id="MathJax-Span-17" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-18" style="font-size: 70.7%; font-family: MathJax_Main;">96</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mo" id="MathJax-Span-19" style="font-family: MathJax_Main; padding-left: 0.303em;">≈</span><span class="msubsup" id="MathJax-Span-20" style="padding-left: 0.303em;"><span style="display: inline-block; position: relative; width: 2.355em; height: 0px;"><span style="position: absolute; clip: rect(3.206em 1000.003em 4.157em -999.997em); top: -4.002em; left: 0.003em;"><span class="mn" id="MathJax-Span-21" style="font-family: MathJax_Main;">10</span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -4.402em; left: 1.004em;"><span class="texatom" id="MathJax-Span-22"><span class="mrow" id="MathJax-Span-23"><span class="mo" id="MathJax-Span-24" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mn" id="MathJax-Span-25" style="font-size: 70.7%; font-family: MathJax_Main;">29</span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.705em;"></span></span></span><span style="border-left-width: 0.003em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.336em; vertical-align: -0.331em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1"> 1/64^{16} = 2^{-96} \approx 10^{-29} </script></span>.</p>
<p>Our plan is to store the base64 token on the browser, and then store its <em>hash digest</em> (the result of running it through a one-way <a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function" target="_blank">cryptographic hash funtion</a>) in the database.<span class="intersentencespace"></span> We can then sign users in automatically by retrieving the token from the cookie, calculating the hash digest, and then searching for a remember token matching the digest’s value.<span class="intersentencespace"></span> The reason for storing only hashed tokens is so that, even if our entire database is compromised, the attacker still won’t be able to use the remember tokens to sign in.<span class="intersentencespace"></span> To make our remember token even more secure, we’ll plan to change it every time a user creates a new session, which means that any <a href="http://en.wikipedia.org/wiki/Session_hijacking" target="_blank">hijacked sessions</a>—in which an attacker uses a stolen cookie to sign in as a particular user—will expire the next time a user signs in.<span class="intersentencespace"></span> (Session hijacking was widely publicized by the <a href="http://codebutler.com/firesheep" target="_blank">Firesheep</a> application, which showed that remember tokens at many high-profile sites were visible when connected to public Wi-Fi networks.<span class="intersentencespace"></span> The solution is to use site-wide SSL, as described in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-deploying_to_production_with_ssl" class="hyperref">Section&nbsp;<span class="ref">7.4.4</span></a>.)</p>
<p>Although in the actual application we will immediately sign in a newly created user (thus creating a new remember token as a side-effect), we don’t want to rely on this behavior; a more robust practice is to ensure that <em>every</em> user has a valid remember token right from the start.<span class="intersentencespace"></span> To accomplish this, we’ll create an initial token using a <em>callback</em>, a technique introduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-uniqueness_validation" class="hyperref">Section&nbsp;<span class="ref">6.2.5</span></a> in the context of email uniqueness.<span class="intersentencespace"></span> In that section, we used a <code>before_save</code> callback; this time, we’ll use the closely related <code>before_create</code> callback to set the remember token when the user is first created.<sup id="_cha-8_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-4">4</a></sup></p>
<p>To test the remember token, we first save the test user (thereby creating it, since it has never been saved), and then check that the user’s <code>remember_token</code> attribute isn’t blank.<span class="intersentencespace"></span> This gives us sufficient flexibility to change the random string if we ever need to.<span class="intersentencespace"></span> The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-remember_token_should_not_be_blank" class="hyperref">Listing&nbsp;<span class="ref">8.17</span></a>.</p>
<div class="codelisting" id="_code-remember_token_should_not_be_blank" data-tralics-id="uid633" data-number="8.17"><div class="heading"><span class="number">Listing 8.17:</span> 

<span class="description">A test for a valid (nonblank) remember token.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"remember token"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-remember_token_should_not_be_blank" class="hyperref">Listing&nbsp;<span class="ref">8.17</span></a> introduces the <code>its</code> method, which is like <code>it</code> but applies the subsequent test to the given attribute rather than the subject of the test.<span class="intersentencespace"></span> In other words,</p>
<div class="code"><div class="highlight"><pre><span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div></div>
<p>is equivalent to</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">remember_token</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div></div>
<p>The application code introduces several new elements to the User model (<code>app/models/user.rb</code>).<span class="intersentencespace"></span> First, we add a callback method to create a remember token immediately before creating a new user in the database:</p>
<div class="code"><div class="highlight"><pre><span class="n">before_create</span> <span class="ss">:create_remember_token</span>
</pre></div></div>
<p>This code, called a <em>method reference</em>, arranges for Rails to look for a method called <code>create_remember_token</code> and run it before saving the user.<span class="intersentencespace"></span> (In <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase" class="hyperref">Listing&nbsp;<span class="ref">6.20</span></a>, we passed <code>before_save</code> an explicit block, but the method reference technique is generally preferred.)<span class="intersentencespace"></span> Second, the method itself is only used internally by the User model, so there’s no need to expose it to outside users.<span class="intersentencespace"></span> As we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strong_parameters" class="hyperref">Section&nbsp;<span class="ref">7.3.2</span></a>, the Ruby way to accomplish this is to use the <code>private</code> keyword:</p>
<div class="code"><div class="highlight"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_remember_token</span>
    <span class="c1"># Create the token.</span>
  <span class="k">end</span>
</pre></div></div>
<p>All methods defined in a class after <code>private</code> are automatically hidden, so that</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_remember_token</span>
</pre></div></div>
<p>will raise a <code>NoMethodError</code> exception.</p>
<p>Finally, the <code>create_remember_token</code> method needs to <em>assign</em> to one of the user attributes, and in this context it is necessary to use the <code>self</code> keyword in front of <code>remember_token</code>:</p>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_remember_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span><span class="p">)</span>
    <span class="k">end</span>
</pre></div></div>
<p>Because of the way Ruby handles assignments inside objects, without <code>self</code> the assignment would create a <em>local</em> variable called <code>remember_token</code>, which isn’t what we want at all.<span class="intersentencespace"></span> Using <code>self</code> ensures that assignment sets the user’s <code>remember_token</code>, and as a result it will be written to the database along with the other attributes when the user is saved.<span class="intersentencespace"></span> (Now you know why the other <code>before_save</code> callback from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_downcase" class="hyperref">Listing&nbsp;<span class="ref">6.20</span></a> uses <code>self.email</code> instead of just <code>email</code>.)</p>
<p>Note that we’ve hashed the remember token using <a href="https://en.wikipedia.org/wiki/SHA-1" target="_blank">SHA1</a>, a hashing algorithm much faster than the Bcrypt algorithm used to hash user passwords in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_hashed_password" class="hyperref">Section&nbsp;<span class="ref">6.3.1</span></a>, which is important because (as we will see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_sign_in_method" class="hyperref">Section&nbsp;<span class="ref">8.2.2</span></a>) for signed-in users it will be run on every page.<span class="intersentencespace"></span> SHA1 is less secure than Bcrypt, but in the present case it is more than sufficient because the token being hashed is already a 16-digit random string; the SHA1 hexdigest of such a string is essentially uncrackable.<span class="intersentencespace"></span> (The call to <code>to_s</code> is to make sure we can handle <code>nil</code> tokens, which shouldn’t happen in browsers but sometimes happens in tests.)</p>
<p>The <code>digest</code> and <code>new_remember_token</code> methods are attached to the <code>User</code> class because they don’t need a user instance to work,<sup id="_cha-8_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-5">5</a></sup> and they are public methods (above the <code>private</code> line) because in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-current_user" class="hyperref">Section&nbsp;<span class="ref">8.2.3</span></a> we will put them to use outside of the User model.</p>
<p>Putting this all together yields the User model shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-before_create_remember_token" class="hyperref">Listing&nbsp;<span class="ref">8.18</span></a>.</p>
<div class="codelisting" id="_code-before_create_remember_token" data-tralics-id="uid635" data-number="8.18"><div class="heading"><span class="number">Listing 8.18:</span> 

<span class="description">A <code>before_create</code> callback to create <code>remember_token</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">before_create</span> <span class="ss">:create_remember_token</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_remember_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>By the way, the extra level of indentation on <code>create_remember_token</code> is there to make it visually apparent which methods are defined after <code>private</code>.<span class="intersentencespace"></span> (Experience shows that this is a wise practice.)</p>
<p>Since the hashed <code>SecureRandom.urlsafe_base64</code> string is definitely <em>not</em> blank, the tests for the User model should now be passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div></div>
</div>
<div id="_sec-a_working_sign_in_method" data-tralics-id="uid636" class="subsection" data-number="8.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_sign_in_method" class="heading hyperref"><span class="number">8.2.2 </span>A working <span class="tt">sign_in</span> method</a></h3>
<p>Now we’re ready to write the first signin element, the <code>sign_in</code> function itself.<span class="intersentencespace"></span> As noted above, our desired authentication method is to place a (newly created) remember token as a cookie on the user’s browser, and then use the token to find the user record in the database as the user moves from page to page (implemented in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-current_user" class="hyperref">Section&nbsp;<span class="ref">8.2.3</span></a>).<span class="intersentencespace"></span> The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>, and introduces the <code>current_user</code> method, which we’ll implement in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-current_user" class="hyperref">Section&nbsp;<span class="ref">8.2.3</span></a>.</p>
<div class="codelisting" id="_code-sign_in_function" data-tralics-id="uid637" data-number="8.19"><div class="heading"><span class="number">Listing 8.19:</span> 

<span class="description">The complete (but not-yet-working) <code>sign_in</code> function.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we follow the desired steps: first, create a new token; second, place the raw token in the browser cookies; third, save the hashed token to the database; fourth, set the current user equal to the given user (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-current_user" class="hyperref">Section&nbsp;<span class="ref">8.2.3</span></a>).<span class="intersentencespace"></span> As we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-current_user" class="hyperref">Section&nbsp;<span class="ref">8.2.3</span></a>, setting the current user to <code>user</code> isn’t currently necessary because of the immediate redirect in the <code>create</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_success_not_yet_working" class="hyperref">Listing&nbsp;<span class="ref">8.13</span></a>), but it’s a good idea in case we ever want to use <code>sign_in</code> without a redirect.</p>
<p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>, note the use of <code>update_attribute</code> to save the token.<span class="intersentencespace"></span> As mentioned briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.5</span></a>), this method allows us to update a single attribute while bypassing the validations—necessary in this case since we don’t have the user’s password or confirmation.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a> also introduces the <code>cookies</code> utility supplied by Rails, which allows us to manipulate browser cookies as if they were hashes.<span class="intersentencespace"></span> Each element in the cookie is itself a hash of two elements, a <code>value</code> and an optional <code>expires</code> date.<span class="intersentencespace"></span> For example, we could implement user signin by placing a cookie with value equal to the remember token that expires 20&nbsp;years from now:</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value</span><span class="p">:</span>   <span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires</span><span class="p">:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div></div>
<p>(This uses one of the convenient Rails time helpers, as discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-time_helpers" class="hyperref">Box&nbsp;<span class="ref">8.1</span></a>.)</p>
<div class="aside" id="_sidebar-time_helpers" data-tralics-id="uid638" data-number="8.1"><div class="heading"><span class="number">Box 8.1.</span> 

<span class="description">Cookies expire <span class="tt">20.years.from_now</span></span></div>
<p>You may recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_class_of_our_own" class="hyperref">Section&nbsp;<span class="ref">4.4.2</span></a> that Ruby lets you add methods to <em>any</em> class, even built-in ones.<span class="intersentencespace"></span> In that section, we added a <span class="tt">palindrome?</span> method to the <span class="tt">String</span> class (and discovered as a result that <span class="tt">"deified"</span> is a palindrome), and we also saw how Rails adds a <span class="tt">blank?</span> method to class <span class="tt">Object</span> (so that <span class="tt">"".blank?</span>, <span class="tt">"&nbsp;".blank?</span>, and <span class="tt">nil.blank?</span> are all <span class="tt">true</span>).<span class="intersentencespace"></span> The cookie code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a> (which internally sets a cookie that expires <span class="tt">20.years.from_now</span>) gives yet another example of this practice through one of Rails’ <em>time helpers</em>, which are methods added to <span class="tt">Fixnum</span> (the base class for numbers):</p>
<pre>  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 13 Mar 2011 03:38:55 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 02 Jan 2010 03:39:14 UTC +00:00</pre>
<p>Rails adds other helpers, too:</p>
<pre>  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>
<p>These are useful for upload validations, making it easy to restrict, say, image uploads to <span class="tt">5.megabytes</span>.</p>
<p>Though it must be used with caution, the flexibility to add methods to built-in classes allows for extraordinarily natural additions to plain Ruby.<span class="intersentencespace"></span> Indeed, much of the elegance of Rails ultimately derives from the malleability of the underlying Ruby language.</p>

</div><p>This pattern of setting a cookie that expires 20 years in the future became so common that Rails added a special <code>permanent</code> method to implement it, so that we can simply write</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
</pre></div></div>
<p>Under the hood, using <code>permanent</code> causes Rails to set the expiration to <code>20.years.from_now</code> automatically.</p>
<p>After the cookie is set, on subsequent page views we can retrieve the user with code like</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">remember_token</span><span class="p">:</span> <span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p>(As we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_working" class="hyperref">Listing&nbsp;<span class="ref">8.22</span></a>, we’ll actually have to hash the remember token first.)<span class="intersentencespace"></span> Of course, <code>cookies</code> isn’t <em>really</em> a hash, since assigning to <code>cookies</code> actually <em>saves</em> a piece of text on the browser, but part of the beauty of Rails is that it lets you ignore that detail and concentrate on writing the application.</p>
</div>
<div id="_sec-current_user" data-tralics-id="uid639" class="subsection" data-number="8.2.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-current_user" class="heading hyperref"><span class="number">8.2.3 </span>Current user</a></h3>
<p>Having discussed how to store the user’s remember token in a cookie for later use, we now need to learn how to retrieve the user on subsequent page views.<span class="intersentencespace"></span> Let’s look again at the <code>sign_in</code> function to see where we are:</p>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>The only code not presently working is</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div></div>
<p>As noted just after <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>, this code will never actually be used in the present application due to the immediate redirect in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_success_not_yet_working" class="hyperref">Listing&nbsp;<span class="ref">8.13</span></a>, but it would be dangerous for the <code>sign_in</code> method to rely on this.</p>
<p>The purpose of <code>current_user</code>, accessible in both controllers and views, is to allow constructions such as</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div></div>
<p>The use of <code>self</code> in the assignment is necessary for the same essential reason noted in the discussion leading up to <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-before_create_remember_token" class="hyperref">Listing&nbsp;<span class="ref">8.18</span></a>: without <code>self</code>, Ruby would simply create a local variable called <code>current_user</code>.</p>
<p>To start writing the code for <code>current_user</code>, note that the line</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div></div>
<p>is an <em>assignment</em>, which we must define.<span class="intersentencespace"></span> Ruby has a special syntax for defining such an assignment function, shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_equals" class="hyperref">Listing&nbsp;<span class="ref">8.20</span></a>.</p>
<div class="codelisting" id="_code-current_user_equals" data-tralics-id="uid640" data-number="8.20"><div class="heading"><span class="number">Listing 8.20:</span> 

<span class="description">Defining assignment to <code>current_user</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This might look confusing—most languages don’t let you use the equals sign in a method definition—but it simply defines a method <code>current_user=</code> expressly designed to handle assignment to <code>current_user</code>.<span class="intersentencespace"></span> In other words, the code</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div></div>
<p>is automatically converted to</p>
<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>thereby invoking the <code>current_user=</code> method.<span class="intersentencespace"></span> Its one argument is the right-hand side of the assignment, in this case the user to be signed in.<span class="intersentencespace"></span> The one-line method body just sets an instance variable <code>@current_user</code>, effectively storing the user for later use.</p>
<p>In ordinary Ruby, we could define a second method, <code>current_user</code>, designed to return the value of <code>@current_user</code>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_wrong" class="hyperref">Listing&nbsp;<span class="ref">8.21</span></a>.</p>
<div class="codelisting" id="_code-current_user_wrong" data-tralics-id="uid641" data-number="8.21"><div class="heading"><span class="number">Listing 8.21:</span> 

<span class="description">A tempting but useless definition for <code>current_user</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span>     <span class="c1"># Useless! Don't use this line.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>If we did this, we would effectively replicate the functionality of <code>attr_accessor</code>, which we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_user_class" class="hyperref">Section&nbsp;<span class="ref">4.4.5</span></a>.<sup id="_cha-8_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-6">6</a></sup><span class="intersentencespace"></span> The problem is that it utterly fails to solve our problem: with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_wrong" class="hyperref">Listing&nbsp;<span class="ref">8.21</span></a>, the user’s signin status would be forgotten: as soon as the user went to another page—<em>poof!</em>—the session would end and the user would be automatically signed out.<span class="intersentencespace"></span> This is due to the stateless nature of HTTP interactions (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a>)—when the user makes a second request, all the variables get set to their defaults, which for instance variables like <code>@current_user</code> is <code>nil</code>.<span class="intersentencespace"></span> Hence, when a user accesses another page, even on the same application, Rails has set <code>@current_user</code> to <code>nil</code>, and the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_wrong" class="hyperref">Listing&nbsp;<span class="ref">8.21</span></a> won’t do what you want it to do.</p>
<p>To avoid this problem, we can find the user corresponding to the remember token created by the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_working" class="hyperref">Listing&nbsp;<span class="ref">8.22</span></a>.<span class="intersentencespace"></span> Note that, because the remember token in the database is hashed, we first need to hash the token from the cookie before using it to find the user in the database.<span class="intersentencespace"></span> We accomplish this with the <code>User.digest</code> method defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-before_create_remember_token" class="hyperref">Listing&nbsp;<span class="ref">8.18</span></a>.</p>
<div class="codelisting" id="_code-current_user_working" data-tralics-id="uid643" data-number="8.22"><div class="heading"><span class="number">Listing 8.22:</span> 

<span class="description">Finding the current user using the <code>remember_token</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">remember_token</span><span class="p">:</span> <span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_working" class="hyperref">Listing&nbsp;<span class="ref">8.22</span></a> uses the common but initially obscure <code>||=</code> (“or equals”) assignment operator (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-or_equals" class="hyperref">Box&nbsp;<span class="ref">8.2</span></a>).<span class="intersentencespace"></span> Its effect is to set the <code>@current_user</code> instance variable to the user corresponding to the remember token, but only if <code>@current_user</code> is undefined.<sup id="_cha-8_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-7">7</a></sup><span class="intersentencespace"></span> In other words, the construction</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">remember_token</span><span class="p">:</span> <span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p>calls the <code>find_by</code> method the first time <code>current_user</code> is called, but on subsequent invocations returns <code>@current_user</code> without hitting the database.<sup id="_cha-8_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-8">8</a></sup><span class="intersentencespace"></span> This is only useful if <code>current_user</code> is used more than once for a single user request; in any case, <code>find_by</code> will be called at least once every time a user visits a page on the site.</p>
<div class="aside" id="_sidebar-or_equals" data-tralics-id="uid646" data-number="8.2"><div class="heading"><span class="number">Box 8.2.</span> 

<span class="description">What the *$@!<span class="intersentencespace"></span> is <span class="tt">||=</span> ?<span class="intersentencespace"></span> </span></div>
<p>The <span class="tt">||=</span> construction is very Rubyish—that is, it is highly characteristic of the Ruby language—and hence important to learn if you plan on doing much Ruby programming.<span class="intersentencespace"></span> Though at first it may seem mysterious, <em>or equals</em> is easy to understand by analogy.</p>
<p>We start by noting a common idiom for changing a currently defined variable.<span class="intersentencespace"></span> Many computer programs involve incrementing a variable, as in</p>
<pre>  x = x + 1</pre>
<p>Most languages provide a syntactic shortcut for this operation; in Ruby (and in C, C++, Perl, Python, Java, etc.), it appears as follows:</p>
<pre>  x += 1</pre>
<p>Analogous constructs exist for other operators as well:</p>
<pre>  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 7
  =&gt; -1</pre>
<p>In each case, the pattern is that <span class="tt">x = x O y</span> and <span class="tt">x O= y</span> are equivalent for any operator <span class="tt">O</span>.</p>
<p>Another common Ruby pattern is assigning to a variable if it’s <span class="tt">nil</span> but otherwise leaving it alone.<span class="intersentencespace"></span> Recalling the <em>or</em>&nbsp;operator <span class="tt">||</span> seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-objects_and_message_passing" class="hyperref">Section&nbsp;<span class="ref">4.2.3</span></a>, we can write this as follows:</p>
<pre>  &gt;&gt; @user
  =&gt; nil
  &gt;&gt; @user = @user || "the user"
  =&gt; "the user"
  &gt;&gt; @user = @user || "another user"
  =&gt; "the user"</pre>
<p>Since <span class="tt">nil</span> is false in a boolean context, the first assignment is <span class="tt">nil || "the user"</span>, which evaluates to <span class="tt">"the user"</span>; similarly, the second assignment is <span class="tt">@user || "another user"</span>, which also evaluates to <span class="tt">"the user"</span> (i.e., the value of <span class="tt">@user</span> from the first assignment)—since strings are <span class="tt">true</span> in a boolean context, the series of <span class="tt">||</span> expressions terminates after the first expression is evaluated.<span class="intersentencespace"></span> (This practice of evaluating <span class="tt">||</span> expressions from left to right and stopping on the first true value is known as <em>short-circuit evaluation</em>.)</p>
<p>Comparing the console sessions for the various operators, we see that <span class="tt">@user = @user || value</span> follows the <span class="tt">x = x O y</span> pattern with <span class="tt">||</span> in the place of <span class="tt">O</span>, which suggests the following equivalent construction:</p>
<pre>  &gt;&gt; @user ||= "the user"
  =&gt; "the user"</pre>
<p>Voilà&nbsp;!<span class="intersentencespace"></span></p>

</div></div>
<div id="_sec-changing_the_layout_links" data-tralics-id="uid647" class="subsection" data-number="8.2.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-changing_the_layout_links" class="heading hyperref"><span class="number">8.2.4 </span>Changing the layout links</a></h3>
<p>We come finally to a practical application of all our signin/out work: we’ll change the layout links based on signin status.<span class="intersentencespace"></span> In particular, as seen in the <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_success_mockup" class="hyperref">Figure&nbsp;<span class="ref">8.3</span></a> mockup, we’ll arrange for the links to change when users sign in or sign out, and we’ll also add links for listing all users and user settings (to be completed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>) and one for the current user’s profile page.<span class="intersentencespace"></span> In doing so, we’ll get the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_success_tests" class="hyperref">Listing&nbsp;<span class="ref">8.6</span></a> to pass, which means our test suite will be green for the first time since the beginning of the chapter.</p>
<p>The way to change the links in the site layout involves using an
if-else branching structure inside of Embedded Ruby:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  # Links for signed-in users
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  # Links for non-signed-in-users
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This kind of code requires the existence of a <code>signed_in?</code> boolean, which we’ll now define.</p>
<p>A user is signed in if there is a current user in the session, i.e., if <code>current_user</code> is non-<code>nil</code>.<span class="intersentencespace"></span> This requires the use of the “not” operator, written using an exclamation point&nbsp;<code>!</code><span class="intersentencespace"></span> and usually read as “bang”.<span class="intersentencespace"></span> In the present context, a user is signed in if <code>current_user</code> is <em>not</em> <code>nil</code>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signed_in_p" class="hyperref">Listing&nbsp;<span class="ref">8.23</span></a>.</p>
<div class="codelisting" id="_code-signed_in_p" data-tralics-id="uid648" data-number="8.23"><div class="heading"><span class="number">Listing 8.23:</span> 

<span class="description">The <code>signed_in?</code> helper method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>With the <code>signed_in?</code> method in hand, we’re ready to finish the layout links.<span class="intersentencespace"></span> There are four new links, two of which are stubbed out (to be completed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The signout link, meanwhile, uses the signout path defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_resource" class="hyperref">Listing&nbsp;<span class="ref">8.2</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>(Notice that the signout link passes a hash argument indicating that it should submit with an HTTP <span class="tt">DELETE</span> request.<sup id="_cha-8_footnote-ref-9" class="footnote intersentence"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-9">9</a></sup><span class="intersentencespace"></span>) Finally, we’ll add a profile link as follows:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Here we could write</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>but Rails allows us to link directly to the user, in this context automatically converting <code>current_user</code> into <code>user_path(current_user)</code>.</p>
<p>In the process of putting the new links into the layout, we’ll take advantage of Bootstrap’s ability to make dropdown menus, which you can read more about on the <a href="http://getbootstrap.com/2.3.2/components.html" target="_blank">Bootstrap components page</a>.<span class="intersentencespace"></span> The full result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_signin_signout_links" class="hyperref">Listing&nbsp;<span class="ref">8.24</span></a>.<span class="intersentencespace"></span> Note in particular the CSS&nbsp;ids and classes related to the Bootstrap dropdown menu.</p>
<div class="codelisting" id="_code-layout_signin_signout_links" data-tralics-id="uid650" data-number="8.24"><div class="heading"><span class="number">Listing 8.24:</span> 

<span class="description">Changing the layout links for signed-in users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"fat-menu"</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div><p>The dropdown menu requires the use of Bootstrap’s JavaScript library, which we can include using the Rails asset pipeline by editing the application JavaScript file, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-bootstrap_js" class="hyperref">Listing&nbsp;<span class="ref">8.25</span></a>.</p>
<div class="codelisting" id="_code-bootstrap_js" data-tralics-id="uid651" data-number="8.25"><div class="heading"><span class="number">Listing 8.25:</span> 

<span class="description">Adding the Bootstrap JavaScript library to <code>application.js</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/javascripts/application.js</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require bootstrap</span>
<span class="c1">//= require turbolinks</span>
<span class="c1">//= require_tree .</span>
</pre></div></div></div><p>This uses the Sprockets library to include the Bootstrap JavaScript, which in turn is available thanks to the <span class="tt">bootstrap-sass</span> gem from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-custom_css" class="hyperref">Section&nbsp;<span class="ref">5.1.2</span></a>.</p>
<p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_signin_signout_links" class="hyperref">Listing&nbsp;<span class="ref">8.24</span></a>, all the tests should be passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>A signed-in user now sees the new links and dropdown menu defined by <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-layout_signin_signout_links" class="hyperref">Listing&nbsp;<span class="ref">8.24</span></a>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_with_signout_link" class="hyperref">Figure&nbsp;<span class="ref">8.9</span></a>.</p>
<div class="center figure" id="_fig-profile_with_signout_link" data-tralics-id="uid652" data-number="8.9">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/profile_with_signout_link_bootstrap.png" alt="images/figures/profile_with_signout_link_bootstrap"></div><div class="caption"><span class="header">Figure 8.9: </span><span class="description">A signed-in user with new links and a dropdown menu.
</span></div></div>
<p>At this point, you should verify that you can sign in, close the browser, and then still be signed in when you visit the sample application.<span class="intersentencespace"></span> If you want, you can even inspect the browser cookies to see the result directly (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-cookie_in_browser" class="hyperref">Figure&nbsp;<span class="ref">8.10</span></a>).</p>
<div class="center figure" id="_fig-cookie_in_browser" data-tralics-id="uid653" data-number="8.10">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/cookie_in_browser.png" alt="images/figures/cookie_in_browser"></div><div class="caption"><span class="header">Figure 8.10: </span><span class="description">The remember token cookie in the local browser.
</span></div></div>
</div>
<div id="_sec-signin_upon_signup" data-tralics-id="uid654" class="subsection" data-number="8.2.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_upon_signup" class="heading hyperref"><span class="number">8.2.5 </span>Signin upon signup</a></h3>
<p>In principle, although we are now done with authentication, newly registered users might be confused, as they are not signed in by default.<span class="intersentencespace"></span> Implementing this is the last bit of polish before letting users sign out.<span class="intersentencespace"></span> We’ll start by adding a line to the authentication tests (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_up_sign_in" class="hyperref">Listing&nbsp;<span class="ref">8.26</span></a>).<span class="intersentencespace"></span> This includes the “after saving the user” <code>describe</code> block from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-after_save_tests" class="hyperref">Listing&nbsp;<span class="ref">7.32</span></a> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_exercises" class="hyperref">Section&nbsp;<span class="ref">7.6</span></a>), which you should add to the test now if you didn’t already do the corresponding exercise.</p>
<div class="codelisting" id="_code-sign_up_sign_in" data-tralics-id="uid655" data-number="8.26"><div class="heading"><span class="number">Listing 8.26:</span> 

<span class="description">Testing that newly signed-up users are also signed in.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"after saving the user"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">'user@example.com'</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-success'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Welcome'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we’ve tested the appearance of the signout link to verify that the user was successfully signed in after signing up.</p>
<p>With the <code>sign_in</code> method from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_success" class="hyperref">Section&nbsp;<span class="ref">8.2</span></a>, getting this test to pass by actually signing in the user is easy: just add <code>sign_in @user</code> right after saving the user to the database (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_upon_signup" class="hyperref">Listing&nbsp;<span class="ref">8.27</span></a>).</p>
<div class="codelisting" id="_code-signin_upon_signup" data-tralics-id="uid656" data-number="8.27"><div class="heading"><span class="number">Listing 8.27:</span> 

<span class="description">Signing in the user upon signup.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-signing_out" data-tralics-id="uid657" class="subsection" data-number="8.2.6"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signing_out" class="heading hyperref"><span class="number">8.2.6 </span>Signing out</a></h3>
<p>As discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_failure" class="hyperref">Section&nbsp;<span class="ref">8.1</span></a>, our authentication model is to keep users signed in until they sign out explicitly.<span class="intersentencespace"></span> In this section, we’ll add this necessary signout capability.</p>
<p>So far, the Sessions controller actions have followed the RESTful convention of using <code>new</code> for a signin page and <code>create</code> to complete the signin.<span class="intersentencespace"></span> We’ll continue this theme by using a <code>destroy</code> action to delete sessions, i.e., to sign out.<span class="intersentencespace"></span> To test this, we’ll click on the “Sign out” link and then look for the reappearance of the signin link (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signout_test" class="hyperref">Listing&nbsp;<span class="ref">8.28</span></a>).</p>
<div class="codelisting" id="_code-signout_test" data-tralics-id="uid658" data-number="8.28"><div class="heading"><span class="number">Listing 8.28:</span> 

<span class="description">A test for signing out a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"followed by signout"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"Sign out"</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As with user signin, which relied on the <code>sign_in</code> function, user signout just defers to a <code>sign_out</code> function (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-destroy_session" class="hyperref">Listing&nbsp;<span class="ref">8.29</span></a>).</p>
<div class="codelisting" id="_code-destroy_session" data-tralics-id="uid659" data-number="8.29"><div class="heading"><span class="number">Listing 8.29:</span> 

<span class="description">Destroying a session (user signout).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">sign_out</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As with the other authentication elements, we’ll put <code>sign_out</code> in the Sessions helper module.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_out_method" class="hyperref">Listing&nbsp;<span class="ref">8.30</span></a> shows the steps: we first change the user’s remember token in the database (in case the cookie has been stolen, as it could still be used to authorize a user), and then we use the <code>delete</code> method on cookies to remove the remember token from the session; as an optional final step, we set the current user to <code>nil</code>.<span class="intersentencespace"></span> (As with the assignment in the <code>sign_in</code> method (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a>), setting the current user to <code>nil</code> isn’t currently necessary because of the immediate redirect in the <code>destroy</code> action, but it’s a good idea in case we ever want to use <code>sign_out</code> without a redirect.)</p>
<div class="codelisting" id="_code-sign_out_method" data-tralics-id="uid660" data-number="8.30"><div class="heading"><span class="number">Listing 8.30:</span> 

<span class="description">The <code>sign_out</code> method in the Sessions helper module.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">sign_out</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span>
                                  <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span><span class="p">))</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This completes the signup/signin/signout triumvirate, and the test suite should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>It’s worth noting that our test suite covers most of the authentication machinery, but not all of it.<span class="intersentencespace"></span> For instance, we don’t test how long the “remember me” cookie lasts or whether it gets set at all.<span class="intersentencespace"></span> It is possible to do so, but experience shows that direct tests of cookie values are brittle and have a tendency to rely on implementation details that sometimes change from one Rails release to the next.<span class="intersentencespace"></span> The result is breaking tests for application code that still works fine.<span class="intersentencespace"></span> By focusing on high-level functionality—verifying that users can sign in, stay signed in from page to page, and can sign out—we test the core application code without focusing on less important details.</p>
</div></div>
<div id="_sec-cucumber" data-tralics-id="cid49" class="section" data-number="8.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-cucumber" class="heading hyperref"><span class="number">8.3 </span>Introduction to cucumber (optional)</a></h2>
<p>Having finished the foundation of the sample application’s authentication system, we’re going to take this opportunity to show how to write signin tests using <a href="http://cukes.info/" target="_blank">Cucumber</a>, a popular tool for behavior-driven development that enjoys significant popularity in the Ruby community.<span class="intersentencespace"></span> This section is optional and can be skipped without loss of continuity.</p>
<p>Cucumber allows the definition of plain-text <em>stories</em> describing application behavior.<span class="intersentencespace"></span> Many Rails programmers find Cucumber especially convenient when doing client work; since they can be read even by non-technical users, Cucumber tests can be shared with (and can sometimes even be written by) the client.<span class="intersentencespace"></span> Of course, using a testing framework that isn’t pure Ruby has a downside, and I find that the plain-text stories can be a bit verbose.<span class="intersentencespace"></span> Nevertheless, Cucumber does have a place in the Ruby testing toolkit, and I especially like its emphasis on high-level behavior over low-level implementation.</p>
<p>Since the emphasis in this book is on RSpec and Capybara, the presentation that follows is necessarily superficial and incomplete, and will be a bit light on explanation.<span class="intersentencespace"></span> Its purpose is just to give you a taste of Cucumber (crisp and juicy, no doubt)—if it strikes your fancy, there are entire books on the subject waiting to satisfy your appetite.<span class="intersentencespace"></span> (I particularly recommend <a href="http://www.amazon.com/gp/product/1934356379" target="_blank"><em>The RSpec Book</em></a> by David Chelimsky, <a href="http://www.amazon.com/gp/product/1935182277" target="_blank"><em>Rails 3 in Action</em></a> by Ryan Bigg and Yehuda Katz, and <a href="http://www.amazon.com/gp/product/1934356808" target="_blank"><em>The Cucumber Book</em></a> by Matt Wynne and Aslak Hellesøy.)</p>
<div id="_sec-installation_and_setup" data-tralics-id="uid661" class="subsection" data-number="8.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-installation_and_setup" class="heading hyperref"><span class="number">8.3.1 </span>Installation and setup</a></h3>
<p>To install Cucumber, first add the <span class="tt">cucumber-rails</span> gem and a utility gem called <span class="tt">database_cleaner</span> to the <code>:test</code> group in the <code>Gemfile</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-cucumber_rails" class="hyperref">Listing <span class="ref">8.31</span></a>).</p>
<div class="codelisting" id="_code-cucumber_rails" data-tralics-id="uid662" data-number="8.31"><div class="heading"><span class="number">Listing 8.31:</span> 

<span class="description">Adding the <span class="tt">cucumber-rails</span> gem to the <code>Gemfile.</code></span>
</div>

<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">'cucumber-rails'</span><span class="p">,</span> <span class="s1">'1.4.0'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">'database_cleaner'</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s1">'bmabey/database_cleaner'</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then install as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>To set up the application to use Cucumber, we next generate some necessary support files and directories:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate cucumber:install
</pre></div></div>
<p>This creates a <code>features/</code> directory where the files associated with Cucumber will live.</p>
</div>
<div id="_sec-features_and_steps" data-tralics-id="uid663" class="subsection" data-number="8.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-features_and_steps" class="heading hyperref"><span class="number">8.3.2 </span>Features and steps</a></h3>
<p>Cucumber features are descriptions of expected behavior using a plain-text language called <a href="https://github.com/cucumber/gherkin" target="_blank">Gherkin</a>.<span class="intersentencespace"></span> Gherkin tests read much like well-written RSpec examples, but because they are plain-text they are more accessible to those more comfortable reading English than Ruby code.</p>
<p>Our Cucumber features will implement a subset of the signin examples in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_failing_signin_test" class="hyperref">Listing&nbsp;<span class="ref">8.5</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_success_tests" class="hyperref">Listing&nbsp;<span class="ref">8.6</span></a>.<span class="intersentencespace"></span> To get started, we’ll create a file in the <code>features/</code> directory called <code>signing_in.feature</code>.</p>
<p>Cucumber features start with a short description of the feature, as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
</pre></div></div>
<p>Then they add individual <em>scenarios</em>.<span class="intersentencespace"></span> For example, to test unsuccessful signin, we could write the following scenario:</p>
<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">they submit invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">they should see an error message</span>
</pre></div></div>
<p>Similarly, to test successful signin, we could add this:</p>
<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">they should see their profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">they should see a signout link</span>
</pre></div></div>
<p>Collecting these together yields the Cucumber feature file shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_features" class="hyperref">Listing <span class="ref">8.32</span></a>.</p>
<div class="codelisting" id="_code-signin_features" data-tralics-id="uid664" data-number="8.32"><div class="heading"><span class="number">Listing 8.32:</span> 

<span class="description">Cucumber features to test user signin.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">features/signing_in.feature</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>

<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">they submit invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">they should see an error message</span>

<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">they should see their profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">they should see a signout link</span>
</pre></div></div></div><p>To run the features, we use the <code>cucumber</code> executable:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div></div>
<p>Compare this to</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>In this context, it’s worth noting that, like RSpec, Cucumber can be invoked using a Rake task:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake cucumber
</pre></div></div>
<p>(For reasons that escape me, this is sometimes written as <code>rake cucumber:ok</code>.)</p>
<p>All we’ve done so far is write some plain text, so it shouldn’t be surprising that the Cucumber scenarios aren’t yet passing.<span class="intersentencespace"></span> To get the test suite to green, we need to add a <em>step</em> file that maps the plain-text lines to Ruby code.<span class="intersentencespace"></span> The step file goes in the <code>features/step_definitions</code> directory; we’ll call it <code>authentication_steps.rb</code>.</p>
<p>The <code>Feature</code> and <code>Scenario</code> lines are mainly for documentation, but each of the other lines needs some corresponding Ruby.<span class="intersentencespace"></span> For example, the line</p>
<div class="code"><div class="highlight"><pre><span class="k">Given </span><span class="nf">a user visits the signin page</span>
</pre></div></div>
<p>in the feature file gets handled by the step definition</p>
<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>
</pre></div></div>
<p>In the feature, <code>Given</code> is just a string, but in the step file <code>Given</code> is a <em>method</em> that takes a regular expression and a block.<span class="intersentencespace"></span> The regex matches the text of the line in the scenario, and the contents of the block are the Ruby code needed to implement the step.<span class="intersentencespace"></span> In this case, “a user visits the signin page” is implemented by</p>
<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signin_path</span>
</pre></div></div>
<p>If this looks familiar, it should: it’s just Capybara, which is included by default in Cucumber step files.<span class="intersentencespace"></span> The next two lines should also look familiar; the scenario steps</p>
<div class="code"><div class="highlight"><pre><span class="k">When </span><span class="nf">they submit invalid signin information</span>
<span class="k">Then </span><span class="nf">they should see an error message</span>
</pre></div></div>
<p>in the feature file are handled by these steps:</p>
<div class="code"><div class="highlight"><pre><span class="no">When</span> <span class="sr">/^they submit invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^they should see an error message$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>The first step also uses Capybara, while the second uses Capybara’s <code>page</code> object with RSpec.<span class="intersentencespace"></span> Evidently, all the testing work we’ve done so far with RSpec and Capybara is also useful with Cucumber.</p>
<p>The rest of the steps proceed similarly.<span class="intersentencespace"></span> The final step definition file appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authentication_steps" class="hyperref">Listing&nbsp;<span class="ref">8.33</span></a>.<span class="intersentencespace"></span> Try adding one step at a time, running</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div></div>
<p>each time until the tests pass.</p>
<div class="codelisting" id="_code-authentication_steps" data-tralics-id="uid665" data-number="8.33"><div class="heading"><span class="number">Listing 8.33:</span> 

<span class="description">The complete steps needed to get the signin features to pass.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">features/step_definitions/authentication_steps.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^they submit invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^they should see an error message$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Given</span> <span class="sr">/^the user has an account$/</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                      <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^the user submits valid signin information$/</span> <span class="k">do</span>
  <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^they should see their profile page$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^they should see a signout link$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authentication_steps" class="hyperref">Listing&nbsp;<span class="ref">8.33</span></a>, the Cucumber tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div></div>
</div>
<div id="_sec-rspec_custom_matchers" data-tralics-id="uid666" class="subsection" data-number="8.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rspec_custom_matchers" class="heading hyperref"><span class="number">8.3.3 </span>Counterpoint: RSpec custom matchers</a></h3>
<p>Having written some simple Cucumber scenarios, it’s worth comparing the result to the equivalent RSpec examples.<span class="intersentencespace"></span> First, take a look at the Cucumber feature in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_features" class="hyperref">Listing&nbsp;<span class="ref">8.32</span></a> and the corresponding step definitions in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authentication_steps" class="hyperref">Listing&nbsp;<span class="ref">8.33</span></a>.<span class="intersentencespace"></span> Then take a look at the RSpec request specs (integration tests):</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"signin"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Sign in"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">"Sign in"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span>     <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>You can see how a case could be made for either Cucumber or integration tests.<span class="intersentencespace"></span> Cucumber features are easily readable, but they are entirely separate from the code that implements them—a property that cuts both ways.<span class="intersentencespace"></span> I find that Cucumber is easy to read and awkward to write, while integration tests are (for a programmer) a little harder to read and <em>much</em> easier to write.</p>
<p>One nice effect of Cucumber’s separation of concerns is that it operates at a higher level of abstraction.<span class="intersentencespace"></span> For example, we write</p>
<div class="code"><div class="highlight"><pre><span class="k">Then </span><span class="nf">they should see an error message</span>
</pre></div></div>
<p>to express the expectation of seeing an error message, and</p>
<div class="code"><div class="highlight"><pre><span class="no">Then</span> <span class="sr">/^they should see an error message$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>to implement the test.<span class="intersentencespace"></span> What’s especially convenient about this is that only the second element (the step) is dependent on the implementation, so that if we change, e.g., the CSS class used for error messages, the feature file would stay the same.</p>
<p>In this vein, it might make you unhappy to write</p>
<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">)</span>
</pre></div></div>
<p>in a bunch of places, when what you really want is to indicate that the page should have an error message.<span class="intersentencespace"></span> This practice couples the test tightly to the implementation, and we would have to change it everywhere if the implementation changed.<span class="intersentencespace"></span> In the context of pure RSpec, there is a solution, which is to use a <em>custom matcher</em>, allowing us to write the following instead:</p>
<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">'Invalid'</span><span class="p">)</span>
</pre></div></div>
<p>We can define such a matcher in the same utilities file where we put the <code>full_title</code> test helper in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pretty_rspec" class="hyperref">Section&nbsp;<span class="ref">5.3.4</span></a>.<span class="intersentencespace"></span> The code itself looks like this:</p>
<div class="code"><div class="highlight"><pre><span class="no">RSpec</span><span class="o">::</span><span class="no">Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>We can also define helper functions for common operations:</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>
</pre></div></div>
<p>The resulting support code is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-have_error_message" class="hyperref">Listing&nbsp;<span class="ref">8.34</span></a> (which incorporates the results of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-full_title_helper_tests" class="hyperref">Listing&nbsp;<span class="ref">5.41</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rspec_utilities_simplified" class="hyperref">Listing&nbsp;<span class="ref">5.42</span></a> from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-layout_exercises" class="hyperref">Section&nbsp;<span class="ref">5.6</span></a>).<span class="intersentencespace"></span> I find this approach to be more flexible than Cucumber step definitions, particularly when the matchers or should helpers naturally take an argument, such as <code>valid_signin(user)</code>.<span class="intersentencespace"></span> Step definitions can replicate this functionality with regex matchers, but I generally find this approach to be more (cu)cumbersome.</p>
<div class="codelisting" id="_code-have_error_message" data-tralics-id="uid667" data-number="8.34"><div class="heading"><span class="number">Listing 8.34:</span> 

<span class="description">Adding a helper method and a custom RSpec matcher.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/support/utilities.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>

<span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">"Sign in"</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="o">::</span><span class="no">Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-error'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-have_error_message" class="hyperref">Listing&nbsp;<span class="ref">8.34</span></a>, we can write</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">'Invalid'</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div></div>
<p>There are many other examples of coupling between our tests and the site’s implementation.<span class="intersentencespace"></span> Sweeping through the current test suite and decoupling the tests from the implementation details by making custom matchers and methods is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sign_in_out_exercises" class="hyperref">Section&nbsp;<span class="ref">8.5</span></a>).</p>
</div></div>
<div id="_cid50" data-tralics-id="cid50" class="section" data-number="8.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid50" class="heading hyperref"><span class="number">8.4 </span>Conclusion</a></h2>
<p>We’ve covered a lot of ground in this chapter, transforming our promising but unformed application into a site capable of the full suite of registration and login behaviors.<span class="intersentencespace"></span> All that is needed to complete the authentication functionality is to restrict access to pages based on signin status and user identity.<span class="intersentencespace"></span> We’ll accomplish this task en route to giving users the ability to edit their information and giving administrators the ability to remove users from the system, which are the main goals of <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a>.</p>
<p>Before moving on, merge your changes back into the master branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Finish sign in"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-in-out
</pre></div></div>
<p>Then push up the remote GitHub repository and the Heroku production server:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku run rake db:migrate
</pre></div></div>
</div>
<div id="_sec-sign_in_out_exercises" data-tralics-id="cid51" class="section" data-number="8.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sign_in_out_exercises" class="heading hyperref"><span class="number">8.5 </span>Exercises</a></h2>
<ol>
<li>Refactor the signin form to use <code>form_tag</code> in place of <code>form_for</code>.<span class="intersentencespace"></span> Make sure the test suite still passes.<span class="intersentencespace"></span> <em>Hint</em>: See the <a href="http://railscasts.com/episodes/270-authentication-in-rails-3-1" target="_blank">RailsCast on authentication in Rails&nbsp;3.1</a>, and note in particular the change in the structure of the <code>params</code> hash.
</li>
<li>Following the example in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rspec_custom_matchers" class="hyperref">Section&nbsp;<span class="ref">8.3.3</span></a>, go through the user and authentication request specs (i.e., the files currently in the <code>spec/requests</code> directory) and add methods to <code>spec/support/utilities.rb</code> to decouple the tests from the implementation.<span class="intersentencespace"></span> <em>Extra credit:</em> Organize the support code into separate files and modules, and get everything to work by including the modules properly in the spec helper file.
</li></ol>
</div>
<div id="cha-8_footnotes">
  <ol class="footnotes">
    <li id="_cha-8_footnote-1">Another common model is to expire the session after a certain amount of time.<span class="intersentencespace"></span> This is especially appropriate on sites containing sensitive information, such as banking and financial trading accounts.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-1">↑</a></li>
    <li id="_cha-8_footnote-2">Image from <a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/" target="_blank">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-2">↑</a></li>
    <li id="_cha-8_footnote-3">This choice is based on the <a href="http://railscasts.com/episodes/274-remember-me-reset-password" target="_blank">RailsCast on remember me</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-3">↑</a></li>
    <li id="_cha-8_footnote-4">For more details on the kind of callbacks supported by Active Record, see the <a href="http://guides.rubyonrails.org/v3.2.13/active_record_validations_callbacks.html" target="_blank">discussion of callbacks at the Rails Guides</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-4">↑</a></li>
    <li id="_cha-8_footnote-5">If a method doesn’t need an instance of an object, it should be a class method.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-5">↑</a></li>
    <li id="_cha-8_footnote-6">In fact, the two are exactly equivalent; <code>attr_accessor</code> is merely a convenient way to create just such getter/setter methods automatically.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-6">↑</a></li>
    <li id="_cha-8_footnote-7">Typically, this means assigning to variables that are initially <code>nil</code>, but note that <code>false</code> values will also be overwritten by the <code>||=</code> operator.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-7">↑</a></li>
    <li id="_cha-8_footnote-8">This is an example of <em>memoization</em>, which we discussed before in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-let" class="hyperref">Box&nbsp;<span class="ref">6.3</span></a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-8">↑</a></li>
    <li id="_cha-8_footnote-9">Web browsers can’t actually issue <span class="tt">DELETE</span> requests; Rails fakes it with JavaScript.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-8_footnote-ref-9">↑</a></li>
  </ol>
</div><div id="_cha-updating_showing_and_deleting_users" data-tralics-id="cid52" class="chapter" data-number="9"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="heading hyperref"><span class="number">Chapter 9 </span>Updating, showing, and deleting users</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>In this chapter, we will complete the REST actions for the Users resource (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>) by adding <code>edit</code>, <code>update</code>, <code>index</code>, and <code>destroy</code> actions.<span class="intersentencespace"></span> We’ll start by giving users the ability to update their profiles, which will also provide a natural opportunity to enforce a security model (made possible by the authorization code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>).<span class="intersentencespace"></span> Then we’ll make a listing of all users (also requiring authorization), which will motivate the introduction of sample data and pagination.<span class="intersentencespace"></span> Finally, we’ll add the ability to destroy users, wiping them clear from the database.<span class="intersentencespace"></span> Since we can’t allow just any user to have such dangerous powers, we’ll take care to create a privileged class of administrative users (admins) authorized to delete other users.</p>
<p>To get started, let’s start work on an <code>updating-users</code> topic branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b updating-users
</pre></div></div>
</div>
<div id="_sec-updating_users" data-tralics-id="cid53" class="section" data-number="9.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_users" class="heading hyperref"><span class="number">9.1 </span>Updating users</a></h2>
<p>The pattern for editing user information closely parallels that for creating new users (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>).<span class="intersentencespace"></span> Instead of a <code>new</code> action rendering a view for new users, we have an <code>edit</code> action rendering a view to edit users; instead of <code>create</code> responding to a <span class="tt">POST</span> request, we have an <code>update</code> action responding to a <span class="tt">PATCH</span> request (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-get_etc" class="hyperref">Box&nbsp;<span class="ref">3.3</span></a>).<span class="intersentencespace"></span> The biggest difference is that, while anyone can sign up, only the current user should be able to update their information.<span class="intersentencespace"></span> This means that we need to enforce access control so that only authorized users can edit and update; the authentication machinery from <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a> will allow us to use a <em>before filter</em> to ensure that this is the case.</p>
<div id="_sec-edit_form" data-tralics-id="uid670" class="subsection" data-number="9.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-edit_form" class="heading hyperref"><span class="number">9.1.1 </span>Edit form</a></h3>
<p>We start with the edit form, whose mockup appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-edit_user_mockup" class="hyperref">Figure&nbsp;<span class="ref">9.1</span></a>.<sup id="_cha-9_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-1">1</a></sup><span class="intersentencespace"></span> As usual, we’ll begin with some tests.<span class="intersentencespace"></span> First, note the link to change the Gravatar image; if you poke around the Gravatar site, you’ll see that the page to add or edit images is located at <a href="http://gravatar.com/emails" target="_blank">http://gravatar.com/emails</a>, so we test the <code>edit</code> page for a link with that URL.<sup id="_cha-9_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-2">2</a></sup></p>
<div class="center figure" id="_fig-edit_user_mockup" data-tralics-id="uid673" data-number="9.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/edit_user_mockup_bootstrap.png" alt="images/figures/edit_user_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 9.1: </span><span class="description">A mockup of the user edit page.
</span></div></div>
<p>The tests for the edit user form are analogous to the test for the new user form in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-error_messages_test" class="hyperref">Listing&nbsp;<span class="ref">7.31</span></a> from the <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a> exercises, which added a test for the error message on invalid submission.<span class="intersentencespace"></span> The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_edit_specs" class="hyperref">Listing&nbsp;<span class="ref">9.1</span></a>.</p>
<div class="codelisting" id="_code-user_edit_specs" data-tralics-id="uid674" data-number="9.1"><div class="heading"><span class="number">Listing 9.1:</span> 

<span class="description">Tests for the user edit page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"page"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">"Update your profile"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s2">"Edit user"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="s1">'http://gravatar.com/emails'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Save changes"</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To write the application code, we need to fill in the <code>edit</code> action in the Users controller.<span class="intersentencespace"></span> Note from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a> that the proper URL for a user’s edit page is /users/1/edit (assuming the user’s id is&nbsp;<span class="tt">1</span>).<span class="intersentencespace"></span> Recall that the id of the user is available in the <code>params[:id]</code> variable, which means that we can find the user with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_edit_action" class="hyperref">Listing&nbsp;<span class="ref">9.2</span></a>.</p>
<div class="codelisting" id="_code-initial_edit_action" data-tralics-id="uid675" data-number="9.2"><div class="heading"><span class="number">Listing 9.2:</span> 

<span class="description">The user <code>edit</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Getting the tests to pass requires making the actual edit view, shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_edit_view" class="hyperref">Listing&nbsp;<span class="ref">9.3</span></a>.<span class="intersentencespace"></span> Note how closely this resembles the new user view from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a>; the large overlap suggests factoring the repeated code into a partial, which is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).</p>
<div class="codelisting" id="_code-user_edit_view" data-tralics-id="uid676" data-number="9.3"><div class="heading"><span class="number">Listing 9.3:</span> 

<span class="description">The user edit view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirm Password"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Save changes"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Here we have reused the shared <code>error_messages</code> partial introduced in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_error_messages" class="hyperref">Section&nbsp;<span class="ref">7.3.3</span></a>.</p>
<p>With the <code>@user</code> instance variable from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_edit_action" class="hyperref">Listing&nbsp;<span class="ref">9.2</span></a>, the edit page tests from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_edit_specs" class="hyperref">Listing&nbsp;<span class="ref">9.1</span></a> should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">"edit page"</span>
</pre></div></div>
<p>The corresponding page appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>, which shows how Rails automatically pre-fills the Name and Email fields using the attributes of the <code>@user</code> variable.</p>
<div class="center figure" id="_fig-edit_page" data-tralics-id="uid677" data-number="9.2">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/edit_page_bootstrap.png" alt="images/figures/edit_page_bootstrap"></div><div class="caption"><span class="header">Figure 9.2: </span><span class="description">The initial user edit page with pre-filled name &amp; email.
</span></div></div>
<p>Looking at the HTML source for <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>, we see a form tag as expected (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-edit_form_html" class="hyperref">Listing&nbsp;<span class="ref">9.4</span></a>).</p>
<div class="codelisting" id="_code-edit_form_html" data-tralics-id="uid678" data-number="9.4"><div class="heading"><span class="number">Listing 9.4:</span> 

<span class="description">HTML for the edit form defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_edit_view" class="hyperref">Listing&nbsp;<span class="ref">9.3</span></a> and shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/users/1"</span> <span class="na">class=</span><span class="s">"edit_user"</span> <span class="na">id=</span><span class="s">"edit_user_1"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div><p>Note here the hidden input field</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>Since web browsers can’t natively send <span class="tt">PATCH</span> requests (as required by the REST conventions from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>), Rails fakes it with a <span class="tt">POST</span> request and a hidden <code>input</code> field.<sup id="_cha-9_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-3">3</a></sup></p>
<p>There’s another subtlety to address here: the code <code>form_for(@user)</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_edit_view" class="hyperref">Listing&nbsp;<span class="ref">9.3</span></a> is <em>exactly</em> the same as the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a>—so how does Rails know to use a <span class="tt">POST</span> request for new users and a <span class="tt">PATCH</span> for editing users?<span class="intersentencespace"></span> The answer is that it is possible to tell whether a user is new or already exists in the database via Active Record’s <code>new_record?</code> boolean method:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>When constructing a form using <code>form_for(@user)</code>, Rails uses <span class="tt">POST</span> if <code>@user.new_record?</code> is <code>true</code> and <span class="tt">PATCH</span> if it is <code>false</code>.</p>
<p>As a final touch, we’ll add a URL to the user settings link to the site navigation.<span class="intersentencespace"></span> Since it depends on the signin status of the user, the test for the “Settings” link belongs with the other authentication tests, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-settings_link_test" class="hyperref">Listing&nbsp;<span class="ref">9.5</span></a>.<span class="intersentencespace"></span> (It would be nice to have additional tests verifying that such links <em>don’t</em> appear for users who aren’t signed in; writing these tests is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).)</p>
<div class="codelisting" id="_code-settings_link_test" data-tralics-id="uid680" data-number="9.5"><div class="heading"><span class="number">Listing 9.5:</span> 

<span class="description">Adding a test for the “Settings” link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span>     <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Settings'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>For convenience, the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-settings_link_test" class="hyperref">Listing&nbsp;<span class="ref">9.5</span></a> uses a helper to sign in a user inside the tests.<span class="intersentencespace"></span> The method is to visit the signin page and submit valid information, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_helper" class="hyperref">Listing&nbsp;<span class="ref">9.6</span></a>.</p>
<div class="codelisting" id="_code-sign_in_helper" data-tralics-id="uid681" data-number="9.6"><div class="heading"><span class="number">Listing 9.6:</span> 

<span class="description">A test helper to sign users in.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/support/utilities.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
  <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:no_capybara</span><span class="o">]</span>
    <span class="c1"># Sign in when not using Capybara.</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">else</span>
    <span class="n">visit</span> <span class="n">signin_path</span>
    <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
    <span class="n">click_button</span> <span class="s2">"Sign in"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As noted in the comment line, filling in the form doesn’t work when not using Capybara, so to cover this case we allow the user to pass the option <code>no_capybara: true</code> to override the default signin method and manipulate the cookies directly.<span class="intersentencespace"></span> This is necessary when using one of the HTTP request methods directly (<code>get</code>, <code>post</code>, <code>patch</code>, or <code>delete</code>), as we’ll see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-delete_destroy_test" class="hyperref">Listing&nbsp;<span class="ref">9.45</span></a>.<span class="intersentencespace"></span> (Note that the test <code>cookies</code> object isn’t a perfect simulation of the real cookies object; in particular, the <code>cookies.permanent</code> method seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_function" class="hyperref">Listing&nbsp;<span class="ref">8.19</span></a> doesn’t work inside tests.)<span class="intersentencespace"></span> As you might suspect, the <code>sign_in</code> method will prove useful in future tests, and in fact it can already be used to eliminate some duplication (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).</p>
<p>The application code to add the URL for the “Settings” link is simple: we just use the named route <code>edit_user_path</code> from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>, together with the handy <code>current_user</code> helper method defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_working" class="hyperref">Listing&nbsp;<span class="ref">8.22</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The full application code appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-settings_link" class="hyperref">Listing&nbsp;<span class="ref">9.7</span></a>).</p>
<div class="codelisting" id="_code-settings_link" data-tralics-id="uid682" data-number="9.7"><div class="heading"><span class="number">Listing 9.7:</span> 

<span class="description">Adding a “Settings” link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"fat-menu"</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div></div>
<div id="_sec-unsuccessful_edits" data-tralics-id="uid683" class="subsection" data-number="9.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-unsuccessful_edits" class="heading hyperref"><span class="number">9.1.2 </span>Unsuccessful edits</a></h3>
<p>In this section we’ll handle unsuccessful edits and get the error messages test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_edit_specs" class="hyperref">Listing&nbsp;<span class="ref">9.1</span></a> to pass.<span class="intersentencespace"></span> The application code creates an <code>update</code> action that uses <code>update_attributes</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.5</span></a>) to update the user based on the submitted <code>params</code> hash, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_update_action_unsuccessful" class="hyperref">Listing&nbsp;<span class="ref">9.8</span></a>.<span class="intersentencespace"></span> With invalid information, the update attempt returns <code>false</code>, so the <code>else</code> branch re-renders the edit page.<span class="intersentencespace"></span> We’ve seen this pattern before; the structure closely parallels the first version of the <code>create</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-first_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.21</span></a>).</p>
<div class="codelisting" id="_code-user_update_action_unsuccessful" data-tralics-id="uid684" data-number="9.8"><div class="heading"><span class="number">Listing 9.8:</span> 

<span class="description">The initial user <code>update</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="c1"># Handle a successful update.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note the use of <code>user_params</code> in the call to <code>update_attributes</code>, which uses strong parameters to prevent mass assignment vulnerability (as described in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strong_parameters" class="hyperref">Section&nbsp;<span class="ref">7.3.2</span></a>).</p>
<p>The resulting error message (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-edit_with_invalid_information" class="hyperref">Figure&nbsp;<span class="ref">9.3</span></a>) is the one needed to get the error message test to pass, as you should verify by running the test suite:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<div class="center figure" id="_fig-edit_with_invalid_information" data-tralics-id="uid685" data-number="9.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/edit_with_invalid_information_bootstrap.png" alt="images/figures/edit_with_invalid_information_bootstrap"></div><div class="caption"><span class="header">Figure 9.3: </span><span class="description">Error message from submitting the update form.
</span></div></div>
</div>
<div id="_sec-successful_edits" data-tralics-id="uid686" class="subsection" data-number="9.1.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-successful_edits" class="heading hyperref"><span class="number">9.1.3 </span>Successful edits</a></h3>
<p>Now it’s time to get the edit form to work.<span class="intersentencespace"></span> Editing the profile images is already functional since we’ve outsourced image upload to Gravatar; we can edit gravatars by clicking on the “change” link from <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-gravatar_cropper" class="hyperref">Figure&nbsp;<span class="ref">9.4</span></a>.<span class="intersentencespace"></span> Let’s get the rest of the user edit functionality working as well.</p>
<div class="center figure" id="_fig-gravatar_cropper" data-tralics-id="uid687" data-number="9.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/gravatar_cropper.png" alt="images/figures/gravatar_cropper"></div><div class="caption"><span class="header">Figure 9.4: </span><span class="description">The <a href="http://gravatar.com/" target="_blank">Gravatar</a> image-cropping interface, with a picture of <a href="http://michaelhartl.com/" target="_blank">some dude</a>.
</span></div></div>
<p>The tests for the <code>update</code> action are similar to those for <code>create</code>.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_update_specs" class="hyperref">Listing&nbsp;<span class="ref">9.9</span></a> shows how to use Capybara to fill in the form fields with valid information and then test that the resulting behavior is correct.<span class="intersentencespace"></span> This is a lot of code; see if you can work through it by referring back to the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>.</p>
<div class="codelisting" id="_code-user_update_specs" data-tralics-id="uid688" data-number="9.9"><div class="heading"><span class="number">Listing 9.9:</span> 

<span class="description">Tests for the user <code>update</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_name</span><span class="p">)</span>  <span class="p">{</span> <span class="s2">"New Name"</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"new@example.com"</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">"Name"</span><span class="p">,</span>             <span class="ss">with</span><span class="p">:</span> <span class="n">new_name</span>
        <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>            <span class="ss">with</span><span class="p">:</span> <span class="n">new_email</span>
        <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span>         <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">fill_in</span> <span class="s2">"Confirm Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">"Save changes"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.alert.alert-success'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span>  <span class="n">eq</span> <span class="n">new_name</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">new_email</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_update_specs" class="hyperref">Listing&nbsp;<span class="ref">9.9</span></a> adds the <code>sign_in</code> method from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_helper" class="hyperref">Listing&nbsp;<span class="ref">9.6</span></a> to the <code>before</code> block, which is required for the “Sign out” link test to pass, and also anticipates protecting the <code>edit</code> action from non-signed-in users (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-requiring_signed_in_users" class="hyperref">Section&nbsp;<span class="ref">9.2.1</span></a>).</p>
<p>The only real novelty in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_update_specs" class="hyperref">Listing&nbsp;<span class="ref">9.9</span></a> is the <code>reload</code> method, which appears in the test for changing the user’s attributes:</p>
<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span>  <span class="n">eq</span> <span class="n">new_name</span> <span class="p">}</span>
<span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">new_email</span> <span class="p">}</span>
</pre></div></div>
<p>This reloads the <code>user</code> variable from the test database using <code>user.reload</code>, and then verifies that the user’s new name and email match the new values.</p>
<p>The <code>update</code> action needed to get the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_update_specs" class="hyperref">Listing&nbsp;<span class="ref">9.9</span></a> to pass is similar to the final form of the <code>create</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signin_upon_signup" class="hyperref">Listing&nbsp;<span class="ref">8.27</span></a>), as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_update_action" class="hyperref">Listing&nbsp;<span class="ref">9.10</span></a>.<span class="intersentencespace"></span> All this does is add</p>
<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
<span class="n">redirect_to</span> <span class="vi">@user</span>
</pre></div></div>
<p>to the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_update_action_unsuccessful" class="hyperref">Listing&nbsp;<span class="ref">9.8</span></a>.</p>
<div class="codelisting" id="_code-user_update_action" data-tralics-id="uid689" data-number="9.10"><div class="heading"><span class="number">Listing 9.10:</span> 

<span class="description">The user <code>update</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, as currently constructed, every edit requires the user to reconfirm the password (as implied by the empty confirmation text box in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-edit_page" class="hyperref">Figure&nbsp;<span class="ref">9.2</span></a>), which is a minor annoyance but is easier to code and decreases the likelihood of submitting a password with a typo.</p>
<p>With the code in this section, the user edit page should be working, as you can double-check by re-running the test suite, which should now be green:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div>
<div id="_sec-authorization" data-tralics-id="cid54" class="section" data-number="9.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-authorization" class="heading hyperref"><span class="number">9.2 </span>Authorization</a></h2>
<p>One nice effect of building the authentication machinery in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a> is that we are now in a position to implement authorization as well: <em>authentication</em> allows us to identify users of our site, and <em>authorization</em> lets us control what they can do.</p>
<p>Although the edit and update actions from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_users" class="hyperref">Section&nbsp;<span class="ref">9.1</span></a> are functionally complete, they suffer from a ridiculous security flaw: they allow anyone (even non-signed-in users) to access either action, and any signed-in user can update the information for any other user.<span class="intersentencespace"></span> In this section, we’ll implement a security model that requires users to be signed in and prevents them from updating any information other than their own.<span class="intersentencespace"></span> Users who aren’t signed in and who try to access protected pages will be forwarded to the signin page with a helpful message, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-signin_page_protected_mockup" class="hyperref">Figure&nbsp;<span class="ref">9.5</span></a>.</p>
<div class="center figure" id="_fig-signin_page_protected_mockup" data-tralics-id="uid690" data-number="9.5">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/signin_page_protected_mockup_bootstrap.png" alt="images/figures/signin_page_protected_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 9.5: </span><span class="description">A mockup of the result of visiting a protected page
</span></div></div>
<div id="_sec-requiring_signed_in_users" data-tralics-id="uid691" class="subsection" data-number="9.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-requiring_signed_in_users" class="heading hyperref"><span class="number">9.2.1 </span>Requiring signed-in users</a></h3>
<p>Since the security restrictions for the <code>edit</code> and <code>update</code> actions are identical, we’ll handle them in a single RSpec <code>describe</code> block.<span class="intersentencespace"></span> Starting with the sign-in requirement, our initial tests verify that non-signed-in users attempting to access either action are simply sent to the signin page, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-protected_edit_update_tests" class="hyperref">Listing&nbsp;<span class="ref">9.11</span></a>.</p>
<div class="codelisting" id="_code-protected_edit_update_tests" data-tralics-id="uid692" data-number="9.11"><div class="heading"><span class="number">Listing 9.11:</span> 

<span class="description">Testing that the <code>edit</code> and <code>update</code> actions are protected.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"in the Users controller"</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">"visiting the edit page"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"submitting to the update action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-protected_edit_update_tests" class="hyperref">Listing&nbsp;<span class="ref">9.11</span></a> introduces a second way, apart from Capybara’s <code>visit</code> method, to access a controller action: by issuing the appropriate HTTP request directly, in this case using the <code>patch</code> method to issue a <span class="tt">PATCH</span> request:</p>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">"submitting to the update action"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>This issues a <span class="tt">PATCH</span> request directly to <code>/users/1</code>, which gets routed to the <code>update</code> action of the Users controller (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>).<span class="intersentencespace"></span> This is necessary because there is no way for a browser to visit the <code>update</code> action directly—it can only get there indirectly by submitting the edit form—so Capybara can’t do it either.<span class="intersentencespace"></span> But visiting the edit page only tests the authorization for the <code>edit</code> action, not for <code>update</code>.<span class="intersentencespace"></span> As a result, the only way to test the proper authorization for the <code>update</code> action itself is to issue a direct request.<span class="intersentencespace"></span> (As you might guess, in addition to <code>patch</code> Rails tests support <code>get</code>, <code>post</code>, and <code>delete</code> as well.)</p>
<p>When using one of the methods to issue HTTP requests directly, we get access to the low-level <code>response</code> object.<span class="intersentencespace"></span> Unlike the Capybara <code>page</code> object, <code>response</code> lets us test for the server response itself, in this case verifying that the <code>update</code> action responds by redirecting to the signin page:</p>
<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>The authorization application code uses a <em>before filter</em>, which uses the <code>before_action</code> command to arrange for a particular method to be called before the given actions.<span class="intersentencespace"></span> (The command for before filters used to be called <code>before_filter</code>, but the Rails core team decided to rename it to emphasize that the filter takes place before particular controller actions.)<span class="intersentencespace"></span> To require users to be signed in, we define a <code>signed_in_user</code> method and invoke it using <code>before_action :signed_in_user</code>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authorize_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.12</span></a>.</p>
<div class="codelisting" id="_code-authorize_before_filter" data-tralics-id="uid693" data-number="9.12"><div class="heading"><span class="number">Listing 9.12:</span> 

<span class="description">Adding a <code>signed_in_user</code> before filter.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Please sign in."</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>By default, before filters apply to <em>every</em> action in a controller, so here we restrict the filter to act only on the <code>:edit</code> and <code>:update</code> actions by passing the appropriate <code>:only</code> options hash.</p>
<p>Note that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authorize_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.12</span></a> uses a shortcut for setting <code>flash[:notice]</code> by passing an options hash to the <code>redirect_to</code> function.<span class="intersentencespace"></span> The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authorize_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.12</span></a> is equivalent to the more verbose</p>
<div class="code"><div class="highlight"><pre><span class="k">unless</span> <span class="n">signed_in?</span>
  <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please sign in."</span>
  <span class="n">redirect_to</span> <span class="n">signin_url</span>
<span class="k">end</span>
</pre></div></div>
<p>(Unfortunately, the same construction doesn’t work for the <code>:error</code> or <code>:success</code> keys.)</p>
<p>Together with <code>:success</code> and <code>:error</code>, the <code>:notice</code> key completes our triumvirate of <code>flash</code> styles, all of which are supported natively by Bootstrap CSS. By signing out and attempting to access the user edit page <a href="http://localhost:3000/users/1/edit" target="_blank">/users/1/edit</a>, we can see the resulting yellow “notice” box, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-protected_sign_in" class="hyperref">Figure&nbsp;<span class="ref">9.6</span></a>.</p>
<div class="center figure" id="_fig-protected_sign_in" data-tralics-id="uid694" data-number="9.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/protected_sign_in_bootstrap.png" alt="images/figures/protected_sign_in_bootstrap"></div><div class="caption"><span class="header">Figure 9.6: </span><span class="description">The signin form after trying to access a protected page.
</span></div></div>
<p>At this point, our test suite should be green:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-requiring_the_right_user" data-tralics-id="uid695" class="subsection" data-number="9.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-requiring_the_right_user" class="heading hyperref"><span class="number">9.2.2 </span>Requiring the right user</a></h3>
<p>Of course, requiring users to sign in isn’t quite enough; users should only be allowed to edit their <em>own</em> information.<span class="intersentencespace"></span> We can test for this by first signing in as an incorrect user and then hitting the <code>edit</code> and <code>update</code> actions (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-edit_update_wrong_user_tests" class="hyperref">Listing&nbsp;<span class="ref">9.13</span></a>).<span class="intersentencespace"></span> Note that, because we’re not using Capybara for these tests (<code>no_capybara: true</code>), we use the <code>get</code> and <code>patch</code> methods to hit the <code>edit</code> and <code>update</code> actions directly.<span class="intersentencespace"></span> In addition, because users should never even <em>try</em> to edit another user’s profile, upon detecting unauthorized access we redirect to the root URL rather than to the signin page.</p>
<div class="codelisting" id="_code-edit_update_wrong_user_tests" data-tralics-id="uid696" data-number="9.13"><div class="heading"><span class="number">Listing 9.13:</span> 

<span class="description">Testing that the <code>edit</code> and <code>update</code> actions require the right user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"as wrong user"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:wrong_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"wrong@example.com"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="ss">no_capybara</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"submitting a GET request to the Users#edit action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">match</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"submitting a PATCH request to the Users#update action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note here that a factory can take an option:</p>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"wrong@example.com"</span><span class="p">)</span>
</pre></div></div>
<p>This creates a user with a different email address from the default.<span class="intersentencespace"></span> The tests specify that the original user should not have access to the wrong user’s <code>edit</code> or <code>update</code> actions.</p>
<p>The application code adds a second before filter to call the <code>correct_user</code> method, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-correct_user_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.14</span></a>.</p>
<div class="codelisting" id="_code-correct_user_before_filter" data-tralics-id="uid697" data-number="9.14"><div class="heading"><span class="number">Listing 9.14:</span> 

<span class="description">A <code>correct_user</code> before filter to protect the edit/update pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Please sign in."</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The <code>correct_user</code> filter uses the <code>current_user?</code> boolean method, which we define in the Sessions helper (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-current_user_p" class="hyperref">Listing&nbsp;<span class="ref">9.15</span></a>).</p>
<div class="codelisting" id="_code-current_user_p" data-tralics-id="uid698" data-number="9.15"><div class="heading"><span class="number">Listing 9.15:</span> 

<span class="description">The <code>current_user?</code> method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">remember_token</span><span class="p">:</span> <span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-correct_user_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.14</span></a> also shows the updated <code>edit</code> and <code>update</code> actions.<span class="intersentencespace"></span> Before, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_edit_action" class="hyperref">Listing&nbsp;<span class="ref">9.2</span></a>, we had</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>and similarly for <code>update</code>.<span class="intersentencespace"></span> Now that the <code>correct_user</code> before filter defines <code>@user</code>, we can omit it from both actions.</p>
<p>Before moving on, you should verify that the test suite passes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-friendly_forwarding" data-tralics-id="uid699" class="subsection" data-number="9.2.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-friendly_forwarding" class="heading hyperref"><span class="number">9.2.3 </span>Friendly forwarding</a></h3>
<p>Our site authorization is complete as written, but there is one minor blemish: when users try to access a protected page, they are currently redirected to their profile pages regardless of where they were trying to go.<span class="intersentencespace"></span> In other words, if a non-logged-in user tries to visit the edit page, after signing in the user will be redirected to /users/1 instead of /users/1/edit.<span class="intersentencespace"></span> It would be much friendlier to redirect them to their intended destination instead.</p>
<p>To test for such “friendly forwarding”, we first visit the user edit page, which redirects to the signin page.<span class="intersentencespace"></span> We then enter valid signin information and click the “Sign in” button.<span class="intersentencespace"></span> The resulting page, which by default is the user’s profile, should in this case be the “Edit user” page.<span class="intersentencespace"></span> The test for this sequence appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-friendly_forwarding_test" class="hyperref">Listing&nbsp;<span class="ref">9.16</span></a>.</p>
<div class="codelisting" id="_code-friendly_forwarding_test" data-tralics-id="uid700" data-number="9.16"><div class="heading"><span class="number">Listing 9.16:</span> 

<span class="description">A test for friendly forwarding.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"when attempting to visit a protected page"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">"Sign in"</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"after signing in"</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">"should render the desired protected page"</span> <span class="k">do</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Now for the implementation.<sup id="_cha-9_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-4">4</a></sup><span class="intersentencespace"></span> In order to forward users to their intended destination, we need to store the location of the requested page somewhere, and then redirect to that location instead.<span class="intersentencespace"></span> We accomplish this with a pair of methods, <code>store_location</code> and <code>redirect_back_or</code>, both defined in the Sessions helper (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-friendly_forwarding_code" class="hyperref">Listing&nbsp;<span class="ref">9.17</span></a>).</p>
<div class="codelisting" id="_code-friendly_forwarding_code" data-tralics-id="uid702" data-number="9.17"><div class="heading"><span class="number">Listing 9.17:</span> 

<span class="description">Code to implement friendly forwarding.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:return_to</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">store_location</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">get?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The storage mechanism is the <code>session</code> facility provided by Rails, which you can think of as being like an instance of the <code>cookies</code> variable from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a> that automatically expires upon browser close.<span class="intersentencespace"></span> We also use the <code>request</code> object to get the <code>url</code>, i.e., the URL of the requested page.<span class="intersentencespace"></span> The <code>store_location</code> method puts the requested URL in the <code>session</code> variable under the key <code>:return_to</code>, but only for a <code>GET</code> request (<code>if request.get?</code>).<span class="intersentencespace"></span> This prevents storing the forwarding URL if a user, say, submits a form when not logged in (which is an edge case but could happen if, e.g., a user deleted the remember token by hand before submitting the form); in this case, the resulting redirect would issue a <code>GET</code> request to a URL expecting <code>POST</code>, <code>PATCH</code>, or <code>DELETE</code>, thereby causing an error.<sup id="_cha-9_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-5">5</a></sup></p>
<p>To make use of <code>store_location</code>, we need to add it to the <code>signed_in_user</code> before filter, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-add_store_location" class="hyperref">Listing&nbsp;<span class="ref">9.18</span></a>.</p>
<div class="codelisting" id="_code-add_store_location" data-tralics-id="uid704" data-number="9.18"><div class="heading"><span class="number">Listing 9.18:</span> 

<span class="description">Adding <code>store_location</code> to the signed-in user before filter.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="k">unless</span> <span class="n">signed_in?</span>
        <span class="n">store_location</span>
        <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Please sign in."</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To implement the forwarding itself, we use the <code>redirect_back_or</code> method to redirect to the requested URL if it exists, or some default URL otherwise, which we add to the Sessions controller <code>create</code> action to redirect after successful signin (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-friendly_session_create" class="hyperref">Listing&nbsp;<span class="ref">9.19</span></a>).<span class="intersentencespace"></span> The <code>redirect_back_or</code> method uses the or operator&nbsp;<code>||</code> through</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span>
</pre></div></div>
<p>This evaluates to <code>session[:return_to]</code> unless it’s <code>nil</code>, in which case it evaluates to the given default URL. Note that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-friendly_forwarding_code" class="hyperref">Listing&nbsp;<span class="ref">9.17</span></a> is careful to remove the forwarding URL; otherwise, subsequent signin attempts would forward to the protected page until the user closed their browser.<span class="intersentencespace"></span> (Testing for this is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).)</p>
<div class="codelisting" id="_code-friendly_session_create" data-tralics-id="uid705" data-number="9.19"><div class="heading"><span class="number">Listing 9.19:</span> 

<span class="description">The Sessions <code>create</code> action with friendly forwarding.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_back_or</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>(If you completed the first exercise in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>, be sure to use the proper <code>params</code> hash in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-friendly_session_create" class="hyperref">Listing&nbsp;<span class="ref">9.19</span></a>.)</p>
<p>With that, the friendly forwarding integration test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-friendly_forwarding_test" class="hyperref">Listing&nbsp;<span class="ref">9.16</span></a> should pass, and the basic user authentication and page protection implementation is complete.<span class="intersentencespace"></span> As usual, it’s a good idea to verify that the test suite is green before proceeding:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div>
<div id="_sec-showing_all_users" data-tralics-id="cid55" class="section" data-number="9.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_all_users" class="heading hyperref"><span class="number">9.3 </span>Showing all users</a></h2>
<p>In this section, we’ll add the <a href="http://www.answers.com/penultimate" target="_blank">penultimate</a> user action, the <code>index</code> action, which is designed to display <em>all</em> the users instead of just one.<span class="intersentencespace"></span> Along the way, we’ll learn about populating the database with sample users and <em>paginating</em> the user output so that the index page can scale up to display a potentially large number of users.<span class="intersentencespace"></span> A mockup of the result—users, pagination links, and a “Users” navigation link—appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_index_mockup" class="hyperref">Figure&nbsp;<span class="ref">9.7</span></a>.<sup id="_cha-9_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-6">6</a></sup><span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-destroying_users" class="hyperref">Section&nbsp;<span class="ref">9.4</span></a>, we’ll add an administrative interface to the user index so that (presumably troublesome) users can be destroyed.</p>
<div class="center figure" id="_fig-user_index_mockup" data-tralics-id="uid707" data-number="9.7">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_index_mockup_bootstrap.png" alt="images/figures/user_index_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 9.7: </span><span class="description">A mockup of the user index, with pagination and a “Users” nav link.
</span></div></div>
<div id="_sec-user_index" data-tralics-id="uid708" class="subsection" data-number="9.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_index" class="heading hyperref"><span class="number">9.3.1 </span>User index</a></h3>
<p>Although we’ll keep individual user <code>show</code> pages visible to all site visitors, the user <code>index</code> will be restricted to signed-in users so that there’s a limit to how much unregistered users can see by default.<span class="intersentencespace"></span> We’ll start by testing that the <code>index</code> action is protected by visiting the <code>users_path</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>) and verifying that we are redirected to the signin page.<span class="intersentencespace"></span> As with other authorization tests, we’ll put this example in the authentication integration test, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-protected_index_test" class="hyperref">Listing&nbsp;<span class="ref">9.20</span></a>.</p>
<div class="codelisting" id="_code-protected_index_test" data-tralics-id="uid709" data-number="9.20"><div class="heading"><span class="number">Listing 9.20:</span> 

<span class="description">Testing that the <code>index</code> action is protected.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"in the Users controller"</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">"visiting the user index"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">users_path</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The corresponding application code simply involves adding <code>index</code> to the list of actions protected by the <code>signed_in_user</code> before filter, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signed_in_user_index" class="hyperref">Listing&nbsp;<span class="ref">9.21</span></a>.</p>
<div class="codelisting" id="_code-signed_in_user_index" data-tralics-id="uid710" data-number="9.21"><div class="heading"><span class="number">Listing 9.21:</span> 

<span class="description">Requiring a signed-in user for the <code>index</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The next set of tests makes sure that, for signed-in users, the index page has the right title/content and lists all of the site’s users.<span class="intersentencespace"></span> The method is to make three factory users (signing in as the first one) and then verify that the index page has a list element (<code>li</code>) tag for the name of each one.<span class="intersentencespace"></span> Note that we’ve taken care to give the users different names so that each element in the list of users has a unique entry, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_index_tests" class="hyperref">Listing&nbsp;<span class="ref">9.22</span></a>.</p>
<div class="codelisting" id="_code-user_index_tests" data-tralics-id="uid711" data-number="9.22"><div class="heading"><span class="number">Listing 9.22:</span> 

<span class="description">Tests for the user index page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Bob"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"bob@example.com"</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Ben"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"ben@example.com"</span><span class="p">)</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"should list each user"</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'li'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>As you may recall from the corresponding action in the demo app (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-demo_index_action" class="hyperref">Listing&nbsp;<span class="ref">2.4</span></a>), the application code uses <code>User.all</code> to pull all the users out of the database, assigning them to an <code>@users</code> instance variable for use in the view, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_index" class="hyperref">Listing&nbsp;<span class="ref">9.23</span></a>.<span class="intersentencespace"></span> (If displaying all the users at once seems like a bad idea, you’re right, and we’ll remove this blemish in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pagination" class="hyperref">Section&nbsp;<span class="ref">9.3.3</span></a>.)</p>
<div class="codelisting" id="_code-user_index" data-tralics-id="uid712" data-number="9.23"><div class="heading"><span class="number">Listing 9.23:</span> 

<span class="description">The user <code>index</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To make the actual index page, we need to make a view that iterates through the users and wraps each one in an&nbsp;<code>li</code> tag.<span class="intersentencespace"></span> We do this with the <code>each</code> method, displaying each user’s Gravatar and name, while wrapping the whole thing in an unordered list (<code>ul</code>) tag (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.24</span></a>).<span class="intersentencespace"></span> The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.24</span></a> uses the result of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gravatar_option" class="hyperref">Listing&nbsp;<span class="ref">7.30</span></a> from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_exercises" class="hyperref">Section&nbsp;<span class="ref">7.6</span></a>, which allows us to pass an option to the Gravatar helper specifying a size other than the default.<span class="intersentencespace"></span> If you didn’t do that exercise, update your Users helper file with the contents of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gravatar_option" class="hyperref">Listing&nbsp;<span class="ref">7.30</span></a> before proceeding.</p>
<div class="codelisting" id="_code-user_index_view" data-tralics-id="uid713" data-number="9.24"><div class="heading"><span class="number">Listing 9.24:</span> 

<span class="description">The user index view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div></div></div><p>Let’s also add a little CSS (or, rather, SCSS) for style (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_index_css" class="hyperref">Listing&nbsp;<span class="ref">9.25</span></a>).</p>
<div class="codelisting" id="_code-user_index_css" data-tralics-id="uid714" data-number="9.25"><div class="heading"><span class="number">Listing 9.25:</span> 

<span class="description">CSS for the user index.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">Users</span> <span class="nt">index</span> <span class="o">*/</span>

<span class="nc">.users</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:last-child</span> <span class="p">{</span>
      <span class="na">border-bottom</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div><p>Finally, we’ll add the URL to the users link in the site’s navigation header using <code>users_path</code>, thereby using the last of the unused named routes in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>.<span class="intersentencespace"></span> The test (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_link_test" class="hyperref">Listing&nbsp;<span class="ref">9.26</span></a>) and application code (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_link" class="hyperref">Listing&nbsp;<span class="ref">9.27</span></a>) are both straightforward.</p>
<div class="codelisting" id="_code-users_link_test" data-tralics-id="uid715" data-number="9.26"><div class="heading"><span class="number">Listing 9.26:</span> 

<span class="description">A test for the “Users” link URL. <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Users'</span><span class="p">,</span>       <span class="ss">href</span><span class="p">:</span> <span class="n">users_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Profile'</span><span class="p">,</span>     <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Settings'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign out'</span><span class="p">,</span>    <span class="ss">href</span><span class="p">:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-users_link" data-tralics-id="uid716" data-number="9.27"><div class="heading"><span class="number">Listing 9.27:</span> 

<span class="description">Adding the URL to the users link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-inner"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav pull-right"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"fat-menu"</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign out"</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in"</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div><p>With that, the user index is fully functional, with all tests passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>On the other hand, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_index_only_one" class="hyperref">Figure&nbsp;<span class="ref">9.8</span></a>, it is a bit…lonely.<span class="intersentencespace"></span> Let’s remedy this sad situation.</p>
<div class="center figure" id="_fig-user_index_only_one" data-tralics-id="uid717" data-number="9.8">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_index_only_one_bootstrap.png" alt="images/figures/user_index_only_one_bootstrap"></div><div class="caption"><span class="header">Figure 9.8: </span><span class="description">The user index page <a href="http://localhost:3000/users" target="_blank">/users</a> with only one user.
</span></div></div>
</div>
<div id="_sec-sample_users" data-tralics-id="uid718" class="subsection" data-number="9.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_users" class="heading hyperref"><span class="number">9.3.2 </span>Sample users</a></h3>
<p>In this section, we’ll give our lonely sample user some company.<span class="intersentencespace"></span> Of course, to create enough users to make a decent user index, we <em>could</em> use our web browser to visit the signup page and make the new users one by one, but far a better solution is to use Ruby (and Rake) to make the users for us.</p>
<p>First, we’ll add the <em>Faker</em> gem to the <code>Gemfile</code>, which will allow us to make sample users with semi-realistic names and email addresses (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-faker_gemfile" class="hyperref">Listing&nbsp;<span class="ref">9.28</span></a>).</p>
<div class="codelisting" id="_code-faker_gemfile" data-tralics-id="uid719" data-number="9.28"><div class="heading"><span class="number">Listing 9.28:</span> 

<span class="description">Adding the Faker gem to the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'sprockets'</span><span class="p">,</span> <span class="s1">'2.11.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.1.2'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then install as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>Next, we’ll add a Rake task to create sample users.<span class="intersentencespace"></span> Rake tasks live in the <code>lib/tasks</code> directory, and are defined using <em>namespaces</em> (in this case, <code>:db</code>), as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-db_populate" class="hyperref">Listing&nbsp;<span class="ref">9.29</span></a>.<span class="intersentencespace"></span> (This is a bit advanced, so don’t worry too much about the details.)</p>
<div class="codelisting" id="_code-db_populate" data-tralics-id="uid720" data-number="9.29"><div class="heading"><span class="number">Listing 9.29:</span> 

<span class="description">A Rake task for populating the database with sample users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">lib/tasks/sample_data.rake</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span>
                 <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
                 <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                 <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
    <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
      <span class="n">password</span>  <span class="o">=</span> <span class="s2">"password"</span>
      <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
                   <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                   <span class="ss">password</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                   <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This defines a task <code>db:populate</code> that creates an example user with name and email address replicating our previous one, and then makes 99 more.<span class="intersentencespace"></span> The line</p>
<div class="code"><div class="highlight"><pre><span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
</pre></div></div>
<p>ensures that the Rake task has access to the local Rails environment, including the User model (and hence <code>User.create!</code>).<span class="intersentencespace"></span> Here <code>create!</code> is just like the <code>create</code> method, except it raises an exception (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-finding_user_objects" class="hyperref">Section&nbsp;<span class="ref">6.1.4</span></a>) for an invalid user rather than returning <code>false</code>.<span class="intersentencespace"></span> This noisier construction makes debugging easier by avoiding silent errors.</p>
<p>With the <code>:db</code> namespace as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-db_populate" class="hyperref">Listing&nbsp;<span class="ref">9.29</span></a>, we can invoke the Rake task as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>After running the Rake task and restarting the server, we see that our application has 100 sample users (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_index_all" class="hyperref">Figure&nbsp;<span class="ref">9.9</span></a>).<span class="intersentencespace"></span> (I’ve taken the liberty of associating the first few sample addresses with photos so that they’re not all the default Gravatar image.)</p>
<div class="center figure" id="_fig-user_index_all" data-tralics-id="uid721" data-number="9.9">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_index_all_bootstrap.png" alt="images/figures/user_index_all_bootstrap"></div><div class="caption"><span class="header">Figure 9.9: </span><span class="description">The user index page <a href="http://localhost:3000/users" target="_blank">/users</a> with 100 sample users.
</span></div></div>
</div>
<div id="_sec-pagination" data-tralics-id="uid722" class="subsection" data-number="9.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pagination" class="heading hyperref"><span class="number">9.3.3 </span>Pagination</a></h3>
<p>Our original user doesn’t suffer from loneliness any more, but now we have the opposite problem: our user has <em>too many</em> companions, and they all appear on the same page.<span class="intersentencespace"></span> Right now there are a hundred, which is already a reasonably large number, and on a real site it could be thousands.<span class="intersentencespace"></span> The solution is to <em>paginate</em> the users, so that (for example) only 30 show up on a page at any one time.</p>
<p>There are several pagination methods in Rails; we’ll use one of the simplest and most robust, called <a href="http://wiki.github.com/mislav/will_paginate/" target="_blank">will_paginate</a>.<span class="intersentencespace"></span> To use it, we need to include both the <span class="tt">will_paginate</span> gem and <span class="tt">bootstrap-will_paginate</span>, which configures will_paginate to use Bootstrap’s pagination styles.<span class="intersentencespace"></span> The updated <code>Gemfile</code> appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-will_paginate_gem" class="hyperref">Listing&nbsp;<span class="ref">9.30</span></a>.</p>
<div class="codelisting" id="_code-will_paginate_gem" data-tralics-id="uid723" data-number="9.30"><div class="heading"><span class="number">Listing 9.30:</span> 

<span class="description">Including <span class="tt">will_paginate</span> in the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'sprockets'</span><span class="p">,</span> <span class="s1">'2.11.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.1.2'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.9'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then run <code>bundle install</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>You should also restart the web server to ensure that the new gems are loaded properly.</p>
<p>Because the <span class="tt">will_paginate</span> gem is in wide use, there’s no need to test it thoroughly, so we’ll take a lightweight approach.<span class="intersentencespace"></span> First, we’ll test for a <code>div</code> with CSS class “pagination”, which is what gets output by <span class="tt">will_paginate</span>.<span class="intersentencespace"></span> Then we’ll verify that the correct users appear on the first page of results.<span class="intersentencespace"></span> This requires the use of the <code>paginate</code> method, which we’ll cover shortly.</p>
<p>As before, we’ll use Factory Girl to simulate users, but immediately we have a problem: user email addresses must be unique, which would appear to require creating more than 30 users by hand—a terribly cumbersome job.<span class="intersentencespace"></span> In addition, when testing for user listings it would be convenient for them all to have different names.<span class="intersentencespace"></span> Fortunately, Factory Girl anticipates this issue, and provides <em>sequences</em> to solve it.<span class="intersentencespace"></span> Our original factory (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_factory" class="hyperref">Listing&nbsp;<span class="ref">7.8</span></a>) hard-coded the name and email address:</p>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">"Michael Hartl"</span>
    <span class="n">email</span>    <span class="s2">"michael@example.com"</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>Instead, we can arrange for a sequence of names and email addresses using the <code>sequence</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div></div>
<p>Here <code>sequence</code> takes a symbol corresponding to the desired attribute (such as <code>:name</code>) and a block with one variable, which we have called&nbsp;<code>n</code>.<span class="intersentencespace"></span> Upon successive invocations of the <code>FactoryGirl</code> method,</p>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div></div>
<p>The block variable <code>n</code> is automatically incremented, so that the first user has name “Person&nbsp;1” and email address “person_1@example.com”, the second user has name “Person&nbsp;2” and email address “person_2@example.com”, and so on.<span class="intersentencespace"></span> The full
code appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-factory_sequence" class="hyperref">Listing&nbsp;<span class="ref">9.31</span></a>.</p>
<div class="codelisting" id="_code-factory_sequence" data-tralics-id="uid724" data-number="9.31"><div class="heading"><span class="number">Listing 9.31:</span> 

<span class="description">Defining a Factory Girl sequence.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/factories.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Applying the idea of factory sequences, we can make 30 users in our test, which (as we will see) will be sufficient to invoke pagination:</p>
<div class="code"><div class="highlight"><pre><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>
</pre></div></div>
<p>Note here the use of <code>before(:all)</code>, which ensures that the sample users are created <em>once</em>, before all the tests in the block.<span class="intersentencespace"></span> This is an optimization for speed, as creating 30 users can be slow on some systems.<span class="intersentencespace"></span> We use the complementary method <code>after(:all)</code> to delete the users once we’re done.</p>
<p>The tests for the appearance of the pagination <code>div</code> and the right users appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-will_paginate_test" class="hyperref">Listing&nbsp;<span class="ref">9.32</span></a>.<span class="intersentencespace"></span> Note the replacement of the <code>User.all</code> array from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_index_tests" class="hyperref">Listing&nbsp;<span class="ref">9.22</span></a> with <code>User.paginate(page: 1)</code>, which (as we’ll see momentarily) is how to pull out the first page of users from the database.<span class="intersentencespace"></span> Note also that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-will_paginate_test" class="hyperref">Listing&nbsp;<span class="ref">9.32</span></a> uses <code>before(:each)</code> to emphasize the contrast with <code>before(:all)</code>.</p>
<div class="codelisting" id="_code-will_paginate_test" data-tralics-id="uid725" data-number="9.32"><div class="heading"><span class="number">Listing 9.32:</span> 

<span class="description">Tests for pagination.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"pagination"</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
      <span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'div.pagination'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">"should list each user"</span> <span class="k">do</span>
        <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'li'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To get pagination working, we need to add some code to the index view telling Rails to paginate the users, and we need to replace <code>User.all</code> in the <code>index</code> action with an object that knows about pagination.<span class="intersentencespace"></span> We’ll start by adding the special <code>will_paginate</code> method in the view (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-will_paginate_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.33</span></a>); we’ll see in a moment why the code appears both above and below the user list.</p>
<div class="codelisting" id="_code-will_paginate_index_view" data-tralics-id="uid726" data-number="9.33"><div class="heading"><span class="number">Listing 9.33:</span> 

<span class="description">The user index with pagination.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>The <code>will_paginate</code> method is a little magical; inside a <code>users</code> view, it automatically looks for an <code>@users</code> object, and then displays pagination links to access other pages.<span class="intersentencespace"></span> The view in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-will_paginate_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.33</span></a> doesn’t work yet, though, because currently <code>@users</code> contains the results of <code>User.all</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_index" class="hyperref">Listing&nbsp;<span class="ref">9.23</span></a>), whereas <code>will_paginate</code> requires that we paginate the results explicitly using the <code>paginate</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">  User Load (1.5ms)  SELECT "users".* FROM "users" LIMIT 30 OFFSET 0</span>
<span class="go">   (1.7ms)  SELECT COUNT(*) FROM "users"</span>
<span class="go">=&gt; #&lt;ActiveRecord::Relation [#&lt;User id: 1,...</span>
</pre></div></div>
<p>Note that <code>paginate</code> takes a hash argument with key <code>:page</code> and value equal to the page requested.<span class="intersentencespace"></span> <code>User.paginate</code> pulls the users out of the database one chunk at a time (30 by default), based on the <code>:page</code> parameter.<span class="intersentencespace"></span> So, for example, page&nbsp;1 is users 1–30, page&nbsp;2 is users 31–60, etc.<span class="intersentencespace"></span> If the page is <code>nil</code>, <code>paginate</code> simply returns the first page.</p>
<p>Using the <code>paginate</code> method, we can paginate the users in the sample application by using <code>paginate</code> in place of <code>all</code> in the <code>index</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-will_paginate_index_action" class="hyperref">Listing&nbsp;<span class="ref">9.34</span></a>).<span class="intersentencespace"></span> Here the <code>:page</code> parameter comes from <code>params[:page]</code>, which is generated automatically by <code>will_paginate</code>.</p>
<div class="codelisting" id="_code-will_paginate_index_action" data-tralics-id="uid727" data-number="9.34"><div class="heading"><span class="number">Listing 9.34:</span> 

<span class="description">Paginating the users in the <code>index</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The user index page should now be working, appearing as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_index_pagination_rails_3" class="hyperref">Figure&nbsp;<span class="ref">9.10</span></a>.<span class="intersentencespace"></span> (On some systems, you may have to restart the Rails server at this point.)<span class="intersentencespace"></span> Because we included <code>will_paginate</code> both above and below the user list, the pagination links appear in both places.</p>
<div class="center figure" id="_fig-user_index_pagination_rails_3" data-tralics-id="uid728" data-number="9.10">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_index_pagination_rails_3_bootstrap.png" alt="images/figures/user_index_pagination_rails_3_bootstrap"></div><div class="caption"><span class="header">Figure 9.10: </span><span class="description">The user index page <a href="http://localhost:3000/users" target="_blank">/users</a> with pagination.
</span></div></div>
<p>If you now click on either the&nbsp;<a href="http://localhost:3000/users?page=2" target="_blank">2</a> link or <a href="http://localhost:3000/users?page=2" target="_blank">Next</a> link, you’ll get the second page of results, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_index_page_two_rails_3" class="hyperref">Figure&nbsp;<span class="ref">9.11</span></a>.</p>
<div class="center figure" id="_fig-user_index_page_two_rails_3" data-tralics-id="uid729" data-number="9.11">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_index_page_two_rails_3_bootstrap.png" alt="images/figures/user_index_page_two_rails_3_bootstrap"></div><div class="caption"><span class="header">Figure 9.11: </span><span class="description">Page 2 of the user index (<a href="http://localhost:3000/users?page=2" target="_blank">/users?page=2</a>).
</span></div></div>
<p>You should also verify that the tests are passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-partial_refactoring" data-tralics-id="uid730" class="subsection" data-number="9.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-partial_refactoring" class="heading hyperref"><span class="number">9.3.4 </span>Partial refactoring</a></h3>
<p>The paginated user index is now complete, but there’s one improvement I can’t resist including: Rails has some incredibly slick tools for making compact views, and in this section we’ll refactor the index page to use them.<span class="intersentencespace"></span> Because our code is well-tested, we can refactor with confidence, assured that we are unlikely to break our site’s functionality.</p>
<p>The first step in our refactoring is to replace the user&nbsp;<code>li</code> from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-will_paginate_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.33</span></a> with a <code>render</code> call (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-index_view_first_refactoring" class="hyperref">Listing&nbsp;<span class="ref">9.35</span></a>).</p>
<div class="codelisting" id="_code-index_view_first_refactoring" data-tralics-id="uid731" data-number="9.35"><div class="heading"><span class="number">Listing 9.35:</span> 

<span class="description">The first refactoring attempt at the index view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>Here we call <code>render</code> not on a string with the name of a partial, but rather on a <code>user</code> variable of class <code>User</code>;<sup id="_cha-9_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-7">7</a></sup> in this context, Rails automatically looks for a partial called <code>_user.html.erb</code>, which we must create (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_partial" class="hyperref">Listing&nbsp;<span class="ref">9.36</span></a>).</p>
<div class="codelisting" id="_code-user_partial" data-tralics-id="uid733" data-number="9.36"><div class="heading"><span class="number">Listing 9.36:</span> 

<span class="description">A partial to render a single user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_user.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p>This is a definite improvement, but we can do even better: we can call <code>render</code> <em>directly</em> on the <code>@users</code> variable (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-index_final_refactoring" class="hyperref">Listing&nbsp;<span class="ref">9.37</span></a>).</p>
<div class="codelisting" id="_code-index_final_refactoring" data-tralics-id="uid734" data-number="9.37"><div class="heading"><span class="number">Listing 9.37:</span> 

<span class="description">The fully refactored user index.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>Here Rails infers that <code>@users</code> is a list of <code>User</code> objects; moreover, when called with a collection of users, Rails automatically iterates through them and renders each one with the <code>_user.html.erb</code> partial.<span class="intersentencespace"></span> The result is the impressively compact code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-index_final_refactoring" class="hyperref">Listing&nbsp;<span class="ref">9.37</span></a>.<span class="intersentencespace"></span> As with any refactoring, you should verify that the test suite is still green after changing the application code:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div>
<div id="_sec-destroying_users" data-tralics-id="cid56" class="section" data-number="9.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-destroying_users" class="heading hyperref"><span class="number">9.4 </span>Deleting users</a></h2>
<p>Now that the user index is complete, there’s only one canonical REST action left: <code>destroy</code>.<span class="intersentencespace"></span> In this section, we’ll add links to delete users, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_index_delete_links_mockup" class="hyperref">Figure&nbsp;<span class="ref">9.12</span></a>, and define the <code>destroy</code> action necessary to accomplish the deletion.<span class="intersentencespace"></span> But first, we’ll create the class of administrative users authorized to do so.</p>
<div class="center figure" id="_fig-user_index_delete_links_mockup" data-tralics-id="uid735" data-number="9.12">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_index_delete_links_mockup_bootstrap.png" alt="images/figures/user_index_delete_links_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 9.12: </span><span class="description">A mockup of the user index with delete links.
</span></div></div>
<div id="_sec-administrative_users" data-tralics-id="uid736" class="subsection" data-number="9.4.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-administrative_users" class="heading hyperref"><span class="number">9.4.1 </span>Administrative users</a></h3>
<p>We will identify privileged administrative users with a boolean <code>admin</code> attribute in the User model, which, as we’ll see, will automatically lead to an <code>admin?</code> boolean method to test for admin status.<span class="intersentencespace"></span> We can write tests for this attribute as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-admin_specs" class="hyperref">Listing&nbsp;<span class="ref">9.38</span></a>.</p>
<div class="codelisting" id="_code-admin_specs" data-tralics-id="uid737" data-number="9.38"><div class="heading"><span class="number">Listing 9.38:</span> 

<span class="description">Tests for an <code>admin</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_admin</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"with admin attribute set to 'true'"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save!</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we’ve used the <code>toggle!</code> method to flip the <code>admin</code> attribute from <code>false</code> to <code>true</code>.<span class="intersentencespace"></span> Also note that the line</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
</pre></div></div>
<p>implies (via the RSpec boolean convention) that the user should have an <code>admin?</code> boolean method.</p>
<p>As usual, we add the <code>admin</code> attribute with a migration, indicating the <code>boolean</code> type on the command line:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div></div>
<p>The migration simply adds the <code>admin</code> column to the <code>users</code> table (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-admin_migration" class="hyperref">Listing&nbsp;<span class="ref">9.39</span></a>), yielding the data model in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_model_admin" class="hyperref">Figure&nbsp;<span class="ref">9.13</span></a>.</p>
<div class="codelisting" id="_code-admin_migration" data-tralics-id="uid738" data-number="9.39"><div class="heading"><span class="number">Listing 9.39:</span> 

<span class="description">The migration to add a boolean <code>admin</code> attribute to users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_admin_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we’ve added the argument <code>default: false</code> to <code>add_column</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-admin_migration" class="hyperref">Listing&nbsp;<span class="ref">9.39</span></a>, which means that users will <em>not</em> be administrators by default.<span class="intersentencespace"></span> (Without the <code>default: false</code> argument, <code>admin</code> will be <code>nil</code> by default, which is still <code>false</code>, so this step is not strictly necessary.<span class="intersentencespace"></span> It is more explicit, though, and communicates our intentions more clearly both to Rails and to readers of our code.)</p>
<div class="center figure" id="_fig-user_model_admin" data-tralics-id="uid739" data-number="9.13"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_model_admin_31.png" alt="user_model_admin_31"></span>
<div class="caption"><span class="header">Figure 9.13: </span><span class="description">The User model with an added <code>admin</code> boolean attribute.
</span></div></div>
<p>Finally, we migrate the development database and prepare the test database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>As expected, Rails figures out the boolean nature of the <code>admin</code> attribute and automatically adds the question-mark method <code>admin?</code>:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>As a result, the admin tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div></div>
<p>As a final step, let’s update our sample data populator to make the first user an admin by default (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-populator_with_admin" class="hyperref">Listing&nbsp;<span class="ref">9.40</span></a>).</p>
<div class="codelisting" id="_code-populator_with_admin" data-tralics-id="uid740" data-number="9.40"><div class="heading"><span class="number">Listing 9.40:</span> 

<span class="description">The sample data populator code with an admin user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">lib/tasks/sample_data.rake</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span>
                         <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
                         <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                         <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                         <span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Then reset the database and re-populate the sample data:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<div id="_sec-revisiting_strong_parameters" data-tralics-id="uid741" class="subsubsection" data-number="9.4.1.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-revisiting_strong_parameters" class="heading">Revisiting strong parameters</a></h4>
<p>You might have noticed that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-populator_with_admin" class="hyperref">Listing&nbsp;<span class="ref">9.40</span></a> makes the user an admin by including <code>admin: true</code> in the initialization hash.<span class="intersentencespace"></span> This underscores the danger of exposing our objects to the wild Web: if we simply passed an initialization hash in from an arbitrary web request, a malicious user could send a <span class="tt">PATCH</span> request as follows:<sup id="_cha-9_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-8">8</a></sup></p>
<div class="code"><div class="highlight"><pre>patch /users/17?admin=1
</pre></div></div>
<p>This request would make user 17 an admin, which would be a potentially serious security breach, to say the least.</p>
<p>Because of this danger, it is essential to pass parameters that have been processed to permit only safe-to-edit attributes.<span class="intersentencespace"></span> As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-strong_parameters" class="hyperref">Section&nbsp;<span class="ref">7.3.2</span></a>, this is accomplished using <em>strong parameters</em> by calling <code>require</code> and <code>permit</code> on the <code>params</code> hash:</p>
<div class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
</pre></div></div>
<p>Note in particular that <code>admin</code> is <em>not</em> in the list of permitted attributes.<span class="intersentencespace"></span> This is what prevents arbitrary users from granting themselves administrative access to our application.<span class="intersentencespace"></span> Because of its importance, it’s a good idea to write a test for any attribute that isn’t editible, and writing such a test for the <code>admin</code> attribute is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).</p>
</div></div>
<div id="_sec-the_destroy_action" data-tralics-id="uid743" class="subsection" data-number="9.4.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_destroy_action" class="heading hyperref"><span class="number">9.4.2 </span>The <span class="tt">destroy</span> action</a></h3>
<p>The final step needed to complete the Users resource is to add delete links and a <code>destroy</code> action.<span class="intersentencespace"></span> We’ll start by adding a delete link for each user on the user index page, restricting access to administrative users.</p>
<p>To write tests for the delete functionality, it’s helpful to be able to have a factory to create admins.<span class="intersentencespace"></span> We can accomplish this by adding an <code>:admin</code> block to our factories, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-admin_factory" class="hyperref">Listing&nbsp;<span class="ref">9.41</span></a>.</p>
<div class="codelisting" id="_code-admin_factory" data-tralics-id="uid744" data-number="9.41"><div class="heading"><span class="number">Listing 9.41:</span> 

<span class="description">Adding a factory for administrative users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/factories.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-admin_factory" class="hyperref">Listing&nbsp;<span class="ref">9.41</span></a>, we can now use <code>FactoryGirl.create(:admin)</code> to create an administrative user in our tests.</p>
<p>Our security model requires that ordinary users not see delete links:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>But administrative users should see such links, and by clicking on a delete link we expect an admin to delete the user, i.e., to change the <code>User</code> count by&nbsp;<code>-1</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="s2">"should be able to delete another user"</span> <span class="k">do</span>
  <span class="n">expect</span> <span class="k">do</span>
    <span class="n">click_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">match</span><span class="p">:</span> <span class="ss">:first</span><span class="p">)</span>
  <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
</pre></div></div>
<p>This includes the code <code>match: :first</code>, which tells Capybara that we don’t care <em>which</em> delete link it clicks; it should just click the first one it sees.<span class="intersentencespace"></span> Note also that we have added a test to verify that the admin does not see a link to delete himself.<span class="intersentencespace"></span> The full set of delete link tests appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-delete_link_tests" class="hyperref">Listing&nbsp;<span class="ref">9.42</span></a>.</p>
<div class="codelisting" id="_code-delete_link_tests" data-tralics-id="uid745" data-number="9.42"><div class="heading"><span class="number">Listing 9.42:</span> 

<span class="description">Tests for delete links.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"index"</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'All users'</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"pagination"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"delete links"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"as an admin user"</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">sign_in</span> <span class="n">admin</span>
          <span class="n">visit</span> <span class="n">users_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="s2">"should be able to delete another user"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">match</span><span class="p">:</span> <span class="ss">:first</span><span class="p">)</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The application code links to <code>"delete"</code> if the current user is an admin (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-delete_links" class="hyperref">Listing&nbsp;<span class="ref">9.43</span></a>).<span class="intersentencespace"></span> Note the <code>method: :delete</code> argument, which arranges for the link to issue the necessary <span class="tt">DELETE</span> request.<span class="intersentencespace"></span> We’ve also wrapped each link inside an&nbsp;<code>if</code> statement so that only admins can see them.<span class="intersentencespace"></span> The result for our admin user appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-index_delete_links_rails_3" class="hyperref">Figure&nbsp;<span class="ref">9.14</span></a>.</p>
<div class="codelisting" id="_code-delete_links" data-tralics-id="uid746" data-number="9.43"><div class="heading"><span class="number">Listing 9.43:</span> 

<span class="description">User delete links (viewable only by admins).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_user.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                  <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p>Web browsers can’t send <span class="tt">DELETE</span> requests natively, so Rails fakes them with JavaScript.<span class="intersentencespace"></span> This means that the delete links won’t work if the user has JavaScript disabled.<span class="intersentencespace"></span> If you must support non-JavaScript-enabled browsers you can fake a <span class="tt">DELETE</span> request using a form and a <span class="tt">POST</span> request, which works even without JavaScript; see the RailsCast on “<a href="http://railscasts.com/episodes/77-destroy-without-javascript" target="_blank">Destroy Without JavaScript</a>” for details.</p>
<div class="center figure" id="_fig-index_delete_links_rails_3" data-tralics-id="uid747" data-number="9.14">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/index_delete_links_rails_3_bootstrap.png" alt="images/figures/index_delete_links_rails_3_bootstrap"></div><div class="caption"><span class="header">Figure 9.14: </span><span class="description">The user index <a href="http://localhost:3000/users" target="_blank">/users</a> with delete links.
</span></div></div>
<p>To get the delete links to work, we need to add a <code>destroy</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>), which finds the corresponding user and destroys it with the Active Record <code>destroy</code> method, finally redirecting to the user index, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-destroy_action" class="hyperref">Listing&nbsp;<span class="ref">9.44</span></a>.<span class="intersentencespace"></span> Note that we also add <code>:destroy</code> to the <code>signed_in_user</code> before filter.</p>
<div class="codelisting" id="_code-destroy_action" data-tralics-id="uid748" data-number="9.44"><div class="heading"><span class="number">Listing 9.44:</span> 

<span class="description">Adding a working <code>destroy</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"User deleted."</span>
    <span class="n">redirect_to</span> <span class="n">users_url</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the <code>destroy</code> action uses method chaining to combine the <code>find</code> and <code>destroy</code> into one line:</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div></div>
<p>As constructed, only admins can destroy users through the web, because only admins can see the delete links.<span class="intersentencespace"></span> Unfortunately, there’s still a terrible security hole: any sufficiently sophisticated attacker could simply issue <span class="tt">DELETE</span> requests directly from the command line to delete any user on the site.<span class="intersentencespace"></span> To secure the site properly, we also need access control on the <code>destroy</code> action, so our tests should check not only that admins <em>can</em> delete users, but also that other users <em>can’t</em>.<span class="intersentencespace"></span> The results appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-delete_destroy_test" class="hyperref">Listing&nbsp;<span class="ref">9.45</span></a>.<span class="intersentencespace"></span> Note that, in analogy with the <code>patch</code> method from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-protected_edit_update_tests" class="hyperref">Listing&nbsp;<span class="ref">9.11</span></a>, we use <code>delete</code> to issue a <span class="tt">DELETE</span> request directly to the specified URL (in this case, the user path, as required by <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_users" class="hyperref">Table&nbsp;<span class="ref">7.1</span></a>).</p>
<div class="codelisting" id="_code-delete_destroy_test" data-tralics-id="uid749" data-number="9.45"><div class="heading"><span class="number">Listing 9.45:</span> 

<span class="description">A test for protecting the <code>destroy</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"as non-admin user"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:non_admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">non_admin</span><span class="p">,</span> <span class="ss">no_capybara</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"submitting a DELETE request to the Users#destroy action"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>In principle, there’s still a minor security hole, which is that an admin could delete himself by issuing a <span class="tt">DELETE</span> request directly.<span class="intersentencespace"></span> One might argue that such an admin is only getting what they deserve, but it would be nice to prevent such an occurrence, and doing so is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>).</p>
<p>As you might suspect by now, the application code uses a before filter, this time to restrict access to the <code>destroy</code> action to admins.<span class="intersentencespace"></span> The resulting <code>admin_user</code> before filter appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-admin_destroy_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.46</span></a>.</p>
<div class="codelisting" id="_code-admin_destroy_before_filter" data-tralics-id="uid750" data-number="9.46"><div class="heading"><span class="number">Listing 9.46:</span> 

<span class="description">A before filter restricting the <code>destroy</code> action to admins.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:admin_user</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, all the tests should be passing, and the Users resource—with its controller, model, and views—is functionally complete.</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div>
<div id="_sec-updating_and_deleting_users_conclusion" data-tralics-id="cid57" class="section" data-number="9.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_and_deleting_users_conclusion" class="heading hyperref"><span class="number">9.5 </span>Conclusion</a></h2>
<p>We’ve come a long way since introducing the Users controller way back in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_signup" class="hyperref">Section&nbsp;<span class="ref">5.4</span></a>.<span class="intersentencespace"></span> Those users couldn’t even sign up; now users can sign up, sign in, sign out, view their profiles, edit their settings, and see an index of all users—and some can even destroy other users.</p>
<p>The rest of this book builds on the foundation of the Users resource (and associated authorization system) to make a site with Twitter-like microposts (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="hyperref">Chapter&nbsp;<span class="ref">10</span></a>) and a status feed of posts from followed users (<a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>).<span class="intersentencespace"></span> These chapters will introduce some of the most powerful features of Rails, including data modeling with <code>has_many</code> and <code>has_many through</code>.</p>
<p>Before moving on, be sure to merge all the changes into the master branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Finish user edit, update, index, and destroy actions"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
</pre></div></div>
<p>You can also deploy the application and even populate the production database with sample users (using the <code>pg:reset</code> task to reset the production database):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div></div>
<p>To get the changes to show up, you may have to force an app restart at Heroku:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku restart
</pre></div></div>
<p>It’s also worth noting that this chapter saw the last of the necessary gem installations.<span class="intersentencespace"></span> For reference, the final <code>Gemfile</code> is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-final_gemfile" class="hyperref">Listing&nbsp;<span class="ref">9.47</span></a>.<span class="intersentencespace"></span> (Optional gems may be system-dependent and are commented out.<span class="intersentencespace"></span> You can uncomment them to see if they work on your system.)</p>
<div class="codelisting" id="_code-final_gemfile" data-tralics-id="uid751" data-number="9.47"><div class="heading"><span class="number">Listing 9.47:</span> 

<span class="description">The final <code>Gemfile</code> for the sample application.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">ruby</span> <span class="s1">'2.0.0'</span>
<span class="c1">#ruby-gemset=railstutorial_rails_4_0</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'4.0.8'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-sass'</span><span class="p">,</span> <span class="s1">'2.3.2.0'</span>
<span class="n">gem</span> <span class="s1">'sprockets'</span><span class="p">,</span> <span class="s1">'2.11.0'</span>
<span class="n">gem</span> <span class="s1">'bcrypt-ruby'</span><span class="p">,</span> <span class="s1">'3.1.2'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span> <span class="s1">'1.1.2'</span>
<span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.9'</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.8'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.13.1'</span>
  <span class="c1"># The following optional lines are part of the advanced setup.</span>
  <span class="c1"># gem 'guard-rspec', '2.5.0'</span>
  <span class="c1"># gem 'spork-rails', '4.0.0'</span>
  <span class="c1"># gem 'guard-spork', '1.5.0'</span>
  <span class="c1"># gem 'childprocess', '0.3.6'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'selenium-webdriver'</span><span class="p">,</span> <span class="s1">'2.35.1'</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span><span class="p">,</span> <span class="s1">'2.1.0'</span>
  <span class="n">gem</span> <span class="s1">'factory_girl_rails'</span><span class="p">,</span> <span class="s1">'4.2.0'</span>
  <span class="n">gem</span> <span class="s1">'cucumber-rails'</span><span class="p">,</span> <span class="s1">'1.4.0'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">'database_cleaner'</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s1">'bmabey/database_cleaner'</span>

  <span class="c1"># Uncomment this line on OS X.</span>
  <span class="c1"># gem 'growl', '1.0.3'</span>

  <span class="c1"># Uncomment these lines on Linux.</span>
  <span class="c1"># gem 'libnotify', '0.8.0'</span>

  <span class="c1"># Uncomment these lines on Windows.</span>
  <span class="c1"># gem 'rb-notifu', '0.0.4'</span>
  <span class="c1"># gem 'wdm', '0.1.0'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'4.0.3'</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'2.1.1'</span>
<span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'4.0.1'</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span><span class="p">,</span> <span class="s1">'3.0.4'</span>
<span class="n">gem</span> <span class="s1">'turbolinks'</span><span class="p">,</span> <span class="s1">'1.1.1'</span>
<span class="n">gem</span> <span class="s1">'jbuilder'</span><span class="p">,</span> <span class="s1">'1.0.2'</span>

<span class="n">group</span> <span class="ss">:doc</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sdoc'</span><span class="p">,</span> <span class="s1">'0.3.20'</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="s1">'0.15.1'</span>
  <span class="n">gem</span> <span class="s1">'rails_12factor'</span><span class="p">,</span> <span class="s1">'0.0.2'</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-updating_deleting_exercises" data-tralics-id="cid58" class="section" data-number="9.6"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="heading hyperref"><span class="number">9.6 </span>Exercises</a></h2>
<ol>
<li>By issuing a <span class="tt">PATCH</span> request directly to the <code>update</code> method as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-forbidden_admin_test" class="hyperref">Listing&nbsp;<span class="ref">9.48</span></a>, verify that the <code>admin</code> attribute isn’t editable through the web.<span class="intersentencespace"></span> Be sure to get first to Red, and then to Green.<span class="intersentencespace"></span> (<em>Hint</em>: Your first step should be to <em>add</em> <code>admin</code> to the list of permitted parameters in <code>user_params</code>.)
</li>
<li>Arrange for the Gravatar “change” link in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_edit_view" class="hyperref">Listing&nbsp;<span class="ref">9.3</span></a> to open in a new window (or tab).<span class="intersentencespace"></span> <em>Hint:</em> Search the web; you should find one particularly robust method involving something called <code>_blank</code>.
</li>
<li>The current authentication tests check that navigation links such as “Profile” and “Settings” appear when a user is signed in.<span class="intersentencespace"></span> Add tests to make sure that these links <em>don’t</em> appear when a user isn’t signed in.
</li>
<li>Use the <code>sign_in</code> test helper from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sign_in_helper" class="hyperref">Listing&nbsp;<span class="ref">9.6</span></a> in as many places as you can find.
</li>
<li>Remove the duplicated form code by refactoring the <code>new.html.erb</code> and <code>edit.html.erb</code> views to use the partial in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_edit_partial" class="hyperref">Listing&nbsp;<span class="ref">9.49</span></a>.<span class="intersentencespace"></span> Note that you will have to pass the form variable&nbsp;<code>f</code> explicitly as a local variable, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_user_with_partial" class="hyperref">Listing&nbsp;<span class="ref">9.50</span></a>.<span class="intersentencespace"></span> You will also have to update the tests, as the forms aren’t currently <em>exactly</em> the same; identify the slight difference and update the tests accordingly.
</li>
<li>Signed-in users have no reason to access the <code>new</code> and <code>create</code> actions in the Users controller.<span class="intersentencespace"></span> Arrange for such users to be redirected to the root URL if they do try to hit those pages.
</li>
<li>Learn about the <code>request</code> object by inserting some of the methods listed in the <a href="http://api.rubyonrails.org/v4.0.0/classes/ActionDispatch/Request.html" target="_blank">Rails API</a><sup id="_cha-9_footnote-ref-9" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-9">9</a></sup> into the site layout.<span class="intersentencespace"></span> (Refer to <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-rails_debug" class="hyperref">Listing&nbsp;<span class="ref">7.1</span></a> if you get stuck.)
</li>
<li>Write a test to make sure that the friendly forwarding only forwards to the given URL the first time.<span class="intersentencespace"></span> On subsequent signin attempts, the forwarding URL should revert to the default (i.e., the profile page).<span class="intersentencespace"></span> See <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-friendly_forgetting_test" class="hyperref">Listing&nbsp;<span class="ref">9.51</span></a> for a hint (and, by a hint, I mean the solution).
</li>
<li>Modify the <code>destroy</code> action to prevent admin users from destroying themselves.<span class="intersentencespace"></span> (Write a test first.)
</li></ol>
<div class="codelisting" id="_code-forbidden_admin_test" data-tralics-id="uid762" data-number="9.48"><div class="heading"><span class="number">Listing 9.48:</span> 

<span class="description">Testing that the <code>admin</code> attribute is forbidden.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"edit"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"forbidden attributes"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="k">do</span>
        <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                  <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="p">}</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="ss">no_capybara</span><span class="p">:</span> <span class="kp">true</span>
        <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="n">params</span>
      <span class="k">end</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_admin</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-new_edit_partial" data-tralics-id="uid763" data-number="9.49"><div class="heading"><span class="number">Listing 9.49:</span> 

<span class="description">A partial for the new and edit form fields.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_fields.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirm Password"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-new_user_with_partial" data-tralics-id="uid764" data-number="9.50"><div class="heading"><span class="number">Listing 9.50:</span> 

<span class="description">The new user view with partial.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'fields'</span><span class="p">,</span> <span class="ss">f</span><span class="p">:</span> <span class="n">f</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Create my account"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-friendly_forgetting_test" data-tralics-id="uid765" data-number="9.51"><div class="heading"><span class="number">Listing 9.51:</span> 

<span class="description">A test for forwarding to the default page after friendly forwarding.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"when attempting to visit a protected page"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">"Sign in"</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"after signing in"</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">"should render the desired protected page"</span> <span class="k">do</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Edit user'</span><span class="p">)</span>
          <span class="k">end</span>

          <span class="n">describe</span> <span class="s2">"when signing in again"</span> <span class="k">do</span>
            <span class="n">before</span> <span class="k">do</span>
              <span class="n">click_link</span> <span class="s2">"Sign out"</span>
              <span class="n">visit</span> <span class="n">signin_path</span>
              <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span>    <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
              <span class="n">fill_in</span> <span class="s2">"Password"</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
              <span class="n">click_button</span> <span class="s2">"Sign in"</span>
            <span class="k">end</span>

            <span class="n">it</span> <span class="s2">"should render the default (profile) page"</span> <span class="k">do</span>
              <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="cha-9_footnotes">
  <ol class="footnotes">
    <li id="_cha-9_footnote-1">Image from <a href="http://www.flickr.com/photos/sashawolff/4598355045/" target="_blank">http://www.flickr.com/photos/sashawolff/4598355045/</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-1">↑</a></li>
    <li id="_cha-9_footnote-2">The Gravatar site actually redirects this to <a href="http://en.gravatar.com/emails" target="_blank">http://en.gravatar.com/emails</a>, which is for English language users, but I’ve omitted the <span class="tt">en</span> part to account for the use of other languages.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-2">↑</a></li>
    <li id="_cha-9_footnote-3">Don’t worry about how this works; the details are of interest to developers of the Rails framework itself, and by design are not important for Rails application developers.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-3">↑</a></li>
    <li id="_cha-9_footnote-4">The code in this section is adapted from the <a href="http://github.com/thoughtbot/clearance" target="_blank">Clearance</a> gem by <a href="http://thoughtbot.com/" target="_blank">thoughtbot</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-4">↑</a></li>
    <li id="_cha-9_footnote-5">Thanks to reader Yoel Adler for pointing out this subtle issue, and for discovering the solution.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-5">↑</a></li>
    <li id="_cha-9_footnote-6">Baby photo from <a href="http://www.flickr.com/photos/glasgows/338937124/" target="_blank">http://www.flickr.com/photos/glasgows/338937124/</a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-6">↑</a></li>
    <li id="_cha-9_footnote-7">The name <code>user</code> is immaterial—we could have written <code>@users.each do |foobar|</code> and then used <code>render foobar</code>.<span class="intersentencespace"></span> The key is the <em>class</em> of the object—in this case, <code>User</code>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-7">↑</a></li>
    <li id="_cha-9_footnote-8">Command-line tools such as <span class="tt">curl</span> can issue <span class="tt">PATCH</span> requests of this form.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-8">↑</a></li>
    <li id="_cha-9_footnote-9">http://api.rubyonrails.org/v4.0.0/classes/ActionDispatch/Request.html&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-9_footnote-ref-9">↑</a></li>
  </ol>
</div><div id="_cha-user_microposts" data-tralics-id="cid59" class="chapter" data-number="10"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-user_microposts" class="heading hyperref"><span class="number">Chapter 10 </span>User microposts</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-updating_showing_and_deleting_users" class="hyperref">Chapter&nbsp;<span class="ref">9</span></a> saw the completion of the REST actions for the Users resource, so the time has finally come to add a second full resource: user <em>microposts</em>.<sup id="_cha-10_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-1">1</a></sup><span class="intersentencespace"></span> These are short messages associated with a particular user, first seen in larval form in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a>.<span class="intersentencespace"></span> In this chapter, we will make a full-strength version of the sketch from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-microposts_resource" class="hyperref">Section&nbsp;<span class="ref">2.3</span></a> by constructing the Micropost data model, associating it with the User model using the <code>has_many</code> and <code>belongs_to</code> methods, and then making the forms and partials needed to manipulate and display the results.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>, we’ll complete our tiny Twitter clone by adding the notion of <em>following</em> users in order to receive a <em>feed</em> of their microposts.</p>
<p>If you’re using Git for version control, I suggest making a topic branch as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b user-microposts
</pre></div></div>
</div>
<div id="_sec-a_micropost_model" data-tralics-id="cid60" class="section" data-number="10.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_micropost_model" class="heading hyperref"><span class="number">10.1 </span>A Micropost model</a></h2>
<p>We begin the Microposts resource by creating a Micropost model, which captures the essential characteristics of microposts.<span class="intersentencespace"></span> What follows builds on the work from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-microposts_resource" class="hyperref">Section&nbsp;<span class="ref">2.3</span></a>; as with the model in that section, our new Micropost model will include data validations and an association with the User model.<span class="intersentencespace"></span> Unlike that model, the present Micropost model will be fully tested, and will also have a default <em>ordering</em> and automatic <em>destruction</em> if its parent user is destroyed.</p>
<div id="_sec-the_basic_model" data-tralics-id="uid767" class="subsection" data-number="10.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_basic_model" class="heading hyperref"><span class="number">10.1.1 </span>The basic model</a></h3>
<p>The Micropost model needs only two attributes: a <code>content</code> attribute to hold the micropost’s content,<sup id="_cha-10_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-2">2</a></sup> and a <code>user_id</code> to associate a micropost with a particular user.<span class="intersentencespace"></span> As with the case of the User model (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-generate_user_model" class="hyperref">Listing&nbsp;<span class="ref">6.1</span></a>), we generate it using <code>generate model</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:string user_id:integer
</pre></div></div>
<p>It’s possible that this will generate a Micropost factory, which you should remove since we’ll be making one later by hand (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ordering_and_dependency" class="hyperref">Section&nbsp;<span class="ref">10.1.4</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm -f spec/factories/microposts.rb
</pre></div></div>
<p>The generate command produces a migration to create a <code>microposts</code> table in the database (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_migration" class="hyperref">Listing&nbsp;<span class="ref">10.1</span></a>); compare it to the analogous migration for the <code>users</code> table from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-users_migration" class="hyperref">Listing&nbsp;<span class="ref">6.2</span></a>.</p>
<div class="codelisting" id="_code-micropost_migration" data-tralics-id="uid769" data-number="10.1"><div class="heading"><span class="number">Listing 10.1:</span> 

<span class="description">The Micropost migration.<span class="intersentencespace"></span> (Note the index on <code>user_id</code> and <code>created_at</code>.)<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_microposts.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, since we expect to retrieve all the microposts associated with a given user&nbsp;id in reverse order of creation, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_migration" class="hyperref">Listing&nbsp;<span class="ref">10.1</span></a> adds an index (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-database_indices" class="hyperref">Box&nbsp;<span class="ref">6.2</span></a>) on the <code>user_id</code> and <code>created_at</code> columns:</p>
<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</pre></div></div>
<p>By including both the <code>user_id</code> and <code>created_at</code> columns as an array, we arrange for Rails to create a <em>multiple key index</em>, which means that Active Record uses <em>both</em> keys at the same time.<span class="intersentencespace"></span> Note also the <code>t.timestamps</code> line, which (as mentioned in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-database_migrations" class="hyperref">Section&nbsp;<span class="ref">6.1.1</span></a>) adds the magic <code>created_at</code> and <code>updated_at</code> columns.<span class="intersentencespace"></span> We’ll put the <code>created_at</code> column to work in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ordering_and_dependency" class="hyperref">Section&nbsp;<span class="ref">10.1.4</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-augmenting_the_user_show_page" class="hyperref">Section&nbsp;<span class="ref">10.2.1</span></a>.</p>
<p>We’ll start with some minimal tests for the Micropost model based on the analogous tests for the User model (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_spec" class="hyperref">Listing&nbsp;<span class="ref">6.5</span></a>).<span class="intersentencespace"></span> In particular, we verify that a micropost object responds to the <code>content</code> and <code>user_id</code> attributes, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-initial_micropost_spec" class="hyperref">Listing&nbsp;<span class="ref">10.2</span></a>.</p>
<div class="codelisting" id="_code-initial_micropost_spec" data-tralics-id="uid770" data-number="10.2"><div class="heading"><span class="number">Listing 10.2:</span> 

<span class="description">The initial Micropost spec.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/micropost_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is not idiomatically correct.</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>We can get these tests to pass by running the microposts migration and preparing the test database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>The result is a Micropost model with the structure shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-micropost_model" class="hyperref">Figure&nbsp;<span class="ref">10.1</span></a>.</p>
<div class="center figure" id="_fig-micropost_model" data-tralics-id="uid771" data-number="10.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/micropost_model.png" alt="images/figures/micropost_model"></div><div class="caption"><span class="header">Figure 10.1: </span><span class="description">The Micropost data model.
</span></div></div>
<p>You should verify that the tests pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/micropost_spec.rb
</pre></div></div>
<p>Even though the tests are passing, you might have noticed this code:</p>
<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># This code is not idiomatically correct.</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>The comment indicates that the code in the <code>before</code> block is not idiomatically correct.<span class="intersentencespace"></span> That is, it works, but it’s not the Rails way.<span class="intersentencespace"></span> See if you can guess why.<span class="intersentencespace"></span> We’ll see the answer in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_micropost_associations" class="hyperref">Section&nbsp;<span class="ref">10.1.3</span></a>.</p>
</div>
<div id="_sec-first_micropost_validation" data-tralics-id="uid772" class="subsection" data-number="10.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-first_micropost_validation" class="heading hyperref"><span class="number">10.1.2 </span>The first validation</a></h3>
<p>One of the necessary aspects of the Micropost model is the presence of a user id to indicate which user made the micropost.<span class="intersentencespace"></span> The idiomatically correct way to do this is to use Active Record <em>associations</em>, which we’ll implement in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_micropost_associations" class="hyperref">Section&nbsp;<span class="ref">10.1.3</span></a>.<span class="intersentencespace"></span> Since this will involve a minor refactoring, in this section we’ll write a test to catch any future regressions.</p>
<p>As shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_validity_test" class="hyperref">Listing&nbsp;<span class="ref">10.3</span></a>, the validation test for user id just sets the id to <code>nil</code> and then checks that the resulting micropost is invalid.<span class="intersentencespace"></span> (Compare with the User model tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-failing_validates_name_spec" class="hyperref">Listing&nbsp;<span class="ref">6.8</span></a>.)</p>
<div class="codelisting" id="_code-micropost_validity_test" data-tralics-id="uid773" data-number="10.3"><div class="heading"><span class="number">Listing 10.3:</span> 

<span class="description">Tests for the validity of a new micropost.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/micropost_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is not idiomatically correct.</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This code requires that the micropost be valid and tests for the presence of the <code>user_id</code> attribute.<span class="intersentencespace"></span> We can get these tests to pass with the simple presence validation shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_user_id_validation" class="hyperref">Listing&nbsp;<span class="ref">10.4</span></a>.</p>
<div class="codelisting" id="_code-micropost_user_id_validation" data-tralics-id="uid774" data-number="10.4"><div class="heading"><span class="number">Listing 10.4:</span> 

<span class="description">A validation for the micropost’s <code>user_id</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-user_micropost_associations" data-tralics-id="uid775" class="subsection" data-number="10.1.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_micropost_associations" class="heading hyperref"><span class="number">10.1.3 </span>User/Micropost associations</a></h3>
<p>When constructing data models for web applications, it is essential to be able to make <em>associations</em> between individual models.<span class="intersentencespace"></span> In the present case, each micropost is associated with one user, and each user is associated with (potentially) many microposts—a relationship seen briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-demo_user_has_many_microposts" class="hyperref">Section&nbsp;<span class="ref">2.3.3</span></a> and shown schematically in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-micropost_belongs_to_user" class="hyperref">Figure&nbsp;<span class="ref">10.2</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_has_many_microposts" class="hyperref">Figure&nbsp;<span class="ref">10.3</span></a>.<span class="intersentencespace"></span> As part of implementing these associations, we’ll write tests for the Micropost model and add a couple of tests to the User model.</p>
<div class="center figure" id="_fig-micropost_belongs_to_user" data-tralics-id="uid776" data-number="10.2">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/micropost_belongs_to_user.png" alt="images/figures/micropost_belongs_to_user"></div><div class="caption"><span class="header">Figure 10.2: </span><span class="description">The <code>belongs_to</code> relationship between a micropost and its user.
</span></div></div>
<div class="center figure" id="_fig-user_has_many_microposts" data-tralics-id="uid777" data-number="10.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_has_many_microposts.png" alt="images/figures/user_has_many_microposts"></div><div class="caption"><span class="header">Figure 10.3: </span><span class="description">The <code>has_many</code> relationship between a user and its microposts.
</span></div></div>
<p>Using the <code>belongs_to</code>/<code>has_many</code> association defined in this section, Rails constructs the methods shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-association_methods" class="hyperref">Table&nbsp;<span class="ref">10.1</span></a>.</p>
<div class="table" id="_table-association_methods" data-tralics-id="uid778" data-number="10.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>Method</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><code>micropost.user</code></td>
<td class="align_left">Return the User object associated with the micropost.<span class="intersentencespace"></span></td>
</tr><tr><td class="align_left"><code>user.microposts</code></td>
<td class="align_left">Return an array of the user’s microposts.<span class="intersentencespace"></span></td>
</tr><tr><td class="align_left"><code>user.microposts.create(arg)</code></td>
<td class="align_left">Create a micropost (<code>user_id = user.id</code>).<span class="intersentencespace"></span></td>
</tr><tr><td class="align_left"><code>user.microposts.create!(arg)</code></td>
<td class="align_left">Create a micropost (exception on failure).<span class="intersentencespace"></span></td>
</tr><tr><td class="align_left"><code>user.microposts.build(arg)</code></td>
<td class="align_left">Return a new Micropost object (<code>user_id = user.id</code>).<span class="intersentencespace"></span></td>
</tr></tbody></table><div class="caption"><span class="header">Table 10.1: </span><span class="description">A summary of user/micropost association methods.
</span></div></div>
<p>Note from <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-association_methods" class="hyperref">Table&nbsp;<span class="ref">10.1</span></a> that instead of</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">create</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
</pre></div></div>
<p>we have</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div></div>
<p>This pattern is the canonical way to make a micropost: <em>through</em> its association with a user.<span class="intersentencespace"></span> When a new micropost is made in this way, its <code>user_id</code> is <em>automatically</em> set to the right value.<span class="intersentencespace"></span> In particular, we can replace the code</p>
<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># This code is not idiomatically correct.</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_validity_test" class="hyperref">Listing&nbsp;<span class="ref">10.3</span></a> with</p>
<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>Once we define the proper associations, the resulting <code>@micropost</code> variable will automatically have <code>user_id</code> equal to its associated user.</p>
<p>As seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-association_methods" class="hyperref">Table&nbsp;<span class="ref">10.1</span></a>, another result of the user/micropost association is <code>micropost.user</code>, which simply returns the micropost’s user.<span class="intersentencespace"></span> We can test this with the <code>it</code> and <code>its</code> methods as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">user</span> <span class="p">}</span>
</pre></div></div>
<p>The resulting Micropost model tests are shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_belongs_to_user_spec" class="hyperref">Listing&nbsp;<span class="ref">10.5</span></a>.</p>
<div class="codelisting" id="_code-micropost_belongs_to_user_spec" data-tralics-id="uid779" data-number="10.5"><div class="heading"><span class="number">Listing 10.5:</span> 

<span class="description">Tests for the micropost’s user association.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/micropost_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>On the User model side of the association, we’ll defer the more detailed tests to <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ordering_and_dependency" class="hyperref">Section&nbsp;<span class="ref">10.1.4</span></a>; for now, we’ll simply test for the presence of a <code>microposts</code> attribute (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_has_many_microposts_spec" class="hyperref">Listing&nbsp;<span class="ref">10.6</span></a>).</p>
<div class="codelisting" id="_code-user_has_many_microposts_spec" data-tralics-id="uid780" data-number="10.6"><div class="heading"><span class="number">Listing 10.6:</span> 

<span class="description">A test for the user’s <code>microposts</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>After all that work, the code to implement the association is almost comically short: we can get the tests in both <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_belongs_to_user_spec" class="hyperref">Listing&nbsp;<span class="ref">10.5</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_has_many_microposts_spec" class="hyperref">Listing&nbsp;<span class="ref">10.6</span></a> to pass by adding just two lines: <code>belongs_to :user</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_belongs_to_user" class="hyperref">Listing&nbsp;<span class="ref">10.7</span></a>) and <code>has_many :microposts</code> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_has_many_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.8</span></a>).</p>
<div class="codelisting" id="_code-micropost_belongs_to_user" data-tralics-id="uid781" data-number="10.7"><div class="heading"><span class="number">Listing 10.7:</span> 

<span class="description">A micropost <code>belongs_to</code> a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-user_has_many_microposts" data-tralics-id="uid782" data-number="10.8"><div class="heading"><span class="number">Listing 10.8:</span> 

<span class="description">A user <code>has_many</code> microposts.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, you should compare the entries in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-association_methods" class="hyperref">Table&nbsp;<span class="ref">10.1</span></a> with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_belongs_to_user_spec" class="hyperref">Listing&nbsp;<span class="ref">10.5</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_has_many_microposts_spec" class="hyperref">Listing&nbsp;<span class="ref">10.6</span></a> to satisfy yourself that you understand the basic nature of the associations.<span class="intersentencespace"></span> You should also check that the tests pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models
</pre></div></div>
</div>
<div id="_sec-ordering_and_dependency" data-tralics-id="uid783" class="subsection" data-number="10.1.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-ordering_and_dependency" class="heading hyperref"><span class="number">10.1.4 </span>Micropost refinements</a></h3>
<p>The test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_has_many_microposts_spec" class="hyperref">Listing&nbsp;<span class="ref">10.6</span></a> of the <code>has_many</code> association doesn’t test for much—it merely verifies the <em>existence</em> of a <code>microposts</code> attribute.<span class="intersentencespace"></span> In this section, we’ll add <em>ordering</em> and <em>dependency</em> to microposts, while also testing that the <code>user.microposts</code> method actually returns an array of microposts.</p>
<p>We will need to construct some microposts in the User model test, which means that we should make a micropost factory at this point.<span class="intersentencespace"></span> To do this, we need a way to make an association in Factory Girl.<span class="intersentencespace"></span> Happily, this is easy, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_factory" class="hyperref">Listing&nbsp;<span class="ref">10.9</span></a>.</p>
<div class="codelisting" id="_code-micropost_factory" data-tralics-id="uid784" data-number="10.9"><div class="heading"><span class="number">Listing 10.9:</span> 

<span class="description">The complete factory file, including a new factory for microposts.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/factories.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">"foobar"</span>
    <span class="n">password_confirmation</span> <span class="s2">"foobar"</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">"Lorem ipsum"</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we tell Factory Girl about the micropost’s associated user just by including a user in the definition of the factory:</p>
<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s2">"Lorem ipsum"</span>
  <span class="n">user</span>
<span class="k">end</span>
</pre></div></div>
<p>As we’ll see in the next section, this allows us to define factory microposts as follows:</p>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div></div>
<div id="_sec-default_scope" data-tralics-id="uid785" class="subsubsection" data-number="10.1.4.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-default_scope" class="heading">Default scope</a></h4>
<p>By default, using <code>user.microposts</code> to pull a user’s microposts from the database makes no guarantees about the order of the posts, but (following the convention of blogs and Twitter) we want the microposts to come out in reverse order of when they were created, i.e., most recent first.<span class="intersentencespace"></span> To test this ordering, we first create a couple of microposts as follows:</p>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
<span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div></div>
<p>Here we indicate (using the time helpers discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-time_helpers" class="hyperref">Box&nbsp;<span class="ref">8.1</span></a>) that the second post was created more recently, i.e., <code>1.hour.ago</code>, while the first post was created <code>1.day.ago</code>.<span class="intersentencespace"></span> Note how convenient the use of Factory Girl is: we can set <code>created_at</code> manually, which Active Record won’t allow us to do.<span class="intersentencespace"></span> (Recall that <code>created_at</code> and <code>updated_at</code> are “magic” columns, automatically set to the proper creation and update timestamps, so any explicit initialization values are overwritten by the magic.)</p>
<p>Most database adapters (including the one for SQLite) return the microposts in order of their ids, so we can arrange for an initial test that almost certainly fails using the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_ordering_test" class="hyperref">Listing&nbsp;<span class="ref">10.10</span></a>.<span class="intersentencespace"></span> This uses the <code>let!</code><span class="intersentencespace"></span> (read “let bang”) method in place of <code>let</code>; the reason is that <code>let</code> variables are <em>lazy</em>, meaning that they only spring into existence when referenced.<span class="intersentencespace"></span> The problem is that we want the microposts to exist immediately, so that the timestamps are in the right order and so that <code>@user.microposts</code> isn’t empty.<span class="intersentencespace"></span> We accomplish this with <code>let!</code>, which forces the corresponding variable to come into existence immediately.</p>
<div class="codelisting" id="_code-micropost_ordering_test" data-tralics-id="uid786" data-number="10.10"><div class="heading"><span class="number">Listing 10.10:</span> 

<span class="description">Testing the order of a user’s microposts.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should have the right microposts in the right order"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">to_a</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The key line here is</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">to_a</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
</pre></div></div>
<p>indicating that the posts should be ordered newest first.<span class="intersentencespace"></span> This should fail because by default the posts will be ordered by&nbsp;id, i.e., <code>[older_micropost, newer_micropost]</code>.<span class="intersentencespace"></span> This test also verifies the basic correctness of the <code>has_many</code> association itself, by checking (as indicated in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-association_methods" class="hyperref">Table&nbsp;<span class="ref">10.1</span></a>) that <code>user.microposts</code> effectively returns an array of microposts.<span class="intersentencespace"></span> The <code>to_a</code> method, discussed before in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-arrays_and_ranges" class="hyperref">Section&nbsp;<span class="ref">4.3.1</span></a>, converts <code>@user.microposts</code> from its default state (which happens to be an Active Record “collection proxy”) to a proper array appropriate for comparison with the one we constructed by hand.</p>
<p>To get the ordering test to pass, we use a Rails facility called <code>default_scope</code> with an <code>order</code> argument, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_ordering" class="hyperref">Listing&nbsp;<span class="ref">10.11</span></a>.<span class="intersentencespace"></span> (This is our first example of the notion of <em>scope</em>.<span class="intersentencespace"></span> We will learn about scope in a more general context in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>.)</p>
<div class="codelisting" id="_code-micropost_ordering" data-tralics-id="uid787" data-number="10.11"><div class="heading"><span class="number">Listing 10.11:</span> 

<span class="description">Ordering the microposts with <code>default_scope</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div><p>The order here is <code>’created_at DESC’</code>, where <code>DESC</code> is SQL for “descending”, i.e., in descending order from newest to oldest.</p>
<p>As of Rails&nbsp;4.0, all scopes take an anonymous function that returns the criteria desired for the scope, mainly so that the scope need not be evaluated immediately, but rather can be loaded later on an as-needed basis (so-called <em>lazy evaluation</em>).<span class="intersentencespace"></span> In the present case, this function is</p>
<div class="code"><div class="highlight"><pre><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>The syntax for this kind of object, called a <em>Proc</em> (procedure) or <em>lambda</em>, is the arrow&nbsp;<code>-&gt;</code>.<span class="intersentencespace"></span> It takes in a block (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-blocks" class="hyperref">Section&nbsp;<span class="ref">4.3.2</span></a>) and then evaluates it when called with the <code>call</code> method.<span class="intersentencespace"></span> We can see how it works at the console:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;</span>&gt; -&gt; <span class="o">{</span> puts <span class="s2">"foo"</span> <span class="o">}</span>
<span class="go">=&gt; #&lt;Proc:0x007fab938d0108@(irb):1 (lambda)&gt;</span>
<span class="gp">&gt;</span>&gt; -&gt; <span class="o">{</span> puts <span class="s2">"foo"</span> <span class="o">}</span>.call
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div></div>
<p>(Procs are a somewhat advanced Ruby topic, so don’t worry if they don’t make sense right away.)</p>
</div>
<div id="_sec-dependent_destroy" data-tralics-id="uid788" class="subsubsection" data-number="10.1.4.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-dependent_destroy" class="heading">Dependent: destroy</a></h4>
<p>Apart from proper ordering, there is a second refinement we’d like to add to microposts.<span class="intersentencespace"></span> Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-destroying_users" class="hyperref">Section&nbsp;<span class="ref">9.4</span></a> that site administrators have the power to <em>destroy</em> users.<span class="intersentencespace"></span> It stands to reason that, if a user is destroyed, the user’s microposts should be destroyed as well.<span class="intersentencespace"></span> We can test for this by first destroying a micropost’s user and then verifying that the associated microposts are no longer in the database.</p>
<p>In order to test destroying microposts properly, we first need to capture a given user’s posts in a local variable, and then destroy the user.<span class="intersentencespace"></span> A straighforward implementation looks like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">to_a</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_empty</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># Make sure the micropost doesn't appear in the database.</span>
<span class="k">end</span>
</pre></div></div>
<p>Here the call to <code>to_a</code> effectively makes a copy of the microposts, and we’ve included the line</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_empty</span>
</pre></div></div>
<p>as a safety check to catch any errors should the <code>to_a</code> ever be accidentally removed.<span class="intersentencespace"></span> The issue is that, without <code>to_a</code>, destroying the user would destroy the posts in the <code>microposts</code> variable, and as a result</p>
<div class="code"><div class="highlight"><pre><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># Make sure the micropost doesn't appear in the database.</span>
<span class="k">end</span>
</pre></div></div>
<p>wouldn’t actually test anything because <code>microposts</code> would be empty.</p>
<p>We can express the expectation that the microposts don’t appear in the database as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="n">expect</span><span class="p">(</span><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_empty</span>
<span class="k">end</span>
</pre></div></div>
<p>Here we have used <code>Micropost.where</code> instead of <code>Micropost.find</code> because it returns an empty object if the record is not found instead of raising an exception, which is a little easier to test.<span class="intersentencespace"></span> (In case you’re curious, the code</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="k">do</span>
  <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">)</span>
</pre></div></div>
<p>does the trick in this case.)</p>
<p>Putting everything together leads to the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_dependency_test" class="hyperref">Listing&nbsp;<span class="ref">10.12</span></a>.</p>
<div class="codelisting" id="_code-micropost_dependency_test" data-tralics-id="uid789" data-number="10.12"><div class="heading"><span class="number">Listing 10.12:</span> 

<span class="description">Testing that microposts are destroyed when users are.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">"should destroy associated microposts"</span> <span class="k">do</span>
      <span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">to_a</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">microposts</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_empty</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_empty</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The application code to get <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_dependency_test" class="hyperref">Listing&nbsp;<span class="ref">10.12</span></a> to pass is less than one line; in fact, it’s just an option to the <code>has_many</code> association method, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_dependency" class="hyperref">Listing&nbsp;<span class="ref">10.13</span></a>.</p>
<div class="codelisting" id="_code-micropost_dependency" data-tralics-id="uid790" data-number="10.13"><div class="heading"><span class="number">Listing 10.13:</span> 

<span class="description">Ensuring that a user’s microposts are destroyed along with the user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Here the option <code>dependent: :destroy</code> in</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</pre></div></div>
<p>arranges for the dependent microposts (i.e., the ones belonging to the given user) to be destroyed when the user itself is destroyed.<span class="intersentencespace"></span> This prevents userless microposts from being stranded in the database when admins choose to remove users from the system.</p>
<p>With that, the final form of the user/micropost association is in place, and all the tests should be passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div>
<div id="_sec-micropost_validations" data-tralics-id="uid791" class="subsection" data-number="10.1.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-micropost_validations" class="heading hyperref"><span class="number">10.1.5 </span>Content validations</a></h3>
<p>Before leaving the Micropost model, we’ll add validations for the micropost <code>content</code> (following the example from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-putting_the_micro_in_microposts" class="hyperref">Section&nbsp;<span class="ref">2.3.2</span></a>).<span class="intersentencespace"></span> Like the <code>user_id</code>, the <code>content</code> attribute must be present, and it is further constrained to be no longer than 140 characters, making it an honest <em>micro</em>post.<span class="intersentencespace"></span> The tests generally follow the examples from the User model validation tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_validations" class="hyperref">Section&nbsp;<span class="ref">6.2</span></a>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_validations_tests" class="hyperref">Listing&nbsp;<span class="ref">10.14</span></a>.</p>
<div class="codelisting" id="_code-micropost_validations_tests" data-tralics-id="uid792" data-number="10.14"><div class="heading"><span class="number">Listing 10.14:</span> 

<span class="description">Tests for the Micropost model validations.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/micropost_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when user_id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"with blank content"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">" "</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"with content that is too long"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">141</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_validations" class="hyperref">Section&nbsp;<span class="ref">6.2</span></a>, the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_validations_tests" class="hyperref">Listing&nbsp;<span class="ref">10.14</span></a> uses string multiplication to test the micropost length validation:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">"a"</span> * 10
<span class="go">=&gt; "aaaaaaaaaa"</span>
<span class="gp">&gt;</span>&gt; <span class="s2">"a"</span> * 141
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
</pre></div></div>
<p>The application code is a one-liner:</p>
<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
</pre></div></div>
<p>The resulting Micropost model is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_validations" class="hyperref">Listing&nbsp;<span class="ref">10.15</span></a>.</p>
<div class="codelisting" id="_code-micropost_validations" data-tralics-id="uid793" data-number="10.15"><div class="heading"><span class="number">Listing 10.15:</span> 

<span class="description">The Micropost model validations.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div></div></div>
<div id="_sec-showing_microposts" data-tralics-id="cid61" class="section" data-number="10.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-showing_microposts" class="heading hyperref"><span class="number">10.2 </span>Showing microposts</a></h2>
<p>Although we don’t yet have a way to create microposts through the web—that comes in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_microposts" class="hyperref">Section&nbsp;<span class="ref">10.3.2</span></a>—that won’t stop us from displaying them (and testing that display).<span class="intersentencespace"></span> Following Twitter’s lead, we’ll plan to display a user’s microposts not on a separate microposts <code>index</code> page, but rather directly on the user <code>show</code> page itself, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_microposts_mockup" class="hyperref">Figure&nbsp;<span class="ref">10.4</span></a>.<span class="intersentencespace"></span> We’ll start with fairly simple ERb templates for adding a micropost display to the user profile, and then we’ll add microposts to the sample data populator from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_users" class="hyperref">Section&nbsp;<span class="ref">9.3.2</span></a> so that we have something to display.</p>
<div class="center figure" id="_fig-user_microposts_mockup" data-tralics-id="uid794" data-number="10.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_microposts_mockup_bootstrap.png" alt="images/figures/user_microposts_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 10.4: </span><span class="description">A mockup of a profile page with microposts.
</span></div></div>
<p>As with the discussion of the signin machinery in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a>, <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-augmenting_the_user_show_page" class="hyperref">Section <span class="ref">10.2.1</span></a> will often push several elements onto the <a href="http://en.wikipedia.org/wiki/Stack_(data_structure)" target="_blank">stack</a> at a time, and then pop them off one by one.<span class="intersentencespace"></span> If you start getting bogged down, be patient; there’s some nice payoff in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_microposts" class="hyperref">Section&nbsp;<span class="ref">10.2.2</span></a>.</p>
<div id="_sec-augmenting_the_user_show_page" data-tralics-id="uid795" class="subsection" data-number="10.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-augmenting_the_user_show_page" class="heading hyperref"><span class="number">10.2.1 </span>Augmenting the user show page</a></h3>
<p>We begin with tests for displaying the user’s microposts, which we’ll create in the request spec for Users.<span class="intersentencespace"></span> Our strategy is to create a couple of factory microposts associated with the user, and then verify that the show page contains each post’s content.<span class="intersentencespace"></span> We’ll also verify that, as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_microposts_mockup" class="hyperref">Figure&nbsp;<span class="ref">10.4</span></a>, the total number of microposts also gets displayed.</p>
<p>We can create the posts with the <code>let</code> method, but as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_ordering_test" class="hyperref">Listing&nbsp;<span class="ref">10.10</span></a> we want the association to exist immediately so that the posts appear on the user show page.<span class="intersentencespace"></span> To accomplish this, we use the <code>let!</code><span class="intersentencespace"></span> variant:</p>
<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Foo"</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Bar"</span><span class="p">)</span> <span class="p">}</span>

<span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>With the microposts so defined, we can test for their appearance on the profile page using the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts_test" class="hyperref">Listing&nbsp;<span class="ref">10.16</span></a>.</p>
<div class="codelisting" id="_code-user_show_microposts_test" data-tralics-id="uid796" data-number="10.16"><div class="heading"><span class="number">Listing 10.16:</span> 

<span class="description">A test for showing microposts on the user <code>show</code> page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Foo"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Bar"</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"microposts"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note here that we can use the <code>count</code> method <em>through</em> the association:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>The association <code>count</code> method is smart, and performs the count directly in the database.<span class="intersentencespace"></span> In particular, it does <em>not</em> pull all the microposts out of the database and then call <code>length</code> on the resulting array, as this could become inefficient as the number of microposts grew.<span class="intersentencespace"></span> Instead, it asks the database to count the microposts with the given <code>user_id</code>.<span class="intersentencespace"></span> In the unlikely event that finding the count is still a bottleneck in your application, you can make it even faster with a <a href="http://railscasts.com/episodes/23-counter-cache-column" target="_blank"><em>counter cache</em></a>.</p>
<p>Although all the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts_test" class="hyperref">Listing&nbsp;<span class="ref">10.16</span></a> won’t pass until <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_partial" class="hyperref">Listing&nbsp;<span class="ref">10.18</span></a>, we’ll get started on the application code by inserting a list of microposts into the user profile page, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.17</span></a>.</p>
<div class="codelisting" id="_code-user_show_microposts" data-tralics-id="uid797" data-number="10.17"><div class="heading"><span class="number">Listing 10.17:</span> 

<span class="description">Adding microposts to the user <code>show</code> page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  .
  .
  .
  <span class="nt">&lt;aside&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>We’ll deal with the microposts list momentarily, but there are several other things to note first.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.17</span></a>, the use of <code>if @user.microposts.any?</code> (a construction we saw before in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-errors_partial" class="hyperref">Listing&nbsp;<span class="ref">7.24</span></a>) makes sure that an empty list won’t be displayed when the user has no microposts.</p>
<p>Also note from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.17</span></a> that we’ve preemptively added pagination for microposts through</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>If you compare this with the analogous line on the user index page, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-will_paginate_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.33</span></a>, you’ll see that before we had just</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This worked because, in the context of the Users controller, <code>will_paginate</code> <em>assumes</em> the existence of an instance variable called <code>@users</code> (which, as we saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-pagination" class="hyperref">Section&nbsp;<span class="ref">9.3.3</span></a>, should be of class <code>ActiveRecord::Relation</code>).<span class="intersentencespace"></span> In the present case, since we are still in the Users controller but want to paginate <em>microposts</em> instead, we pass an explicit <code>@microposts</code> variable to <code>will_paginate</code>.<span class="intersentencespace"></span> Of course, this means that we will have to define such a variable in the user <code>show</code> action (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts_instance" class="hyperref">Listing&nbsp;<span class="ref">10.19</span></a>).</p>
<p>Finally, note that we have taken this opportunity to add a count of the current number of microposts:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
</pre></div></div>
<p>As noted, <code>@user.microposts.count</code> is the analogue of the <code>User.count</code> method, except that it counts the microposts belonging to a given user through the user/micropost association.</p>
<p>We come finally to the micropost list itself:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</pre></div></div>
<p>This code, which uses the <em>ordered list</em> tag&nbsp;<code>ol</code>, is responsible for generating the list of microposts, but you can see that it just defers the heavy lifting to a micropost partial.<span class="intersentencespace"></span> We saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-partial_refactoring" class="hyperref">Section&nbsp;<span class="ref">9.3.4</span></a> that the code</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>automatically renders each of the users in the <code>@users</code> variable using the <code>_user.html.erb</code> partial.<span class="intersentencespace"></span> Similarly, the code</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>does exactly the same thing for microposts.<span class="intersentencespace"></span> This means that we must define a <code>_micropost.html.erb</code> partial (along with a <code>micropost</code> views directory), as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_partial" class="hyperref">Listing&nbsp;<span class="ref">10.18</span></a>.</p>
<div class="codelisting" id="_code-micropost_partial" data-tralics-id="uid798" data-number="10.18"><div class="heading"><span class="number">Listing 10.18:</span> 

<span class="description">A partial for showing a single micropost.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/microposts/_micropost.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p>This uses the awesome <code>time_ago_in_words</code> helper method, whose effect we will see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_microposts" class="hyperref">Section&nbsp;<span class="ref">10.2.2</span></a>.</p>
<p>Thus far, despite defining all the relevant ERb templates, the test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts_test" class="hyperref">Listing&nbsp;<span class="ref">10.16</span></a> should have been failing for want of an <code>@microposts</code> variable.<span class="intersentencespace"></span> We can get it to pass with <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts_instance" class="hyperref">Listing&nbsp;<span class="ref">10.19</span></a>.</p>
<div class="codelisting" id="_code-user_show_microposts_instance" data-tralics-id="uid799" data-number="10.19"><div class="heading"><span class="number">Listing 10.19:</span> 

<span class="description">Adding an <code>@microposts</code> instance variable to the user <code>show</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Notice here how clever <code>paginate</code> is—it even works through the microposts association, reaching into the <span class="tt">microposts</span> table and pulling out the desired page of microposts.</p>
<p>At this point, we can get a look at our new user profile page in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_profile_no_microposts" class="hyperref">Figure&nbsp;<span class="ref">10.5</span></a>.<span class="intersentencespace"></span> It’s rather…disappointing.<span class="intersentencespace"></span> Of course, this is because there are not currently any microposts.<span class="intersentencespace"></span> It’s time to change that.</p>
<div class="center figure" id="_fig-user_profile_no_microposts" data-tralics-id="uid800" data-number="10.5">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_profile_no_microposts_bootstrap.png" alt="images/figures/user_profile_no_microposts_bootstrap"></div><div class="caption"><span class="header">Figure 10.5: </span><span class="description">The user profile page with code for microposts—but no microposts.
</span></div></div>
</div>
<div id="_sec-sample_microposts" data-tralics-id="uid801" class="subsection" data-number="10.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_microposts" class="heading hyperref"><span class="number">10.2.2 </span>Sample microposts</a></h3>
<p>With all the work making templates for user microposts in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-augmenting_the_user_show_page" class="hyperref">Section&nbsp;<span class="ref">10.2.1</span></a>, the ending was rather anticlimactic.<span class="intersentencespace"></span> We can rectify this sad situation by adding microposts to the sample populator from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_users" class="hyperref">Section&nbsp;<span class="ref">9.3.2</span></a>.<span class="intersentencespace"></span> Adding sample microposts for <em>all</em> the users actually takes a rather long time, so first we’ll select just the first six users<sup id="_cha-10_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-3">3</a></sup> using the <code>:limit</code> option to the <code>User.all</code> method:<sup id="_cha-10_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-4">4</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit</span><span class="p">:</span> <span class="mi">6</span><span class="p">)</span>
</pre></div></div>
<p>We then make 50 microposts for each user (plenty to overflow the pagination limit of&nbsp;30), generating sample content for each micropost using the Faker gem’s handy <a href="http://rubydoc.info/gems/faker/1.3.0/Faker/Lorem" target="_blank"><span class="tt">Lorem.sentence</span> method</a>.<span class="intersentencespace"></span> (<code>Faker::Lorem.sentence</code> returns <em>lorem ipsum</em> text; as noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>, <em>lorem ipsum</em> has a <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean" target="_blank">fascinating back story</a>.)<span class="intersentencespace"></span> The result is the new sample data populator shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sample_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.20</span></a>.</p>
<div class="codelisting" id="_code-sample_microposts" data-tralics-id="uid804" data-number="10.20"><div class="heading"><span class="number">Listing 10.20:</span> 

<span class="description">Adding microposts to the sample data.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">lib/tasks/sample_data.rake</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit</span><span class="p">:</span> <span class="mi">6</span><span class="p">)</span>
    <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Of course, to generate the new sample data we have to run the <code>db:populate</code> Rake task:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>With that, we are in a position to enjoy the fruits of our <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-augmenting_the_user_show_page" class="hyperref">Section&nbsp;<span class="ref">10.2.1</span></a> labors by displaying information for each micropost.<sup id="_cha-10_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-5">5</a></sup><span class="intersentencespace"></span> The preliminary results appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_profile_microposts_no_styling" class="hyperref">Figure&nbsp;<span class="ref">10.6</span></a>.</p>
<div class="center figure" id="_fig-user_profile_microposts_no_styling" data-tralics-id="uid806" data-number="10.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_profile_microposts_no_styling_bootstrap.png" alt="images/figures/user_profile_microposts_no_styling_bootstrap"></div><div class="caption"><span class="header">Figure 10.6: </span><span class="description">The user profile (<a href="http://localhost:3000/users/1" target="_blank">/users/1</a>) with unstyled microposts.
</span></div></div>
<p>The page shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_profile_microposts_no_styling" class="hyperref">Figure&nbsp;<span class="ref">10.6</span></a> has no micropost-specific styling, so let’s add some (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_css" class="hyperref">Listing&nbsp;<span class="ref">10.21</span></a>) and take a look the resulting pages.<sup id="_cha-10_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-6">6</a></sup><span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_profile_with_microposts" class="hyperref">Figure&nbsp;<span class="ref">10.7</span></a>, which displays the user profile page for the first (signed-in) user, while <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-other_profile_with_microposts" class="hyperref">Figure&nbsp;<span class="ref">10.8</span></a> shows the profile for a second user.<span class="intersentencespace"></span> Finally, <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_profile_microposts_page_2_rails_3" class="hyperref">Figure&nbsp;<span class="ref">10.9</span></a> shows the <em>second</em> page of microposts for the first user, along with the pagination links at the bottom of the display.<span class="intersentencespace"></span> In all three cases, observe that each micropost display indicates the time since it was created (e.g., “Posted 1 minute ago.”); this is the work of the <code>time_ago_in_words</code> method from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_partial" class="hyperref">Listing&nbsp;<span class="ref">10.18</span></a>.<span class="intersentencespace"></span> If you wait a couple minutes and reload the pages, you’ll see how the text gets automatically updated based on the new time.</p>
<div class="codelisting" id="_code-micropost_css" data-tralics-id="uid808" data-number="10.21"><div class="heading"><span class="number">Listing 10.21:</span> 

<span class="description">The CSS for microposts (including all the CSS for this chapter).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">;</span>

  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.content</span> <span class="p">{</span>
  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="na">height</span><span class="o">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="_fig-user_profile_with_microposts" data-tralics-id="uid809" data-number="10.7">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_profile_with_microposts_bootstrap.png" alt="images/figures/user_profile_with_microposts_bootstrap"></div><div class="caption"><span class="header">Figure 10.7: </span><span class="description">The user profile (<a href="http://localhost:3000/users/1" target="_blank">/users/1</a>) with microposts.
</span></div></div>
<div class="center figure" id="_fig-other_profile_with_microposts" data-tralics-id="uid810" data-number="10.8">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/other_profile_with_microposts_bootstrap.png" alt="images/figures/other_profile_with_microposts_bootstrap"></div><div class="caption"><span class="header">Figure 10.8: </span><span class="description">The profile of a different user, also with microposts (<a href="http://localhost:3000/users/5" target="_blank">/users/5</a>).
</span></div></div>
<div class="center figure" id="_fig-user_profile_microposts_page_2_rails_3" data-tralics-id="uid811" data-number="10.9">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_profile_microposts_page_2_rails_3_bootstrap.png" alt="images/figures/user_profile_microposts_page_2_rails_3_bootstrap"></div><div class="caption"><span class="header">Figure 10.9: </span><span class="description">Micropost pagination links (<a href="http://localhost:3000/users/1?page=2" target="_blank">/users/1?page=2</a>).
</span></div></div>
</div></div>
<div id="_sec-manipulating_microposts" data-tralics-id="cid62" class="section" data-number="10.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-manipulating_microposts" class="heading hyperref"><span class="number">10.3 </span>Manipulating microposts</a></h2>
<p>Having finished both the data modeling and display templates for microposts, we now turn our attention to the interface for creating them through the web.<span class="intersentencespace"></span> The result will be our third example of using an HTML form to create a resource—in this case, a Microposts resource.<sup id="_cha-10_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-7">7</a></sup><span class="intersentencespace"></span> In this section, we’ll also see the first hint of a <em>status feed</em>—a notion brought to full fruition in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>.<span class="intersentencespace"></span> Finally, as with users, we’ll make it possible to destroy microposts through the web.</p>
<p>There is one break with past convention worth noting: the interface to the Microposts resource will run principally through the Users and StaticPages controllers, so we won’t need actions like <code>new</code> or <code>edit</code> in the Microposts controller; we’ll only need <code>create</code> and <code>destroy</code>.<span class="intersentencespace"></span> This means that the routes for the Microposts resource are unusually simple, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_resource" class="hyperref">Listing&nbsp;<span class="ref">10.22</span></a>.<span class="intersentencespace"></span> The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_resource" class="hyperref">Listing&nbsp;<span class="ref">10.22</span></a> leads in turn to the RESTful routes shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-RESTful_microposts" class="hyperref">Table&nbsp;<span class="ref">10.2</span></a>, which is a small subset of the full set of routes seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-demo_RESTful_microposts" class="hyperref">Table&nbsp;<span class="ref">2.3</span></a>.<span class="intersentencespace"></span> Of course, this simplicity is a sign of being <em>more</em> advanced, not less—we’ve come a long way since our reliance on scaffolding in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-a_demo_app" class="hyperref">Chapter&nbsp;<span class="ref">2</span></a>, and we no longer need most of its complexity.</p>
<div class="codelisting" id="_code-microposts_resource" data-tralics-id="uid813" data-number="10.22"><div class="heading"><span class="number">Listing 10.22:</span> 

<span class="description">Routes for the Microposts resource.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="table" id="_table-RESTful_microposts" data-tralics-id="uid814" data-number="10.2"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><span class="tt">POST</span></td>
<td class="align_left">/microposts</td>
<td class="align_left"><code>create</code></td>
<td class="align_left">create a new micropost</td>
</tr><tr><td class="align_left"><span class="tt">DELETE</span></td>
<td class="align_left">/microposts/1</td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left">delete micropost with id <code>1</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 10.2: </span><span class="description">RESTful routes provided by the Microposts resource in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_resource" class="hyperref">Listing&nbsp;<span class="ref">10.22</span></a>.
</span></div></div>
<div id="_sec-access_control" data-tralics-id="uid815" class="subsection" data-number="10.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-access_control" class="heading hyperref"><span class="number">10.3.1 </span>Access control</a></h3>
<p>We begin our development of the Microposts resource with some access control in the Microposts controller.<span class="intersentencespace"></span> The idea is simple: both the <code>create</code> and <code>destroy</code> actions should require users to be signed in.<span class="intersentencespace"></span> The RSpec code to test for this appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_access_control" class="hyperref">Listing&nbsp;<span class="ref">10.23</span></a>.<span class="intersentencespace"></span> (We’ll test for and add a third protection—ensuring that only a micropost’s user can destroy it—in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-destroying_microposts" class="hyperref">Section&nbsp;<span class="ref">10.3.4</span></a>.)</p>
<div class="codelisting" id="_code-micropost_access_control" data-tralics-id="uid816" data-number="10.23"><div class="heading"><span class="number">Listing 10.23:</span> 

<span class="description">Access control tests for microposts.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"in the Microposts controller"</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">"submitting to the create action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">microposts_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"submitting to the destroy action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">))</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Rather than using the (yet-to-be-built) web interface for microposts, the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_access_control" class="hyperref">Listing&nbsp;<span class="ref">10.23</span></a> operates at the level of the individual micropost actions, a strategy we first saw in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-edit_update_wrong_user_tests" class="hyperref">Listing&nbsp;<span class="ref">9.13</span></a>.<span class="intersentencespace"></span> In this case, a non-signed-in user is redirected upon submitting a <span class="tt">POST</span> request to /microposts (<code>post microposts_path</code>, which hits the <code>create</code> action) or submitting a <span class="tt">DELETE</span> request to /microposts/1 (<code>delete micropost_path(micropost)</code>, which hits the <code>destroy</code> action).</p>
<p>Writing the application code needed to get the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_access_control" class="hyperref">Listing&nbsp;<span class="ref">10.23</span></a> to pass requires a little refactoring first.<span class="intersentencespace"></span> Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-requiring_signed_in_users" class="hyperref">Section&nbsp;<span class="ref">9.2.1</span></a> that we enforced the signin requirement using a before filter that called the <code>signed_in_user</code> method (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-authorize_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.12</span></a>).<span class="intersentencespace"></span> At the time, we only needed that method in the Users controller, but now we find that we need it in the Microposts controller as well, so we’ll move it into the Sessions helper, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_helper_authenticate" class="hyperref">Listing&nbsp;<span class="ref">10.24</span></a>.<sup id="_cha-10_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-8">8</a></sup></p>
<div class="codelisting" id="_code-sessions_helper_authenticate" data-tralics-id="uid818" data-number="10.24"><div class="heading"><span class="number">Listing 10.24:</span> 

<span class="description">Moving the <code>signed_in_user</code> method into the Sessions helper.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in_user</span>
    <span class="k">unless</span> <span class="n">signed_in?</span>
      <span class="n">store_location</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Please sign in."</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To avoid code repetition, you should also remove <code>signed_in_user</code> from the Users controller at this time.</p>
<p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_helper_authenticate" class="hyperref">Listing&nbsp;<span class="ref">10.24</span></a>, the <code>signed_in_user</code> method is now available in the Microposts controller, which means that we can restrict access to the <code>create</code> and <code>destroy</code> actions with the before filter shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_controller_access_control" class="hyperref">Listing&nbsp;<span class="ref">10.25</span></a>.<span class="intersentencespace"></span> (Since we didn’t generate it at the command line, you will have to create the Microposts controller file by hand.)</p>
<div class="codelisting" id="_code-microposts_controller_access_control" data-tralics-id="uid819" data-number="10.25"><div class="heading"><span class="number">Listing 10.25:</span> 

<span class="description">Adding authentication to the Microposts controller actions.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we haven’t restricted the actions the before filter applies to since it applies to them both by default.<span class="intersentencespace"></span> If we were to add, say, an <code>index</code> action accessible even to non-signed-in users, we would need to specify the protected actions explicitly:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>At this point, the tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb
</pre></div></div>
</div>
<div id="_sec-creating_microposts" data-tralics-id="uid820" class="subsection" data-number="10.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_microposts" class="heading hyperref"><span class="number">10.3.2 </span>Creating microposts</a></h3>
<p>In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_up" class="hyperref">Chapter&nbsp;<span class="ref">7</span></a>, we implemented user signup by making an HTML form that issued an HTTP <span class="tt">POST</span> request to the <code>create</code> action in the Users controller.<span class="intersentencespace"></span> The implementation of micropost creation is similar; the main difference is that, rather than using a separate page at /microposts/new, we will (following Twitter’s convention) put the form on the Home page itself (i.e., the root path&nbsp;/), as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_page_with_micropost_form_mockup" class="hyperref">Figure&nbsp;<span class="ref">10.10</span></a>.</p>
<div class="center figure" id="_fig-home_page_with_micropost_form_mockup" data-tralics-id="uid821" data-number="10.10">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_page_with_micropost_form_mockup_bootstrap.png" alt="images/figures/home_page_with_micropost_form_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 10.10: </span><span class="description">A mockup of the Home page with a form for creating microposts.
</span></div></div>
<p>When we last left the Home page, it appeared as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-sample_app_logo" class="hyperref">Figure&nbsp;<span class="ref">5.6</span></a>—that is, it had a “Sign up now!”<span class="intersentencespace"></span> button in the middle.<span class="intersentencespace"></span> Since a micropost creation form only makes sense in the context of a particular signed-in user, one goal of this section will be to serve different versions of the Home page depending on a visitor’s signin status.<span class="intersentencespace"></span> We’ll implement this in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_home_page" class="hyperref">Listing&nbsp;<span class="ref">10.28</span></a> below, but we can still write the tests now.<span class="intersentencespace"></span> As with the Users resource, we’ll use an integration test:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test micropost_pages
</pre></div></div>
<p>The micropost creation tests then parallel those for user creation from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-basic_signup_tests" class="hyperref">Listing&nbsp;<span class="ref">7.16</span></a>; the result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_create_tests" class="hyperref">Listing&nbsp;<span class="ref">10.26</span></a>.</p>
<div class="codelisting" id="_code-microposts_create_tests" data-tralics-id="uid822" data-number="10.26"><div class="heading"><span class="number">Listing 10.26:</span> 

<span class="description">Tests for creating microposts.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/micropost_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Micropost pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"micropost creation"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"with invalid information"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">"should not create a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"error messages"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"with valid information"</span> <span class="k">do</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">fill_in</span> <span class="s1">'micropost_content'</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s2">"should create a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Post"</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We’ll start with the <code>create</code> action for microposts, which is similar to its user analogue (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_create_action" class="hyperref">Listing&nbsp;<span class="ref">7.26</span></a>); the principal difference lies in using the user/micropost association to <code>build</code> the new micropost, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_create_action" class="hyperref">Listing&nbsp;<span class="ref">10.27</span></a>.<span class="intersentencespace"></span> Note the use of strong parameters via <code>micropost_params</code>, which permits only the micropost content to be edited through the web.</p>
<div class="codelisting" id="_code-microposts_create_action" data-tralics-id="uid823" data-number="10.27"><div class="heading"><span class="number">Listing 10.27:</span> 

<span class="description">The Microposts controller <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To build a form for creating microposts, we use the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_home_page" class="hyperref">Listing&nbsp;<span class="ref">10.28</span></a>, which serves up different HTML based on whether the site visitor is signed in or not.</p>
<div class="codelisting" id="_code-microposts_home_page" data-tralics-id="uid824" data-number="10.28"><div class="heading"><span class="number">Listing 10.28:</span> 

<span class="description">Adding microposts creation to the Home page (<a href="http://localhost:3000/" target="_blank">/</a>).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"span4"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"center hero-unit"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;h2&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/h2&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span>
                                <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">"rails.png"</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="s2">"Rails"</span><span class="p">),</span> <span class="s1">'http://rubyonrails.org/'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>Having so much code in each branch of the <code>if</code>-<code>else</code> conditional is a bit messy, and cleaning it up using partials is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-micropost_exercises" class="hyperref">Section&nbsp;<span class="ref">10.5</span></a>).<span class="intersentencespace"></span> Filling in the necessary partials from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_home_page" class="hyperref">Listing&nbsp;<span class="ref">10.28</span></a> isn’t an exercise, though; we fill in the new Home page sidebar in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_info" class="hyperref">Listing&nbsp;<span class="ref">10.29</span></a>
and the micropost form partial in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_form" class="hyperref">Listing&nbsp;<span class="ref">10.30</span></a>.</p>
<div class="codelisting" id="_code-user_info" data-tralics-id="uid825" data-number="10.29"><div class="heading"><span class="number">Listing 10.29:</span> 

<span class="description">The partial for the user info sidebar.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_user_info.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">52</span><span class="p">),</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"micropost"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
</pre></div></div></div><p>As in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_index_view" class="hyperref">Listing&nbsp;<span class="ref">9.24</span></a>, the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_info" class="hyperref">Listing&nbsp;<span class="ref">10.29</span></a> uses the version of the <code>gravatar_for</code> helper defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-gravatar_option" class="hyperref">Listing&nbsp;<span class="ref">7.30</span></a>.</p>
<p>Note that, as in the profile sidebar (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.17</span></a>), the user info in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_info" class="hyperref">Listing&nbsp;<span class="ref">10.29</span></a> displays the total number of microposts for the user.<span class="intersentencespace"></span> There’s a slight difference in the display, though; in the profile sidebar, “Microposts” is a label, and showing “Microposts (1)” makes sense.<span class="intersentencespace"></span> In the present case, though, saying “1 microposts” is ungrammatical, so we arrange to display “1 micropost” (but “2 microposts”) using <code>pluralize</code>.</p>
<p>We next define the form for creating microposts (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_form" class="hyperref">Listing&nbsp;<span class="ref">10.30</span></a>), which is similar to the signup form in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_form" class="hyperref">Listing&nbsp;<span class="ref">7.17</span></a>.</p>
<div class="codelisting" id="_code-micropost_form" data-tralics-id="uid826" data-number="10.30"><div class="heading"><span class="number">Listing 10.30:</span> 

<span class="description">The form partial for creating microposts.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_micropost_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">"Compose new micropost..."</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Post"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>We need to make two changes before the form in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_form" class="hyperref">Listing&nbsp;<span class="ref">10.30</span></a> will work.<span class="intersentencespace"></span> First, we need to define <code>@micropost</code>, which (as before) we do through the association:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div></div>
<p>The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_instance_variable" class="hyperref">Listing&nbsp;<span class="ref">10.31</span></a>.</p>
<div class="codelisting" id="_code-micropost_instance_variable" data-tralics-id="uid827" data-number="10.31"><div class="heading"><span class="number">Listing 10.31:</span> 

<span class="description">Adding a micropost instance variable to the <code>home</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_instance_variable" class="hyperref">Listing&nbsp;<span class="ref">10.31</span></a> has the advantage that it will break the test suite if we forget to require the user to sign in.</p>
<p>The second change needed to get <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_form" class="hyperref">Listing&nbsp;<span class="ref">10.30</span></a> to work is to redefine the error messages partial so that</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>works.<span class="intersentencespace"></span> You may recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-f_error_messages" class="hyperref">Listing&nbsp;<span class="ref">7.23</span></a> that the error messages partial references the <code>@user</code> variable explicitly, but in the present case we have an <code>@micropost</code> variable instead.<span class="intersentencespace"></span> We should define an error messages partial that works regardless of the kind of object passed to it.<span class="intersentencespace"></span> Happily, the form variable&nbsp;<code>f</code> can access the associated object through <code>f.object</code>, so that in</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div></div>
<p><code>f.object</code> is <code>@user</code>, and in</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div></div>
<p><code>f.object</code> is <code>@micropost</code>.</p>
<p>To pass the object to the partial, we use a hash with value equal to the object and key equal to the desired name of the variable in the partial, which is what this code accomplishes:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>In other words, <code>object: f.object</code> creates a variable called <code>object</code> in the <code>error_messages</code> partial.<span class="intersentencespace"></span> We can use this object to construct a customized error message, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-updated_error_messages_partial" class="hyperref">Listing&nbsp;<span class="ref">10.32</span></a>.</p>
<div class="codelisting" id="_code-updated_error_messages_partial" data-tralics-id="uid828" data-number="10.32"><div class="heading"><span class="number">Listing 10.32:</span> 

<span class="description">Updating the error-messages partial from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-errors_partial" class="hyperref">Listing&nbsp;<span class="ref">7.24</span></a> to work with other objects.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_error_messages.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-error"</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>As this point, the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_create_tests" class="hyperref">Listing&nbsp;<span class="ref">10.26</span></a> should be passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/micropost_pages_spec.rb
</pre></div></div>
<p>Unfortunately, the User request spec is now broken because the signup and edit forms use the old version of the error messages partial.<span class="intersentencespace"></span> To fix them, we’ll update them with the more general version, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-signup_errors_updated" class="hyperref">Listing&nbsp;<span class="ref">10.33</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-edit_errors_updated" class="hyperref">Listing&nbsp;<span class="ref">10.34</span></a>.<span class="intersentencespace"></span> (<em>Note</em>: Your code will differ if you implemented <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_edit_partial" class="hyperref">Listing&nbsp;<span class="ref">9.49</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-new_user_with_partial" class="hyperref">Listing&nbsp;<span class="ref">9.50</span></a> from the exercises in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-updating_deleting_exercises" class="hyperref">Section&nbsp;<span class="ref">9.6</span></a>.<span class="intersentencespace"></span> <a href="http://en.wikipedia.org/wiki/Mutatis_mutandis" target="_blank"><em>Mutatis mutandis</em>.</a>)</p>
<div class="codelisting" id="_code-signup_errors_updated" data-tralics-id="uid829" data-number="10.33"><div class="heading"><span class="number">Listing 10.33:</span> 

<span class="description">Updating the rendering of user signup errors.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-edit_errors_updated" data-tralics-id="uid830" data-number="10.34"><div class="heading"><span class="number">Listing 10.34:</span> 

<span class="description">Updating the errors for editing users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span6 offset3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>At this point, all the tests should be passing:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>Additionally, all the HTML in this section should render properly, showing the form as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_with_form" class="hyperref">Figure&nbsp;<span class="ref">10.11</span></a>, and a form with a submission error as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_form_errors" class="hyperref">Figure&nbsp;<span class="ref">10.12</span></a>.<span class="intersentencespace"></span> You are invited at this point to create a new post for yourself and verify that everything is working—but you should probably wait until after <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_proto_feed" class="hyperref">Section&nbsp;<span class="ref">10.3.3</span></a>.</p>
<div class="center figure" id="_fig-home_with_form" data-tralics-id="uid831" data-number="10.11">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_with_form_bootstrap.png" alt="images/figures/home_with_form_bootstrap"></div><div class="caption"><span class="header">Figure 10.11: </span><span class="description">The Home page (<a href="http://localhost:3000/" target="_blank">/</a>) with a new micropost form.
</span></div></div>
<div class="center figure" id="_fig-home_form_errors" data-tralics-id="uid832" data-number="10.12">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_form_errors_bootstrap.png" alt="images/figures/home_form_errors_bootstrap"></div><div class="caption"><span class="header">Figure 10.12: </span><span class="description">The home page with form errors.
</span></div></div>
</div>
<div id="_sec-a_proto_feed" data-tralics-id="uid833" class="subsection" data-number="10.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_proto_feed" class="heading hyperref"><span class="number">10.3.3 </span>A proto-feed</a></h3>
<p>The comment at the end of <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-creating_microposts" class="hyperref">Section&nbsp;<span class="ref">10.3.2</span></a> alluded to a problem: the current Home page doesn’t display any microposts.<span class="intersentencespace"></span> If you like, you can verify that the form shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_with_form" class="hyperref">Figure&nbsp;<span class="ref">10.11</span></a> is working by submitting a valid entry and then navigating to the <a href="http://localhost:3000/users/1" target="_blank">profile page</a> to see the post, but that’s rather cumbersome.<span class="intersentencespace"></span> It would be far better to have a <em>feed</em> of microposts that includes the user’s own posts, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-proto_feed_mockup" class="hyperref">Figure&nbsp;<span class="ref">10.13</span></a>.<span class="intersentencespace"></span> (In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>, we’ll generalize this feed to include the microposts of users being <em>followed</em> by the current user.)</p>
<div class="center figure" id="_fig-proto_feed_mockup" data-tralics-id="uid834" data-number="10.13">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/proto_feed_mockup_bootstrap.png" alt="images/figures/proto_feed_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 10.13: </span><span class="description">A mockup of the Home page with a proto-feed.
</span></div></div>
<p>Since each user should have a feed, we are led naturally to a <code>feed</code> method in the User model.<span class="intersentencespace"></span> Eventually, we will test that the feed returns the microposts of the users being followed, but for now we’ll just test that the <code>feed</code> method <em>includes</em> the current user’s microposts but <em>excludes</em> the posts of a different user.<span class="intersentencespace"></span> We can express these requirements in code with <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_specs" class="hyperref">Listing&nbsp;<span class="ref">10.35</span></a>.</p>
<div class="codelisting" id="_code-feed_specs" data-tralics-id="uid835" data-number="10.35"><div class="heading"><span class="number">Listing 10.35:</span> 

<span class="description">Tests for the (proto-)status feed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"status"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>These tests introduce (via the RSpec boolean convention) the array <code>include?</code> method, which simply checks if an array includes the given element:<sup id="_cha-10_footnote-ref-9" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-9">9</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"baz"</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>This example shows just how flexible the RSpec boolean convention is; even though <code>include</code> is already a Ruby keyword (used to include a module, as seen in, e.g., <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_helper_include" class="hyperref">Listing&nbsp;<span class="ref">8.14</span></a>), in this context RSpec correctly guesses that we want to test array inclusion.</p>
<p>We can arrange for an appropriate micropost <code>feed</code> method by selecting all the microposts with <code>user_id</code> equal to the current user’s id, which we accomplish using the <code>where</code> method on the <code>Micropost</code> model, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-proto_status_feed" class="hyperref">Listing&nbsp;<span class="ref">10.36</span></a>.<sup id="_cha-10_footnote-ref-10" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-10">10</a></sup></p>
<div class="codelisting" id="_code-proto_status_feed" data-tralics-id="uid838" data-number="10.36"><div class="heading"><span class="number">Listing 10.36:</span> 

<span class="description">A preliminary implementation for the micropost status feed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="c1"># This is preliminary. See "Following users" for the full implementation.</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The question mark in</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>ensures that <code>id</code>&nbsp;is properly <em>escaped</em> before being included in the underlying SQL query, thereby avoiding a serious security hole called <a href="http://en.wikipedia.org/wiki/SQL_injection" target="_blank"><em>SQL injection</em></a>.<span class="intersentencespace"></span> The <code>id</code> attribute here is just an integer (i.e., <code>self.id</code>, the unique ID of the user), so there is no danger in this case, but <em>always</em> escaping variables injected into SQL statements is a good habit to cultivate.</p>
<p>Alert readers might note at this point that the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-proto_status_feed" class="hyperref">Listing&nbsp;<span class="ref">10.36</span></a> is essentially equivalent to writing</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div></div>
<p>We’ve used the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-proto_status_feed" class="hyperref">Listing&nbsp;<span class="ref">10.36</span></a> instead because it generalizes much more naturally to the full status feed needed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>.</p>
<p>To test the display of the status feed, we first create a couple of microposts and then verify that a list element (<code>li</code>) appears on the page for each one (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_feed_test" class="hyperref">Listing&nbsp;<span class="ref">10.37</span></a>).</p>
<div class="codelisting" id="_code-home_page_feed_test" data-tralics-id="uid839" data-number="10.37"><div class="heading"><span class="number">Listing 10.37:</span> 

<span class="description">A test for rendering the feed on the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"for signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Dolor sit amet"</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"should render the user's feed"</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_feed_test" class="hyperref">Listing&nbsp;<span class="ref">10.37</span></a> assumes that each feed item has a unique CSS&nbsp;id, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div></div>
<p>will generate a match for each item.<span class="intersentencespace"></span> (Note that the first&nbsp;<code>#</code> in <code>li##{item.id}</code> is Capybara syntax for a CSS&nbsp;id, whereas the second&nbsp;<code>#</code> is the beginning of a Ruby string interpolation&nbsp;<code>#{}</code>.)</p>
<p>To use the feed in the sample application, we add an <code>@feed_items</code> instance variable for the current user’s (paginated) feed, as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_instance_variable" class="hyperref">Listing&nbsp;<span class="ref">10.38</span></a>, and then add a feed partial (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_partial" class="hyperref">Listing&nbsp;<span class="ref">10.39</span></a>) to the Home page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_with_feed" class="hyperref">Listing&nbsp;<span class="ref">10.41</span></a>).<span class="intersentencespace"></span> (Adding tests for pagination is left as an exercise; see <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-micropost_exercises" class="hyperref">Section&nbsp;<span class="ref">10.5</span></a>.)</p>
<div class="codelisting" id="_code-feed_instance_variable" data-tralics-id="uid840" data-number="10.38"><div class="heading"><span class="number">Listing 10.38:</span> 

<span class="description">Adding a feed instance variable to the <code>home</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-feed_partial" data-tralics-id="uid841" data-number="10.39"><div class="heading"><span class="number">Listing 10.39:</span> 

<span class="description">The status feed partial.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_feed.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial</span><span class="p">:</span> <span class="s1">'shared/feed_item'</span><span class="p">,</span> <span class="ss">collection</span><span class="p">:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ol&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>The status feed partial defers the feed item rendering to a feed item partial using the code</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial</span><span class="p">:</span> <span class="s1">'shared/feed_item'</span><span class="p">,</span> <span class="ss">collection</span><span class="p">:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Here we pass a <code>:collection</code> parameter with the feed items, which causes <code>render</code> to use the given partial (<code>’feed_item’</code> in this case) to render each item in the collection.<span class="intersentencespace"></span> (We have omitted the <code>:partial</code> parameter in previous renderings, writing, e.g., <code>render ’shared/micropost’</code>, but with a <code>:collection</code> parameter that syntax doesn’t work.)<span class="intersentencespace"></span> The feed item partial itself appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_item_partial" class="hyperref">Listing&nbsp;<span class="ref">10.40</span></a>.</p>
<div class="codelisting" id="_code-feed_item_partial" data-tralics-id="uid842" data-number="10.40"><div class="heading"><span class="number">Listing 10.40:</span> 

<span class="description">A partial for a single feed item.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_feed_item.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_item_partial" class="hyperref">Listing&nbsp;<span class="ref">10.40</span></a> also adds a CSS&nbsp;id for each feed item using</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
</pre></div></div>
<p>as required by the test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_feed_test" class="hyperref">Listing&nbsp;<span class="ref">10.37</span></a>.</p>
<p>We can then add the feed to the Home page by rendering the feed partial as usual (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_with_feed" class="hyperref">Listing&nbsp;<span class="ref">10.41</span></a>).<span class="intersentencespace"></span> The result is a display of the feed on the Home page, as required (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_with_proto_feed" class="hyperref">Figure&nbsp;<span class="ref">10.14</span></a>).</p>
<div class="codelisting" id="_code-home_with_feed" data-tralics-id="uid843" data-number="10.41"><div class="heading"><span class="number">Listing 10.41:</span> 

<span class="description">Adding a status feed to the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    .
    .
    .
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="center figure" id="_fig-home_with_proto_feed" data-tralics-id="uid844" data-number="10.14">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_with_proto_feed_bootstrap.png" alt="images/figures/home_with_proto_feed_bootstrap"></div><div class="caption"><span class="header">Figure 10.14: </span><span class="description">The Home page (<a href="http://localhost:3000/" target="_blank">/</a>) with a proto-feed.
</span></div></div>
<p>At this point, creating a new micropost works as expected, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-micropost_created" class="hyperref">Figure&nbsp;<span class="ref">10.15</span></a>.<span class="intersentencespace"></span> There is one subtlety, though: on <em>failed</em> micropost submission, the Home page expects an <code>@feed_items</code> instance variable, so failed submissions currently break (as you should be able to verify by running your test suite).<span class="intersentencespace"></span> The easiest solution is to suppress the feed entirely by assigning it an empty array, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_create_action_with_feed" class="hyperref">Listing&nbsp;<span class="ref">10.42</span></a>.<sup id="_cha-10_footnote-ref-11" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-11">11</a></sup></p>
<div class="center figure" id="_fig-micropost_created" data-tralics-id="uid846" data-number="10.15">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/micropost_created_bootstrap.png" alt="images/figures/micropost_created_bootstrap"></div><div class="caption"><span class="header">Figure 10.15: </span><span class="description">The Home page after creating a new micropost.
</span></div></div>
<div class="codelisting" id="_code-microposts_create_action_with_feed" data-tralics-id="uid847" data-number="10.42"><div class="heading"><span class="number">Listing 10.42:</span> 

<span class="description">Adding an (empty) <code>@feed_items</code> instance variable to the <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">micropost_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">render</span> <span class="s1">'static_pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the proto-feed should be working, and the test suite should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-destroying_microposts" data-tralics-id="uid848" class="subsection" data-number="10.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-destroying_microposts" class="heading hyperref"><span class="number">10.3.4 </span>Destroying microposts</a></h3>
<p>The last piece of functionality to add to the Microposts resource is the ability to destroy posts.<span class="intersentencespace"></span> As with user deletion (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_destroy_action" class="hyperref">Section&nbsp;<span class="ref">9.4.2</span></a>), we accomplish this with “delete” links, as mocked up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-micropost_delete_links_mockup" class="hyperref">Figure&nbsp;<span class="ref">10.16</span></a>.<span class="intersentencespace"></span> Unlike that case, which restricted user destruction to admin users, the delete links will work only for microposts created by the current user.</p>
<div class="center figure" id="_fig-micropost_delete_links_mockup" data-tralics-id="uid849" data-number="10.16">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/micropost_delete_links_mockup_bootstrap.png" alt="images/figures/micropost_delete_links_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 10.16: </span><span class="description">A mockup of the proto-feed with micropost delete links.
</span></div></div>
<p>Our first step is to add a delete link to the micropost partial as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_item_partial" class="hyperref">Listing&nbsp;<span class="ref">10.40</span></a>, and while we’re at it we’ll add a similar link to the feed item partial from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_item_partial" class="hyperref">Listing&nbsp;<span class="ref">10.40</span></a>.<span class="intersentencespace"></span> The results appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_partial_with_delete" class="hyperref">Listing&nbsp;<span class="ref">10.43</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_item_partial_with_delete" class="hyperref">Listing&nbsp;<span class="ref">10.44</span></a>.<span class="intersentencespace"></span> (The two cases are almost identical, and eliminating this duplication is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-micropost_exercises" class="hyperref">Section&nbsp;<span class="ref">10.5</span></a>).)</p>
<div class="codelisting" id="_code-micropost_partial_with_delete" data-tralics-id="uid850" data-number="10.43"><div class="heading"><span class="number">Listing 10.43:</span> 

<span class="description">Adding a delete link to the micropost partial.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/microposts/_micropost.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">},</span>
                                     <span class="ss">title</span><span class="p">:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-feed_item_partial_with_delete" data-tralics-id="uid851" data-number="10.44"><div class="heading"><span class="number">Listing 10.44:</span> 

<span class="description">The feed item partial with added delete link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_feed_item.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">},</span>
                                     <span class="ss">title</span><span class="p">:</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p>The test for destroying microposts uses Capybara to click the “delete” link and expects the Micropost count to decrease by&nbsp;1 (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_destroy_specs" class="hyperref">Listing&nbsp;<span class="ref">10.45</span></a>).</p>
<div class="codelisting" id="_code-micropost_destroy_specs" data-tralics-id="uid852" data-number="10.45"><div class="heading"><span class="number">Listing 10.45:</span> 

<span class="description">Tests for the Microposts controller <code>destroy</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/micropost_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Micropost pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost destruction"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"as correct user"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">"should delete a micropost"</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">"delete"</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The application code is also analogous to the user case in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-admin_destroy_before_filter" class="hyperref">Listing&nbsp;<span class="ref">9.46</span></a>; the main difference is that, rather than using an <code>admin_user</code> before filter, in the case of microposts we have a <code>correct_user</code> before filter to check that the current user actually has a micropost with the given id.<span class="intersentencespace"></span> The code appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_destroy_action" class="hyperref">Listing&nbsp;<span class="ref">10.46</span></a>, and the result of destroying the second-most-recent post appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_post_delete" class="hyperref">Figure&nbsp;<span class="ref">10.17</span></a>.</p>
<div class="codelisting" id="_code-microposts_destroy_action" data-tralics-id="uid853" data-number="10.46"><div class="heading"><span class="number">Listing 10.46:</span> 

<span class="description">The Microposts controller <code>destroy</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/microposts_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">micropost_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>In the <code>correct_user</code> before filter, note that we find microposts <em>through</em> the association:</p>
<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>This automatically ensures that we find only microposts belonging to the current user.<span class="intersentencespace"></span> In this case, we use <code>find_by</code> instead of <code>find</code> because the latter raises an exception when the micropost doesn’t exist instead of returning <code>nil</code>.<span class="intersentencespace"></span> By the way, if you’re comfortable with exceptions in Ruby, you could also write the <code>correct_user</code> filter like this:</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">correct_user</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">rescue</span>
  <span class="n">redirect_to</span> <span class="n">root_url</span>
<span class="k">end</span>
</pre></div></div>
<p>It might occur to you that we could implement the <code>correct_user</code> filter using the <code>Micropost</code> model directly, like this:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>This would be equivalent to the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_destroy_action" class="hyperref">Listing&nbsp;<span class="ref">10.46</span></a>, but, as explained by <a href="http://www.rubyfocus.biz/" target="_blank">Wolfram Arnold</a> in the blog post <a href="http://www.rubyfocus.biz/blog/2011/06/15/access_control_101_in_rails_and_the_citibank-hack.html" target="_blank">Access Control 101 in Rails and the Citibank Hack</a>, for security purposes it is a good practice always to run lookups through the association.</p>
<div class="center figure" id="_fig-home_post_delete" data-tralics-id="uid854" data-number="10.17">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_post_delete_bootstrap.png" alt="images/figures/home_post_delete_bootstrap"></div><div class="caption"><span class="header">Figure 10.17: </span><span class="description">The user home page after deleting the second-most-recent micropost.
</span></div></div>
<p>With the code in this section, our Micropost model and interface are complete, and the test suite should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div></div>
<div id="_cid63" data-tralics-id="cid63" class="section" data-number="10.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#cid63" class="heading hyperref"><span class="number">10.4 </span>Conclusion</a></h2>
<p>With the addition of the Microposts resource, we are nearly finished with our sample application.<span class="intersentencespace"></span> All that remains is to add a social layer by letting users follow each other.<span class="intersentencespace"></span> We’ll learn how to model such user relationships, and see the implications for the status feed, in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="hyperref">Chapter&nbsp;<span class="ref">11</span></a>.</p>
<p>Before proceeding, be sure to commit and merge your changes if you’re using Git for version control:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add user microposts"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge user-microposts
<span class="gp">$</span> git push
</pre></div></div>
<p>You can also push the app up to Heroku at this point.<span class="intersentencespace"></span> Because the data model has changed through the addition of the <code>microposts</code> table, you will also need to migrate the production database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div></div>
</div>
<div id="_sec-micropost_exercises" data-tralics-id="cid64" class="section" data-number="10.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-micropost_exercises" class="heading hyperref"><span class="number">10.5 </span>Exercises</a></h2>
<p>We’ve covered enough material now that there is a combinatorial explosion of possible extensions to the application.<span class="intersentencespace"></span> Below are just a few of the many possibilities.</p>
<ol>
<li>Add tests for the sidebar micropost counts (including proper pluralization).<span class="intersentencespace"></span>
</li>
<li>Add tests for micropost pagination.<span class="intersentencespace"></span>
</li>
<li>Refactor the Home page to use separate partials for the two branches of the <code>if</code>-<code>else</code> statement.<span class="intersentencespace"></span>
</li>
<li>Write a test to make sure delete links do not appear for microposts not created by the current user.<span class="intersentencespace"></span>
</li>
<li>Using partials, eliminate the duplication in the delete links from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_partial_with_delete" class="hyperref">Listing&nbsp;<span class="ref">10.43</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_item_partial_with_delete" class="hyperref">Listing&nbsp;<span class="ref">10.44</span></a>.<span class="intersentencespace"></span>
</li>
<li>Very long words currently break our layout, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-long_word_micropost" class="hyperref">Figure&nbsp;<span class="ref">10.18</span></a>.<span class="intersentencespace"></span> Fix this problem using the <code>wrap</code> helper defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-wrap" class="hyperref">Listing&nbsp;<span class="ref">10.47</span></a>.<span class="intersentencespace"></span> Note the use of the <code>raw</code> method to prevent Rails from escaping the resulting HTML, together with the <code>sanitize</code> method needed to prevent cross-site scripting.<span class="intersentencespace"></span> This code also uses the strange-looking but useful <em>ternary operator</em> (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-ternary_operator" class="hyperref">Box&nbsp;<span class="ref">10.1</span></a>).<span class="intersentencespace"></span>
</li>
<li><strong>(challenging)</strong> Add a JavaScript display to the Home page to count down from&nbsp;140 characters.<span class="intersentencespace"></span>
</li></ol>
<div class="aside" id="_sidebar-ternary_operator" data-tralics-id="uid862" data-number="10.1"><div class="heading"><span class="number">Box 10.1.</span> 

<span class="description">10 types of people</span></div>
<p>There are 10 kinds of people in the world: Those who like the ternary operator, those who don’t, and those who don’t know about it.<span class="intersentencespace"></span> (If you happen to be in the third category, soon you won’t be any longer.)</p>
<p>When you do a lot of programming, you quickly learn that one of the most common bits of control flow goes something like this:</p>
<pre>  if boolean?
    do_one_thing
  else
    do_something_else
  end</pre>
<p>Ruby, like many other languages (including C/C++, Perl, PHP, and Java), allows you to replace this with a much more compact expression using the <em>ternary operator</em> (so called because it consists of three parts):</p>
<pre>  boolean? ? do_one_thing : do_something_else</pre>
<p>You can also use the ternary operator to replace assignment:</p>
<pre>  if boolean?
    var = foo
  else
    var = bar
  end</pre>
<p>becomes</p>
<pre>  var = boolean? ? foo : bar</pre>
<p>Another common use is in a function’s return value:</p>
<pre>  def foo
    do_stuff
    boolean? ? "bar" : "baz"
  end</pre>
<p>Since Ruby implicitly returns the value of the last expression in a function, here the <span class="tt">foo</span> method returns <span class="tt">"bar"</span> or <span class="tt">"baz"</span> depending on the value of <span class="tt">boolean?</span>.<span class="intersentencespace"></span> It is this final construction that appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-wrap" class="hyperref">Listing&nbsp;<span class="ref">10.47</span></a>.<span class="intersentencespace"></span></p>

</div><div class="center figure" id="_fig-long_word_micropost" data-tralics-id="uid863" data-number="10.18">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/long_word_micropost_bootstrap.png" alt="images/figures/long_word_micropost_bootstrap"></div><div class="caption"><span class="header">Figure 10.18: </span><span class="description">The (broken) site layout with a particularly long word.
</span></div></div>
<div class="codelisting" id="_code-wrap" data-tralics-id="uid864" data-number="10.47"><div class="heading"><span class="number">Listing 10.47:</span> 

<span class="description">A helper to wrap long words.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/microposts_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">"&amp;#8203;"</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span>
                                  <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="cha-10_footnotes">
  <ol class="footnotes">
    <li id="_cha-10_footnote-1">Technically, we treated sessions as a resource in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-sign_in_sign_out" class="hyperref">Chapter&nbsp;<span class="ref">8</span></a>, but sessions are not saved to the database the way users and microposts are.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-1">↑</a></li>
    <li id="_cha-10_footnote-2">The <code>content</code> attribute will be a <code>string</code>, but, as noted briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-modeling_demo_microposts" class="hyperref">Section&nbsp;<span class="ref">2.1.2</span></a>, for longer text fields you should use the <code>text</code> data type.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-2">↑</a></li>
    <li id="_cha-10_footnote-3">(i.e., the five users with custom Gravatars, and one with the default Gravatar)&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-3">↑</a></li>
    <li id="_cha-10_footnote-4">Tail your <code>log/development.log</code> file if you’re curious about the SQL this method generates.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-4">↑</a></li>
    <li id="_cha-10_footnote-5">By design, the Faker gem’s <em>lorem ipsum</em> text is randomized, so the contents of your sample microposts will differ.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-5">↑</a></li>
    <li id="_cha-10_footnote-6">For convenience, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_css" class="hyperref">Listing&nbsp;<span class="ref">10.21</span></a> actually has <em>all</em> the CSS needed for this chapter.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-6">↑</a></li>
    <li id="_cha-10_footnote-7">The other two resources are Users in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_form" class="hyperref">Section&nbsp;<span class="ref">7.2</span></a> and Sessions in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signin_failure" class="hyperref">Section&nbsp;<span class="ref">8.1</span></a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-7">↑</a></li>
    <li id="_cha-10_footnote-8">We noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-remember_me" class="hyperref">Section&nbsp;<span class="ref">8.2.1</span></a> that helper methods are available only in <em>views</em> by default, but we arranged for the Sessions helper methods to be available in the controllers as well by adding <code>include SessionsHelper</code> to the Application controller (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sessions_helper_include" class="hyperref">Listing&nbsp;<span class="ref">8.14</span></a>).&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-8">↑</a></li>
    <li id="_cha-10_footnote-9">Learning about methods such as <code>include?</code> is one reason why, as noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-comments_for_various_readers" class="hyperref">Section&nbsp;<span class="ref">1.1.1</span></a>, I recommend reading a pure Ruby book after finishing this one.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-9">↑</a></li>
    <li id="_cha-10_footnote-10">See the Rails Guide on the <a href="http://guides.rubyonrails.org/active_record_querying.html" target="_blank">Active Record Query Interface</a> for more on <code>where</code> and the like.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-10">↑</a></li>
    <li id="_cha-10_footnote-11">Unfortunately, returning a paginated feed doesn’t work in this case.<span class="intersentencespace"></span> Implement it and click on a pagination link to see why.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-10_footnote-ref-11">↑</a></li>
  </ol>
</div><div id="_cha-following_users" data-tralics-id="cid65" class="chapter" data-number="11"><h1><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-following_users" class="heading hyperref"><span class="number">Chapter 11 </span>Following users</a></h1>
<p><strong>Note: The <a href="http://draft.railstutorial.org/book" target="_blank">3rd edition of the <em><strong>Ruby on Rails Tutorial</strong></em><strong></strong></a> is now available.<span class="intersentencespace"></span> See the <a href="http://news.railstutorial.org/rails_tutorial_3rd_edition/" target="_blank">3rd edition announcement</a> for details.</strong></p>
<p>In this chapter, we will complete the core sample application by adding a social layer that allows users to follow (and unfollow) other users, resulting in each user’s Home page displaying a status feed of the followed users’ microposts.<span class="intersentencespace"></span> We will also make views to display both a user’s followers and the users each user is following.<span class="intersentencespace"></span> We will learn how to model relationships between users in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_relationship_model" class="hyperref">Section&nbsp;<span class="ref">11.1</span></a>, and then make the web interface in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_web_interface_for_following_and_followers" class="hyperref">Section&nbsp;<span class="ref">11.2</span></a> (including an introduction to Ajax).<span class="intersentencespace"></span> Finally, we’ll end by developing a fully functional status feed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_status_feed" class="hyperref">Section&nbsp;<span class="ref">11.3</span></a>.</p>
<p>This final chapter contains some of the most challenging material in the tutorial, including some Ruby/SQL trickery to make the status feed.<span class="intersentencespace"></span> Through these examples, you will see how Rails can handle even rather intricate data models, which should serve you well as you go on to develop your own applications with their own specific requirements.<span class="intersentencespace"></span> To help with the transition from tutorial to independent development, <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_conclusion" class="hyperref">Section&nbsp;<span class="ref">11.4</span></a> contains suggested extensions to the core sample application, along with pointers to more advanced resources.</p>
<p>As usual, Git users should create a new topic branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b following-users
</pre></div></div>
<p>Because the material in this chapter is particularly challenging, before writing any code we’ll pause for a moment and take a tour of the interface.<span class="intersentencespace"></span> As in previous chapters, at this early stage we’ll represent pages using mockups.<sup id="_cha-11_footnote-ref-1" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-1">1</a></sup><span class="intersentencespace"></span> The full page flow runs as follows: a user (John Calvin) starts at his profile page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-page_flow_profile_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.1</span></a>) and navigates to the Users page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-page_flow_user_index_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.2</span></a>) to select a user to follow.<span class="intersentencespace"></span> Calvin navigates to the profile of a second user, Thomas Hobbes (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-page_flow_other_profile_follow_button_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.3</span></a>), clicking on the “Follow” button to follow that user.<span class="intersentencespace"></span> This changes the “Follow” button to “Unfollow”, and increments Hobbes’s “followers” count by one (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-page_flow_other_profile_unfollow_button_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.4</span></a>).<span class="intersentencespace"></span> Navigating to his home page, Calvin now sees an incremented “following” count and finds Hobbes’s microposts in his status feed (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-page_flow_home_page_feed_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.5</span></a>).<span class="intersentencespace"></span> The rest of this chapter is dedicated to making this page flow actually work.</p>
<div class="center figure" id="_fig-page_flow_profile_mockup" data-tralics-id="uid866" data-number="11.1">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/page_flow_profile_mockup_bootstrap.png" alt="images/figures/page_flow_profile_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.1: </span><span class="description">The current user’s profile.
</span></div></div>
<div class="center figure" id="_fig-page_flow_user_index_mockup" data-tralics-id="uid867" data-number="11.2">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/page_flow_user_index_mockup_bootstrap.png" alt="images/figures/page_flow_user_index_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.2: </span><span class="description">Finding a user to follow.
</span></div></div>
<div class="center figure" id="_fig-page_flow_other_profile_follow_button_mockup" data-tralics-id="uid868" data-number="11.3">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/page_flow_other_profile_follow_button_mockup_bootstrap.png" alt="images/figures/page_flow_other_profile_follow_button_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.3: </span><span class="description">The profile of a user to follow, with a follow button.
</span></div></div>
<div class="center figure" id="_fig-page_flow_other_profile_unfollow_button_mockup" data-tralics-id="uid869" data-number="11.4">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/page_flow_other_profile_unfollow_button_mockup_bootstrap.png" alt="images/figures/page_flow_other_profile_unfollow_button_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.4: </span><span class="description">A profile with an unfollow button and incremented followers count.
</span></div></div>
<div class="center figure" id="_fig-page_flow_home_page_feed_mockup" data-tralics-id="uid870" data-number="11.5">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/page_flow_home_page_feed_mockup_bootstrap.png" alt="images/figures/page_flow_home_page_feed_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.5: </span><span class="description">The Home page with status feed and incremented following count.
</span></div></div>
</div>
<div id="_sec-the_relationship_model" data-tralics-id="cid66" class="section" data-number="11.1"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_relationship_model" class="heading hyperref"><span class="number">11.1 </span>The Relationship model</a></h2>
<p>Our first step in implementing following users is to construct a data model, which is not as straightforward as it seems.<span class="intersentencespace"></span> Naïvely, it seems that a <code>has_many</code> relationship should do: a user <code>has_many</code> followed users and <code>has_many</code> followers.<span class="intersentencespace"></span> As we will see, there is a problem with this approach, and we’ll learn how to fix it using <code>has_many through</code>.<span class="intersentencespace"></span> It’s likely that many of the ideas in this section won’t seem obvious at first, and it may take a while for the rather complicated data model to sink in.<span class="intersentencespace"></span> If you find yourself getting confused, try pushing forward to the end; then, read the section a second time through to see if things are clearer.</p>
<div id="_sec-a_problem_with_the_data_model" data-tralics-id="uid871" class="subsection" data-number="11.1.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_problem_with_the_data_model" class="heading hyperref"><span class="number">11.1.1 </span>A problem with the data model (and a solution)</a></h3>
<p>As a first step toward constructing a data model for following users, let’s examine a typical case.<span class="intersentencespace"></span> For instance, consider a user who follows a second user: we could say that, e.g., Calvin is following Hobbes, and Hobbes is followed by Calvin, so that Calvin is the <em>follower</em> and Hobbes is <em>followed</em>.<span class="intersentencespace"></span> Using Rails’ default pluralization convention, the set of all users following a given user is that user’s <em>followers</em>, and <code>user.followers</code> is an array of those users.<span class="intersentencespace"></span> Unfortunately, the reverse doesn’t work: by default, the set of all followed users would be called the <em>followeds</em>, which is ungrammatical and clumsy.<span class="intersentencespace"></span> We could call them <em>following</em>, but that’s ambiguous: in normal English, a “following” is the set of people following <em>you</em>, i.e., your followers—exactly the opposite of the intended meaning.<span class="intersentencespace"></span> Although we will use “following” as a label, as in “50 following, 75 followers”, we’ll use “followed users” for the users themselves, with a corresponding <code>user.followed_users</code> array.<sup id="_cha-11_footnote-ref-2" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-2">2</a></sup></p>
<p>This discussion suggests modeling the followed users as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-naive_user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.6</span></a>, with a <code>followed_users</code> table and a <code>has_many</code> association.<span class="intersentencespace"></span> Since <code>user.followed_users</code> should be an array of users, each row of the <code>followed_users</code> table would need to be a user, as identified by the <code>followed_id</code>, together with the <code>follower_id</code> to establish the association.<sup id="_cha-11_footnote-ref-3" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-3">3</a></sup><span class="intersentencespace"></span> In addition, since each row is a user, we would need to include the user’s other attributes, including the name, password, etc.</p>
<div class="center figure" id="_fig-naive_user_has_many_following" data-tralics-id="uid874" data-number="11.6">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/naive_user_has_many_followed_users.png" alt="images/figures/naive_user_has_many_followed_users"></div><div class="caption"><span class="header">Figure 11.6: </span><span class="description">A naïve implementation of user following.
</span></div></div>
<p>The problem with the data model in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-naive_user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.6</span></a> is that it is terribly redundant: each row contains not only each followed user’s id, but all their other information as well—all of which are <em>already</em> in the <code>users</code> table.<span class="intersentencespace"></span> Even worse, to model user <em>followers</em> we would need a separate, similarly redundant <code>followers</code> table.<span class="intersentencespace"></span> Finally, this data model is a maintainability nightmare: each time a user changed (say) their name, we would need to update not just the user’s record in the <code>users</code> table but also <em>every row containing that user</em>
in both the <code>followed_users</code> and <code>followers</code> tables.</p>
<p>The problem here is that we are missing an underlying abstraction.<span class="intersentencespace"></span> One way to find the proper abstraction is to consider how we might implement the act of <em>following</em> in a web application.<span class="intersentencespace"></span> Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_users_resource" class="hyperref">Section&nbsp;<span class="ref">7.1.2</span></a> that the REST architecture involves <em>resources</em> that are created and destroyed.<span class="intersentencespace"></span> This leads us to ask two questions: When a user follows another user, what is being created?<span class="intersentencespace"></span> When a user <em>un</em>follows another user, what is being destroyed?</p>
<p>Upon reflection, we see that in these cases the application should either create or destroy a <em>relationship</em> between two users.<span class="intersentencespace"></span> A user then <code>has_many :relationships</code>, and has many <code>followed_users</code> (or <code>followers</code>) <em>through</em> these relationships.<span class="intersentencespace"></span> Indeed, <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-naive_user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.6</span></a> already contains most of the implementation: since each followed user is uniquely identified by <code>followed_id</code>, we could convert <code>followed_users</code> to a <code>relationships</code> table, omit the user details, and use <code>followed_id</code> to retrieve the followed user from the <code>users</code> table.<span class="intersentencespace"></span> Moreover, by considering <em>reverse</em> relationships, we could use the <code>follower_id</code> column to extract an array of user’s followers.</p>
<p>To make a <code>followed_users</code> array of users, it would be possible to pull out an array of <code>followed_id</code> attributes and then find the user for each one.<span class="intersentencespace"></span> As you might expect, though, Rails has a way to make this procedure more convenient, and the relevant technique is known as <code>has_many through</code>.<span class="intersentencespace"></span> As we will see in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following" class="hyperref">Section&nbsp;<span class="ref">11.1.4</span></a>, Rails allows us to say that a user is following many users <em>through</em> the relationships table, using the succinct code</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
</pre></div></div>
<p>This code automatically populates <code>user.followed_users</code> with an array of followed users.<span class="intersentencespace"></span> A diagram of the data model appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.7</span></a>.</p>
<div class="center figure" id="_fig-user_has_many_following" data-tralics-id="uid875" data-number="11.7">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_has_many_followed_users.png" alt="images/figures/user_has_many_followed_users"></div><div class="caption"><span class="header">Figure 11.7: </span><span class="description">A model of followed users through user relationships.
</span></div></div>
<p>To get started with the implementation, we first generate a Relationship model as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Relationship follower_id:integer followed_id:integer
</pre></div></div>
<p>It’s possible that this will generate a Relationship factory, which you should remove:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm -f spec/factories/relationship.rb
</pre></div></div>
<p>Since we will be finding relationships by <code>follower_id</code> and by <code>followed_id</code>, we should add an index on each column for efficiency, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_migration" class="hyperref">Listing&nbsp;<span class="ref">11.1</span></a>.</p>
<div class="codelisting" id="_code-relationships_migration" data-tralics-id="uid876" data-number="11.1"><div class="heading"><span class="number">Listing 11.1:</span> 

<span class="description">Adding indices for the <code>relationships</code> table.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_relationships.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_migration" class="hyperref">Listing&nbsp;<span class="ref">11.1</span></a> also includes a <em>composite</em> index that enforces uniqueness of pairs of (<code>follower_id</code>, <code>followed_id</code>), so that a user can’t follow another user more than once:</p>
<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p>(Compare to the email uniqueness index from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-email_uniqueness_index" class="hyperref">Listing&nbsp;<span class="ref">6.19</span></a>.)<span class="intersentencespace"></span> As we’ll see starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following" class="hyperref">Section&nbsp;<span class="ref">11.1.4</span></a>, our user interface won’t allow this to happen, but adding a unique index arranges to raise an error if a user tries to create duplicate relationships anyway (using, e.g., a command-line tool such as <span class="tt">curl</span>).<span class="intersentencespace"></span> We will add a uniqueness validation to the Relationship model, but because it is <em>always</em> an error to create duplicate relationships, the unique index is sufficient for now.</p>
<p>To create the <code>relationships</code> table, we migrate the database and prepare the test database as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
<p>The result is the Relationship data model shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-relationship_model" class="hyperref">Figure&nbsp;<span class="ref">11.8</span></a>.</p>
<div class="center figure" id="_fig-relationship_model" data-tralics-id="uid877" data-number="11.8">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/relationship_model.png" alt="images/figures/relationship_model"></div><div class="caption"><span class="header">Figure 11.8: </span><span class="description">The Relationship data model.
</span></div></div>
</div>
<div id="_sec-relationship_user_associations" data-tralics-id="uid878" class="subsection" data-number="11.1.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-relationship_user_associations" class="heading hyperref"><span class="number">11.1.2 </span>User/relationship associations</a></h3>
<p>Before implementing followed users and followers, we first need to establish the association between users and relationships.<span class="intersentencespace"></span> A user <code>has_many</code> relationships, and—since relationships involve <em>two</em> users—a relationship <code>belongs_to</code> both a follower and a followed user.</p>
<p>As with microposts in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_micropost_associations" class="hyperref">Section&nbsp;<span class="ref">10.1.3</span></a>, we will create new relationships using the user association, with code such as</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>We start with a basic validity test, shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationship_create_test" class="hyperref">Listing&nbsp;<span class="ref">11.2</span></a>.</p>
<div class="codelisting" id="_code-relationship_create_test" data-tralics-id="uid879" data-number="11.2"><div class="heading"><span class="number">Listing 11.2:</span> 

<span class="description">Testing Relationship creation and attributes.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/relationship_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="p">{</span> <span class="n">follower</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">followed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">relationship</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, unlike the tests for the User and Micropost models, which use <code>@user</code> and <code>@micropost</code>, respectively, <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationship_create_test" class="hyperref">Listing&nbsp;<span class="ref">11.2</span></a> uses <code>let</code> in preference to an instance variable.<span class="intersentencespace"></span> The differences rarely matter,<sup id="_cha-11_footnote-ref-4" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-4">4</a></sup> but I consider <code>let</code> to be cleaner than using an instance variable.<span class="intersentencespace"></span> We originally used instance variables both because instance variables are important to introduce early and because <code>let</code> is a little more advanced.</p>
<p>We should also test the User model for a <code>relationships</code> attribute, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_relationships_method_test" class="hyperref">Listing&nbsp;<span class="ref">11.3</span></a>.</p>
<div class="codelisting" id="_code-user_relationships_method_test" data-tralics-id="uid881" data-number="11.3"><div class="heading"><span class="number">Listing 11.3:</span> 

<span class="description">Testing for the <code>user.relationships</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, you might expect application code as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_micropost_associations" class="hyperref">Section&nbsp;<span class="ref">10.1.3</span></a>, and it’s similar, but there is one critical difference: in the case of the Micropost model, we could say</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>because the <code>microposts</code> table has a <code>user_id</code> attribute to identify the user (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_basic_model" class="hyperref">Section&nbsp;<span class="ref">10.1.1</span></a>).<span class="intersentencespace"></span> An id used in this manner to connect two database tables is known as a <em>foreign key</em>, and when the foreign key for a User model object is <code>user_id</code>, Rails infers the association automatically: by default, Rails expects a foreign key of the form <code>&lt;class&gt;_id</code>, where <code>&lt;class&gt;</code> is the lower-case version of the class name.<sup id="_cha-11_footnote-ref-5" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-5">5</a></sup><span class="intersentencespace"></span> In the present case, although we are still dealing with users, they are now identified with the foreign key <code>follower_id</code>, so we have to tell that to Rails, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_relationships_association" class="hyperref">Listing&nbsp;<span class="ref">11.4</span></a>.<sup id="_cha-11_footnote-ref-6" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-6">6</a></sup></p>
<div class="codelisting" id="_code-user_relationships_association" data-tralics-id="uid884" data-number="11.4"><div class="heading"><span class="number">Listing 11.4:</span> 

<span class="description">Implementing the user/relationships <code>has_many</code> association.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>(Since destroying a user should also destroy that user’s relationships, we’ve gone ahead and added <code>dependent: :destroy</code> to the association; writing a test for this is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_exercises" class="hyperref">Section&nbsp;<span class="ref">11.5</span></a>).)</p>
<p>As with the Micropost model, the Relationship model has a <code>belongs_to</code> relationship with users; in this case, a relationship object belongs to both a <code>follower</code> and a <code>followed</code> user, which we test for in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_belongs_to_test" class="hyperref">Listing&nbsp;<span class="ref">11.5</span></a>.</p>
<div class="codelisting" id="_code-relationships_belongs_to_test" data-tralics-id="uid885" data-number="11.5"><div class="heading"><span class="number">Listing 11.5:</span> 

<span class="description">Testing the user/relationships <code>belongs_to</code> association.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/relationship_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"follower methods"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">follower</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="n">eq</span> <span class="n">followed</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To write the application code, we define the <code>belongs_to</code> relationship as usual.<span class="intersentencespace"></span> Rails infers the names of the foreign keys from the corresponding symbols (i.e., <code>follower_id</code> from <code>:follower</code>, and <code>followed_id</code> from <code>:followed</code>), but since there is neither a Followed nor a Follower model we need to supply the class name <code>User</code>.<span class="intersentencespace"></span> The result is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationship_belongs_to" class="hyperref">Listing&nbsp;<span class="ref">11.6</span></a>.</p>
<div class="codelisting" id="_code-relationship_belongs_to" data-tralics-id="uid886" data-number="11.6"><div class="heading"><span class="number">Listing 11.6:</span> 

<span class="description">Adding the <code>belongs_to</code> associations to the Relationship model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/relationship.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
<span class="k">end</span>
</pre></div></div></div><p>The <code>followed</code> association isn’t actually needed until <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-followers" class="hyperref">Section&nbsp;<span class="ref">11.1.5</span></a>, but the parallel follower/followed structure is clearer if we implement them both at the same time.</p>
<p>At this point, the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationship_create_test" class="hyperref">Listing&nbsp;<span class="ref">11.2</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_relationships_method_test" class="hyperref">Listing&nbsp;<span class="ref">11.3</span></a> should pass.</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-relationship_validations" data-tralics-id="uid887" class="subsection" data-number="11.1.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-relationship_validations" class="heading hyperref"><span class="number">11.1.3 </span>Validations</a></h3>
<p>Before moving on, we’ll add a couple of Relationship model validations for completeness.<span class="intersentencespace"></span> The tests (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationship_validation_tests" class="hyperref">Listing&nbsp;<span class="ref">11.7</span></a>) and application code (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationship_validations" class="hyperref">Listing&nbsp;<span class="ref">11.8</span></a>) are straightforward.</p>
<div class="codelisting" id="_code-relationship_validation_tests" data-tralics-id="uid888" data-number="11.7"><div class="heading"><span class="number">Listing 11.7:</span> 

<span class="description">Testing the Relationship model validations.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/relationship_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"when followed id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">followed_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"when follower id is not present"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">follower_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-relationship_validations" data-tralics-id="uid889" data-number="11.8"><div class="heading"><span class="number">Listing 11.8:</span> 

<span class="description">Adding the Relationship model validations.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/relationship.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-following" data-tralics-id="uid890" class="subsection" data-number="11.1.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following" class="heading hyperref"><span class="number">11.1.4 </span>Followed users</a></h3>
<p>We come now to the heart of the Relationship associations: <code>followed_users</code> and <code>followers</code>.<span class="intersentencespace"></span> We start with <code>followed_users</code>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_following_test" class="hyperref">Listing&nbsp;<span class="ref">11.9</span></a>.</p>
<div class="codelisting" id="_code-user_following_test" data-tralics-id="uid891" data-number="11.9"><div class="heading"><span class="number">Listing 11.9:</span> 

<span class="description">A test for the <code>user.followed_users</code> attribute.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The implementation uses <code>has_many through</code> for the first time: a user has many following <em>through</em> relationships, as illustrated in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.7</span></a>.<span class="intersentencespace"></span> By default, in a <code>has_many through</code> association Rails looks for a foreign key corresponding to the singular version of the association; in other words, code like</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:relationships</span>
</pre></div></div>
<p>would assemble an array using the <code>followed_id</code> in the <code>relationships</code> table.<span class="intersentencespace"></span> But, as noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_problem_with_the_data_model" class="hyperref">Section&nbsp;<span class="ref">11.1.1</span></a>, <code>user.followeds</code> is rather awkward; far more natural is to use “followed users” as a plural of “followed”, and write instead <code>user.followed_users</code> for the array of followed users.<span class="intersentencespace"></span> Naturally, Rails allows us to override the default, in this case using the <code>:source</code> parameter (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-has_many_following_through_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.10</span></a>), which explicitly tells Rails that the source of the <code>followed_users</code> array is the set of <code>followed</code>&nbsp;ids.</p>
<div class="codelisting" id="_code-has_many_following_through_relationships" data-tralics-id="uid892" data-number="11.10"><div class="heading"><span class="number">Listing 11.10:</span> 

<span class="description">Adding the User model <code>followed_users</code> association.<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To create a following relationship, we’ll introduce a <code>follow!</code> utility method so that we can write <code>user.follow!(other_user)</code>.<span class="intersentencespace"></span> (This <code>follow!</code> method should always work, so, as with <code>create!</code> and <code>save!</code>, we indicate with an exclamation point that an exception will be raised on failure.)<span class="intersentencespace"></span> We’ll also add an associated <code>following?</code> boolean method to test if one user is following another.<sup id="_cha-11_footnote-ref-7" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-7">7</a></sup><span class="intersentencespace"></span> The tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-utility_method_tests" class="hyperref">Listing&nbsp;<span class="ref">11.11</span></a> show how we expect these methods to be used in practice.</p>
<div class="codelisting" id="_code-utility_method_tests" data-tralics-id="uid894" data-number="11.11"><div class="heading"><span class="number">Listing 11.11:</span> 

<span class="description">Tests for some “following” utility methods.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:following?</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"following"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>In the application code, the <code>following?</code> method takes in a user, called <code>other_user</code>, and checks to see if a followed user with that id exists in the database; the <code>follow!</code> method calls <code>create!</code> through the <code>relationships</code> association to create the following relationship.<span class="intersentencespace"></span> The results appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_p_follow_bang" class="hyperref">Listing&nbsp;<span class="ref">11.12</span></a>.</p>
<div class="codelisting" id="_code-following_p_follow_bang" data-tralics-id="uid895" data-number="11.12"><div class="heading"><span class="number">Listing 11.12:</span> 

<span class="description">The <code>following?</code> and <code>follow!</code> utility methods.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_p_follow_bang" class="hyperref">Listing&nbsp;<span class="ref">11.12</span></a> we have omitted the user itself, writing just</p>
<div class="code"><div class="highlight"><pre><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>instead of the equivalent code</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>Whether to include the explicit <code>self</code> is largely a matter of taste.</p>
<p>Of course, users should be able to unfollow other users as well as follow them, which leads to the somewhat predictable <code>unfollow!</code> method, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_unfollow_test" class="hyperref">Listing&nbsp;<span class="ref">11.13</span></a>.</p>
<div class="codelisting" id="_code-user_unfollow_test" data-tralics-id="uid896" data-number="11.13"><div class="heading"><span class="number">Listing 11.13:</span> 

<span class="description">A test for unfollowing a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:unfollow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"following"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"and unfollowing"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The code for <code>unfollow!</code> is straightforward: just find the relationship by followed&nbsp;id and destroy it (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_unfollow" class="hyperref">Listing&nbsp;<span class="ref">11.14</span></a>).</p>
<div class="codelisting" id="_code-user_unfollow" data-tralics-id="uid897" data-number="11.14"><div class="heading"><span class="number">Listing 11.14:</span> 

<span class="description">Unfollowing a user by destroying a user relationship.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-followers" data-tralics-id="uid898" class="subsection" data-number="11.1.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-followers" class="heading hyperref"><span class="number">11.1.5 </span>Followers</a></h3>
<p>The final piece of the relationships puzzle is to add a <code>user.followers</code> method to go with <code>user.followed_users</code>.<span class="intersentencespace"></span> You may have noticed from <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.7</span></a> that all the information needed to extract an array of followers is already present in the <code>relationships</code> table.<span class="intersentencespace"></span> Indeed, the technique is exactly the same as for user following, with the roles of <code>follower_id</code> and <code>followed_id</code> reversed.<span class="intersentencespace"></span> This suggests that, if we could somehow arrange for a <code>reverse_relationships</code> table with those two columns reversed (<a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_has_many_followers" class="hyperref">Figure&nbsp;<span class="ref">11.9</span></a>), we could implement <code>user.followers</code> with little effort.</p>
<div class="center figure" id="_fig-user_has_many_followers" data-tralics-id="uid899" data-number="11.9">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_has_many_followers_2nd_ed.png" alt="images/figures/user_has_many_followers_2nd_ed"></div><div class="caption"><span class="header">Figure 11.9: </span><span class="description">A model for user followers using a reverse Relationship model.
</span></div></div>
<p>We begin with the tests, having faith that the magic of Rails will come to the rescue (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-reverse_relationships_test" class="hyperref">Listing&nbsp;<span class="ref">11.15</span></a>).</p>
<div class="codelisting" id="_code-reverse_relationships_test" data-tralics-id="uid900" data-number="11.15"><div class="heading"><span class="number">Listing 11.15:</span> 

<span class="description">Testing for reverse relationships.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:reverse_relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>

  <span class="n">describe</span> <span class="s2">"following"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"followed user"</span> <span class="k">do</span>
      <span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Notice how we switch subjects using the <code>subject</code> method, replacing <code>@user</code> with <code>other_user</code>, allowing us to test the follower relationship in a natural way:</p>
<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>As you probably suspect, we will not be making a whole database table just to hold reverse relationships.<span class="intersentencespace"></span> Instead, we will exploit the underlying symmetry between followers and followed users to simulate a <code>reverse_relationships</code> table by passing <code>followed_id</code> as the primary key.<span class="intersentencespace"></span> In other words, where the <code>relationships</code> association uses the <code>follower_id</code> foreign key,</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span>
</pre></div></div>
<p>the <code>reverse_relationships</code> association uses <code>followed_id</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"followed_id"</span>
</pre></div></div>
<p>The <code>followers</code> association then gets built through the reverse relationships, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_reverse_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.16</span></a>.</p>
<div class="codelisting" id="_code-user_reverse_relationships" data-tralics-id="uid901" data-number="11.16"><div class="heading"><span class="number">Listing 11.16:</span> 

<span class="description">Implementing <code>user.followers</code> using reverse relationships.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"followed_id"</span><span class="p">,</span>
                                   <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
                                   <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:follower</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>(As with <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_relationships_association" class="hyperref">Listing&nbsp;<span class="ref">11.4</span></a>, the test for <code>dependent :destroy</code> is left as an exercise (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_exercises" class="hyperref">Section&nbsp;<span class="ref">11.5</span></a>).)<span class="intersentencespace"></span> Note that we actually have to include the <em>class</em> name for this association, i.e.,</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"followed_id"</span><span class="p">,</span>
                                 <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"Relationship"</span>
</pre></div></div>
<p>because otherwise Rails would look for a <code>ReverseRelationship</code> class, which doesn’t exist.</p>
<p>It’s also worth noting that we could actually omit the <code>:source</code> key in this case, using simply</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:reverse_relationships</span>
</pre></div></div>
<p>since, in the case of a <code>:followers</code> attribute, Rails will singularize “followers” and automatically look for the foreign key <code>follower_id</code> in this case.<span class="intersentencespace"></span> I’ve kept the <code>:source</code> key to emphasize the parallel structure with the <code>has_many :followed_users</code> association, but you are free to leave it off.</p>
<p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_reverse_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.16</span></a>, the following/follower associations are complete, and all the tests should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>This section has placed rather heavy demands on your data modeling skills, and it’s fine if it takes a while to soak in.<span class="intersentencespace"></span> In fact, one of the best ways to understand the associations is to use them in the web interface, as seen in the next section.</p>
</div></div>
<div id="_sec-a_web_interface_for_following_and_followers" data-tralics-id="cid67" class="section" data-number="11.2"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_web_interface_for_following_and_followers" class="heading hyperref"><span class="number">11.2 </span>A web interface for following users</a></h2>
<p>In the introduction to this chapter, we saw a preview of the page flow for user following.<span class="intersentencespace"></span> In this section, we will implement the basic interface and following/unfollowing functionality shown in those mockups.<span class="intersentencespace"></span> We will also make separate pages to show the user following and followers arrays.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_status_feed" class="hyperref">Section&nbsp;<span class="ref">11.3</span></a>, we’ll complete our sample application by adding the user’s status feed.</p>
<div id="_sec-sample_following_data" data-tralics-id="uid902" class="subsection" data-number="11.2.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-sample_following_data" class="heading hyperref"><span class="number">11.2.1 </span>Sample following data</a></h3>
<p>As in previous chapters, we will find it convenient to use the sample data Rake task to fill the database with sample relationships.<span class="intersentencespace"></span> This will allow us to design the look and feel of the web pages first, deferring the back-end functionality until later in this section.</p>
<p>When we last left the sample data populator in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sample_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.20</span></a>, it was getting rather cluttered, so we begin by defining separate methods to make users and microposts, and then add sample relationship data using a new <code>make_relationships</code> method.<span class="intersentencespace"></span> The results are shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sample_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.17</span></a>.</p>
<div class="codelisting" id="_code-sample_relationships" data-tralics-id="uid903" data-number="11.17"><div class="heading"><span class="number">Listing 11.17:</span> 

<span class="description">Adding following/follower relationships to the sample data.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">lib/tasks/sample_data.rake</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Fill database with sample data"</span>
  <span class="n">task</span> <span class="ss">populate</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">make_users</span>
    <span class="n">make_microposts</span>
    <span class="n">make_relationships</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_users</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="s2">"Example User"</span><span class="p">,</span>
                       <span class="ss">email</span><span class="p">:</span>    <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
                       <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                       <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
                       <span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
    <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
    <span class="n">password</span>  <span class="o">=</span> <span class="s2">"password"</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="nb">name</span><span class="p">,</span>
                 <span class="ss">email</span><span class="p">:</span>    <span class="n">email</span><span class="p">,</span>
                 <span class="ss">password</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                 <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_microposts</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit</span><span class="p">:</span> <span class="mi">6</span><span class="p">)</span>
  <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
    <span class="n">content</span> <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>Here the sample relationships are created using the code</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>We somewhat arbitrarily arrange for the first user to follow users&nbsp;3 through 51, and then have users 4 through 41 follow that user back.<span class="intersentencespace"></span> The resulting relationships will be sufficient for developing the application interface.</p>
<p>To execute the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-sample_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.17</span></a>, populate the database as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div></div>
</div>
<div id="_sec-stats_and_a_follow_form" data-tralics-id="uid904" class="subsection" data-number="11.2.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-stats_and_a_follow_form" class="heading hyperref"><span class="number">11.2.2 </span>Stats and a follow form</a></h3>
<p>Now that our sample users have both followed user and followers arrays, we need to update the profile page and Home page to reflect this.<span class="intersentencespace"></span> We’ll start by making a partial to display the following and follower statistics on the profile and home pages.<span class="intersentencespace"></span> We’ll next add a follow/unfollow form, and then make dedicated pages for showing user followed users and followers.</p>
<p>As noted in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_problem_with_the_data_model" class="hyperref">Section&nbsp;<span class="ref">11.1.1</span></a>, while the word “following” is ambiguous as an attribute (where <code>user.following</code> could reasonably mean either the followed users or the user’s followers), it makes sense as a label, as in “50 following”.<span class="intersentencespace"></span> Indeed, this is the label used by Twitter itself, a usage adopted in the mockups starting in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-page_flow_profile_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.1</span></a> and shown in close-up in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-stats_partial_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.10</span></a>.</p>
<div class="center figure" id="_fig-stats_partial_mockup" data-tralics-id="uid905" data-number="11.10"><span class="graphics"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/stats_partial_mockup.png" alt="stats_partial_mockup"></span>
<div class="caption"><span class="header">Figure 11.10: </span><span class="description">A mockup of the stats partial.
</span></div></div>
<p>The stats in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-stats_partial_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.10</span></a> consist of the number of users the current user is following and the number of followers, each of which should be a link to its respective dedicated display page.<span class="intersentencespace"></span> In <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-filling_in_the_layout" class="hyperref">Chapter&nbsp;<span class="ref">5</span></a>, we stubbed out such links with the dummy text&nbsp;<code>’#’</code>, but that was before we had much experience with routes.<span class="intersentencespace"></span> This time, although we’ll defer the actual pages to <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_and_followers_pages" class="hyperref">Section&nbsp;<span class="ref">11.2.3</span></a>, we’ll make the routes now, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a>.<span class="intersentencespace"></span> This code uses the <code>:member</code> method inside a <code>resources</code> <em>block</em>, which we haven’t seen before, but see if you can guess what it does.<span class="intersentencespace"></span> (<em>Note</em>: The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a> should <em>replace</em> the <code>resources :users</code>.)</p>
<div class="codelisting" id="_code-following_followers_actions_routes" data-tralics-id="uid906" data-number="11.18"><div class="heading"><span class="number">Listing 11.18:</span> 

<span class="description">Adding <code>following</code> and <code>followers</code> actions to the Users controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>You might suspect that the URLs will look like /users/1/following and /users/1/followers, and that is exactly what the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a> does.<span class="intersentencespace"></span> Since both pages will be showing data, we use <code>get</code> to arrange for the URLs to respond to <span class="tt">GET</span> requests (as required by the REST convention for such pages), and the <code>member</code> method means that the routes respond to URLs containing the user id.<span class="intersentencespace"></span> The other possibility, <code>collection</code>, works without the id, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>would respond to the URL /users/tigers (presumably to display all the tigers in our application).<span class="intersentencespace"></span> For more details on such routing options, see the <a href="http://guides.rubyonrails.org/routing.html" target="_blank">Rails Guides article on “Rails Routing from the Outside In”</a>.<span class="intersentencespace"></span> A table of the routes generated by <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a> appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-following_routes" class="hyperref">Table&nbsp;<span class="ref">11.1</span></a>; note the named routes for the followed user and followers pages, which we’ll put to use shortly.<span class="intersentencespace"></span> The unfortunate hybrid usage in the “following” route is forced by our choice to use the unambiguous “followed users” terminology along with the “following” usage from Twitter.<span class="intersentencespace"></span> Since the former would lead to routes of the form <code>followed_users_user_path</code>, which sounds strange, we’ve opted for the latter in the context of <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-following_routes" class="hyperref">Table&nbsp;<span class="ref">11.1</span></a>, yielding <code>following_user_path</code>.</p>
<div class="table" id="_table-following_routes" data-tralics-id="uid907" data-number="11.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Named route</strong></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/following</td>
<td class="align_left"><code>following</code></td>
<td class="align_left"><code>following_user_path(1)</code></td>
</tr><tr><td class="align_left"><span class="tt">GET</span></td>
<td class="align_left">/users/1/followers</td>
<td class="align_left"><code>followers</code></td>
<td class="align_left"><code>followers_user_path(1)</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 11.1: </span><span class="description">RESTful routes provided by the custom rules in resource in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a>.
</span></div></div>
<p>With the routes defined, we are now in a position to make tests for the stats partial.<span class="intersentencespace"></span> (We could have written the tests first, but the named routes would have been hard to motivate without the updated routes file.)<span class="intersentencespace"></span> The stats partial will appear on both the profile page and the Home page; <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-stats_view_test" class="hyperref">Listing&nbsp;<span class="ref">11.19</span></a> opts to test it on the latter.</p>
<div class="codelisting" id="_code-stats_view_test" data-tralics-id="uid908" data-number="11.19"><div class="heading"><span class="number">Listing 11.19:</span> 

<span class="description">Testing the following/follower statistics on the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/static_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Static pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"Home page"</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"for signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem"</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s2">"Ipsum"</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"should render the user's feed"</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"follower/following counts"</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">other_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">root_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">"0 following"</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">"1 followers"</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The core of this test is the expectation that the following and follower counts appear on the page, together with the right URLs:</p>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">"0 following"</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">"1 followers"</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div></div>
<p>Here we have used the named routes shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#table-following_routes" class="hyperref">Table&nbsp;<span class="ref">11.1</span></a> to verify that the links have the right addresses.<span class="intersentencespace"></span> Also note that in this case the word “followers” is acting as a <em>label</em>, so we keep it plural even when there is only one follower.</p>
<p>The application code for the stats partial is just a couple of links inside a div, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-stats_partial" class="hyperref">Listing&nbsp;<span class="ref">11.20</span></a>.</p>
<div class="codelisting" id="_code-stats_partial" data-tralics-id="uid909" data-number="11.20"><div class="heading"><span class="number">Listing 11.20:</span> 

<span class="description">A partial for displaying follower stats.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_stats.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    following
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"followers"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    followers
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Since we will be including the stats on both the user show pages and the home page, the first line of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-stats_partial" class="hyperref">Listing&nbsp;<span class="ref">11.20</span></a> picks the right one using</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>As discussed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sidebar-or_equals" class="hyperref">Box&nbsp;<span class="ref">8.2</span></a>, this does nothing when <code>@user</code> is not <code>nil</code> (as on a profile page), but when it is (as on the Home page) it sets <code>@user</code> to the current user.</p>
<p>Note also that the following/follower counts are calculated through the associations using</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>Compare these to the microposts count from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_show_microposts" class="hyperref">Listing&nbsp;<span class="ref">10.17</span></a>, where we wrote</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>to count the microposts.</p>
<p>One final detail worth noting is the presence of CSS ids on some elements, as in</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/strong&gt;</span>
</pre></div></div>
<p>This is for the benefit of the Ajax implementation in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_with_ajax" class="hyperref">Section&nbsp;<span class="ref">11.2.5</span></a>, which accesses elements on the page using their unique ids.</p>
<p>With the partial in hand, including the stats on the Home page is easy, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-home_page_stats" class="hyperref">Listing&nbsp;<span class="ref">11.21</span></a>.<span class="intersentencespace"></span> (This also gets the test in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-stats_view_test" class="hyperref">Listing&nbsp;<span class="ref">11.19</span></a> to pass.)</p>
<div class="codelisting" id="_code-home_page_stats" data-tralics-id="uid910" data-number="11.21"><div class="heading"><span class="number">Listing 11.21:</span> 

<span class="description">Adding follower stats to the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      .
      .
      .
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>To style the stats, we’ll add some SCSS, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-stats_css" class="hyperref">Listing&nbsp;<span class="ref">11.22</span></a> (which contains all the stylesheet code needed in this chapter).<span class="intersentencespace"></span> The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_page_follow_stats" class="hyperref">Figure&nbsp;<span class="ref">11.11</span></a>.</p>
<div class="codelisting" id="_code-stats_css" data-tralics-id="uid911" data-number="11.22"><div class="heading"><span class="number">Listing 11.22:</span> 

<span class="description">SCSS for the Home page sidebar.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.css.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.stats</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">border-left</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">padding-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
      <span class="na">color</span><span class="o">:</span> <span class="nv">$blue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">strong</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.user_avatars</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
</pre></div></div></div><div class="center figure" id="_fig-home_page_follow_stats" data-tralics-id="uid912" data-number="11.11">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_page_follow_stats_bootstrap.png" alt="images/figures/home_page_follow_stats_bootstrap"></div><div class="caption"><span class="header">Figure 11.11: </span><span class="description">The Home page (<a href="http://localhost:3000/" target="_blank">/</a>) with follow stats.
</span></div></div>
<p>We’ll render the stats partial on the profile page in a moment, but first let’s make a partial for the follow/unfollow button, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_form_partial" class="hyperref">Listing&nbsp;<span class="ref">11.23</span></a>.</p>
<div class="codelisting" id="_code-follow_form_partial" data-tralics-id="uid913" data-number="11.23"><div class="heading"><span class="number">Listing 11.23:</span> 

<span class="description">A partial for a follow/unfollow form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"follow_form"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'unfollow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>This does nothing but defer the real work to <code>follow</code> and <code>unfollow</code> partials, which need a new routes file with rules for the Relationships resource, which follows the Microposts resource example (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-microposts_resource" class="hyperref">Listing&nbsp;<span class="ref">10.22</span></a>), as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_resource" class="hyperref">Listing&nbsp;<span class="ref">11.24</span></a>.</p>
<div class="codelisting" id="_code-relationships_resource" data-tralics-id="uid914" data-number="11.24"><div class="heading"><span class="number">Listing 11.24:</span> 

<span class="description">Adding the routes for user relationships.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>      <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>    <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The follow/unfollow partials themselves are shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_form" class="hyperref">Listing&nbsp;<span class="ref">11.25</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-unfollow_form" class="hyperref">Listing&nbsp;<span class="ref">11.26</span></a>.</p>
<div class="codelisting" id="_code-follow_form" data-tralics-id="uid915" data-number="11.25"><div class="heading"><span class="number">Listing 11.25:</span> 

<span class="description">A form for following a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-unfollow_form" data-tralics-id="uid916" data-number="11.26"><div class="heading"><span class="number">Listing 11.26:</span> 

<span class="description">A form for unfollowing a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_unfollow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>These two forms both use <code>form_for</code> to manipulate a Relationship model object; the main difference between the two is that <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_form" class="hyperref">Listing&nbsp;<span class="ref">11.25</span></a> builds a <em>new</em> relationship, whereas <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-unfollow_form" class="hyperref">Listing&nbsp;<span class="ref">11.26</span></a> finds the existing relationship.<span class="intersentencespace"></span> Naturally, the former sends a <span class="tt">POST</span> request to the Relationships controller to <code>create</code> a relationship, while the latter sends a <span class="tt">DELETE</span> request to <code>destroy</code> a relationship.<span class="intersentencespace"></span> (We’ll write these actions in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a>.)<span class="intersentencespace"></span> Finally, you’ll note that the follow form doesn’t have any content other than the button, but it still needs to send the <code>followed_id</code> to the controller.<span class="intersentencespace"></span> We accomplish this with the <code>hidden_field</code> method in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_form" class="hyperref">Listing&nbsp;<span class="ref">11.25</span></a>, which produces HTML of the form</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"relationship_followed_id"</span>
<span class="na">name=</span><span class="s">"relationship[followed_id]"</span>
<span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"3"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>The “hidden” <code>input</code> tag puts the relevant information on the page without displaying it in the browser.</p>
<p>We can now include the follow form and the following statistics on the user profile page simply by rendering the partials, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_follow_form_profile_stats" class="hyperref">Listing&nbsp;<span class="ref">11.27</span></a>.<span class="intersentencespace"></span> Profiles with follow and unfollow buttons, respectively, appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_follow_button" class="hyperref">Figure&nbsp;<span class="ref">11.12</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-profile_unfollow_button" class="hyperref">Figure&nbsp;<span class="ref">11.13</span></a>.</p>
<div class="codelisting" id="_code-user_follow_form_profile_stats" data-tralics-id="uid917" data-number="11.27"><div class="heading"><span class="number">Listing 11.27:</span> 

<span class="description">Adding the follow form and follower stats to the user profile page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"span4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow_form'</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><div class="center figure" id="_fig-profile_follow_button" data-tralics-id="uid918" data-number="11.12">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/profile_follow_button_bootstrap.png" alt="images/figures/profile_follow_button_bootstrap"></div><div class="caption"><span class="header">Figure 11.12: </span><span class="description">A user profile with a follow button (<a href="http://localhost:3000/users/2" target="_blank">/users/2</a>).
</span></div></div>
<div class="center figure" id="_fig-profile_unfollow_button" data-tralics-id="uid919" data-number="11.13">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/profile_unfollow_button_bootstrap.png" alt="images/figures/profile_unfollow_button_bootstrap"></div><div class="caption"><span class="header">Figure 11.13: </span><span class="description">A user profile with an unfollow button (<a href="http://localhost:3000/users/5" target="_blank">/users/5</a>).
</span></div></div>
<p>We’ll get these buttons working soon enough—in fact, we’ll do it two ways, the standard way (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a>) and using Ajax (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_with_ajax" class="hyperref">Section&nbsp;<span class="ref">11.2.5</span></a>)—but first we’ll finish the HTML interface by making the following and followers pages.</p>
</div>
<div id="_sec-following_and_followers_pages" data-tralics-id="uid920" class="subsection" data-number="11.2.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_and_followers_pages" class="heading hyperref"><span class="number">11.2.3 </span>Following and followers pages</a></h3>
<p>Pages to display followed users and followers will resemble a hybrid of the user profile page and the user index page (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-user_index" class="hyperref">Section&nbsp;<span class="ref">9.3.1</span></a>), with a sidebar of user information (including the following stats) and a list of users.<span class="intersentencespace"></span> In addition, we’ll include a raster of user profile image links in the sidebar.<span class="intersentencespace"></span> Mockups matching these requirements appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-following_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.14</span></a> (following) and <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-followers_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.15</span></a> (followers).</p>
<div class="center figure" id="_fig-following_mockup" data-tralics-id="uid921" data-number="11.14">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/following_mockup_bootstrap.png" alt="images/figures/following_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.14: </span><span class="description">A mockup of the user following page.
</span></div></div>
<div class="center figure" id="_fig-followers_mockup" data-tralics-id="uid922" data-number="11.15">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/followers_mockup_bootstrap.png" alt="images/figures/followers_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.15: </span><span class="description">A mockup of the user followers page.
</span></div></div>
<p>Our first step is to get the following and followers links to work.<span class="intersentencespace"></span> We’ll follow Twitter’s lead and have both pages require user signin, as tested in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_authorization_test" class="hyperref">Listing&nbsp;<span class="ref">11.28</span></a>.<span class="intersentencespace"></span> For signed-in users, the pages should have links for following and followers, respectively, as tested in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_tests" class="hyperref">Listing&nbsp;<span class="ref">11.29</span></a>.</p>
<div class="codelisting" id="_code-following_followers_authorization_test" data-tralics-id="uid923" data-number="11.28"><div class="heading"><span class="number">Listing 11.28:</span> 

<span class="description">Tests for the authorization of the following and followers pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"in the Users controller"</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">"visiting the following page"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"visiting the followers page"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">'Sign in'</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="_code-following_followers_tests" data-tralics-id="uid924" data-number="11.29"><div class="heading"><span class="number">Listing 11.29:</span> 

<span class="description">Test for the <code>followed_users</code> and <code>followers</code> pages.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"following/followers"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"followed users"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Following'</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h3'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Following'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"followers"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">other_user</span>
        <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">'Followers'</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">'h3'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'Followers'</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href</span><span class="p">:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The only tricky part of the implementation is realizing that we need to add two new actions to the Users controller; based on the routes defined in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_actions_routes" class="hyperref">Listing&nbsp;<span class="ref">11.18</span></a>, we need to call them <code>following</code> and <code>followers</code>.<span class="intersentencespace"></span> Each action needs to set a title, find the user, retrieve either <code>@user.followed_users</code> or <code>@user.followers</code> (in paginated form), and then render the page.<span class="intersentencespace"></span> The result appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-following_followers_actions" class="hyperref">Listing&nbsp;<span class="ref">11.30</span></a>.</p>
<div class="codelisting" id="_code-following_followers_actions" data-tralics-id="uid925" data-number="11.30"><div class="heading"><span class="number">Listing 11.30:</span> 

<span class="description">The <code>following</code> and <code>followers</code> actions.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span><span class="p">,</span>
                <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Following"</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Followers"</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note here that both actions make an <em>explicit</em> call to <code>render</code>, in this case rendering a view called <code>show_follow</code>, which we must create.<span class="intersentencespace"></span> The reason for the common view is that the ERb is nearly identical for the two cases, and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-show_follow_view" class="hyperref">Listing&nbsp;<span class="ref">11.31</span></a> covers them both.</p>
<div class="codelisting" id="_code-show_follow_view" data-tralics-id="uid926" data-number="11.31"><div class="heading"><span class="number">Listing 11.31:</span> 

<span class="description">The <code>show_follow</code> view used to render following and followers.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@title</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"span4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span&gt;&lt;b&gt;</span>Microposts:<span class="nt">&lt;/b&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"user_avatars"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"span8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h3&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>With that, the tests should now be passing, and the pages should render as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_following" class="hyperref">Figure&nbsp;<span class="ref">11.16</span></a> (following) and <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_followers" class="hyperref">Figure&nbsp;<span class="ref">11.17</span></a> (followers).</p>
<div class="center figure" id="_fig-user_following" data-tralics-id="uid927" data-number="11.16">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_following_bootstrap.png" alt="images/figures/user_following_bootstrap"></div><div class="caption"><span class="header">Figure 11.16: </span><span class="description">Showing the users being followed by the current user.
</span></div></div>
<div class="center figure" id="_fig-user_followers" data-tralics-id="uid928" data-number="11.17">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_followers_bootstrap.png" alt="images/figures/user_followers_bootstrap"></div><div class="caption"><span class="header">Figure 11.17: </span><span class="description">Showing the current user’s followers.
</span></div></div>
</div>
<div id="_sec-a_working_follow_button_the_standard_way" data-tralics-id="uid929" class="subsection" data-number="11.2.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_the_standard_way" class="heading hyperref"><span class="number">11.2.4 </span>A working follow button the standard way</a></h3>
<p>Now that our views are in order, it’s time to get the follow/unfollow buttons working.<span class="intersentencespace"></span> The tests for these buttons combine many of the testing techniques covered throughout this tutorial and make for a good exercise in reading code.<span class="intersentencespace"></span> Study <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_unfollow_button_tests" class="hyperref">Listing&nbsp;<span class="ref">11.32</span></a> until you are convinced that you understand what it’s testing and why.<span class="intersentencespace"></span> (There’s one minor security omission in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_unfollow_button_tests" class="hyperref">Listing&nbsp;<span class="ref">11.32</span></a>; see if you can spot it.<span class="intersentencespace"></span> We’ll cover it momentarily.)<span class="intersentencespace"></span> Note in particular the use of the <code>have_xpath</code> method, which is an advanced and powerful technique that uses <a href="http://en.wikipedia.org/wiki/XPath" target="_blank">XPath</a> to navigate XML documents (including HTML5).<span class="intersentencespace"></span> You can read more about XPath by doing a web search for <a href="http://www.w3schools.com/xpath/xpath_syntax.asp" target="_blank">XPath syntax</a>.</p>
<div class="codelisting" id="_code-follow_unfollow_button_tests" data-tralics-id="uid930" data-number="11.32"><div class="heading"><span class="number">Listing 11.32:</span> 

<span class="description">Tests for the Follow/Unfollow button.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/user_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"User pages"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"profile page"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"follow/unfollow buttons"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">"following a user"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="s2">"should increment the followed user count"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">"Follow"</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">"should increment the other user's followers count"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">"Follow"</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"toggling the button"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Follow"</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_xpath</span><span class="p">(</span><span class="s2">"//input[@value='Unfollow']"</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">"unfollowing a user"</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">"should decrement the followed user count"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">"Unfollow"</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">"should decrement the other user's followers count"</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">"Unfollow"</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"toggling the button"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">"Unfollow"</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_xpath</span><span class="p">(</span><span class="s2">"//input[@value='Follow']"</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_unfollow_button_tests" class="hyperref">Listing&nbsp;<span class="ref">11.32</span></a> tests the following buttons by clicking on them and specifying the proper behavior.<span class="intersentencespace"></span> Writing the implementation involves digging a little deeper: following and unfollowing involve <em>creating</em> and <em>destroying</em> relationships, which means defining <code>create</code> and <code>destroy</code> actions in a Relationships controller (which we must create).<span class="intersentencespace"></span> Although the following buttons only appear for signed-in users, giving us a superficial layer of security, the tests in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_unfollow_button_tests" class="hyperref">Listing&nbsp;<span class="ref">11.32</span></a> miss a lower-level issue, namely, the <code>create</code> and <code>destroy</code> actions themselves should only be accessible to signed-in users.<span class="intersentencespace"></span> (This is the security hole alluded to above.)<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_controller_authorization_test" class="hyperref">Listing&nbsp;<span class="ref">11.33</span></a> expresses this requirement using the <code>post</code> and <code>delete</code> methods to hit those actions directly.</p>
<div class="codelisting" id="_code-relationships_controller_authorization_test" data-tralics-id="uid931" data-number="11.33"><div class="heading"><span class="number">Listing 11.33:</span> 

<span class="description">Tests for the Relationships controller authorization.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/requests/authentication_pages_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Authentication"</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"authorization"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"for non-signed-in users"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">"in the Relationships controller"</span> <span class="k">do</span>
        <span class="n">describe</span> <span class="s2">"submitting to the create action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">relationships_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">"submitting to the destroy action"</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, in order to avoid the overhead of creating a virtually useless Relationship object, the <code>delete</code> test hard-codes the id&nbsp;<code>1</code> in the named route:</p>
<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
</pre></div></div>
<p>This works because the user should be redirected before the application ever tries to retrieve the relationship with this&nbsp;id.</p>
<p>The controller code needed to get these tests to pass is remarkably concise: we just retrieve the user followed or to be followed, and then follow or unfollow the user using the relevant utility method.<span class="intersentencespace"></span> The full implementation appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_controller" class="hyperref">Listing&nbsp;<span class="ref">11.34</span></a>.</p>
<div class="codelisting" id="_code-relationships_controller" data-tralics-id="uid932" data-number="11.34"><div class="heading"><span class="number">Listing 11.34:</span> 

<span class="description">The Relationships controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can see from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_controller" class="hyperref">Listing&nbsp;<span class="ref">11.34</span></a> why the security issue mentioned above is minor: if an unsigned-in user were to hit either action directly (e.g., using a command-line tool like <span class="tt">curl</span>), <code>current_user</code> would be <code>nil</code>, and in both cases the action’s second line would raise an exception, resulting in an error but no harm to the application or its data.<span class="intersentencespace"></span> It’s best not to rely on that, though, so we’ve taken the extra step and added an extra layer of security.</p>
<p>With that, the core follow/unfollow functionality is complete, and any user can follow (or unfollow) any other user, which you should verify both by clicking around in the sample application and by running the test suite:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
</div>
<div id="_sec-a_working_follow_button_with_ajax" data-tralics-id="uid933" class="subsection" data-number="11.2.5"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_with_ajax" class="heading hyperref"><span class="number">11.2.5 </span>A working follow button with Ajax</a></h3>
<p>Although our user following implementation is complete as it stands, we have one bit of polish left to add before starting work on the status feed.<span class="intersentencespace"></span> You may have noticed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a> that both the <code>create</code> and <code>destroy</code> actions in the Relationships controller simply redirect <em>back</em> to the original profile.<span class="intersentencespace"></span> In other words, a user starts on a profile page, follows the user, and is immediately redirected back to the original page.<span class="intersentencespace"></span> It is reasonable to ask why the user needs to leave that page at all.</p>
<p>This is exactly the problem solved by <em>Ajax</em>, which allows web pages to send requests asynchronously to the server without leaving the page.<sup id="_cha-11_footnote-ref-8" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-8">8</a></sup><span class="intersentencespace"></span> Because the practice of adding Ajax to web forms is quite common, Rails makes Ajax easy to implement.<span class="intersentencespace"></span> Indeed, updating the follow/unfollow form partials is trivial: just change</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p>and Rails <a href="http://catb.org/jargon/html/A/automagically.html" target="_blank">automagically</a> uses Ajax.<sup id="_cha-11_footnote-ref-9" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-9">9</a></sup><span class="intersentencespace"></span> The updated partials appear in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_form_ajax" class="hyperref">Listing <span class="ref">11.35</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-unfollow_form_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.36</span></a>.</p>
<div class="codelisting" id="_code-follow_form_ajax" data-tralics-id="uid936" data-number="11.35"><div class="heading"><span class="number">Listing 11.35:</span> 

<span class="description">A form for following a user using Ajax.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="_code-unfollow_form_ajax" data-tralics-id="uid937" data-number="11.36"><div class="heading"><span class="number">Listing 11.36:</span> 

<span class="description">A form for unfollowing a user using Ajax.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_unfollow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">},</span>
             <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-large"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>The actual HTML generated by this ERb isn’t particularly relevant, but you might be curious, so here’s a peek:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/relationships/117"</span> <span class="na">class=</span><span class="s">"edit_relationship"</span> <span class="na">data-remote=</span><span class="s">"true"</span>
      <span class="na">id=</span><span class="s">"edit_relationship_117"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div></div>
<p>This sets the variable <code>data-remote="true"</code> inside the form tag, which tells Rails to allow the form to be handled by JavaScript.<span class="intersentencespace"></span> By using a simple HTML property instead of inserting the full JavaScript code (as in previous versions of Rails), Rails follows the philosophy of <a href="http://railscasts.com/episodes/205-unobtrusive-javascript" target="_blank"><em>unobtrusive JavaScript</em></a>.</p>
<p>Having updated the form, we now need to arrange for the Relationships controller to respond to Ajax requests.<span class="intersentencespace"></span> Testing Ajax is quite tricky, and doing it thoroughly is a large subject in its own right, but we can get started with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_controller_spec_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.37</span></a>.<span class="intersentencespace"></span> This uses the <code>xhr</code> method (for “XmlHttpRequest”) to issue an Ajax request; compare to the <code>get</code>, <code>post</code>, <code>patch</code>, and <code>delete</code> methods used in previous tests.<span class="intersentencespace"></span> We then verify that the <code>create</code> and <code>destroy</code> actions do the correct things when hit with an Ajax request.<span class="intersentencespace"></span> (To write more thorough test suites for Ajax-heavy applications, take a look at <a href="http://seleniumhq.org/" target="_blank">Selenium</a> and <a href="http://watir.com/" target="_blank">Watir</a>.)</p>
<div class="codelisting" id="_code-relationships_controller_spec_ajax" data-tralics-id="uid938" data-number="11.37"><div class="heading"><span class="number">Listing 11.37:</span> 

<span class="description">Tests for the Relationships controller responses to Ajax requests.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/controllers/relationships_controller_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">RelationshipsController</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span><span class="p">,</span> <span class="ss">no_capybara</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"creating a relationship with Ajax"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"should increment the Relationship count"</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship</span><span class="p">:</span> <span class="p">{</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should respond with success"</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship</span><span class="p">:</span> <span class="p">{</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"destroying a relationship with Ajax"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should decrement the Relationship count"</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should respond with success"</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_controller_spec_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.37</span></a> is our first example of a <em>controller</em> test, which I used to use extensively (as in the previous edition of this book) but now mainly eschew in favor of integration tests.<span class="intersentencespace"></span> In this case, though, the <code>xhr</code> method is (somewhat inexplicably) not available in integration tests.<span class="intersentencespace"></span> Although our use of <code>xhr</code> is new, at this point in the tutorial you should be able to infer from context what the code does:</p>
<div class="code"><div class="highlight"><pre><span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship</span><span class="p">:</span> <span class="p">{</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
</pre></div></div>
<p>We see that <code>xhr</code> takes as arguments a symbol for the relevant HTTP method, a symbol for the action, and a hash representing the contents of <code>params</code> in the controller itself.<span class="intersentencespace"></span> As in previous examples, we use <code>expect</code> to wrap the operation in a block and test for an increment or decrement in the relevant count.</p>
<p>As implied by the tests, the application code uses the same <code>create</code> and <code>destroy</code> actions to respond to the Ajax requests that it uses to respond to ordinary <span class="tt">POST</span> and <span class="tt">DELETE</span> HTTP requests.<span class="intersentencespace"></span> All we need to do is respond to a normal HTTP request with a redirect (as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a>) and respond to an Ajax request with JavaScript.<span class="intersentencespace"></span> The controller code appears as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_controller_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.38</span></a>.<span class="intersentencespace"></span> (See <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_exercises" class="hyperref">Section&nbsp;<span class="ref">11.5</span></a> for an exercise showing an even more compact way to accomplish the same thing.)</p>
<div class="codelisting" id="_code-relationships_controller_ajax" data-tralics-id="uid939" data-number="11.38"><div class="heading"><span class="number">Listing 11.38:</span> 

<span class="description">Responding to Ajax requests in the Relationships controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This code uses <code>respond_to</code> to take the appropriate action depending on the kind of request.<span class="intersentencespace"></span> (There is no relationship between this <code>respond_to</code> and the <code>respond_to</code> used in the RSpec examples.)<span class="intersentencespace"></span> The syntax is potentially confusing, and it’s important to understand that in</p>
<div class="code"><div class="highlight"><pre><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
<span class="k">end</span>
</pre></div></div>
<p>only <em>one</em> of the lines gets executed (based on the nature of the request).</p>
<p>In the case of an Ajax request, Rails automatically calls a <em>JavaScript Embedded Ruby</em> (<code>.js.erb</code>) file with the same name as the action, i.e., <code>create.js.erb</code> or <code>destroy.js.erb</code>.<span class="intersentencespace"></span> As you might guess, the files allow us to mix JavaScript and Embedded Ruby to perform actions on the current page.<span class="intersentencespace"></span> It is these files that we need to create and edit in order to update the user profile page upon being followed or unfollowed.</p>
<p>Inside a JS-ERb file, Rails automatically provides the <a href="http://jquery.com/" target="_blank">jQuery</a> JavaScript helpers to manipulate the page using the <a href="http://www.w3.org/DOM/" target="_blank">Document Object Model (DOM)</a>.<span class="intersentencespace"></span> The jQuery library provides a large number of methods for manipulating the DOM, but here we will need only two.<span class="intersentencespace"></span> First, we will need to know about the dollar-sign syntax to access a DOM element based in its unique CSS&nbsp;id.<span class="intersentencespace"></span> For example, to manipulate the <code>follow_form</code> element, we will use the syntax</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">)</span>
</pre></div></div>
<p>(Recall from <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-follow_form_partial" class="hyperref">Listing&nbsp;<span class="ref">11.23</span></a> that this is a <code>div</code> that wraps the form, not the form itself.)<span class="intersentencespace"></span> This syntax, inspired by CSS, uses the&nbsp;<code>#</code> symbol to indicate a CSS&nbsp;id.<span class="intersentencespace"></span> As you might guess, jQuery, like CSS, uses a dot&nbsp;<code>.</code> to manipulate CSS classes.</p>
<p>The second method we’ll need is <code>html</code>, which updates the HTML inside the relevant element with the contents of its argument.<span class="intersentencespace"></span> For example, to replace the entire follow form with the string <code>"foobar"</code>, we would write</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
</pre></div></div>
<p>Unlike plain JavaScript files, JS-ERb files also allow the use of Embedded Ruby, which we apply in the <code>create.js.erb</code> file to update the follow form with the <code>unfollow</code> partial (which is what should show after a successful following) and update the follower count.<span class="intersentencespace"></span> The result is shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-create_js_erb" class="hyperref">Listing&nbsp;<span class="ref">11.39</span></a>.<span class="intersentencespace"></span> This uses the <code>escape_javascript</code> function, which is needed to escape out the result when inserting HTML in a JavaScript file.</p>
<div class="codelisting" id="_code-create_js_erb" data-tralics-id="uid940" data-number="11.39"><div class="heading"><span class="number">Listing 11.39:</span> 

<span class="description">The JavaScript Embedded Ruby to create a following relationship.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/relationships/create.js.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%= escape_javascript(render('users/unfollow')) %&gt;"</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#followers"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;%= @user.followers.count %&gt;'</span><span class="p">)</span>
</pre></div></div></div><p>The <code>destroy.js.erb</code> file is analogous (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-destroy_js_erb" class="hyperref">Listing&nbsp;<span class="ref">11.40</span></a>).</p>
<div class="codelisting" id="_code-destroy_js_erb" data-tralics-id="uid941" data-number="11.40"><div class="heading"><span class="number">Listing 11.40:</span> 

<span class="description">The Ruby JavaScript (RJS) to destroy a following relationship.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/relationships/destroy.js.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%= escape_javascript(render('users/follow')) %&gt;"</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#followers"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;%= @user.followers.count %&gt;'</span><span class="p">)</span>
</pre></div></div></div><p>With that, you should navigate to a user profile page and verify that you can follow and unfollow without a page refresh, and the test suite should also pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>Using Ajax in Rails is a large and fast-moving subject, so we’ve only been able to scratch the surface here, but (as with the rest of the material in this tutorial) our treatment should give you a good foundation for more advanced resources.</p>
</div></div>
<div id="_sec-the_status_feed" data-tralics-id="cid68" class="section" data-number="11.3"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_status_feed" class="heading hyperref"><span class="number">11.3 </span>The status feed</a></h2>
<p>We come now to the pinnacle of our sample application: the status feed.<span class="intersentencespace"></span> Appropriately, this section contains some of the most advanced material in the entire tutorial.<span class="intersentencespace"></span> The full status feed builds on the proto-feed from <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_proto_feed" class="hyperref">Section&nbsp;<span class="ref">10.3.3</span></a> by assembling an array of the microposts from the users being followed by the current user, along with the current user’s own microposts.<span class="intersentencespace"></span> To accomplish this feat, we will need some fairly advanced Rails, Ruby, and even SQL programming techniques.</p>
<p>Because of the heavy lifting ahead, it’s especially important to review where we’re going.<span class="intersentencespace"></span> A recap of the final user status feed, shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-page_flow_home_page_feed_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.5</span></a>, appears again in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_page_feed_mockup" class="hyperref">Figure&nbsp;<span class="ref">11.18</span></a>.</p>
<div class="center figure" id="_fig-home_page_feed_mockup" data-tralics-id="uid942" data-number="11.18">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/page_flow_home_page_feed_mockup_bootstrap.png" alt="images/figures/page_flow_home_page_feed_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 11.18: </span><span class="description">A mockup of a user’s Home page with a status feed.
</span></div></div>
<div id="_sec-motivation_and_strategy" data-tralics-id="uid943" class="subsection" data-number="11.3.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-motivation_and_strategy" class="heading hyperref"><span class="number">11.3.1 </span>Motivation and strategy</a></h3>
<p>The basic idea behind the feed is simple.<span class="intersentencespace"></span> <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-user_feed" class="hyperref">Figure&nbsp;<span class="ref">11.19</span></a> shows a sample <code>microposts</code> database table and the resulting feed.<span class="intersentencespace"></span> The purpose of a feed is to pull out the microposts whose user ids correspond to the users being followed by the current user (and the current user itself), as indicated by the arrows in the diagram.</p>
<div class="center figure" id="_fig-user_feed" data-tralics-id="uid944" data-number="11.19">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/user_feed.png" alt="images/figures/user_feed"></div><div class="caption"><span class="header">Figure 11.19: </span><span class="description">The feed for a user (id 1) following users 2, 7, 8, and 10.
</span></div></div>
<p>Since we need a way to find all the microposts from users followed by a given user, we’ll plan on implementing a method called <code>from_users_followed_by</code>, which we will use as follows:</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>Although we don’t yet know how to implement it, we can already write tests for its functionality.<span class="intersentencespace"></span> The key is to check all three requirements for the feed: microposts for followed users and the user itself should be included in the feed, but a post from an <em>unfollowed</em> user should not be included.<span class="intersentencespace"></span> Two of these requirements already appear in our tests: <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-feed_specs" class="hyperref">Listing&nbsp;<span class="ref">10.35</span></a> verifies that a user’s own microposts appear in the feed, while the micropost from an unfollowed user doesn’t appear.<span class="intersentencespace"></span> Now that we know how to follow users, we can add a third type of test, this time checking that the microposts of a followed user appear in the feed, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-full_feed_specs" class="hyperref">Listing&nbsp;<span class="ref">11.41</span></a>.</p>
<div class="codelisting" id="_code-full_feed_specs" data-tralics-id="uid945" data-number="11.41"><div class="heading"><span class="number">Listing 11.41:</span> 

<span class="description">The final tests for the status feed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">spec/models/user_spec.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"status"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:followed_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed_user</span><span class="p">)</span>
        <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="s2">"Lorem ipsum"</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
          <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The feed itself simply defers the hard work to <code>Micropost.from_users_followed_by</code>, as shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_feed" class="hyperref">Listing&nbsp;<span class="ref">11.42</span></a>.</p>
<div class="codelisting" id="_code-user_feed" data-tralics-id="uid946" data-number="11.42"><div class="heading"><span class="number">Listing 11.42:</span> 

<span class="description">Adding the completed feed to the User model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="_sec-a_first_feed_implementation" data-tralics-id="uid947" class="subsection" data-number="11.3.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_first_feed_implementation" class="heading hyperref"><span class="number">11.3.2 </span>A first feed implementation</a></h3>
<p>Now it’s time to implement <code>Micropost.from_users_followed_by</code>, which for simplicity we’ll just refer to as “the feed”.<span class="intersentencespace"></span> Since the final result is rather intricate, we’ll build up to the final feed implementation by introducing one piece at a time.</p>
<p>The first step is to think of the kind of query we’ll need.<span class="intersentencespace"></span> What we want to do is select from the <code>microposts</code> table all the microposts with ids corresponding to the users being followed by a given user (or the user itself).<span class="intersentencespace"></span> We might write this schematically as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</pre></div></div>
<p>In writing this code, we’ve guessed that SQL supports an <code>IN</code> keyword that allows us to test for set inclusion.<span class="intersentencespace"></span> (Happily, it does.)</p>
<p>Recall from the proto-feed in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_proto_feed" class="hyperref">Section&nbsp;<span class="ref">10.3.3</span></a> that Active Record uses the <code>where</code> method to accomplish the kind of select shown above, as illustrated in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-proto_status_feed" class="hyperref">Listing&nbsp;<span class="ref">10.36</span></a>.<span class="intersentencespace"></span> There, our select was very simple; we just picked out all the microposts with user id corresponding to the current user:</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>Here, we expect it to be more complicated, something like</p>
<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">"user_id in (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>(Here we’ve used the Rails convention of <code>user</code> instead of <code>user.id</code> in the condition; Rails automatically uses the&nbsp;<code>id</code>.<span class="intersentencespace"></span> We’ve also omitted the leading <code>Micropost.</code> since we expect this method to live in the Micropost model itself.)</p>
<p>We see from these conditions that we’ll need an array of ids corresponding to the users being followed.<span class="intersentencespace"></span> One way to do this is to use Ruby’s <code>map</code> method, available on any “enumerable” object, i.e., any object (such as an Array or a Hash) that consists of a collection of elements.<sup id="_cha-11_footnote-ref-10" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-10">10</a></sup><span class="intersentencespace"></span> We saw an example of this method in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-blocks" class="hyperref">Section&nbsp;<span class="ref">4.3.2</span></a>; it works like this:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="go">=&gt; ["1", "2", "3", "4"]</span>
</pre></div></div>
<p>Situations like the one illustrated above, where the same method (e.g., <code>to_s</code>) gets called on each element, are common enough that there’s a shorthand notation using an <em>ampersand</em>&nbsp;<code>&amp;</code> and a symbol corresponding to the method:<sup id="_cha-11_footnote-ref-11" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-11">11</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
<span class="go">=&gt; ["1", "2", "3", "4"]</span>
</pre></div></div>
<p>Using the <code>join</code> method (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-arrays_and_ranges" class="hyperref">Section&nbsp;<span class="ref">4.3.1</span></a>), we can create a string composed of the ids by joining them on comma-space :</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="go">=&gt; "1, 2, 3, 4"</span>
</pre></div></div>
<p>We can use the above method to construct the necessary array of followed user ids by calling&nbsp;<code>id</code> on each element in <code>user.followed_users</code>.<span class="intersentencespace"></span> For example, for the first user in the database this array appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div></div>
<p>In fact, because this sort of construction is so useful, Active Record provides it by default:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div></div>
<p>Here the <code>followed_user_ids</code> method is synthesized by Active Record based on the <code>has_many :followed_users</code> association (<a href="http://rails-4-0.railstutorial.org/book/_single-page#code-has_many_following_through_relationships" class="hyperref">Listing&nbsp;<span class="ref">11.10</span></a>); the result is that we need only append <code>_ids</code> to the association name to get the ids corresponding to the <code>user.followed_users</code> collection.<span class="intersentencespace"></span> A string of followed user ids then appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="go">=&gt; "4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51"</span>
</pre></div></div>
<p>When inserting into an SQL string, though, you don’t need to do this; the <code>?</code> interpolation takes care of it for you (and in fact eliminates some database-dependent incompatibilities).<span class="intersentencespace"></span> This means we can use</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div></div>
<p>by itself.</p>
<p>At this point, you might guess that code like</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>will involve a class method in the <code>Micropost</code> class (a construction mentioned briefly in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-constructors" class="hyperref">Section&nbsp;<span class="ref">4.4.1</span></a>).<span class="intersentencespace"></span> A proposed implementation along these lines appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-from_users_followed_by_first_cut" class="hyperref">Listing&nbsp;<span class="ref">11.43</span></a>.</p>
<div class="codelisting" id="_code-from_users_followed_by_first_cut" data-tralics-id="uid950" data-number="11.43"><div class="heading"><span class="number">Listing 11.43:</span> 

<span class="description">A first cut at the <code>from_users_followed_by</code> method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Although the discussion leading up to <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-from_users_followed_by_first_cut" class="hyperref">Listing&nbsp;<span class="ref">11.43</span></a> was couched in hypothetical terms, it actually works!<span class="intersentencespace"></span> You can verify this yourself by running the test suite, which should pass:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div></div>
<p>In some applications, this initial implementation might be good enough for most practical purposes.<span class="intersentencespace"></span> But it’s not the final implementation; see if you can make a guess about why not before moving on to the next section.<span class="intersentencespace"></span> (<em>Hint:</em> What if a user is following 5000 other users?)</p>
</div>
<div id="_sec-scopes_subselects_and_a_lambda" data-tralics-id="uid951" class="subsection" data-number="11.3.3"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-scopes_subselects_and_a_lambda" class="heading hyperref"><span class="number">11.3.3 </span>Subselects</a></h3>
<p>As hinted at in the last section, the feed implementation in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_first_feed_implementation" class="hyperref">Section&nbsp;<span class="ref">11.3.2</span></a> doesn’t scale well when the number of microposts in the feed is large, as would likely happen if a user were following, say, 5000 other users.<span class="intersentencespace"></span> In this section, we’ll reimplement the status feed in a way that scales better with the number of followed users.</p>
<p>The problem with the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_first_feed_implementation" class="hyperref">Section&nbsp;<span class="ref">11.3.2</span></a> is that</p>
<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div></div>
<p>pulls <em>all</em> the followed users’ ids into memory, and creates an array the full length of the followed users array.<span class="intersentencespace"></span> Since the condition in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-from_users_followed_by_first_cut" class="hyperref">Listing&nbsp;<span class="ref">11.43</span></a> actually just checks inclusion in a set, there must be a more efficient way to do this, and indeed SQL is optimized for just such set operations.The solution involves pushing the finding of followed user ids into the database using a <em>subselect</em>.</p>
<p>We’ll start by refactoring the feed with the slightly modified code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-from_users_followed_by_second_cut" class="hyperref">Listing&nbsp;<span class="ref">11.44</span></a>.</p>
<div class="codelisting" id="_code-from_users_followed_by_second_cut" data-tralics-id="uid952" data-number="11.44"><div class="heading"><span class="number">Listing 11.44:</span> 

<span class="description">Improving <code>from_users_followed_by</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns microposts from the users being followed by the given user.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (:followed_user_ids) OR user_id = :user_id"</span><span class="p">,</span>
          <span class="ss">followed_user_ids</span><span class="p">:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As preparation for the next step, we have replaced</p>
<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>with the equivalent</p>
<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (:followed_user_ids) OR user_id = :user_id"</span><span class="p">,</span>
      <span class="ss">followed_user_ids</span><span class="p">:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>The question mark syntax is fine, but when we want the <em>same</em> variable inserted in more than one place, the second syntax is more convenient.</p>
<p>The above discussion implies that we will be adding a <em>second</em> occurrence of <code>user_id</code> in the SQL query.<span class="intersentencespace"></span> In particular, we can replace the Ruby code</p>
<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div></div>
<p>with the SQL snippet</p>
<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                     WHERE follower_id = :user_id"</span>
</pre></div></div>
<p>This code contains an SQL subselect, and internally the entire select for user&nbsp;1 would look something like this:</p>
<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span> <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div></div>
<p>This subselect arranges for all the set logic to be pushed into the database, which is more efficient.<sup id="_cha-11_footnote-ref-12" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-12">12</a></sup></p>
<p>With this foundation, we are ready for an efficient feed implementation, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-from_users_followed_by_final" class="hyperref">Listing&nbsp;<span class="ref">11.45</span></a>.<span class="intersentencespace"></span> Note that, because it is now raw SQL, <code>followed_user_ids</code> is <em>interpolated</em>, not escaped.<span class="intersentencespace"></span> (It actually works either way, but logically it makes more sense to interpolate in this context.)</p>
<div class="codelisting" id="_code-from_users_followed_by_final" data-tralics-id="uid954" data-number="11.45"><div class="heading"><span class="number">Listing 11.45:</span> 

<span class="description">The final implementation of <code>from_users_followed_by</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/micropost.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'created_at DESC'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>

  <span class="c1"># Returns microposts from the users being followed by the given user.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                         WHERE follower_id = :user_id"</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (</span><span class="si">#{</span><span class="n">followed_user_ids</span><span class="si">}</span><span class="s2">) OR user_id = :user_id"</span><span class="p">,</span>
          <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This code has a formidable combination of Rails, Ruby, and SQL, but it does the job, and does it well.<span class="intersentencespace"></span> (Of course, even the subselect won’t scale forever.<span class="intersentencespace"></span> For bigger sites, you would probably need to generate the feed asynchronously using a background job, but such scaling subtleties are beyond the scope of this tutorial.)</p>
</div>
<div id="_sec-the_new_status_feed" data-tralics-id="uid955" class="subsection" data-number="11.3.4"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-the_new_status_feed" class="heading hyperref"><span class="number">11.3.4 </span>The new status feed</a></h3>
<p>With the code in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-from_users_followed_by_final" class="hyperref">Listing&nbsp;<span class="ref">11.45</span></a>, our status feed is complete.<span class="intersentencespace"></span> As a reminder, the code for the Home page appears in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-real_feed_instance_variable" class="hyperref">Listing&nbsp;<span class="ref">11.46</span></a>; this code creates a paginated feed of the relevant microposts for use in the view, as seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_page_with_feed" class="hyperref">Figure&nbsp;<span class="ref">11.20</span></a>.<sup id="_cha-11_footnote-ref-13" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-13">13</a></sup><span class="intersentencespace"></span> Note that the <code>paginate</code> method actually reaches all the way into the Micropost model method in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-from_users_followed_by_final" class="hyperref">Listing&nbsp;<span class="ref">11.45</span></a>, arranging to pull out only&nbsp;30 microposts at a time from the database.<span class="intersentencespace"></span> (You can verify this by examining the SQL statements in the development server log file.)</p>
<div class="codelisting" id="_code-real_feed_instance_variable" data-tralics-id="uid957" data-number="11.46"><div class="heading"><span class="number">Listing 11.46:</span> 

<span class="description">The <code>home</code> action with a paginated feed.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/static_pages_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="center figure" id="_fig-home_page_with_feed" data-tralics-id="uid958" data-number="11.20">
<div class="graphics image box"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/home_page_with_feed_bootstrap.png" alt="images/figures/home_page_with_feed_bootstrap"></div><div class="caption"><span class="header">Figure 11.20: </span><span class="description">The Home page with a working status feed.
</span></div></div>
</div></div>
<div id="_sec-following_conclusion" data-tralics-id="cid69" class="section" data-number="11.4"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_conclusion" class="heading hyperref"><span class="number">11.4 </span>Conclusion</a></h2>
<p>With the addition of the status feed, we’ve finished the core sample application for the <em>Ruby on Rails Tutorial</em>.<span class="intersentencespace"></span> This application includes examples of all the major features of Rails, including models, views, controllers, templates, partials, filters, validations, callbacks, <code>has_many</code>/<code>belongs_to</code> and <code>has_many through</code> associations, security, testing, and deployment.<span class="intersentencespace"></span> Despite this impressive list, there is still much to learn about Rails.<span class="intersentencespace"></span> As a first step in this process, this section contains some suggested extensions to the core application, as well as suggestions for further learning.</p>
<p>Before moving on to tackle any of the application extensions, it’s a good idea to merge in your changes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Add user following"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge following-users
</pre></div></div>
<p>As usual, you can also push the code and deploy the application if you want:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div></div>
<div id="_sec-extensions_to_the_sample_application" data-tralics-id="uid959" class="subsection" data-number="11.4.1"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-extensions_to_the_sample_application" class="heading hyperref"><span class="number">11.4.1 </span>Extensions to the sample application</a></h3>
<p>The proposed extensions in this section are mostly inspired either by general features common to web applications, such as password reminders and email confirmation, or features specific to our type of sample application, such as search, replies, and messaging.<span class="intersentencespace"></span> Implementing one or more of these application extensions will help you make the transition from following a tutorial to writing original applications of your own.</p>
<p>Don’t be surprised if it’s tough going at first; the blank slate of a new feature can be quite intimidating.<span class="intersentencespace"></span> To help get you started, I can give two pieces of general advice.<span class="intersentencespace"></span> First, before adding any feature to a Rails application, take a look at the <a href="http://railscasts.com/episodes/archive" target="_blank">RailsCasts archive</a> to see if Ryan Bates has already covered the subject.<sup id="_cha-11_footnote-ref-14" class="footnote"><a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-14">14</a></sup><span class="intersentencespace"></span> If he has, watching the relevant RailsCast first will often save you a ton of time.<span class="intersentencespace"></span> Second, always do extensive Google searches on your proposed feature to find relevant blog posts and tutorials.<span class="intersentencespace"></span> Web application development is hard, and it helps to learn from the experience (and mistakes) of others.</p>
<p>Many of the following features are quite challenging, and I have given some hints about the tools you might need to implement them.<span class="intersentencespace"></span> Even with hints, they are <em>much</em> more difficult than the book’s end-of-chapter exercises, so don’t be discouraged if you can’t solve them without considerable effort.<span class="intersentencespace"></span> Due to time constraints, I am not available for one-on-one assistance, but if there is sufficient interest I might release standalone article/screencast bundles on some of these extensions in the future; go to the main Rails Tutorial website at <a href="http://railstutorial.org/" target="_blank">http://railstutorial.org/</a> and subscribe to the news feed to get the latest updates.</p>
<div id="_sec-replies" data-tralics-id="uid961" class="subsubsection" data-number="11.4.1.1"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-replies" class="heading">Replies</a></h4>
<p>Twitter allows users to make “@replies”, which are microposts whose first characters are the user’s login preceded by the <span class="tt">@</span>&nbsp;sign.<span class="intersentencespace"></span> These posts only appear in the feed of the user in question or users following that user.<span class="intersentencespace"></span> Implement a simplified version of this, restricting @replies to appear only in the feeds of the recipient and the sender.<span class="intersentencespace"></span> This might involve adding an <code>in_reply_to</code> column in the <code>microposts</code> table and an extra <code>including_replies</code> scope to the Micropost model.</p>
<p>Since our application lacks unique user logins, you will also have to decide on a way to represent users.<span class="intersentencespace"></span> One option is to use a combination of the id and the name, such as <code>@1-michael-hartl</code>.<span class="intersentencespace"></span> Another is to <em>add</em> a unique username to the signup process and then use it in @replies.</p>
</div>
<div id="_sec-messaging" data-tralics-id="uid962" class="subsubsection" data-number="11.4.1.2"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-messaging" class="heading">Messaging</a></h4>
<p>Twitter supports direct (private) messaging by prefixing a micropost with the letter&nbsp;“d”.<span class="intersentencespace"></span> Implement this feature for the sample application.<span class="intersentencespace"></span> The solution will probably involve a Message model and a regular expression match on new microposts.</p>
</div>
<div id="_sec-follower_notifications" data-tralics-id="uid963" class="subsubsection" data-number="11.4.1.3"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-follower_notifications" class="heading">Follower notifications</a></h4>
<p>Implement a feature to send each user an email notification when they gain a new follower.<span class="intersentencespace"></span> Then make the notification optional, so that users can opt out if desired.<span class="intersentencespace"></span> Among other things, adding this feature requires learning how to send mail with Rails.<span class="intersentencespace"></span> To get started, I suggest viewing the <a href="http://railscasts.com/episodes/206-action-mailer-in-rails-3" target="_blank">RailsCast on Action Mailer in Rails&nbsp;3</a>.</p>
</div>
<div id="_sec-password_reminders" data-tralics-id="uid964" class="subsubsection" data-number="11.4.1.4"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-password_reminders" class="heading">Password reminders</a></h4>
<p>Currently, if our application’s users forget their passwords, they have no way to retrieve them.<span class="intersentencespace"></span> Because of the one-way secure password hashing in <a href="http://rails-4-0.railstutorial.org/book/_single-page#cha-modeling_users" class="hyperref">Chapter&nbsp;<span class="ref">6</span></a>, our application can’t email the user’s password, but it can send a link to a reset form.<span class="intersentencespace"></span> Follow the steps in the <a href="http://railscasts.com/episodes/274-remember-me-reset-password" target="_blank">RailsCast on Remember Me &amp; Reset Password</a> to fix this omission.</p>
</div>
<div id="_sec-signup_confirmation" data-tralics-id="uid965" class="subsubsection" data-number="11.4.1.5"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-signup_confirmation" class="heading">Signup confirmation</a></h4>
<p>Apart from an email regular expression, the sample application currently has no way to verify the validity of a user’s email address.<span class="intersentencespace"></span> Add an email address verification step to confirm a user’s signup.<span class="intersentencespace"></span> The new feature should create users in an inactive state, email the user an activation URL, and then change the user to an active state when the URL gets hit.<span class="intersentencespace"></span> You might want to read up on <a href="http://www.google.com/search?q=state+machines+in+rails" target="_blank">state machines in Rails</a> to help you with the inactive/active transition.</p>
</div>
<div id="_sec-rss_feed" data-tralics-id="uid966" class="subsubsection" data-number="11.4.1.6"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rss_feed" class="heading">RSS feed</a></h4>
<p>For each user, implement an RSS feed for their microposts.<span class="intersentencespace"></span> Then implement an RSS feed for their status feed, optionally restricting access to that feed using an authentication scheme.<span class="intersentencespace"></span> The <a href="http://railscasts.com/episodes/87-generating-rss-feeds" target="_blank">RailsCast on generating RSS feeds</a> will help get you started.</p>
</div>
<div id="_sec-rest_api" data-tralics-id="uid967" class="subsubsection" data-number="11.4.1.7"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-rest_api" class="heading">REST API</a></h4>
<p>Many websites expose an Application Programmer Interface (API) so that third-party applications can get, post, put, and delete the application’s resources.<span class="intersentencespace"></span> Implement such a REST API for the sample application.<span class="intersentencespace"></span> The solution will involve adding <code>respond_to</code> blocks (<a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_with_ajax" class="hyperref">Section&nbsp;<span class="ref">11.2.5</span></a>) to many of the application’s controller actions; these should respond to requests for XML. Be careful about security; the API should only be accessible to authorized users.</p>
</div>
<div id="_sec-search" data-tralics-id="uid968" class="subsubsection" data-number="11.4.1.8"><h4><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-search" class="heading">Search</a></h4>
<p>Currently, there is no way for users to find each other, apart from paging through the user index or viewing the feeds of other users.<span class="intersentencespace"></span> Implement a search feature to remedy this.<span class="intersentencespace"></span> Then add another search feature for microposts.<span class="intersentencespace"></span> The <a href="http://railscasts.com/episodes/37-simple-search-form" target="_blank">RailsCast on simple search forms</a> will help get you started.<span class="intersentencespace"></span> If you deploy using a shared host or a dedicated server, I suggest using <a href="http://freelancing-god.github.com/ts/en/" target="_blank">Thinking Sphinx</a> (following the <a href="http://railscasts.com/episodes/120-thinking-sphinx" target="_blank">RailsCast on Thinking Sphinx</a>).<span class="intersentencespace"></span> If you deploy on Heroku, you should follow the <a href="http://devcenter.heroku.com/articles/full-text-search" target="_blank">Heroku full text search</a> instructions.</p>
</div></div>
<div id="_sec-guide_to_further_resources" data-tralics-id="uid969" class="subsection" data-number="11.4.2"><h3><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-guide_to_further_resources" class="heading hyperref"><span class="number">11.4.2 </span>Guide to further resources</a></h3>
<p>There are a wealth of Rails resources in stores and on the web—indeed, the supply is so rich that it can be overwhelming.<span class="intersentencespace"></span> The good news is that, having gotten this far, you’re ready for almost anything else out there.<span class="intersentencespace"></span> Here are some suggestions for further learning:</p>
<ul>
<li><a href="http://railstutorial.org/screencasts" target="_blank">The <em>Ruby on Rails Tutorial</em> screencasts</a>: I have prepared a full-length screencast course based on this book.<span class="intersentencespace"></span> In addition to covering all the material in the book, the screencasts are filled with tips, tricks, and the kind of see-how-it’s-done demos that are hard to capture in print.<span class="intersentencespace"></span> They are available for purchase through the <a href="http://railstutorial.org/" target="_blank">Ruby on Rails Tutorial website</a>.
</li>
<li><a href="http://railscasts.com/" target="_blank">RailsCasts</a>: It’s hard to overemphasize what a great resource RailsCasts is.<span class="intersentencespace"></span> I suggest starting by visiting the <a href="http://railscasts.com/episodes/archive" target="_blank">RailsCasts episode archive</a> and clicking on subjects that catch your eye.
</li>
<li><a href="http://www.gotealeaf.com/railstutorial" target="_blank">Tealeaf Academy</a>: Lots of in-person developer bootcamps have sprung up in recent years, and I recommend looking for one in your area, but <a href="http://www.gotealeaf.com/railstutorial" target="_blank">Tealeaf Academy</a> is available online and so can be taken from anywhere.<span class="intersentencespace"></span> Tealeaf is an especially good choice if you want instructor feedback within the context of a structured curriculum.
</li>
<li>Ruby and Rails books: I recommend <a href="http://www.amazon.com/gp/product/1430223634" target="_blank"><em>Beginning Ruby</em></a> by Peter Cooper, <a href="http://www.amazon.com/gp/product/1933988657" target="_blank"><em>The Well-Grounded Rubyist</em></a> by David&nbsp;A. Black, <a href="http://www.amazon.com/Eloquent-Ruby-Addison-Wesley-Professional-Series/dp/0321584104/" target="_blank"><em>Eloquent Ruby</em></a> by Russ Olsen, and <a href="http://www.amazon.com/gp/product/0672328844" target="_blank"><em>The Ruby Way</em></a> by Hal Fulton for further Ruby learning, and <a href="http://www.amazon.com/gp/product/0321601661" target="_blank"><em>The Rails&nbsp;3 Way</em></a> by Obie Fernandez and <em>Rails&nbsp;3 in Action</em> (wait for the second edition) by Ryan Bigg and Yehuda Katz for more about Rails.
</li>
<li><a href="http://peepcode.com/" target="_blank">PeepCode</a> and <a href="http://mbsy.co/6VQ8l" target="_blank">Code School</a>: The screencasts at PeepCode and interactive courses at Code School are consistently high-quality, and I warmly recommend them.
</li></ul>
</div></div>
<div id="_sec-following_exercises" data-tralics-id="cid70" class="section" data-number="11.5"><h2><a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-following_exercises" class="heading hyperref"><span class="number">11.5 </span>Exercises</a></h2>
<ol>
<li>Add tests for destroying relationships associated with a given user (i.e., as implemented by <code>dependent :destroy</code> in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_relationships_association" class="hyperref">Listing&nbsp;<span class="ref">11.4</span></a> and <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-user_reverse_relationships" class="hyperref">Listing <span class="ref">11.16</span></a>).<span class="intersentencespace"></span> <em>Hint</em>: Follow the example in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-micropost_dependency_test" class="hyperref">Listing&nbsp;<span class="ref">10.12</span></a>.<span class="intersentencespace"></span>
</li>
<li>The <code>respond_to</code> method seen in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_controller_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.38</span></a> can actually be hoisted out of the actions into the Relationships controller itself, and the <code>respond_to</code> blocks can be replaced with a Rails method called <code>respond_with</code>.<span class="intersentencespace"></span> Prove that the resulting code, shown in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-compact_respond_to" class="hyperref">Listing&nbsp;<span class="ref">11.47</span></a>, is correct by verifying that the test suite still passes.<span class="intersentencespace"></span> (For details on this method, do a Google search on “rails respond_with”.)
</li>
<li>Refactor <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-show_follow_view" class="hyperref">Listing&nbsp;<span class="ref">11.31</span></a> by adding partials for the code common to the following/followers pages, the Home page, and the user show page.<span class="intersentencespace"></span>
</li>
<li>Following the model in <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-stats_view_test" class="hyperref">Listing&nbsp;<span class="ref">11.19</span></a>, write tests for the stats on the profile page.<span class="intersentencespace"></span>
</li></ol>
<div class="codelisting" id="_code-compact_respond_to" data-tralics-id="uid979" data-number="11.47"><div class="heading"><span class="number">Listing 11.47:</span> 

<span class="description">A compact refactoring of <a href="http://rails-4-0.railstutorial.org/book/_single-page#code-relationships_controller_ajax" class="hyperref">Listing&nbsp;<span class="ref">11.38</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:signed_in_user</span>

  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:js</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div><div id="cha-11_footnotes">
  <ol class="footnotes">
    <li id="_cha-11_footnote-1">The photographs in the mockup tour are from <a href="http://www.flickr.com/photos/john_lustig/2518452221/" target="_blank">http://www.flickr.com/photos/john_lustig/2518452221/</a> and http://www.flickr.com/photos/30775272@N05/2884963755/ (link expired).&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-1">↑</a></li>
    <li id="_cha-11_footnote-2">The first edition of this book used the <code>user.following</code> terminology, which even I found confusing at times.<span class="intersentencespace"></span> Thanks to reader Cosmo Lee for convincing me to change the terminology and for offering suggestions on how to make it clearer.<span class="intersentencespace"></span> (I didn’t follow his exact advice, though, so if it’s still confusing he bears none of the blame.)&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-2">↑</a></li>
    <li id="_cha-11_footnote-3">For simplicity, <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-naive_user_has_many_following" class="hyperref">Figure&nbsp;<span class="ref">11.6</span></a> suppresses the <code>followed_users</code> table’s&nbsp;<code>id</code> column.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-3">↑</a></li>
    <li id="_cha-11_footnote-4">See the discussion on <a href="http://stackoverflow.com/questions/5359558/when-to-use-rspec-let" target="_blank">when to use let at Stack Overflow</a> for more information.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-4">↑</a></li>
    <li id="_cha-11_footnote-5">Technically, Rails uses the <code>underscore</code> method to convert the class name to an id.<span class="intersentencespace"></span> For example, <code>"FooBar".underscore</code> is <code>"foo_bar"</code>, so the foreign key for a <code>FooBar</code> object would be <code>foo_bar_id</code>.<span class="intersentencespace"></span> (Incidentally, the inverse of <code>underscore</code> is <code>camelize</code>, which converts <code>"camel_case"</code> to <code>"CamelCase"</code>.)&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-5">↑</a></li>
    <li id="_cha-11_footnote-6">If you’ve noticed that <code>followed_id</code> also identifies a user, and are concerned about the asymmetric treatment of followed and follower, you’re ahead of the game.<span class="intersentencespace"></span> We’ll deal with this issue in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-followers" class="hyperref">Section&nbsp;<span class="ref">11.1.5</span></a>.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-6">↑</a></li>
    <li id="_cha-11_footnote-7">Once you have a lot of experience modeling a particular domain, you can often guess such utility methods in advance, and even when you can’t you’ll often find yourself writing them to make the tests cleaner.<span class="intersentencespace"></span> In this case, though, it’s OK if you wouldn’t have guessed them.<span class="intersentencespace"></span> Software development is usually an iterative process—you write code until it starts getting ugly, and then you refactor it—but for brevity the tutorial presentation is streamlined a bit.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-7">↑</a></li>
    <li id="_cha-11_footnote-8">Because it is nominally an acronym for <em>asynchronous JavaScript and XML</em>, Ajax is sometimes misspelled “AJAX”, even though the <a href="http://www.adaptivepath.com/ideas/ajax-new-approach-web-applications/" target="_blank">original Ajax article</a> spells it as “Ajax” throughout.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-8">↑</a></li>
    <li id="_cha-11_footnote-9">This only works if JavaScript is enabled in the browser, but it degrades gracefully, working exactly as in <a href="http://rails-4-0.railstutorial.org/book/_single-page#sec-a_working_follow_button_the_standard_way" class="hyperref">Section&nbsp;<span class="ref">11.2.4</span></a> if JavaScript is disabled.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-9">↑</a></li>
    <li id="_cha-11_footnote-10">The main requirement is that enumerable objects must implement an <code>each</code> method to iterate through the collection.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-10">↑</a></li>
    <li id="_cha-11_footnote-11">This notation actually started as an extension Rails made to the core Ruby language; it was so useful that it has now been incorporated into Ruby itself.<span class="intersentencespace"></span> How cool is that?&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-11">↑</a></li>
    <li id="_cha-11_footnote-12">For a more advanced way to create the necessary subselect, see the blog post <a href="http://pivotallabs.com/users/jsusser/blog/articles/567-hacking-a-subselect-in-activerecord" target="_blank">“Hacking a subselect in ActiveRecord”.</a>&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-12">↑</a></li>
    <li id="_cha-11_footnote-13">In order to make a prettier feed for <a href="http://rails-4-0.railstutorial.org/book/_single-page#fig-home_page_with_feed" class="hyperref">Figure&nbsp;<span class="ref">11.20</span></a>, I’ve added a few extra microposts by hand using the Rails console.&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-13">↑</a></li>
    <li id="_cha-11_footnote-14">Note that RailsCasts usually omit the tests, which is probably necessary to keep the episodes nice and short, but you could get the wrong idea about the importance of testing.<span class="intersentencespace"></span> Once you’ve watched the relevant RailsCast to get a basic idea of how to proceed, I suggest writing the new feature using test-driven development.<span class="intersentencespace"></span> (In this context, I recommend taking a look at <a href="http://railscasts.com/episodes/275-how-i-test" target="_blank">the RailsCast on “How I test”</a>.<span class="intersentencespace"></span> You’ll see that Ryan Bates himself often uses TDD for real-life development, and in fact his testing style is similar to the style used in this tutorial.)&nbsp;<a class="arrow" href="http://rails-4-0.railstutorial.org/book/_single-page#cha-11_footnote-ref-14">↑</a></li>
  </ol>
</div>
    </div></div>
<div id="bookBottomMenu">
<div class="bookMenuArows">
<a class="leftArrow" href="javascript://">◄</a>
<a class="upArrow" href="javascript://">▲</a>
<a class="rightArrow" href="javascript://">►</a>
</div>
</div>
</div>
<div id="bookContentNotAvailable">
<img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/empty_content-f645e37a2f80dc1a63b6889833b1d916e96339ce337b9da5db9fd00748cf29b0.png" alt="Empty content f645e37a2f80dc1a63b6889833b1d916e96339ce337b9da5db9fd00748cf29b0">
Sorry, content not available
</div>
</div>
<div class="emailPitch" id="bookEmailModal">
<a onclick="closeEmailPops()" class="emailSignupClose" href="javascript://">x</a>
<strong>STAY UP TO DATE!</strong>
<p>Joining the email list for this book will allow the author to contact you to let you know about special offers and when updates for the book are available.</p>
<div class="j_followBookForm"><form action="https://www.softcover.io/books/ruby_on_rails_tutorial/follow?username=28fdb94f" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="✓">
<!-- %input{name: "name", type: "text", placeholder: "YOUR NAME"} -->
<input name="email" placeholder="YOUR EMAIL ADDRESS" type="text">
<input class="greyButton optClick_follow" type="submit" value="Follow Book">
</form>

</div>
</div>
<script>
  // setup book nav
  $(function(){
    Book.init({
      title: "Ruby on Rails Tutorial (4.0 version & 2nd Ed.)",
      path: "/book",
      slug: "ruby_on_rails_tutorial",
      s3_path_prefix: "636/ruby_on_rails_tutorial",
      chapters: [{"title":"Frontmatter\n","number":0,"slug":"frontmatter","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/frontmatter_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121519Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=b4fd905bbee9bcc78cb1dfd240c20769e86c8ec95ac8480499e35daeb1bcee97"},{"title":"Chapter 1: From zero to deploy\n","number":1,"slug":"beginning","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/beginning_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121519Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=72e94c0546861dbf1059e6d0a5f400be48113c6118efab80e3e27d659e508c95"},{"title":"Chapter 2: A demo app\n","number":2,"slug":"demo_app","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/demo_app_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121519Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=7d1af5d0b8e6a4193af8418ed641a457a25a7f7c0af3ae44de6b0f252dec7ad1"},{"title":"Chapter 3: Mostly static pages\n","number":3,"slug":"static_pages","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/static_pages_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121519Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=57c622953e5ce0e0c7e26c593cfa69092ba6798b4a4005959feb0082d1729771"},{"title":"Chapter 4: Rails-flavored Ruby\n","number":4,"slug":"rails_flavored_ruby","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/rails_flavored_ruby_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121519Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=991c7f89abad40f6cd494a5c9510d97d227216947ded1e4598fa272f21dc9b67"},{"title":"Chapter 5: Filling in the layout\n","number":5,"slug":"filling_in_the_layout","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/filling_in_the_layout_fragment.html?X-Amz-Expires=604799\u0026X-Amz-Date=20150727T121520Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=0a67c8e26484bf1ad7ba6a858d6b0a918f8ee7d2b8ad1261cccfa7f7b2f082e5"},{"title":"Chapter 6: Modeling users\n","number":6,"slug":"modeling_users","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/modeling_users_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121520Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=dc999338725a99ac6ca9ff1e58fd466adc75bccc93de49b730cb43ec3bc98f82"},{"title":"Chapter 7: Sign up\n","number":7,"slug":"sign_up","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/sign_up_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121520Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=1172b10c850ff107704b3ba495b26a0d7f1fdf0673f24768dcb090a9206d023e"},{"title":"Chapter 8: Sign in, sign out\n","number":8,"slug":"sign_in_out","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/sign_in_out_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121520Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=0ab4ea9d93a098d604754620d34a4bd4826e1736a511c8eba0bf2a751ab326bd"},{"title":"Chapter 9: Updating, showing, and deleting users\n","number":9,"slug":"updating_and_deleting_users","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/updating_and_deleting_users_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121520Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=bb044d28412e1fe0c9c713e741bdb8bfb33a406e37301be1800a3a87cf2788a5"},{"title":"Chapter 10: User microposts\n","number":10,"slug":"user_microposts","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/user_microposts_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121520Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=7da3f9a263b597a3d40e84baf46fbccbc71a69b570381abfc40b146b6907caae"},{"title":"Chapter 11: Following users\n","number":11,"slug":"following_users","s3_url":"https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial/html/following_users_fragment.html?X-Amz-Expires=604800\u0026X-Amz-Date=20150727T121520Z\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20150727/us-west-2/s3/aws4_request\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=be8cd2596f3d3d9f7c5566cb2b20e94a8b48566792bf98fc3fd390f2ac0bdbb6"}],
      full_page: true,
      custom_math: ""
    });
  });
</script>

</div>
</div>
<div class="footer clearfix">
<div class="wrapper" id="hide_chromeFooter">
<em>powered by</em>
<a class="logo" href="http://www.softcover.io/"><img src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/logo_foot-06b81d3a7ed51e8bbd39d0caaa622c1f6f5fca29d725d2e7aa1f6e79e3aaa4a5.png" alt="Logo foot 06b81d3a7ed51e8bbd39d0caaa622c1f6f5fca29d725d2e7aa1f6e79e3aaa4a5">
</a></div>
</div>

<script type="text/javascript">
setTimeout(function(){var a=document.createElement("script");
var b=document.getElementsByTagName("script")[0];
a.src=document.location.protocol+"//dnn506yrbagrg.cloudfront.net/pages/scripts/0023/6713.js?"+Math.floor(new Date().getTime()/3600000);
a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
</script>

<script type="text/javascript">
  var _sf_async_config = { uid: 9895, domain: 'softcover.io', useCanonical: true };
  (function() {
    function loadChartbeat() {
      window._sf_endpt = (new Date()).getTime();
      var e = document.createElement('script');
      e.setAttribute('language', 'javascript');
      e.setAttribute('type', 'text/javascript');
      e.setAttribute('src','//static.chartbeat.com/js/chartbeat.js');
      document.body.appendChild(e);
    };
    var oldonload = window.onload;
    window.onload = (typeof window.onload != 'function') ?
      loadChartbeat : function() { oldonload(); loadChartbeat(); };
  })();
</script>

<script type="text/javascript">
  (function() {
    window._pa = window._pa || {};
    // _pa.orderId = "myOrderId"; // OPTIONAL: attach unique conversion identifier to conversions
    // _pa.revenue = "19.99"; // OPTIONAL: attach dynamic purchase values to conversions
    // _pa.productId = "myProductId"; // OPTIONAL: Include product ID for use with dynamic ads
    var pa = document.createElement('script'); pa.type = 'text/javascript'; pa.async = true;
    pa.src = ('https:' == document.location.protocol ? 'https:' : 'http:') + "//tag.perfectaudience.com/serve/54eea5d20a23b37d87000040.js";
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(pa, s);
  })();
</script>



<iframe name="stripeXDM_default820653_provider" id="stripeXDM_default820653_provider" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/channel.html" frameborder="0" style="position: absolute; top: -2000px; left: 0px;"></iframe><div id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="fb_xdm_frame_http" frameborder="0" allowtransparency="true" allowfullscreen="true" scrolling="no" id="fb_xdm_frame_http" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/X9pYjJn4xhW.html" style="border: none;"></iframe><iframe name="fb_xdm_frame_https" frameborder="0" allowtransparency="true" allowfullscreen="true" scrolling="no" id="fb_xdm_frame_https" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/X9pYjJn4xhW(1).html" style="border: none;"></iframe></div></div><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div></div></div></div><div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Main, sans-serif;"></div></div><script language="javascript" type="text/javascript" src="./Single Page _ Ruby on Rails Tutorial (4.0 version & 2nd Ed.) _ Softcover.io_files/chartbeat.js"></script></body></html>